System.register([],function(q3){"use strict";return{execute:function(){function _e(e){return(_e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?l(e):t}function o(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=g(e)););return e}function _(e,t,i){return(_="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=o(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function a(e,t,i,n){return(a="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,a=o(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else s(n,t,i);return!0})(e,t,i,n)}function r(e,t,i,n,r){if(!a(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function u(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function m(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function b(i,n,e,t,r){var a={};return Object.keys(t).forEach(function(e){a[e]=t[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(i,n,a),a=null),a}q3({BitMask:_t,Enum:vt,EventType:void 0,GFXAddress:void 0,GFXAttributeName:void 0,GFXBindingType:void 0,GFXBlendFactor:void 0,GFXBlendOp:void 0,GFXBufferAccessBit:void 0,GFXBufferFlagBit:void 0,GFXBufferUsageBit:void 0,GFXClearFlag:void 0,GFXColorMask:void 0,GFXCommandBufferType:void 0,GFXComparisonFunc:void 0,GFXCullMode:void 0,GFXDynamicState:void 0,GFXFilter:void 0,GFXFormat:void 0,GFXFormatSize:Yc,GFXFormatSurfaceSize:Kc,GFXFormatType:void 0,GFXGetTypeSize:Zc,GFXLoadOp:void 0,GFXMemoryUsageBit:void 0,GFXObjectType:void 0,GFXPipelineBindPoint:void 0,GFXPolygonMode:void 0,GFXPrimitiveMode:void 0,GFXQueueType:void 0,GFXSampleCount:void 0,GFXShadeModel:void 0,GFXShaderType:void 0,GFXStatus:void 0,GFXStencilFace:void 0,GFXStencilOp:void 0,GFXStoreOp:void 0,GFXTextureFlagBit:void 0,GFXTextureLayout:void 0,GFXTextureType:void 0,GFXTextureUsageBit:void 0,GFXTextureViewType:void 0,GFXType:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,RenderPassStage:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Po,WorldNode3DToWorldNodeUI:Do,approx:fi,assert:k,assertID:V,bezier:eO,bezierByTime:oO,clamp:pi,clamp01:_i,color:ar,computeRatioByType:bO,equals:di,error:A,errorID:D,find:Z_,fragmentText:js,getPathFromRoot:IM,getWorldTransformUntilRoot:LM,inverseLerp:ki,isCustomTargetModifier:v_,isDisplayStats:H,isElementModifier:__,isPropertyModifier:p_,isUnicodeCJK:Hs,isUnicodeSpace:Ws,isValid:qo,lerp:vi,log:E,logID:L,markAsWarning:void 0,mat4:Dn,nextPow2:Ei,pingPong:Ai,pseudoRandom:Si,pseudoRandomRange:wi,pseudoRandomRangeInt:Ti,quat:mn,randomRange:bi,randomRangeInt:xi,rect:Jn,removeProperty:void 0,repeat:Ci,replaceProperty:void 0,safeMeasureText:qs,sampleAnimationCurve:gO,setDefaultLogTimes:function(e){0<e&&(hr=e)},setDisplayStats:W,size:jn,toDegree:yi,toRadian:mi,tween:l3,tweenUtil:s3,v2:zi,v3:Vi,v4:Xi,warn:C,warnID:B});var c="undefined"==typeof window?global:window,e=c.cc=c.cc||{};function t(e,t){void 0===c[e]&&(c[e]=t)}e.internal=e.internal||{},e._global=c,t("CC_BUILD",!1),c.CC_BUILD=!0,c.CC_TEST=!1,c.CC_EDITOR=!1,c.CC_PREVIEW=!1,c.CC_DEV=!1,c.CC_DEBUG=!1,c.CC_JSB=!1,c.CC_WECHATGAME=!0,c.CC_QQPLAY=!1,c.CC_RUNTIME=!1,c.CC_SUPPORT_JIT=!1,c.CC_PHYSICS_BUILTIN=!1,c.CC_PHYSICS_CANNON=!0,c.CC_PHYSICS_AMMO=!1;c.CocosEngine=e.ENGINE_VERSION="1.0.1",Object.defineProperty(c,"CC_PHYSICS_BUILT_IN",{get:function(){return console.warn("CC_PHYSICS_BUILT_IN is deprecated, please using CC_PHYSICS_BUILTIN instead."),c.CC_PHYSICS_BUILTIN}});var h=null,d=console.log,f=console.log,S=console.log,w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+T.apply(void 0,[t].concat(n)))}};function T(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function E(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return d.apply(void 0,[e].concat(i))}function C(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return f.apply(void 0,[e].concat(i))}function A(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return S.apply(void 0,[e].concat(i))}function k(e,t){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return w.apply(void 0,[e,t].concat(n))}function R(e){if(d=f=S=w=function(){},e!==F.NONE){if(e>F.ERROR){var a=function(e){if(cc.game.canvas){if(!h){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(h=document.createElement("textarea")).setAttribute("rows","20"),h.setAttribute("cols","30"),h.setAttribute("disabled","true");var n=h.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(h),cc.game.canvas.parentNode.appendChild(t)}h.value=h.value+e+"\r\n",h.scrollTop=h.scrollHeight}};S=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("ERROR :  "+T.apply(void 0,[e].concat(i)))},w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];a("ASSERT: "+T.apply(void 0,[t].concat(n)))}},e!==F.ERROR_FOR_WEB_PAGE&&(f=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("WARN :  "+T.apply(void 0,[e].concat(i)))}),e===F.INFO_FOR_WEB_PAGE&&(d=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a(T.apply(void 0,[e].concat(i)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),S=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},w=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=T.apply(void 0,[t].concat(n));throw new Error(a)}});e!==F.ERROR&&(f=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===F.INFO&&(d=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function O(e){var t=e.stack;A(t||e)}function M(a){return function(e){for(var t="".concat(a," ").concat(e,", please go to ").concat("https://github.com/cocos-creator/engine/blob/3d-v1.0.0/EngineErrorMap.md","#").concat(e," to see details."),i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return 0===n.length?t:t+" Arguments: "+n.join(", ")}}var I=M("Log");function L(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];E(I.apply(void 0,[e].concat(i)))}var z=M("Warning");function B(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];C(z.apply(void 0,[e].concat(i)))}var P=M("Error");function D(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];A(P.apply(void 0,[e].concat(i)))}var F,N,U=M("Assert");function V(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];k(!1,U.apply(void 0,[t].concat(n)))}}function G(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return P.apply(void 0,[e].concat(i))}function H(){return!!cc.profiler&&cc.profiler.isShowingStats()}function W(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}(N=F=F||{})[N.NONE=0]="NONE",N[N.INFO=1]="INFO",N[N.WARN=2]="WARN",N[N.ERROR=3]="ERROR",N[N.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",N[N.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",N[N.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE";var q=Object.freeze({log:E,warn:C,error:A,assert:k,_resetDebugSetting:R,_throw:O,logID:L,warnID:B,errorID:D,assertID:V,get DebugMode(){return F},getError:G,isDisplayStats:H,setDisplayStats:W}),j=/(\.[^\.\/\?\\]*)(\?.*)?$/,X=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Y=/[^\.\/]+\/\.\.\//;function K(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){e=(e+(""===e?"":"/")+a[r]).replace(/(\/|\\\\)$/,"")}return e}function Q(e){var t=j.exec(e);return t?t[1]:""}function Z(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function J(e,t){var i=e.indexOf("?");0<i&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function $(e){var t=X.exec(e);return t?t[2]:""}function ee(e,t){t=t||"";var i=e.indexOf("?"),n="";return 0<i&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function te(e,t,i){if(0===t.indexOf("."))return ee(e,t);var n=e.indexOf("?"),r="",a=i?Q(e):"";return 0<n&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function ie(e){for(var t=e=String(e);e=(t=e).replace(Y,""),t.length!==e.length;);return e}function ne(e){return e.replace(/[\/\\]$/,"")}function re(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}q3("path",Object.freeze({join:K,extname:Q,mainFileName:Z,basename:J,dirname:$,changeExtname:ee,changeBasename:te,_normalize:ie,stripSep:ne,getSeperator:re})),cc.log=E,cc.warn=C,cc.error=A,cc.assert=k,cc._throw=O,cc.logID=L,cc.warnID=B,cc.errorID=D,cc.assertID=V,cc.debug=q,cc.path={join:K,extname:Q,mainFileName:Z,basename:J,dirname:$,changeExtname:ee,changeBasename:te,_normalize:ie,stripSep:ne,get sep(){return re()}};var ae=2147483647;function se(e){return(0<e)-(e<0)}function oe(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}var le=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(le);var ue=Object.freeze({INT_BITS:32,INT_MAX:ae,INT_MIN:-1<<31,sign:se,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(65535<e)<<4,t|=i=(255<(e>>>=t))<<3,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1},log10:function(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:oe,nextPow2:function(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1},prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return le[255&e]<<24|le[e>>>8&255]<<16|le[e>>>16&255]<<8|le[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return 1+t|(~t&-~t)-1>>>oe(e)+1}});q3("bits",ue);var ce=function(){function t(e){y(this,t),this.array=e,this.i=0}return v(t,[{key:"remove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),t}();function he(e,t){e.splice(t,1)}function de(e,t){var i=e.indexOf(t);return 0<=i&&(he(e,i),!0)}function fe(e,t){return 0<=e.indexOf(t)}var pe=Object.freeze({removeAt:he,fastRemoveAt:function(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)},remove:de,fastRemove:function(e,t){var i=e.indexOf(t);0<=i&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(0<=i){var n=e[i];return he(e,i),n}},verifyType:function(e,t){if(e&&0<e.length){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(!(a instanceof t))return cc.logID(1300),!1}}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)de(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(u(t))),e},indexOf:function(e,t,i){return Array.prototype.indexOf.call(e,[t,i])},contains:fe,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:ce}),ve=function(){function t(e){y(this,t),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return v(t,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),t}();ve.global=new ve("global");var me=new ve("TmpCId.");function ye(e){return"number"==typeof e||e instanceof Number}function ge(e){return"string"==typeof e||e instanceof String}var be,xe,Se,we,Te=(be={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){be.value=i,be.writable=n,be.enumerable=r,Object.defineProperty(e,t,be),be.value=void 0}),Ee=(xe={get:void 0,set:void 0,enumerable:!1},function(e,t,i,n){var r=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=5<arguments.length&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof n&&(r=n,n=void 0),xe.get=i,xe.set=n,xe.enumerable=r,xe.configurable=a,Object.defineProperty(e,t,xe),xe.get=void 0,xe.set=void 0}),Ce=(Se={get:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){Se.get=i,Se.enumerable=n,Se.configurable=r,Object.defineProperty(e,t,Se),Se.get=void 0}),Ae=(we={set:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){we.set=i,we.enumerable=n,we.configurable=r,Object.defineProperty(e,t,we),we.set=void 0});function ke(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function Re(e){if("function"!=typeof e)return e&&e.constructor?Re(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}function Oe(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],s=r.exec(i)[0];function o(){return this[s]}n?Ee(e,a,o,function(e){this[s]=e}):Ce(e,a,o)}function Me(e,t,i,n){for(var r in i){Oe(e,t+"."+r,i[r],n)}}var Ie=/(%d)|(%s)/,Le=/%s/;function ze(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&Ie.test(e)){var r=i,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u="number"==typeof l?Ie:Le;u.test(e)?e=e.replace(u,l):e+=" "+l}}else{var c=i,h=Array.isArray(c),d=0;for(c=h?c:c[Symbol.iterator]();;){var f;if(h){if(d>=c.length)break;f=c[d++]}else{if((d=c.next()).done)break;f=d.value}e+=" "+f}}return e}function Be(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Pe(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function De(e,t,i){var n=Pe(t,e);n&&Object.defineProperty(i,e,n)}function Fe(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==_e(s)){cc.errorID(5402,s);continue}for(var o in s)o in e||De(o,s,e)}}return e}function Ne(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==_e(s)){cc.errorID(5403,s);continue}for(var o in s)De(o,s,e)}}return e}function Ue(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ve(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Ge(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ve(e)))return!1;if(e===t)return!0}}return!1}function He(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var We={},qe={};function je(e,t){var i="__cid__",n=We;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Te(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a='A Class already exists with the same __cid__ : "'+e+'".';0,cc.error(a)}else n[e]=t}}function Xe(e,t){if(function(e,t){var i="__classname__",n=qe;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],Te(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';0,cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||me.getNewId();i&&je(i,t)}}function Ye(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n].prototype,s=a.__cid__;s&&delete We[s];var o=a.__classname__;o&&delete qe[o]}}function Ke(e){return We[e]}function Qe(e){return qe[e]}function Ze(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Je=function(){function r(e,t){y(this,r),this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}return v(r,[{key:"get",value:function(){return this._get()}}]),v(r,[{key:"_get",value:function(){if(0<this.count){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),r}(),$e=pe,et={IDGenerator:ve,Pool:Je,array:pe,isNumber:ye,isString:ge,getPropertyDescriptor:Pe,addon:Fe,mixin:Ne,extend:Ue,getSuper:Ve,isChildClassOf:Ge,clear:He,value:Te,getset:Ee,get:Ce,set:Ae,unregisterClass:Ye,getClassName:Re,setClassName:Xe,getClassByName:Qe,_getClassId:Ze,_setClassId:je,_getClassById:Ke,obsolete:Oe,obsoletes:Me,formatStr:ze,shiftArguments:Be,createMap:ke};cc.js=et,q3("js",Object.freeze({array:$e,js:et,IDGenerator:ve,Pool:Je,isNumber:ye,isString:ge,value:Te,getset:Ee,get:Ce,set:Ae,createMap:ke,getClassName:Re,obsolete:Oe,obsoletes:Me,formatStr:ze,shiftArguments:Be,getPropertyDescriptor:Pe,addon:Fe,mixin:Ne,extend:Ue,getSuper:Ve,isChildClassOf:Ge,clear:He,_idToClass:We,_nameToClass:qe,_setClassId:je,setClassName:Xe,unregisterClass:Ye,_getClassById:Ke,getClassByName:Qe,_getClassId:Ze}));for(var tt=/^(?:cc|dragonBones|sp|ccsg)\..+/,it=new Array(123),nt=0;nt<123;++nt)it[nt]=64;for(var rt=0;rt<64;++rt)it["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(rt)]=rt;var at=it;function st(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];Ee(e,t,a,e[n])}}for(var r,a=e.prototype,s=0;s<t.length;s++){var o=(r=t[s])[0].toUpperCase()+r.slice(1);n(a,r,"get"+o,"set"+o)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function ot(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function lt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function ut(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function ct(e){return"object"===("undefined"==typeof window?"undefined":_e(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===_e(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ht(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function dt(e,t,i,n){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}_AFTER_CALL_}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(n)}function ft(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function pt(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function _t(e){if("__bitmask__"in e)return e;Te(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&Te(e,s,r)}return e}function vt(e){if("__enums__"in e)return e;Te(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&Te(e,s,r)}return e}function mt(e){"__enums__"in e||Te(e,"__enums__",null,!0)}cc.misc={BUILTIN_CLASSID_RE:tt,BASE64_VALUES:at,propertyDefine:st,nextPOT:ot,pushToMap:lt,contains:ut,isDomNode:ct,callInNextTick:ht,tryCatchFunctor_EDITOR:dt,isPlainEmptyObj_DEV:ft,cloneable_DEV:pt},q3("misc",Object.freeze({BUILTIN_CLASSID_RE:tt,BASE64_VALUES:at,propertyDefine:st,nextPOT:ot,pushToMap:lt,contains:ut,isDomNode:ct,callInNextTick:ht,tryCatchFunctor_EDITOR:dt,isPlainEmptyObj_DEV:ft,cloneable_DEV:pt})),_t.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},_t.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.BitMask=_t,vt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},vt.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.Enum=vt;var yt=q3("ValueType",function(){function e(){y(this,e)}return v(e,[{key:"clone",value:function(){return D(100,Re(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){D(100,Re(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}());Xe("cc.ValueType",yt),cc.ValueType=yt;var gt="$_$";function bt(e,t,i){var n;n=function(){},i&&Ue(n,i.constructor);var r=new n;return Te(e,"__attrs__",r),r}function xt(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;0<=n;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||bt(r,0,(t=i[n+1])&&t.__attrs__)}return bt(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function St(e,t,i){var n,r;if("function"==typeof e)r=(n=wt(e)).constructor.prototype;else{var a=e;if(!(n=a.__attrs__))n=bt(a,0,wt(e=a.constructor));r=n}if(void 0===i){var s=t+gt,o={};for(var l in n)l.startsWith(s)&&(o[l.slice(s.length)]=n[l]);return o}if("object"===_e(i))for(var u in i)95!==u.charCodeAt(0)&&(r[t+gt+u]=i[u]);else 0}function wt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||xt(e)}function Tt(e){return wt(e).constructor.prototype}function Et(e,t,i,n){Tt(e)[t+gt+i]=n}var Ct=function(){function i(e,t){y(this,i),this.name=void 0,this.default=void 0,this.name=e,this.default=t}return v(i,[{key:"toString",value:function(){return this.name}}]),i}(),At=q3("CCInteger",new Ct("Integer",0));cc.Integer=At,cc.CCInteger=At;var kt=q3("CCFloat",new Ct("Float",0));cc.Float=kt,cc.CCFloat=kt;var Rt=q3("CCBoolean",new Ct("Boolean",!1));cc.Boolean=Rt,cc.CCBoolean=Rt;var Ot=q3("CCString",new Ct("String",""));function Mt(l,u){return function(e,t){var i='"'+Re(e)+"."+t+'"',n=St(e,t);if(!n.saveUrlAsAsset){var r=n.type;if(r===At||r===kt?r="Number":r!==Ot&&r!==Rt||(r=r.toString()),r!==l)return void B(3604,i)}if(n.hasOwnProperty("default")){var a=n.default;if(void 0!==a)if(!(Array.isArray(a)||ft(a))){var s=_e(a),o=l.toLowerCase();if(s===o){if(!n.saveUrlAsAsset)if("object"===o){if(!a||a instanceof n.ctor)return;B(3605,i,Re(n.ctor))}else"Number"!==l&&B(3606,u,i,l)}else{if("function"===s)return;l===Ot.default&&null==a?Ge(n.ctor,cc.RawAsset)||B(3607,i):B(3611,u,i,s)}delete n.type}}}}function It(s){return function(e,t){Mt("Object","type")(e,t);var i=wt(e)[t+gt+"default"],n=cc.Class.getDefault(i);if(!Array.isArray(n)&&Ge(s,cc.ValueType)){var r=Re(s),a=ze('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Re(e),t,r);i?E(a):B(3612,a,r,Re(e),t,r)}}}cc.String=Ot,cc.CCString=Ot;var Lt=Object.freeze({DELIMETER:gt,createAttrsSingle:bt,createAttrs:xt,attr:St,getClassAttrs:wt,getClassAttrsProto:Tt,setClassAttr:Et,PrimitiveType:Ct,CCInteger:At,CCFloat:kt,CCBoolean:Rt,CCString:Ot,getTypeChecker:Mt,getObjTypeChecker:It}),zt={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Bt(e,t,i,n){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var s in n[r]=a,zt){var o=zt[s];e.hasOwnProperty(s)&&(a[s]=e[s],o.canUsedInGet||delete e[s])}}else 0}function Pt(e,t,i,n){if(Array.isArray(t)){if(!(0<t.length))return D(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Dt(e){if(e&&e.constructor===Object)return null;if(Array.isArray(e)&&0<e.length){e[0];return{default:[],type:e,_short:!0}}if("function"!=typeof e)return e instanceof Ct?{default:e.default,_short:!0}:{default:e,_short:!0};var t=e;return cc.RawAsset.isRawAssetType(t)?{default:"",url:t,_short:!0}:{default:Ge(t,cc.ValueType)?new t:null,type:t,_short:!0}}var Ft=[];function Nt(){return Ft[Ft.length-1]}cc._RF={push:function(e,t,i){void 0===i&&(i=t,t=""),Ft.push({uuid:t,script:i,module:e,exports:e.exports,beh:null})},pop:function(){var e=Ft.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:Nt};var Ut=gt,Vt=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function Gt(e,t){e.indexOf(t)<0&&e.push(t)}var Ht={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout(function(){t.init()},0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=Re(n);r?ri(n,a,r,n.$super,i.mixins):D(3633,a)}this.datas=null}}};function Wt(e,t){Gt(e.__props__,t)}var qt=[];function jt(e,t,i,n){var r=n.default;Et(e,i,"default",r),Wt(e,i);var a=li(e,n,t,i,!1);if(a){for(var s=qt,o=0;o<a.length;o++){var l=a[o];St(e,i,l),!1===l.serializable&&Gt(e.__values__,i),l._onAfterProp&&s.push(l._onAfterProp)}for(var u=0;u<s.length;u++)s[u](e,i);qt.length=0,a.length=0}}function Xt(e,t,i,n,r){var a=n.get,s=n.set,o=e.prototype,l=Object.getOwnPropertyDescriptor(o,i),u=!l;if(a){0;for(var c=li(e,n,t,i,!0),h=0;h<c.length;h++)St(e,i,c[h]);c.length=0,Et(e,i,"serializable",!1),r||Ce(o,i,a,u,u)}s&&(r||Ae(o,i,s,u,u))}function Yt(e){return"function"==typeof e?e():e}function Kt(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,Pe(t,n))}function Qt(e,t,i,n){var r,a,s=n.__ctor__,o=n.ctor,l=n.__ES6__;l?(r=[o],a=o):(r=s?[s]:function(e,t,i){for(var n=[],r=[e].concat(t),a=0;a<r.length;a++){var s=r[a];if(s)for(var o=ai._isCCClass(u=s)?u.__ctors__||[]:[u],l=0;l<o.length;l++)Gt(n,o[l])}var u;var c=i.ctor;c&&n.push(c);return n}(t,i,n),a=ei(r,t,e,n),Te(a,"extend",function(e){return e.extends=this,ai(e)},!0)),Te(a,"__ctors__",0<r.length?r:null,!0);var u=a.prototype;if(t&&(l||(Ue(a,t),u=a.prototype),a.$super=t),i){for(var c=function(e){var t=i[e];Kt(u,t.prototype),Kt(a,t,function(e){return t.hasOwnProperty(e)&&!0}),ai._isCCClass(t)&&Kt(wt(a).constructor.prototype,wt(t).constructor.prototype)},h=i.length-1;0<=h;h--)c(h);u.constructor=a}return l||(u.__initProps__=$t),Xe(e,a),a}function Zt(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var Jt=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function $t(e){var t=wt(e),i=e.__props__;null===i&&(Ht.init(),i=e.__props__);var n=function(e,t){for(var a=[],s=[],o=[],l=[],i=0;i<t.length;++i){var n=t[i],r=n+Ut+"default";if(r in e){var u=e[r];"object"===_e(u)&&u||"function"==typeof u?(a.push(n),s.push(u)):(o.push(n),l.push(u))}}return function(){for(var e=0;e<o.length;++e)this[o[e]]=l[e];for(var t=0;t<a.length;t++){var i=a[t],n=void 0,r=s[t];n="object"===_e(r)?r instanceof cc.ValueType?r.clone():Array.isArray(r)?[]:{}:r(),this[i]=n}}}(t,i);(e.prototype.__initProps__=n).call(this)}var ei=function(t,e,i,n){var r,a=e&&ni(e,n,i),s=t.length;return r=0<s?a?2===s?function(){this._super=null,this.__initProps__(r),t[0].apply(this,arguments),t[1].apply(this,arguments)}:function(){this._super=null,this.__initProps__(r);for(var e=0;e<t.length;++e)t[e].apply(this,arguments)}:3===s?function(){this.__initProps__(r),t[0].apply(this,arguments),t[1].apply(this,arguments),t[2].apply(this,arguments)}:function(){this.__initProps__(r);for(var e=r.__ctors__,t=0;t<e.length;++t)e[t].apply(this,arguments)}:function(){a&&(this._super=null),this.__initProps__(r)}};var ti=/xyz/.test(function(){}.toString()),ii=ti?/\b\._super\b/:/.*/;function ni(e,t){var i=!1;for(var n in t)if(!(0<=Vt.indexOf(n))){var r=t[n];if("function"==typeof r){var a=Pe(e.prototype,n);if(a){var s=a.value;if("function"==typeof s){ii.test(r)&&(i=!0,t[n]=function(i,n){return function(){var e=this._super;this._super=i;var t=n.apply(this,arguments);return this._super=e,t}}(s,r));continue}}0}}return i}function ri(t,e,i,n,r,a){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var s=0;s<r.length;++s){var o=r[s];o.__props__&&(t.__props__=t.__props__.concat(o.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i)for(var l in function(e,t){for(var i in e){var n=e[i],r=Dt(n);if(r&&(n=e[i]=r),n){var a=n.notify;a&&Bt(n,i,a,e),"type"in n&&Pt(n,n.type,t,i),"url"in n&&(o=(s=n).url,Array.isArray(o)&&0<o.length&&(o=o[0]),s.type=o),"type"in n&&n.type}}var s,o}(i,e),i){var u=i[l];"default"in u?jt(t,e,l,u):Xt(t,e,l,u,a)}var c=wt(t);t.__values__=t.__props__.filter(function(e){return!1!==c[e+Ut+"serializable"]})}function ai(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=Nt();if(a&&Ge(t,r)){if(Ge(a.cls,r))return D(3615),null;0,e=e||a.script}var s=Qt(e,t,i,n);if(a)if(Ge(t,r)){var o=a.uuid;o&&je(o,s),a.cls=s}else Ge(a.cls,r)||(a.cls=s);return s}(t,i,n,e);t=t||cc.js.getClassName(r),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some(function(e){return null===e.__props__})?(Ht.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):ri(r,t,a,i,e.mixins,e.__ES6__);var s,o,l=e.statics;if(l)for(s in l)r[s]=l[s];for(var u in e)if(!(0<=Vt.indexOf(u))){var c=e[u];"function"!=typeof(o=c)&&null!==o||Te(r.prototype,u,c,!0,!0)}var h=e.editor;return h&&Ge(i,cc.Component)&&cc.Component._registerEditorProps(r,h),r}ai._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},ai.fastDefine=function(e,t,i){Xe(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=Tt(t),a=0;a<n.length;a++){var s=n[a];r[s+Ut+"visible"]=!1,r[s+Ut+"default"]=i[s]}},ai.Attr=Lt,ai.attr=St,ai.getInheritanceChain=function(e){for(var t=[];e=Ve(e);)e!==Object&&t.push(e);return t};var si={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},oi=[];function li(e,n,t,i){var r=null,a="";function s(){return a=i+Ut,r=Tt(e)}oi.length=0;var o=oi,l=n.type;if(l){var u=si[l];if(u)o.push({type:l,_onAfterProp:void 0});else if("Object"===l)0;else if("object"===_e(l))vt.isEnum(l)?o.push({type:"Enum",enumList:vt.getList(l)}):_t.isBitMask(l)&&o.push({type:"BitMask",bitmaskList:_t.getList(l)});else if("function"==typeof l){var c;0,o.push({type:"Object",ctor:l,_onAfterProp:c})}else 0}function h(e,t){if(e in n){var i=n[e];_e(i)===t&&((r||s())[a+e]=i)}}n.editorOnly&&((r||s())[a+"editorOnly"]=!0),n.url&&((r||s())[a+"saveUrlAsAsset"]=!0),!1===n.serializable&&((r||s())[a+"serializable"]=!1),h("formerlySerializedAs","string");var d=n.range;return d&&Array.isArray(d)&&2<=d.length&&((r||s())[a+"min"]=d[0],(r||s())[a+"max"]=d[1],2<d.length&&((r||s())[a+"step"]=d[2])),h("min","number"),h("max","number"),h("step","number"),o}ai.isArray=function(e){return e=Yt(e),Array.isArray(e)},ai.getDefault=Yt,ai.escapeForJS=Zt,ai.IDENTIFIER_RE=Jt,ai.getNewValueTypeCode=!1,q3("CCClass",ai),cc.Class=ai;var ui=Math.PI/180,ci=180/Math.PI,hi=q3("EPSILON",1e-6);function di(e,t){return Math.abs(e-t)<=hi*Math.max(1,Math.abs(e),Math.abs(t))}function fi(e,t,i){return i=i||hi,Math.abs(e-t)<=i}function pi(e,t,i){if(i<t){var n=t;t=i,i=n}return e<t?t:i<e?i:e}function _i(e){return e<0?0:1<e?1:e}function vi(e,t,i){return e+(t-e)*i}function mi(e){return e*ui}function yi(e){return e*ci}var gi=q3("random",Math.random);function bi(e,t){return Math.random()*(t-e)+e}function xi(e,t){return Math.floor(bi(e,t))}function Si(e){return(e=(9301*e+49297)%233280)/233280}function wi(e,t,i){return Si(e)*(i-t)+t}function Ti(e,t,i){return Math.floor(wi(e,t,i))}function Ei(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Ci(e,t){return e-Math.floor(e/t)*t}function Ai(e,t){return e=Ci(e,2*t),e=t-Math.abs(e-t)}function ki(e,t,i){return(i-e)/(t-e)}var Ri=0,Oi=0,Mi=q3("Vec2",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).x=void 0,i.y=void 0,e&&"object"===_e(e)?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}return p(n,yt),v(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){return Ri=t.x-e.x,Oi=t.y-e.y,Math.sqrt(Ri*Ri+Oi*Oi)}},{key:"squaredDistance",value:function(e,t){return Ri=t.x-e.x,Oi=t.y-e.y,Ri*Ri+Oi*Oi}},{key:"len",value:function(e){return Ri=e.x,Oi=e.y,Math.sqrt(Ri*Ri+Oi*Oi)}},{key:"lengthSqr",value:function(e){return Ri=e.x,Oi=e.y,Ri*Ri+Oi*Oi}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){return Ri=t.x,Oi=t.y,Math.abs(Ri)<hi?e.x=0:e.x=1/Ri,Math.abs(Oi)<hi?e.y=0:e.y=1/Oi,e}},{key:"normalize",value:function(e,t){Ri=t.x,Oi=t.y;var i=Ri*Ri+Oi*Oi;return 0<i&&(i=1/Math.sqrt(i),e.x=Ri*i,e.y=Oi*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){return Ri=t.x,Oi=t.y,e.x=Ri+n*(i.x-Ri),e.y=Oi+n*(i.y-Oi),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){return Ri=t.x,Oi=t.y,e.x=i.m00*Ri+i.m03*Oi+i.m06,e.y=i.m01*Ri+i.m04*Oi+i.m07,e}},{key:"transformMat4",value:function(e,t,i){return Ri=t.x,Oi=t.y,e.x=i.m00*Ri+i.m04*Oi+i.m12,e.y=i.m01*Ri+i.m05*Oi+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(Ii,e),n.normalize(Li,t);var i=n.dot(Ii,Li);return 1<i?0:i<-1?Math.PI:Math.acos(i)}}]),v(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===_e(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){return Ri=this.x,Oi=this.y,this.x=Ri+t*(e.x-Ri),this.y=Oi+t*(e.y-Oi),this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===_e(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==_e(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){Ri=this.x,Oi=this.y;var e=Ri*Ri+Oi*Oi;return 0<e&&(e=1/Math.sqrt(e),this.x=this.x*e,this.y=this.y*e),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=pi(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){Ri=this.x,Oi=this.y;var t=Math.sin(e),i=Math.cos(e);return this.x=i*Ri-t*Oi,this.y=t*Ri+i*Oi,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){return Ri=this.x,Oi=this.y,this.x=e.m00*Ri+e.m04*Oi+e.m12,this.y=e.m01*Ri+e.m05*Oi+e.m13,this}}]),n}());Mi.ZERO=Object.freeze(new Mi(0,0)),Mi.ONE=Object.freeze(new Mi(1,1)),Mi.NEG_ONE=Object.freeze(new Mi(-1,-1)),Mi.UNIT_X=Object.freeze(new Mi(1,0)),Mi.UNIT_Y=Object.freeze(new Mi(0,1));var Ii=new Mi,Li=new Mi;function zi(e,t){return new Mi(e,t)}ai.fastDefine("cc.Vec2",Mi,{x:0,y:0}),cc.Vec2=Mi,cc.v2=zi;var Bi=0,Pi=0,Di=0,Fi=q3("Vec3",function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this))).x=void 0,n.y=void 0,n.z=void 0,e&&"object"===_e(e)?(n.x=e.x,n.y=e.y,n.z=e.z):(n.x=e||0,n.y=t||0,n.z=i||0),n}return p(r,yt),v(r,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){return Bi=t.x-e.x,Pi=t.y-e.y,Di=t.z-e.z,Math.sqrt(Bi*Bi+Pi*Pi+Di*Di)}},{key:"squaredDistance",value:function(e,t){return Bi=t.x-e.x,Pi=t.y-e.y,Di=t.z-e.z,Bi*Bi+Pi*Pi+Di*Di}},{key:"len",value:function(e){return Bi=e.x,Pi=e.y,Di=e.z,Math.sqrt(Bi*Bi+Pi*Pi+Di*Di)}},{key:"lengthSqr",value:function(e){return Bi=e.x,Pi=e.y,Di=e.z,Bi*Bi+Pi*Pi+Di*Di}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){return Bi=t.x,Pi=t.y,Di=t.z,Math.abs(Bi)<hi?e.x=0:e.x=1/Bi,Math.abs(Pi)<hi?e.y=0:e.y=1/Pi,Math.abs(Di)<hi?e.z=0:e.z=1/Di,e}},{key:"normalize",value:function(e,t){Bi=t.x,Pi=t.y,Di=t.z;var i=Bi*Bi+Pi*Pi+Di*Di;return 0<i&&(i=1/Math.sqrt(i),e.x=Bi*i,e.y=Pi*i,e.z=Di*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z;return e.x=r*l-a*o,e.y=a*s-n*l,e.z=n*o-r*s,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI,n=2*gi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){Bi=t.x,Pi=t.y,Di=t.z;var n=i.m03*Bi+i.m07*Pi+i.m11*Di+i.m15;return n=n?1/n:1,e.x=(i.m00*Bi+i.m04*Pi+i.m08*Di+i.m12)*n,e.y=(i.m01*Bi+i.m05*Pi+i.m09*Di+i.m13)*n,e.z=(i.m02*Bi+i.m06*Pi+i.m10*Di+i.m14)*n,e}},{key:"transformMat4Normal",value:function(e,t,i){Bi=t.x,Pi=t.y,Di=t.z;var n=i.m03*Bi+i.m07*Pi+i.m11*Di;return n=n?1/n:1,e.x=(i.m00*Bi+i.m04*Pi+i.m08*Di)*n,e.y=(i.m01*Bi+i.m05*Pi+i.m09*Di)*n,e.z=(i.m02*Bi+i.m06*Pi+i.m10*Di)*n,e}},{key:"transformMat3",value:function(e,t,i){return Bi=t.x,Pi=t.y,Di=t.z,e.x=Bi*i.m00+Pi*i.m03+Di*i.m06,e.y=Bi*i.m01+Pi*i.m04+Di*i.m07,e.z=Bi*i.m02+Pi*i.m05+Di*i.m08,e}},{key:"transformAffine",value:function(e,t,i){return Bi=t.x,Pi=t.y,Di=t.z,e.x=i.m00*Bi+i.m01*Pi+i.m02*Di+i.m03,e.y=i.m04*Bi+i.m05*Pi+i.m06*Di+i.m07,e.x=i.m08*Bi+i.m09*Pi+i.m10*Di+i.m11,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,s=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+s*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+s*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+s*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,s=t.y*r.y,o=t.z*r.z,l=i.w*a+i.y*o-i.z*s,u=i.w*s+i.z*a-i.x*o,c=i.w*o+i.x*s-i.y*a,h=-i.x*a-i.y*s-i.z*o;return e.x=l*i.w+h*-i.x+u*-i.z-c*-i.y+n.x,e.y=u*i.w+h*-i.y+c*-i.x-l*-i.z+n.y,e.z=c*i.w+h*-i.z+l*-i.y-u*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var a=t.x-n.x,s=t.y-n.y,o=t.z-n.z,l=i.w*a-i.y*o+i.z*s,u=i.w*s-i.z*a+i.x*o,c=i.w*o-i.x*s+i.y*a,h=i.x*a+i.y*s+i.z*o;return e.x=(l*i.w+h*i.x+u*i.z-c*i.y)/r.x,e.y=(u*i.w+h*i.y+c*i.x-l*i.z)/r.y,e.z=(c*i.w+h*i.z+l*i.y-u*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){Bi=t.x-i.x,Pi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Bi,o=Pi*r-Di*a,l=Pi*a+Di*r;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateY",value:function(e,t,i,n){Bi=t.x-i.x,Pi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Di*a+Bi*r,o=Pi,l=Di*r-Bi*a;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){Bi=t.x-i.x,Pi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Bi*r-Pi*a,o=Bi*a+Pi*r,l=Di;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi,r=e.x,a=e.y,s=e.z,o=t.x,l=t.y,u=t.z;return Math.abs(r-o)<=n*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=n*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(s-u)<=n*Math.max(1,Math.abs(s),Math.abs(u))}},{key:"angle",value:function(e,t){r.normalize(Ni,e),r.normalize(Ui,t);var i=r.dot(Ni,Ui);return 1<i?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return r.subtract(e,t,r.project(e,t,i))}},{key:"project",value:function(e,t,i){var n=r.lengthSqr(i);return n<1e-6?r.set(e,0,0,0):r.multiplyScalar(e,i,r.dot(t,i)/n)}}]),v(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z)}},{key:"set",value:function(e,t,i){return e&&"object"===_e(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i,n){var r=3<arguments.length&&void 0!==n?n:hi;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===_e(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==_e(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){Bi=this.x,Pi=this.y,Di=this.z;var e=Bi*Bi+Pi*Pi+Di*Di;return 0<e&&(e=1/Math.sqrt(e),this.x=Bi*e,this.y=Pi*e,this.z=Di*e),this}},{key:"transformMat4",value:function(e){Bi=this.x,Pi=this.y,Di=this.z;var t=e.m03*Bi+e.m07*Pi+e.m11*Di+e.m15;return t=t?1/t:1,this.x=(e.m00*Bi+e.m04*Pi+e.m08*Di+e.m12)*t,this.y=(e.m01*Bi+e.m05*Pi+e.m09*Di+e.m13)*t,this.z=(e.m02*Bi+e.m06*Pi+e.m10*Di+e.m14)*t,this}}]),r}());Fi.UNIT_X=Object.freeze(new Fi(1,0,0)),Fi.UNIT_Y=Object.freeze(new Fi(0,1,0)),Fi.UNIT_Z=Object.freeze(new Fi(0,0,1)),Fi.ZERO=Object.freeze(new Fi(0,0,0)),Fi.ONE=Object.freeze(new Fi(1,1,1)),Fi.NEG_ONE=Object.freeze(new Fi(-1,-1,-1));var Ni=new Fi,Ui=new Fi;function Vi(e,t,i){return new Fi(e,t,i)}ai.fastDefine("cc.Vec3",Fi,{x:0,y:0,z:0}),cc.Vec3=Fi,cc.v3=Vi;var Gi=0,Hi=0,Wi=0,qi=0,ji=q3("Vec4",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===_e(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||0),r}return p(a,yt),v(a,null,[{key:"clone",value:function(e){return new a(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){return Gi=e.x,Hi=e.y,Wi=e.z,qi=e.w,Math.sqrt(Gi*Gi+Hi*Hi+Wi*Wi+qi*qi)}},{key:"lengthSqr",value:function(e){return Gi=e.x,Hi=e.y,Wi=e.z,qi=e.w,Gi*Gi+Hi*Hi+Wi*Wi+qi*qi}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){return Gi=t.x,Hi=t.y,Wi=t.z,qi=t.w,Math.abs(Gi)<hi?e.x=0:e.x=1/Gi,Math.abs(Hi)<hi?e.y=0:e.y=1/Hi,Math.abs(Wi)<hi?e.z=0:e.z=1/Wi,Math.abs(qi)<hi?e.w=0:e.w=1/qi,e}},{key:"normalize",value:function(e,t){Gi=t.x,Hi=t.y,Wi=t.z,qi=t.w;var i=Gi*Gi+Hi*Hi+Wi*Wi+qi*qi;return 0<i&&(i=1/Math.sqrt(i),e.x=Gi*i,e.y=Hi*i,e.z=Wi*i,e.w=qi*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*gi()*Math.PI,n=2*gi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){return Gi=t.x,Hi=t.y,Wi=t.z,qi=t.w,e.x=i.m00*Gi+i.m04*Hi+i.m08*Wi+i.m12*qi,e.y=i.m01*Gi+i.m05*Hi+i.m09*Wi+i.m13*qi,e.z=i.m02*Gi+i.m06*Hi+i.m10*Wi+i.m14*qi,e.w=i.m03*Gi+i.m07*Hi+i.m11*Wi+i.m15*qi,e}},{key:"transformAffine",value:function(e,t,i){return Gi=t.x,Hi=t.y,Wi=t.z,qi=t.w,e.x=i.m00*Gi+i.m01*Hi+i.m02*Wi+i.m03*qi,e.y=i.m04*Gi+i.m05*Hi+i.m06*Wi+i.m07*qi,e.x=i.m08*Gi+i.m09*Hi+i.m10*Wi+i.m11*qi,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;Gi=i.x,Hi=i.y,Wi=i.z;var s=(qi=i.w)*n+Hi*a-Wi*r,o=qi*r+Wi*n-Gi*a,l=qi*a+Gi*r-Hi*n,u=-Gi*n-Hi*r-Wi*a;return e.x=s*qi+u*-Gi+o*-Wi-l*-Hi,e.y=o*qi+u*-Hi+l*-Gi-s*-Wi,e.z=l*qi+u*-Wi+s*-Hi-o*-Gi,e.w=t.w,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),v(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===_e(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n,r){var a=4<arguments.length&&void 0!==r?r:hi;return Math.abs(this.x-e)<=a*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=a*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=a*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=a*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){return Gi=this.x,Hi=this.y,Wi=this.z,qi=this.w,this.x=Gi+t*(e.x-Gi),this.y=Hi+t*(e.y-Hi),this.z=Wi+t*(e.z-Wi),this.w=qi+t*(e.w-qi),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this.w=pi(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===_e(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==_e(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Gi=this.x,Hi=this.y,Wi=this.z,qi=this.w,Math.sqrt(Gi*Gi+Hi*Hi+Wi*Wi+qi*qi)}},{key:"lengthSqr",value:function(){return Gi=this.x,Hi=this.y,Wi=this.z,qi=this.w,Gi*Gi+Hi*Hi+Wi*Wi+qi*qi}},{key:"normalize",value:function(){Gi=this.x,Hi=this.y,Wi=this.z,qi=this.w;var e=Gi*Gi+Hi*Hi+Wi*Wi+qi*qi;return 0<e&&(e=1/Math.sqrt(e),this.x=Gi*e,this.y=Hi*e,this.z=Wi*e,this.w=qi*e),this}},{key:"transformMat4",value:function(e){return Gi=this.x,Hi=this.y,Wi=this.z,qi=this.w,this.x=e.m00*Gi+e.m04*Hi+e.m08*Wi+e.m12*qi,this.y=e.m01*Gi+e.m05*Hi+e.m09*Wi+e.m13*qi,this.z=e.m02*Gi+e.m06*Hi+e.m10*Wi+e.m14*qi,this.w=e.m03*Gi+e.m07*Hi+e.m11*Wi+e.m15*qi,this}}]),a}());function Xi(e,t,i,n){return new ji(e,t,i,n)}ji.ZERO=Object.freeze(new ji(0,0,0,0)),ji.ONE=Object.freeze(new ji(1,1,1,1)),ji.NEG_ONE=Object.freeze(new ji(-1,-1,-1,-1)),ai.fastDefine("cc.Vec4",ji,{x:0,y:0,z:0,w:0}),cc.Vec4=ji,cc.v4=Xi;var Yi=0,Ki=0,Qi=0,Zi=0,Ji=0,$i=0,en=0,tn=0,nn=0,rn=q3("Mat3",function(){function c(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,u=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;return y(this,c),(e=x(this,g(c).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,"object"===_e(t)?(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08):(e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u),e}return p(c,yt),v(c,null,[{key:"clone",value:function(e){return new c(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){return e===t?(Ki=t.m01,Qi=t.m02,$i=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=Ki,e.m05=t.m07,e.m06=Qi,e.m07=$i):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e}},{key:"invert",value:function(e,t){Yi=t.m00,Ki=t.m01,Qi=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07;var i=(nn=t.m08)*Ji-$i*tn,n=-nn*Zi+$i*en,r=tn*Zi-Ji*en,a=Yi*i+Ki*n+Qi*r;return a&&(a=1/a,e.m00=i*a,e.m01=(-nn*Ki+Qi*tn)*a,e.m02=($i*Ki-Qi*Ji)*a,e.m03=n*a,e.m04=(nn*Yi-Qi*en)*a,e.m05=(-$i*Yi+Qi*Zi)*a,e.m06=r*a,e.m07=(-tn*Yi+Ki*en)*a,e.m08=(Ji*Yi-Ki*Zi)*a),e}},{key:"determinant",value:function(e){return Yi=e.m00,Ki=e.m01,Qi=e.m02,Zi=e.m03,Ji=e.m04,$i=e.m05,en=e.m06,tn=e.m07,nn=e.m08,Yi*(nn*Ji-$i*tn)+Ki*(-nn*Zi+$i*en)+Qi*(tn*Zi-Ji*en)}},{key:"multiply",value:function(e,t,i){Yi=t.m00,Ki=t.m01,Qi=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m03,o=i.m04,l=i.m05,u=i.m06,c=i.m07,h=i.m08;return e.m00=n*Yi+r*Zi+a*en,e.m01=n*Ki+r*Ji+a*tn,e.m02=n*Qi+r*$i+a*nn,e.m03=s*Yi+o*Zi+l*en,e.m04=s*Ki+o*Ji+l*tn,e.m05=s*Qi+o*$i+l*nn,e.m06=u*Yi+c*Zi+h*en,e.m07=u*Ki+c*Ji+h*tn,e.m08=u*Qi+c*$i+h*nn,e}},{key:"multiplyMat4",value:function(e,t,i){Yi=t.m00,Ki=t.m01,Qi=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m04,o=i.m05,l=i.m06,u=i.m08,c=i.m09,h=i.m10;return e.m00=n*Yi+r*Zi+a*en,e.m01=n*Ki+r*Ji+a*tn,e.m02=n*Qi+r*$i+a*nn,e.m03=s*Yi+o*Zi+l*en,e.m04=s*Ki+o*Ji+l*tn,e.m05=s*Qi+o*$i+l*nn,e.m06=u*Yi+c*Zi+h*en,e.m07=u*Ki+c*Ji+h*tn,e.m08=u*Qi+c*$i+h*nn,e}},{key:"transfrom",value:function(e,t,i){Yi=t.m00,Ki=t.m01,Qi=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=i.x,r=i.y;return e.m00=Yi,e.m01=Ki,e.m02=Qi,e.m03=Zi,e.m04=Ji,e.m05=$i,e.m06=n*Yi+r*Zi+en,e.m07=n*Ki+r*Ji+tn,e.m08=n*Qi+r*$i+nn,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){Yi=t.m00,Ki=t.m01,Qi=t.m02,Zi=t.m03,Ji=t.m04,$i=t.m05,en=t.m06,tn=t.m07,nn=t.m08;var n=Math.sin(i),r=Math.cos(i);return e.m00=r*Yi+n*Zi,e.m01=r*Ki+n*Ji,e.m02=r*Qi+n*$i,e.m03=r*Zi-n*Yi,e.m04=r*Ji-n*Ki,e.m05=r*$i-n*Qi,e.m06=en,e.m07=tn,e.m08=nn,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return Fi.lengthSqr(t)<hi*hi?(c.identity(e),e):(i=i||Fi.UNIT_Y,Fi.normalize(an,Fi.cross(an,i,t)),Fi.lengthSqr(an)<hi*hi?c.identity(e):(Fi.cross(sn,t,an),c.set(e,an.x,an.y,an.z,sn.x,sn.y,sn.z,t.x,t.y,t.z)),e)}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,u=i*s,c=n*s,h=n*o,d=r*s,f=r*o,p=r*l,_=a*s,v=a*o,m=a*l;return e.m00=1-h-p,e.m03=c-m,e.m06=d+v,e.m01=c+m,e.m04=1-u-p,e.m07=f-_,e.m02=d-v,e.m05=f+_,e.m08=1-u-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,u=t.m07,c=t.m08,h=t.m09,d=t.m10,f=t.m11,p=t.m12,_=t.m13,v=t.m14,m=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*u-a*s,x=n*l-r*o,S=n*u-a*o,w=r*u-a*l,T=c*_-h*p,E=c*v-d*p,C=c*m-f*p,A=h*v-d*_,k=h*m-f*_,R=d*m-f*v,O=y*R-g*k+b*A+x*C-S*E+w*T;return O?(O=1/O,e.m00=(o*R-l*k+u*A)*O,e.m01=(l*C-s*R-u*E)*O,e.m02=(s*k-o*C+u*T)*O,e.m03=(r*k-n*R-a*A)*O,e.m04=(i*R-r*C+a*E)*O,e.m05=(n*C-i*k-a*T)*O,e.m06=(_*w-v*S+m*x)*O,e.m07=(v*b-p*w-m*g)*O,e.m08=(p*S-_*b+m*y)*O,e):null}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),v(c,[{key:"clone",value:function(){return new c(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08)}},{key:"set",value:function(e,t,i,n,r,a,s,o,l){var u=0<arguments.length&&void 0!==e?e:1,c=1<arguments.length&&void 0!==t?t:0,h=2<arguments.length&&void 0!==i?i:0,d=3<arguments.length&&void 0!==n?n:0,f=4<arguments.length&&void 0!==r?r:1,p=5<arguments.length&&void 0!==a?a:0,_=6<arguments.length&&void 0!==s?s:0,v=7<arguments.length&&void 0!==o?o:0,m=8<arguments.length&&void 0!==l?l:1;return"object"===_e(u)?(this.m00=u.m00,this.m01=u.m01,this.m02=u.m02,this.m03=u.m03,this.m04=u.m04,this.m05=u.m05,this.m06=u.m06,this.m07=u.m07,this.m08=u.m08):(this.m00=u,this.m01=c,this.m02=h,this.m03=d,this.m04=f,this.m05=p,this.m06=_,this.m07=v,this.m08=m),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+",\n"+this.m03+",\n"+this.m04+", "+this.m05+",\n"+this.m06+", "+this.m07+",\n"+this.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){Yi=this.m00,Ki=this.m01,Qi=this.m02,Zi=this.m03,Ji=this.m04,$i=this.m05,en=this.m06,tn=this.m07;var e=(nn=this.m08)*Ji-$i*tn,t=-nn*Zi+$i*en,i=tn*Zi-Ji*en,n=Yi*e+Ki*t+Qi*i;return n?(n=1/n,this.m00=e*n,this.m01=(-nn*Ki+Qi*tn)*n,this.m02=($i*Ki-Qi*Ji)*n,this.m03=t*n,this.m04=(nn*Yi-Qi*en)*n,this.m05=(-$i*Yi+Qi*Zi)*n,this.m06=i*n,this.m07=(-tn*Yi+Ki*en)*n,this.m08=(Ji*Yi-Ki*Zi)*n,this):null}},{key:"determinant",value:function(){return Yi=this.m00,Ki=this.m01,Qi=this.m02,Zi=this.m03,Ji=this.m04,$i=this.m05,en=this.m06,tn=this.m07,nn=this.m08,Yi*(nn*Ji-$i*tn)+Ki*(-nn*Zi+$i*en)+Qi*(tn*Zi-Ji*en)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,s=this.m05,o=this.m06,l=this.m07,u=this.m08,c=e.m00,h=e.m01,d=e.m02,f=e.m03,p=e.m04,_=e.m05,v=e.m06,m=e.m07,y=e.m08;return this.m00=c*t+h*r+d*o,this.m01=c*i+h*a+d*l,this.m02=c*n+h*s+d*u,this.m03=f*t+p*r+_*o,this.m04=f*i+p*a+_*l,this.m05=f*n+p*s+_*u,this.m06=v*t+m*r+y*o,this.m07=v*i+m*a+y*l,this.m08=v*n+m*s+y*u,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){Yi=this.m00,Ki=this.m01,Qi=this.m02,Zi=this.m03,Ji=this.m04,$i=this.m05,en=this.m06,tn=this.m07,nn=this.m08;var t=Math.sin(e),i=Math.cos(e);return this.m00=i*Yi+t*Zi,this.m01=i*Ki+t*Ji,this.m02=i*Qi+t*$i,this.m03=i*Zi-t*Yi,this.m04=i*Ji-t*Ki,this.m05=i*$i-t*Qi,this.m06=en,this.m07=tn,this.m08=nn,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=i*a,c=i*s,h=n*a,d=n*s,f=n*o,p=r*a,_=r*s,v=r*o;return this.m00=1-c-f,this.m03=u-v,this.m06=h+_,this.m01=u+v,this.m04=1-l-f,this.m07=d-p,this.m02=h-_,this.m05=d+p,this.m08=1-l-c,this}}]),c}());rn.IDENTITY=Object.freeze(new rn);var an=new Fi,sn=new Fi;ai.fastDefine("cc.Mat3",rn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=rn;var on=0,ln=0,un=0,cn=0,hn=q3("Quat",function(){function s(e,t,i,n){var r;return y(this,s),(r=x(this,g(s).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===_e(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||1),r}return p(s,yt),v(s,null,[{key:"clone",value:function(e){return new s(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var n=Fi.dot(t,i);return n<-.999999?(Fi.cross(pn,Fi.UNIT_X,t),pn.length()<1e-6&&Fi.cross(pn,Fi.UNIT_Y,t),Fi.normalize(pn,pn),s.fromAxisAngle(e,pn,Math.PI),e):.999999<n?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Fi.cross(pn,t,i),e.x=pn.x,e.y=pn.y,e.z=pn.z,e.w=1+n,s.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){return on=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,ln=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,un=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,cn=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z,e.x=on,e.y=ln,e.z=un,e.w=cn,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.w*n,e.y=t.y*r+t.z*n,e.z=t.z*r-t.y*n,e.w=t.w*r-t.x*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r-t.z*n,e.y=t.y*r+t.w*n,e.z=t.z*r+t.x*n,e.w=t.w*r-t.y*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.y*n,e.y=t.y*r-t.x*n,e.z=t.z*r+t.w*n,e.w=t.w*r-t.z*n,e}},{key:"rotateAround",value:function(e,t,i,n){return s.invert(dn,t),Fi.transformQuat(pn,i,dn),s.fromAxisAngle(dn,pn,n),s.multiply(e,t,dn),e}},{key:"rotateAroundLocal",value:function(e,t,i,n){return s.fromAxisAngle(dn,i,n),s.multiply(e,t,dn),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,s=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(s<0&&(s=-s,i.x=-i.x,i.y=-i.y,i.z=-i.z,i.w=-i.w),1e-6<1-s){var o=Math.acos(s),l=Math.sin(o);r=Math.sin((1-n)*o)/l,a=Math.sin(n*o)/l}else r=1-n,a=n;return e.x=r*t.x+a*i.x,e.y=r*t.y+a*i.y,e.z=r*t.z+a*i.z,e.w=r*t.w+a*i.w,e}},{key:"sqlerp",value:function(e,t,i,n,r,a){return s.slerp(dn,t,r,a),s.slerp(fn,i,n,a),s.slerp(e,dn,fn,2*a*(1-a)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return 0<i&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,n){return rn.set(_n,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),s.normalize(e,s.fromMat3(e,_n))}},{key:"fromViewUp",value:function(e,t,i){return rn.fromViewUp(_n,t,i),s.normalize(e,s.fromMat3(e,_n))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,s=t.m04,o=t.m07,l=t.m02,u=t.m05,c=t.m08,h=i+s+c;if(0<h){var d=.5/Math.sqrt(h+1);e.w=.25/d,e.x=(u-o)*d,e.y=(r-l)*d,e.z=(a-n)*d}else if(s<i&&c<i){var f=2*Math.sqrt(1+i-s-c);e.w=(u-o)/f,e.x=.25*f,e.y=(n+a)/f,e.z=(r+l)/f}else if(c<s){var p=2*Math.sqrt(1+s-i-c);e.w=(r-l)/p,e.x=(n+a)/p,e.y=.25*p,e.z=(o+u)/p}else{var _=2*Math.sqrt(1+c-i-s);e.w=(a-n)/_,e.x=(r+l)/_,e.y=(o+u)/_,e.z=.25*_}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=vn,i*=vn,n*=vn;var r=Math.sin(t),a=Math.cos(t),s=Math.sin(i),o=Math.cos(i),l=Math.sin(n),u=Math.cos(n);return e.x=r*o*u+a*s*l,e.y=a*s*u+r*o*l,e.z=a*o*l-r*s*u,e.w=a*o*u-r*s*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=0,l=0,u=0,c=n*r+a*s;if(.499999<c)o=0,l=yi(2*Math.atan2(n,s)),u=90;else if(c<-.499999)o=0,l=-yi(2*Math.atan2(n,s)),u=-90;else{var h=n*n,d=r*r,f=a*a;o=yi(Math.atan2(2*n*s-2*r*a,1-2*h-2*f)),l=yi(Math.atan2(2*r*s-2*n*a,1-2*d-2*f)),u=yi(Math.asin(2*c)),i&&(o=-180*Math.sign(o+1e-6)+o,l=-180*Math.sign(l+1e-6)+l,u=180*Math.sign(u+1e-6)-u)}return e.x=o,e.y=l,e.z=u,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),v(s,[{key:"clone",value:function(){return new s(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===_e(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||1),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return s.toEuler(e,this)}},{key:"lerp",value:function(e,t){var i=0,n=0,r=this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;if(r<0&&(r=-r,e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),1e-6<1-r){var a=Math.acos(r),s=Math.sin(a);i=Math.sin((1-t)*a)/s,n=Math.sin(t*a)/s}else i=1-t,n=t;return this.x=i*this.x+n*e.x,this.y=i*this.y+n*e.y,this.z=i*this.z+n*e.z,this.w=i*this.w+n*e.w,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),s}());hn.IDENTITY=Object.freeze(new hn);var dn=new hn,fn=new hn,pn=new Fi,_n=new rn,vn=.5*Math.PI/180;function mn(){return new hn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}ai.fastDefine("cc.Quat",hn,{x:0,y:0,z:0,w:1}),cc.Quat=hn,cc.quat=mn;var yn=0,gn=0,bn=0,xn=0,Sn=0,wn=0,Tn=0,En=0,Cn=0,An=0,kn=0,Rn=0,On=0,Mn=0,In=0,Ln=0,zn=q3("Mat4",function(){function m(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,u=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,h=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,d=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,f=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,p=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,_=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,v=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return y(this,m),(e=x(this,g(m).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===_e(t)?(e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e.m00=t.m00):(e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e.m09=c,e.m10=h,e.m11=d,e.m12=f,e.m13=p,e.m14=_,e.m15=v,e.m00=t),e}return p(m,yt),v(m,null,[{key:"clone",value:function(e){return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p,_,v){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e.m09=c,e.m10=h,e.m11=d,e.m12=f,e.m13=p,e.m14=_,e.m15=v,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,s=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=s,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15;var i=yn*wn-gn*Sn,n=yn*Tn-bn*Sn,r=yn*En-xn*Sn,a=gn*Tn-bn*wn,s=gn*En-xn*wn,o=bn*En-xn*Tn,l=Cn*Mn-An*On,u=Cn*In-kn*On,c=Cn*Ln-Rn*On,h=An*In-kn*Mn,d=An*Ln-Rn*Mn,f=kn*Ln-Rn*In,p=i*f-n*d+r*h+a*c-s*u+o*l;return 0===p||(p=1/p,e.m00=(wn*f-Tn*d+En*h)*p,e.m01=(bn*d-gn*f-xn*h)*p,e.m02=(Mn*o-In*s+Ln*a)*p,e.m03=(kn*s-An*o-Rn*a)*p,e.m04=(Tn*c-Sn*f-En*u)*p,e.m05=(yn*f-bn*c+xn*u)*p,e.m06=(In*r-On*o-Ln*n)*p,e.m07=(Cn*o-kn*r+Rn*n)*p,e.m08=(Sn*d-wn*c+En*l)*p,e.m09=(gn*c-yn*d-xn*l)*p,e.m10=(On*s-Mn*r+Ln*i)*p,e.m11=(An*r-Cn*s-Rn*i)*p,e.m12=(wn*u-Sn*h-Tn*l)*p,e.m13=(yn*h-gn*u+bn*l)*p,e.m14=(Mn*n-On*a-In*i)*p,e.m15=(Cn*a-An*n+kn*i)*p),e}},{key:"determinant",value:function(e){return yn=e.m00,gn=e.m01,bn=e.m02,xn=e.m03,Sn=e.m04,wn=e.m05,Tn=e.m06,En=e.m07,Cn=e.m08,An=e.m09,kn=e.m10,Rn=e.m11,On=e.m12,Mn=e.m13,In=e.m14,Ln=e.m15,(yn*wn-gn*Sn)*(kn*Ln-Rn*In)-(yn*Tn-bn*Sn)*(An*Ln-Rn*Mn)+(yn*En-xn*Sn)*(An*In-kn*Mn)+(gn*Tn-bn*wn)*(Cn*Ln-Rn*On)-(gn*En-xn*wn)*(Cn*In-kn*On)+(bn*En-xn*Tn)*(Cn*Mn-An*On)}},{key:"multiply",value:function(e,t,i){yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15;var n=i.m00,r=i.m01,a=i.m02,s=i.m03;return e.m00=n*yn+r*Sn+a*Cn+s*On,e.m01=n*gn+r*wn+a*An+s*Mn,e.m02=n*bn+r*Tn+a*kn+s*In,e.m03=n*xn+r*En+a*Rn+s*Ln,n=i.m04,r=i.m05,a=i.m06,s=i.m07,e.m04=n*yn+r*Sn+a*Cn+s*On,e.m05=n*gn+r*wn+a*An+s*Mn,e.m06=n*bn+r*Tn+a*kn+s*In,e.m07=n*xn+r*En+a*Rn+s*Ln,n=i.m08,r=i.m09,a=i.m10,s=i.m11,e.m08=n*yn+r*Sn+a*Cn+s*On,e.m09=n*gn+r*wn+a*An+s*Mn,e.m10=n*bn+r*Tn+a*kn+s*In,e.m11=n*xn+r*En+a*Rn+s*Ln,n=i.m12,r=i.m13,a=i.m14,s=i.m15,e.m12=n*yn+r*Sn+a*Cn+s*On,e.m13=n*gn+r*wn+a*An+s*Mn,e.m14=n*bn+r*Tn+a*kn+s*In,e.m15=n*xn+r*En+a*Rn+s*Ln,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return t===e?(e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15):(yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15,e.m00=yn,e.m01=gn,e.m02=bn,e.m03=xn,e.m04=Sn,e.m05=wn,e.m06=Tn,e.m07=En,e.m08=Cn,e.m09=An,e.m10=kn,e.m11=Rn,e.m12=yn*n+Sn*r+Cn*a+t.m12,e.m13=gn*n+wn*r+An*a+t.m13,e.m14=bn*n+Tn*r+kn*a+t.m14,e.m15=xn*n+En*r+Rn*a+t.m15),e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.y):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,s=n.z,o=Math.sqrt(r*r+a*a+s*s);if(Math.abs(o)<hi)return null;r*=o=1/o,a*=o,s*=o;var l=Math.sin(i),u=Math.cos(i),c=1-u;yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11;var h=r*r*c+u,d=a*r*c+s*l,f=s*r*c-a*l,p=r*a*c-s*l,_=a*a*c+u,v=s*a*c+r*l,m=r*s*c+a*l,y=a*s*c-r*l,g=s*s*c+u;return e.m00=yn*h+Sn*d+Cn*f,e.m01=gn*h+wn*d+An*f,e.m02=bn*h+Tn*d+kn*f,e.m03=xn*h+En*d+Rn*f,e.m04=yn*p+Sn*_+Cn*v,e.m05=gn*p+wn*_+An*v,e.m06=bn*p+Tn*_+kn*v,e.m07=xn*p+En*_+Rn*v,e.m08=yn*m+Sn*y+Cn*g,e.m09=gn*m+wn*y+An*g,e.m10=bn*m+Tn*y+kn*g,e.m11=xn*m+En*y+Rn*g,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,s=t.m05,o=t.m06,l=t.m07,u=t.m08,c=t.m09,h=t.m10,d=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+u*n,e.m05=s*r+c*n,e.m06=o*r+h*n,e.m07=l*r+d*n,e.m08=u*r-a*n,e.m09=c*r-s*n,e.m10=h*r-o*n,e.m11=d*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,u=t.m08,c=t.m09,h=t.m10,d=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-u*n,e.m01=s*r-c*n,e.m02=o*r-h*n,e.m03=l*r-d*n,e.m08=a*n+u*r,e.m09=s*n+c*r,e.m10=o*n+h*r,e.m11=l*n+d*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,u=t.m04,c=t.m05,h=t.m06,d=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+u*n,e.m01=s*r+c*n,e.m02=o*r+h*n,e.m03=l*r+d*n,e.m04=u*r-a*n,e.m05=c*r-s*n,e.m06=h*r-o*n,e.m07=d*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,s=Math.sqrt(n*n+r*r+a*a);if(Math.abs(s)<hi)return null;n*=s=1/s,r*=s,a*=s;var o=Math.sin(t),l=Math.cos(t),u=1-l;return e.m00=n*n*u+l,e.m01=r*n*u+a*o,e.m02=a*n*u-r*o,e.m03=0,e.m04=n*r*u-a*o,e.m05=r*r*u+l,e.m06=a*r*u+n*o,e.m07=0,e.m08=n*a*u+r*o,e.m09=r*a*u-n*o,e.m10=a*a*u+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=n+n,l=r+r,u=a+a,c=n*o,h=n*l,d=n*u,f=r*l,p=r*u,_=a*u,v=s*o,m=s*l,y=s*u;return e.m00=1-(f+_),e.m01=h+y,e.m02=d-m,e.m03=0,e.m04=h-y,e.m05=1-(c+_),e.m06=p+v,e.m07=0,e.m08=d+m,e.m09=p-v,e.m10=1-(c+f),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=Pn.m00=t.m00,n=Pn.m01=t.m01,r=Pn.m02=t.m02,a=Pn.m03=t.m04,s=Pn.m04=t.m05,o=Pn.m05=t.m06,l=Pn.m06=t.m08,u=Pn.m07=t.m09,c=Pn.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+s*s+o*o),e.z=Math.sqrt(l*l+u*u+c*c),rn.determinant(Pn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return 0<i?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=Fi.set(Bn,e.m00,e.m01,e.m02).length(),Pn.m00=e.m00/n.x,Pn.m01=e.m01/n.x,Pn.m02=e.m02/n.x,n.y=Fi.set(Bn,e.m04,e.m05,e.m06).length(),Pn.m03=e.m04/n.y,Pn.m04=e.m05/n.y,Pn.m05=e.m06/n.y,n.z=Fi.set(Bn,e.m08,e.m09,e.m10).length(),Pn.m06=e.m08/n.z,Pn.m07=e.m09/n.z,Pn.m08=e.m10/n.z,rn.determinant(Pn)<0&&(n.x*=-1,Pn.m00*=-1,Pn.m01*=-1,Pn.m02*=-1),hn.fromMat3(t,Pn),Fi.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=r+r,u=a+a,c=s+s,h=r*l,d=r*u,f=r*c,p=a*u,_=a*c,v=s*c,m=o*l,y=o*u,g=o*c,b=n.x,x=n.y,S=n.z;return e.m00=(1-(p+v))*b,e.m01=(d+g)*b,e.m02=(f-y)*b,e.m03=0,e.m04=(d-g)*x,e.m05=(1-(h+v))*x,e.m06=(_+m)*x,e.m07=0,e.m08=(f+y)*S,e.m09=(_-m)*S,e.m10=(1-(h+p))*S,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,s=t.y,o=t.z,l=t.w,u=a+a,c=s+s,h=o+o,d=a*u,f=a*c,p=a*h,_=s*c,v=s*h,m=o*h,y=l*u,g=l*c,b=l*h,x=n.x,S=n.y,w=n.z,T=r.x,E=r.y,C=r.z;return e.m00=(1-(_+m))*x,e.m01=(f+b)*x,e.m02=(p-g)*x,e.m03=0,e.m04=(f-b)*S,e.m05=(1-(d+m))*S,e.m06=(v+y)*S,e.m07=0,e.m08=(p+g)*w,e.m09=(v-y)*w,e.m10=(1-(d+_))*w,e.m11=0,e.m12=i.x+T-(e.m00*T+e.m04*E+e.m08*C),e.m13=i.y+E-(e.m01*T+e.m05*E+e.m09*C),e.m14=i.z+C-(e.m02*T+e.m06*E+e.m10*C),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,u=i*s,c=n*s,h=n*o,d=r*s,f=r*o,p=r*l,_=a*s,v=a*o,m=a*l;return e.m00=1-h-p,e.m01=c+m,e.m02=d-v,e.m03=0,e.m04=c-m,e.m05=1-u-p,e.m06=f+_,e.m07=0,e.m08=d+v,e.m09=f-_,e.m10=1-u-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,s){var o=1/(i-t),l=1/(r-n),u=1/(a-s);return e.m00=2*a*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*l,e.m10=(s+a)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*a*2*u,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=1/Math.tan(t/2),s=1/(n-r);return e.m00=a/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,s){var o=1/(t-i),l=1/(n-r),u=1/(a-s);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*u,e.m11=0,e.m12=(t+i)*o,e.m13=(r+n)*l,e.m14=(s+a)*u,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=n.x,l=n.y,u=n.z,c=r-i.x,h=a-i.y,d=s-i.z,f=1/Math.sqrt(c*c+h*h+d*d),p=l*(d*=f)-u*(h*=f),_=u*(c*=f)-o*d,v=o*h-l*c,m=h*(v*=f=1/Math.sqrt(p*p+_*_+v*v))-d*(_*=f),y=d*(p*=f)-c*v,g=c*_-h*p;return e.m00=p,e.m01=m,e.m02=c,e.m03=0,e.m04=_,e.m05=y,e.m06=h,e.m07=0,e.m08=v,e.m09=g,e.m10=d,e.m11=0,e.m12=-(p*r+_*a+v*s),e.m13=-(m*r+y*a+g*s),e.m14=-(c*r+h*a+d*s),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){yn=t.m00,gn=t.m01,bn=t.m02,xn=t.m03,Sn=t.m04,wn=t.m05,Tn=t.m06,En=t.m07,Cn=t.m08,An=t.m09,kn=t.m10,Rn=t.m11,On=t.m12,Mn=t.m13,In=t.m14,Ln=t.m15;var i=yn*wn-gn*Sn,n=yn*Tn-bn*Sn,r=yn*En-xn*Sn,a=gn*Tn-bn*wn,s=gn*En-xn*wn,o=bn*En-xn*Tn,l=Cn*Mn-An*On,u=Cn*In-kn*On,c=Cn*Ln-Rn*On,h=An*In-kn*Mn,d=An*Ln-Rn*Mn,f=kn*Ln-Rn*In,p=i*f-n*d+r*h+a*c-s*u+o*l;return p?(p=1/p,e.m00=(wn*f-Tn*d+En*h)*p,e.m01=(Tn*c-Sn*f-En*u)*p,e.m02=(Sn*d-wn*c+En*l)*p,e.m03=0,e.m04=(bn*d-gn*f-xn*h)*p,e.m05=(yn*f-bn*c+xn*u)*p,e.m06=(gn*c-yn*d-xn*l)*p,e.m07=0,e.m08=(Mn*o-In*s+Ln*a)*p,e.m09=(In*r-On*o-Ln*n)*p,e.m10=(On*s-Mn*r+Ln*i)*p,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),v(m,[{key:"clone",value:function(){var e=this;return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p,_){var v=0<arguments.length&&void 0!==e?e:1,m=1<arguments.length&&void 0!==t?t:0,y=2<arguments.length&&void 0!==i?i:0,g=3<arguments.length&&void 0!==n?n:0,b=4<arguments.length&&void 0!==r?r:0,x=5<arguments.length&&void 0!==a?a:1,S=6<arguments.length&&void 0!==s?s:0,w=7<arguments.length&&void 0!==o?o:0,T=8<arguments.length&&void 0!==l?l:0,E=9<arguments.length&&void 0!==u?u:0,C=10<arguments.length&&void 0!==c?c:1,A=11<arguments.length&&void 0!==h?h:0,k=12<arguments.length&&void 0!==d?d:0,R=13<arguments.length&&void 0!==f?f:0,O=14<arguments.length&&void 0!==p?p:0,M=15<arguments.length&&void 0!==_?_:1;return"object"===_e(v)?(this.m01=v.m01,this.m02=v.m02,this.m03=v.m03,this.m04=v.m04,this.m05=v.m05,this.m06=v.m06,this.m07=v.m07,this.m08=v.m08,this.m09=v.m09,this.m10=v.m10,this.m11=v.m11,this.m12=v.m12,this.m13=v.m13,this.m14=v.m14,this.m15=v.m15,this.m00=v.m00):(this.m01=m,this.m02=y,this.m03=g,this.m04=b,this.m05=x,this.m06=S,this.m07=w,this.m08=T,this.m09=E,this.m10=C,this.m11=A,this.m12=k,this.m13=R,this.m14=O,this.m15=M,this.m00=v),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:hi;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=i*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=i*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=i*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=i*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=i*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=i*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=i*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11,On=this.m12,Mn=this.m13,In=this.m14,Ln=this.m15;var e=yn*wn-gn*Sn,t=yn*Tn-bn*Sn,i=yn*En-xn*Sn,n=gn*Tn-bn*wn,r=gn*En-xn*wn,a=bn*En-xn*Tn,s=Cn*Mn-An*On,o=Cn*In-kn*On,l=Cn*Ln-Rn*On,u=An*In-kn*Mn,c=An*Ln-Rn*Mn,h=kn*Ln-Rn*In,d=e*h-t*c+i*u+n*l-r*o+a*s;return 0===d?null:(d=1/d,this.m00=(wn*h-Tn*c+En*u)*d,this.m01=(bn*c-gn*h-xn*u)*d,this.m02=(Mn*a-In*r+Ln*n)*d,this.m03=(kn*r-An*a-Rn*n)*d,this.m04=(Tn*l-Sn*h-En*o)*d,this.m05=(yn*h-bn*l+xn*o)*d,this.m06=(In*i-On*a-Ln*t)*d,this.m07=(Cn*a-kn*i+Rn*t)*d,this.m08=(Sn*c-wn*l+En*s)*d,this.m09=(gn*l-yn*c-xn*s)*d,this.m10=(On*r-Mn*i+Ln*e)*d,this.m11=(An*i-Cn*r-Rn*e)*d,this.m12=(wn*o-Sn*u-Tn*s)*d,this.m13=(yn*u-gn*o+bn*s)*d,this.m14=(Mn*t-On*n-In*e)*d,this.m15=(Cn*n-An*t+kn*e)*d,this)}},{key:"determinant",value:function(){return yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11,On=this.m12,Mn=this.m13,In=this.m14,Ln=this.m15,(yn*wn-gn*Sn)*(kn*Ln-Rn*In)-(yn*Tn-bn*Sn)*(An*Ln-Rn*Mn)+(yn*En-xn*Sn)*(An*In-kn*Mn)+(gn*Tn-bn*wn)*(Cn*Ln-Rn*On)-(gn*En-xn*wn)*(Cn*In-kn*On)+(bn*En-xn*Tn)*(Cn*Mn-An*On)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11,On=this.m12,Mn=this.m13,In=this.m14,Ln=this.m15;var t=e.m00,i=e.m01,n=e.m02,r=e.m03;return this.m00=t*yn+i*Sn+n*Cn+r*On,this.m01=t*gn+i*wn+n*An+r*Mn,this.m02=t*bn+i*Tn+n*kn+r*In,this.m03=t*xn+i*En+n*Rn+r*Ln,t=e.m04,i=e.m05,n=e.m06,r=e.m07,this.m04=t*yn+i*Sn+n*Cn+r*On,this.m05=t*gn+i*wn+n*An+r*Mn,this.m06=t*bn+i*Tn+n*kn+r*In,this.m07=t*xn+i*En+n*Rn+r*Ln,t=e.m08,i=e.m09,n=e.m10,r=e.m11,this.m08=t*yn+i*Sn+n*Cn+r*On,this.m09=t*gn+i*wn+n*An+r*Mn,this.m10=t*bn+i*Tn+n*kn+r*In,this.m11=t*xn+i*En+n*Rn+r*Ln,t=e.m12,i=e.m13,n=e.m14,r=e.m15,this.m12=t*yn+i*Sn+n*Cn+r*On,this.m13=t*gn+i*wn+n*An+r*Mn,this.m14=t*bn+i*Tn+n*kn+r*In,this.m15=t*xn+i*En+n*Rn+r*Ln,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.y,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<hi)return null;i*=a=1/a,n*=a,r*=a;var s=Math.sin(e),o=Math.cos(e),l=1-o;yn=this.m00,gn=this.m01,bn=this.m02,xn=this.m03,Sn=this.m04,wn=this.m05,Tn=this.m06,En=this.m07,Cn=this.m08,An=this.m09,kn=this.m10,Rn=this.m11;var u=i*i*l+o,c=n*i*l+r*s,h=r*i*l-n*s,d=i*n*l-r*s,f=n*n*l+o,p=r*n*l+i*s,_=i*r*l+n*s,v=n*r*l-i*s,m=r*r*l+o;return this.m00=yn*u+Sn*c+Cn*h,this.m01=gn*u+wn*c+An*h,this.m02=bn*u+Tn*c+kn*h,this.m03=xn*u+En*c+Rn*h,this.m04=yn*d+Sn*f+Cn*p,this.m05=gn*d+wn*f+An*p,this.m06=bn*d+Tn*f+kn*p,this.m07=xn*d+En*f+Rn*p,this.m08=yn*_+Sn*v+Cn*m,this.m09=gn*_+wn*v+An*m,this.m10=bn*_+Tn*v+kn*m,this.m11=xn*_+En*v+Rn*m,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=Pn.m00=this.m00,i=Pn.m01=this.m01,n=Pn.m02=this.m02,r=Pn.m03=this.m04,a=Pn.m04=this.m05,s=Pn.m05=this.m06,o=Pn.m06=this.m08,l=Pn.m07=this.m09,u=Pn.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+s*s),e.z=Math.sqrt(o*o+l*l+u*u),rn.determinant(Pn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return 0<t?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,s=e.w,o=n+n,l=r+r,u=a+a,c=n*o,h=n*l,d=n*u,f=r*l,p=r*u,_=a*u,v=s*o,m=s*l,y=s*u,g=i.x,b=i.y,x=i.z;return this.m00=(1-(f+_))*g,this.m01=(h+y)*g,this.m02=(d-m)*g,this.m03=0,this.m04=(h-y)*b,this.m05=(1-(c+_))*b,this.m06=(p+v)*b,this.m07=0,this.m08=(d+m)*x,this.m09=(p-v)*x,this.m10=(1-(c+f))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=i*a,c=i*s,h=n*a,d=n*s,f=n*o,p=r*a,_=r*s,v=r*o;return this.m00=1-c-f,this.m01=u+v,this.m02=h-_,this.m03=0,this.m04=u-v,this.m05=1-l-f,this.m06=d+p,this.m07=0,this.m08=h+_,this.m09=d-p,this.m10=1-l-c,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),m}());zn.IDENTITY=Object.freeze(new zn);var Bn=new Fi,Pn=new rn;function Dn(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p,_){return new zn(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p,_)}ai.fastDefine("cc.Mat4",zn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=zn,cc.mat4=Dn;var Fn=0,Nn=0,Un=0,Vn=0,Gn=0,Hn=0,Wn=q3("AffineTransform",function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;y(this,s),this.a=void 0,this.b=void 0,this.c=void 0,this.d=void 0,this.tx=void 0,this.ty=void 0,this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a}return v(s,null,[{key:"identity",value:function(){return new s}},{key:"clone",value:function(e){return new s(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"concat",value:function(e,t,i){Fn=t.a,Nn=t.b,Un=t.c,Vn=t.d,Gn=t.tx,Hn=t.ty,e.a=Fn*i.a+Nn*i.c,e.b=Fn*i.b+Nn*i.d,e.c=Un*i.a+Vn*i.c,e.d=Un*i.b+Vn*i.d,e.tx=Gn*i.a+Hn*i.c+i.tx,e.ty=Gn*i.b+Hn*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;a=void 0===n?(n=i,r=t.x,t.y):(r=t,i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,s=i.b*t.x+i.d*t.y+i.ty,o=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,u=i.a*t.x+i.c*r+i.tx,c=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,d=i.b*n+i.d*r+i.ty,f=Math.min(a,o,u,h),p=Math.max(a,o,u,h),_=Math.min(s,l,c,d),v=Math.max(s,l,c,d);e.x=f,e.y=_,e.width=p-f,e.height=v-_}},{key:"transformObb",value:function(e,t,i,n,r,a){var s=a.a*r.x+a.c*r.y+a.tx,o=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,u=a.b*r.width,c=a.c*r.height,h=a.d*r.height;t.x=s,t.y=o,i.x=l+s,i.y=u+o,e.x=c+s,e.y=h+o,n.x=l+c+s,n.y=u+h+o}}]),s}());cc.AffineTransform=Wn;var qn=q3("Size",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).width=void 0,i.height=void 0,e&&"object"===_e(e)?(i.height=e.height,i.width=e.width):(i.width=e||0,i.height=t||0),i}return p(n,yt),v(n,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}},{key:"ZERO",get:function(){return new n(0,0)}}]),v(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===_e(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}());function jn(){return new qn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0)}ai.fastDefine("cc.Size",qn,{width:0,height:0}),cc.size=jn,cc.Size=qn;var Xn=0,Yn=0,Kn=0,Qn=0,Zn=q3("Rect",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this))).x=void 0,r.y=void 0,r.width=void 0,r.height=void 0,e&&"object"===_e(e)?(r.y=e.y,r.width=e.width,r.height=e.height,r.x=e.x):(r.x=e||0,r.y=t||0,r.width=i||0,r.height=n||0),r}return p(a,yt),v(a,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Mi(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new qn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),s=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=s-r,e}},{key:"lerp",value:function(e,t,i,n){return Xn=t.x,Yn=t.y,Kn=t.width,Qn=t.height,e.x=Xn+(i.x-Xn)*n,e.y=Yn+(i.y-Yn)*n,e.width=Kn+(i.width-Kn)*n,e.height=Qn+(i.height-Qn)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,s=t.y+t.height,o=i.x,l=i.y,u=i.x+i.width,c=i.y+i.height;return e.x=Math.max(n,o),e.y=Math.max(r,l),e.width=Math.min(a,u)-e.x,e.height=Math.min(s,c)-e.y,e}},{key:"union",value:function(e,t,i){Xn=t.x,Yn=t.y,Kn=t.width,Qn=t.height;var n=i.x,r=i.y,a=i.width,s=i.height;return e.x=Math.min(Xn,n),e.y=Math.min(Yn,r),e.width=Math.max(Xn+Kn,n+a)-e.x,e.height=Math.max(Yn+Qn,r+s)-e.y,e}}]),v(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,i,n){return e&&"object"===_e(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return Xn=this.x,Yn=this.y,Kn=this.width,Qn=this.height,this.x=Xn+(e.x-Xn)*t,this.y=Yn+(e.y-Yn)*t,this.width=Kn+(e.width-Kn)*t,this.height=Qn+(e.height-Qn)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,s=e.m01*t+e.m05*i+e.m13,o=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,u=e.m00*t+e.m04*r+e.m12,c=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,d=e.m01*n+e.m05*r+e.m13,f=Math.min(a,o,u,h),p=Math.max(a,o,u,h),_=Math.min(s,l,c,d),v=Math.max(s,l,c,d);return this.x=f,this.y=_,this.width=p-f,this.height=v-_,this}}]),a}());function Jn(){return new Zn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0)}ai.fastDefine("cc.Rect",Zn,{x:0,y:0,width:0,height:0}),cc.Rect=Zn,cc.rect=Jn;var $n=1/255,er=0,tr=0,ir=0,nr=0,rr=q3("Color",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this)))._val=0,"string"==typeof e?r.fromHEX(e):("object"===_e(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,r._val=(n<<24>>>0)+(i<<16)+(t<<8)+e),r}return p(a,yt),v(a,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~pi(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~pi(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~pi(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~pi(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*$n},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*$n},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*$n},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*$n},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new a;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHex",value:function(e,t){return e.r=(t>>24)/255,e.g=(t>>16&255)/255,e.b=(t>>8&255)/255,e.a=(255&t)/255,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){return er=t.r,tr=t.g,ir=t.b,nr=t.a,er+=(i.r-er)*n,tr+=(i.g-tr)*n,ir+=(i.b-ir)*n,nr+=(i.a-nr)*n,e._val=Math.floor((nr<<24>>>0)+(ir<<16)+(tr<<8)+er),e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0,r=t instanceof a||1<t.a?1/255:1;return e[n+0]=t.r*r,e[n+1]=t.g*r,e[n+2]=t.b*r,e[n+3]=t.a*r,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:hi;return Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),v(a,[{key:"clone",value:function(){var e=new a;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){return er=this.r,tr=this.g,ir=this.b,nr=this.a,er+=(e.r-er)*t,tr+=(e.g-tr)*t,ir+=(e.b-ir)*t,nr+=(e.a-nr)*t,this._val=Math.floor((nr<<24>>>0)+(ir<<16)+(tr<<8)+er),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*$n).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){return e=0===e.indexOf("#")?e.substring(1):e,er=parseInt(e.substr(0,2),16)||0,tr=parseInt(e.substr(2,2),16)||0,ir=parseInt(e.substr(4,2),16)||0,nr=parseInt(e.substr(6,2),16)||255,this._val=(nr<<24>>>0)+(ir<<16)+(tr<<8)+er,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){if((ir=tr=er=0)===t)er=tr=ir=i;else if(0===i)er=tr=ir=0;else{1===e&&(e=0),e*=6,t=t,i=i;var n=Math.floor(e),r=e-n,a=i*(1-t),s=i*(1-t*r),o=i*(1-t*(1-r));switch(n){case 0:er=i,tr=o,ir=a;break;case 1:er=s,tr=i,ir=a;break;case 2:er=a,tr=i,ir=o;break;case 3:er=a,tr=s,ir=i;break;case 4:er=o,tr=a,ir=i;break;case 5:er=i,tr=a,ir=s}}return er*=255,tr*=255,ir*=255,this._val=(this.a<<24>>>0)+(ir<<16)+(tr<<8)+er,this}},{key:"toHSV",value:function(){er=this.r*$n,tr=this.g*$n,ir=this.b*$n;var e={h:0,s:0,v:0},t=Math.max(er,tr,ir),i=Math.min(er,tr,ir),n=0;return e.v=t,e.s=t?(t-i)/t:0,e.s?(n=t-i,e.h=er===t?(tr-ir)/n:tr===t?2+(ir-er)/n:4+(er-tr)/n,e.h/=6,e.h<0&&(e.h+=1)):e.h=0,e}},{key:"set",value:function(e,t,i,n){return"object"===_e(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e,this}},{key:"multiply",value:function(e){return er=(255&this._val)*e.r>>8,tr=(65280&this._val)*e.g>>8,ir=(16711680&this._val)*e.b>>8,nr=((4278190080&this._val)>>>8)*e.a,this._val=4278190080&nr|16711680&ir|65280&tr|255&er,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),a}());function ar(e,t,i,n){return new rr(e,t,i,n)}rr.WHITE=Object.freeze(new rr(255,255,255,255)),rr.GRAY=Object.freeze(new rr(127,127,127,255)),rr.BLACK=Object.freeze(new rr(0,0,0,255)),rr.TRANSPARENT=Object.freeze(new rr(0,0,0,0)),rr.RED=Object.freeze(new rr(255,0,0,255)),rr.GREEN=Object.freeze(new rr(0,255,0,255)),rr.BLUE=Object.freeze(new rr(0,0,255,255)),rr.CYAN=Object.freeze(new rr(0,255,255,255)),rr.MAGENTA=Object.freeze(new rr(255,0,255,255)),rr.YELLOW=Object.freeze(new rr(255,255,0,255)),ai.fastDefine("cc.Color",rr,{r:0,g:0,b:0,a:255}),cc.Color=rr,cc.color=ar;var sr,or,lr,ur,cr,hr=10;var dr=0,fr=new Map;lr=function(e,t,i,n,r,a){var s=fr.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),s.count++)},sr=q3("replaceProperty",function(o,l,e){null!=o&&e.forEach(function(t){var i=dr++;fr.set(i,{id:i,count:0,logTimes:void 0!==t.logTimes?t.logTimes:hr});var n=null!=t.target?t.target:o,r=null!=t.newName?t.newName:t.name,a=null!=t.targetName?t.targetName:l;if(null!=t.customFunction)o[t.name]=function(){return lr(l,t.name,a,r,C,i),t.customFunction.call(this,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3],arguments.length<=4?void 0:arguments[4],arguments.length<=5?void 0:arguments[5],arguments.length<=6?void 0:arguments[6],arguments.length<=7?void 0:arguments[7],arguments.length<=8?void 0:arguments[8],arguments.length<=9?void 0:arguments[9],arguments.length<=10?void 0:arguments[10],arguments.length<=11?void 0:arguments[11])};else if(null!=t.customSetter||null!=t.customGetter){var e=null!=t.customSetter,s=null!=t.customGetter;e&&s?Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,C,i),t.customGetter.call(this)},set:function(e){lr(l,t.name,a,r,C,i),t.customSetter.call(this,e)}}):e?Object.defineProperty(o,t.name,{set:function(e){lr(l,t.name,a,r,C,i),t.customSetter.call(this,e)}}):s&&Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,C,i),t.customGetter.call(this)}})}else Object.defineProperty(o,t.name,{get:function(){return lr(l,t.name,a,r,C,i),n[r]},set:function(e){lr(l,t.name,a,r,C,i),n[r]=e}})})}),cr=function(e,t,i,n){var r=fr.get(n);r&&r.logTimes>r.count&&(i("'%s' has been removed.","".concat(e,".").concat(t)),r.count++)},or=q3("removeProperty",function(i,n,e){null!=i&&e.forEach(function(e){var t=dr++;fr.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:hr}),Object.defineProperty(i,e.name,{get:function(){return cr(n,e.name,A,t)},set:function(){cr(n,e.name,A,t)}})})}),ur=function(e,t,i,n){var r=fr.get(n);r&&r.logTimes>r.count&&(i("'%s' is deprecated.","".concat(e,".").concat(t)),r.count++)},q3("markAsWarning",function(a,s,e){if(null!=a){var o=function(e,t,i,n,r,a,s){if(i.get){var o=i.get();i.get=function(){return ur(n,r,a,s),o.call(this)}}if(i.set){var l=Object.create(i.set);i.set=function(e){ur(n,r,a,s),l.call(this,e)}}};e.forEach(function(e){var t=e.name,i=Object.getOwnPropertyDescriptor(a,t);if(i){var n=dr++;if(fr.set(n,{id:n,count:0,logTimes:void 0!==e.logTimes?e.logTimes:hr}),null!=i.value)if("function"==typeof i.value){var r=i.value;a[t]=function(){return ur(s,t,C,n),r.call(this)}}else o(0,0,i,s,t,C,n);else o(0,0,i,s,t,C,n)}})}}),sr(Mi,"Vec2",[{name:"sub",newName:"subtract",target:Mi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Mi,targetName:"Vec2"},{name:"div",newName:"divide",target:Mi,targetName:"Vec2"},{name:"dist",newName:"distance",target:Mi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Mi,targetName:"Vec2"},{name:"mag",newName:"len",target:Mi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Mi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Mi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Mi,targetName:"Vec2"}]),sr(Mi.prototype,"Vec2",[{name:"mag",newName:"length",target:Mi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Mi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Mi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Mi.prototype,targetName:"Vec2"}]),or(Mi.prototype,"vmath",[{name:"divide"}]),sr(Fi,"Vec3",[{name:"sub",newName:"subtract",target:Fi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Fi,targetName:"Vec3"},{name:"div",newName:"divide",target:Fi,targetName:"Vec3"},{name:"dist",newName:"distance",target:Fi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Fi,targetName:"Vec3"},{name:"mag",newName:"len",target:Fi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Fi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Fi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Fi,targetName:"Vec3"}]),sr(Fi.prototype,"Vec3",[{name:"mag",newName:"length",target:Fi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Fi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Fi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Fi.prototype,targetName:"Vec3"}]),or(Fi.prototype,"vmath",[{name:"divide"}]),sr(ji,"Vec4",[{name:"sub",newName:"subtract",target:ji,targetName:"Vec4"},{name:"mul",newName:"multiply",target:ji,targetName:"Vec4"},{name:"div",newName:"divide",target:ji,targetName:"Vec4"},{name:"dist",newName:"distance",target:ji,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:ji,targetName:"Vec4"},{name:"mag",newName:"len",target:ji,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:ji,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ji,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ji,targetName:"Vec4"}]),sr(ji.prototype,"Vec4",[{name:"mag",newName:"length",target:ji.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:ji.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ji.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ji.prototype,targetName:"Vec4"}]),or(ji.prototype,"vmath",[{name:"divide"}]),sr(hn,"Quat",[{name:"mag",newName:"len",target:hn,targetName:"Quat"},{name:"mul",newName:"multiply",target:hn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:hn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:hn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:hn,targetName:"Quat"}]),sr(hn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:hn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:hn.prototype,targetName:"Quat"}]),sr(rr,"Color",[{name:"sub",newName:"subtract",target:rr,targetName:"Color"},{name:"mul",newName:"multiply",target:rr,targetName:"Color"},{name:"div",newName:"divide",target:rr,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:rr,targetName:"Color"}]),sr(rn,"Mat3",[{name:"sub",newName:"subtract",target:rn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:rn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:rn,targetName:"Mat3"}]),sr(rn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:rn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:rn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:rn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:rn.prototype,targetName:"Mat3"}]),sr(zn,"Mat4",[{name:"sub",newName:"subtract",target:zn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:zn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:zn,targetName:"Mat4"}]),sr(zn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:zn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:zn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:zn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:zn.prototype,targetName:"Mat4"}]);var pr=Object.freeze({bits:ue,Vec2:Mi,v2:zi,Vec3:Fi,v3:Vi,Vec4:ji,v4:Xi,Quat:hn,quat:mn,Mat3:rn,Mat4:zn,mat4:Dn,AffineTransform:Wn,Size:qn,size:jn,Rect:Zn,rect:Jn,Color:rr,color:ar,EPSILON:hi,equals:di,approx:fi,clamp:pi,clamp01:_i,lerp:vi,toRadian:mi,toDegree:yi,random:gi,randomRange:bi,randomRangeInt:xi,pseudoRandom:Si,pseudoRandomRange:wi,pseudoRandomRangeInt:Ti,nextPow2:Ei,repeat:Ci,pingPong:Ai,inverseLerp:ki});q3("math",pr);var _r={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256},vr=new Fi,mr=new Fi,yr=new Fi,gr=new Fi,br=new Fi,xr=new Fi,Sr=new Array(3),wr=new Array(3);function Tr(e,t){return Fi.dot(t.n,e)-t.d}function Er(e,t,i){return Fi.copy(e,t),Fi.subtract(br,i.center,i.halfExtents),Fi.add(xr,i.center,i.halfExtents),e.x=e.x<br.x?br.x:e.x,e.y=e.y<br.x?br.y:e.y,e.z=e.z<br.x?br.z:e.z,e.x=e.x>xr.x?xr.x:e.x,e.y=e.y>xr.x?xr.y:e.y,e.z=e.z>xr.x?xr.z:e.z,e}function Cr(e,t,i){Fi.set(vr,i.orientation.m00,i.orientation.m01,i.orientation.m02),Fi.set(mr,i.orientation.m03,i.orientation.m04,i.orientation.m05),Fi.set(yr,i.orientation.m06,i.orientation.m07,i.orientation.m08),Sr[0]=vr,Sr[1]=mr,Sr[2]=yr,wr[0]=i.halfExtents.x,wr[1]=i.halfExtents.y,wr[2]=i.halfExtents.z,Fi.subtract(gr,t,i.center),Fi.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Fi.dot(gr,Sr[n]);r>wr[n]&&(r=wr[n]),r<-wr[n]&&(r=-wr[n]),e.x+=r*Sr[n].x,e.y+=r*Sr[n].y,e.z+=r*Sr[n].z}return e}var Ar,kr,Rr,Or,Mr,Ir,Lr,zr,Br,Pr,Dr,Fr,Nr,Ur,Vr,Gr,Hr,Wr,qr,jr,Xr,Yr,Kr,Qr,Zr,Jr,$r,ea=Object.freeze({point_plane:Tr,pt_point_plane:function(e,t,i){var n=Tr(t,i);return Fi.subtract(e,t,Fi.multiplyScalar(e,i.n,n))},pt_point_aabb:Er,pt_point_obb:Cr}),ta=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.o=void 0,this.d=void 0,this._type=void 0,this._type=_r.SHAPE_RAY,this.o=new Fi(e,t,i),this.d=new Fi(n,r,a)}return v(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(0<arguments.length&&void 0!==e?e:0,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==n?n:0,4<arguments.length&&void 0!==r?r:0,5<arguments.length&&void 0!==a?a:1)}},{key:"clone",value:function(e){return new s(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.o,t.o),Fi.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Fi.copy(e.o,t),Fi.normalize(e.d,Fi.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=s,e}}]),v(s,[{key:"computeHit",value:function(e,t){Fi.normalize(e,this.d),Fi.scaleAndAdd(e,this.o,e,t)}}]),s}(),ia=(Ar=new Fi(0,0,0),function(e,t){var i=Fi.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Fi.multiplyScalar(Ar,t.n,t.d);var n=Fi.dot(Fi.subtract(Ar,Ar,e.o),t.n)/i;return n<0?0:n}),na=(kr=new Fi(0,0,0),Rr=new Fi(0,0,0),Or=new Fi(0,0,0),Mr=new Fi(0,0,0),Ir=new Fi(0,0,0),function(e,t,i){Fi.subtract(kr,t.b,t.a),Fi.subtract(Rr,t.c,t.a),Fi.cross(Or,e.d,Rr);var n=Fi.dot(kr,Or);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Fi.subtract(Mr,e.o,t.a);var a=Fi.dot(Mr,Or)*r;if(a<0||1<a)return 0;Fi.cross(Ir,Mr,kr);var s=Fi.dot(e.d,Ir)*r;if(s<0||1<a+s)return 0;var o=Fi.dot(Rr,Ir)*r;return o<0?0:o}),ra=(Lr=new Fi(0,0,0),function(e,t){var i=t.radius,n=t.center,r=e.o,a=e.d,s=i*i;Fi.subtract(Lr,n,r);var o=Lr.lengthSqr(),l=Fi.dot(Lr,a),u=s-(o-l*l);if(u<0)return 0;var c=Math.sqrt(u),h=o<s?l+c:l-c;return h<0?0:h}),aa=(zr=new Fi,Br=new Fi,function(e,t){var i=e.o,n=e.d,r=1/n.x,a=1/n.y,s=1/n.z;Fi.subtract(zr,t.center,t.halfExtents),Fi.add(Br,t.center,t.halfExtents);var o=(zr.x-i.x)*r,l=(Br.x-i.x)*r,u=(zr.y-i.y)*a,c=(Br.y-i.y)*a,h=(zr.z-i.z)*s,d=(Br.z-i.z)*s,f=Math.max(Math.max(Math.min(o,l),Math.min(u,c)),Math.min(h,d)),p=Math.min(Math.min(Math.max(o,l),Math.max(u,c)),Math.max(h,d));return p<0||p<f?0:f}),sa=(Pr=new Fi,Dr=new Fi,Fr=new Fi,Nr=new Fi,Ur=new Fi,Vr=new Fi,Gr=new Fi,Hr=new Array(3),Wr=new Array(3),qr=new Array(3),jr=new Array(6),function(e,t){Hr[0]=t.halfExtents.x,Hr[1]=t.halfExtents.y,Hr[2]=t.halfExtents.z,Pr=t.center,Dr=e.o,Fr=e.d,Fi.set(Nr,t.orientation.m00,t.orientation.m01,t.orientation.m02),Fi.set(Ur,t.orientation.m03,t.orientation.m04,t.orientation.m05),Fi.set(Vr,t.orientation.m06,t.orientation.m07,t.orientation.m08),Fi.subtract(Gr,Pr,Dr),Wr[0]=Fi.dot(Nr,Fr),Wr[1]=Fi.dot(Ur,Fr),Wr[2]=Fi.dot(Vr,Fr),qr[0]=Fi.dot(Nr,Gr),qr[1]=Fi.dot(Ur,Gr),qr[2]=Fi.dot(Vr,Gr);for(var i=0;i<3;++i){if(0===Wr[i]){if(0<-qr[i]-Hr[i]||-qr[i]+Hr[i]<0)return 0;Wr[i]=1e-7}jr[2*i+0]=(qr[i]+Hr[i])/Wr[i],jr[2*i+1]=(qr[i]-Hr[i])/Wr[i]}var n=Math.max(Math.max(Math.min(jr[0],jr[1]),Math.min(jr[2],jr[3])),Math.min(jr[4],jr[5])),r=Math.min(Math.min(Math.max(jr[0],jr[1]),Math.max(jr[2],jr[3])),Math.max(jr[4],jr[5]));return r<0||r<n||n<0?0:n}),oa=(Xr=new Fi(0,0,0),function(e,t){Fi.subtract(Xr,e.e,e.s);var i=(t.d-Fi.dot(e.s,t.n))/Fi.dot(Xr,t.n);return i<0||1<i?0:i}),la=(Yr=new Fi(0,0,0),Kr=new Fi(0,0,0),Qr=new Fi(0,0,0),Zr=new Fi(0,0,0),Jr=new Fi(0,0,0),$r=new Fi(0,0,0),function(e,t,i){Fi.subtract(Yr,t.b,t.a),Fi.subtract(Kr,t.c,t.a),Fi.subtract(Qr,e.s,e.e),Fi.cross(Jr,Yr,Kr);var n=Fi.dot(Qr,Jr);if(n<=0)return 0;Fi.subtract(Zr,e.s,t.a);var r=Fi.dot(Zr,Jr);if(r<0||n<r)return 0;Fi.cross($r,Qr,Zr);var a=Fi.dot(Kr,$r);if(a<0||n<a)return 0;var s=-Fi.dot(Yr,$r);if(s<0||n<a+s)return 0;if(i){var o=1/n,l=1-(a*=o)-(s*=o);Fi.set(i,t.a.x*l+t.b.x*a+t.c.x*s,t.a.y*l+t.b.y*a+t.c.y*s,t.a.z*l+t.b.z*a+t.c.z*s)}return 1}),ua=new ta;function ca(e,t){ua.o.set(e.s),Fi.subtract(ua.d,e.e,e.s),ua.d.normalize();var i=aa(ua,t);return i<=e.length()?i:0}function ha(e,t){ua.o.set(e.s),Fi.subtract(ua.d,e.e,e.s),ua.d.normalize();var i=sa(ua,t);return i<=e.length()?i:0}function da(e,t){ua.o.set(e.s),Fi.subtract(ua.d,e.e,e.s),ua.d.normalize();var i=ra(ua,t);return i<=e.length()?i:0}var fa,pa,_a,va,ma=(fa=new Fi,pa=new Fi,_a=new Fi,va=new Fi,function(e,t){return Fi.subtract(fa,e.center,e.halfExtents),Fi.add(pa,e.center,e.halfExtents),Fi.subtract(_a,t.center,t.halfExtents),Fi.add(va,t.center,t.halfExtents),fa.x<=va.x&&pa.x>=_a.x&&fa.y<=va.y&&pa.y>=_a.y&&fa.z<=va.z&&pa.z>=_a.z});function ya(e,t,i,n,r,a){Fi.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),Fi.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),Fi.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),Fi.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),Fi.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),Fi.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),Fi.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),Fi.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function ga(e,t){for(var i=Fi.dot(t,e[0]),n=i,r=1;r<8;++r){var a=Fi.dot(t,e[r]);i=a<i?a:i,n=n<a?a:n}return[i,n]}function ba(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=Fi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}function xa(e,t){for(var i=0;i<t.planes.length;i++)if(-1===ba(e,t.planes[i]))return 0;return 1}var Sa,wa,Ta=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Fi(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Fi(0,0,0),l[t]=new Fi(0,0,0);var u=new Fi,c=new Fi;return function(e,t){Fi.set(s[0],1,0,0),Fi.set(s[1],0,1,0),Fi.set(s[2],0,0,1),Fi.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Fi.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Fi.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Fi.cross(s[6+3*i+0],s[i],s[0]),Fi.cross(s[6+3*i+1],s[i],s[1]),Fi.cross(s[6+3*i+1],s[i],s[2]);Fi.subtract(u,e.center,e.halfExtents),Fi.add(c,e.center,e.halfExtents),function(e,t,i){Fi.set(i[0],e.x,t.y,t.z),Fi.set(i[1],e.x,t.y,e.z),Fi.set(i[2],e.x,e.y,t.z),Fi.set(i[3],e.x,e.y,e.z),Fi.set(i[4],t.x,t.y,t.z),Fi.set(i[5],t.x,t.y,e.z),Fi.set(i[6],t.x,e.y,t.z),Fi.set(i[7],t.x,e.y,e.z)}(u,c,o),ya(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=ga(o,s[n]),a=ga(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),Ea=function(){for(var u=new Array(8),c=0,h=0,e=0;e<u.length;e++)u[e]=new Fi(0,0,0);return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=ba(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Fi.subtract(u[a],t.vertices[a],e.center);for(var s=h=c=0;s<t.vertices.length;s++)u[s].x>e.halfExtents.x?c++:u[s].x<-e.halfExtents.x&&h++;if(c===t.vertices.length||h===t.vertices.length)return 0;for(var o=h=c=0;o<t.vertices.length;o++)u[o].y>e.halfExtents.y?c++:u[o].y<-e.halfExtents.y&&h++;if(c===t.vertices.length||h===t.vertices.length)return 0;for(var l=h=c=0;l<t.vertices.length;l++)u[l].z>e.halfExtents.z?c++:u[l].z<-e.halfExtents.z&&h++;return c===t.vertices.length||h===t.vertices.length?0:1}}(),Ca=(Sa=new Fi(0,0,0),wa=new rn,function(e,t){return Fi.subtract(Sa,t,e.center),Fi.transformMat3(Sa,Sa,rn.transpose(wa,e.orientation)),function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z}(Sa,e.halfExtents)}),Aa=function(e,t){var i=e.halfExtents.x*ka(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*ka(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*ka(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=Fi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1};function ka(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)}function Ra(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Aa(e,t.planes[i]))return 0;return 1}function Oa(e,t){var i=Fi.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1}function Ma(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Oa(e,t.planes[i]))return 0;return 1}function Ia(e,t){var i=e.radius+t.radius;return Fi.squaredDistance(e.center,t.center)<i*i}var La,za,Ba,Pa,Da=function(){for(var u=new Array(8),c=0,h=0,d=0,e=0;e<u.length;e++)u[e]=new Fi(0,0,0);function f(e,t,i,n){return e.x*t+e.y*i+e.z*n}return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=Aa(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Fi.subtract(u[a],t.vertices[a],e.center);for(var s=d=h=0;s<t.vertices.length;s++)(c=f(u[s],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:c<-e.halfExtents.x&&d++;if(h===t.vertices.length||d===t.vertices.length)return 0;for(var o=d=h=0;o<t.vertices.length;o++)(c=f(u[o],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:c<-e.halfExtents.y&&d++;if(h===t.vertices.length||d===t.vertices.length)return 0;for(var l=d=h=0;l<t.vertices.length;l++)(c=f(u[l],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:c<-e.halfExtents.z&&d++;return h===t.vertices.length||d===t.vertices.length?0:1}}(),Fa=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Fi(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Fi(0,0,0),l[t]=new Fi(0,0,0);return function(e,t){Fi.set(s[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Fi.set(s[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Fi.set(s[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Fi.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Fi.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Fi.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Fi.cross(s[6+3*i+0],s[i],s[0]),Fi.cross(s[6+3*i+1],s[i],s[1]),Fi.cross(s[6+3*i+1],s[i],s[2]);ya(e.center,e.halfExtents,s[0],s[1],s[2],o),ya(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=ga(o,s[n]),a=ga(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),Na=(La=new Fi(0,0,0),za=[1,-1,1,-1,1,-1],function(e,t){for(var i=0;i<6;i++){var n=t.planes[i],r=e.radius,a=e.center,s=n.n,o=n.d,l=Fi.dot(s,a);if(l+r<o)return 0;if(!(o<l-r)){Fi.add(La,a,Fi.multiplyScalar(La,s,r));for(var u=0;u<6;u++)if(u!==i&&u!==i+za[i]){var c=t.planes[u];if(Fi.dot(c.n,La)<c.d)return 0}}}return 1}),Ua=(Ba=new Fi,function(e,t){return Er(Ba,e.center,t),Fi.squaredDistance(e.center,Ba)<e.radius*e.radius}),Va=(Pa=new Fi,function(e,t){return Cr(Pa,e.center,t),Fi.squaredDistance(e.center,Pa)<e.radius*e.radius}),Ga={ray_sphere:ra,ray_aabb:aa,ray_obb:sa,ray_plane:ia,ray_triangle:na,line_sphere:da,line_aabb:ca,line_obb:ha,line_plane:oa,line_triangle:la,sphere_sphere:Ia,sphere_aabb:Ua,sphere_obb:Va,sphere_plane:Oa,sphere_frustum:Ma,sphere_frustum_accurate:Na,aabb_aabb:ma,aabb_obb:Ta,aabb_plane:ba,aabb_frustum:xa,aabb_frustum_accurate:Ea,obb_obb:Fa,obb_plane:Aa,obb_frustum:Ra,obb_frustum_accurate:Da,obb_point:Ca,resolve:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:null,r=e._type,a=t._type,s=this[r|a];return r<a?s(e,t,n):s(t,e,n)}};Ga[_r.SHAPE_RAY|_r.SHAPE_SPHERE]=ra,Ga[_r.SHAPE_RAY|_r.SHAPE_AABB]=aa,Ga[_r.SHAPE_RAY|_r.SHAPE_OBB]=sa,Ga[_r.SHAPE_RAY|_r.SHAPE_PLANE]=ia,Ga[_r.SHAPE_RAY|_r.SHAPE_TRIANGLE]=na,Ga[_r.SHAPE_LINE|_r.SHAPE_SPHERE]=da,Ga[_r.SHAPE_LINE|_r.SHAPE_AABB]=ca,Ga[_r.SHAPE_LINE|_r.SHAPE_OBB]=ha,Ga[_r.SHAPE_LINE|_r.SHAPE_PLANE]=oa,Ga[_r.SHAPE_LINE|_r.SHAPE_TRIANGLE]=la,Ga[_r.SHAPE_SPHERE]=Ia,Ga[_r.SHAPE_SPHERE|_r.SHAPE_AABB]=Ua,Ga[_r.SHAPE_SPHERE|_r.SHAPE_OBB]=Va,Ga[_r.SHAPE_SPHERE|_r.SHAPE_PLANE]=Oa,Ga[_r.SHAPE_SPHERE|_r.SHAPE_FRUSTUM]=Ma,Ga[_r.SHAPE_SPHERE|_r.SHAPE_FRUSTUM_ACCURATE]=Na,Ga[_r.SHAPE_AABB]=ma,Ga[_r.SHAPE_AABB|_r.SHAPE_OBB]=Ta,Ga[_r.SHAPE_AABB|_r.SHAPE_PLANE]=ba,Ga[_r.SHAPE_AABB|_r.SHAPE_FRUSTUM]=xa,Ga[_r.SHAPE_AABB|_r.SHAPE_FRUSTUM_ACCURATE]=Ea,Ga[_r.SHAPE_OBB]=Fa,Ga[_r.SHAPE_OBB|_r.SHAPE_PLANE]=Aa,Ga[_r.SHAPE_OBB|_r.SHAPE_FRUSTUM]=Ra,Ga[_r.SHAPE_OBB|_r.SHAPE_FRUSTUM_ACCURATE]=Da;var Ha=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.s=void 0,this.e=void 0,this._type=void 0,this._type=_r.SHAPE_LINE,this.s=new Fi(e,t,i),this.e=new Fi(n,r,a)}return v(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.s,t.s),Fi.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Fi.copy(e.s,t),Fi.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=s,e}},{key:"len",value:function(e){return Fi.distance(e.s,e.e)}}]),v(s,[{key:"length",value:function(){return Fi.distance(this.s,this.e)}}]),s}(),Wa=new Fi(0,0,0),qa=new Fi(0,0,0),ja=cc.mat4(),Xa=cc.v4(),Ya=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,r),this.n=void 0,this.d=void 0,this._type=void 0,this._type=_r.SHAPE_PLANE,this.n=new Fi(e,t,i),this.d=n}return v(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.n.x,e.n.y,e.n.z,e.d)}},{key:"copy",value:function(e,t){return Fi.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return Fi.subtract(Wa,i,t),Fi.subtract(qa,n,t),Fi.normalize(e.n,Fi.cross(e.n,Wa,qa)),e.d=Fi.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Fi.copy(e.n,t),e.d=Fi.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return Fi.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e}}]),v(r,[{key:"transform",value:function(e){zn.invert(ja,e),zn.transpose(ja,ja),ji.set(Xa,this.n.x,this.n.y,this.n.z,this.d),ji.transformMat4(Xa,Xa,ja),Fi.set(this.n,Xa.x,Xa.y,Xa.z),this.d=Xa.w}}]),r}(),Ka=function(){function u(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:1,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0;y(this,u),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=_r.SHAPE_TRIANGLE,this.a=new Fi(e,t,i),this.b=new Fi(n,r,a),this.c=new Fi(s,o,l)}return v(u,null,[{key:"create",value:function(e,t,i,n,r,a,s,o,l){return new u(0<arguments.length&&void 0!==e?e:1,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==n?n:0,4<arguments.length&&void 0!==r?r:0,5<arguments.length&&void 0!==a?a:0,6<arguments.length&&void 0!==s?s:0,7<arguments.length&&void 0!==o?o:0,8<arguments.length&&void 0!==l?l:1)}},{key:"clone",value:function(e){return new u(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.a,t.a),Fi.copy(e.b,t.b),Fi.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return Fi.copy(e.a,t),Fi.copy(e.b,i),Fi.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=s,e.c.x=o,e.c.y=l,e.c.z=u,e}}]),u}(),Qa=new Fi;function Za(e){return Math.max(Math.max(e.x,e.y),e.z)}function Ja(e,t,i){rs.m00=Math.abs(i.m00),rs.m01=Math.abs(i.m01),rs.m02=Math.abs(i.m02),rs.m03=Math.abs(i.m04),rs.m04=Math.abs(i.m05),rs.m05=Math.abs(i.m06),rs.m06=Math.abs(i.m08),rs.m07=Math.abs(i.m09),rs.m08=Math.abs(i.m10),Fi.transformMat3(e,t,rs)}var $a=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=_r.SHAPE_SPHERE,this.center=new Fi(e,t,i),this.radius=n}return v(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.center.x,e.center.y,e.center.z,e.radius)}},{key:"copy",value:function(e,t){return Fi.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Fi.multiplyScalar(e.center,Fi.add(Qa,t,i),.5),e.radius=.5*Fi.subtract(Qa,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),v(r,[{key:"clone",value:function(){return r.clone(this)}},{key:"copy",value:function(e){return r.copy(this,e)}},{key:"getBoundary",value:function(e,t){Fi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Fi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){Fi.transformMat4(r.center,this.center,e),r.radius=this.radius*Za(n)}},{key:"translateAndRotate",value:function(e,t,i){Fi.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*Za(e)}}]),r}(),es=new Fi,ts=new Fi,is=new Fi,ns=new Fi,rs=new rn,as=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1;y(this,s),this.center=void 0,this.halfExtents=void 0,this._type=_r.SHAPE_AABB,this.center=new Fi(e,t,i),this.halfExtents=new Fi(n,r,a)}return v(s,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}},{key:"copy",value:function(e,t){return Fi.copy(e.center,t.center),Fi.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Fi.multiplyScalar(e.center,Fi.add(es,t,i),.5),Fi.multiplyScalar(e.halfExtents,Fi.subtract(ts,i,t),.5),e}},{key:"set",value:function(e,t,i,n,r,a,s){return Fi.set(e.center,t,i,n),Fi.set(e.halfExtents,r,a,s),e}},{key:"merge",value:function(e,t,i){return Fi.subtract(es,t.center,t.halfExtents),Fi.subtract(ts,i.center,i.halfExtents),Fi.add(is,t.center,t.halfExtents),Fi.add(ns,i.center,i.halfExtents),Fi.max(ns,is,ns),Fi.min(is,es,ts),s.fromPoints(e,is,ns)}},{key:"transform",value:function(e,t,i){return Fi.transformMat4(e.center,t.center,i),Ja(e.halfExtents,t.halfExtents,i),e}}]),v(s,[{key:"getBoundary",value:function(e,t){Fi.subtract(e,this.center,this.halfExtents),Fi.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){Fi.transformMat4(r.center,this.center,e),Ja(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return s.clone(this)}},{key:"copy",value:function(e){return s.copy(this,e)}}]),s}(),ss=new Fi,os=new Fi,ls=new rn,us=function(){function _(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:1,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,c=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,d=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,f=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:1;y(this,_),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=_r.SHAPE_OBB,this.center=new Fi(e,t,i),this.halfExtents=new Fi(n,r,a),this.orientation=new rn(s,o,l,u,c,h,d,f,p)}return v(_,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p){return new _(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p)}},{key:"clone",value:function(e){return new _(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}},{key:"copy",value:function(e,t){return Fi.copy(e.center,t.center),Fi.copy(e.halfExtents,t.halfExtents),rn.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Fi.multiplyScalar(e.center,Fi.add(ss,t,i),.5),Fi.multiplyScalar(e.halfExtents,Fi.subtract(os,i,t),.5),rn.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,d,f,p,_){return Fi.set(e.center,t,i,n),Fi.set(e.halfExtents,r,a,s),rn.set(e.orientation,o,l,u,c,h,d,f,p,_),e}}]),v(_,[{key:"getBoundary",value:function(e,t){!function(e,t,i){ls.m00=Math.abs(i.m00),ls.m01=Math.abs(i.m01),ls.m02=Math.abs(i.m02),ls.m03=Math.abs(i.m03),ls.m04=Math.abs(i.m04),ls.m05=Math.abs(i.m05),ls.m06=Math.abs(i.m06),ls.m07=Math.abs(i.m07),ls.m08=Math.abs(i.m08),Fi.transformMat3(e,t,ls)}(ss,this.halfExtents,this.orientation),Fi.subtract(e,this.center,ss),Fi.add(t,this.center,ss)}},{key:"transform",value:function(e,t,i,n,r){Fi.transformMat4(r.center,this.center,e),rn.fromQuat(r.orientation,i),Fi.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){Fi.transformMat4(i.center,this.center,e),rn.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Fi.multiply(t.halfExtents,this.halfExtents,e)}}]),_}(),cs=new Array(8);cs[0]=new Fi(1,1,1),cs[1]=new Fi(-1,1,1),cs[2]=new Fi(-1,-1,1),cs[3]=new Fi(1,-1,1),cs[4]=new Fi(1,1,-1),cs[5]=new Fi(-1,1,-1),cs[6]=new Fi(-1,-1,-1),cs[7]=new Fi(1,-1,-1);var hs,ds=function(){function i(){y(this,i),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=_r.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Ya.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Fi}return v(i,[{key:"accurate",set:function(e){this._type=e?_r.SHAPE_FRUSTUM_ACCURATE:_r.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new i}},{key:"clone",value:function(e){return i.copy(new i,e)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)Ya.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)Fi.copy(e.vertices[n],t.vertices[n]);return e}}]),v(i,[{key:"update",value:function(e,t){if(Fi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Fi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Fi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Fi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Fi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Fi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===_r.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();Fi.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)Fi.transformMat4(this.vertices[a],cs[a],t)}}},{key:"transform",value:function(e){if(this._type===_r.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Fi.transformMat4(this.vertices[t],this.vertices[t],e);Ya.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Ya.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Ya.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Ya.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Ya.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Ya.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),i}();ds.createOrtho=(hs=new Fi,function(e,t,i,n,r,a){var s=t/2,o=i/2;Fi.set(hs,s,o,n),Fi.transformMat4(e.vertices[0],hs,a),Fi.set(hs,-s,o,n),Fi.transformMat4(e.vertices[1],hs,a),Fi.set(hs,-s,-o,n),Fi.transformMat4(e.vertices[2],hs,a),Fi.set(hs,s,-o,n),Fi.transformMat4(e.vertices[3],hs,a),Fi.set(hs,s,o,r),Fi.transformMat4(e.vertices[4],hs,a),Fi.set(hs,-s,o,r),Fi.transformMat4(e.vertices[5],hs,a),Fi.set(hs,-s,-o,r),Fi.transformMat4(e.vertices[6],hs,a),Fi.set(hs,s,-o,r),Fi.transformMat4(e.vertices[7],hs,a),Ya.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Ya.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Ya.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Ya.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Ya.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Ya.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])});q3("CircularPool",function(){function n(e,t){y(this,n),this._cursor=void 0,this._data=void 0,this._cursor=0,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return v(n,[{key:"request",value:function(){var e=this._data[this._cursor];return this._cursor=(this._cursor+1)%this._data.length,e}}]),n}());var fs=32,ps=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function _s(e){return e<1e5?e<100?e<10?0:1:e<1e4?e<1e3?2:3:4:e<1e7?e<1e6?5:6:e<1e9?e<1e8?7:8:9}function vs(e,t){if(e===t)return 0;if(~~e===e&&~~t===t){if(0===e||0===t)return e<t?-1:1;if(e<0||t<0){if(0<=t)return-1;if(0<=e)return 1;e=-e,t=-t}var i=_s(e),n=_s(t),r=0;return i<n?(e*=ps[n-i-1],t/=10,r=-1):n<i&&(t*=ps[i-n-1],e/=10,r=1),e===t?r:e<t?-1:1}var a=String(e),s=String(t);return a===s?0:a<s?-1:1}function ms(e,t,i,n){var r=t+1;if(r===i)return 1;if(n(e[r++],e[t])<0){for(;r<i&&n(e[r],e[r-1])<0;)r++;!function(e,t,i){i--;for(;t<i;){var n=e[t];e[t++]=e[i],e[i--]=n}}(e,t,r)}else for(;r<i&&0<=n(e[r],e[r-1]);)r++;return r-t}function ys(e,t,i,n,r){for(n===t&&n++;n<i;n++){for(var a=e[n],s=t,o=n;s<o;){var l=s+o>>>1;r(a,e[l])<0?o=l:s=1+l}var u=n-s;switch(u){case 3:e[s+3]=e[s+2];case 2:e[s+2]=e[s+1];case 1:e[s+1]=e[s];break;default:for(;0<u;)e[s+u]=e[s+u-1],u--}e[s]=a}}function gs(e,t,i,n,r,a){var s=0,o=0,l=1;if(0<a(e,t[i+r])){for(o=n-r;l<o&&0<a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}else{for(o=r+1;l<o&&a(e,t[i+r-l])<=0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var u=s;s=r-l,l=r-u}for(s++;s<l;){var c=s+(l-s>>>1);0<a(e,t[i+c])?s=c+1:l=c}return l}function bs(e,t,i,n,r,a){var s=0,o=0,l=1;if(a(e,t[i+r])<0){for(o=r+1;l<o&&a(e,t[i+r-l])<0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var u=s;s=r-l,l=r-u}else{for(o=n-r;l<o&&0<=a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}for(s++;s<l;){var c=s+(l-s>>>1);a(e,t[i+c])<0?l=c:s=c+1}return l}var xs=function(){function i(e,t){y(this,i),this.array=void 0,this.compare=void 0,this.minGallop=void 0,this.length=void 0,this.tmpStorageLength=void 0,this.tmp=void 0,this.stackLength=void 0,this.runStart=void 0,this.runLength=void 0,this.stackSize=void 0,this.array=e,this.compare=t,this.minGallop=7,this.length=e.length,this.tmpStorageLength=256,this.length<512&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength),this.stackSize=0}return v(i,[{key:"pushRun",value:function(e,t){this.runStart[this.stackSize]=e,this.runLength[this.stackSize]=t,this.stackSize+=1}},{key:"mergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;if(1<=e&&this.runLength[e-1]<=this.runLength[e]+this.runLength[e+1]||2<=e&&this.runLength[e-2]<=this.runLength[e]+this.runLength[e-1])this.runLength[e-1]<this.runLength[e+1]&&e--;else if(this.runLength[e]>this.runLength[e+1])break;this.mergeAt(e)}}},{key:"forceMergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;0<e&&this.runLength[e-1]<this.runLength[e+1]&&e--,this.mergeAt(e)}}},{key:"mergeAt",value:function(e){var t=this.compare,i=this.array,n=this.runStart[e],r=this.runLength[e],a=this.runStart[e+1],s=this.runLength[e+1];this.runLength[e]=r+s,e===this.stackSize-3&&(this.runStart[e+1]=this.runStart[e+2],this.runLength[e+1]=this.runLength[e+2]),this.stackSize--;var o=bs(i[a],i,n,r,0,t);n+=o,0!==(r-=o)&&0!==(s=gs(i[n+r-1],i,a,s,s-1,t))&&(r<=s?this.mergeLow(n,r,a,s):this.mergeHigh(n,r,a,s))}},{key:"mergeLow",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<t;o++)s[o]=a[e+o];var l=0,u=i,c=e;if(a[c++]=a[u++],0!=--n)if(1!==t){for(var h=this.minGallop;;){var d=0,f=0,p=!1;do{if(r(a[u],s[l])<0){if(a[c++]=a[u++],f++,(d=0)==--n){p=!0;break}}else if(a[c++]=s[l++],d++,f=0,1==--t){p=!0;break}}while((d|f)<h);if(p)break;do{if(0!==(d=bs(a[u],s,l,t,0,r))){for(o=0;o<d;o++)a[c+o]=s[l+o];if(c+=d,l+=d,(t-=d)<=1){p=!0;break}}if(a[c++]=a[u++],0==--n){p=!0;break}if(0!==(f=gs(s[l],a,u,n,0,r))){for(o=0;o<f;o++)a[c+o]=a[u+o];if(c+=f,u+=f,0===(n-=f)){p=!0;break}}if(a[c++]=s[l++],1==--t){p=!0;break}h--}while(7<=d||7<=f);if(p)break;h<0&&(h=0),h+=2}if((this.minGallop=h)<1&&(this.minGallop=1),1===t){for(o=0;o<n;o++)a[c+o]=a[u+o];a[c+n]=s[l]}else{if(0===t)throw new Error("mergeLow preconditions were not respected");for(o=0;o<t;o++)a[c+o]=s[l+o]}}else{for(o=0;o<n;o++)a[c+o]=a[u+o];a[c+n]=s[l]}else for(o=0;o<t;o++)a[c+o]=s[l+o]}},{key:"mergeHigh",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<n;o++)s[o]=a[i+o];var l=e+t-1,u=n-1,c=i+n-1,h=0,d=0;if(a[c--]=a[l--],0!=--t)if(1!==n){for(var f=this.minGallop;;){var p=0,_=0,v=!1;do{if(r(s[u],a[l])<0){if(a[c--]=a[l--],p++,(_=0)==--t){v=!0;break}}else if(a[c--]=s[u--],_++,p=0,1==--n){v=!0;break}}while((p|_)<f);if(v)break;do{if(0!==(p=t-bs(s[u],a,e,t,t-1,r))){for(t-=p,d=(c-=p)+1,h=(l-=p)+1,o=p-1;0<=o;o--)a[d+o]=a[h+o];if(0===t){v=!0;break}}if(a[c--]=s[u--],1==--n){v=!0;break}if(0!==(_=n-gs(a[l],s,0,n,n-1,r))){for(n-=_,d=(c-=_)+1,h=(u-=_)+1,o=0;o<_;o++)a[d+o]=s[h+o];if(n<=1){v=!0;break}}if(a[c--]=a[l--],0==--t){v=!0;break}f--}while(7<=p||7<=_);if(v)break;f<0&&(f=0),f+=2}if((this.minGallop=f)<1&&(this.minGallop=1),1===n){for(d=(c-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[d+o]=a[h+o];a[c]=s[u]}else{if(0===n)throw new Error("mergeHigh preconditions were not respected");for(h=c-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}else{for(d=(c-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[d+o]=a[h+o];a[c]=s[u]}else for(h=c-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}]),i}();function Ss(e,t,i,n){if(!Array.isArray(e))throw new TypeError("Can only sort arrays");void 0===t&&(t=0),void 0===i&&(i=e.length),void 0===n&&(n=vs);var r=i-t;if(!(r<2)){var a=0;if(r<fs)ys(e,t,i,t+(a=ms(e,t,i,n)),n);else{var s=new xs(e,n),o=function(e){for(var t=0;fs<=e;)t|=1&e,e>>=1;return e+t}(r);do{if((a=ms(e,t,i,n))<o){var l=r;o<l&&(l=o),ys(e,t,t+l,t+a,n),a=l}s.pushRun(t,a),s.mergeRuns(),r-=a,t+=a}while(0!==r);s.forceMergeRuns()}}}for(var ws=q3("FixedArray",function(){function t(e){y(this,t),this._count=void 0,this._data=void 0,this._count=0,this._data=new Array(e)}return v(t,[{key:"_resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=void 0}},{key:"reset",value:function(){for(var e=0;e<this._count;++e)this._data[e]=void 0;this._count=0}},{key:"push",value:function(e){this._count>=this._data.length&&this._resize(2*this._data.length),this._data[this._count]=e,++this._count}},{key:"pop",value:function(){--this._count,this._count<0&&(this._count=0);var e=this._data[this._count];return this._data[this._count]=void 0,e}},{key:"fastRemove",value:function(e){if(!(e>=this._count||e<0)){var t=this._count-1;this._data[e]=this._data[t],this._data[t]=void 0,this._count-=1}}},{key:"indexOf",value:function(e){return this._data.indexOf(e)}},{key:"sort",value:function(e){return Ss(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}()),Ts=q3("Pool",function(){function n(e,t){y(this,n),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=e,this._idx=t-1,this._frees=new Array(t);for(var i=0;i<t;++i)this._frees[i]=e()}return v(n,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),n}()),Es=(q3("LinkedArray",function(){function i(e,t){y(this,i),this._fn=void 0,this._count=void 0,this._head=void 0,this._tail=void 0,this._pool=void 0,this._fn=e,this._count=0,this._head=null,this._tail=null,this._pool=new Ts(e,t)}return v(i,[{key:"add",value:function(){var e=this._pool.alloc();return this._tail?(this._tail._next=e)._prev=this._tail:this._head=e,this._tail=e,this._count+=1,e}},{key:"remove",value:function(e){e._prev?e._prev._next=e._next:this._head=e._next,e._next?e._next._prev=e._prev:this._tail=e._prev,e._next=null,e._prev=null,this._pool.free(e),this._count-=1}},{key:"forEach",value:function(e,t){var i=this._head;if(i){t&&(e=e.bind(t));for(var n=0,r=i;i;)r=i._next,e(i,n,this),i=r,++n}}},{key:"head",get:function(){return this._head}},{key:"tail",get:function(){return this._tail}},{key:"length",get:function(){return this._count}}]),i}()),q3("RecyclePool",function(){function n(e,t){y(this,n),this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return v(n,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"sort",value:function(e){return Ss(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),n}())),Cs=Array(8),As=0;As<8;++As)Cs[As]=[];function ks(e){var t=(65535<e)<<4,i=(255<(e>>>=t))<<3;return t|=i,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function Rs(e){var t=function(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}(e),i=Cs[ks(t)>>2];return 0<i.length?i.pop():new ArrayBuffer(t)}function Os(e,t,i,n,r){return Fi.set(e,t.x*i,t.y*n,t.z*r)}q3("TypedArrayPool",{alloc_int8:function(e){var t=new Int8Array(Rs(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint8:function(e){var t=new Uint8Array(Rs(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int16:function(e){var t=new Int16Array(Rs(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint16:function(e){var t=new Uint16Array(Rs(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int32:function(e){var t=new Int32Array(Rs(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint32:function(e){var t=new Uint32Array(Rs(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float32:function(e){var t=new Float32Array(Rs(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float64:function(e){var t=new Float64Array(Rs(8*e),0,e);return t.length!==e?t.subarray(0,e):t},free:function(e){!function(e){Cs[ks(e.byteLength)>>2].push(e)}(e.buffer)},reset:function(){Cs=Array(8);for(var e=0;e<8;++e)Cs[e]=[]}});function Ms(){y(this,Ms),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}var Is=function(){function s(e,t,i,n,r,a){y(this,s),this.minPos=void 0,this.maxPos=void 0,this.boundingBox=void 0,this.capacity=void 0,this.depth=void 0,this.maxDepth=void 0,this.blocks=void 0,this.entries=void 0,this._getBoundingShape=void 0,this.minPos=e,this.maxPos=t,this.boundingBox=as.fromPoints(as.create(),e,t),this.capacity=i,this.depth=n,this.maxDepth=r,this._getBoundingShape=a,this.blocks=null,this.entries=new ws(this.capacity)}return v(s,[{key:"addEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else{var a=this._getBoundingShape(e);if(!Ga.resolve(this.boundingBox,a))return;this.entries.push(e),this.entries.length>=this.capacity&&this.depth<this.maxDepth&&(this.blocks=Ls.createBlocks(this.minPos,this.maxPos,this.entries,this.capacity,this.depth,this.maxDepth,this._getBoundingShape),this.entries.reset())}}},{key:"removeEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.entries.fastRemove(this.entries.indexOf(e))}},{key:"select",value:function(e,t){if(Ga.resolve(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.select(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}},{key:"frustumSelect",value:function(e,t){if(Ga.aabb_frustum(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.frustumSelect(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}}]),s}(),Ls=function(){function c(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:32,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5;y(this,c),this.blockCapacity=void 0,this.maxDepth=void 0,this.blocks=void 0,this.dynamics=void 0,this._selection=void 0,this._getBoundingShape=void 0,this.blockCapacity=t,this.maxDepth=i,this.blocks=[],this.dynamics=[],this._selection=new Set,this._getBoundingShape=function(){return e._getBoundingShape}}return v(c,null,[{key:"createBlocks",value:function(e,t,i,n,r,a,s){var o=[],l=new Fi;Fi.multiplyScalar(l,Fi.subtract(l,t,e),.5);for(var u=0;u<2;u++)for(var c=0;c<2;c++)for(var h=0;h<2;h++){var d=new Fi,f=new Fi;Fi.add(d,e,Os(d,l,u,c,h)),Fi.add(f,e,Os(f,l,u+1,c+1,h+1));for(var p=new Is(d,f,n,r+1,a,s),_=0;_<i.length;_++){var v=(i.data||i)[_];p.addEntry(v)}o.push(p)}return o}}]),v(c,[{key:"build",value:function(e,t){var i=new Fi(1/0,1/0,1/0),n=new Fi(-1/0,-1/0,-1/0),r=new Fi,a=new Fi,s=[];this.dynamics=[];for(var o=0;o<e.length;o++){var l=(e.data||e)[o],u=t(l);u?(u.getBoundary(r,a),Fi.min(i,i,r),Fi.max(n,n,a),s.push(l)):this.dynamics.push(l)}this.blocks=c.createBlocks(i,n,s,this.blockCapacity,0,this.maxDepth,t),this._getBoundingShape=t}},{key:"addEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else this.dynamics.push(e)}},{key:"removeEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.dynamics.splice(this.dynamics.indexOf(e),1)}},{key:"select",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.select(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;this._selection.add(u)}return this._selection}},{key:"frustumSelect",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.frustumSelect(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;this._selection.add(u)}return this._selection}}]),c}(),zs=vt({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4});ai.fastDefine("cc.Keyframe",Ms,{time:0,value:0,inTangent:0,outTangent:0});var Bs=function(){function e(){y(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return v(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var Ps=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;y(this,t),this.keyFrames=void 0,this.preWrapMode=zs.Loop,this.postWrapMode=zs.Loop,this.cachedKey=void 0,this.keyFrames=e||[].concat(t.defaultKF),this.cachedKey=new Bs}return v(t,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case zs.Loop:t=Ci(e-n,r-n)+n;break;case zs.PingPong:t=Ai(e-n,r-n)+n;break;case zs.ClampForever:t=pi(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var s=0;s<this.keyFrames.length-1;s++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[s+1].time){a=s;break}var o=this.keyFrames[a],l=this.keyFrames[a+1],u=ki(o.time,l.time,t),c=l.time-o.time,h=o.outTangent*c,d=l.inTangent*c,f=u*u,p=f*u,_=p-2*f+u,v=p-f,m=-2*p+3*f;return(2*p-3*f+1)*o.value+_*h+v*d+m*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case zs.Loop:t=Ci(e-n,r-n)+n;break;case zs.PingPong:t=Ai(e-n,r-n)+n;break;case zs.ClampForever:t=pi(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),s=a+1;return s===this.keyFrames.length&&(s-=1),this.calcOptimizedKey(this.cachedKey,a,s),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,s=r.value-n.value,o=1/(a*a),l=n.outTangent*a,u=r.inTangent*a;e.coefficient[0]=(l+u-s-s)*o/a,e.coefficient[1]=(s+s+s-l-l-u)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(this.keyFrames[i].time<t)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var s=i-a;if(0<=s&&this.keyFrames[s-1].time<=t)return s-1}for(var o=0,l=this.keyFrames.length,u=Math.floor((o+l)/2);1<l-o;)this.keyFrames[u].time>=t?l=u:o=u+1,u=Math.floor((o+l)/2);return o}}]),t}();Ps.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],ai.fastDefine("cc.AnimationCurve",Ps,{preWrapMode:zs.Default,postWrapMode:zs.Default,keyFrames:[]}),sr(Ha.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),or(Ga,"intersect",[{name:"line_quad"}]);var Ds=Object.freeze({distance:ea,enums:_r,intersect:Ga,line:Ha,plane:Ya,ray:ta,triangle:Ka,sphere:$a,aabb:as,obb:us,frustum:ds,Octree:Ls,Keyframe:Ms,AnimationCurve:Ps});q3("geometry",Ds);var Fs=/([a-zA-Z0-9--]+|\S)/,Ns=/^[!,.:;'}\]%\?>]/,Us=/([a-zA-Z0-9--]+|\S)$/,Vs=/[a-zA-Z0-9--]+$/,Gs=/^[a-zA-Z0-9--]/;function Hs(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Ws(e){var t=e.charCodeAt(0);return 9<=t&&t<=13||32===t||133===t||160===t||5760===t||8192<=t&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function qs(e,t){var i=e.measureText(t);return i&&i.width||0}function js(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;i<t&&1<a.length;){for(var s=a.length*(i/t)|0,o=a.substr(s),l=t-n(o),u=o,c=0,h=0;i<l&&h++<10;)s*=i/l,s|=0,l=t-n(o=a.substr(s));for(h=0;l<=i&&h++<10;){if(o){var d=Fs.exec(o);c=d?d[0].length:1,u=o}s+=c,l=t-n(o=a.substr(s))}0===(s-=c)&&(s=1,u=u.substr(1));var f=a.substr(0,s),p=void 0;Ns.test(u||o)&&(0===(s-=(p=Us.exec(f))?p[0].length:0)&&(s=1),u=a.substr(s),f=a.substr(0,s)),Gs.test(u)&&(p=Vs.exec(f))&&f!==p[0]&&(s-=p[0].length,u=a.substr(s),f=a.substr(0,s)),0===r.length?r.push(f):0<(f=f.trim()).length&&r.push(f),t=n(a=u||o)}return 0===r.length?r.push(a):0<(a=a.trim()).length&&r.push(a),r}var Xs=/^(click)(\s)*=|(param)(\s)*=/,Ys=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,Ks=q3("HtmlTextParser",function(){function e(){y(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return v(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=-1<r?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return-1<r&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var s="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match(Ys);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"src"===n?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(l=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(l=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===n?t.imageHeight=parseInt(o):"width"===n?t.imageWidth=parseInt(o):"click"===n&&(t.event=this._processEventHandler(n+"="+o)),t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match(Ys);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var u={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var c,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),c=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+c):"color"===n?u.color=c:"width"===n&&(u.width=parseInt(c)),t.event&&"param"===n&&(t.event[n]=c.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=u}if((i=e.match(/^(on|u|b|i)(\s)*/))&&0<i[0].length){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(Xs),r=!1;n;){var a=n[0],s="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))-1<(t=e.indexOf('"',1))&&(s=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))-1<(t=e.indexOf("'",1))&&(s=e.substring(1,t).trim(),r=!0),t++;else{var o=e.match(/(\S)+/);t=(s=o?o[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=s),n=(e=e.substring(t).trim()).match(Xs)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a[0],o=a[1];e=e.replace(s,o)}return e}}]),e}());var Qs="__ccclassCache__";function Zs(e){return e}function Js(e,t){return e[t]||(e[t]={})}function $s(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function eo(e,i,t){return function(t){return function(e){return i(e,t)}}}var to=eo.bind(null,!1);function io(){return eo.bind(null,!1)}var no=io(),ro=io();function ao(e){return Js(e,Qs)}function so(e,t,i,n,r,a){var s;n&&(s=(s=Dt(n))||n);var o=Ne(t[i]||{},s||{});if(r&&(r.get||r.set)){r.get&&(o.get=r.get),r.set&&(o.set=r.set)}else{var l;0;if(r)r.initializer&&(l=function(t){var e;try{e=t()}catch(e){return t}return"object"!==_e(e)||null===e?e:t}(r.initializer),!0);else{var u=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(i)&&(l=u[i],!0)}0,o.default=l}t[i]=o}var oo=$s(function(e,t){var i=Ve(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e[Qs];if(r){var a=r.proto;a&&Ne(n,a),e[Qs]=void 0}return cc.Class(n)});function lo(e,t,i){var a=null;function n(e,t,i){var n=ao(e.constructor);if(n){var r=Js(Js(n,"proto"),"properties");so(e.constructor,r,t,a,i,n)}}if(void 0===t)return a=e,n;n(e,t,i)}function uo(e,r,a){return e(function(e,t){var i=ao(e);if(i){var n=void 0!==a?a:t;Js(Js(i,"proto"),"editor")[r]=n}},r)}function co(e){return e(Zs)}var ho=co($s),fo=uo(to,"requireComponent"),po=co(no),_o=uo(ro,"executionOrder"),vo=co($s),mo=co($s),yo=co(no),go=co(no),bo=co(no);var xo=Eo(At),So=Eo(kt),wo=Eo(Rt),To=Eo(Ot);function Eo(e){return lo({type:e})}var Co,Ao,ko,Ro,Oo,Mo,Io,Lo=Object.freeze({ccclass:oo,property:lo,executeInEditMode:ho,requireComponent:fo,menu:po,executionOrder:_o,disallowMultiple:vo,playOnFocus:mo,inspector:yo,icon:go,help:bo,mixins:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=e<0||arguments.length<=e?void 0:arguments[e];return function(e){var t=ao(e);t&&(Js(t,"proto").mixins=i)}},integer:xo,float:So,boolean:wo,string:To,type:Eo});q3("_decorator",Lo);var zo=q3("PrefabInfo",oo("cc.PrefabInfo")((ko=b((Ao=function e(){y(this,e),m(this,"root",ko,this),m(this,"asset",Ro,this),m(this,"fileId",Oo,this),m(this,"sync",Mo,this),m(this,"_synced",Io,this)}).prototype,"root",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ro=b(Ao.prototype,"asset",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oo=b(Ao.prototype,"fileId",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mo=b(Ao.prototype,"sync",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Io=b(Ao.prototype,"_synced",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),Co=Ao))||Co);cc._PrefabInfo=zo;var Bo=new Fi;function Po(e,t,i,n){n=n||new Fi,e.worldToScreen(t,Bo),Bo.x=Bo.x/cc.view.getScaleX(),Bo.y=Bo.y/cc.view.getScaleY();var r=i.getComponent("cc.UITransformComponent");if(!r)return n;r.convertToNodeSpaceAR(Bo,n);var a=i.getPosition();return n.add(a),n}function Do(e,t,i){return i=i||new Fi,e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}var Fo=q3("convertUtils",{WorldNode3DToLocalNodeUI:Po,WorldNode3DToWorldNodeUI:Do});cc.pipelineUtils=Fo;var No=1,Uo=4,Vo=~(129504|Uo|1<<17|1<<18|1<<19|1<<20|1<<21),Go=[];var Ho=q3("CCObject",function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";y(this,t),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}return v(t,null,[{key:"_deferredDestroy",value:function(){for(var e=Go.length,t=0;t<e;++t){var i=Go[t];i._objFlags&No||i._destroyImmediate()}e===Go.length?Go.length=0:Go.splice(0,e)}}]),v(t,[{key:"destroy",value:function(){return this._objFlags&No?(cc.warnID(5e3),!1):!(this._objFlags&Uo)&&(this._objFlags|=Uo,Go.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof cc._BaseNode||e instanceof cc.Component,r=n?"_id":null,a={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(_e(e[i])){case"string":a[i]="";break;case"object":case"function":a[i]=null}}if(ai._isCCClass(t))for(var s=cc.Class.Attr.getClassAttrs(t),o=t.__props__,l=0;l<o.length;l++){var u=(i=o[l])+cc.Class.Attr.DELIMETER+"default";if(u in s){if(n&&"_id"===i)continue;switch(_e(s[u])){case"string":a[i]="";break;case"object":case"function":a[i]=null;break;case"undefined":a[i]=void 0}}}return function(e){for(var t in a)e[t]=a[t]}}(this,e),Te(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){this._objFlags&No?cc.errorID(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=No)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(this._objFlags&No)}}]),t}()),Wo=Ho.prototype;function qo(e,t){return"object"===_e(e)?!(!e||e._objFlags&(t?No|Uo:No)):void 0!==e}Wo._deserialize=null,Wo._onPreDestroy=null,ai.fastDefine("cc.Object",Ho,{_name:"",_objFlags:0}),Te(Ho,"Flags",{Destroyed:No,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:Vo,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=qo,cc.Object=Ho;var jo=function(){function e(){y(this,e),this.assignAssetsBy=void 0,this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=ke(!0)}return v(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,He(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();jo.pool=void 0,jo.pool=new Je(function(e){e.reset()},10),jo.pool.get=function(){return this._get()||new jo};var Xo=function(e,p){var _,v=tt.test(Ze(p)),h=cc.js.isChildClassOf(p,cc._BaseNode)||cc.js.isChildClassOf(p,cc.Component),m=[],y=m,g=[],b=g,x=[],S=[];return function(){var e=p.__values__;_="_$erialized"===e[e.length-1];for(var t=wt(p),i=gt+"type",n=gt+"default",r=gt+"saveUrlAsAsset",a=gt+"formerlySerializedAs",s=0;s<e.length;s++){var o=e[s],l=o;t[o+a]&&(l=t[o+a]);var u=t[o+r],c=ai.getDefault(t[o+n]),h=!1;if(v){var d=t[o+i];if(void 0===c&&d)h=d===cc.String||d===cc.Integer||d===cc.Float||d===cc.Boolean;else{var f=_e(c);h="string"===f&&!u||"number"===f||"boolean"===f}}v&&h?(l!==o&&y===m&&(y=m.slice()),m.push(o),y!==m&&y.push(l)):(l!==o&&b===g&&(b=g.slice()),g.push(o),b!==g&&b.push(l),x.push(u),S.push(c instanceof cc.ValueType&&c.constructor))}}(),function(e,t,i,n,r){for(var a=0;a<m.length;++a){var s=i[y[a]];void 0!==s&&(t[m[a]]=s)}for(var o=0;o<g.length;++o){var l=g[o],u=i[b[o]];if(void 0!==u)if(v||"object"===_e(u)){var c=S[o];c?v||u?e._deserializeTypedObject(t[l],u,c):t[l]=null:u?e._deserializeObjField(t,u,l,null,x[o]):t[l]=null}else t[l]=u}h&&i._id&&(t._id=i._id),_&&(t._$erialized=JSON.parse(JSON.stringify(i)),e._deserializePrimitiveObject(t._$erialized,i))}};function Yo(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=Xo(e,n),Te(n,"__deserialize__",a,!0)),a(e,t,i,n,r),t.__postDeserialize&&t.__postDeserialize()}var Ko=function(){function a(e,t,i,n,r){y(this,a),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return v(a,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++){if(t[n])this.deserializedList[n]=this._deserializeObject(t[n],!1)}this.deserializedData=0<i?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,s=e._idList,o=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<s.length;t++)i=a[t],n=s[t],o[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n,r){var a,s=null,o=null,l=e.__type__;if("TypedArray"===l){var u=e.array;s=new window[e.ctor](u.length);for(var c=0;c<u.length;++c)s[c]=u[c];return s}if(l){var h=function(){(s=new o)._deserialize?s._deserialize(e.content,d):cc.Class._isCCClass(o)?Yo(d,s,e,o,i):d._deserializeTypedObject(s,e,o)};if(!(o=this._classFinder(l,e,n,r)))return this._classFinder===Ke&&cc.deserialize.reportMissingClass(l),null;var d=this;h()}else if(Array.isArray(e)){s=new Array(e.length);for(var f=0;f<e.length;f++)"object"===_e(a=e[f])&&a?this._deserializeObjField(s,a,""+f,null,t):s[f]=a}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var s=t.__uuid__;s?this.result.push(e,i,s,r):e[i]=this._deserializeObject(t,r)}else{var o=this.deserializedList[a];o?e[i]=o:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"object"!==_e(n)?"__type__"!==i&&(e[i]=n):n?this._deserializeObjField(e,n,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=gt+"default",r=wt(i),a=i.__props__||Object.keys(e),s=0;s<a.length;s++){var o=a[s],l=t[o];void 0!==l&&t.hasOwnProperty(o)||(l=ai.getDefault(r[o+n])),"object"!==_e(l)?e[o]=l:l?this._deserializeObjField(e,l,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var u=t.a;e.a=void 0===u?255:u}}}]),a}();function Qo(e,t,i){var n=(i=i||{}).classFinder||Ke,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||jo.pool.get();var l=Ko.pool.get(t,!1,n,a,s);cc.game._isCloning=!0;var u=l.deserialize(e);return cc.game._isCloning=!1,Ko.pool.put(l),r&&t.assignAssetsBy(Editor.serialize.asAsset),o&&jo.pool.put(t),u}Ko.pool=void 0,Ko.pool=new Je(function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),Ko.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new Ko(e,t,i,n,r)},Qo.Details=jo,Qo.reportMissingClass=function(e){cc.warnID(5302,e)},cc.deserialize=Qo,q3("deserialize",Qo);var Zo,Jo,$o,el,tl,il,nl,rl,al,sl,ol,ll,ul,cl=Ho.Flags.Destroyed,hl=Ho.Flags.PersistentMask,dl=[];function fl(e,t){if(!t){if("object"!==_e(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var i;if(e instanceof Ho){if((e=e)._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=pl(e),cc.game._isCloning=!1,i}function pl(e,t){if(Array.isArray(e))return null;if(ct(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new e.constructor}else i=Object.create(null);_l(e,i,t);for(var n=0,r=dl.length;n<r;++n)dl[n]._iN$t=null;return dl.length=0,i}function _l(e,t,i){Te(e,"_iN$t",t,!0),dl.push(e);var n=e.constructor;if(cc.Class._isCCClass(n))!function(e,t,i,n){for(var r=e.__values__,a=0;a<r.length;a++){var s=r[a],o=t[s];if("object"===_e(o)&&o){var l=i[s];l instanceof yt&&l.constructor===o.constructor?l.set(o):i[s]=o._iN$t||vl(o,n)}else i[s]=o}}(n,e,t,i);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=e[r];if("object"===_e(a)&&a){if(a===t)continue;t[r]=a._iN$t||vl(a,i)}else t[r]=a}e instanceof Ho&&(t._objFlags&=hl)}function vl(e,t){if(e instanceof yt)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var n=e.length;i=new Array(n),e._iN$t=i;for(var r=0;r<n;++r){var a=e[r];"object"===_e(a)&&a?i[r]=a._iN$t||vl(a,t):i[r]=a}return dl.push(e),i}if(e._objFlags&cl)return null;var s=e.constructor;if(cc.Class._isCCClass(s)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new s}else if(s===Object)i={};else{if(s)return e;i=Object.create(null)}return _l(e,i,t),i}fl._clone=pl,cc.instantiate=fl,q3("instantiate",fl),(ol=sl=sl||{})[ol.Uint8=0]="Uint8",ol[ol.Uint16=1]="Uint16",ol[ol.Uint32=2]="Uint32",ol[ol.Int8=3]="Int8",ol[ol.Int16=4]="Int16",ol[ol.Int32=5]="Int32",ol[ol.Float32=6]="Float32",ol[ol.Float64=7]="Float64",(ul=ll=ll||{})[ul.Scalar=0]="Scalar",ul[ul.Vec2=1]="Vec2",ul[ul.Vec3=2]="Vec3",ul[ul.Vec4=3]="Vec4",ul[ul.Quat=4]="Quat";function ml(e,t){return(t<<3)+e}var yl=q3("CompactValueTypeArray",oo("cc.CompactValueTypeArray")((rl=nl=function(){function d(){y(this,d),m(this,"_byteOffset",$o,this),m(this,"_unitCount",el,this),m(this,"_unitElement",tl,this),m(this,"_length",il,this)}return v(d,[{key:"decompress",value:function(e){for(var t=function(e){return{storageUnit:7&e,elementType:e>>3}}(this._unitElement),i=t.storageUnit,n=gl(t.elementType),r=new(bl(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=n.decompress(r,s);return a}}],[{key:"lengthFor",value:function(e,t,i){return gl(t).requiredUnits*e.length*bl(i).BYTES_PER_ELEMENT}},{key:"compress",value:function(e,t,i,n,r,a){for(var s=gl(t),o=bl(i),l=s.requiredUnits*e.length,u=new o(n,r,l),c=0;c<e.length;++c)s.compress(u,c,e[c]);var h=new d;return h._unitElement=ml(i,t),h._byteOffset=a,h._unitCount=l,h._length=e.length,h}}]),d}(),nl.StorageUnit=sl,nl.ElementType=ll,$o=b((Jo=rl).prototype,"_byteOffset",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),el=b(Jo.prototype,"_unitCount",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tl=b(Jo.prototype,"_unitElement",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ml(sl.Uint8,ll.Scalar)}}),il=b(Jo.prototype,"_length",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zo=Jo))||Zo);function gl(e){return xl[e]}function bl(e){switch(e){case sl.Uint8:return Uint8Array;case sl.Uint16:return Uint16Array;case sl.Uint32:return Uint32Array;case sl.Int8:return Int8Array;case sl.Int16:return Int16Array;case sl.Int32:return Int32Array;case sl.Float32:return Float32Array;case sl.Float64:return Float64Array}}var xl=(s(al={},ll.Scalar,{requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}}),s(al,ll.Vec2,{requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new Fi(e[2*t],e[2*t+1])}}),s(al,ll.Vec3,{requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new Fi(e[3*t],e[3*t+1],e[3*t+2])}}),s(al,ll.Vec4,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new ji(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),s(al,ll.Quat,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new hn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),al);cc._decorator=Lo;var Sl=q3("Event",function(){function i(e,t){y(this,i),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}return v(i,[{key:"unuse",value:function(){this.type=i.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=i.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),i}());Sl.NO_TYPE="no_type",Sl.TOUCH="touch",Sl.MOUSE="mouse",Sl.KEYBOARD="keyboard",Sl.ACCELERATION="acceleration",Sl.NONE=0,Sl.CAPTURING_PHASE=1,Sl.AT_TARGET=2,Sl.BUBBLING_PHASE=3,cc.Event=Sl;var wl=$e.fastRemoveAt;function Tl(){}var El=function(){function e(){y(this,e),this.callback=Tl,this.target=void 0,this.once=!1}return v(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),Cl=new Ts(function(){return new El},32),Al=function(){function e(){y(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return v(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(Cl.free(i),wl(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(Cl.free(i),wl(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(Cl.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(Cl.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;0<=e;--e){this.callbackInfos[e]||wl(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),kl=new Ts(function(){return new Al},16),Rl=function(){function e(){y(this,e),this._callbackTable=ke(!0)}return v(e,[{key:"on",value:function(e,t,i,n){var r=this._callbackTable[e];r=r||(this._callbackTable[e]=kl.alloc());var a=Cl.alloc();a.set(t,i,n),r.callbackInfos.push(a)}},{key:"hasEventListener",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:null,r=this._callbackTable[e];if(!r)return!1;var a=r.callbackInfos;if(!t){if(r.isInvoking){var s=a,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}if(u)return!0}return!1}return 0<a.length}var c=a,h=Array.isArray(c),d=0;for(c=h?c:c[Symbol.iterator]();;){var f;if(h){if(d>=c.length)break;f=c[d++]}else{if((d=c.next()).done)break;f=d.value}var p=f;if(p&&p.callback===t&&p.target===n)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),kl.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var s=r[a];s&&s.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.callback===t&&s.target===i){n.isInvoking?n.cancel(a):(wl(r,a),Cl.free(s));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var n=t.callbackInfos,r=arguments.length,a=new Array(1<r?r-1:0),s=1;s<r;s++)a[s-1]=arguments[s];for(var o=0,l=n.length;o<l;++o){var u=n[o];if(u){var c=u.callback,h=u.target;u.once&&this.off(e,c,h),h?c.call.apply(c,[h].concat(a)):c.apply(void 0,a)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var Ol=$e.fastRemove,Ml=q3("EventTarget",function(){function r(){return y(this,r),x(this,g(r).apply(this,arguments))}return p(r,Rl),v(r,[{key:"on",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_(g(r.prototype),"on",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"off",value:function(e,t,i){if(t){_(g(r.prototype),"off",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?Ol(n.__eventTargets,this):n.node&&n.node.__eventTargets&&Ol(n.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_(g(r.prototype),"on",this).call(this,e,t,i,!0);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}}]),r}());cc.EventTarget=Ml;var Il,Ll={};Ll.LANGUAGE_ENGLISH="en",Ll.LANGUAGE_CHINESE="zh",Ll.LANGUAGE_FRENCH="fr",Ll.LANGUAGE_ITALIAN="it",Ll.LANGUAGE_GERMAN="de",Ll.LANGUAGE_SPANISH="es",Ll.LANGUAGE_DUTCH="du",Ll.LANGUAGE_RUSSIAN="ru",Ll.LANGUAGE_KOREAN="ko",Ll.LANGUAGE_JAPANESE="ja",Ll.LANGUAGE_HUNGARIAN="hu",Ll.LANGUAGE_PORTUGUESE="pt",Ll.LANGUAGE_ARABIC="ar",Ll.LANGUAGE_NORWEGIAN="no",Ll.LANGUAGE_POLISH="pl",Ll.LANGUAGE_TURKISH="tr",Ll.LANGUAGE_UKRAINIAN="uk",Ll.LANGUAGE_ROMANIAN="ro",Ll.LANGUAGE_BULGARIAN="bg",Ll.LANGUAGE_UNKNOWN="unknown",Ll.OS_IOS="iOS",Ll.OS_ANDROID="Android",Ll.OS_WINDOWS="Windows",Ll.OS_MARMALADE="Marmalade",Ll.OS_LINUX="Linux",Ll.OS_BADA="Bada",Ll.OS_BLACKBERRY="Blackberry",Ll.OS_OSX="OS X",Ll.OS_WP8="WP8",Ll.OS_WINRT="WINRT",Ll.OS_UNKNOWN="Unknown",Ll.UNKNOWN=-1,Ll.WIN32=0,Ll.LINUX=1,Ll.MACOS=2,Ll.ANDROID=3,Ll.IPHONE=4,Ll.IPAD=5,Ll.BLACKBERRY=6,Ll.NACL=7,Ll.EMSCRIPTEN=8,Ll.TIZEN=9,Ll.WINRT=10,Ll.WP8=11,Ll.MOBILE_BROWSER=100,Ll.DESKTOP_BROWSER=101,Ll.EDITOR_PAGE=102,Ll.EDITOR_CORE=103,Ll.WECHAT_GAME=104,Ll.QQ_PLAY=105,Ll.BROWSER_TYPE_WECHAT="wechat",Ll.BROWSER_TYPE_WECHAT_GAME="wechatgame",Ll.BROWSER_TYPE_WECHAT_GAME_SUB="wechatgamesub",Ll.BROWSER_TYPE_QQ_PLAY="qqplay",Ll.BROWSER_TYPE_ANDROID="androidbrowser",Ll.BROWSER_TYPE_IE="ie",Ll.BROWSER_TYPE_QQ="qqbrowser",Ll.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",Ll.BROWSER_TYPE_UC="ucbrowser",Ll.BROWSER_TYPE_UCBS="ucbs",Ll.BROWSER_TYPE_360="360browser",Ll.BROWSER_TYPE_BAIDU_APP="baiduboxapp",Ll.BROWSER_TYPE_BAIDU="baidubrowser",Ll.BROWSER_TYPE_MAXTHON="maxthon",Ll.BROWSER_TYPE_OPERA="opera",Ll.BROWSER_TYPE_OUPENG="oupeng",Ll.BROWSER_TYPE_MIUI="miuibrowser",Ll.BROWSER_TYPE_FIREFOX="firefox",Ll.BROWSER_TYPE_SAFARI="safari",Ll.BROWSER_TYPE_CHROME="chrome",Ll.BROWSER_TYPE_LIEBAO="liebao",Ll.BROWSER_TYPE_QZONE="qzone",Ll.BROWSER_TYPE_SOUGOU="sogou",Ll.BROWSER_TYPE_UNKNOWN="unknown",Ll.isNative=!1,Ll.isBrowser="object"===("undefined"==typeof window?"undefined":_e(window))&&"object"===("undefined"==typeof document?"undefined":_e(document))&&!1,Ll.isLittleEndian=(Il=new ArrayBuffer(2),new DataView(Il).setInt16(0,256,!0),256===new Int16Array(Il)[0]);var zl=wx.getSystemInfoSync();Ll.isMobile=!0,Ll.platform=Ll.WECHAT_GAME,Ll.language=zl.language.substr(0,2);var Bl=zl.system.toLowerCase();"android"===zl.platform?Ll.os=Ll.OS_ANDROID:"ios"===zl.platform?Ll.os=Ll.OS_IOS:"devtools"===zl.platform&&(Ll.isMobile=!1,-1<Bl.indexOf("android")?Ll.os=Ll.OS_ANDROID:-1<Bl.indexOf("ios")&&(Ll.os=Ll.OS_IOS)),"android p"===Bl&&(Bl="android p 9.0");var Pl=/[\d\.]+/.exec(Bl);Ll.osVersion=Pl?Pl[0]:Bl,Ll.osMainVersion=parseInt(Ll.osVersion),wx.getFileSystemManager?Ll.browserType=Ll.BROWSER_TYPE_WECHAT_GAME:Ll.browserType=Ll.BROWSER_TYPE_WECHAT_GAME_SUB,Ll.browserVersion=zl.version;var Dl=zl.windowWidth,Fl=zl.windowHeight,Nl=zl.pixelRatio||1;Ll.windowPixelResolution={width:Nl*Dl,height:Nl*Fl},Ll.localStorage=window.localStorage,Ll.capabilities={canvas:!0,opengl:Ll.browserType!==Ll.BROWSER_TYPE_WECHAT_GAME_SUB,webp:!1},Ll.__audioSupport={ONLY_ONE:!1,WEB_AUDIO:!1,DELAY_CREATE_CTX:!1,format:[".mp3"]},Ll.NetworkType={NONE:0,LAN:1,WWAN:2},Ll.getNetworkType=function(){return Ll.NetworkType.LAN},Ll.getBatteryLevel=function(){return 1},Ll.garbageCollect=function(){},Ll.dumpRoot=function(){},Ll.restartVM=function(){},Ll.cleanScript=function(e){},Ll.isObjectValid=function(e){return!!e},Ll.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},Ll.openURL=function(e){window.open(e)},Ll.now=function(){return Date.now?Date.now():+new Date},cc.sys=Ll;var Ul=cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),Vl=q3("macro",{SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat:Ul,RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Mi(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1});cc.macro=Vl;var Gl={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,s=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=s,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=s,this.right.y=r+i/2}};function Hl(e){return e*e}function Wl(e){return e*(2-e)}function ql(e){return e*e*e}function jl(e){return--e*e*e+1}function Xl(e){return e*e*e*e}function Yl(e){return 1- --e*e*e*e}function Kl(e){return e*e*e*e*e}function Ql(e){return--e*e*e*e*e+1}function Zl(e){return 1-Math.cos(e*Math.PI/2)}function Jl(e){return Math.sin(e*Math.PI/2)}function $l(e){return 0===e?0:Math.pow(1024,e-1)}function eu(e){return 1===e?1:1-Math.pow(2,-10*e)}function tu(e){return 1-Math.sqrt(1-e*e)}function iu(e){return Math.sqrt(1- --e*e)}function nu(e){return e*e*(2.70158*e-1.70158)}function ru(e){return--e*e*(2.70158*e+1.70158)+1}function au(e){return 1-su(1-e)}function su(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}cc.visibleRect=Gl;var ou=vu(Hl,Wl),lu=vu(ql,jl),uu=vu(Xl,Yl),cu=vu(Kl,Ql),hu=vu(Zl,Jl),du=vu($l,eu),fu=vu(tu,iu),pu=vu(nu,ru),_u=vu(au,su);function vu(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var mu=Object.freeze({constant:function(){return 0},linear:function(e){return e},quadIn:Hl,quadOut:Wl,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:ql,cubicOut:jl,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:Xl,quartOut:Yl,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:Kl,quintOut:Ql,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:Zl,sineOut:Jl,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:$l,expoOut:eu,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:tu,circOut:iu,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},elasticOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},elasticInOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)},backIn:nu,backOut:ru,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)},bounceIn:au,bounceOut:su,bounceInOut:function(e){return e<.5?.5*au(2*e):.5*su(2*e-1)+.5},smooth:function(e){return e<=0?0:1<=e?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:ou,cubicOutIn:lu,quartOutIn:uu,quintOutIn:cu,sineOutIn:hu,expoOutIn:du,circOutIn:fu,backOutIn:pu,bounceOutIn:_u});q3("easing",mu);var yu,gu,bu,xu,Su=q3("GFX_MAX_VERTEX_ATTRIBUTES",16),wu=q3("GFX_MAX_TEXTURE_UNITS",16),Tu=q3("GFX_MAX_ATTACHMENTS",4),Eu=q3("GFX_MAX_BUFFER_BINDINGS",24);(gu=yu=yu||q3("GFXObjectType",{}))[gu.UNKNOWN=0]="UNKNOWN",gu[gu.BUFFER=1]="BUFFER",gu[gu.TEXTURE=2]="TEXTURE",gu[gu.TEXTURE_VIEW=3]="TEXTURE_VIEW",gu[gu.RENDER_PASS=4]="RENDER_PASS",gu[gu.FRAMEBUFFER=5]="FRAMEBUFFER",gu[gu.SAMPLER=6]="SAMPLER",gu[gu.SHADER=7]="SHADER",gu[gu.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",gu[gu.PIPELINE_STATE=9]="PIPELINE_STATE",gu[gu.BINDING_LAYOUT=10]="BINDING_LAYOUT",gu[gu.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",gu[gu.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",gu[gu.COMMAND_BUFFER=13]="COMMAND_BUFFER",gu[gu.QUEUE=14]="QUEUE",gu[gu.WINDOW=15]="WINDOW",(xu=bu=bu||q3("GFXStatus",{}))[xu.UNREADY=0]="UNREADY",xu[xu.FAILED=1]="FAILED",xu[xu.SUCCESS=2]="SUCCESS";var Cu,Au,ku,Ru,Ou,Mu,Iu,Lu,zu,Bu,Pu,Du,Fu,Nu,Uu,Vu,Gu,Hu,Wu,qu,ju,Xu,Yu,Ku,Qu,Zu,Ju,$u,ec,tc,ic,nc,rc,ac,sc,oc,lc,uc,hc,dc,fc,pc,_c,vc,mc,yc,gc,bc,xc,Sc,wc,Tc,Ec,Cc,Ac,kc,Rc,Oc,Mc,Ic,Lc,zc,Bc,Pc,Dc,Fc,Nc,Uc,Vc=q3("GFXObject",function(){function t(e){y(this,t),this._gfxType=yu.UNKNOWN,this._status=bu.UNREADY,this._gfxType=e}return v(t,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),t}());(Au=Cu=Cu||q3("GFXAttributeName",{})).ATTR_POSITION="a_position",Au.ATTR_NORMAL="a_normal",Au.ATTR_TANGENT="a_tangent",Au.ATTR_BITANGENT="a_bitangent",Au.ATTR_WEIGHTS="a_weights",Au.ATTR_JOINTS="a_joints",Au.ATTR_COLOR="a_color",Au.ATTR_COLOR1="a_color1",Au.ATTR_COLOR2="a_color2",Au.ATTR_TEX_COORD="a_texCoord",Au.ATTR_TEX_COORD1="a_texCoord1",Au.ATTR_TEX_COORD2="a_texCoord2",Au.ATTR_TEX_COORD3="a_texCoord3",Au.ATTR_TEX_COORD4="a_texCoord4",Au.ATTR_TEX_COORD5="a_texCoord5",Au.ATTR_TEX_COORD6="a_texCoord6",Au.ATTR_TEX_COORD7="a_texCoord7",Au.ATTR_TEX_COORD8="a_texCoord8",Au.ATTR_BATCH_ID="a_batch_id",Au.ATTR_BATCH_UV="a_batch_uv",(Ru=ku=ku||q3("GFXType",{}))[Ru.UNKNOWN=0]="UNKNOWN",Ru[Ru.BOOL=1]="BOOL",Ru[Ru.BOOL2=2]="BOOL2",Ru[Ru.BOOL3=3]="BOOL3",Ru[Ru.BOOL4=4]="BOOL4",Ru[Ru.INT=5]="INT",Ru[Ru.INT2=6]="INT2",Ru[Ru.INT3=7]="INT3",Ru[Ru.INT4=8]="INT4",Ru[Ru.UINT=9]="UINT",Ru[Ru.UINT2=10]="UINT2",Ru[Ru.UINT3=11]="UINT3",Ru[Ru.UINT4=12]="UINT4",Ru[Ru.FLOAT=13]="FLOAT",Ru[Ru.FLOAT2=14]="FLOAT2",Ru[Ru.FLOAT3=15]="FLOAT3",Ru[Ru.FLOAT4=16]="FLOAT4",Ru[Ru.MAT2=17]="MAT2",Ru[Ru.MAT2X3=18]="MAT2X3",Ru[Ru.MAT2X4=19]="MAT2X4",Ru[Ru.MAT3X2=20]="MAT3X2",Ru[Ru.MAT3=21]="MAT3",Ru[Ru.MAT3X4=22]="MAT3X4",Ru[Ru.MAT4X2=23]="MAT4X2",Ru[Ru.MAT4X3=24]="MAT4X3",Ru[Ru.MAT4=25]="MAT4",Ru[Ru.SAMPLER1D=26]="SAMPLER1D",Ru[Ru.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",Ru[Ru.SAMPLER2D=28]="SAMPLER2D",Ru[Ru.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",Ru[Ru.SAMPLER3D=30]="SAMPLER3D",Ru[Ru.SAMPLER_CUBE=31]="SAMPLER_CUBE",Ru[Ru.COUNT=32]="COUNT",(Mu=Ou=Ou||q3("GFXFormat",{}))[Mu.UNKNOWN=0]="UNKNOWN",Mu[Mu.A8=1]="A8",Mu[Mu.L8=2]="L8",Mu[Mu.LA8=3]="LA8",Mu[Mu.R8=4]="R8",Mu[Mu.R8SN=5]="R8SN",Mu[Mu.R8UI=6]="R8UI",Mu[Mu.R8I=7]="R8I",Mu[Mu.R16F=8]="R16F",Mu[Mu.R16UI=9]="R16UI",Mu[Mu.R16I=10]="R16I",Mu[Mu.R32F=11]="R32F",Mu[Mu.R32UI=12]="R32UI",Mu[Mu.R32I=13]="R32I",Mu[Mu.RG8=14]="RG8",Mu[Mu.RG8SN=15]="RG8SN",Mu[Mu.RG8UI=16]="RG8UI",Mu[Mu.RG8I=17]="RG8I",Mu[Mu.RG16F=18]="RG16F",Mu[Mu.RG16UI=19]="RG16UI",Mu[Mu.RG16I=20]="RG16I",Mu[Mu.RG32F=21]="RG32F",Mu[Mu.RG32UI=22]="RG32UI",Mu[Mu.RG32I=23]="RG32I",Mu[Mu.RGB8=24]="RGB8",Mu[Mu.SRGB8=25]="SRGB8",Mu[Mu.RGB8SN=26]="RGB8SN",Mu[Mu.RGB8UI=27]="RGB8UI",Mu[Mu.RGB8I=28]="RGB8I",Mu[Mu.RGB16F=29]="RGB16F",Mu[Mu.RGB16UI=30]="RGB16UI",Mu[Mu.RGB16I=31]="RGB16I",Mu[Mu.RGB32F=32]="RGB32F",Mu[Mu.RGB32UI=33]="RGB32UI",Mu[Mu.RGB32I=34]="RGB32I",Mu[Mu.RGBA8=35]="RGBA8",Mu[Mu.SRGB8_A8=36]="SRGB8_A8",Mu[Mu.RGBA8SN=37]="RGBA8SN",Mu[Mu.RGBA8UI=38]="RGBA8UI",Mu[Mu.RGBA8I=39]="RGBA8I",Mu[Mu.RGBA16F=40]="RGBA16F",Mu[Mu.RGBA16UI=41]="RGBA16UI",Mu[Mu.RGBA16I=42]="RGBA16I",Mu[Mu.RGBA32F=43]="RGBA32F",Mu[Mu.RGBA32UI=44]="RGBA32UI",Mu[Mu.RGBA32I=45]="RGBA32I",Mu[Mu.R5G6B5=46]="R5G6B5",Mu[Mu.R11G11B10F=47]="R11G11B10F",Mu[Mu.RGB5A1=48]="RGB5A1",Mu[Mu.RGBA4=49]="RGBA4",Mu[Mu.RGB10A2=50]="RGB10A2",Mu[Mu.RGB10A2UI=51]="RGB10A2UI",Mu[Mu.RGB9E5=52]="RGB9E5",Mu[Mu.D16=53]="D16",Mu[Mu.D16S8=54]="D16S8",Mu[Mu.D24=55]="D24",Mu[Mu.D24S8=56]="D24S8",Mu[Mu.D32F=57]="D32F",Mu[Mu.D32F_S8=58]="D32F_S8",Mu[Mu.BC1=59]="BC1",Mu[Mu.BC1_ALPHA=60]="BC1_ALPHA",Mu[Mu.BC1_SRGB=61]="BC1_SRGB",Mu[Mu.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",Mu[Mu.BC2=63]="BC2",Mu[Mu.BC2_SRGB=64]="BC2_SRGB",Mu[Mu.BC3=65]="BC3",Mu[Mu.BC3_SRGB=66]="BC3_SRGB",Mu[Mu.BC4=67]="BC4",Mu[Mu.BC4_SNORM=68]="BC4_SNORM",Mu[Mu.BC5=69]="BC5",Mu[Mu.BC5_SNORM=70]="BC5_SNORM",Mu[Mu.BC6H_UF16=71]="BC6H_UF16",Mu[Mu.BC6H_SF16=72]="BC6H_SF16",Mu[Mu.BC7=73]="BC7",Mu[Mu.BC7_SRGB=74]="BC7_SRGB",Mu[Mu.ETC_RGB8=75]="ETC_RGB8",Mu[Mu.ETC2_RGB8=76]="ETC2_RGB8",Mu[Mu.ETC2_SRGB8=77]="ETC2_SRGB8",Mu[Mu.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",Mu[Mu.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",Mu[Mu.ETC2_RGBA8=80]="ETC2_RGBA8",Mu[Mu.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",Mu[Mu.EAC_R11=82]="EAC_R11",Mu[Mu.EAC_R11SN=83]="EAC_R11SN",Mu[Mu.EAC_RG11=84]="EAC_RG11",Mu[Mu.EAC_RG11SN=85]="EAC_RG11SN",Mu[Mu.PVRTC_RGB2=86]="PVRTC_RGB2",Mu[Mu.PVRTC_RGBA2=87]="PVRTC_RGBA2",Mu[Mu.PVRTC_RGB4=88]="PVRTC_RGB4",Mu[Mu.PVRTC_RGBA4=89]="PVRTC_RGBA4",Mu[Mu.PVRTC2_2BPP=90]="PVRTC2_2BPP",Mu[Mu.PVRTC2_4BPP=91]="PVRTC2_4BPP",(Lu=Iu=Iu||q3("GFXBufferUsageBit",{}))[Lu.NONE=0]="NONE",Lu[Lu.TRANSFER_SRC=1]="TRANSFER_SRC",Lu[Lu.TRANSFER_DST=2]="TRANSFER_DST",Lu[Lu.INDEX=4]="INDEX",Lu[Lu.VERTEX=8]="VERTEX",Lu[Lu.UNIFORM=16]="UNIFORM",Lu[Lu.STORAGE=32]="STORAGE",Lu[Lu.INDIRECT=64]="INDIRECT",(Bu=zu=zu||q3("GFXMemoryUsageBit",{}))[Bu.NONE=0]="NONE",Bu[Bu.DEVICE=1]="DEVICE",Bu[Bu.HOST=2]="HOST",(Du=Pu=Pu||q3("GFXBufferFlagBit",{}))[Du.NONE=0]="NONE",Du[Du.BAKUP_BUFFER=4]="BAKUP_BUFFER",(Nu=Fu=Fu||q3("GFXBufferAccessBit",{}))[Nu.NONE=0]="NONE",Nu[Nu.READ=1]="READ",Nu[Nu.WRITE=2]="WRITE",(Vu=Uu=Uu||q3("GFXPrimitiveMode",{}))[Vu.POINT_LIST=0]="POINT_LIST",Vu[Vu.LINE_LIST=1]="LINE_LIST",Vu[Vu.LINE_STRIP=2]="LINE_STRIP",Vu[Vu.LINE_LOOP=3]="LINE_LOOP",Vu[Vu.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",Vu[Vu.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",Vu[Vu.ISO_LINE_LIST=6]="ISO_LINE_LIST",Vu[Vu.TRIANGLE_LIST=7]="TRIANGLE_LIST",Vu[Vu.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",Vu[Vu.TRIANGLE_FAN=9]="TRIANGLE_FAN",Vu[Vu.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",Vu[Vu.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",Vu[Vu.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",Vu[Vu.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(Hu=Gu=Gu||q3("GFXPolygonMode",{}))[Hu.FILL=0]="FILL",Hu[Hu.POINT=1]="POINT",Hu[Hu.LINE=2]="LINE",(qu=Wu=Wu||q3("GFXShadeModel",{}))[qu.GOURAND=0]="GOURAND",qu[qu.FLAT=1]="FLAT",(Xu=ju=ju||q3("GFXCullMode",{}))[Xu.NONE=0]="NONE",Xu[Xu.FRONT=1]="FRONT",Xu[Xu.BACK=2]="BACK",(Ku=Yu=Yu||q3("GFXComparisonFunc",{}))[Ku.NEVER=0]="NEVER",Ku[Ku.LESS=1]="LESS",Ku[Ku.EQUAL=2]="EQUAL",Ku[Ku.LESS_EQUAL=3]="LESS_EQUAL",Ku[Ku.GREATER=4]="GREATER",Ku[Ku.NOT_EQUAL=5]="NOT_EQUAL",Ku[Ku.GREATER_EQUAL=6]="GREATER_EQUAL",Ku[Ku.ALWAYS=7]="ALWAYS",(Zu=Qu=Qu||q3("GFXStencilOp",{}))[Zu.ZERO=0]="ZERO",Zu[Zu.KEEP=1]="KEEP",Zu[Zu.REPLACE=2]="REPLACE",Zu[Zu.INCR=3]="INCR",Zu[Zu.DECR=4]="DECR",Zu[Zu.INVERT=5]="INVERT",Zu[Zu.INCR_WRAP=6]="INCR_WRAP",Zu[Zu.DECR_WRAP=7]="DECR_WRAP",($u=Ju=Ju||q3("GFXBlendOp",{}))[$u.ADD=0]="ADD",$u[$u.SUB=1]="SUB",$u[$u.REV_SUB=2]="REV_SUB",$u[$u.MIN=3]="MIN",$u[$u.MAX=4]="MAX",(tc=ec=ec||q3("GFXBlendFactor",{}))[tc.ZERO=0]="ZERO",tc[tc.ONE=1]="ONE",tc[tc.SRC_ALPHA=2]="SRC_ALPHA",tc[tc.DST_ALPHA=3]="DST_ALPHA",tc[tc.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",tc[tc.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",tc[tc.SRC_COLOR=6]="SRC_COLOR",tc[tc.DST_COLOR=7]="DST_COLOR",tc[tc.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",tc[tc.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",tc[tc.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",tc[tc.CONSTANT_COLOR=11]="CONSTANT_COLOR",tc[tc.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",tc[tc.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",tc[tc.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(nc=ic=ic||q3("GFXColorMask",{}))[nc.NONE=0]="NONE",nc[nc.R=1]="R",nc[nc.G=2]="G",nc[nc.B=4]="B",nc[nc.A=8]="A",nc[nc.ALL=15]="ALL",(ac=rc=rc||q3("GFXFilter",{}))[ac.NONE=0]="NONE",ac[ac.POINT=1]="POINT",ac[ac.LINEAR=2]="LINEAR",ac[ac.ANISOTROPIC=3]="ANISOTROPIC",(oc=sc=sc||q3("GFXAddress",{}))[oc.WRAP=0]="WRAP",oc[oc.MIRROR=1]="MIRROR",oc[oc.CLAMP=2]="CLAMP",oc[oc.BORDER=3]="BORDER",(uc=lc=lc||q3("GFXTextureType",{}))[uc.TEX1D=0]="TEX1D",uc[uc.TEX2D=1]="TEX2D",uc[uc.TEX3D=2]="TEX3D",(dc=hc=hc||q3("GFXTextureUsageBit",{}))[dc.NONE=0]="NONE",dc[dc.TRANSFER_SRC=1]="TRANSFER_SRC",dc[dc.TRANSFER_DST=2]="TRANSFER_DST",dc[dc.SAMPLED=4]="SAMPLED",dc[dc.STORAGE=8]="STORAGE",dc[dc.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",dc[dc.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",dc[dc.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",dc[dc.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT",(pc=fc=fc||q3("GFXSampleCount",{}))[pc.X1=0]="X1",pc[pc.X2=1]="X2",pc[pc.X4=2]="X4",pc[pc.X8=3]="X8",pc[pc.X16=4]="X16",pc[pc.X32=5]="X32",pc[pc.X64=6]="X64",(vc=_c=_c||q3("GFXTextureFlagBit",{}))[vc.NONE=0]="NONE",vc[vc.GEN_MIPMAP=1]="GEN_MIPMAP",vc[vc.CUBEMAP=2]="CUBEMAP",vc[vc.BAKUP_BUFFER=4]="BAKUP_BUFFER",(yc=mc=mc||q3("GFXTextureViewType",{}))[yc.TV1D=0]="TV1D",yc[yc.TV2D=1]="TV2D",yc[yc.TV3D=2]="TV3D",yc[yc.CUBE=3]="CUBE",yc[yc.TV1D_ARRAY=4]="TV1D_ARRAY",yc[yc.TV2D_ARRAY=5]="TV2D_ARRAY",(bc=gc=gc||q3("GFXShaderType",{}))[bc.VERTEX=0]="VERTEX",bc[bc.HULL=1]="HULL",bc[bc.DOMAIN=2]="DOMAIN",bc[bc.GEOMETRY=3]="GEOMETRY",bc[bc.FRAGMENT=4]="FRAGMENT",bc[bc.COMPUTE=5]="COMPUTE",bc[bc.COUNT=6]="COUNT",(Sc=xc=xc||q3("GFXBindingType",{}))[Sc.UNKNOWN=0]="UNKNOWN",Sc[Sc.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",Sc[Sc.SAMPLER=2]="SAMPLER",Sc[Sc.STORAGE_BUFFER=3]="STORAGE_BUFFER",(Tc=wc=wc||q3("GFXCommandBufferType",{}))[Tc.PRIMARY=0]="PRIMARY",Tc[Tc.SECONDARY=1]="SECONDARY",(Cc=Ec=Ec||q3("GFXLoadOp",{}))[Cc.LOAD=0]="LOAD",Cc[Cc.CLEAR=1]="CLEAR",Cc[Cc.DISCARD=2]="DISCARD",(kc=Ac=Ac||q3("GFXStoreOp",{}))[kc.STORE=0]="STORE",kc[kc.DISCARD=1]="DISCARD",(Oc=Rc=Rc||q3("GFXTextureLayout",{}))[Oc.UNDEFINED=0]="UNDEFINED",Oc[Oc.GENERAL=1]="GENERAL",Oc[Oc.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",Oc[Oc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",Oc[Oc.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",Oc[Oc.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",Oc[Oc.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",Oc[Oc.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",Oc[Oc.PREINITIALIZED=8]="PREINITIALIZED",Oc[Oc.PRESENT_SRC=9]="PRESENT_SRC",(Ic=Mc=Mc||q3("GFXPipelineBindPoint",{}))[Ic.GRAPHICS=0]="GRAPHICS",Ic[Ic.COMPUTE=1]="COMPUTE",Ic[Ic.RAY_TRACING=2]="RAY_TRACING",(zc=Lc=Lc||q3("GFXDynamicState",{}))[zc.VIEWPORT=0]="VIEWPORT",zc[zc.SCISSOR=1]="SCISSOR",zc[zc.LINE_WIDTH=2]="LINE_WIDTH",zc[zc.DEPTH_BIAS=3]="DEPTH_BIAS",zc[zc.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",zc[zc.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",zc[zc.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",zc[zc.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK",(Pc=Bc=Bc||q3("GFXStencilFace",{}))[Pc.FRONT=0]="FRONT",Pc[Pc.BACK=1]="BACK",Pc[Pc.ALL=2]="ALL",(Fc=Dc=Dc||q3("GFXQueueType",{}))[Fc.GRAPHICS=0]="GRAPHICS",Fc[Fc.COMPUTE=1]="COMPUTE",Fc[Fc.TRANSFER=2]="TRANSFER",(Uc=Nc=Nc||q3("GFXClearFlag",{}))[Uc.NONE=0]="NONE",Uc[Uc.COLOR=1]="COLOR",Uc[Uc.DEPTH=2]="DEPTH",Uc[Uc.STENCIL=4]="STENCIL",Uc[Uc.DEPTH_STENCIL=6]="DEPTH_STENCIL",Uc[Uc.ALL=7]="ALL";var Gc,Hc,Wc=q3("GFXTextureSubres",function e(){y(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1}),qc=q3("GFXTextureCopy",function e(){y(this,e),this.srcSubres=new Wc,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new Wc,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}}),jc=q3("GFXBufferTextureCopy",function e(){y(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new Wc});(Hc=Gc=Gc||q3("GFXFormatType",{}))[Hc.NONE=0]="NONE",Hc[Hc.UNORM=1]="UNORM",Hc[Hc.SNORM=2]="SNORM",Hc[Hc.UINT=3]="UINT",Hc[Hc.INT=4]="INT",Hc[Hc.UFLOAT=5]="UFLOAT",Hc[Hc.FLOAT=6]="FLOAT";var Xc=q3("GFXFormatInfos",[{name:"UNKNOWN",size:0,count:0,type:Gc.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:Gc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:Gc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:Gc.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:Gc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:Gc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:Gc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:Gc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:Gc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:Gc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:Gc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:Gc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:Gc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:Gc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:Gc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:Gc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:Gc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:Gc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:Gc.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:Gc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:Gc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:Gc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:Gc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}]);function Yc(e,t,i,n){if(!Xc[e].isCompressed)return t*i*n*Xc[e].size;switch(e){case Ou.BC1:case Ou.BC1_ALPHA:case Ou.BC1_SRGB:case Ou.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ou.BC2:case Ou.BC2_SRGB:case Ou.BC3:case Ou.BC3_SRGB:case Ou.BC4:case Ou.BC4_SNORM:case Ou.BC6H_SF16:case Ou.BC6H_UF16:case Ou.BC7:case Ou.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ou.BC5:case Ou.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case Ou.ETC_RGB8:case Ou.ETC2_RGB8:case Ou.ETC2_SRGB8:case Ou.ETC2_RGB8_A1:case Ou.ETC2_SRGB8_A1:case Ou.EAC_R11:case Ou.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ou.EAC_RG11:case Ou.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ou.PVRTC_RGB2:case Ou.PVRTC_RGBA2:case Ou.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case Ou.PVRTC_RGB4:case Ou.PVRTC_RGBA4:case Ou.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function Kc(e,t,i,n,r){for(var a=0,s=0;s<r;++s)a+=Yc(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a}var Qc=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Zc(e){return Qc[e]||0}var Jc,$c,eh,th,ih=Object.freeze({GFX_MAX_VERTEX_ATTRIBUTES:Su,GFX_MAX_TEXTURE_UNITS:wu,GFX_MAX_ATTACHMENTS:Tu,GFX_MAX_BUFFER_BINDINGS:Eu,get GFXObjectType(){return yu},get GFXStatus(){return bu},GFXObject:Vc,get GFXAttributeName(){return Cu},get GFXType(){return ku},get GFXFormat(){return Ou},get GFXBufferUsageBit(){return Iu},get GFXMemoryUsageBit(){return zu},get GFXBufferFlagBit(){return Pu},get GFXBufferAccessBit(){return Fu},get GFXPrimitiveMode(){return Uu},get GFXPolygonMode(){return Gu},get GFXShadeModel(){return Wu},get GFXCullMode(){return ju},get GFXComparisonFunc(){return Yu},get GFXStencilOp(){return Qu},get GFXBlendOp(){return Ju},get GFXBlendFactor(){return ec},get GFXColorMask(){return ic},get GFXFilter(){return rc},get GFXAddress(){return sc},get GFXTextureType(){return lc},get GFXTextureUsageBit(){return hc},get GFXSampleCount(){return fc},get GFXTextureFlagBit(){return _c},get GFXTextureViewType(){return mc},get GFXShaderType(){return gc},get GFXBindingType(){return xc},get GFXCommandBufferType(){return wc},get GFXLoadOp(){return Ec},get GFXStoreOp(){return Ac},get GFXTextureLayout(){return Rc},get GFXPipelineBindPoint(){return Mc},get GFXDynamicState(){return Lc},get GFXStencilFace(){return Bc},get GFXQueueType(){return Dc},get GFXClearFlag(){return Nc},GFXTextureSubres:Wc,GFXTextureCopy:qc,GFXBufferTextureCopy:jc,get GFXFormatType(){return Gc},GFXFormatInfos:Xc,GFXFormatSize:Yc,GFXFormatSurfaceSize:Kc,GFXGetTypeSize:Zc});mt(Ou),($c=Jc=Jc||{})[$c.UNKNOWN=0]="UNKNOWN",$c[$c.WEBGL=1]="WEBGL",$c[$c.WEBGL2=2]="WEBGL2",(th=eh=eh||{})[th.COLOR_FLOAT=0]="COLOR_FLOAT",th[th.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",th[th.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",th[th.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",th[th.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",th[th.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",th[th.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",th[th.FORMAT_D24S8=7]="FORMAT_D24S8",th[th.FORMAT_ETC1=8]="FORMAT_ETC1",th[th.FORMAT_ETC2=9]="FORMAT_ETC2",th[th.FORMAT_DXT=10]="FORMAT_DXT",th[th.FORMAT_PVRTC=11]="FORMAT_PVRTC",th[th.FORMAT_ASTC=12]="FORMAT_ASTC",th[th.MSAA=13]="MSAA",th[th.COUNT=14]="COUNT";var nh=q3("GFXDevice",function(){function e(){y(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=Jc.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(eh.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=Eu,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=Ou.UNKNOWN,this._depthStencilFmt=Ou.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return v(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}}]),e}()),rh={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},ah=q3("Layers",function(){function i(){y(this,i)}return v(i,null,[{key:"makeMaskInclude",value:function(e){var t=0,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t|=a}return t}},{key:"makeMaskExclude",value:function(e){return~i.makeMaskInclude(e)}},{key:"addLayer",value:function(e,t){void 0!==t?19<t||t<0?console.warn("maximum layers reached."):(i.Enum[e]=1<<t,i.Enum[t]=e,i.BitMask[e]=1<<t,i.BitMask[t]=e):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(e){19<e||e<0?console.warn("do not change buildin layers."):(delete i.Enum[i.Enum[e]],delete i.Enum[e],delete i.BitMask[i.BitMask[e]],delete i.BitMask[e])}}]),i}());ah.Enum=vt(rh),ah.BitMask=_t(Object.assign({},rh)),cc.Layers=ah;var sh,oh,lh,uh;(oh=sh=sh||q3("RenderPassStage",{}))[oh.DEFAULT=100]="DEFAULT",(uh=lh=lh||{})[uh.MIN=0]="MIN",uh[uh.MAX=255]="MAX",uh[uh.DEFAULT=128]="DEFAULT";var ch,hh;(hh=ch=ch||{})[hh.UBO_GLOBAL=23]="UBO_GLOBAL",hh[hh.UBO_SHADOW=22]="UBO_SHADOW",hh[hh.UBO_LOCAL=21]="UBO_LOCAL",hh[hh.UBO_LOCAL_BATCHED=20]="UBO_LOCAL_BATCHED",hh[hh.UBO_FORWARD_LIGHTS=19]="UBO_FORWARD_LIGHTS",hh[hh.UBO_SKINNING_ANIMATION=18]="UBO_SKINNING_ANIMATION",hh[hh.UBO_SKINNING_TEXTURE=17]="UBO_SKINNING_TEXTURE",hh[hh.UBO_UI=16]="UBO_UI",hh[hh.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",hh[hh.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",hh[hh.CUSTUM_UBO_BINDING_END_POINT=16]="CUSTUM_UBO_BINDING_END_POINT",hh[hh.CUSTOM_SAMPLER_BINDING_START_POINT=30]="CUSTOM_SAMPLER_BINDING_START_POINT";function dh(e){return e>=ch.CUSTUM_UBO_BINDING_END_POINT&&e<ch.CUSTOM_SAMPLER_BINDING_START_POINT}function fh(){y(this,fh),this.view=new Float32Array(fh.COUNT)}fh.SIZE=4*(fh.COUNT=(fh.AMBIENT_GROUND_OFFSET=(fh.AMBIENT_SKY_OFFSET=(fh.MAIN_LIT_COLOR_OFFSET=(fh.MAIN_LIT_DIR_OFFSET=(fh.EXPOSURE_OFFSET=(fh.CAMERA_POS_OFFSET=(fh.MAT_VIEW_PROJ_INV_OFFSET=(fh.MAT_VIEW_PROJ_OFFSET=(fh.MAT_PROJ_INV_OFFSET=(fh.MAT_PROJ_OFFSET=(fh.MAT_VIEW_INV_OFFSET=(fh.MAT_VIEW_OFFSET=(fh.NATIVE_SIZE_OFFSET=(fh.SCREEN_SCALE_OFFSET=(fh.SCREEN_SIZE_OFFSET=(fh.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),fh.BLOCK={binding:ch.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:ku.FLOAT4,count:1},{name:"cc_screenSize",type:ku.FLOAT4,count:1},{name:"cc_screenScale",type:ku.FLOAT4,count:1},{name:"cc_nativeSize",type:ku.FLOAT4,count:1},{name:"cc_matView",type:ku.MAT4,count:1},{name:"cc_matViewInv",type:ku.MAT4,count:1},{name:"cc_matProj",type:ku.MAT4,count:1},{name:"cc_matProjInv",type:ku.MAT4,count:1},{name:"cc_matViewProj",type:ku.MAT4,count:1},{name:"cc_matViewProjInv",type:ku.MAT4,count:1},{name:"cc_cameraPos",type:ku.FLOAT4,count:1},{name:"cc_exposure",type:ku.FLOAT4,count:1},{name:"cc_mainLitDir",type:ku.FLOAT4,count:1},{name:"cc_mainLitColor",type:ku.FLOAT4,count:1},{name:"cc_ambientSky",type:ku.FLOAT4,count:1},{name:"cc_ambientGround",type:ku.FLOAT4,count:1}]};function ph(){y(this,ph),this.view=new Float32Array(ph.COUNT)}ph.SIZE=4*(ph.COUNT=(ph.SHADOW_COLOR_OFFSET=(ph.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),ph.BLOCK={binding:ch.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:ku.MAT4,count:1},{name:"cc_shadowColor",type:ku.FLOAT4,count:1}]};function _h(){y(this,_h),this.view=new Float32Array(_h.COUNT)}var vh={binding:ch.SAMPLER_ENVIRONMENT,name:"cc_environment",type:ku.SAMPLER_CUBE,count:1},mh=new Map;_h.SIZE=4*(_h.COUNT=(_h.MAT_WORLD_IT_OFFSET=(_h.MAT_WORLD_OFFSET=0)+16)+16),_h.BLOCK={binding:ch.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:ku.MAT4,count:1},{name:"cc_matWorldIT",type:ku.MAT4,count:1}]},mh.set(_h.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:_h.BLOCK});function yh(){y(this,yh),this.view=new Float32Array(yh.COUNT)}yh.BATCHING_COUNT=10,yh.MAT_WORLDS_OFFSET=0,yh.SIZE=4*(yh.COUNT=16*yh.BATCHING_COUNT),yh.BLOCK={binding:ch.UBO_LOCAL_BATCHED,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:ku.MAT4,count:yh.BATCHING_COUNT}]},mh.set(yh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:yh.BLOCK});function gh(){y(this,gh),this.view=new Float32Array(gh.COUNT)}gh.MAX_SPHERE_LIGHTS=2,gh.MAX_SPOT_LIGHTS=2,gh.SIZE=4*(gh.COUNT=(gh.SPOT_LIGHT_COLOR_OFFSET=(gh.SPOT_LIGHT_DIR_OFFSET=(gh.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(gh.SPOT_LIGHT_POS_OFFSET=(gh.SPHERE_LIGHT_COLOR_OFFSET=(gh.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(gh.SPHERE_LIGHT_POS_OFFSET=0)+4*gh.MAX_SPHERE_LIGHTS)+4*gh.MAX_SPHERE_LIGHTS)+4*gh.MAX_SPOT_LIGHTS)+4*gh.MAX_SPOT_LIGHTS)+4*gh.MAX_SPOT_LIGHTS)+4*gh.MAX_SPOT_LIGHTS)+4*gh.MAX_SPOT_LIGHTS),gh.BLOCK={binding:ch.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:ku.FLOAT4,count:gh.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:ku.FLOAT4,count:gh.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:ku.FLOAT4,count:gh.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:ku.FLOAT4,count:gh.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:ku.FLOAT4,count:gh.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:ku.FLOAT4,count:gh.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:ku.FLOAT4,count:gh.MAX_SPOT_LIGHTS}]},mh.set(gh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:gh.BLOCK});function bh(){y(this,bh)}bh.SIZE=4*(bh.COUNT=(bh.JOINTS_TEXTURE_INFO_OFFSET=0)+4),bh.BLOCK={binding:ch.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureInfo",type:ku.FLOAT4,count:1}]},mh.set(bh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:bh.BLOCK});function xh(){y(this,xh)}xh.SIZE=4*(xh.COUNT=(xh.JOINTS_ANIM_INFO_OFFSET=0)+4),xh.BLOCK={binding:ch.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointsAnimInfo",type:ku.FLOAT4,count:1}]},mh.set(xh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:xh.BLOCK});var Sh={binding:ch.SAMPLER_JOINTS,name:"cc_jointsTexture",type:ku.SAMPLER2D,count:1};mh.set(Sh.name,{type:xc.SAMPLER,samplerInfo:Sh});function wh(e,t,i,n){return e<<28&Mh|i<<22&Ih|t<<14&4177920|16383&(3<arguments.length&&void 0!==n?n:0)}function Th(e){return(e&Ih)>>>22}function Eh(e,t){return e&~Ih|t<<22&Ih}var Ch,Ah,kh,Rh=ah.makeMaskExclude([ah.BitMask.UI_2D,ah.BitMask.GIZMOS,ah.BitMask.EDITOR,ah.BitMask.SCENE_GIZMO,ah.BitMask.PROFILER]),Oh=ah.makeMaskExclude([ah.BitMask.UI_2D,ah.BitMask.PROFILER]),Mh=(ah.Enum.ALL,4026531840),Ih=264241152,Lh=(s(Ch={},ku.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),s(Ch,ku.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),s(Ch,ku.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.fromArray(t,e,i)}),s(Ch,ku.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.fromArray(t,e,i)}),s(Ch,ku.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return ji.fromArray(t,e,i)}),s(Ch,ku.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),s(Ch,ku.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.fromArray(t,e,i)}),s(Ch,ku.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.fromArray(t,e,i)}),s(Ch,ku.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return ji.fromArray(t,e,i)}),s(Ch,ku.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return rn.fromArray(t,e,i)}),s(Ch,ku.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return zn.fromArray(t,e,i)}),Ch),zh=(s(Ah={},ku.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),s(Ah,ku.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(Ah,ku.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.toArray(e,t,i)}),s(Ah,ku.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.toArray(e,t,i)}),s(Ah,ku.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return ji.toArray(e,t,i)}),s(Ah,ku.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(Ah,ku.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Mi.toArray(e,t,i)}),s(Ah,ku.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Fi.toArray(e,t,i)}),s(Ah,ku.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return ji.toArray(e,t,i)}),s(Ah,ku.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return rn.toArray(e,t,i)}),s(Ah,ku.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return zn.toArray(e,t,i)}),Ah),Bh=(s(kh={},ku.INT,[0]),s(kh,ku.INT2,[0,0]),s(kh,ku.INT3,[0,0,0]),s(kh,ku.INT4,[0,0,0,0]),s(kh,ku.FLOAT,[0]),s(kh,ku.FLOAT2,[0,0]),s(kh,ku.FLOAT3,[0,0,0]),s(kh,ku.FLOAT4,[0,0,0,0]),s(kh,ku.MAT3,[1,0,0,0,1,0,0,0,1]),s(kh,ku.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),s(kh,ku.SAMPLER2D,"default-texture"),s(kh,ku.SAMPLER_CUBE,"default-cube-texture"),kh);function Ph(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Dh(e,t){switch(e.type){case"boolean":return t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function Fh(e,t,i){var n=e.builtins[i],r=e.blocks,a=n.blocks,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=t.get(u.name);if(c&&c.type===xc.UNIFORM_BUFFER){var h=Object.assign({defines:u.defines,size:Nh(c.blockInfo),bindingType:xc.UNIFORM_BUFFER},c.blockInfo);r.push(h)}else console.warn("builtin UBO '".concat(u.name,"' not available!"))}var d=e.samplers,f=n.samplers,p=Array.isArray(f),_=0;for(f=p?f:f[Symbol.iterator]();;){var v;if(p){if(_>=f.length)break;v=f[_++]}else{if((_=f.next()).done)break;v=_.value}var m=v,y=t.get(m.name);if(y&&y.type===xc.SAMPLER){var g=Object.assign({defines:m.defines,bindingType:xc.SAMPLER},y.samplerInfo);d.push(g)}else console.warn("builtin sampler '".concat(m.name,"' not available!"))}}function Nh(e){return e.members.reduce(function(e,t){return e+Zc(t.type)*t.count},0)}var Uh,Vh=new(function(){function e(){y(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return v(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=e,n=0,r=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var e=l,t=1;if("number"===e.type){var i=e.range;t=Ph(i[1]-i[0]+1),e._map=function(e){return e-i[0]}}else"string"===e.type?(t=Ph(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex(function(e){return e===t}))}):"boolean"===e.type&&(e._map=function(e){return e?1:0});e._offset=n,n+=t},a=i.defines,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===r())break}i.blocks.forEach(function(e){return e.size=Nh(e),e.bindingType=xc.UNIFORM_BUFFER}),i.samplers.forEach(function(e){return e.bindingType=xc.SAMPLER}),i.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,a=0,s=0;s<r.length;s++){var o=r[s];t[o.name]=wh(xc.UNIFORM_BUFFER,n.binding,o.type,a),a+=(Zc(o.type)>>2)*o.count}for(var l=0;l<e.samplers.length;l++){var u=e.samplers[l];t[u.name]=wh(xc.SAMPLER,u.binding,u.type)}return t}(i),i.localsInited||(Fh(i,mh,"locals"),i.localsInited=!0),this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=0,r=i.defines,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u=t[l.name];if(void 0!==u&&l._map)n|=l._map(u)<<l._offset}return"".concat(n.toString(16),"|").concat(i.hash)}},{key:"destroyShaderByDefines",value:function(i){var n=this,e=Object.keys(i);if(e.length){var r=e.map(function(e){var t=i[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(e+t)}),t=Object.keys(this._cache).filter(function(t){return r.every(function(e){return e.test(n._cache[t].name)})}),a=Array.isArray(t),s=0;for(t=a?t:t[Symbol.iterator]();;){var o;if(a){if(s>=t.length)break;o=t[s++]}else{if((s=t.next()).done)break;o=s.value}var l=o;console.log("destroyed shader ".concat(this._cache[l].name)),this._cache[l].destroy(),delete this._cache[l]}}}},{key:"getGFXShader",value:function(e,t,i,n){Object.assign(i,n.macros);var r=this.getKey(t,i),a=this._cache[r];if(void 0!==a)return a;var s=this._templates[t];s.globalsInited||(Fh(s,n.globalBindings,"globals"),s.globalsInited=!0);var o=function(e,t){var i=[],n=t,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name,u=e[l],c=Dh(o,u),h=!u||"0"===u;i.push({name:l,value:c,isDefault:h})}return i}(i,s.defines),l=o.reduce(function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")},""),u="",c="";return c=e.gfxAPI===Jc.WEBGL2?(u="#version 300 es\n".concat(l,"\n").concat(s.glsl3.vert),"#version 300 es\n".concat(l,"\n").concat(s.glsl3.frag)):(u="#version 100\n".concat(l,"\n").concat(s.glsl1.vert),"#version 100\n".concat(l,"\n").concat(s.glsl1.frag)),a=e.createShader({name:function(e,t){return e+t.reduce(function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)},"")}(t,o),blocks:s.blocks,samplers:s.samplers,stages:[{type:gc.VERTEX,source:u},{type:gc.FRAGMENT,source:c}]}),this._cache[r]=a}}]),e}());function Gh(i,e){e.forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){"constructor"!==e&&Object.defineProperty(i.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})})}cc.programLib=Vh;var Hh,Wh,qh,jh,Xh,Yh,Kh,Qh=q3("RawAsset",oo("cc.RawAsset")(Uh=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._uuid=void 0,Object.defineProperty(l(t),"_uuid",{value:"",writable:!0}),t}return p(a,Ho),v(a,null,[{key:"isRawAssetType",value:function(e){return Ge(e,cc.RawAsset)&&!Ge(e,cc.Asset)}}]),a}())||Uh);cc.RawAsset=Qh;var Zh,Jh,$h,ed,td,id,nd,rd=q3("Asset",(Hh=oo("cc.Asset"),Wh=lo({visible:!1}),Hh((Kh=Yh=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).loaded=!0,m(t,"_native",Xh,l(t)),t._file=null,t._callbackTable=ke(!0),t}return p(a,Qh),v(a,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),v(a,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e,t){var i=!(1<arguments.length&&void 0!==t)||t;this._native=!1!==i?e||"":"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}]),a}(),Yh.preventDeferredLoadDependents=!1,Yh.preventPreloadNativeObject=!1,Xh=b((jh=Kh).prototype,"_native",[To],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),b(jh.prototype,"nativeUrl",[Wh],Object.getOwnPropertyDescriptor(jh.prototype,"nativeUrl"),jh.prototype),b(jh.prototype,"_nativeAsset",[lo],Object.getOwnPropertyDescriptor(jh.prototype,"_nativeAsset"),jh.prototype),qh=jh))||qh));Gh(rd,[Rl,Ml]),rd.prototype.createNode=null,cc.Asset=rd;var ad,sd,od,ld,ud,cd,hd,dd,fd,pd,_d,vd,md,yd,gd={},bd=q3("EffectAsset",oo("cc.EffectAsset")((nd=id=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"techniques",$h,l(t)),m(t,"shaders",ed,l(t)),m(t,"combinations",td,l(t)),t}return p(a,rd),v(a,[{key:"onLoaded",value:function(){this.shaders.forEach(function(e){return Vh.define(e)}),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),a.register(this)}},{key:"_precompile",value:function(){for(var i=this,n=cc.director.root,e=function(e){var t=i.shaders[e],a=i.combinations[e];if(!a)return"continue";Object.keys(a).reduce(function(e,r){return e.reduce(function(e,t){var i=a[r],n=[t].concat(u(Array(i.length-1)).map(function(){return Object.assign({},t)}));return n.forEach(function(e,t){return e[r]=i[t]}),e.concat(n)},[])},[{}]).forEach(function(e){return Vh.getGFXShader(n.device,t.name,e,n.pipeline)})},t=0;t<this.shaders.length;t++)e(t)}}],[{key:"register",value:function(e){gd[e.name]=e}},{key:"remove",value:function(e){if(gd[e])delete gd[e];else for(var t in gd)if(gd[t]._uuid===e)return void delete gd[t]}},{key:"get",value:function(e){if(gd[e])return gd[e];for(var t in gd)if(gd[t]._uuid===e)return gd[t];return null}},{key:"getAll",value:function(){return gd}}]),a}(),id._effects={},$h=b((Jh=nd).prototype,"techniques",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ed=b(Jh.prototype,"shaders",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),td=b(Jh.prototype,"combinations",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zh=Jh))||Zh);function xd(e,t){for(var i=e.length,n=t^i,r=0;4<=i;){var a=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}cc.EffectAsset=bd,(sd=ad=ad||{})[sd.RGB565=Ou.R5G6B5]="RGB565",sd[sd.RGB5A1=Ou.RGB5A1]="RGB5A1",sd[sd.RGBA4444=Ou.RGBA4]="RGBA4444",sd[sd.RGB888=Ou.RGB8]="RGB888",sd[sd.RGBA8888=Ou.RGBA8]="RGBA8888",sd[sd.RGBA32F=Ou.RGBA32F]="RGBA32F",sd[sd.A8=Ou.A8]="A8",sd[sd.I8=Ou.L8]="I8",sd[sd.AI8=Ou.LA8]="AI8",sd[sd.RGB_PVRTC_2BPPV1=Ou.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",sd[sd.RGBA_PVRTC_2BPPV1=Ou.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",sd[sd.RGB_PVRTC_4BPPV1=Ou.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",sd[sd.RGBA_PVRTC_4BPPV1=Ou.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",sd[sd.RGB_ETC1=Ou.ETC_RGB8]="RGB_ETC1",sd[sd.RGB_ETC2=Ou.ETC2_RGB8]="RGB_ETC2",sd[sd.RGBA_ETC2=Ou.ETC2_RGBA8]="RGBA_ETC2",(ld=od=od||{})[ld.REPEAT=sc.WRAP]="REPEAT",ld[ld.CLAMP_TO_EDGE=sc.CLAMP]="CLAMP_TO_EDGE",ld[ld.MIRRORED_REPEAT=sc.MIRROR]="MIRRORED_REPEAT",ld[ld.CLAMP_TO_BORDER=sc.BORDER]="CLAMP_TO_BORDER",(cd=ud=ud||{})[cd.NONE=rc.NONE]="NONE",cd[cd.LINEAR=rc.LINEAR]="LINEAR",cd[cd.NEAREST=rc.POINT]="NEAREST",(dd=hd=hd||{})[dd.NONE=Ou.UNKNOWN]="NONE",dd[dd.DEPTH_16=Ou.D16]="DEPTH_16",dd[dd.DEPTH_24=Ou.D24]="DEPTH_24",dd[dd.DEPTH_32=Ou.D32F]="DEPTH_32",dd[dd.DEPTH_16_STENCIL_8=Ou.D16S8]="DEPTH_16_STENCIL_8",dd[dd.DEPTH_24_STENCIL_8=Ou.D24S8]="DEPTH_24_STENCIL_8",dd[dd.DEPTH_32_STENCIL_8=Ou.D32F_S8]="DEPTH_32_STENCIL_8";var Sd,wd,Td=q3("ImageAsset",(fd=oo("cc.ImageAsset"),pd=lo({override:!0}),fd((yd=md=function(){function b(e){var t;return y(this,b),(t=x(this,g(b).call(this)))._nativeData=void 0,t._tex=void 0,t._url=void 0,t._exportedExts=void 0,t._format=ad.RGBA8888,t._width=0,t._height=0,t._url="",t.loaded=!1,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&(t._nativeAsset=e),t}return p(b,rd),v(b,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){var e=this._nativeData._data;return ArrayBuffer.isView(e)||e instanceof ArrayBuffer?e:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=ad.RGB_ETC1&&this._format<=ad.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new cc.Texture2D;e.name=this._url,(e.image=this)._tex=e}return this._tex}}]),v(b,[{key:"reset",value:function(e){e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._nativeData.format=this._format),this._onDataComplete()}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var t=[],i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.split("@"),l=b.extnames.indexOf(o[0]),u=l<0?s:"".concat(l);o[1]&&(u+="@"+o[1]),t.push(u)}return{fmt:t.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,t){var i="";i="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt);var n=cc.director.root?cc.director.root.device:null,r=i.split("_"),a=Number.MAX_VALUE,s=this._format,o="",l=cc.macro.SUPPORT_TEXTURE_FORMATS,u=r,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var d;if(c){if(h>=u.length)break;d=u[h++]}else{if((h=u.next()).done)break;d=h.value}var f=d.split("@"),p=parseInt(f[0],void 0),_=b.extnames[p]||f.join(),v=l.indexOf(_);if(-1!==v&&v<a){var m=f[1]?parseInt(f[1]):this._format;if(!(".pvr"!==_||n&&n.hasFeature(eh.FORMAT_PVRTC)))continue;if(!(m!==ad.RGB_ETC1||n&&n.hasFeature(eh.FORMAT_ETC1)))continue;if(!(m!==ad.RGB_ETC2&&m!==ad.RGBA_ETC2||n&&n.hasFeature(eh.FORMAT_ETC2)))continue;if(".webp"===_&&!cc.sys.capabilities.webp)continue;a=v,o=_,s=m}}o&&(this._setRawAsset(o),this._format=s);var y=t.customEnv,g=y&&y.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),b}(),md.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],b((vd=yd).prototype,"_nativeAsset",[pd],Object.getOwnPropertyDescriptor(vd.prototype,"_nativeAsset"),vd.prototype),_d=vd))||_d));cc.ImageAsset=Td,(wd=Sd=Sd||{})[wd.minFilter=0]="minFilter",wd[wd.magFilter=1]="magFilter",wd[wd.mipFilter=2]="mipFilter",wd[wd.addressU=3]="addressU",wd[wd.addressV=4]="addressV",wd[wd.addressW=5]="addressW",wd[wd.maxAnisotropy=6]="maxAnisotropy",wd[wd.cmpFunc=7]="cmpFunc",wd[wd.minLOD=8]="minLOD",wd[wd.maxLOD=9]="maxLOD",wd[wd.mipLODBias=10]="mipLODBias",wd[wd.borderColor=11]="borderColor",wd[wd.total=15]="total";var Ed=[rc.LINEAR,rc.LINEAR,rc.NONE,sc.WRAP,sc.WRAP,sc.WRAP,8,Yu.NEVER,0,0,0,0,0,0,0],Cd=kd(Ed),Ad={};function kd(e){for(var t=0,i=0,n=0;n<Ed.length;n++)switch(t=e[n]||Ed[n],n){case Sd.minFilter:i|=t;break;case Sd.magFilter:i|=t<<2;break;case Sd.mipFilter:i|=t<<4;break;case Sd.addressU:i|=t<<6;break;case Sd.addressV:i|=t<<8;break;case Sd.addressW:i|=t<<10;break;case Sd.maxAnisotropy:i|=t<<12;break;case Sd.cmpFunc:i|=t<<16;break;case Sd.minLOD:i|=t<<20;break;case Sd.maxLOD:i|=t<<24;break;case Sd.mipLODBias:i|=t<<28}return i}var Rd,Od,Md,Id,Ld,zd,Bd,Pd,Dd,Fd,Nd,Ud,Vd,Gd,Hd,Wd,qd,jd,Xd,Yd=new(function(){function e(){y(this,e),this._cache={}}return v(e,[{key:"getSampler",value:function(e,t){0===t&&(t=Cd);var i=this._cache[t];return i||(Ad.minFilter=3&t,Ad.magFilter=t>>2&3,Ad.mipFilter=t>>4&3,Ad.addressU=t>>6&3,Ad.addressV=t>>8&3,Ad.addressW=t>>10&3,Ad.maxAnisotropy=t>>12&15,Ad.cmpFunc=t>>16&15,Ad.minLOD=t>>20&15,Ad.maxLOD=t>>24&15,Ad.mipLODBias=t>>28&15,Ad.borderColor={r:0,g:0,b:0,a:0},this._cache[t]=e.createSampler(Ad))}}]),e}()),Kd=new ve("Tex"),Qd=oo("cc.TextureBase")((Gd=Vd=function(){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return y(this,i),m(e=x(this,g(i).call(this)),"_format",Md,l(e)),m(e,"_premultiplyAlpha",Id,l(e)),m(e,"_flipY",Ld,l(e)),m(e,"_minFilter",zd,l(e)),m(e,"_magFilter",Bd,l(e)),m(e,"_mipFilter",Pd,l(e)),m(e,"_wrapS",Dd,l(e)),m(e,"_wrapT",Fd,l(e)),m(e,"_wrapR",Nd,l(e)),m(e,"_anisotropy",Ud,l(e)),e._width=0,e._height=0,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._flipY=t,e._id=Kd.getNewId(),e.loaded=!1,e}return p(i,rd),v(i,[{key:"isCompressed",get:function(){return this._format>=ad.RGB_ETC1&&this._format<=ad.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),v(i,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Sd.addressU]=e,this._wrapT=t,this._samplerInfo[Sd.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Sd.addressW]=i),this._samplerHash=kd(this._samplerInfo)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Sd.minFilter]=e,this._magFilter=t,this._samplerInfo[Sd.magFilter]=t,this._samplerHash=kd(this._samplerInfo)}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Sd.mipFilter]=e,this._samplerInfo[Sd.maxLOD]=e===ud.NONE?0:15,this._samplerHash=kd(this._samplerInfo)}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Sd.maxAnisotropy]=e,this._samplerHash=kd(this._samplerInfo)}},{key:"destroy",value:function(){return _(g(i.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),6<=i.length&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),8<=i.length&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),9<=i.length&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?ad.RGBA8888:e}}]),i}(),Vd.PixelFormat=ad,Vd.WrapMode=od,Vd.Filter=ud,Md=b((Od=Gd).prototype,"_format",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ad.RGBA8888}}),Id=b(Od.prototype,"_premultiplyAlpha",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ld=b(Od.prototype,"_flipY",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zd=b(Od.prototype,"_minFilter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ud.LINEAR}}),Bd=b(Od.prototype,"_magFilter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ud.LINEAR}}),Pd=b(Od.prototype,"_mipFilter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ud.NONE}}),Dd=b(Od.prototype,"_wrapS",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return od.REPEAT}}),Fd=b(Od.prototype,"_wrapT",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return od.REPEAT}}),Nd=b(Od.prototype,"_wrapR",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return od.REPEAT}}),Ud=b(Od.prototype,"_anisotropy",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),Rd=Od))||Rd;cc.TextureBase=Qd,mt(hd);var Zd,Jd=q3("RenderTexture",oo("cc.RenderTexture")((Xd=jd=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._window=null,m(t,"_depthStencilFormat",qd,l(t)),t}return p(a,Qd),v(a,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,e.colorFormat&&(this._format=e.colorFormat),e.depthStencilFormat&&(this._depthStencilFormat=e.depthStencilFormat),this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),_(g(a.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow(),this.loaded=!0,this.emit("load")}},{key:"_serialize",value:function(e){return{base:_(g(a.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,t){_(g(a.prototype),"_deserialize",this).call(this,e.base,t);var i=e;this.name=i.name||"",this._width=i.width,this._height=i.height,this._format=i.colorFormat,this._depthStencilFormat=i.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),a}(),jd.DepthStencilFormat=hd,qd=b((Wd=Xd).prototype,"_depthStencilFormat",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hd.NONE}}),b(Wd.prototype,"width",[lo],Object.getOwnPropertyDescriptor(Wd.prototype,"width"),Wd.prototype),b(Wd.prototype,"height",[lo],Object.getOwnPropertyDescriptor(Wd.prototype,"height"),Wd.prototype),b(Wd.prototype,"depthStencilFormat",[lo],Object.getOwnPropertyDescriptor(Wd.prototype,"depthStencilFormat"),Wd.prototype),Hd=Wd))||Hd);cc.RenderTexture=Jd;var $d=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}];function ef(e){return e&&0==(e&e-1)}var tf,nf,rf,af,sf,of=oo("cc.SimpleTexture")(Zd=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t}return p(a,Qd),v(a,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),_(g(a.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:0,r=2<arguments.length&&void 0!==i?i:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=n)){var a=this._getGFXDevice();if(a){var s=$d[0];s.texExtent.width=this._gfxTexture.width>>n,s.texExtent.height=this._gfxTexture.height>>n,s.texSubres.baseMipLevel=n,s.texSubres.baseArrayLayer=r,e instanceof ArrayBuffer?a.copyBuffersToTexture([e],this._gfxTexture,$d):a.copyTexImagesToTexture([e],this._gfxTexture,$d)}}}},{key:"_assignImage",value:function(i,n,r){function e(){var e,t=i.data;t&&(e=ArrayBuffer.isView(t)?t.buffer:t,a.uploadData(e,n,r),a._checkTextureLoaded())}var a=this;if(i.loaded)e();else{if(i.once("load",function(){e()}),!this.isCompressed){var t=cc.builtinResMgr.get("black-texture").image;this.uploadData(t.data,n,r)}cc.textureUtil.postLoadImage(i)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=_c.NONE;this._mipFilter!==ud.NONE&&ef(this._width)&&ef(this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=_c.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:hc.SAMPLED|hc.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i),r=this._getGfxTextureViewCreateInfo({texture:n,format:this._getGFXFormat()});if(r){var a=e.createTextureView(r);a?(this._gfxTexture=n,this._gfxTextureView=a):n.destroy()}else n.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),a}())||Zd;cc.SimpleTexture=of;var lf,uf=q3("Texture2D",(tf=oo("cc.Texture2D"),nf=lo([Td]),tf((sf=b((af=function(){function a(){var e;return y(this,a),m(e=x(this,g(a).call(this,!0)),"_mipmaps",sf,l(e)),e}return p(a,of),v(a,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),v(a,[{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:ad.RGBA8888,a=3<arguments.length&&void 0!==n?n:1;this.reset({width:e,height:t,format:r,mipmapLevel:a})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:0,n=1<arguments.length?t:void 0;if(!(i>=this._mipmaps.length))for(var r=Math.min(void 0===n?this._mipmaps.length:n,this._mipmaps.length-i),a=0;a<r;++a){var s=i+a;this._assignImage(this._mipmaps[s],s)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],_(g(a.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(t){return{base:_(g(a.prototype),"_serialize",this).call(this,t),mipmaps:this._mipmaps.map(function(e){return e&&e._uuid?t?Editor.Utils.UuidUtils.compressUuid(e._uuid,!0):e._uuid:null})}}},{key:"_deserialize",value:function(e,t){var i=e;_(g(a.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n)if(this._mipmaps[n]=new Td,i.mipmaps[n]){var r=i.mipmaps[n];t.result.push(this._mipmaps,"".concat(n),r),this._mipmaps[n]._texture=this}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:lc.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:mc.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,t=0;t<this._mipmaps.length;++t){if(!this._mipmaps[t].loaded){e=!1;break}}e&&_(g(a.prototype),"_textureReady",this).call(this)}}]),a}()).prototype,"_mipmaps",[nf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rf=af))||rf));cc.Texture2D=uf;var cf,hf,df,ff,pf,_f,vf,mf=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],yf=q3("SpriteFrame",oo("cc.SpriteFrame")(lf=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e._image=null,e.uvSliced=[],e._rect=new Zn,e._offset=new Mi,e._originalSize=new qn,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return p(t,rd),v(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]=e,this._calculateSlicedUV()}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]=e,this._calculateSlicedUV()}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]=e,this._calculateSlicedUV()}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]=e,this._calculateSlicedUV()}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.set(e),this._calculateUV()}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.set(e),this._calculateUV()}},{key:"_imageSource",set:function(e){this._image=e,window.Editor&&Editor.isBuilder||(this._texture=e._texture,this._texture.on("load",this._textureLoaded,this),this._calculateUV())}},{key:"texture",get:function(){return this._texture||(this._texture=!this._image||window.Editor&&Editor.isBuilder?new uf:this._image._texture,this._texture.on("load",this._textureLoaded,this)),this._texture},set:function(e){e?(this.reset({texture:e},!0),this._texture instanceof Jd&&this.onLoaded()):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}}]),v(t,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this._rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this._rect.set(e)}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this._originalSize.set(e)}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this._offset.set(e)}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"reset",value:function(e,t){var i=!1;1<arguments.length&&void 0!==t&&t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],i=!(this._rotated=!1)),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._texture&&this._texture.off("load"),this._texture=e.texture,this.checkRect(this._texture),this._texture.on("load",this._textureLoaded,this)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),this._texture instanceof Jd&&(this._flipUv=!0),i=!0),i&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(cc.errorID(3301,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return this._texture&&this._texture.off("load"),_(g(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],a=this._capInsets[2],s=e.width-r-a,o=this._capInsets[1],l=this._capInsets[3],u=e.height-o-l,c=this.uvSliced;if(c.length=0,this._rotated){mf[0].u=(e.x+e.height)/i,mf[1].u=(e.x+o+u)/i,mf[2].u=(e.x+o)/i,mf[3].u=e.x/i,mf[3].v=(e.y+e.width)/n,mf[2].v=(e.y+r+s)/n,mf[1].v=(e.y+r)/n,mf[0].v=e.y/n;for(var h=0;h<4;++h)for(var d=mf[h],f=0;f<4;++f){var p=mf[3-f];c.push({u:d.u,v:p.v})}}else{mf[0].u=e.x/i,mf[1].u=(e.x+r)/i,mf[2].u=(e.x+r+s)/i,mf[3].u=(e.x+e.width)/i,mf[3].v=e.y/n,mf[2].v=(e.y+o)/n,mf[1].v=(e.y+o+u)/n,mf[0].v=(e.y+e.height)/n;for(var _=0;_<4;++_)for(var v=mf[_],m=0;m<4;++m){var y=mf[m];c.push({u:y.u,v:v.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,n=i.width,r=i.height;if(this._rotated){var a=0===n?0:e.x/n,s=0===n?0:(e.x+e.height)/n,o=0===r?0:e.y/r,l=0===r?0:(e.y+e.width)/r;this._flipUv?(t[0]=a,t[1]=o,t[2]=a,t[3]=l,t[4]=s,t[5]=o,t[6]=s,t[7]=l):(t[0]=s,t[1]=l,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=a,t[7]=o)}else{var u=0===n?0:e.x/n,c=0===n?0:(e.x+e.width)/n,h=0===r?0:(e.y+e.height)/r,d=0===r?0:e.y/r;this._flipUv?(t[0]=u,t[1]=d,t[2]=c,t[3]=d,t[4]=u,t[5]=h,t[6]=c,t[7]=h):(t[0]=u,t[1]=h,t[2]=c,t[3]=h,t[4]=u,t[5]=d,t[6]=c,t[7]=d)}for(var f="",p=0;p<t.length;p++)f+=t[p];this.uvHash=xd(f,666);var _=this.vertices;if(_){_.nu.length=0;for(var v=_.nv.length=0;v<_.u.length;v++)_.nu[v]=_.u[v]/n,_.nv[v]=_.v[v]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,n=this._offset,r=this._originalSize,a=this._uuid;return a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{image:this._image?e?Editor.Utils.UuidUtils.compressUuid(this._image._uuid,!0):this._image._uuid:void 0,name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:n,originalSize:r,rotated:this._rotated,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&this.setRect(new Zn(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&this.setOffset(new Mi(r.x,r.y));var a=i.originalSize;i.originalSize&&this.setOriginalSize(new qn(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var s=i.capInsets;s&&(this._capInsets[0]=s[0],this._capInsets[1]=s[1],this._capInsets[2]=s[2],this._capInsets[3]=s[3]),t.result.push(this,"_imageSource",i.image),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Zn(0,0,e.width,e.height),i=!0),0!==this._originalSize.width&&0!==this._originalSize.height&&!i||(t.originalSize=new qn(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}}]),t}())||lf);cc.SpriteFrame=yf,(vf=_f=_f||{})[vf.right=0]="right",vf[vf.left=1]="left",vf[vf.top=2]="top",vf[vf.bottom=3]="bottom",vf[vf.front=4]="front",vf[vf.back=5]="back";var gf,bf,xf=q3("TextureCube",oo("cc.TextureCube")((pf=ff=function(){function s(){var e;return y(this,s),m(e=x(this,g(s).call(this)),"_mipmaps",df,l(e)),e}return p(s,of),v(s,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var n=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){Sf(e,function(e,t){n._assignImage(e,i,t)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],n=e.length/6,r=0;r<n;r++){var a=6*r;i.push({front:e[a+_f.front].image,back:e[a+_f.back].image,left:e[a+_f.left].image,right:e[a+_f.right].image,top:e[a+_f.top].image,bottom:e[a+_f.bottom].image})}return(t=t||new s).mipmaps=i,t}}]),v(s,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(e,t){var n=this,r=0<arguments.length&&void 0!==e?e:0,i=1<arguments.length?t:void 0;if(!(r>=this._mipmaps.length))for(var a=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-r),s=function(e){var i=r+e;Sf(n._mipmaps[i],function(e,t){n._assignImage(e,i,t)})},o=0;o<a;++o)s(o)}},{key:"destroy",value:function(){return this._mipmaps=[],_(g(s.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:_(g(s.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map(function(e){return t?{front:Editor.Utils.UuidUtils.compressUuid(e.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(e.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(e.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(e.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(e.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(e.bottom._uuid,!0)}:{front:e.front._uuid,back:e.back._uuid,left:e.left._uuid,right:e.right._uuid,top:e.top._uuid,bottom:e.bottom._uuid}})}}},{key:"_deserialize",value:function(e,t){var i=e;_(g(s.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]={front:new Td,back:new Td,left:new Td,right:new Td,top:new Td,bottom:new Td};var r=i.mipmaps[n];t.result.push(this._mipmaps[n],"front",r.front),t.result.push(this._mipmaps[n],"back",r.back),t.result.push(this._mipmaps[n],"left",r.left),t.result.push(this._mipmaps[n],"right",r.right),t.result.push(this._mipmaps[n],"top",r.top),t.result.push(this._mipmaps[n],"bottom",r.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:lc.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|_c.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:mc.CUBE,layerCount:6},e)}}]),s}(),ff.FaceIndex=_f,df=b((hf=pf).prototype,"_mipmaps",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cf=hf))||cf);function Sf(e,t){t(e.front,_f.front),t(e.back,_f.back),t(e.left,_f.left),t(e.right,_f.right),t(e.top,_f.top),t(e.bottom,_f.bottom)}cc.TextureCube=xf,(bf=gf=gf||q3("SystemEventType",{})).TOUCH_START="touch-start",bf.TOUCH_MOVE="touch-move",bf.TOUCH_END="touch-end",bf.TOUCH_CANCEL="touch-cancel",bf.MOUSE_DOWN="mouse-down",bf.MOUSE_MOVE="mouse-move",bf.MOUSE_UP="mouse-up",bf.MOUSE_WHEEL="mouse-wheel",bf.MOUSE_ENTER="mouse-enter",bf.MOUSE_LEAVE="mouse-leave",bf.KEY_DOWN="keydown",bf.KEY_UP="keyup",bf.DEVICEMOTION="devicemotion",bf.TRANSFORM_CHANGED="transform-changed",bf.POSITION_PART="position-part",bf.ROTATION_PART="rotation-part",bf.SCALE_PART="scale-part",bf.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",bf.SIZE_CHANGED="size-changed",bf.ANCHOR_CHANGED="anchor-changed",bf.CHILD_ADDED="child-added",bf.CHILD_REMOVED="child-removed",bf.PARENT_CHANGED="parent-changed",mt(gf),cc.SystemEventType=gf;var wf=q3("EventMouse",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,Sl.MOUSE,t))).movementX=0,i.movementY=0,i._eventType=void 0,i._button=0,i._x=0,i._y=0,i._prevX=0,i._prevY=0,i._scrollX=0,i._scrollY=0,i._eventType=e,i}return p(n,Sl),v(n,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e=e||new Mi,Mi.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e=e||new Mi,Mi.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e=e||new Mi,Mi.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e=e||new Mi,Mi.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e=e||new Mi,Mi.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e=e||new Mi,Mi.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e=e||new Mi,Mi.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),n}());wf.NONE=0,wf.DOWN=1,wf.UP=2,wf.MOVE=3,wf.SCROLL=4,wf.BUTTON_LEFT=0,wf.BUTTON_RIGHT=2,wf.BUTTON_MIDDLE=1,wf.BUTTON_4=3,wf.BUTTON_5=4,wf.BUTTON_6=5,wf.BUTTON_7=6,wf.BUTTON_8=7;var Tf=q3("EventTouch",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,Sl.TOUCH,t))).touch=null,i._eventCode=0,i.simulate=!1,i._touches=void 0,i._eventCode=0,i._touches=e||[],i}return p(n,Sl),v(n,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Mi}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Mi}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Mi}},{key:"getUILocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Mi}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Mi}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Mi}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Mi}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Mi}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Mi}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),n}());Tf.MAX_TOUCHES=5,Tf.BEGAN=0,Tf.MOVED=1,Tf.ENDED=2,Tf.CANCELLED=3;var Ef=q3("EventAcceleration",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,Sl.ACCELERATION,t))).acc=void 0,i.acc=e,i}return p(n,Sl),n}()),Cf=q3("EventKeyboard",function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,Sl.KEYBOARD,i))).keyCode=void 0,n.rawEvent=void 0,n.isPressed=void 0,"number"==typeof e?n.keyCode=e:(n.keyCode=e.keyCode,n.rawEvent=e),n.isPressed=t,n}return p(r,Sl),r}());Sl.EventMouse=wf,Sl.EventTouch=Tf,Sl.EventAcceleration=Ef,Sl.EventKeyboard=Cf;var Af=function(){function n(e,t,i){y(this,n),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}return v(n,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new Of:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new Mf:t===cc.EventListener.MOUSE?i=new Rf:t===cc.EventListener.KEYBOARD?i=new Lf:t===cc.EventListener.ACCELERATION&&(i=new If(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),v(n,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),n}();Af.UNKNOWN=0,Af.TOUCH_ONE_BY_ONE=1,Af.TOUCH_ALL_AT_ONCE=2,Af.KEYBOARD=3,Af.MOUSE=4,Af.ACCELERATION=6,Af.CUSTOM=8,Af.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var kf=Af.ListenerID,Rf=function(){function i(){var t;return y(this,i),(t=x(this,g(i).call(this,Af.MOUSE,kf.MOUSE,null))).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}return p(i,Af),v(i,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new i;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),i}(),Of=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,Af.TOUCH_ONE_BY_ONE,kf.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return p(t,Af),v(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),Mf=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,Af.TOUCH_ALL_AT_ONCE,kf.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return p(t,Af),v(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),If=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,Af.ACCELERATION,kf.ACCELERATION,null)))._onAccelerationEvent=null,t._onEvent=function(e){return t._callback(e)},t._onAccelerationEvent=e,t}return p(i,Af),v(i,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new i(this._onAccelerationEvent)}}]),i}(),Lf=function(){function i(){var t;return y(this,i),(t=x(this,g(i).call(this,Af.KEYBOARD,kf.KEYBOARD,null))).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}return p(i,Af),v(i,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new i;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),i}(),zf=(cc.EventListener=Af).ListenerID;var Bf=function(){function e(){y(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return v(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var Pf,Df,Ff,Nf=q3("eventManager",new(function(){function e(){y(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[]}return v(e,[{key:"pauseTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r){n[r]._setPaused(!0)}if(!0===i){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.pauseTarget(o,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r){n[r]._setPaused(!1)}if(this._setDirtyForNode(e),!0===i&&0<e.children.length){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.resumeTarget(o,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!function(e){for(;e;){if(e.getComponent("cc.CanvasComponent"))return!0;e=e.parent}return!1}(t))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=Af.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var o=this._toAddedListeners,l=o.length-1;0<=l;l--){var u=o[l];if(u===e){cc.js.array.removeAt(o,l),u._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var r=cc.js.array.copy(n),a=0;a<r.length;++a){var s=r[a];this.removeListener(s)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,l=0;l<o.length;){var u=o[l];u._getSceneGraphPriority()===e?(u._setSceneGraphPriority(null),u._setRegistered(!1),o.splice(l,1)):++l}if(!0===i)for(var c=e.getChildren(),h=0;h<c.length;++h){var d=c[h];this.removeListeners(d,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(zf.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(zf.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(zf.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(zf.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(zf.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=Sl,i=e.type;return i===t.ACCELERATION?zf.ACCELERATION:i===t.KEYBOARD?zf.KEYBOARD:i.startsWith(t.MOUSE)?zf.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(0<e.children.length)for(var a=e.children,s=0,o=a?a.length:0;s<o;s++)this._setDirtyForNode(a[s])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new Bf,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;0<=i;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;0<=a;a--){var s=r[a];s&&s._getListenerID()===e&&cc.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy))return-1;if(!e||!i||!i._activeInHierarchy)return 1;for(var r=i,a=n,s=!1;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(s=!0)&&n:r.parent,a=null===a.parent.parent?(s=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var o=r.getSiblingIndex(),l=a.getSiblingIndex();return s?o-l:l-o}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(0<=i[n]._getFixedPriority());)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;0<=r;r--){var a=i[r];if(!a._isRegistered()){cc.js.array.removeAt(i,r);var s=n.indexOf(a);-1!==s&&n.splice(s,1)}}if(t)for(var o=t.length-1;0<=o;o--){var l=t[o];if(!l._isRegistered()){cc.js.array.removeAt(t,o);var u=n.indexOf(l);-1!==u&&n.splice(u,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(0<t,3508),!(1<t)){var i;(i=this._listenersMap[zf.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[zf.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var s=a.indexOf(i);-1!==s&&a.splice(s,1)}if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,a=-1,s=i.getEventCode();return s===Tf.BEGAN?e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&e._claimedTouches.push(n):0<e._claimedTouches.length&&-1!==(a=e._claimedTouches.indexOf(n))&&(r=!0,s===Tf.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):s===Tf.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1)):s===Tf.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1))),i.isStopped()?(Nf._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(zf.TOUCH_ONE_BY_ONE),this._sortEventListeners(zf.TOUCH_ALL_AT_ONCE);var t=this._getListeners(zf.TOUCH_ONE_BY_ONE),i=this._getListeners(zf.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var s=0;s<n.length;++s){var o=n[s];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&0<r.length&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===Tf.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===Tf.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===Tf.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===Tf.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(Nf._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),s=0;if(r&&0!==r.length)for(;s<e.gt0Index;++s){var o=r[s];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var u=a[l];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}if(r&&!n)for(;s<r.length;++s){var c=r[s];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}()));cc.eventManager=Nf;var Uf=q3("Script",oo("cc.Script")(Pf=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,rd),e}())||Pf);cc._Script=Uf;var Vf=q3("JavaScript",oo("cc.JavaScript")(Df=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Uf),e}())||Df);cc._JavaScript=Vf;var Gf,Hf,Wf,qf,jf,Xf,Yf,Kf,Qf,Zf,Jf,$f,ep,tp=q3("TypeScript",oo("cc.TypeScript")(Ff=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Uf),e}())||Ff);cc._TypeScript=tp;var ip=new ve("Comp"),np=(Ho.Flags.IsOnEnableCalled,Ho.Flags.IsOnLoadCalled),rp=q3("Component",(Gf=oo("cc.Component"),Hf=lo({visible:!1}),Wf=lo({visible:!1}),qf=lo({displayName:"Script",type:Uf,tooltip:void 0}),jf=lo({visible:!1}),Xf=lo({visible:!1}),Yf=lo({visible:!1}),Gf((ep=$f=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"node",Zf,l(t)),m(t,"_enabled",Jf,l(t)),t._sceneGetter=null,t._id=ip.getNewId(),t._eventTargets=[],t}return p(a,Ho),v(a,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){_(g(a.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var n=e[t];n&&n.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return(e=e||cc.instantiate._clone(this,this)).node=null,e}},{key:"schedule",value:function(e,t,i,n){var r=1<arguments.length&&void 0!==t?t:0,a=2<arguments.length&&void 0!==i?i:cc.macro.REPEAT_FOREVER,s=3<arguments.length&&void 0!==n?n:0;cc.assertID(e,1619),cc.assertID(0<=r,1620),r=r||0,a=isNaN(a)?cc.macro.REPEAT_FOREVER:a,s=s||0;var o=cc.director.getScheduler(),l=o.isTargetPaused(this);o.schedule(e,this,r,a,s,l)}},{key:"scheduleOnce",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;this.schedule(e,0,0,i)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=Re(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&np}}]),a}(),$f.system=null,b((Qf=ep).prototype,"name",[Hf],Object.getOwnPropertyDescriptor(Qf.prototype,"name"),Qf.prototype),b(Qf.prototype,"uuid",[Wf],Object.getOwnPropertyDescriptor(Qf.prototype,"uuid"),Qf.prototype),b(Qf.prototype,"__scriptAsset",[qf],Object.getOwnPropertyDescriptor(Qf.prototype,"__scriptAsset"),Qf.prototype),b(Qf.prototype,"enabled",[jf],Object.getOwnPropertyDescriptor(Qf.prototype,"enabled"),Qf.prototype),b(Qf.prototype,"enabledInHierarchy",[Xf],Object.getOwnPropertyDescriptor(Qf.prototype,"enabledInHierarchy"),Qf.prototype),Zf=b(Qf.prototype,"node",[Yf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jf=b(Qf.prototype,"_enabled",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kf=Qf))||Kf)),ap=rp.prototype;ap.update=null,ap.lateUpdate=null,ap.__preload=null,ap.onLoad=null,ap.start=null,ap.onEnable=null,ap.onDisable=null,ap.onDestroy=null,ap.onFocusInEditor=null,ap.onLostFocusInEditor=null,ap.resetInEditor=null,ap._getLocalBounds=null,ap.onRestore=null,rp._requireComponent=null,rp._executionOrder=0,Te(rp,"_registerEditorProps",function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)}),cc.Component=rp;Ho.Flags.Destroying;var sp=new Array(16),op=null,lp=new Mi,up=[gf.TOUCH_START.toString(),gf.TOUCH_MOVE.toString(),gf.TOUCH_END.toString(),gf.TOUCH_CANCEL.toString()],cp=[gf.MOUSE_DOWN.toString(),gf.MOUSE_ENTER.toString(),gf.MOUSE_MOVE.toString(),gf.MOUSE_LEAVE.toString(),gf.MOUSE_UP.toString(),gf.MOUSE_WHEEL.toString()];function hp(e,t){var i=this.owner;return!(!i||!i.uiTransfromComp)&&(e.getUILocation(lp),!!i.uiTransfromComp.isHit(lp,this)&&(t.type=gf.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function dp(e,t){var i=this.owner;if(!i||!i.uiTransfromComp)return!1;t.type=gf.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function fp(e,t){var i=this.owner;i&&i.uiTransfromComp&&(e.getUILocation(lp),i.uiTransfromComp.isHit(lp,this)?t.type=gf.TOUCH_END.toString():t.type=gf.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function pp(e,t){var i=this.owner;i&&i.uiTransfromComp&&(t.type=gf.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function _p(e){var t=this.owner;t&&t.uiTransfromComp&&(lp=e.getUILocation(),t.uiTransfromComp.isHit(lp,this)&&(e.type=gf.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function vp(e){var t=this.owner;if(t&&t.uiTransfromComp){if(lp=e.getUILocation(),t.uiTransfromComp.isHit(lp,this))this._previousIn||(op&&op.eventProcessor.mouseListener&&(e.type=gf.MOUSE_LEAVE,op.dispatchEvent(e),op.eventProcessor.mouseListener&&(op.eventProcessor.mouseListener._previousIn=!1)),op=t,e.type=gf.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=gf.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=gf.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,op=null}e.propagationStopped=!0}}function mp(e){var t=this.owner;t&&t.uiTransfromComp&&(lp=e.getUILocation(),t.uiTransfromComp.isHit(lp,this)&&(e.type=gf.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function yp(e){var t=this.owner;t&&t.uiTransfromComp&&(lp=e.getUILocation(),t.uiTransfromComp.isHit(lp,this)&&(e.type=gf.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function gp(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&cc.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function bp(e,t){if(e._persistNode)return!0;var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}var xp,Sp,wp,Tp,Ep,Cp,Ap,kp,Rp,Op=function(){function t(e){y(this,t),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}return v(t,[{key:"node",get:function(){return this._node}}]),v(t,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=gp(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=gp(this._node))}},{key:"destroy",value:function(){op===this._node&&(op=null),(this.touchListener||this.mouseListener)&&(Nf.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new Ml),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){(this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new Ml:this.bubblingTargets=this.bubblingTargets||new Ml).once(e,t,i)}},{key:"off",value:function(e,t,i,n){var r=-1!==up.indexOf(e),a=!r&&-1!==cp.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!bp(this._node,up)&&(Nf.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!bp(this._node,cp)&&(Nf.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this.bubblingTargets).emit.apply(t,[e].concat(n))}}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,sp.length=0,e.eventProcessor.getCapturingTargets(t.type,sp),t.eventPhase=1,n=sp.length-1;0<=n;--n)if((i=sp[n]).eventProcessor.capturingTargets&&((t.currentTarget=i).eventProcessor.capturingTargets.emit(t.type,t,sp),t.propagationStopped))return sp.length=0;if(sp.length=0,t.eventPhase=2,(t.currentTarget=e).eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,sp),t.eventPhase=3,n=0;n<sp.length;++n)if((i=sp[n]).eventProcessor.bubblingTargets&&((t.currentTarget=i).eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return sp.length=0;sp.length=0}(this._node,e),sp.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!bp(this.node,up)&&(Nf.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!bp(this.node,cp)&&(Nf.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==up.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:gp(this._node),onTouchBegan:hp,onTouchMoved:dp,onTouchEnded:fp,onTouchCancelled:pp}),Nf.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==cp.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:gp(this._node),onMouseDown:_p,onMouseMove:vp,onMouseUp:mp,onMouseScroll:yp}),Nf.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule(function(){t._node.activeInHierarchy||Nf.pauseTarget(t._node)},this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new Ml:this.bubblingTargets=this.bubblingTargets||new Ml).hasEventListener(e,t,i)||r.on(e,t,i),t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),t}();cc.NodeEventProcessor=Op;var Mp=Ho.Flags.Destroying,Ip=Ho.Flags.DontDestroy,Lp=Ho.Flags.Deactivating,zp=(Ho.Flags.Activating,new ve("Node"));function Bp(e){return e?"string"==typeof e?Qe(e):e:(D(3804),null)}var Pp,Dp,Fp,Np,Up,Vp,Gp,Hp,Wp,qp,jp,Xp,Yp,Kp,Qp,Zp=q3("BaseNode",oo("cc._BaseNode")((Rp=kp=function(){function u(e){var t;return y(this,u),m(t=x(this,g(u).call(this,e)),"_parent",wp,l(t)),m(t,"_children",Tp,l(t)),m(t,"_active",Ep,l(t)),m(t,"_components",Cp,l(t)),m(t,"_prefab",Ap,l(t)),t._scene=null,t._activeInHierarchy=!1,t._id=zp.getNewId(),t._name=void 0,t._eventProcessor=new Op(l(t)),t._eventMask=0,t.__eventTargets=[],t._siblingIndex=0,t._name=void 0!==e?e:"New Node",t}return p(u,Ho),v(u,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&Ip)},set:function(e){e?this._objFlags|=Ip:this._objFlags&=~Ip}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var s=0;s<n.length;++s){var o=n[s];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var s=r[a];s.constructor===t&&i.push(s)}else for(var o=0;o<r.length;++o){var l=r[o];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var n=e[i],r=u._findComponent(n,t);if(r)return r;if(0<n._children.length&&(r=u._findChildComponent(n._children,t)))return r}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var n=0;n<e.length;++n){var r=e[n];u._findComponents(r,t,i),0<r._children.length&&u._findChildComponents(r._children,t,i)}}}]),v(u,[{key:"attr",value:function(e){Ne(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(this._parent!==e){var n=this._parent;if(this._parent=e,this._siblingIndex=0,this._onSetParent(n,i),this.emit&&this.emit(gf.PARENT_CHANGED,n),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(gf.CHILD_ADDED,this)),n&&!(n._objFlags&Mp)){var r=n._children.indexOf(this);0,n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(gf.CHILD_REMOVED,this)}this._onHierarchyChanged(n)}}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var n=e.split("/"),r=this,t=function(e){var t=n[e];if(0===t.length)return"continue";var i=r.children.find(function(e){return e.name===t});if(!i)return{v:null};r=i},i=0;i<n.length;++i){var a=t(i);switch(a){case"continue":continue;default:if("object"===_e(a))return a.v}}return r}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Lp)D(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,n=null,r=null,a=0,s=u._stacks[u._stackId];s||(s=[],u._stacks.push(s)),u._stackId++,s.length=0,s[0]=this;for(var o=null,l=!1;i;)if(r=s[--i])if(!l&&e?e(r):l&&t&&t(r),s[i]=null,l){if(l=!1,n)if(n[++a])s[i]=n[a],i++;else if(o&&(s[i]=o,i++,l=!0,o._parent?(a=(n=o._parent._children).indexOf(o),o=o._parent):n=o=null,a<0))break}else 0<r._children.length?(n=(o=r)._children,a=0,s[i]=n[a],i++):(s[i]=r,i++,l=!0);s.length=0,u._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){-1<this._children.indexOf(e)&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;0<=t;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=Bp(e);return t?u._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=Bp(e),i=[];return t&&u._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=Bp(e);return t?u._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=Bp(e),i=[];return t&&(u._findComponents(this,t,i),u._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Qe(e)))return D(3807,e),cc._RF.peek()&&D(3808,e),null}else{if(!e)return D(3804),null;t=e}if("function"!=typeof t)return D(3809),null;if(!Ge(t,cc.Component))return D(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return(n.node=this)._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof rp?e:this.getComponent(e))&&t.destroy()}else D(3813)}},{key:"on",value:function(e,t,i,n){switch(e){case gf.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i,n){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case gf.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this._eventProcessor).emit.apply(t,[e].concat(n))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(gf.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!_(g(u.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Mp)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&D(3815)}}else D(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(function(e){u._setScene(e)}))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e=e||cc.instantiate._clone(this,this);var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Mp;var e=this._parent,t=null!==e&&0!=(e._objFlags&Mp);for(var i=this._children,n=0;n<i.length;++n)i[n]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();for(var s=this.__eventTargets,o=0;o<s.length;++o){var l=s[o];l&&l.targetOff(this)}if(s.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){this.emit(gf.PARENT_CHANGED,this);var u=e._children.indexOf(this);e._children.splice(u,1),this._siblingIndex=0,e.emit&&e.emit(gf.CHILD_REMOVED,this)}return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),u}(),kp.idGenerator=zp,kp._stacks=[[]],kp._stackId=0,b((Sp=Rp).prototype,"_persistNode",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"_persistNode"),Sp.prototype),b(Sp.prototype,"name",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"name"),Sp.prototype),b(Sp.prototype,"uuid",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"uuid"),Sp.prototype),b(Sp.prototype,"children",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"children"),Sp.prototype),b(Sp.prototype,"active",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"active"),Sp.prototype),b(Sp.prototype,"activeInHierarchy",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"activeInHierarchy"),Sp.prototype),b(Sp.prototype,"parent",[lo],Object.getOwnPropertyDescriptor(Sp.prototype,"parent"),Sp.prototype),wp=b(Sp.prototype,"_parent",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tp=b(Sp.prototype,"_children",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ep=b(Sp.prototype,"_active",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cp=b(Sp.prototype,"_components",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ap=b(Sp.prototype,"_prefab",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xp=Sp))||xp);cc._BaseNode=Zp,(Dp=Pp=Pp||{})[Dp.LOCAL=0]="LOCAL",Dp[Dp.WORLD=1]="WORLD",(Np=Fp=Fp||{})[Np.NONE=0]="NONE",Np[Np.POSITION=1]="POSITION",Np[Np.ROTATION=2]="ROTATION",Np[Np.SCALE=4]="SCALE",Np[Np.RS=Np.ROTATION|Np.SCALE]="RS",Np[Np.TRS=Np.POSITION|Np.ROTATION|Np.SCALE]="TRS",Np[Np.TRS_MASK=~Np.TRS]="TRS_MASK";var Jp,$p,e_,t_,i_,n_,r_=new Fi,a_=new hn,s_=new hn,o_=new Array(10),l_=new hn,u_=new rn,c_=new rn,h_=new zn,d_=new Map,f_=q3("Node",(Up=oo("cc.Node"),Vp=lo({type:Fi}),Up((Qp=Kp=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._pos=new Fi,t._rot=new hn,t._scale=new Fi(1,1,1),t._mat=new zn,m(t,"_lpos",Wp,l(t)),m(t,"_lrot",qp,l(t)),m(t,"_lscale",jp,l(t)),m(t,"_layer",Xp,l(t)),m(t,"_euler",Yp,l(t)),t._dirtyFlags=Fp.NONE,t._eulerDirty=!1,t._uiTransfromComp=null,t._uiComp=null,t}return p(a,Zp),v(a,[{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;i&&this.updateWorldTransform(),_(g(a.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,t){if(_(g(a.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent;i?(i.updateWorldTransform(),zn.multiply(h_,zn.invert(h_,i._mat),this._mat),zn.toRTS(h_,this._lrot,this._lpos,this._lscale)):(Fi.copy(this._lpos,this._pos),hn.copy(this._lrot,this._rot),Fi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Fp.TRS)}},{key:"_onBatchCreated",value:function(){_(g(a.prototype),"_onBatchCreated",this).call(this),d_.set(this._id,Fp.TRS),this._dirtyFlags=Fp.TRS;for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||Pp.LOCAL;if(i===Pp.LOCAL)Fi.transformQuat(r_,e,this._lrot),this._lpos.x+=r_.x,this._lpos.y+=r_.y,this._lpos.z+=r_.z;else if(i===Pp.WORLD)if(this._parent){hn.invert(a_,this._parent.worldRotation),Fi.transformQuat(r_,e,a_);var n=this.worldScale;this._lpos.x+=r_.x/n.x,this._lpos.y+=r_.y/n.y,this._lpos.z+=r_.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Fp.POSITION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.POSITION_PART)}},{key:"rotate",value:function(e,t){var i=t||Pp.LOCAL;if(hn.normalize(a_,e),i===Pp.LOCAL)hn.multiply(this._lrot,this._lrot,a_);else if(i===Pp.WORLD){var n=this.worldRotation;hn.multiply(s_,a_,n),hn.invert(a_,n),hn.multiply(s_,a_,s_),hn.multiply(this._lrot,this._lrot,s_)}this._eulerDirty=!0,this.invalidateChildren(Fp.ROTATION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.ROTATION_PART)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(r_),Fi.subtract(r_,r_,e),Fi.normalize(r_,r_),hn.fromViewUp(a_,r_,t),this.setWorldRotation(a_)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,d_.set(this._id,this.hasChangedFlags|e),e|=Fp.POSITION;for(var t=this._children.length,i=0;i<t;++i)this._children[i].invalidateChildren(e)}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)t=(o_[i++]=t)._parent;for(var n=0;i;)n|=(e=o_[--i])._dirtyFlags,t?(n&Fp.POSITION&&(Fi.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Fp.RS&&(zn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),zn.multiply(e._mat,t._mat,e._mat),n&Fp.ROTATION&&hn.multiply(e._rot,t._rot,e._lrot),rn.fromQuat(u_,hn.conjugate(l_,e._rot)),rn.multiplyMat4(u_,u_,e._mat),e._scale.x=u_.m00,e._scale.y=u_.m04,e._scale.z=u_.m08)):(n&Fp.POSITION&&(Fi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Fp.RS&&(n&Fp.ROTATION?hn.copy(e._rot,e._lrot):Fi.copy(e._scale,e._lscale),zn.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=Fp.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._lpos,e):Fi.set(this._lpos,e,t,i),this.invalidateChildren(Fp.POSITION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.POSITION_PART)}},{key:"getPosition",value:function(e){return e?Fi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Fi.copy(new Fi,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?hn.copy(this._lrot,e):hn.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Fp.ROTATION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.ROTATION_PART)}},{key:"setRotationFromEuler",value:function(e,t,i){Fi.set(this._euler,e,t,i),hn.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(Fp.ROTATION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.ROTATION_PART)}},{key:"getRotation",value:function(e){return e?hn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):hn.copy(new hn,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._lscale,e):Fi.set(this._lscale,e,t,i),this.invalidateChildren(Fp.SCALE),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.SCALE_PART)}},{key:"getScale",value:function(e){return e?Fi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Fi.copy(new Fi,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){Fi.copy(e,t);for(var i=this,n=0;i._parent;)i=(o_[n++]=i)._parent;for(;0<=n;)Fi.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=o_[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._pos,e):Fi.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),Fi.transformMat4(r,this._pos,zn.invert(h_,n._mat))):Fi.copy(r,this._pos),this.invalidateChildren(Fp.POSITION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.POSITION_PART)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Fi.copy(e,this._pos):Fi.copy(new Fi,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?hn.copy(this._rot,e):hn.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),hn.multiply(this._lrot,hn.conjugate(this._lrot,this._parent._rot),this._rot)):hn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Fp.ROTATION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.ROTATION_PART)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){hn.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),hn.multiply(this._lrot,hn.conjugate(this._lrot,this._parent._rot),this._rot)):hn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Fp.ROTATION),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.ROTATION_PART)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?hn.copy(e,this._rot):hn.copy(new hn,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Fi.copy(this._scale,e):Fi.set(this._scale,e,t,i);var n=this._parent;n?(n.updateWorldTransform(),rn.fromQuat(u_,hn.conjugate(l_,n._rot)),rn.multiplyMat4(u_,u_,n._mat),c_.m00=this._scale.x,c_.m04=this._scale.y,c_.m08=this._scale.z,rn.multiply(u_,c_,rn.invert(u_,u_)),this._lscale.x=u_.m00,this._lscale.y=u_.m04,this._lscale.z=u_.m08):Fi.copy(this._lscale,this._scale),this.invalidateChildren(Fp.SCALE),1&this._eventMask&&this.emit(gf.TRANSFORM_CHANGED,gf.SCALE_PART)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Fi.copy(e,this._scale):Fi.copy(new Fi,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e=e||new zn,zn.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e=e||new zn,zn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e=e||new zn,zn.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return(e=e||new Mi).set(this.uiTransfromComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this.uiTransfromComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return(e=e||new qn).set(this.uiTransfromComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this.uiTransfromComp.setContentSize(e,t)}},{key:"pauseSystemEvents",value:function(e){Nf.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){Nf.resumeTarget(this,e)}},{key:"_onPostActivated",value:function(e){e?(Nf.resumeTarget(this),this.eventProcessor.reattach()):Nf.pauseTarget(this)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),_(g(a.prototype),"_onPreDestroy",this).call(this)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(hn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){zn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Fp.TRS),this._eulerDirty=!0,1&this._eventMask&&(this.emit(gf.TRANSFORM_CHANGED,gf.POSITION_PART),this.emit(gf.TRANSFORM_CHANGED,gf.ROTATION_PART),this.emit(gf.TRANSFORM_CHANGED,gf.SCALE_PART))}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Fi.transformQuat(new Fi,Fi.UNIT_Z,this.worldRotation)},set:function(e){var t=e.length();Fi.multiplyScalar(r_,e,-1/t),hn.fromViewUp(a_,r_),this.setWorldRotation(a_)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return d_.get(this._id)||0},set:function(e){d_.set(this._id,e)}},{key:"uiTransfromComp",get:function(){return this._uiTransfromComp||(this._uiTransfromComp=this.getComponent("cc.UITransformComponent")),this._uiTransfromComp},set:function(e){this._uiTransfromComp=e}},{key:"width",get:function(){return this.uiTransfromComp.width},set:function(e){this.uiTransfromComp.width=e}},{key:"height",get:function(){return this.uiTransfromComp.height},set:function(e){this.uiTransfromComp.height=e}},{key:"anchorX",get:function(){return this.uiTransfromComp.anchorX},set:function(e){this.uiTransfromComp.anchorX=e}},{key:"anchorY",get:function(){return this.uiTransfromComp.anchorY},set:function(e){this.uiTransfromComp.anchorY=e}}],[{key:"isNode",value:function(e){return e instanceof a&&(e.constructor===a||!(e instanceof cc.Scene))}}]),a}(),Kp.bookOfChange=d_,Kp.EventType=gf,Kp.NodeSpace=Pp,Kp.TransformDirtyBit=Fp,Wp=b((Hp=Qp).prototype,"_lpos",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),qp=b(Hp.prototype,"_lrot",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn}}),jp=b(Hp.prototype,"_lscale",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),Xp=b(Hp.prototype,"_layer",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ah.Enum.DEFAULT}}),Yp=b(Hp.prototype,"_euler",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),b(Hp.prototype,"eulerAngles",[Vp],Object.getOwnPropertyDescriptor(Hp.prototype,"eulerAngles"),Hp.prototype),b(Hp.prototype,"layer",[lo],Object.getOwnPropertyDescriptor(Hp.prototype,"layer"),Hp.prototype),Gp=Hp))||Gp));function p_(e){return"string"==typeof e}function __(e){return"number"==typeof e}function v_(e,t){return e instanceof t}cc.Node=f_,cc.isPropertyModifier=p_,cc.isElementModifier=__,cc.isCustomTargetModifier=v_;var m_=q3("HierachyModifier",oo("cc.HierachyModifier")((e_=b(($p=function(){function t(e){y(this,t),m(this,"path",e_,this),this.path=e||""}return v(t,[{key:"get",value:function(e){if(!(e instanceof f_))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getChildByPath(this.path);if(!t)throw new Error('Node "'.concat(e.name,'" has no path "').concat(this.path,'"'));return t}}]),t}()).prototype,"path",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jp=$p))||Jp);cc.HierachyModifier=m_;var y_=q3("ComponentModifier",oo("cc.ComponentModifier")((n_=b((i_=function(){function t(e){y(this,t),m(this,"component",n_,this),this.component=e||""}return v(t,[{key:"get",value:function(e){if(!(e instanceof f_))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getComponent(this.component);if(!t)throw new Error('Node "'.concat(e.name,'" has no component "').concat(this.component,'"'));return t}}]),t}()).prototype,"component",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),t_=i_))||t_);cc.ComponentModifier=y_;var g_=function(){function s(e,t,i){var n;y(this,s),this._isProxy=void 0,this._assignmentOrProxy=void 0;for(var r=0;r<t.length;++r){var a=t[r];if(__(a)||p_(a))if(r!==t.length-1||i){if(!(a in e))throw new Error('Target object has no property "'.concat(a,'"'));e=e[a]}else n=a;else e=a.get(e)}if(void 0!==n)this._assignmentOrProxy={object:e,propertyOrElement:n},this._isProxy=!1;else{if(!i)throw new Error("Bad animation curve.");this._assignmentOrProxy=i.forTarget(e),this._isProxy=!0}}return v(s,[{key:"setValue",value:function(e){this._isProxy?this._assignmentOrProxy.set(e):this._assignmentOrProxy.object[this._assignmentOrProxy.propertyOrElement]=e}}]),s}(),b_=q3("SkelAnimDataHub",function(){function i(){y(this,i)}return v(i,null,[{key:"getOrExtract",value:function(e){var t=i.pool.get(e);return t||(t=function(a){a.hash;var s=a.keys,o={};a.curves.forEach(function(e){if(!e.valueAdapter&&v_(e.modifiers[0],m_)&&p_(e.modifiers[1])){var t=e.modifiers[0].path,i=o[t];i=i||(o[t]={props:{}});var n=e.modifiers[1];i.props[n]=e.data}});for(var e=function(){var n=i[t],r=o[n]&&o[n].props;if(!r)return"continue";Object.defineProperty(r,"worldMatrix",{get:function(){if(!r._worldMatrix){var e=r.position,t=r.rotation,i=r.scale;x_(a,s,e),x_(a,s,t),x_(a,s,i),function(e,t,i){var n=i.position.values,r=i.rotation.values,a=i.scale.values,s=n.map(function(){return new zn}),o=t.lastIndexOf("/"),l=null;if(0<o){var u=t.substring(0,o),c=e[u];if(!c||!c.props)return console.warn("no data for parent bone?");l=c.props.worldMatrix.values}for(var h=0;h<n.length;h++){var d=n[h],f=r[h],p=a[h],_=s[h];zn.fromRTS(_,f,d,p),l&&zn.multiply(_,l[h],_)}Object.keys(i).forEach(function(e){return delete i[e]}),i._worldMatrix={keys:0,interpolate:!1,values:s}}(o,n,r)}return r._worldMatrix}})},t=0,i=Object.keys(o);t<i.length;t++)e();for(var n=new Array(Math.ceil(a.sample*a.duration/a.speed)+1),r=0;r<n.length;r++)n[r]=r;return a.curves=[{modifiers:[new m_(""),new y_(Re(cc.SkeletalAnimationComponent)),"frameID"],data:{keys:0,values:n,interpolate:!1}}],a.keys=[n.map(function(e,t){return t*a.speed/a.sample})],a.duration=a.keys[0][n.length-1],o}(e),i.pool.set(e,t)),t}}]),i}());function x_(e,t,i){var n=t[i.keys];i.keys=0;var r=e.keys[0].length,a=[];if(n&&1!==n.length)for(var s=0,o=0;s<r;s++){for(var l=s*e.speed/e.sample;n[o]<=l;)o++;o>n.length-1?l=n[o=n.length-1]:0===o&&(o=1);var u=i.values[o-1].clone();u.lerp(i.values[o],(l-n[o-1])/(n[o]-n[o-1])),a[s]=u}else for(var c=0;c<r;c++)a[c]=i.values[0].clone();i.values=a}b_.pool=new Map;var S_,w_,T_,E_=function(){function t(e){y(this,t),this._device=void 0,this._format=Ou.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new jc,this._region1=new jc,this._region2=new jc,this._roundUpFn=null,this._inOrderFree=!1,this._device=e}return v(t,[{key:"initialize",value:function(e){return this._format=e.format,this._formatSize=Xc[this._format].size,this._chunks=new Array(e.maxChunks),this._roundUpFn=e.roundUpFn||null,this._inOrderFree=e.inOrderFree||!1,!0}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.splice(0),this._handles.splice(0)}},{key:"alloc",value:function(l){var u=this;if(0===l)return null;for(var e=function(t){var e=u._chunks[t],i=!1,n=e.start;if(n+l<=e.end)i=!0;else if(u._inOrderFree)n>e.end?n+l<=e.size?i=!0:l<=e.end&&(e.start=n=0,i=!0):n===e.end&&(e.start=n=0,e.end=e.size,l<=e.end&&(i=!0));else{n=0;for(var r=u._handles.filter(function(e){return e.chunkIdx===t}).sort(function(e,t){return e.start-t.start}),a=0;a<r.length;a++){var s=r[a];if(n+l<=s.start){i=!0;break}n=s.end}!i&&n+l<=e.size&&(i=!0)}if(i){e.start+=l;var o={chunkIdx:t,start:n,end:n+l,texture:e.texture,texView:e.texView};return u._handles.push(o),{v:o}}},t=0;t<this._chunkCount;++t){var i=e(t);if("object"===_e(i))return i.v}if(this._chunkCount>=this._chunks.length)return console.error("TextureBufferPool: Reach max chunk count."),null;var n=Math.sqrt(l/this._formatSize),r=this._roundUpFn&&this._roundUpFn(n,this._formatSize)||Math.max(1024,function(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}(n)),a=r*r*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+a);var s=this._device.createTexture({type:lc.TEX2D,usage:hc.SAMPLED,format:this._format,width:r,height:r,mipLevel:1}),o=this._device.createTextureView({texture:s,type:mc.TV2D,format:this._format}),c={chunkIdx:this._chunkCount,start:0,end:l,texture:s,texView:o};return this._handles.push(c),this._chunks[this._chunkCount++]={texture:s,texView:o,size:a,start:l,end:a},c}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,s=r%e.texture.width,o=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-s,a),u=0;0<s&&(this._region0.texOffset.x=s,this._region0.texOffset.y=o,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(t.slice(u*this._formatSize,(u+l)*this._formatSize)),n.push(this._region0),s=0,o+=1,a-=l,u+=l),0<a&&(this._region1.texOffset.x=s,this._region1.texOffset.y=o,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(t.slice(u*this._formatSize,(u+l)*this._formatSize)),n.push(this._region1),s=0,o+=this._region1.texExtent.height,a-=l,u+=l),0<a&&(this._region2.texOffset.x=s,this._region2.texOffset.y=o,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(t.slice(u*this._formatSize,(u+a)*this._formatSize)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}}]),t}(),C_=function(e,t,i,n){zn.toRTS(i,L_,I_,z_),n?hn.copy(O_,L_):hn.dot(O_,L_)<0&&hn.multiplyScalar(L_,L_,-1);hn.set(M_,I_.x,I_.y,I_.z,0),hn.multiplyScalar(M_,hn.multiply(M_,M_,L_),.5),e[t+0]=B_(L_.x),e[t+1]=B_(L_.y),e[t+2]=B_(L_.z),e[t+3]=B_(L_.w),e[t+4]=B_(M_.x),e[t+5]=B_(M_.y),e[t+6]=B_(M_.z),e[t+7]=B_(M_.w),e[t+8]=B_(z_.x),e[t+9]=B_(z_.y),e[t+10]=B_(z_.z)};function A_(e){return e.hasFeature(eh.TEXTURE_FLOAT)?w_.RGBA32F:w_.RGBA8}(T_=w_=w_||{})[T_.NONE=0]="NONE",T_[T_.RGBA8=1]="RGBA8",T_[T_.RGBA32F=2]="RGBA32F";var k_=Object.freeze(new zn),R_=new zn,O_=new hn,M_=new hn,I_=new Fi,L_=new hn,z_=new Fi;function B_(e){return e||0}function P_(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(204*i,e)/12)}function D_(){y(this,D_),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new j_]}var F_=(s(S_={},w_.RGBA8,Ou.RGBA8),s(S_,w_.RGBA32F,Ou.RGBA32F),S_),N_=function(){function t(e){y(this,t),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=0,this._device=e,this._pool=new E_(e)}return v(t,[{key:"initialize",value:function(e){var t=0<arguments.length&&void 0!==e?e:8,i=F_[A_(this._device)];this._formatSize=Xc[i].size;var n=16/this._formatSize;this._pool.initialize({format:i,maxChunks:t*n,roundUpFn:P_})}},{key:"destroy",value:function(){this._pool.destroy()}},{key:"getDefaultJointsTexture",value:function(e){var t=e&&e.joints.length||1,i=this._textureBuffers.get(t)||null;if(i)return i.refCount++,i;var n=this._pool.alloc(12*t*Float32Array.BYTES_PER_ELEMENT);if(!n)return null;i={pixelOffset:n.start/this._formatSize,refCount:1,hash:t,handle:n};for(var r=new Float32Array(12*t),a=0;a<t;a++)C_(r,12*a,k_,0===a);return this._pool.update(n,r.buffer),this._textureBuffers.set(t,i),i}},{key:"getJointsTextureWithAnimation",value:function(e,t){var i=e.hash^t.hash,n=this._textureBuffers.get(i)||null;if(n)return n.refCount++,n;var r=t.keys[0].length,a=12*e.joints.length*r,s=this._pool.alloc(a*Float32Array.BYTES_PER_ELEMENT);if(!s)return null;n={pixelOffset:s.start/this._formatSize,refCount:1,hash:i,handle:s};for(var o=new Float32Array(a),l=b_.getOrExtract(t),u=0;u<e.joints.length;u++){var c=l[e.joints[u]];if(c&&c.props)for(var h=e.bindposes[u],d=c.props.worldMatrix.values,f=0;f<r;f++){var p=d[f];zn.multiply(R_,p,h),C_(o,12*(r*u+f),R_,0===u)}}return this._pool.update(s,o.buffer),this._textureBuffers.set(i,n),n}},{key:"releaseTexture",value:function(e){0==--e.refCount&&(this._pool.free(e.handle),this._textureBuffers.delete(e.hash))}}]),t}(),U_=q3("effects",[{name:"builtin-billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:1060434011,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:767569309,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture2D(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean"},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:522881683,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    in vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    in vec3 a_texCoord3;\n    in vec3 a_normal;\n    in vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    attribute vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    attribute vec3 a_texCoord3;\n    attribute vec3 a_normal;\n    attribute vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean"},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:1088715623,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"builtin-standard",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},albedo:{value:[1,1,1,1],type:16},albedoScale:{value:[1,1,1,0],type:16},pbrParams:{value:[.8,.6,1,1],type:16},pbrScale:{value:[1,1,1,1],type:16},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1,1],type:16},albedoMap:{value:"grey",type:28},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:2481836677,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n  In.index = attr.index;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n#endif\nhighp vec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  highp mat4 matWorld, matWorldIT;\n  CCGetWorldMatrixFull(matWorld, matWorldIT);\n  highp vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = textureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nin vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 v_uv;\n#endif\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\nin vec3 v_normal;\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\n#if CC_USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n  In.index = attr.index;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform vec4 tilingOffset;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n#endif\nhighp vec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  highp mat4 matWorld, matWorldIT;\n  CCGetWorldMatrixFull(matWorld, matWorldIT);\n  highp vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\n#if CC_USE_IBL\n  #ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n  #endif\n#endif\nprecision highp float;\nuniform vec4 cc_cameraPos;\nuniform vec4 cc_exposure;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_mainLitColor;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    #ifdef GL_EXT_shader_texture_lod\n      vec4 envmap = textureCubeLodEXT(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #else\n      vec4 envmap = textureCube(cc_environment, R);\n    #endif\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScale;\nuniform vec4 pbrParams;\nuniform vec4 pbrScale;\nuniform vec4 emissive;\nuniform vec4 emissiveScale;\nvarying vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  varying vec2 v_uv;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture2D(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture2D(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocalBatched",defines:["CC_USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"ROUGHNESS_CHANNEL",type:"string",options:["r","g","b"]},{name:"METALLIC_CHANNEL",type:"string",options:["g","r","b"]},{name:"OCCLUSION_CHANNEL",type:"string",options:["b","r","g"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScale",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"pbrScale",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScale",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}]}]},{name:"builtin-terrain",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:936791507,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 uvw;\nout vec2 uv0;\nout vec2 uv1;\nout vec2 uv2;\nout vec2 uv3;\nout vec3 diffuse;\nuniform TexCoords {\n  vec4 UVScale;\n};\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 uvw;\nvarying vec2 uv0;\nvarying vec2 uv1;\nvarying vec2 uv2;\nvarying vec2 uv3;\nvarying vec3 diffuse;\nuniform vec4 UVScale;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,3]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:30},{name:"detailMap0",type:28,count:1,defines:[],binding:31},{name:"detailMap1",type:28,count:1,defines:[],binding:32},{name:"detailMap2",type:28,count:1,defines:[],binding:33},{name:"detailMap3",type:28,count:1,defines:[],binding:34}]}]},{name:"builtin-unlit",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{color:{value:[1,1,1,1],type:16},tilingOffset:{value:[1,1,0,0],type:16},mainTexture:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:84121543,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  highp vec4 pos = cc_matProj * (cc_matView * matWorld) * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform Constant {\n    vec4 color;\n  };\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\n#if CC_USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  highp vec4 pos = cc_matProj * (cc_matView * matWorld) * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n    #if FLIP_UV\n      v_uv.y = 1.0 - v_uv.y;\n    #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["CC_USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"FLIP_UV",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_COLOR",type:"boolean"}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:["USE_COLOR"],binding:1,members:[{name:"color",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"pipeline/planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:938761954,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_BATCHING\n  in float a_dyn_batch_id;\n  uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n};\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\n#if CC_USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nvoid CCGetWorldMatrix (out highp mat4 matWorld) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n}\nvoid CCGetWorldMatrixFull (out highp mat4 matWorld, out highp mat4 matWorldIT) {\n  #if CC_USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id + 0.5)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n}\nuniform highp mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  highp mat4 matWorld;\n  CCGetWorldMatrix(matWorld);\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_shadowColor;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocalBatched",defines:["CC_USE_BATCHING"]},{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[]}]},{name:"pipeline/skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:925089992,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nout vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nvarying vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = ACESToneMap(color.rgb);\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[]}]},{name:"util/profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:529846440,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nin vec4 a_color;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n  vec4 symbols[4];\n};\nuniform PerFrameInfo {\n  vec4 digits[16 * 9 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v[0]; }\n  else if (i < 2.0) { return v[1]; }\n  else if (i < 3.0) { return v[2]; }\n  else { return v[3]; }\n}\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  if(a_color.z < 0.0){\n    v_uv = a_color.xy;\n  }\n  else{\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    float row = floor(n / 4.0), col = n - row * 4.0;\n    v_uv = a_color.xy + vec2(getComponent(symbols[int(row)], col), 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 symbols[4];\nuniform vec4 digits[36];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v[0]; }\n  else if (i < 2.0) { return v[1]; }\n  else if (i < 3.0) { return v[2]; }\n  else { return v[3]; }\n}\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  if(a_color.z < 0.0){\n    v_uv = a_color.xy;\n  }\n  else{\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    float row = floor(n / 4.0), col = n - row * 4.0;\n    v_uv = a_color.xy + vec2(getComponent(symbols[int(row)], col), 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1},{name:"symbols",type:16,count:4}]},{name:"PerFrameInfo",defines:[],binding:1,members:[{name:"digits",type:16,count:36}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]}]),V_=function(){function e(){y(this,e),this._device=null,this._resources={}}return v(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new Td(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var s=new uf;s._uuid="black-texture",s.image=r,t[s._uuid]=s;var o=new xf;o._uuid="black-cube-texture",o.setMipFilter(xf.Filter.LINEAR),o.image={front:new Td(i),back:new Td(i),left:new Td(i),right:new Td(i),top:new Td(i),bottom:new Td(i)},t[o._uuid]=o,n.fillStyle="#777",n.fillRect(0,0,a,a);var l=new uf;l._uuid="grey-texture",l.image=r,t[l._uuid]=l,n.fillStyle="#fff",n.fillRect(0,0,a,a);var u=new uf;u._uuid="white-texture",u.image=r,t[u._uuid]=u;var c=new xf;c._uuid="white-cube-texture",c.setMipFilter(xf.Filter.LINEAR),c.image={front:new Td(i),back:new Td(i),left:new Td(i),right:new Td(i),top:new Td(i),bottom:new Td(i)},t[c._uuid]=c,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var h=new uf;h._uuid="normal-texture",h.image=r,t[h._uuid]=h,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var d=new uf;d._uuid="default-texture",d.image=r,t[d._uuid]=d;var f=new xf;f.setMipFilter(xf.Filter.LINEAR),f._uuid="default-cube-texture",f.image={front:new Td(i),back:new Td(i),left:new Td(i),right:new Td(i),top:new Td(i),bottom:new Td(i)},t[f._uuid]=f;var p=new yf,_=r._texture;p.texture=_,p._uuid="default-spriteframe",t[p._uuid]=p,U_.forEach(function(e){Object.assign(new cc.EffectAsset,e).onLoaded()});var v=new cc.Material;v._uuid="standard-material",v.initialize({effectName:"builtin-standard"}),t[v._uuid]=v;var m=new cc.Material;m._uuid="missing-material",m.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),m.setProperty("color",cc.color("#ff00ff")),t[m._uuid]=m;var y=new cc.Material;y._uuid="missing-skinning-material";var g=A_(e);y.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,CC_USE_SKINNING:g}}),y.setProperty("color",cc.color("#ff00ff")),t[y._uuid]=y;var b=new cc.Material;b._uuid="missing-effect-material",b.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),b.setProperty("color",cc.color("#ffff00")),t[b._uuid]=b;var x=new cc.Material;x._uuid="ui-base-material",x.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[x._uuid]=x;var S=new cc.Material;S._uuid="ui-sprite-material",S.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[S._uuid]=S;var w=new cc.Material;w._uuid="ui-sprite-gray-material",w.initialize({defines:{USE_TEXTURE:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[w._uuid]=w;var T=new cc.Material;T._uuid="default-particle-material",T.initialize({effectName:"builtin-particle"}),t[T._uuid]=T;var E=new cc.Material;E._uuid="default-trail-material",E.initialize({effectName:"builtin-particle-trail"}),t[E._uuid]=E;var C=new cc.Material;C._uuid="default-billboard-material",C.initialize({effectName:"builtin-billboard"}),t[C._uuid]=C}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),G_=q3("builtinResMgr",cc.builtinResMgr=new V_),H_=q3("GFXTextureView",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.TEXTURE_VIEW)))._device=void 0,t._texture=null,t._type=mc.TV2D,t._format=Ou.UNKNOWN,t._baseLevel=0,t._levelCount=1,t._baseLayer=0,t._layerCount=1,t._device=e,t}return p(i,Vc),v(i,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),i}()),W_=function(){function e(){y(this,e),this.isDiscard=!1,this.polygonMode=Gu.FILL,this.shadeModel=Wu.GOURAND,this.cullMode=ju.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return v(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),q_=function(){function e(){y(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Yu.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Yu.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=Qu.KEEP,this.stencilZFailOpFront=Qu.KEEP,this.stencilPassOpFront=Qu.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Yu.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=Qu.KEEP,this.stencilZFailOpBack=Qu.KEEP,this.stencilPassOpBack=Qu.KEEP,this.stencilRefBack=1}return v(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),j_=function(){function e(){y(this,e),this.blend=!1,this.blendSrc=ec.ONE,this.blendDst=ec.ZERO,this.blendEq=Ju.ADD,this.blendSrcAlpha=ec.ONE,this.blendDstAlpha=ec.ZERO,this.blendAlphaEq=Ju.ADD,this.blendColorMask=ic.ALL}return v(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),X_=q3("GFXPipelineState",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.PIPELINE_STATE)))._device=void 0,t._shader=null,t._primitive=Uu.TRIANGLE_LIST,t._is=null,t._rs=null,t._dss=null,t._bs=null,t._dynamicStates=[],t._layout=null,t._renderPass=null,t._hash=0,t._device=e,t}return p(i,Vc),v(i,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"hash",get:function(){return this._hash}}]),i}()),Y_=q3("GFXBuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.BUFFER)))._device=void 0,t._usage=Iu.NONE,t._memUsage=zu.NONE,t._size=0,t._stride=1,t._count=0,t._flags=Pu.NONE,t._bufferView=null,t._device=e,t}return p(i,Vc),v(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"bufferView",get:function(){return this._bufferView}}]),i}()),K_=q3("GFXCommandBuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.COMMAND_BUFFER)))._device=void 0,t._allocator=null,t._type=wc.PRIMARY,t._numDrawCalls=0,t._numTris=0,t._device=e,t}return p(i,Vc),v(i,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),i}()),Q_=q3("GFXFramebuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.FRAMEBUFFER)))._device=void 0,t._renderPass=null,t._colorViews=[],t._depthStencilView=null,t._isOffscreen=!0,t._device=e,t}return p(i,Vc),v(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),i}());function Z_(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.find=Z_;var J_,$_,ev,tv,iv=function(){function e(){y(this,e),this._arrayBufferOrPaddings=[],this._length=0}return v(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!=t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer}}]),e}();var nv=function(){function t(e){y(this,t),this._subMeshes=e}return v(t,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"destroySubMeshes",value:function(){for(var e=0;e<this._subMeshes.length;++e){for(var t=this._subMeshes[e],i=0;i<t.vertexBuffers.length;++i)t.vertexBuffers[i].destroy();t.indexBuffer&&t.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.destroySubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),t}(),rv=q3("Mesh",oo("cc.Mesh")((ev=b(($_=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_struct",ev,l(e)),m(e,"_dataLength",tv,l(e)),e._data=null,e._initialized=!1,e._hasFlatBuffers=!1,e._renderingMesh=null,e.loaded=!1,e}return p(t,rd),v(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hasFlatBuffers",get:function(){return this._hasFlatBuffers}}]),v(t,[{key:"initialize",value:function(){var c=this;if(!this._initialized){this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),function(i,n){i.loaded?n&&n():i.nativeUrl?cc.loader.load({url:i.nativeUrl},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}(this));var h=this._data.buffer,d=cc.director.root.device,f=this._createVertexBuffers(d,h),p=[],e=function(){if(v){if(m>=_.length)return"break";y=_[m++]}else{if((m=_.next()).done)return"break";y=m.value}var e=y;if(0===e.vertexBundelIndices.length)return"continue";var t=null,i=null;if(e.indexView){var n=e.indexView;t=d.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:n.length,stride:n.stride}),i=new(function(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}(n.stride))(h,n.offset,n.count),c.loaded?t.update(i):c.once("load",function(){t.update(i)})}var r=e.vertexBundelIndices.map(function(e){return f[e]}),a=[];if(0<e.vertexBundelIndices.length){var s=e.vertexBundelIndices[0];a=c._struct.vertexBundles[s].attributes}var o={primitiveMode:e.primitiveMode,vertexBuffers:r,flatBuffers:[],indexBuffer:t,attributes:a};if(e.geometricInfo){var l=e.geometricInfo,u=new Float32Array(h,l.view.offset,l.view.length/4);o.geometricInfo={indices:i,positions:u}}p.push(o)};var _=this._struct.primitives,v=Array.isArray(_),m=0;e:for(_=v?_:_[Symbol.iterator]();;){var y;switch(e()){case"break":break e;case"continue":continue}}this._renderingMesh=new nv(p)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),_(g(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t){if(void 0!==t&&t&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;if(!this._initialized&&e._data){var i=JSON.parse(JSON.stringify(e._struct)),n=e._data.slice();return this.reset({struct:i,data:n}),this.initialize(),!0}for(var r,a,s,o,l,u=new iv,c=0,h=0,d=0,f=0,p=0,_=0,v=0,m=0,y=!1,g=new Array(this._struct.vertexBundles.length),b=0;b<this._struct.vertexBundles.length;++b){var x=this._struct.vertexBundles[b],S=e._struct.vertexBundles[b];d=x.view.offset,f=S.view.offset,h=x.view.stride,c=x.view.count+S.view.count,r=new ArrayBuffer(c*h),a=new Uint8Array(r),d+=(s=this._data.subarray(d,d+x.view.length)).length,f+=(o=e._data.subarray(f,f+S.view.length)).length,a.set(s),p=0;var w=x.attributes,T=Array.isArray(w),E=0;for(w=T?w:w[Symbol.iterator]();;){var C;if(T){if(E>=w.length)break;C=w[E++]}else{if((E=w.next()).done)break;C=E.value}var A=C;v=0,y=!1;var k=S.attributes,R=Array.isArray(k),O=0;for(k=R?k:k[Symbol.iterator]();;){var M;if(R){if(O>=k.length)break;M=k[O++]}else{if((O=k.next()).done)break;M=O.value}var I=M;if(A.name===I.name&&A.format===I.format){y=!0;break}v+=Xc[I.format].size}if(y){m=Xc[A.format].size,_=x.view.length+p;for(var L=0;L<S.view.count;++L)l=o.subarray(v,v+m),a.set(l,_),_+=x.view.stride,v+=S.view.stride}p+=Xc[A.format].size}g[b]={attributes:x.attributes,view:{offset:u.getLength(),length:r.byteLength,count:c,stride:h}},u.addBuffer(r)}for(var z,B,P,D=0,F=2,N=0,U=new Array(this._struct.primitives.length),V=0;V<this._struct.primitives.length;++V){var G=this._struct.primitives[V],H=e._struct.primitives[V];U[V]={primitiveMode:G.primitiveMode,vertexBundelIndices:G.vertexBundelIndices};var W=G.vertexBundelIndices,q=Array.isArray(W),j=0;for(W=q?W:W[Symbol.iterator]();;){var X;if(q){if(j>=W.length)break;X=W[j++]}else{if((j=W.next()).done)break;X=j.value}var Y=X;N=Math.max(N,this._struct.vertexBundles[Y].view.count)}if(G.indexView&&H.indexView){D=G.indexView.count,D+=H.indexView.count,d=G.indexView.offset,f=H.indexView.offset,F=D<256?1:D<65536?2:4;var K=new ArrayBuffer(D*F);if(z=2===F?new Uint16Array(K):1===F?new Uint8Array(K):new Uint32Array(K),B=2===G.indexView.stride?new Uint16Array(this._data.buffer,d,G.indexView.count):1===G.indexView.stride?new Uint8Array(this._data.buffer,d,G.indexView.count):new Uint32Array(this._data.buffer,d,G.indexView.count),F===G.indexView.stride)z.set(B);else for(var Q=0;Q<G.indexView.count;++Q)z[Q]=B[Q];d+=G.indexView.length,P=2===H.indexView.stride?new Uint16Array(e._data.buffer,f,H.indexView.count):1===H.indexView.stride?new Uint8Array(e._data.buffer,f,H.indexView.count):new Uint32Array(e._data.buffer,f,H.indexView.count);for(var Z=0;Z<H.indexView.count;++Z)z[G.indexView.count+Z]=N+P[Z];f+=H.indexView.length,U[V].indexView={offset:u.getLength(),length:K.byteLength,count:D,stride:F},u.setNextAlignment(F),u.addBuffer(K)}if(G.geometricInfo&&H.geometricInfo){var J=G.geometricInfo.view.length+H.geometricInfo.view.length,$=new ArrayBuffer(J),ee=new Uint8Array($),te=new Uint8Array(this._data.buffer,G.geometricInfo.view.offset,G.geometricInfo.view.length),ie=new Uint8Array(e._data.buffer,H.geometricInfo.view.offset,H.geometricInfo.view.length);ee.set(te),ee.set(ie,te.length),u.setNextAlignment(4),U[V].geometricInfo={doubleSided:G.geometricInfo.doubleSided,view:{offset:u.getLength(),length:ee.length,count:G.geometricInfo.view.count+H.geometricInfo.view.count,stride:G.geometricInfo.view.stride}},u.addBuffer($)}}var ne={vertexBundles:g,primitives:U,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ne.minPosition&&e._struct.minPosition&&Fi.min(ne.minPosition,ne.minPosition,e._struct.minPosition),ne.maxPosition&&e._struct.maxPosition&&Fi.max(ne.maxPosition,ne.maxPosition,e._struct.maxPosition),this.reset({struct:ne,data:new Uint8Array(u.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var s=this._struct.primitives[a],o=e._struct.primitives[a];if(s.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var l=0;l<s.vertexBundelIndices.length;++l)if(s.vertexBundelIndices[l]!==o.vertexBundelIndices[l])return!1;if(s.primitiveMode!==o.primitiveMode)return!1;if(s.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var f=this,p=null;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(f._data.buffer,e.view.offset+av(e.attributes,t)),r=Xc[i],a=sv(i),s=lv(n,i);if(a&&s){for(var o=e.view.count,l=r.count,u=new a(o*l),c=e.view.stride,h=0;h<o;++h)for(var d=0;d<l;++d)u[l*h+d]=s(c*h+u.BYTES_PER_ELEMENT*d);p=u}}),p}},{key:"copyAttribute",value:function(e,t,v,m,y){var g=this,b=!1;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(g._data.buffer,e.view.offset+av(e.attributes,t)),r=new DataView(v,y),a=Xc[i],s=lv(n,i),o=function(i,e){var t=Xc[e],n=t.size/t.count;switch(t.type){case Gc.UNORM:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,ov)};case 4:return function(e,t){return i.setUint32(e,t,ov)}}break;case Gc.SNORM:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,ov)};case 4:return function(e,t){return i.setInt32(e,t,ov)}}break;case Gc.INT:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,ov)};case 4:return function(e,t){return i.setInt32(e,t,ov)}}break;case Gc.UINT:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,ov)};case 4:return function(e,t){return i.setUint32(e,t,ov)}}break;case Gc.FLOAT:return function(e,t){return i.setFloat32(e,t,ov)}}return null}(r,i);if(s&&o){for(var l=e.view.count,u=a.count,c=e.view.stride,h=function(e){var t=Xc[e];return t.size/t.count}(i),d=m,f=h,p=0;p<l;++p)for(var _=0;_<u;++_){o(d*p+f*_,s(c*p+h*_))}b=!0}}),b}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,n=i<256?Ou.R8UI:i<65536?Ou.R16UI:Ou.R32UI,r=new(sv(n))(i),a=lv(new DataView(this._data.buffer),n),s=0;s<i;++s)r[s]=a(t.indexView.offset+r.BYTES_PER_ELEMENT*s);return r}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?Ou.R8UI:2===i.indexView.stride?Ou.R16UI:Ou.R32UI,a=lv(new DataView(this._data.buffer),r),s=0;s<n;++s)t[s]=a(i.indexView.offset+Xc[r].size*s);return!0}},{key:"createFlatBuffers",value:function(){if(!this._renderingMesh||this._hasFlatBuffers)return!1;cc.director.root.device;for(var e,t=0,i=0;i<this._struct.primitives.length;++i){var n=this._struct.primitives[i],r=this._renderingMesh.subMeshes[i];n.indexView&&(t=n.indexView.count);var a=n.vertexBundelIndices,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=this._struct.vertexBundles[u],h=n.indexView?n.indexView.count:c.view.count,d=c.view.stride,f=d*h,p=new Uint8Array(this._data.buffer,c.view.offset,c.view.length);if(n.indexView){var _=new Uint8Array(f);e=2===(t<65536?2:4)?new Uint16Array(this._data.buffer,n.indexView.offset,n.indexView.count):new Uint32Array(this._data.buffer,n.indexView.offset,n.indexView.count);for(var v=0;v<t;++v)for(var m=v*d,y=e[v]*d,g=0;g<d;++g)_[m+g]=p[y+g];r.flatBuffers.push({stride:d,count:h,buffer:_})}else r.flatBuffers.push({stride:d,count:h,buffer:p})}}return this._hasFlatBuffers=!0}},{key:"destroyFlatBuffers",value:function(){if(this._hasFlatBuffers){if(this._renderingMesh)for(var e=this._renderingMesh.subMeshes,t=0;t<e.length;++t)e[t].flatBuffers.splice(0);this._hasFlatBuffers=!1}}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var n=this._struct.primitives[e].vertexBundelIndices,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=this._struct.vertexBundles[o],u=l.attributes.findIndex(function(e){return e.name===t});if(!(u<0)){i(l,u);break}}}}},{key:"_createVertexBuffers",value:function(n,r){var a=this;return this._struct.vertexBundles.map(function(e){var t=n.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:e.view.length,stride:e.view.stride}),i=new Uint8Array(r,e.view.offset,e.view.length);return a.loaded?t.update(i):a.once("load",function(){t.update(i)}),t})}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}()).prototype,"_struct",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),tv=b($_.prototype,"_dataLength",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J_=$_))||J_);function av(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=Xc[r.format].size}return i}function sv(e){var t=Xc[e],i=t.size/t.count;switch(t.type){case Gc.UNORM:case Gc.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Gc.SNORM:case Gc.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Gc.FLOAT:return Float32Array}return null}cc.Mesh=rv;var ov=cc.sys.isLittleEndian;function lv(t,e){var i=Xc[e],n=i.size/i.count;switch(i.type){case Gc.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,ov)};case 4:return function(e){return t.getUint32(e,ov)}}break;case Gc.SNORM:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,ov)};case 4:return function(e){return t.getInt32(e,ov)}}break;case Gc.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,ov)};case 4:return function(e){return t.getInt32(e,ov)}}break;case Gc.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,ov)};case 4:return function(e){return t.getUint32(e,ov)}}break;case Gc.FLOAT:return function(e){return t.getFloat32(e,ov)}}return null}var uv=function(){function t(e){y(this,t),this._onAttach=void 0,this._onDetach=void 0,this._models={},this._onAttach=e.onAttach,this._onDetach=e.onDetach}return v(t,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||0<--t[i]||this._onDetach&&this._onDetach(e)}}]),t}(),cv=new(function(){function e(){y(this,e),this._customs={}}return v(e,[{key:"register",value:function(e,t){this._customs[e]=new uv(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}());cc.customizationManager=cv;var hv=function(){function e(){y(this,e),this._subMeshObject=void 0,this._inputAssembler=void 0,this._material=void 0,this._cmdBuffers=void 0,this._psos=void 0,this._priority=void 0,this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=lh.DEFAULT}return v(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:wc.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===bu.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:wc.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){null!=(this._material=e)&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),dv=new zn,fv=new Ts(function(){return new hv},32);function pv(e){var t=0,i=e.members,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=Zc(s.type)*s.count}return t}var _v=function(){function i(e,t){y(this,i),this._type="default",this._device=void 0,this._scene=void 0,this._node=void 0,this._transform=void 0,this._id=void 0,this._enabled=!1,this._visFlags=ah.Enum.NONE,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._implantPSOs=[],this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new _h,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._isDynamicBatching=!1,this._transformUpdated=!0,this._device=cc.director.root.device,this._scene=e,this._node=this._transform=t,this._id=this._scene.generateModelId()}return v(i,[{key:"scene",set:function(e){this._scene=e,this._id=this._scene.generateModelId()},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModels",get:function(){return this._subModels}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isDynamicBatching",get:function(){return this._isDynamicBatching},set:function(e){this._isDynamicBatching=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),v(i,[{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.destroy(),fv.free(r)}for(var a=this._localBindings.values(),s=a.next();!s.done;){var o=s.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),s=a.next()}this._localBindings.has(gh.BLOCK.name)&&this._localBindings.delete(gh.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;if(this._uboUpdated=!0,this._transformUpdated&&!this._isDynamicBatching){var e=this._transform._mat;zn.toArray(this._uboLocal.view,e,_h.MAT_WORLD_OFFSET),zn.inverseTranspose(dv,e),zn.toArray(this._uboLocal.view,dv,_h.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(_h.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view),this._transformUpdated=!1}return this._matPSORecord.forEach(this._updatePass,this),!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=as.fromPoints(as.create(),e,t),this._worldBounds=as.clone(this._modelBounds),this._transform.updateWorldTransform(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=fv.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=fv.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineState(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineState(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onPipelineChange",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}for(var r=n,a=r.material,s=this._matPSORecord.get(a),o=0;o<a.passes.length;o++){var l=a.passes[o];l.tryCompile(),l.destroyPipelineState(s[o]),s[o]=this._doCreatePSO(l),s[o].pipelineLayout.layouts[0].update()}r.updateCommandBuffer()}}},{key:"insertImplantPSO",value:function(e){this._implantPSOs.push(e)}},{key:"removeImplantPSO",value:function(e){var t=this._implantPSOs.indexOf(e);0<=t&&this._implantPSOs.splice(t,1)}},{key:"createPipelineState",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var n=e.passes[i],r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;cv.attach(l,this)}t[i]=this._doCreatePSO(n)}return t}},{key:"destroyPipelineState",value:function(e,t){for(var i=0;i<e.passes.length;i++){var n=e.passes[i];n.destroyPipelineState(t[i]);var r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;cv.detach(l,this)}}}},{key:"_doCreatePSO",value:function(e,t,i){(t=t||{}).CC_USE_BATCHING=this._isDynamicBatching;var n=e.createPipelineState(t,i);return n.pipelineLayout.layouts[0].bindBuffer(_h.BLOCK.binding,this._localBindings.get(_h.BLOCK.name).buffer),this._localBindings.has(gh.BLOCK.name)&&n.pipelineLayout.layouts[0].bindBuffer(gh.BLOCK.binding,this._localBindings.get(gh.BLOCK.name).buffer),n}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(_h.BLOCK.name)||this._localBindings.set(_h.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:_h.BLOCK});var t=!1,i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.bindings.find(function(e){return e.name===gh.BLOCK.name})){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(gh.BLOCK.name)||this._localBindings.set(gh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:gh.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var n=i.value;n.buffer||(n.buffer=this._device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:pv(n.blockInfo)})),i=t.next()}}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var n=0;n<e.length;n++)e[n].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineState(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineState(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),i}(),vv=function(){function a(){y(this,a)}return v(a,null,[{key:"create",value:function(e){var t=a.pool.get(e);if(t)return t;var i=cc.director.root.device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:xh.SIZE,stride:xh.SIZE}),n=new Float32Array([1,0,0,0]);i.update(n);var r={buffer:i,data:n};return a.pool.set(e,r),r}},{key:"destroy",value:function(e){var t=a.pool.get(e);t&&(t.buffer.destroy(),a.pool.delete(e))}},{key:"switchClip",value:function(e,t){var i=a.pool.get(e);i&&(i.data[0]=t?t.keys[0].length:1,i.data[1]=0,i.buffer.update(i.data))}},{key:"get",value:function(e){return a.pool.get(e)||a.create(-1)}}]),a}();vv.pool=new Map;var mv,yv,gv,bv=kd([rc.POINT,rc.POINT,rc.NONE,sc.CLAMP,sc.CLAMP,sc.CLAMP]),xv=function(){function l(e,t){var i;y(this,l),(i=x(this,g(l).call(this,e,t))).uploadedAnim=null,i._jointsMedium=void 0,i._skeleton=null,i._type="skinning";var n=new Float32Array(4),r=i._scene.texturePool.getDefaultJointsTexture();return i._jointsMedium={buffer:null,jointsTextureInfo:n,texture:r},i}return p(l,_v),v(l,[{key:"worldBounds",get:function(){return this.uploadedAnim?null:this._worldBounds}}]),v(l,[{key:"destroy",value:function(){_(g(l.prototype),"destroy",this).call(this),this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null)}},{key:"bindSkeleton",value:function(e,t){(this._skeleton=e)&&t&&(this._transform=t,this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:bh.SIZE,stride:bh.SIZE})))}},{key:"uploadAnimation",value:function(e){if(this._skeleton){var t=(this.uploadedAnim=e)?this._scene.texturePool.getJointsTextureWithAnimation(this._skeleton,e):this._scene.texturePool.getDefaultJointsTexture(this._skeleton);vv.switchClip(this._transform.uuid,e),this._applyJointsTexture(t)}}},{key:"_applyJointsTexture",value:function(e){if(e){this._jointsMedium.texture=e;var t=this._jointsMedium,i=t.buffer,n=t.jointsTextureInfo;n[0]=e.handle.texture.width,n[1]=1/n[0],n[2]=e.pixelOffset+.1,i&&i.update(n);var r=Yd.getSampler(this._device,bv),a=this._subModels,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;if(u.psos){var c=u.psos,h=Array.isArray(c),d=0;for(c=h?c:c[Symbol.iterator]();;){var f;if(h){if(d>=c.length)break;f=c[d++]}else{if((d=c.next()).done)break;f=d.value}var p=f.pipelineLayout.layouts[0];p.bindTextureView(Sh.binding,e.handle.texView),p.bindSampler(Sh.binding,r)}}}var _=this._implantPSOs,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}var g=y.pipelineLayout.layouts[0];g.bindTextureView(Sh.binding,e.handle.texView),g.bindSampler(Sh.binding,r),g.update()}}}},{key:"_doCreatePSO",value:function(e){var t=_(g(l.prototype),"_doCreatePSO",this).call(this,e,{CC_USE_SKINNING:A_(this._device)}),i=this._jointsMedium,n=i.buffer,r=i.texture,a=vv.get(this._transform.uuid),s=t.pipelineLayout.layouts[0];s.bindBuffer(bh.BLOCK.binding,n),s.bindBuffer(xh.BLOCK.binding,a.buffer);var o=Yd.getSampler(this._device,bv);return r&&(s.bindTextureView(Sh.binding,r.handle.texView),s.bindSampler(Sh.binding,o)),t}}]),l}();(gv=yv=yv||{})[gv.positions=Cu.ATTR_POSITION]="positions",gv[gv.normals=Cu.ATTR_NORMAL]="normals",gv[gv.uvs=Cu.ATTR_TEX_COORD]="uvs",gv[gv.colors=Cu.ATTR_COLOR]="colors";var Sv=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_NORMAL,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RG32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA32F}],wv=new Fi;function Tv(e,t,i){i=i||{};var n,r=[],a=0,s=[],o=0;if(0<e.positions.length){if(n=null,e.attributes){var l=e.attributes,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}var d=h;if(d.name===Cu.ATTR_POSITION){n=d;break}}}n=n||Sv[0];var f=Xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.positions.length/f.count)),s.push({offset:a,data:e.positions,attribute:n}),a+=f.size}if(e.normals&&0<e.normals.length){if(n=null,e.attributes){var p=e.attributes,_=Array.isArray(p),v=0;for(p=_?p:p[Symbol.iterator]();;){var m;if(_){if(v>=p.length)break;m=p[v++]}else{if((v=p.next()).done)break;m=v.value}var y=m;if(y.name===Cu.ATTR_NORMAL){n=y;break}}}n=n||Sv[1];var g=Xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/g.count)),s.push({offset:a,data:e.normals,attribute:n}),a+=g.size}if(e.uvs&&0<e.uvs.length){if(n=null,e.attributes){var b=e.attributes,x=Array.isArray(b),S=0;for(b=x?b:b[Symbol.iterator]();;){var w;if(x){if(S>=b.length)break;w=b[S++]}else{if((S=b.next()).done)break;w=S.value}var T=w;if(T.name===Cu.ATTR_TEX_COORD){n=T;break}}}n=n||Sv[2];var E=Xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/E.count)),s.push({offset:a,data:e.uvs,attribute:n}),a+=E.size}if(e.colors&&0<e.colors.length){if(n=null,e.attributes){var C=e.attributes,A=Array.isArray(C),k=0;for(C=A?C:C[Symbol.iterator]();;){var R;if(A){if(k>=C.length)break;R=C[k++]}else{if((k=C.next()).done)break;R=k.value}var O=R;if(O.name===Cu.ATTR_COLOR){n=O;break}}}n=n||Sv[3];var M=Xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/M.count)),s.push({offset:a,data:e.colors,attribute:n}),a+=M.size}if(e.customAttributes){var I=e.customAttributes,L=Array.isArray(I),z=0;for(I=L?I:I[Symbol.iterator]();;){var B;if(L){if(z>=I.length)break;B=I[z++]}else{if((z=I.next()).done)break;B=z.value}var P=B,D=Xc[P.attr.format];r.push(P.attr),o=Math.max(o,Math.floor(P.values.length/D.count)),s.push({offset:a,data:P.values,attribute:P.attr}),a+=D.size}}for(var F=new iv,N=new ArrayBuffer(o*a),U=new DataView(N),V=0,G=s;V<G.length;V++){var H=G[V];kv(U,H.data,H.attribute.format,H.offset,a)}F.setNextAlignment(0);var W={attributes:r,view:{offset:F.getLength(),length:N.byteLength,count:o,stride:a}};F.addBuffer(N);var q=null,j=0;if(e.indices){var X=e.indices;j=X.length,q=new ArrayBuffer(2*j),kv(new DataView(q),X,Ou.R16UI)}var Y={primitiveMode:e.primitiveMode||Uu.TRIANGLE_LIST,vertexBundelIndices:[0]};if(Y.primitiveMode>=Uu.TRIANGLE_LIST){var K=Float32Array.from(e.positions);F.setNextAlignment(4),Y.geometricInfo={doubleSided:e.doubleSided,view:{offset:F.getLength(),length:K.byteLength,count:e.positions.length/4,stride:4}},F.addBuffer(K.buffer)}q&&(F.setNextAlignment(2),Y.indexView={offset:F.getLength(),length:q.byteLength,count:j,stride:2},F.addBuffer(q));var Q=e.minPos;if(!Q&&i.calculateBounds){Q=Fi.set(new Fi,1/0,1/0,1/0);for(var Z=0;Z<o;++Z)Fi.set(wv,e.positions[3*Z+0],e.positions[3*Z+1],e.positions[3*Z+2]),Fi.min(Q,Q,wv)}var J=e.maxPos;if(!J&&i.calculateBounds){J=Fi.set(new Fi,-1/0,-1/0,-1/0);for(var $=0;$<o;++$)Fi.set(wv,e.positions[3*$+0],e.positions[3*$+1],e.positions[3*$+2]),Fi.max(J,J,wv)}var ee={vertexBundles:[W],primitives:[Y]};return Q&&(ee.minPosition=new Fi(Q.x,Q.y,Q.z)),J&&(ee.maxPosition=new Fi(J.x,J.y,J.z)),(t=t||new rv).reset({struct:ee,data:new Uint8Array(F.getCombined())}),t}var Ev=cc.sys.isLittleEndian,Cv=(s(mv={},Gc.UNORM,"Uint"),s(mv,Gc.SNORM,"Int"),s(mv,Gc.UINT,"Uint"),s(mv,Gc.INT,"Int"),s(mv,Gc.UFLOAT,"Float"),s(mv,Gc.FLOAT,"Float"),s(mv,"default","Uint"),mv);function Av(e){return(Cv[e.type]||Cv.default)+e.size/e.count*8}function kv(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ou.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=Xc[i];r=r||a.size;for(var s="set"+Av(a),o=a.size/a.count,l=Math.floor(t.length/a.count),u=0;u<l;++u)for(var c=n+r*u,h=0;h<a.count;++h){var d=c+o*h;e[s](d,t[a.count*u+h],Ev)}}function Rv(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Ou.R32F,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],s=Xc[t];r=r||s.size;for(var o="get"+Av(s),l=s.size/s.count,u=Math.floor(n/r),c=0;c<u;++c)for(var h=i+r*c,d=0;d<s.count;++d){var f=h+l*d;a[s.count*c+d]=e[o](f,Ev)}return a}function Ov(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Ou.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length?arguments[6]:void 0;s=s||new DataView(new ArrayBuffer(e.byteLength));var o=Xc[i];a=a||o.size;for(var l="set"+Av(o),u="get"+Av(o),c=o.size/o.count,h=Math.floor(r/a),d=0;d<h;++d)for(var f=n+a*d,p=0;p<o.count;++p){var _=f+c*p,v=e[u](_,Ev);s[l](_,t(v,p,e),Ev)}return s}var Mv=[],Iv=new Fi;var Lv=new(function(){function e(){y(this,e),this._cached=new Map}return v(e,[{key:"use",value:function(e,t){var i=this._cached.get(e);i||(i=new Map,this._cached.set(e,i));var n=i.get(t);return n||(n={bounds:function(e,t){for(var i=new Array(t.joints.length),n=0;n<i.length;++n)i[n]={hasValue:!1,min:new Fi(1/0,1/0,1/0),max:new Fi(-1/0,-1/0,-1/0)};for(var r=0;r<e.struct.primitives.length;++r){var a=e.readAttribute(r,Cu.ATTR_JOINTS);if(a){var s=e.readAttribute(r,Cu.ATTR_WEIGHTS);if(s){var o=e.readAttribute(r,Cu.ATTR_POSITION);if(o)for(var l=Math.min(a.length/4,s.length/4,o.length/3),u=0;u<l;++u){Fi.set(wv,o[3*u+0],o[3*u+1],o[3*u+2]);for(var c=0;c<4;++c){if(0!==s[4*u+c]){var h=a[4*u+c];if(!(h>=t.joints.length)){t.bindposes?Fi.transformMat4(Iv,wv,t.bindposes[h]):Fi.copy(Iv,wv);var d=i[h];d.hasValue=!0,Fi.min(d.min,d.min,Iv),Fi.max(d.max,d.max,Iv)}}}}}}}return i.map(function(e){return e.hasValue?as.fromPoints(new as,e.min,e.max):null})}(e,t),referenceCount:0},i.set(t,n)),++n.referenceCount,n.bounds}},{key:"unuse",value:function(e,t){var i=this._cached.get(e);if(i){var n=i.get(t);n&&(--n.referenceCount,0===n.referenceCount&&i.delete(t)),0===i.size&&this._cached.delete(e)}}}]),e}()),zv=new zn,Bv=new zn,Pv=new as,Dv=new Fi,Fv=new Fi;var Nv=Object.freeze({toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter(function(e,t){return t%4<3}).toString(),"\n")},createMesh:Tv,readMesh:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},n=new DataView(e._nativeAsset),r=e.struct,a=r.primitives[t],s=a.vertexBundelIndices,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u,h=r.vertexBundles[c],d=h.view.offset,f=h.view,p=f.length,_=f.stride,v=h.attributes,m=Array.isArray(v),y=0;for(v=m?v:v[Symbol.iterator]();;){var g;if(m){if(y>=v.length)break;g=v[y++]}else{if((y=v.next()).done)break;g=y.value}var b=g,x=yv[b.name];x&&(i[x]=(i[x]||[]).concat(Rv(n,b.format,d,p,_))),d+=Xc[b.format].size}}var S=a.indexView;return i.indices=Rv(n,Ou["R".concat(8*S.stride,"UI")],S.offset,S.length),i},writeBuffer:kv,readBuffer:Rv,mapBuffer:Ov,LCA:function(e,t){if(e===t)return e;var i=t;for(Mv.length=0;i;)Mv.push(i),i=i.parent;for(i=e;i;){if(Mv.find(function(e){return e===i}))return i;i=i.parent}return null},calculateSkinnedBounds:function(e,t){if(t.model&&t.mesh){var i=t.skeleton,n=t.skinningRoot,r=t.model.uploadedAnim,a=n&&vv.get(n.uuid);if(!(i&&n&&r&&a)){if(!t.model.worldBounds)return;return as.copy(e,t.model.worldBounds),!0}Fi.set(Dv,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Fi.set(Fv,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n.getWorldMatrix(zv);for(var s=Lv.use(t.mesh,i),o=i.joints.length,l=b_.getOrExtract(r),u=a.data[1],c=0;c<o;++c){var h=s[c],d=l[i.joints[c]];if(h&&d&&d.props){var f=d.props.worldMatrix.values[u];zn.multiply(Bv,zv,f),as.transform(Pv,h,Bv),Pv.getBoundary(wv,Iv),Fi.min(Dv,Dv,wv),Fi.max(Fv,Fv,Iv)}}return as.fromPoints(e,Dv,Fv),!0}},find:Z_});q3("utils",Nv);var Uv=q3("GFXInputAssembler",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.INPUT_ASSEMBLER)))._device=void 0,t._attributes=[],t._vertexBuffers=[],t._indexBuffer=null,t._vertexCount=0,t._firstVertex=0,t._indexCount=0,t._firstIndex=0,t._vertexOffset=0,t._instanceCount=0,t._firstInstance=0,t._isIndirect=!1,t._indirectBuffer=null,t._device=e,t}return p(i,Vc),v(i,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),v(i,[{key:"getVertexBuffer",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i,n,r){var a=3<arguments.length&&void 0!==n?n:0,s=!(4<arguments.length&&void 0!==r)||r,o=0,l=Ou.UNKNOWN,u=this._attributes,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var d;if(c){if(h>=u.length)break;d=u[h++]}else{if((h=u.next()).done)break;d=h.value}var f=d;if(f.name===t){l=f.format;break}o+=Xc[f.format].size}var p=this._vertexBuffers[a];l&&p&&(kv(new DataView(e),i,l,o,p.stride),s&&p.update(e,0,p.stride*p.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,n=this._indexBuffer;i&&n&&(kv(new DataView(e),t,Ou["R".concat(8*n.stride,"UI")]),n.update(e,0,n.stride*n.count),this._indexCount=t.length)}}]),i}()),Vv=q3("GFXPipelineLayout",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.PIPELINE_LAYOUT)))._device=void 0,t._pushConstantsRanges=[],t._layouts=[],t._device=e,t}return p(i,Vc),v(i,[{key:"layouts",get:function(){return this._layouts}}]),i}()),Gv=q3("GFXQueue",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.QUEUE)))._device=void 0,t._type=Dc.GRAPHICS,t._device=e,t}return p(i,Vc),v(i,[{key:"type",get:function(){return this._type}}]),i}()),Hv=q3("GFXRenderPass",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.RENDER_PASS)))._device=void 0,t._colorInfos=[],t._depthStencilInfo=null,t._device=e,t}return p(i,Vc),i}()),Wv=function(){function e(){y(this,e),this.name="",this.minFilter=rc.LINEAR,this.magFilter=rc.LINEAR,this.mipFilter=rc.NONE,this.addressU=sc.WRAP,this.addressV=sc.WRAP,this.addressW=sc.WRAP,this.maxAnisotropy=16,this.cmpFunc=Yu.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return v(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),qv=q3("GFXSampler",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.SAMPLER)))._device=void 0,t._state=new Wv,t._device=e,t}return p(i,Vc),v(i,[{key:"state",get:function(){return this._state}}]),i}()),jv=q3("GFXShader",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.SHADER)))._device=void 0,t._id=void 0,t._name="",t._stages=[],t._blocks=[],t._samplers=[],t._device=e,t._id=e.genShaderId(),t}return p(i,Vc),v(i,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),i}()),Xv=q3("GFXTexture",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.TEXTURE)))._device=void 0,t._type=lc.TEX2D,t._usage=hc.NONE,t._format=Ou.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._arrayLayer=1,t._mipLevel=1,t._samples=fc.X1,t._flags=_c.NONE,t._isPowerOf2=!1,t._size=0,t._buffer=null,t._device=e,t}return p(i,Vc),v(i,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),i}());cc.GFXDevice=nh,cc.GFXBuffer=Y_,cc.GFXTexture=Xv,cc.GFXTextureView=H_,cc.GFXSampler=qv,cc.GFXShader=jv,cc.GFXInputAssembler=Uv,cc.GFXRenderPass=Hv,cc.GFXFramebuffer=Q_,cc.GFXPipelineLayout=Vv,cc.GFXPipelineState=X_,cc.GFXCommandBuffer=K_,cc.GFXQueue=Gv,Object.assign(cc,ih);var Yv,Kv,Qv,Zv,Jv,$v,em,tm,im,nm,rm,am=new yh,sm=function(){function t(e){y(this,t),this.batches=[],this.pass=void 0,this.pass=e}return v(t,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.splice(0)}},{key:"merge",value:function(e,t,i){var n=e.subMeshData.flatBuffers;if(0!==n.length){for(var r=0,a=0,s=n[0].count,o=i.pipelineLayout.layouts[0],l=!1,u=0;u<this.batches.length;++u){var c=this.batches[u];if(c.vbs.length===n.length&&c.mergeCount<yh.BATCHING_COUNT){l=!0;for(var h=0;h<c.vbs.length;++h){if(c.vbs[h].stride!==n[h].stride){l=!1;break}}if(l){for(var d=0;d<c.vbs.length;++d){var f=n[d],p=c.vbs[d],_=c.vbDatas[d];(r=(s+c.vbCount)*f.stride)>p.size&&(p.resize(r),_=c.vbDatas[d]=new Uint8Array(p.bufferView.buffer)),_.set(f.buffer,c.vbCount*f.stride)}(a=4*(s+c.vbCount))>c.vbIdx.size&&(c.vbIdx.resize(a),c.vbIdxData=new Float32Array(c.vbIdx.bufferView.buffer));var v=c.vbCount,m=v+s,y=c.vbIdxData,g=c.mergeCount;if(y[v]!==g||y[m-1]!==g)for(var b=v;b<m;b++)y[b]=g;return zn.toArray(c.uboData.view,t.model.transform.worldMatrix,yh.MAT_WORLDS_OFFSET+16*c.mergeCount),c.mergeCount||c.pso===i||(o.bindBuffer(ch.UBO_LOCAL_BATCHED,c.ubo),o.update(),c.pso=i),++c.mergeCount,c.vbCount+=s,void(c.ia.vertexCount+=s)}}}for(var x=this.pass.device,S=[],w=[],T=[],E=0;E<n.length;++E){var C=n[E],A=x.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:C.count*C.stride,stride:C.stride,flags:Pu.BAKUP_BUFFER});A.update(C.buffer.buffer),S.push(A),w.push(new Uint8Array(A.bufferView.buffer)),T.push(A)}var k=x.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:4*s,stride:4,flags:Pu.BAKUP_BUFFER}),R=new Float32Array(s);R.fill(0),k.update(R),T.push(k);for(var O=new Float32Array(k.bufferView.buffer),M=e.inputAssembler.attributes,I=new Array(M.length+1),L=0;L<M.length;++L)I[L]=M[L];I[M.length]={name:"a_dyn_batch_id",format:Ou.R32F,stream:n.length};var z=x.createInputAssembler({attributes:I,vertexBuffers:T}),B=this.pass.device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:yh.SIZE});o.bindBuffer(ch.UBO_LOCAL_BATCHED,B),o.update();var P=new yh;zn.toArray(P.view,t.model.transform.worldMatrix,yh.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:S,vbDatas:w,vbIdx:k,vbIdxData:O,vbCount:s,ia:z,ubo:B,uboData:P,pso:i})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}},{key:"clearUBO",value:function(){for(var e=0;e<this.batches.length;++e){this.batches[e].ubo.update(am.view.buffer)}}}]),t}(),om=(Yv=new Map,Kv=0,function(e){return"number"==typeof e?e:(Yv.has(e)||(Yv.set(e,1<<Kv),Kv++),Yv.get(e))}),lm={memUsage:zu.HOST|zu.DEVICE,size:0,usage:Iu.UNIFORM|Iu.TRANSFER_DST},um={bindings:null},cm={layouts:null},hm={primitive:0,shader:null,inputState:new function e(){y(this,e),this.attributes=[]},rasterizerState:null,depthStencilState:null,blendState:null,dynamicStates:null,layout:null,renderPass:null,hash:0,program:"",defines:null,stage:0},dm=function(){function w(e){y(this,w),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=om("default"),this._idxInTech=0,this._programName="",this._priority=lh.DEFAULT,this._primitive=Uu.TRIANGLE_LIST,this._stage=sh.DEFAULT,this._bindings=[],this._bs=new D_,this._dss=new q_,this._rs=new W_,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._device=void 0,this._renderPass=null,this._shader=null,this._batchedBuffer=null,this._device=e}return v(w,null,[{key:"createPasses",value:function(e,t){var i=t.techIdx,n=t.defines,r=t.states,a=e.techniques[i||0];if(!a)return[];for(var s=a.passes.length,o=[],l=0;l<s;++l){var u=a.passes[l],c=u.curDefs=n.length>l?n[l]:{};if(!u.switch||c[u.switch]){u.states=r.length>l?r[l]:{},u.idxInTech=l;var h=new w(cc.game._gfxDevice);h.initialize(u),o.push(h)}}return o}},{key:"fillinPipelineInfo",value:function(e,t){void 0!==t.priority&&(e._priority=t.priority),void 0!==t.primitive&&(e._primitive=t.primitive),void 0!==t.stage&&(e._stage=t.stage),void 0!==t.dynamicStates&&(e._dynamicStates=t.dynamicStates),t.customizations&&(e._customizations=t.customizations),t.phase&&(e._phase=om(t.phase));var i=e._bs;if(t.blendState){var n=Object.assign({},t.blendState);n.targets&&n.targets.forEach(function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new j_),e)}),delete n.targets,Object.assign(i,n)}Object.assign(e._rs,t.rasterizerState),Object.assign(e._dss,t.depthStencilState)}},{key:"getPSOHash",value:function(e){var t=Vh.getKey(e.program,e.defines),i="".concat(t,",").concat(e.stage,",").concat(e.primitive);return i+=function(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=",bt,".concat(s.blend,",").concat(s.blendEq,",").concat(s.blendAlphaEq,",").concat(s.blendColorMask),t+=",".concat(s.blendSrc,",").concat(s.blendDst,",").concat(s.blendSrcAlpha,",").concat(s.blendDstAlpha)}return t}(e.blendState),i+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(e.depthStencilState),xd(i+=function(e){return",rs,".concat(e.cullMode,",").concat(e.depthBias,",").concat(e.isFrontFaceCCW)}(e.rasterizerState),666)}}]),v(w,[{key:"initialize",value:function(e){this._idxInTech=e.idxInTech,this._programName=e.program,this._defines=e.curDefs,this._shaderInfo=Vh.getTemplate(e.program),this._properties=e.properties||this._properties;var t=this._device;w.fillinPipelineInfo(this,e),w.fillinPipelineInfo(this,e.states);for(var i=this._shaderInfo.blocks,n=0;n<i.length;n++){var r=i[n],a=r.size,s=r.binding;if(!dh(s)){lm.size=16*Math.ceil(a/16),this._buffers[s]=t.createBuffer(lm);var o=new ArrayBuffer(a);this._blocks[s]={buffer:o,dirty:!1,view:new Float32Array(o)}}}var l=this._handleMap=this._shaderInfo.handleMap,u={};for(var c in this._properties){var h=this._properties[c];h.handleInfo&&(u[c]=this.getHandle.apply(this,h.handleInfo))}Object.assign(l,u),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:0,r=2<arguments.length&&void 0!==i?i:ku.UNKNOWN,a=this._handleMap[e];if(a)return r?a=Eh(a,r):n&&(a=Eh(a,Th(a)-n)),a+n}},{key:"getBinding",value:function(e){var t=this.getHandle(e);if(void 0!==t)return w.getBindingFromHandle(t)}},{key:"setUniform",value:function(e,t){var i=w.getBindingFromHandle(e),n=w.getTypeFromHandle(e),r=w.getOffsetFromHandle(e),a=this._blocks[i];zh[n](a.view,t,r),a.dirty=!0}},{key:"getUniform",value:function(e,t){var i=w.getBindingFromHandle(e),n=w.getTypeFromHandle(e),r=w.getOffsetFromHandle(e),a=this._blocks[i];return Lh[n](a.view,t,r)}},{key:"setUniformArray",value:function(e,t){for(var i=w.getBindingFromHandle(e),n=w.getTypeFromHandle(e),r=Zc(n)>>2,a=this._blocks[i],s=w.getOffsetFromHandle(e),o=0;o<t.length;o++,s+=r)null!==t[o]&&zh[n](a.view,t[o],s);a.dirty=!0}},{key:"bindBuffer",value:function(e,t){if(this._buffers[e]!==t){this._buffers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindBuffer(e,t)}}}},{key:"bindTextureView",value:function(e,t){if(this._textureViews[e]!==t){this._textureViews[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindTextureView(e,t)}}}},{key:"bindSampler",value:function(e,t){if(this._samplers[e]!==t){this._samplers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindSampler(e,t)}}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){this._bs=new D_,this._dss=new q_,this._rs=new W_,w.fillinPipelineInfo(this,e),w.fillinPipelineInfo(this,t)}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}for(var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals,a=r.samplers.length,s=0;s<a;s++){var o=r.samplers[s],l=n.get(o.name);l.sampler&&this.bindSampler(l.samplerInfo.binding,l.sampler),this.bindTextureView(l.samplerInfo.binding,l.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;dh(r.binding)||this._buffers[r.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={},this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!dh(r.binding)){for(var a=this._blocks[r.binding],s=0,o=0;o<r.members.length;o++){for(var l=r.members[o],u=this._properties[l.name],c=u&&u.value,h=c||Bh[l.type],d=Zc(l.type)>>2,f=0;f<l.count;f++)a.view.set(h,s+f*d);s+=d*l.count}a.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._shaderInfo.samplers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!dh(r.binding)){var a=this._properties[r.name],s=a&&a.value?a.value+"-texture":Bh[r.type],o=G_.get(s),l=o&&o.getGFXTextureView();if(l){this._textureViews[r.binding]=l;for(var u=a&&void 0!==a.samplerHash?a.samplerHash:o.getSamplerHash(),c=this._samplers[r.binding]=Yd.getSampler(this._device,u),h=0;h<this._resources.length;h++){var d=this._resources[h];d.bindingLayout.bindSampler(r.binding,c),d.bindingLayout.bindTextureView(r.binding,l)}}else console.warn("illegal texture default value: "+s)}}}},{key:"tryCompile",value:function(e,t){var i=!(1<arguments.length&&void 0!==t)||t,n=cc.director.root.pipeline;if(!n)return null;if(this._renderPass=n.getRenderPass(this._stage),!this._renderPass)return console.warn("illegal pass stage."),null;var r=this._defines;e&&(i?Object.assign(this._defines,e):(Object.assign(e,this._defines),r=e));var a=Vh.getGFXShader(this._device,this._programName,r,n);if(!a)return console.warn("create shader ".concat(this._programName," failed")),null;i&&(this._shader=a);var s=this._shaderInfo,o=s.blocks,l=s.samplers;e:for(var u=this._bindings.length=0;u<o.length;u++){for(var c=o[u],h=0;h<c.defines.length;h++)if(!r[c.defines[h]])continue e;this._bindings.push(c)}e:for(var d=0;d<l.length;d++){for(var f=l[d],p=0;p<f.defines.length;p++)if(!r[f.defines[p]])continue e;this._bindings.push(f)}return a}},{key:"createPipelineState",value:function(e,t){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;var i=this._shader;e&&(i=this.tryCompile(e,!1)),um.bindings=this._bindings;var n=this._device.createBindingLayout(um);for(var r in this._buffers)n.bindBuffer(parseInt(r),this._buffers[r]);for(var a in this._samplers)n.bindSampler(parseInt(a),this._samplers[a]);for(var s in this._textureViews)n.bindTextureView(parseInt(s),this._textureViews[s]);var o=cc.director.root.pipeline.globalBindings,l=this._shaderInfo.builtins.globals,u=l.blocks,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var d;if(c){if(h>=u.length)break;d=u[h++]}else{if((h=u.next()).done)break;d=h.value}var f=d,p=o.get(f.name);p&&p.type===xc.UNIFORM_BUFFER?n.bindBuffer(p.blockInfo.binding,p.buffer):console.warn("builtin UBO '".concat(f.name,"' not available!"))}var _=l.samplers,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}var g=y,b=o.get(g.name);b&&b.type===xc.SAMPLER?(b.sampler&&n.bindSampler(b.samplerInfo.binding,b.sampler),n.bindTextureView(b.samplerInfo.binding,b.textureView)):console.warn("builtin texture '".concat(g.name,"' not available!"))}cm.layouts=[n];var x=this._device.createPipelineLayout(cm);hm.primitive=t&&t.primitive||this._primitive,hm.shader=i,hm.rasterizerState=t&&t.rasterizerState||this._rs,hm.depthStencilState=t&&t.depthStencilState||this._dss,hm.blendState=t&&t.blendState||this._bs,hm.dynamicStates=t&&t.dynamicStates||this._dynamicStates,hm.layout=x,hm.renderPass=this._renderPass,hm.program=this._programName,hm.defines=e||this._defines,hm.stage=this._stage,hm.hash=w.getPSOHash(hm);var S=this._device.createPipelineState(hm);return this._resources.push({bindingLayout:n,pipelineLayout:x,pipelineState:S}),S}},{key:"destroyPipelineState",value:function(t){var e=this._resources.findIndex(function(e){return e.pipelineState===t});if(0<=e){var i=this._resources[e],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(e,1)}}},{key:"createBatchedBuffer",value:function(){this._batchedBuffer||(this._batchedBuffer=new sm(this))}},{key:"clearBatchedBuffer",value:function(){this._batchedBuffer&&this._batchedBuffer.clearUBO()}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"customizations",get:function(){return this._customizations}},{key:"phase",get:function(){return this._phase}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"device",get:function(){return this._device}},{key:"bindings",get:function(){return this._bindings}},{key:"shader",get:function(){return this._shader}},{key:"renderPass",get:function(){return this._renderPass}},{key:"dynamics",get:function(){return this._dynamics}},{key:"batchedBuffer",get:function(){return this._batchedBuffer}},{key:"blocks",get:function(){return this._blocks}}]),w}();dm.getBindingTypeFromHandle=function(e){return(e&Mh)>>>28},dm.getTypeFromHandle=Th,dm.getBindingFromHandle=function(e){return(4177920&e)>>>14},dm.getOffsetFromHandle=function(e){return 16383&e};var fm=q3("Material",(Qv=oo("cc.Material"),Zv=lo(bd),Qv((em=b(($v=function(){function r(){var e;return y(this,r),m(e=x(this,g(r).call(this)),"_effectAsset",em,l(e)),m(e,"_techIdx",tm,l(e)),m(e,"_defines",im,l(e)),m(e,"_states",nm,l(e)),m(e,"_props",rm,l(e)),e._passes=[],e._owner=null,e._hash=0,e.loaded=!1,e}return p(r,rd),v(r,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}}],[{key:"getInstantiatedMaterial",value:function(e,t,i){if(e._owner===t)return e;var n=new r;return n.copy(e),n._native=e._native+" (Instance)",n._owner=t,i&&(n._uuid=e._uuid),n}}]),v(r,[{key:"reset",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=bd.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"initialize",value:function(e){this.reset(e)}},{key:"destroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}return this._passes=[],this._effectAsset=null,this._props=[],this._defines=[],this._states=[],_(g(r.prototype),"destroy",this).call(this)}},{key:"resetUniforms",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;this._props.length=this._passes.length;for(var i=0;i<this._props.length;i++)this._props[i]={};if(t){var n=this._passes,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.resetUBOs(),o.resetTextures()}}}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this._effectAsset){if(void 0===t){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.tryCompile(e)}}else this._passes[t].tryCompile(e);this._onPassesChange()}}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this._effectAsset){var i=this._effectAsset.techniques[this._techIdx].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n];this._states[n]=e,r.overridePipelineStates(i[r.idxInTech],e)}else this._states[t]=e,this._passes[t].overridePipelineStates(i[t],e);this._onPassesChange()}}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,s=0;s<a;s++){var o=r[s];this._uploadProperty(o,e,t)&&(this._props[s][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var a=i[r];for(var s in a)if(s===e)return a[s]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var o=this._props[t];for(var l in o)if(l===e)return o[l]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=Object.assign({},e._states[n]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;++n)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_update",value:function(e){var r=this,t=!(0<arguments.length&&void 0!==e)||e;if(this._effectAsset){if(this._passes&&this._passes.length){var i=this._passes,n=Array.isArray(i),a=0;for(i=n?i:i[Symbol.iterator]();;){var s;if(n){if(a>=i.length)break;s=i[a++]}else{if((a=i.next()).done)break;s=a.value}s.destroy()}}this._passes=dm.createPasses(this._effectAsset,{techIdx:this._techIdx,defines:this._defines,states:this._states});var o=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=o,t)this._passes.forEach(function(e,t){var i=r._props[e.idxInTech];for(var n in i=i||(r._props[t]={})){i[n]&&r._uploadProperty(e,n,i[n])}});else for(var l=0;l<this._props.length;l++)this._props[l]={}}else{var u=G_.get("missing-effect-material");u&&(this._passes=u._passes.slice())}this._onPassesChange()}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=dm.getBindingTypeFromHandle(n);if(r===xc.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):e.setUniform(n,i);else if(r===xc.SAMPLER){var a=dm.getBindingFromHandle(n);if(i instanceof H_)e.bindTextureView(a,i);else if(i instanceof Qd||i instanceof yf){var s=i.getGFXTextureView();if(!s||!s.texture.width||!s.texture.height)return!1;e.bindTextureView(a,s),i instanceof Qd&&e.bindSampler(a,Yd.getSampler(cc.game._gfxDevice,i.getSamplerHash()))}}return!0}},{key:"_onPassesChange",value:function(){var t=this,e="",i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e+=dm.getPSOHash(s)}if(this._hash=xd(e,666),this._owner){var o=this._owner,l=o.sharedMaterials.findIndex(function(e){return e===t});0<=l&&o._onRebuildPSO(l,this)}}}]),r}()).prototype,"_effectAsset",[Zv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tm=b($v.prototype,"_techIdx",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),im=b($v.prototype,"_defines",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nm=b($v.prototype,"_states",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rm=b($v.prototype,"_props",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jv=$v))||Jv));cc.Material=fm;var pm=function(){function t(){y(this,t),this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.setting=void 0,this.image=void 0,this.device=void 0,this.cmdBuff=void 0,this.assmebler=void 0,this.vertexBuffers=void 0,this.indicesBuffers=void 0,this.pso=void 0,this.framebuffer=void 0,this.renderArea=void 0,this.region=void 0,this.material=void 0,this.texture=void 0,this.textureView=void 0,this.clearColors=void 0,this._splashFinish=!1,this._loadFinish=!1,this.textImg=void 0,this.textRegion=void 0,this.textTexture=void 0,this.textTextureView=void 0,this.textVB=void 0,this.textIB=void 0,this.textAssmebler=void 0,this.textMaterial=void 0,this.textPSO=void 0,this.program=void 0,this.effect=void 0,this.screenWidth=void 0,this.screenHeight=void 0}return v(t,[{key:"main",value:function(e){if(window._CCSettings&&window._CCSettings.splashScreen?(this.setting=window._CCSettings.splashScreen,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=null!=this.setting.base64src?this.setting.base64src:"",this.setting.effect=null!=this.setting.effect?this.setting.effect:"Fade-InOut",this.setting.clearColor=null!=this.setting.clearColor?this.setting.clearColor:{r:.88,g:.88,b:.88,a:1},this.setting.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,this.setting.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark):this.setting={totalTime:3e3,base64src:"",effect:"Fade-InOut",clearColor:{r:.88,g:.88,b:.88,a:1},displayRatio:.4,displayWatermark:!0},""==this.setting.base64src||this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void delete t._ins;cc.game.once(cc.Game.EVENT_GAME_INITED,function(){cc.director._lateUpdate=performance.now()},cc.director),this.program={name:"util/splash-image",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/splash-image|splash-vs:vert|splash-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},u_precent:{type:13}}}]}],shaders:[{name:"util/splash-image|splash-vs:vert|splash-fs:frag",hash:2381344969,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},this.effect=new bd,this.effect.name=this.program.name,this.effect.techniques=this.program.techniques,this.effect.shaders=this.program.shaders,this.effect.onLoaded(),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.clearColors=[this.setting.clearColor],this.device=e,this.screenWidth=this.device.width,this.screenHeight=this.device.height,this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}},{key:"setOnFinish",value:function(e){this.callBack=e}},{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide())}},{key:"init",value:function(){var r=this;this.initCMD(),this.initIA(),this.initPSO(),this.setting.displayWatermark&&this.initText();this.handle=requestAnimationFrame(function e(t){if(!r.cancelAnimate){r.startTime<0&&(r.startTime=t);var i=t-r.startTime,n=jl(_i(i/r.setting.totalTime));r.material.setProperty("u_precent",n),r.material.passes[0].update(),r.setting.displayWatermark&&r.textMaterial&&(r.textMaterial.setProperty("u_precent",n),r.textMaterial.passes[0].update()),r.frame(t),i>r.setting.totalTime&&(r.splashFinish=!0),requestAnimationFrame(e)}})}},{key:"hide",value:function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,this.destoy()}},{key:"frame",value:function(e){var t=this.device,i=this.cmdBuff,n=this.framebuffer,r=this.renderArea;i.begin(),i.beginRenderPass(n,r,Nc.ALL,this.clearColors,1,0),i.bindPipelineState(this.pso),i.bindBindingLayout(this.pso.pipelineLayout.layouts[0]),i.bindInputAssembler(this.assmebler),i.draw(this.assmebler),this.setting.displayWatermark&&this.textPSO&&this.textAssmebler&&(i.bindPipelineState(this.textPSO),i.bindBindingLayout(this.textPSO.pipelineLayout.layouts[0]),i.bindInputAssembler(this.textAssmebler),i.draw(this.textAssmebler)),i.endRenderPass(),i.end(),t.queue.submit([i]),t.present()}},{key:"initText",value:function(){this.textImg=document.createElement("canvas"),this.textImg.width=300,this.textImg.height=30,this.textImg.style.width="".concat(this.textImg.width),this.textImg.style.height="".concat(this.textImg.height);var e=this.textImg.getContext("2d");e.font="".concat(18,"px Arial"),e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`",e.fillText("Powered by Cocos Creator 3D",30,8),this.textRegion=new jc,this.textRegion.texExtent.width=this.textImg.width,this.textRegion.texExtent.height=this.textImg.height,this.textRegion.texExtent.depth=1,this.textTexture=this.device.createTexture({type:lc.TEX2D,usage:hc.SAMPLED,format:Ou.RGBA8,width:this.textImg.width,height:this.textImg.height,mipLevel:1}),this.textTextureView=this.device.createTextureView({texture:this.textTexture,type:mc.TV2D,format:Ou.RGBA8}),this.device.copyTexImagesToTexture([this.textImg],this.textTexture,[this.textRegion]),this.textMaterial=new fm,this.textMaterial.initialize({effectAsset:this.effect});var t=this.textMaterial.passes[0],i=t.getBinding("mainTexture");t.bindTextureView(i,this.textTextureView),this.textPSO=t.createPipelineState(),this.textPSO.pipelineLayout.layouts[0].update();var n=4*Float32Array.BYTES_PER_ELEMENT,r=4*n;this.textVB=this.device.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:r,stride:n});var a=new Float32Array(16),s=-this.textImg.width/2,o=-this.textImg.height/2;o=this.screenWidth<this.screenHeight?(s=-this.screenWidth/2*.5)/(this.textImg.width/this.textImg.height):(s=-this.screenHeight/2*.5)/(this.textImg.width/this.textImg.height);var l=0;a[l++]=s,a[l++]=o,a[l++]=0,a[l++]=1,a[l++]=-s,a[l++]=o,a[l++]=1,a[l++]=1,a[l++]=s,a[l++]=-o,a[l++]=0,a[l++]=0,a[l++]=-s,a[l++]=-o,a[l++]=1;for(var u=a[l++]=0;u<a.length;u+=4)a[u]=a[u]+this.screenWidth/2,a[u+1]=a[u+1]+.1*this.screenHeight;for(var c=0;c<a.length;c+=4)a[c]=a[c]/this.screenWidth*2-1,a[c+1]=a[c+1]/this.screenHeight*2-1;this.textVB.update(a);var h=Uint8Array.BYTES_PER_ELEMENT,d=6*h;this.textIB=this.device.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:d,stride:h});var f=new Uint8Array(6);f[0]=0,f[1]=1,f[2]=2,f[3]=1,f[4]=3,f[5]=2,this.textIB.update(f);var p=[{name:"a_position",format:Ou.RG32F},{name:"a_texCoord",format:Ou.RG32F}];this.textAssmebler=this.device.createInputAssembler({attributes:p,vertexBuffers:[this.textVB],indexBuffer:this.textIB})}},{key:"initCMD",value:function(){var e=this.device;this.renderArea={x:0,y:0,width:e.width,height:e.height},this.framebuffer=e.mainWindow.framebuffer,this.cmdBuff=e.createCommandBuffer({allocator:e.commandAllocator,type:wc.PRIMARY})}},{key:"initIA",value:function(){var e=this.device,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t;this.vertexBuffers=e.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:i,stride:t});var n=new Float32Array(16),r=-this.image.width/2,a=-this.image.height/2;a=this.screenWidth<this.screenHeight?(r=-this.screenWidth/2*this.setting.displayRatio)/(this.image.width/this.image.height):(r=-this.screenHeight/2*this.setting.displayRatio)/(this.image.width/this.image.height);var s=0;n[s++]=r,n[s++]=a,n[s++]=0,n[s++]=1,n[s++]=-r,n[s++]=a,n[s++]=1,n[s++]=1,n[s++]=r,n[s++]=-a,n[s++]=0,n[s++]=0,n[s++]=-r,n[s++]=-a,n[s++]=1;for(var o=n[s++]=0;o<n.length;o+=4)n[o]=n[o]+this.screenWidth/2,n[o+1]=n[o+1]+this.screenHeight/2;for(var l=0;l<n.length;l+=4)n[l]=n[l]/this.screenWidth*2-1,n[l+1]=n[l+1]/this.screenHeight*2-1;this.vertexBuffers.update(n);var u=Uint8Array.BYTES_PER_ELEMENT,c=6*u;this.indicesBuffers=e.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:c,stride:u});var h=new Uint8Array(6);h[0]=0,h[1]=1,h[2]=2,h[3]=1,h[4]=3,h[5]=2,this.indicesBuffers.update(h);var d=[{name:"a_position",format:Ou.RG32F},{name:"a_texCoord",format:Ou.RG32F}];this.assmebler=e.createInputAssembler({attributes:d,vertexBuffers:[this.vertexBuffers],indexBuffer:this.indicesBuffers})}},{key:"initPSO",value:function(){var e=this.device;this.material=new fm,this.material.initialize({effectAsset:this.effect}),this.texture=e.createTexture({type:lc.TEX2D,usage:hc.SAMPLED,format:Ou.RGBA8,width:this.image.width,height:this.image.height,mipLevel:1}),this.textureView=e.createTextureView({texture:this.texture,type:mc.TV2D,format:Ou.RGBA8});var t=this.material.passes[0],i=t.getBinding("mainTexture");t.bindTextureView(i,this.textureView),this.pso=t.createPipelineState(),this.pso.pipelineLayout.layouts[0].update(),this.region=new jc,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,e.copyTexImagesToTexture([this.image],this.texture,[this.region])}},{key:"destoy",value:function(){this.callBack=null,this.clearColors=null,this.device=null,this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.program=null,this.effect.destroy(),this.effect=null,this.cmdBuff.destroy(),this.cmdBuff=null,this.pso.destroy(),this.pso=null,this.material.destroy(),this.material=null,this.textureView.destroy(),this.textureView=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.setting.displayWatermark&&this.textImg&&(this.textImg=null,this.textRegion=null,this.textPSO.destroy(),this.textPSO=null,this.textMaterial.destroy(),this.textMaterial=null,this.textTextureView.destroy(),this.textTextureView=null,this.textTexture.destroy(),this.textTexture=null,this.textAssmebler.destroy(),this.textAssmebler=null,this.textVB.destroy(),this.textVB=null,this.textIB.destroy(),this.textIB=null),this.setting=null,delete t._ins}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==t._ins&&(t._ins=new t),t._ins}}]),t}();pm._ins=void 0;var _m=q3("Game",function(){function f(){var e,t;y(this,f);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(f)).call.apply(e,[this].concat(n)))).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=_(g(f.prototype),"on",l(t)),t.eventTargetOnce=_(g(f.prototype),"once",l(t)),t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._prepared=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t._lastTime=null,t._frameTime=null,t._sceneInfos=[],t.collisionMatrix=[],t.groupList=[],t}return p(f,Ml),v(f,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0)}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()})}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,t,i){this._prepared&&e===f.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i)}},{key:"once",value:function(e,t,i){this._prepared&&e===f.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"run",value:function(e,t){this._initConfig(e),this._initRenderer(),this.onStart=t,pm.instance.main(this._gfxDevice),this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void B(3801);if(e.parent!==i)return void B(3802)}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0}}else B(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(t){if(this._prepared)t&&t();else{var e=this.config.jsList;if(e&&0<e.length){var i=this;cc.loader.load(e,function(e){if(e)throw new Error(JSON.stringify(e));i._prepareFinished(t)})}else this._prepareFinished(t)}}},{key:"_initEngine",value:function(){this._initEvents(),this.emit(f.EVENT_ENGINE_INITED)}},{key:"_prepareFinished",value:function(e){var t=this;this._prepared=!0,this._initEngine(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION);function i(){t._setAnimFrame(),t._runMainLoop(),t.emit(f.EVENT_GAME_INITED),e&&e()}pm.instance.setOnFinish(i),pm.instance.loadFinish=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,window.cancelAnimationFrame=this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(function(){e()},i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var t,i=this,e=i.config,n=cc.director,r=!0,a=e.frameRate;W(!!e.showFPS),t=function(e){if(!i._paused){if(i._intervalId=window.requestAnimationFrame(t),30===a&&(r=!r))return;n.mainLoop(e)}},i._intervalId=window.requestAnimationFrame(t),i._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||2<t||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],R(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode);this.renderType=f.RENDER_TYPE_CANVAS;var i=!1;if(0===t?cc.sys.capabilities.opengl?(this.renderType=f.RENDER_TYPE_WEBGL,i=!0):cc.sys.capabilities.canvas&&(this.renderType=f.RENDER_TYPE_CANVAS,i=!0):1===t&&cc.sys.capabilities.canvas?(this.renderType=f.RENDER_TYPE_CANVAS,i=!0):2===t&&cc.sys.capabilities.opengl&&(this.renderType=f.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(G(3820,t))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e,t,i,n,r,a,s=this.config.id,o=cc.sys.platform===cc.sys.WECHAT_GAME,l=cc.sys.platform===cc.sys.QQ_PLAY;if(o)this.container=n=document.createElement("div"),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,i=cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?window.sharedCanvas||wx.getSharedCanvas():window.canvas,this.canvas=i;else if(l)this.container=cc.container=document.createElement("div"),this.frame=document.documentElement,this.canvas=i=window.canvas;else{var u=s?s instanceof HTMLElement?s:document.querySelector(s)||document.querySelector("#"+s):null;if(!u)throw new Error(G(200));"CANVAS"===u.tagName?(e=u.width,t=u.height,this.canvas=i=u,this.container=n=document.createElement("div"),i&&i.parentNode&&i.parentNode.insertBefore(n,i)):("DIV"!==u.tagName&&B(3819),e=u.clientWidth,t=u.clientHeight,this.canvas=i=document.createElement("canvas"),this.container=n=document.createElement("div"),u.appendChild(n)),n.setAttribute("id","Cocos3dGameContainer"),n.appendChild(i),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,a="gameCanvas",-1<(" "+(r=i).className+" ").indexOf(" "+a+" ")||(r.className&&(r.className+=" "),r.className+=a),i.setAttribute("width",e||"480"),i.setAttribute("height",t||"320"),i.setAttribute("tabindex","99")}if(this._determineRenderType(),this.renderType===f.RENDER_TYPE_WEBGL){var c=!!window.WebGL2RenderingContext,h=navigator.userAgent.toLowerCase();-1!==h.indexOf("safari")&&-1===h.indexOf("chrome")&&(c=!1),c&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var d={canvasElm:i,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(d)&&c&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(d))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=f.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1},this._rendererInitialized=!0,this.emit(f.EVENT_RENDERER_INITED)}}},{key:"_initEvents",value:function(){var i,e=window;void 0!==document.hidden?i="hidden":void 0!==document.mozHidden?i="mozHidden":void 0!==document.msHidden?i="msHidden":void 0!==document.webkitHidden&&(i="webkitHidden");var t=!1;function n(){t||(t=!0,cc.game.emit(f.EVENT_HIDE))}function r(){t&&(t=!1,cc.game.emit(f.EVENT_SHOW))}if(i)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<a.length;s++)document.addEventListener(a[s],function(e){var t=document[i];(t=t||e.hidden)?n():r()});else e.addEventListener("blur",n),e.addEventListener("focus",r);-1<navigator.userAgent.indexOf("MicroMessenger")&&(e.onfocus=r),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&(wx.onShow&&wx.onShow(r),wx.onHide&&wx.onHide(n)),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",n),e.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r)),this.on(f.EVENT_HIDE,function(){cc.game.pause()}),this.on(f.EVENT_SHOW,function(){cc.game.resume()})}}]),f}());_m.EVENT_HIDE="game_on_hide",_m.EVENT_SHOW="game_on_show",_m.EVENT_GAME_INITED="game_inited",_m.EVENT_ENGINE_INITED="engine_inited",_m.EVENT_RENDERER_INITED="renderer_inited",_m.RENDER_TYPE_CANVAS=0,_m.RENDER_TYPE_WEBGL=1,_m.RENDER_TYPE_OPENGL=2,cc.Game=_m;var vm=q3("game",cc.game=new _m),mm=new(function(){function e(){y(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return v(e,[{key:"init",value:function(){0}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(cc.sys.os===cc.sys.OS_IOS&&(mm.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?mm.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:mm.adaptationType=cc.sys.BROWSER_TYPE_WECHAT_GAME,mm.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:mm.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_UC:mm.availWidth=function(e){return e.clientWidth},mm.availHeight=function(e){return e.clientHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME:mm.availWidth=function(){return window.innerWidth},mm.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var ym=window.sharedCanvas||wx.getSharedCanvas();mm.availWidth=function(){return ym.width},mm.availHeight=function(){return ym.height}}var gm=null,bm=q3("View",function(){function n(){var e;y(this,n),(e=x(this,g(n).call(this)))._frameSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0,e._resizeWithBrowserSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0;l(e);var t=xm,i=Sm;return e._frameSize=new qn(0,0),e._designResolutionSize=new qn(0,0),e._originalDesignResolutionSize=new qn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Zn(0,0,0,0),e._visibleRect=new Zn(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new wm(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new wm(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new wm(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new wm(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new wm(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),cc.game.once(cc.Game.EVENT_ENGINE_INITED,e.init,l(e)),e}return p(n,Ml),v(n,[{key:"init",value:function(){mm.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===cc.Game.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===cc.Game.RENDER_TYPE_CANVAS){var s=cc.game.canvas.getContext("2d");s.imageSmoothingEnabled=e,s.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof wm)t._resolutionPolicy=e;else{var i=wm;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(0<e||0<t){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,s=this._visibleRect,o=r.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY;cc.game._renderContext.viewport(e*r+this._viewportRect.x,t*a+this._viewportRect.y,i*r,n*a)}},{key:"setScissorInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY,s=Math.ceil(e*r+this._viewportRect.x),o=Math.ceil(t*a+this._viewportRect.y),l=Math.ceil(i*r),u=Math.ceil(n*a),c=cc.game._renderContext;if(!gm){var h=c.getParameter(c.SCISSOR_BOX);gm=new Zn(h[0],h[1],h[2],h[3])}gm.x===s&&gm.y===o&&gm.width===l&&gm.height===u||(gm.x=s,gm.y=o,gm.width=l,gm.height=u,c.scissor(s,o,l,u))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!gm){var t=e.getParameter(e.SCISSOR_BOX);gm=new Zn(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,n=1/this._scaleY;return new Zn((gm.x-this._viewportRect.x)*i,(gm.y-this._viewportRect.y)*n,gm.width*i,gm.height*n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||cc.v2(),a=this._devicePixelRatio*(e-i.left),s=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-s,r.y=a):(r.x=a,r.y=s),r}},{key:"_resizeEvent",value:function(){var e,t=(e=this.setDesignResolutionSize?this:cc.view)._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(cc.sys.isMobile){var r=cc.game.container.style,a=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=a,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var s=e._originalDesignResolutionSize.width,o=e._originalDesignResolutionSize.height;e._resizing=!0,0<s&&e.setDesignResolutionSize(s,o,e._resolutionPolicy),e._resizing=!1,e._resizeCallback&&e._resizeCallback.call()}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=mm.availWidth(cc.game.frame),i=mm.availHeight(cc.game.frame),n=i<=t;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(function(){cc.view._orientationChanging=!1},1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,s=document.getElementsByName("viewport"),o=s?s[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport,0}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,s=0;s<e.length;s++){var o=e[s];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),n}());bm.instance=void 0;var xm=function(){function e(){y(this,e),this.name="ContainerStrategy"}return v(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();xm.EQUAL_TO_FRAME=void 0,xm.PROPORTION_TO_FRAME=void 0;var Sm=function(){function e(){y(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return v(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var s=new Zn(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,a],this._result.viewport=s,this._result}}]),e}();Sm.EXACT_FIT=void 0,Sm.SHOW_ALL=void 0,Sm.NO_BORDER=void 0,Sm.FIXED_HEIGHT=void 0,Sm.FIXED_WIDTH=void 0,function(){var e=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="EqualToFrame",t}return p(a,xm),v(a,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),a}(),t=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ProportionalToFrame",t}return p(a,xm),v(a,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,s=cc.game.container.style,o=t.width,l=t.height,u=r/o,c=a/l;n=u<c?(i=r,l*u):(i=o*c,a);var h=Math.round((r-i)/2),d=Math.round((a-n)/2);i=r-2*h,n=a-2*d,this._setupContainer(e,i,n),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=h+"px",s.paddingRight=h+"px",s.paddingTop=d+"px",s.paddingBottom=d+"px"}}]),a}();xm.EQUAL_TO_FRAME=new e,xm.PROPORTION_TO_FRAME=new t;var i=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ExactFit",t}return p(a,Sm),v(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),a}(),n=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ShowAll",t}return p(a,Sm),v(a,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,s=t.width,o=t.height,l=r/s,u=a/o,c=0;return n=l<u?(i=r,o*(c=l)):(i=s*(c=u),a),this._buildResult(r,a,i,n,c,c)}}]),a}(),r=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="NoBorder",t}return p(a,Sm),v(a,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,s=cc.game.canvas.height,o=t.width,l=t.height,u=a/o,c=s/l;return r=u<c?(n=o*(i=c),s):(n=a,l*(i=u)),this._buildResult(a,s,n,r,i,i)}}]),a}(),a=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="FixedHeight",t}return p(a,Sm),v(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}(),s=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="FixedWidth",t}return p(a,Sm),v(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}();Sm.EXACT_FIT=new i,Sm.SHOW_ALL=new n,Sm.NO_BORDER=new r,Sm.FIXED_HEIGHT=new a,Sm.FIXED_WIDTH=new s}();var wm=q3("ResolutionPolicy",function(){function i(e,t){y(this,i),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}return v(i,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof xm&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof Sm&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),i}());wm.EXACT_FIT=void 0,wm.SHOW_ALL=void 0,wm.NO_BORDER=void 0,wm.FIXED_HEIGHT=void 0,wm.FIXED_WIDTH=void 0,wm.UNKNOWN=void 0,wm.ContainerStrategy=void 0,wm.ContentStrategy=void 0,wm.EXACT_FIT=0,wm.NO_BORDER=1,wm.SHOW_ALL=2,wm.FIXED_HEIGHT=3,wm.FIXED_WIDTH=4,wm.UNKNOWN=5,wm.ContainerStrategy=xm,wm.ContentStrategy=Sm,cc.ResolutionPolicy=wm;var Tm=q3("view",bm.instance=cc.view=new bm);cc.winSize=cc.v2();var Em=new Mi,Cm=q3("Touch",function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;y(this,n),this._point=new Mi,this._prevPoint=new Mi,this._lastModified=0,this._id=null,this._startPoint=new Mi,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}return v(n,[{key:"getLocation",value:function(e){return(e=e||new Mi).set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return(e=e||new Mi).set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return(e=e||new Mi).set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return(e=e||new Mi).set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return(e=e||new Mi).set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return(e=e||new Mi).set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return(e=e||new Mi).set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e=e||new Mi,Em.set(this._point),Em.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),Mi.divide(e,Em,e),e}},{key:"getLocationInView",value:function(e){return(e=e||new Mi).set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return(e=e||new Mi).set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return(e=e||new Mi).set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(e,t,i){var n=0<arguments.length&&void 0!==e?e:null,r=1<arguments.length?t:void 0,a=2<arguments.length?i:void 0;this._prevPoint=this._point,this._point=new Mi(r||0,a||0),this._id=n,this._startPointCaptured||(this._startPoint=new Mi(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,t){"object"===_e(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0)}},{key:"_setPrevPoint",value:function(e,t){"object"===_e(e)?this._prevPoint=new Mi(e.x,e.y):this._prevPoint=new Mi(e||0,t||0)}}]),n}());cc.Touch=Cm;function Am(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,Am),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}var km,Rm=Vl.TOUCH_TIMEOUT,Om=new Mi,Mm=new Mi,Im=new(function(){function e(){y(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Mi,this._prevMousePoint=new Mi,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return v(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=Ll.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s)if(void 0===i[s]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}var l=new Cm(a._point.x,a._point.y,a.getID());(this._touches[o]=l)._lastModified=n,l._setPrevPoint(a._prevPoint),i[s]=o,t.push(l)}}if(0<t.length){var u=new Tf(t);u._eventCode=Tf.BEGAN,Nf.dispatchEvent(u)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=Ll.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=this._touchesIntegerDict[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),i[o]._lastModified=n,t.push(i[o]))}}if(0<t.length){var l=new Tf(t);l._eventCode=Tf.MOVED,Nf.dispatchEvent(l)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Tf(t);i._eventCode=Tf.ENDED,Nf.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Tf(t);i._eventCode=Tf.CANCELLED,Nf.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=n[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),t.push(i[o]),this._removeUsedIndexBit(o),delete n[s])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(Ll.platform===Ll.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=window.pageXOffset-t.clientLeft,n=window.pageYOffset-t.clientTop;if(e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){t=i[r];break}return t=t||e}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var s=new Cm(a.x,a.y,0);return s._setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,s}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new wf(i);return r._setPrevCursor(n.x,n.y),n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(Ll.platform===Ll.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,s=0;s<a;s++){var o=e.changedTouches[s];if(o){var l=void 0;l=Ll.BROWSER_TYPE_FIREFOX===Ll.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,Om):n.convertToLocationInView(o.clientX,o.clientY,t,Om);var u=void 0;null!=o.identifier?(u=new Cm(l.x,l.y,o.identifier),this.getPreTouch(u).getLocation(Mm),u._setPrevPoint(Mm.x,Mm.y),this.setPreTouch(u)):(u=new Cm(l.x,l.y))._setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(u)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=cc.view;var t=Ll.isMobile,i="mouse"in Ll.capabilities,n="touches"in Ll.capabilities;Ll.platform===Ll.WECHAT_GAME&&(i=!(n=!(t=!1))),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var s=e;i=(s.gamma||0)/90*.981,n=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,Nf.dispatchEvent(new Ef(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n._lastModified>Rm){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){function e(){var e=cc.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1}var t=this;"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}},{key:"_registerWindowMouseEvents",value:function(r){var a=this;window.addEventListener("mousedown",function(){a._mousePressed=!0},!1),window.addEventListener("mouseup",function(e){if(a._mousePressed){a._mousePressed=!1;var t=a.getHTMLElementPosition(r),i=a.getPointByEvent(e,t);if(!Jn(t.left,t.top,t.width,t.height).contains(new Mi(i.x,i.y))){a.handleTouchesEnd([a.getTouchByXY(e,i.x,i.y,t)]);var n=a.getMouseEvent(i,t,wf.UP);n.setButton(e.button),Nf.dispatchEvent(n)}}},!1)}},{key:"_registerElementMouseEvents",value:function(s,e){function t(e,r,a){s.addEventListener(e,function(e){var t=o.getHTMLElementPosition(s),i=o.getPointByEvent(e,t),n=o.getMouseEvent(i,t,r);n.setButton(e.button),a(e,n,i,t),Nf.dispatchEvent(n),e.stopPropagation(),e.preventDefault()})}var o=this;e||(t("mousedown",wf.DOWN,function(e,t,i,n){o._mousePressed=!0,o.handleTouchesBegin([o.getTouchByXY(e,i.x,i.y,n)]),s.focus()}),t("mouseup",wf.UP,function(e,t,i,n){o._mousePressed=!1,o.handleTouchesEnd([o.getTouchByXY(e,i.x,i.y,n)])}),t("mousemove",wf.MOVE,function(e,t,i,n){o.handleTouchesMove([o.getTouchByXY(e,i.x,i.y,n)]),o._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),t("mousewheel",wf.SCROLL,function(e,t,i,n){t.setScrollData(0,e.wheelDelta)}),t("DOMMouseScroll",wf.SCROLL,function(e,t,i,n){t.setScrollData(0,-120*e.detail)})}},{key:"_registerMousePointerEvents",value:function(n){function e(e){var i=t[e];n.addEventListener(e,function(e){var t=r.getHTMLElementPosition(n);t.left-=document.documentElement.scrollLeft,t.top-=document.documentElement.scrollTop,i.call(r,[r.getTouchByXY(e,e.clientX,e.clientY,t)]),e.stopPropagation()},!1)}var r=this,t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel};for(var i in t)e(i)}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(r){function e(n){return function(e){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t))}}var a=this;wx.onTouchStart(e(function(e){a.handleTouchesBegin(e)})),wx.onTouchEnd(e(function(e){a.handleTouchesEnd(e)})),wx.onTouchMove(e(function(e){a.handleTouchesMove(e)})),wx.onTouchCancel(e(function(e){a.handleTouchesCancel(e)}))}},{key:"_registerHTMLTouchEvents",value:function(r){function e(n){return function(e){if(e.changedTouches){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t)),e.stopPropagation(),e.preventDefault()}}}var a=this;r.addEventListener("touchstart",e(function(e){a.handleTouchesBegin(e),Ll.platform!==Ll.WECHAT_GAME&&r.focus()}),!1),r.addEventListener("touchmove",e(function(e){a.handleTouchesMove(e)}),!1),r.addEventListener("touchend",e(function(e){a.handleTouchesEnd(e)}),!1),r.addEventListener("touchcancel",e(function(e){a.handleTouchesCancel(e)}),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",function(e){Nf.dispatchEvent(new Cf(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",function(e){Nf.dispatchEvent(new Cf(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new Am,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),km=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,km,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";km&&window.removeEventListener(e,km,!1)}}]),e}());vm.on(_m.EVENT_ENGINE_INITED,function(){vm.config.registerSystemEvent&&Im.registerSystemEvent(vm.canvas)}),cc.internal.inputManager=Im;var Lm=null,zm=null,Bm=null,Pm=null,Dm=q3("SystemEvent",function(){function f(){return y(this,f),x(this,g(f).call(this))}return p(f,Ml),v(f,[{key:"setAccelerometerEnabled",value:function(e){Im.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){Im.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i){return _(g(f.prototype),"on",this).call(this,e,t,i),e!==gf.KEY_DOWN&&e!==gf.KEY_UP||Lm||(Lm=Af.create({event:Af.KEYBOARD,onKeyPressed:function(e,t){t.type=gf.KEY_DOWN,Fm.emit(t.type,t)},onKeyReleased:function(e,t){t.type=gf.KEY_UP,Fm.emit(t.type,t)}}),Nf.addListener(Lm,256)),e===gf.DEVICEMOTION&&(zm||(zm=Af.create({event:Af.ACCELERATION,callback:function(e,t){t.type=gf.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),Nf.addListener(zm,256))),e!==gf.TOUCH_START&&e!==gf.TOUCH_MOVE&&e!==gf.TOUCH_END&&e!==gf.TOUCH_CANCEL||Bm||(Bm=Af.create({event:Af.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=gf.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=gf.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=gf.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=gf.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),Nf.addListener(Bm,256)),e!==gf.MOUSE_DOWN&&e!==gf.MOUSE_MOVE&&e!==gf.MOUSE_UP&&e!==gf.MOUSE_WHEEL||Pm||(Pm=Af.create({event:Af.MOUSE,onMouseDown:function(e){e.type=gf.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=gf.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=gf.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=gf.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),Nf.addListener(Pm,256)),t}},{key:"off",value:function(e,t,i){if(_(g(f.prototype),"off",this).call(this,e,t,i),Lm&&(e===gf.KEY_DOWN||e===gf.KEY_UP)){var n=this.hasEventListener(gf.KEY_DOWN),r=this.hasEventListener(gf.KEY_UP);n||r||(Nf.removeListener(Lm),Lm=null)}if(zm&&e===gf.DEVICEMOTION&&(Nf.removeListener(zm),zm=null),Bm&&(e===gf.TOUCH_START||e===gf.TOUCH_MOVE||e===gf.TOUCH_END||e===gf.TOUCH_CANCEL)){var a=this.hasEventListener(gf.TOUCH_START),s=this.hasEventListener(gf.TOUCH_MOVE),o=this.hasEventListener(gf.TOUCH_END),l=this.hasEventListener(gf.TOUCH_CANCEL);a||s||o||l||(Nf.removeListener(Bm),Bm=null)}if(Pm&&(e===gf.MOUSE_DOWN||e===gf.MOUSE_MOVE||e===gf.MOUSE_UP||e===gf.MOUSE_WHEEL)){var u=this.hasEventListener(gf.MOUSE_DOWN),c=this.hasEventListener(gf.MOUSE_MOVE),h=this.hasEventListener(gf.MOUSE_UP),d=this.hasEventListener(gf.MOUSE_WHEEL);u||c||h||d||(Nf.removeListener(Pm),Pm=null)}}}]),f}());Dm.EventType=gf,cc.SystemEvent=Dm;var Fm=q3("systemEvent",new Dm);cc.systemEvent=Fm;var Nm=q3("screen",{_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(t,i){t=t||document.body;var n=cc.game.canvas||t,r=this;this.requestFullScreen(t,i),n.addEventListener(this._touchEvent,function e(){n.removeEventListener(r._touchEvent,e),r.requestFullScreen(t,i)})}});function Um(e){var t=[];return function e(t,i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}Nm.init(),cc.screen=Nm;var Vm=Ho.Flags.Destroyed,Gm=Ho.Flags.PersistentMask,Hm=gt+"default",Wm=ai.IDENTIFIER_RE,qm="var ",jm="o",Xm={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},Ym=ai.escapeForJS,Km=function(){function i(e,t){y(this,i),this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return v(i,[{key:"toString",value:function(){return qm+this.varName+"="+this.expression+";"}}]),i}();function Qm(e,t){return t instanceof Km?new Km(t.varName,e+t.expression):e+t}function Zm(e,t,i){Array.isArray(i)?(i[0]=Qm(t,i[0]),e.push(i)):e.push(Qm(t,i)+";")}var Jm=function(){function t(e){y(this,t),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}return v(t,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(1<this._exps.length)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];Zm(e,t+$m(n[0])+"=",n[1])}}}]),t}();function $m(e){return Wm.test(e)?"."+e:"["+Ym(e)+"]"}Jm.pool=void 0,Jm.pool=new Je(function(e){e._exps.length=0,e._targetExp=null},1),Jm.pool.get=function(e){var t=this._get()||new Jm;return t._targetExp=e,t};var ey,ty,iy,ny,ry,ay,sy,oy=function(){function s(e,t){var i;y(this,s),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ke(),Ne(this.funcModuleCache,Xm),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),0<this.globalVariables.length&&(i=qm+this.globalVariables.join(",")+";");var n=Um(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}return v(s,[{key:"getFuncModule",value:function(e,t){var i=Re(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=Jm.pool.get(n),a=t.constructor.__props__;a=a||Object.keys(t);for(var s=0;s<a.length;s++){var o=a[s],l=i[o];if(t[o]!==l){var u=this.enumerateField(i,o,l);r.append(o,u)}}r.writeCode(e),Jm.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,i){for(var n=i.__values__,r=wt(i),a=0;a<n.length;a++){var s=n[a],o=t[s],l=r[s+Hm];if(!ly(l,o))if("object"===_e(o)&&o instanceof cc.ValueType&&(l=ai.getDefault(l))&&l.constructor===o.constructor){var u=jm+$m(s);this.setValueType(e,l,o,u)}else this.setObjProp(e,t,s,o)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new Km(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){Zm(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===_e(i)&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=n.source[0];n.source[0]=Qm(r+"=",a)}return r}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?Ym(i):("_objFlags"===t&&e instanceof Ho&&(i&=Gm),i)}},{key:"setObjProp",value:function(e,t,i,n){Zm(e,jm+$m(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var n in t)if(t.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=t[n];"object"===_e(r)&&r&&r===t._iN$t||this.setObjProp(e,t,n,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return ai.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&Vm)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Km(jm,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new Km(jm,"{}");else{if(i)return this.getObjRef(e);t=new Km(jm,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),s}();function ly(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function uy(e){var t=e instanceof cc._BaseNode&&e;return new oy(e,t).result}var cy,hy,dy,fy,py=vt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),_y=q3("Prefab",oo("cc.Prefab")((sy=ay=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"data",iy,l(e)),m(e,"optimizationPolicy",ny,l(e)),m(e,"asyncLoadAssets",ry,l(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return p(t,rd),v(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=uy(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e,t=!1;return t?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(),ay.OptimizationPolicy=py,ay.OptimizationPolicyThreshold=3,iy=b((ty=sy).prototype,"data",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ny=b(ty.prototype,"optimizationPolicy",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return py.AUTO}}),ry=b(ty.prototype,"asyncLoadAssets",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ey=ty))||ey);cc.Prefab=_y,Oe(cc,"cc._Prefab","Prefab");var vy,my,yy,gy=q3("SceneAsset",oo("cc.SceneAsset")((dy=b((hy=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"scene",dy,l(t)),m(t,"asyncLoadAssets",fy,l(t)),t}return p(a,rd),a}()).prototype,"scene",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fy=b(hy.prototype,"asyncLoadAssets",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cy=hy))||cy);cc.SceneAsset=gy;var by,xy,Sy,wy=q3("SpriteAtlas",oo("cc.SpriteAtlas")((yy=b((my=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"spriteFrames",yy,l(t)),t}return p(a,rd),v(a,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(0<e.length){var t=this.spriteFrames[e[0]];return t&&t._image}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],s=a?a._uuid:"";s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(s,!0)),t.push(r),t.push(s)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=ke();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),a}()).prototype,"spriteFrames",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ke()}}),vy=my))||vy);cc.SpriteAtlas=wy;var Ty,Ey,Cy,Ay=q3("TextAsset",oo("cc.TextAsset")((Sy=b((xy=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"text",Sy,l(t)),t}return p(a,rd),v(a,[{key:"toString",value:function(){return this.text}}]),a}()).prototype,"text",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),by=xy))||by);cc.TextAsset=Ay;var ky=q3("JsonAsset",oo("cc.JsonAsset")((Cy=b((Ey=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"json",Cy,l(t)),t}return p(a,rd),a}()).prototype,"json",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ty=Ey))||Ty);cc.JsonAsset=ky;var Ry="0123456789abcdef".split(""),Oy=["","","",""],My=Oy.concat(Oy,"-",Oy,"-",Oy,"-",Oy,"-",Oy,Oy,Oy),Iy=My.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function Ly(e){var t=e.split("@")[0];if(22!==t.length)return e;My[0]=e[0],My[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=at[e.charCodeAt(i)],a=at[e.charCodeAt(i+1)];My[Iy[n++]]=Ry[r>>2],My[Iy[n++]]=Ry[(3&r)<<2|a>>4],My[Iy[n++]]=Ry[15&a]}return e.replace(t,My.join(""))}var zy={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=zy,q3("url",zy);function By(e,t){y(this,By),this.uuid=void 0,this.type=void 0,this.uuid=e,this.type=t}var Py=function(){function e(){y(this,e),this._pathToUuid=void 0,this._pathToUuid=ke(!0)}return v(e,[{key:"getUuid",value:function(e,t){e=zy.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(Ge(r.type,t))return r.uuid}}else{if(!t||Ge(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=zy.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n,r,a=this._pathToUuid,s=[];for(var o in a)if(o.startsWith(e)&&(r=e,!((n=o).length>r.length)||47===n.charCodeAt(r.length))||!e){var l=a[o];if(Array.isArray(l))for(var u=0;u<l.length;u++){var c=l[u];(!t||Ge(c.type,t))&&(s.push(c.uuid),i&&i.push(o))}else(!t||Ge(l.type,t))&&(s.push(l.uuid),i&&i.push(o))}return s}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-Q(e).length));var r=new By(t,i);lt(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],s=i[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(s.uuid===e)return t.path=a,t.type=s.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=ke(!0)}}]),e}();function Dy(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,Dy(a,t))}}}function Fy(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,Dy(i,t))}}function Ny(e,t){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=e[i[n]];if("object"===_e(r)&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var s=r[a];s instanceof Qh&&Fy(s,t)}else if(r.constructor&&r.constructor!==Object)r instanceof Qh&&Fy(r,t);else for(var o=Object.getOwnPropertyNames(r),l=0;l<o.length;l++){var u=r[o[l]];u instanceof Qh&&Fy(u,t)}}}function Uy(e,t){for(var i=0;i<e._components.length;i++)Ny(e._components[i],t);for(var n=0;n<e._children.length;n++)Uy(e._children[n],t)}function Vy(e){var t={};return Dy(e,t),Object.keys(t)}var Gy,Hy,Wy=0|998*Math.random(),qy=ke(!0),jy=[];(Hy=Gy=Gy||{})[Hy.WORKING=0]="WORKING",Hy[Hy.COMPLETE=1]="COMPLETE",Hy[Hy.ERROR=2]="ERROR";var Xy=ke(!0);function Yy(t,e){var i="object"===_e(t)?t.url:t,n={queueId:e,id:i,url:i,rawUrl:void 0,urlParam:function(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach(function(e){var t=e.split("=");i[t[0]]=t[1]}),i}}}(i),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:t.uuid&&cc.game._sceneInfos.find(function(e){return e.uuid===t.uuid})};if("object"===_e(t)&&(Ne(n,t),t.skips))for(var r=0;r<t.skips.length;r++){var a=t.skips[r];n.states[a]=Gy.COMPLETE}return n.rawUrl=n.url,i&&!n.type&&(n.type=Q(i).toLowerCase().substr(1)),n}var Ky=[];function Qy(e,t,i){if(!e||!t)return!1;var n=!1;if(Ky.push(t.id),t.deps){var r,a,s=t.deps;for(r=0;r<s.length;r++){if((a=s[r]).id===e.id){n=!0;break}if(!(0<=Ky.indexOf(a.id))&&(a.deps&&Qy(e,a,!0))){n=!0;break}}}return i||(Ky.length=0),n}var Zy=q3("LoadingItems",function(){function u(e,t,i,n){var r;return y(this,u),(r=x(this,g(u).call(this))).onProgress=void 0,r.onComplete=void 0,r.map=ke(!0),r.completed={},r.totalCount=0,r.completedCount=0,r.active=void 0,r._id=void 0,r._pipeline=void 0,r._errorUrls=[],r._appending=!1,r._ownerQueue=null,r._id=++Wy,qy[r._id]=l(r),r._pipeline=e,r.onProgress=i,r.onComplete=n,r._pipeline?r.active=!0:r.active=!1,t&&(0<t.length?r.append(t):r.allComplete()),r}return p(u,Rl),v(u,[{key:"append",value:function(e,i){var n=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var t,r,a,s,o=[];for(t=0;t<e.length;++t){if((r=e[t]).queueId&&!this.map[r.id]){if(this.map[r.id]=r,i&&i.deps.push(r),r.complete||Qy(i,r)){this.totalCount++,this.itemComplete(r.id);continue}if("continue"===function(){var t=n,e=qy[r.queueId];return e&&(n.totalCount++,u.registerQueueDep(i||n._id,r.id),e.addListener(r.id,function(e){t.itemComplete(e.id)})),"continue"}())continue}if("string"==typeof((s=r).url||s)){var l=(a=Yy(r,this._id)).id;this.map[l]||(this.map[l]=a,this.totalCount++,i&&i.deps.push(a),u.registerQueueDep(i||this._id,l),o.push(a))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(o),o}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=Xy[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var t=this.map[e];if(t){var i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),this.completed[e]=t,this.completedCount++,u.finishDep(t.id),this.onProgress){var n=Xy[this._id];this.onProgress(n?n.completed.length:this.completedCount,n?n.deps.length:this.totalCount,t)}this.emit(e,t),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=ke(!0),this.completed={},this.totalCount=0,this.completedCount=0,Rl.call(this),qy[this._id]=null,Xy[this._id]&&(Xy[this._id].completed.length=0,Xy[this._id].deps.length=0),-1===jy.indexOf(this)&&jy.length<10&&jy.push(this)}},{key:"addListener",value:function(e,t,i){return _(g(u.prototype),"on",this).call(this,e,t,i)}},{key:"hasListener",value:function(e,t,i){return _(g(u.prototype),"hasEventListener",this).call(this,e,t,i)}},{key:"removeListener",value:function(e,t,i){return _(g(u.prototype),"off",this).call(this,e,t,i)}},{key:"removeAllListeners",value:function(e){_(g(u.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,t,i,n){void 0===i?"function"==typeof t&&(n=t,t=i=null):void 0===n&&("function"==typeof t?(n=i,i=t,t=null):(n=i,i=null));var r=jy.pop();return r?(r._pipeline=e,r.onProgress=i,r.onComplete=n,(qy[r._id]=r)._pipeline&&(r.active=!0),t&&r.append(t)):r=new u(e,t,i,n),r}},{key:"getQueue",value:function(e){return e.queueId?qy[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=qy[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=Xy[e._id];t?(t.completed.length=0,t.deps.length=0):t=Xy[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=Xy[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in Xy){var a=Xy[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in Xy){var i=Xy[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),u}());Zy.ItemState=new cc.Enum(Gy);var Jy=(cc.LoadingItems=Zy).ItemState;function $y(e,i){var n=e.id,t=i.states[n],r=e.next,a=e.pipeline;if(!i.error&&t!==Jy.WORKING&&t!==Jy.ERROR)if(t===Jy.COMPLETE)r?$y(r,i):a.flowOut(i);else{i.states[n]=Jy.WORKING;var s=e.handle(i,function(e,t){e?(i.error=e,i.states[n]=Jy.ERROR,a.flowOut(i)):(t&&(i.content=t),i.states[n]=Jy.COMPLETE,r?$y(r,i):a.flowOut(i))});s instanceof Error?(i.error=s,i.states[n]=Jy.ERROR,a.flowOut(i)):void 0!==s&&(null!==s&&(i.content=s),i.states[n]=Jy.COMPLETE,r?$y(r,i):a.flowOut(i))}}var eg=q3("Pipeline",function(){function n(e){y(this,n),this._pipes=void 0,this._cache=ke(!0),this._pipes=e;for(var t=0;t<e.length;++t){var i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}return v(n,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(0<this._pipes.indexOf(e))cc.warnID(4922);else{var i=null;t<(e.pipeline=this)._pipes.length&&(i=this._pipes[t]);var n=null;0<t&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,0<this._pipes.length&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)$y(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return Zy.create(this,function(e,t){i(e,t),t.destroy()}).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,Zy.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t&&t.alias&&(t=t.alias),t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),n}());eg.ItemState=Jy,cc.Pipeline=eg;var tg="MD5Pipe",ig=/(\.[^.\n\\/]*)$/,ng=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var rg=function(){function n(e,t,i){y(this,n),this.id=tg,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=tg,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}return v(n,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(ng);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=cc.path.dirname(e),a=cc.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var s=!1;e=e.replace(ig,function(e,t){return s=!0,"."+n+t}),s||(e=e+"."+n)}}return e}}]),n}();rg.ID=tg,eg.MD5Pipe=rg;var ag,sg,og=function(){function e(){y(this,e),this.jsons={}}return v(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),lg=function(){function e(){y(this,e),this.contents={}}return v(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}(),ug=/\?/;function cg(e){return cc.game.config.noCache&&"string"==typeof e&&(ug.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function hg(e,t){if(Array.isArray(e))for(var i=0,n=e.length;i<n;i++)hg(e[i],t);else if("object"===_e(e))for(var r in e)hg(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}(sg=ag=ag||{})[sg.Invalid=0]="Invalid",sg[sg.Removed=1]="Removed",sg[sg.Downloading=2]="Downloading",sg[sg.Loaded=3]="Loaded";var dg=function e(){y(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=ag.Invalid},fg={},pg={},_g={};function vg(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function mg(e){for(var t in pg=e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;lt(fg,r,t,a)}}function yg(n,r,a){var e=cc.AssetLibrary.getLibUrlNoExt(r)+".json";cc.loader.load({url:e,ignoreMaxConcurrency:!0},function(e,t){if(e)return D(4916,n),a(e);var i=bg(n,r,t);i?a(null,i):a(vg(n,r))})}function gg(e,t){var i=_g[e];i||((i=_g[e]=new dg).state=ag.Downloading),i.state!==ag.Loaded&&(i.unpacker=new og,i.unpacker.load(pg[e],t),i.state=ag.Loaded)}function bg(e,t,i){var n=_g[t];if(n.state!==ag.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;hg(i=i.data,r)}Array.isArray(i)?n.unpacker=new og:i.type===Ze(uf)&&(n.unpacker=new lg),n.unpacker.load(pg[t],i),n.state=ag.Loaded}return n.unpacker.retrieve(e)}function xg(e){for(var t=ag.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=_g[r];if(a){var s=a.state;if(s===ag.Loaded)return r;t<s&&(t=s,i=r)}}return t!==ag.Invalid?i:e[0]}function Sg(e,t){var i=e.uuid,n=fg[i];if(n){Array.isArray(n)&&(n=xg(n));var r=_g[n];if(r&&r.state===ag.Loaded){var a=r.unpacker.retrieve(i);return a||vg(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=_g[n]=new dg).state=ag.Downloading),yg(i,n,t),null}}var wg=Object.freeze({initPacks:mg,_loadNewPack:yg,_doPreload:gg,_doLoadNewPack:bg,_selectLoadedPack:xg,load:Sg}),Tg="SubPackPipe",Eg=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var Cg=Object.create(null),Ag=function(){function n(t){y(this,n),this.id=Tg,this.async=!1,this.pipeline=null;function e(e){var i=t[e];i.uuids&&i.uuids.forEach(function(e){var t=Ly(e);t=t.split("@").map(function(e){return encodeURIComponent(e)}).join("@"),Cg[t]=i.path})}for(var i in t)e(i)}return v(n,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(Eg);return t?t[1]:""}(e);if(t){var i=Cg[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),n}();Ag.ID=Tg,eg.SubPackPipe=Ag;var kg="",Rg="",Og=ke(!0);function Mg(e,t){this.url=e,this.type=t}var Ig,Lg={_uuidToAsset:{},loadAsset:function(n,r,e){if("string"!=typeof n)return ht(r,new Error("[AssetLibrary] uuid must be string"),null);var t={uuid:n,type:"uuid"};e&&e.existingAsset&&(t.existingAsset=e.existingAsset),cc.loader.load(t,function(e,t){if(e||!t)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error"));else if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(n);t.scene.dependAssets=Vy(i)}r&&r(e,t)})},getLibUrlNoExt:function(e,t){return e=(e=Ly(e)).split("@").map(function(e){return encodeURIComponent(e)}).join("@"),(t?Rg+"assets/":kg)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=Og[e];return i&&!Ge(i.type,cc.Asset)?(t.url=Rg+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in Og},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,r){var a=""+((new Date).getTime()+Math.random()),t={uuid:a,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(t,function(e,t){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(a);t.scene.dependAssets=Vy(i)}if(function(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}(t)){var n=cc.loader._getReferenceKey(a);cc.loader.removeItem(n)}}t._uuid="",r&&r(e,t)})},getAssetByUuid:function(e){return Lg._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),kg=cc.path.stripSep(t)+"/",Rg=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=ke(!0),a=i.import;for(n=0;n<a.length;n+=2){r[Ly(a[n]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=a[n+1]}var s=ke(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2){s[Ly(a[n]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=a[n+1]}var o=new rg(r,s,kg);cc.loader.insertPipeAfter(cc.loader.assetLoader,o),cc.loader.md5Pipe=o}if(e.subpackages){var l=new Ag(e.subpackages);cc.loader.insertPipeAfter(cc.loader.assetLoader,l),cc.loader.subPackPipe=l}var u=cc.loader._assetTables;for(var c in u)u[c].reset();var h=e.rawAssets;if(h)for(var d in h){var f=h[d];for(var p in f){var _=f[p],v=_[0],m=_[1],y=Ke(m);if(y){Og[p]=new Mg(d+"/"+v,y);var g=1===_[2];u[d]||(u[d]=new Py),u[d].add(v,p,y,!g)}else cc.error("Cannot get",m)}}e.packedAssets&&mg(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||Rg+"assets")}};cc.AssetLibrary=Lg,q3("AssetLibrary",Lg);var zg,Bg,Pg,Dg,Fg,Ng=q3("Font",oo("cc.Font")(Ig=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,rd),e}())||Ig);cc.Font=Ng;var Ug,Vg,Gg,Hg,Wg,qg,jg,Xg,Yg=q3("TTFFont",(zg=oo("cc.TTFFont"),Bg=lo({override:!0}),zg((Fg=b((Dg=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_fontFamily",Fg,l(t)),t}return p(a,Ng),v(a,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),a}()).prototype,"_fontFamily",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(Dg.prototype,"_nativeAsset",[Bg,To],Object.getOwnPropertyDescriptor(Dg.prototype,"_nativeAsset"),Dg.prototype),Pg=Dg))||Pg));cc.TTFFont=Yg;var Kg,Qg=q3("BitmapFont",(Ug=oo("cc.BitmapFont"),Vg=lo({type:yf}),Ug((Wg=b((Hg=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"fntDataStr",Wg,l(t)),m(t,"spriteFrame",qg,l(t)),m(t,"fontSize",jg,l(t)),m(t,"fntConfig",Xg,l(t)),t}return p(a,Ng),a}()).prototype,"fntDataStr",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qg=b(Hg.prototype,"spriteFrame",[Vg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jg=b(Hg.prototype,"fontSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Xg=b(Hg.prototype,"fntConfig",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gg=Hg))||Gg));cc.BitmapFont=Qg;var Zg=q3("LabelAtlas",oo("cc.LabelAtlas")(Kg=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,Qg),e}())||Kg);cc.LabelAtlas=Zg;var Jg="AssetLoader",$g=[],eb=function(){function e(){y(this,e),this.id=Jg,this.async=!0,this.pipeline=null}return v(e,[{key:"handle",value:function(a,s){var o=a.uuid;if(!o)return a.content||null;cc.AssetLibrary.queryAssetInfo(o,function(e,t,i){if(e)s(e);else if(a.url=a.rawUrl=t,a.isRawAsset=i){var n=Q(t).toLowerCase();if(!n)return void s(new Error(G(4931,o,t)));n=n.substr(1);var r=Zy.getQueue(a);$g[0]={queueId:a.queueId,id:t,url:t,type:n,error:null,alias:a,complete:!0},r.append($g),a.type=n,s(null,a.content)}else a.type="uuid",s(null,a.content)})}}]),e}();function tb(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function ib(e,t){var i=e.url;i=cg(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function nb(){return null}function rb(e,t,i){var n=e.url,r=document,a=document.createElement("script");function s(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(null,n)}function o(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(new Error(G(4928,n)))}a.async=!!i,a.src=cg(n),a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),r.body.appendChild(a)}function ab(e,t,i,n){void 0===i&&(i=!0);var r=cg(e.url);function a(){n.removeEventListener("load",a),n.removeEventListener("error",s),n.id=e.id,t(null,n)}function s(){n.removeEventListener("load",a),n.removeEventListener("error",s),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?ab(e,t,!1,n):t(new Error(G(4930,r)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&0<n.naturalWidth&&n.src===r)return n;n.addEventListener("load",a),n.addEventListener("error",s),n.src=r}eb.ID=Jg,eg.AssetLoader=eb;var sb={js:rb,png:ab,jpg:ab,bmp:ab,jpeg:ab,gif:ab,ico:ab,tiff:ab,webp:function(e,t,i,n){return cc.sys.capabilities.webp?ab(e,t,i,n):new Error(G(4929,e.url))},image:ab,pvr:tb,pkm:tb,txt:ib,xml:ib,vsh:ib,fsh:ib,atlas:ib,tmx:ib,tsx:ib,json:ib,ExportJson:ib,plist:ib,fnt:ib,font:nb,eot:nb,ttf:nb,woff:nb,svg:nb,ttc:nb,uuid:function(e,t){var i=Sg(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:tb,bin:tb,default:ib},ob="Downloader",lb=q3("Downloader",function(){function t(e){y(this,t),this.id=ob,this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=Ne(e,sb)}return v(t,[{key:"addHandlers",value:function(e){Ne(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,i){var n=this,t=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=t.call(this,e,function(e,t){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),i&&i(e,t)})))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=t.call(this,e,i)))return r}else this._loadQueue.push({item:e,callback:i})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():rb({url:i.path},function(e){e||(i.loaded=!0),t&&t(e)}):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),t}());lb.ID=ob,lb.PackDownloader=wg,eg.Downloader=lb;var ub=function(){function e(){y(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return v(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),cb=new(function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,ub),v(e,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),e}());function hb(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function db(t,i){var e,n;if("string"==typeof t.content)try{if((e=JSON.parse(t.content)).keys&&e.data){var r=e.keys;hg(e=e.data,r)}}catch(e){return new Error(G(4923,t.id,e.stack))}else{if("object"!==_e(t.content))return new Error(G(4924));e=t.content}if(null==e)return new Error(G(4923,t.id));var a=hb(e);n=a?cc._MissingScript.safeFindClass:function(e){var t=Ke(e);return t||(cc.warnID(4903,e),Object)};var s,o=cc.deserialize.Details.pool.get();try{s=cc.deserialize(e,o,{classFinder:n,target:t.existingAsset,customEnv:t})}catch(e){return cc.deserialize.Details.pool.put(o),console.error(e),new Error("Failed to load asset ".concat(t.id,", exception occurs during deserialization: ").concat(e.stack,"."))}s._uuid=t.uuid;var l=function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(n=e.asyncLoadAssets),n}(s,t,a),u=function(e,t,i,n){var r,a,s,o=i.uuidList,l=i.uuidObjList,u=i.uuidPropList,c=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<o.length;a++){s=o[a];var d=l[a],f=u[a],p=cc.AssetLibrary._getAssetInfoInRuntime(s);if(p.raw){var _=p.url;d[f]=_,h.push(_)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:d,_ownerProp:f,_stillUseUrl:c[a]})}else{for(r=new Array(o.length),a=0;a<o.length;a++)s=o[a],r[a]={type:"uuid",uuid:s,_owner:l[a],_ownerProp:u[a],_stillUseUrl:c[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(t,s,o,l);cc.deserialize.Details.pool.put(o);function c(t,e){if(!t&&e.onLoaded)try{e.onLoaded()}catch(e){t=e}i(t,e)}if(0===u.length)return c(null,s);!function(e,t,f,p,_){t.content=f;var v=t.dependKeys;e.flowInDeps(t,p,function(e,t){var i,n=t.map;for(var r in n)(i=n[r]).uuid&&i.content&&(i.content._uuid=i.uuid);for(var a=0;a<p.length;a++){var s=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==f._uuid&&v.indexOf(e.id)<0&&v.push(e.id)},o=p[a],l=o.uuid,u=o.url;o._owner,o._ownerProp;if(i=n[u]){var c=o;if(i.complete||i.content){if(i.error)cc._throw(i.error);else s.call(c,i)}else{var h=Zy.getQueue(i),d=h._callbackTable[l];d?d.unshift(s,c):h.addListener(l,s,c)}}}_(e,f)})}(this.pipeline,t,s,u,c)}db.isSceneObj=hb;var fb=null,pb="BES bswy:->@",_b={},vb=-1,mb=[],yb=6e4;function gb(){for(var e=!0,t=Date.now(),i=mb.length-1;0<=i;i--){var n=mb[i],r=n.fontFamilyName;if(t-n.startTime>yb)cc.warnID(4933,r),n.callback(null,r),mb.splice(i,1);else{var a=n.refWidth;fb.font="40px "+r,a!==qs(fb,pb)?(mb.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(vb),vb=-1)}function bb(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(_b[n])return n;if(!fb){var r=document.createElement("canvas");r.width=100,r.height=100,fb=r.getContext("2d")}var a="40px "+n;fb.font=a;var s=qs(fb,pb),o=document.createElement("style");o.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",o.textContent=l+"}",document.body.appendChild(o);var u=document.createElement("div"),c=u.style;c.fontFamily=n,u.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(u);var h={fontFamilyName:n,refWidth:s,callback:t,startTime:Date.now()};mb.push(h),_b[n]=o,-1===vb&&(vb=setInterval(gb,100))}function xb(t){if("string"!=typeof t.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(t.content)}catch(e){return new Error("JSON Loader: Parse json ["+t.id+"] failed : "+e)}}function Sb(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;var i=e.rawUrl,n=e.imageAsset||new Td;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function wb(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function Tb(e){return e.load?e.load(e.content):e.content}function Eb(e,t){return e[t]<<8|e[t+1]}var Cb={png:Sb,jpg:Sb,bmp:Sb,jpeg:Sb,gif:Sb,ico:Sb,tiff:Sb,webp:Sb,image:Sb,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176!==i[11])return new Error("Invalid magic number in PVR header");var s=i[0],o=i[1],l=i[2];return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:o}},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=Eb(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=Eb(i,12),a=Eb(i,14);return Eb(i,8),Eb(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:wb,ogg:wb,wav:wb,m4a:wb,json:xb,ExportJson:xb,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=cb.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:db,prefab:db,fire:db,scene:db,binary:Tb,bin:Tb,font:bb,eot:bb,ttf:bb,woff:bb,svg:bb,ttc:bb,default:function(){return null}},Ab=q3("Loader",function(){function t(e){y(this,t),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=Ne(e,Cb)}return v(t,[{key:"addHandlers",value:function(e){this.extMap=Ne(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),t}());Ab.ID="Loader",eg.Loader=Ab;var kb=Object.create(null);function Rb(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}kb.assets=new Py,kb.internal=new Py;var Ob={url:null,raw:!1};function Mb(e){var t,i,n;if("object"===_e(e)){if((i=e).url)return i;t=e.uuid}else i={},t=e;return n=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,Ob),i.url=n?Ob.url:t,Ob.url&&"uuid"===i.type&&Ob.raw?(i.type=null,i.isRawAsset=!0):n||(i.isRawAsset=!0),i}var Ib=[],Lb=[],zb=function(){function r(){var e;y(this,r);var t=new eb,i=new lb,n=new Ab;return(e=x(this,g(r).call(this,[t,i,n]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=Rb,e.assetLoader=t,e.md5Pipe=null,e.downloader=i,e.loader=n,e.onProgress=null,e._assetTables=kb,e._autoReleaseSetting=ke(!0),e}return p(r,eg),v(r,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var r,a=this,s=!1;e instanceof Array||(e=e?(s=!0,[e]):[]);for(var i=Ib.length=0;i<e.length;++i){var o=e[i];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(r=Mb(o)).url||r.uuid){var l=this._cache[r.url];Ib.push(l||r)}}var u=Zy.create(this,t,function(t,i){ht(function(){if(n){if(s){var e=r.url;n.call(a,i.getError(e),i.getContent(e))}else n.call(a,t,i);n=null}i.destroy()})});Zy.initQueueDeps(u),u.append(Ib),Ib.length=0}},{key:"flowInDeps",value:function(i,e,n){for(var t=Lb.length=0;t<e.length;++t){var r=Mb(e[t]);if(r.url||r.uuid){var a=this._cache[r.url];a?Lb.push(a):Lb.push(r)}}var s=Zy.create(this,i?function(e,t,i){s._ownerQueue&&s._ownerQueue.onProgress&&s._ownerQueue._childOnProgress(i)}:null,function(e,t){n(e,t),i&&i.deps&&(i.deps.length=0),t.destroy()});if(i){var o=Zy.getQueue(i);s._ownerQueue=o._ownerQueue||o}var l=s.append(Lb,i);return Lb.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=this,o=s._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},n,function(e,t){t&&s.setAutoReleaseRecursively(o,!1),r&&r(e,t)}):s._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,l){if(5!==arguments.length&&(l=n,n=i,i="assets"),kb[i]){var r=this._parseLoadResArgs(t,n,l);t=r.type,n=r.onProgress,l=r.onComplete;var a=[],s=kb[i].getUuidArray(e,t,a);this._loadResUuids(s,n,function(e,t,i){for(var n=t.length,r=0;r<n;++r)if(t[r]instanceof cc.SpriteAtlas){var a=t[r].getSpriteFrames();for(var s in a){var o=a[s];t.push(o),i&&i.push("".concat(i[r],"/").concat(o.name))}}l&&l(e,t,i)},a)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var s=[],o=0;o<e.length;o++){var l=e[o],u=this._getResUuid(l,t,i,!0);if(!u)return void this._urlNotFound(l,t,r);s.push(u)}this._loadResUuids(s,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=Vy(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cc.Asset){var a=e.nativeUrl;a&&this.release(a),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(kb[i=i||"assets"])for(var n=kb[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=eg.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=Vy(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r="",a=kb[i=i||"assets"];if(e&&a){var s=e.indexOf("?");if(-1!==s&&(e=e.substr(0,s)),!(r=a.getUuid(e,t))){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(r=a.getUuid(e,t))&&!n&&cc.warnID(4901,e,o))}}return!r&&t&&(Ge(t,yf)||Ge(t,uf)||Ge(t,xf))&&cc.warnID(4934),r}},{key:"_getReferenceKey",value:function(e){var t;return"object"===_e(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,null,null,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,Ob),this._cache[Ob.url]?Ob.url:t):(cc.warnID(4800,e),t)}},{key:"_urlNotFound",value:function(t,i,n){ht(function(){t=cc.url.normalize(t);var e="".concat(i?Re(i):"Asset",' in "resources/').concat(t,'" does not exist.');n&&n(new Error(e),[])})}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=Ge(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,l,u){if(0<e.length){var c=this,h=e.map(function(e){return{type:"uuid",uuid:e}});this.load(h,t,function(e,t){if(l){for(var i=[],n=u&&[],r=0;r<h.length;++r){var a=h[r].uuid,s=c._getReferenceKey(a),o=t.getContent(s);o&&(c.setAutoReleaseRecursively(a,!1),i.push(o),n&&n.push(u[r]))}u?l(e,i,n):l(e,i)}})}else l&&ht(function(){u?l(null,[],[]):l(null,[])})}}]),r}(),Bb=q3("loader",cc.loader=new zb);var Pb,Db,Fb,Nb,Ub,Vb,Gb,Hb=Object.freeze({loadImage:function(e,i,n){V(!!e,3103);var r=Bb.getRes(e);return r?r.loaded?i&&i.call(n,null,r):r.once("load",function(){i&&i.call(n,null,r)},n):(r=new Td,Bb.load({url:e,imageAsset:r},function(e,t){if(e)return i&&i.call(n,e||new Error("Unknown error")),r;i&&i.call(n,null,t)})),r},cacheImage:function(e,t){if(e&&t){var i=new Td(t),n={id:e,url:e,error:null,content:i,complete:!1};return Bb.flowOut(n),i}},postLoadImage:function(i,n){i.loaded?n&&n():i.nativeUrl?Bb.load({url:i.nativeUrl,skips:i.isCompressed?void 0:["Loader"]},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}});q3("textureUtil",Hb);var Wb=q3("Skeleton",(Pb=oo("cc.Skeleton"),Db=lo([Ot]),Fb=lo([zn]),Pb((Vb=b((Ub=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_joints",Vb,l(t)),m(t,"_bindposes",Gb,l(t)),t._bindTRS=[],t._hash=0,t}return p(a,rd),v(a,[{key:"onLoaded",value:function(){this.bindposes=this._bindposes}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e,this._bindTRS=e.map(function(e){var t=new Fi,i=new hn,n=new Fi;return zn.toRTS(e,i,t,n),{position:t,rotation:i,scale:n}}),this._hash=xd(this.bindposes.reduce(function(e,t){return e+t.m00.toPrecision(2)+" "+t.m01.toPrecision(2)+" "+t.m02.toPrecision(2)+" "+t.m03.toPrecision(2)+" "+t.m04.toPrecision(2)+" "+t.m05.toPrecision(2)+" "+t.m06.toPrecision(2)+" "+t.m07.toPrecision(2)+" "+t.m08.toPrecision(2)+" "+t.m09.toPrecision(2)+" "+t.m10.toPrecision(2)+" "+t.m11.toPrecision(2)+" "+t.m12.toPrecision(2)+" "+t.m13.toPrecision(2)+" "+t.m14.toPrecision(2)+" "+t.m15.toPrecision(2)+"\n"},""),666)}},{key:"bindTRS",get:function(){return this._bindTRS}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"hash",get:function(){return this._hash}}]),a}()).prototype,"_joints",[Db],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gb=b(Ub.prototype,"_bindposes",[Fb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nb=Ub))||Nb));cc.Skeleton=Wb,cc.textureUtil=Hb;function qb(){y(this,qb),this.material=null,this.vertexCount=0,this.indiceCount=0}var jb,Xb,Yb,Kb,Qb,Zb,Jb,$b,ex,tx,ix=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._datas=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}return p(a,qb),v(a,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)rx.free(t[n]);for(n=i;n<e;n++)t[n]=rx.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return ax.add()}},{key:"remove",value:function(e){var t=ax.data.indexOf(e);-1!==t&&(ax.data[t].clear(),ax.removeAt(t))}}]),a}(),nx=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),t.iData=new Uint16Array(1536),t.vertexStart=0,t.indiceStart=0,t.byteStart=0,t.byteCount=0,t._formatByte=9*Float32Array.BYTES_PER_ELEMENT,t}return p(a,qb),v(a,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(65535<e+this.vertexCount)return!1;var r=this.vData.byteLength,a=this.iData.length,s=this.vData.length,o=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)r=4*(s*=2),a=o*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(s),this.vData.set(l,0);var u=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(u,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),a}(),rx=new Ts(function(){return{x:0,y:0,z:0,u:0,v:0,color:rr.WHITE.clone()}},128),ax=new Es(function(){return new ix},32),sx=lo,ox=q3("RenderableComponent",(jb=oo("cc.RenderableComponent"),Xb=sx({type:[fm]}),Yb=sx({type:fm,displayName:"Materials"}),Kb=sx({visible:!1}),jb((Jb=b((Zb=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_materials",Jb,l(e)),m(e,"_visFlags",$b,l(e)),e._models=[],e}return p(t,rp),v(t,[{key:"getMaterial",value:function(e,t,i){var n=1<arguments.length&&void 0!==t&&t,r=2<arguments.length&&void 0!==i&&i,a=this._materials[e];if(!a)return null;var s=fm.getInstantiatedMaterial(a,this,n);return s!==this._materials[e]&&this.setMaterial(s,e,r||!n),this._materials[e]}},{key:"getSharedMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t,i){var n=!(2<arguments.length&&void 0!==i)||i;this._materials[t]=e,n&&this._onMaterialModified(t,e)}},{key:"_collectModels",value:function(){return this._models}},{key:"_changeSceneInModel",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materials[e]=this.getMaterial(e);return this._materials},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials=this._materials.concat(new Array(t).fill(null));else if(t<0){for(var i=-t;i<this._materials.length;++i)this.setMaterial(null,i);this._materials=this._materials.splice(-t)}}},{key:"material",get:function(){return this.getMaterial(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterial(e,0)}},{key:"sharedMaterial",get:function(){return this.getSharedMaterial(0)}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisiblityChange(e)}}]),t}()).prototype,"_materials",[Xb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$b=b(Zb.prototype,"_visFlags",[sx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ah.Enum.NONE}}),b(Zb.prototype,"sharedMaterials",[Yb],Object.getOwnPropertyDescriptor(Zb.prototype,"sharedMaterials"),Zb.prototype),b(Zb.prototype,"visibility",[Kb],Object.getOwnPropertyDescriptor(Zb.prototype,"visibility"),Zb.prototype),Qb=Zb))||Qb)),lx=q3("System",function(){function e(){y(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return v(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}());(tx=ex=ex||{})[tx.DIRECTIONAL=0]="DIRECTIONAL",tx[tx.SPHERE=1]="SPHERE",tx[tx.SPOT=2]="SPOT",tx[tx.UNKNOWN=3]="UNKNOWN";function ux(e){return 4*Math.PI*Math.PI*e*e}var cx=function(){function n(e,t,i){y(this,n),this._enabled=!0,this._color=new Fi(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Fi(1,1,1),this._scene=void 0,this._node=void 0,this._type=void 0,this._name=void 0,this._scene=e,this._name=t,this._type=ex.UNKNOWN,this._node=i}return v(n,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,function(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,s=3*n/a,o=2*r/a,l=1/o*s,u=1/o*(1-s-o);e.x=3.2404542*l-1.5371385+-.4985314*u,e.y=-.969266*l+1.8760108+.041556*u,e.z=.0556434*l-.2040259+1.0572252*u}(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}}]),v(n,[{key:"update",value:function(){}}]),n}();(hx=new ds).accurate=!0;var hx,dx,fx,px,_x,vx,mx,yx,gx,bx=function(){var o=new Fi,l=new Fi,u=new hn,c=new ds;c.accurate=!0;var h=new zn,d=new zn,f=new Fi,p=new Fi;return function(e,t,i,n,r,a){zn.fromRT(h,i.node.getWorldRotation(u),t.node.getWorldPosition(o)),zn.invert(d,h),t.getSplitFrustum(c,n,r),c.transform(d),Fi.set(f,c.vertices[0].x,c.vertices[0].y,c.vertices[0].z),Fi.copy(p,f);for(var s=1;s<c.vertices.length;s++)f.x=Math.min(f.x,c.vertices[s].x),f.y=Math.min(f.y,c.vertices[s].y),f.z=Math.min(f.z,c.vertices[s].z),p.x=Math.max(p.x,c.vertices[s].x),p.y=Math.max(p.y,c.vertices[s].y),p.z=Math.max(p.z,c.vertices[s].z);Fi.set(l,(f.x+p.x)/2,(f.y+p.y)/2,p.z),l.z+=a,Fi.transformMat4(o,l,h),zn.fromRT(h,i.node.getWorldRotation(u),o),ds.createOrtho(e,p.x-f.x,p.y-f.y,0,f.z-a-p.z,h)}}(),xx=function(){function t(e){y(this,t),this._device=void 0,this._pipeline=void 0,this._name="",this._priority=0,this._stages=[],this._material=new fm,this._device=e.device,this._pipeline=e}return v(t,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}}]),v(t,[{key:"resize",value:function(e,t){var i=this._stages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.resize(e,t)}}},{key:"render",value:function(e){var t=this._stages,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"createStage",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._stages.push(i),this._stages.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyStages",value:function(){var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._stages=[]}}]),t}(),Sx=function(){function t(e){if(y(this,t),this._flow=void 0,this._pipeline=void 0,this._device=void 0,this._name="",this._priority=0,this._framebuffer=null,this._cmdBuff=null,this._clearColors=void 0,this._clearDepth=1,this._clearStencil=0,this._renderArea=void 0,this._pass=null,this._pso=null,this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0}}return v(t,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),v(t,[{key:"setClearColor",value:function(e){0<this._clearColors.length?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}}]),t}(),Tx=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._hTexSampler=0,t._hBlendTexSampler=0,t._bindingLayout=null,t}return p(i,Sx),v(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:wc.PRIMARY}),this.rebuild(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(fh.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(fh.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.smaaBlendTexView)),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,Nc.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}this._device.queue.submit([this._cmdBuff])}}]),i}(),Ex=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return p(t,xx),v(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}});var t=this._pipeline.root.mainWindow.framebuffer;return this.createStage(Tx,{name:"ToneMapStage",priority:0,framebuffer:t}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&(this._material.destroy(),this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}}));var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}}]),t}();(fx=dx=dx||{})[fx.ORTHO=0]="ORTHO",fx[fx.PERSPECTIVE=1]="PERSPECTIVE",(_x=px=px||{})[_x.F1_8=0]="F1_8",_x[_x.F2_0=1]="F2_0",_x[_x.F2_2=2]="F2_2",_x[_x.F2_5=3]="F2_5",_x[_x.F2_8=4]="F2_8",_x[_x.F3_2=5]="F3_2",_x[_x.F3_5=6]="F3_5",_x[_x.F4_0=7]="F4_0",_x[_x.F4_5=8]="F4_5",_x[_x.F5_0=9]="F5_0",_x[_x.F5_6=10]="F5_6",_x[_x.F6_3=11]="F6_3",_x[_x.F7_1=12]="F7_1",_x[_x.F8_0=13]="F8_0",_x[_x.F9_0=14]="F9_0",_x[_x.F10_0=15]="F10_0",_x[_x.F11_0=16]="F11_0",_x[_x.F13_0=17]="F13_0",_x[_x.F14_0=18]="F14_0",_x[_x.F16_0=19]="F16_0",_x[_x.F18_0=20]="F18_0",_x[_x.F20_0=21]="F20_0",_x[_x.F22_0=22]="F22_0",(mx=vx=vx||{})[mx.ISO100=0]="ISO100",mx[mx.ISO200=1]="ISO200",mx[mx.ISO400=2]="ISO400",mx[mx.ISO800=3]="ISO800",(gx=yx=yx||{})[gx.D1=0]="D1",gx[gx.D2=1]="D2",gx[gx.D4=2]="D4",gx[gx.D8=3]="D8",gx[gx.D15=4]="D15",gx[gx.D30=5]="D30",gx[gx.D60=6]="D60",gx[gx.D125=7]="D125",gx[gx.D250=8]="D250",gx[gx.D500=9]="D500",gx[gx.D1000=10]="D1000",gx[gx.D2000=11]="D2000",gx[gx.D4000=12]="D4000";var Cx,Ax,kx,Rx,Ox,Mx,Ix,Lx,zx,Bx,Px,Dx,Fx,Nx,Ux,Vx,Gx,Hx,Wx,qx,jx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eS,tS,iS,nS,rS,aS,sS,oS,lS,uS,cS,hS,dS=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],fS=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],pS=[100,200,400,800],_S=new Fi,vS=new Fi,mS=new zn,yS=new zn,gS=Nc.STENCIL<<1,bS=function(){function i(e,t){y(this,i),this._scene=void 0,this._name=void 0,this._enabled=!1,this._proj=void 0,this._isWindowSize=!0,this._width=void 0,this._height=void 0,this._screenScale=void 0,this._aspect=void 0,this._orthoHeight=10,this._fov=mi(45),this._nearClip=1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=Nc.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new Zn(0,0,1,1),this._isProjDirty=!0,this._matView=new zn,this._matProj=new zn,this._matProjInv=new zn,this._matViewProj=new zn,this._matViewProjInv=new zn,this._frustum=new ds,this._forward=new Fi,this._position=new Fi,this._node=null,this._view=void 0,this._visibility=Rh,this._priority=0,this._aperture=px.F16_0,this._apertureValue=void 0,this._shutter=yx.D125,this._shutterValue=0,this._iso=vx.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._scene=e,this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._apertureValue=dS[this._aperture],this._shutterValue=fS[this._shutter],this._isoValue=pS[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1,this._view=this._scene.root.createView({camera:this,name:this._name,priority:this._priority,flows:t.flows}),this.changeTargetWindow(t.window),console.log("Create Camera: "+this._name+" "+this._width+" x "+this._height)}return v(i,[{key:"destroy",value:function(){this._scene.root.destroyView(this._view)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(e){var t=0<arguments.length&&void 0!==e&&e;if(this._node){if((this._node.hasChangedFlags||t)&&(zn.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){if(this._proj===dx.PERSPECTIVE)zn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var i=this._orthoHeight*this._aspect,n=this._orthoHeight;zn.ortho(this._matProj,-i,i,-n,n,this._nearClip,this._farClip)}zn.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||t)&&(zn.multiply(this._matViewProj,this._matProj,this._matView),zn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),zn.invert(this._matView,this.node.worldMatrix),this._proj===dx.PERSPECTIVE)zn.perspective(mS,this._fov,this._aspect,t,i);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;zn.ortho(mS,-n,n,-r,r,t,i)}zn.multiply(yS,mS,this._matView),zn.invert(mS,yS),e.update(yS,mS)}}},{key:"changeTargetWindow",value:function(e){var t=0<arguments.length&&void 0!==e?e:null,i=this._scene,n=t||i.root.mainWindow;n&&(this._view.window=n,this.resize(n.width,n.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this._viewport.x*this._width,r=this._viewport.y*this._height,a=this._viewport.width*this._width,s=this._viewport.height*this._height;return Fi.set(_S,(t-n)/a*2-1,(i-r)/s*2-1,1),Fi.transformMat4(_S,_S,this._matViewProjInv),this._proj===dx.PERSPECTIVE?this._node&&this._node.getWorldPosition(vS):(Fi.set(vS,(t-n)/a*2-1,(i-r)/s*2-1,-1),Fi.transformMat4(vS,vS,this._matViewProjInv)),ta.fromPoints(e,vS,_S)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return this._proj===dx.PERSPECTIVE?(Fi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),Fi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(_S),Fi.lerp(e,_S,e,vi(this._nearClip/this._farClip,1,t.z))):(Fi.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),Fi.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return Fi.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize},set:function(e){this._isWindowSize=e}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum}},{key:"forward",get:function(){return this._forward}},{key:"position",get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view.visibility=e},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view.priority},set:function(e){this._priority=e,this._view.priority=this._priority}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=dS[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=fS[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=pS[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}}]),i}(),xS=function(){function t(e){y(this,t),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=t.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=e}return v(t,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),v(t,[{key:"update",value:function(){}}]),t}();xS.SUN_ILLUM=65e3,xS.SKY_ILLUM=2e4;var SS=new Fi(0,1,0),wS=new Fi,TS=new hn,ES=(Cx=oo("cc.AmbientInfo"),Ax=lo({type:rr}),kx=lo({type:rr}),Cx((Mx=b((Ox=function(){function e(){y(this,e),m(this,"_skyColor",Mx,this),m(this,"_skyIllum",Ix,this),m(this,"_groundAlbedo",Lx,this),this._resource=null}return v(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&rr.toArray(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&Fi.toArray(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(51,128,204,1)}}),Ix=b(Ox.prototype,"_skyIllum",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xS.SKY_ILLUM}}),Lx=b(Ox.prototype,"_groundAlbedo",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(51,51,51,255)}}),b(Ox.prototype,"skyColor",[Ax],Object.getOwnPropertyDescriptor(Ox.prototype,"skyColor"),Ox.prototype),b(Ox.prototype,"skyIllum",[So],Object.getOwnPropertyDescriptor(Ox.prototype,"skyIllum"),Ox.prototype),b(Ox.prototype,"groundAlbedo",[kx],Object.getOwnPropertyDescriptor(Ox.prototype,"groundAlbedo"),Ox.prototype),Rx=Ox))||Rx);cc.AmbientInfo=ES;var CS=(zx=oo("cc.SkyboxInfo"),Bx=lo(xf),Px=lo({type:Rt}),Dx=lo({type:Rt}),Fx=lo({type:xf}),Nx=lo({type:Rt}),zx((Gx=b((Vx=function(){function e(){y(this,e),m(this,"_envmap",Gx,this),m(this,"_isRGBE",Hx,this),m(this,"_enabled",Wx,this),m(this,"_useIBL",qx,this),this._resource=null}return v(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hx=b(Vx.prototype,"_isRGBE",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wx=b(Vx.prototype,"_enabled",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qx=b(Vx.prototype,"_useIBL",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b(Vx.prototype,"enabled",[Px],Object.getOwnPropertyDescriptor(Vx.prototype,"enabled"),Vx.prototype),b(Vx.prototype,"useIBL",[Dx],Object.getOwnPropertyDescriptor(Vx.prototype,"useIBL"),Vx.prototype),b(Vx.prototype,"envmap",[Fx],Object.getOwnPropertyDescriptor(Vx.prototype,"envmap"),Vx.prototype),b(Vx.prototype,"isRGBE",[Nx],Object.getOwnPropertyDescriptor(Vx.prototype,"isRGBE"),Vx.prototype),Ux=Vx))||Ux);cc.SkyboxInfo=CS;var AS=(jx=oo("cc.PlanarShadowInfo"),Xx=lo({type:Rt}),Yx=lo({type:Fi}),Kx=lo({type:kt}),Qx=lo({type:rr}),jx(($x=b((Jx=function(){function e(){y(this,e),m(this,"_enabled",$x,this),m(this,"_normal",eS,this),m(this,"_distance",tS,this),m(this,"_shadowColor",iS,this),this._resource=null}return v(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(TS),this.normal=Fi.transformQuat(wS,SS,TS),e.getWorldPosition(wS),this.distance=Fi.dot(this._normal,wS)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Fi.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eS=b(Jx.prototype,"_normal",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,1,0)}}),tS=b(Jx.prototype,"_distance",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iS=b(Jx.prototype,"_shadowColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(0,0,0,76)}}),b(Jx.prototype,"enabled",[Xx],Object.getOwnPropertyDescriptor(Jx.prototype,"enabled"),Jx.prototype),b(Jx.prototype,"normal",[Yx],Object.getOwnPropertyDescriptor(Jx.prototype,"normal"),Jx.prototype),b(Jx.prototype,"distance",[Kx],Object.getOwnPropertyDescriptor(Jx.prototype,"distance"),Jx.prototype),b(Jx.prototype,"shadowColor",[Qx],Object.getOwnPropertyDescriptor(Jx.prototype,"shadowColor"),Jx.prototype),Zx=Jx))||Zx);cc.PlanarShadowInfo=AS;var kS,RS,OS,MS,IS=(nS=oo("cc.SceneGlobals"),rS=lo({type:ES}),aS=lo({type:CS}),sS=lo({type:AS}),nS((uS=b((lS=function(){function e(){y(this,e),m(this,"ambient",uS,this),m(this,"skybox",cS,this),m(this,"planarShadows",hS,this)}return v(e,[{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ES}}),cS=b(lS.prototype,"skybox",[aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CS}}),hS=b(lS.prototype,"planarShadows",[sS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AS}}),oS=lS))||oS);cc.SceneGlobals=IS;var LS,zS=q3("Scene",oo("cc.Scene")((OS=b((RS=function(){function i(e){var t;return y(this,i),m(t=x(this,g(i).call(this,e)),"autoReleaseAssets",OS,l(t)),m(t,"_globals",MS,l(t)),t._renderScene=null,t.dependAssets=null,t._inited=void 0,t._prefabSyncedInLiveReload=!1,t._pos=Fi.ZERO,t._rot=hn.IDENTITY,t._scale=Fi.ONE,t._mat=zn.IDENTITY,t._dirtyFlags=0,t._activeInHierarchy=!1,cc.director&&cc.director.root&&(t._renderScene=cc.director.root.createScene({})),t._inited=!cc.game||!cc.game._isCloning,t}return p(i,Zp),v(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),v(i,[{key:"destroy",value:function(){var e=_(g(i.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){return B(3822),null}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){_(g(i.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return Fi.copy(e||new Fi,Fi.ZERO)}},{key:"getRotation",value:function(e){return hn.copy(e||new hn,hn.IDENTITY)}},{key:"getScale",value:function(e){return Fi.copy(e||new Fi,Fi.ONE)}},{key:"getWorldPosition",value:function(e){return Fi.copy(e||new Fi,Fi.ZERO)}},{key:"getWorldRotation",value:function(e){return hn.copy(e||new hn,hn.IDENTITY)}},{key:"getWorldScale",value:function(e){return Fi.copy(e||new Fi,Fi.ONE)}},{key:"getWorldMatrix",value:function(e){return zn.copy(e||new zn,zn.IDENTITY)}},{key:"getWorldRS",value:function(e){return zn.copy(e||new zn,zn.IDENTITY)}},{key:"getWorldRT",value:function(e){return zn.copy(e||new zn,zn.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(Zp._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}},{key:"position",get:function(){return Fi.ZERO}},{key:"worldPosition",get:function(){return Fi.ZERO}},{key:"rotation",get:function(){return hn.IDENTITY}},{key:"worldRotation",get:function(){return hn.IDENTITY}},{key:"scale",get:function(){return Fi.ONE}},{key:"worldScale",get:function(){return Fi.ONE}},{key:"eulerAngles",get:function(){return Fi.ZERO}},{key:"worldMatrix",get:function(){return zn.IDENTITY}}]),i}()).prototype,"autoReleaseAssets",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MS=b(RS.prototype,"_globals",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IS}}),kS=RS))||kS);cc.Scene=zS;var BS=Ho.Flags.HideInHierarchy,PS=q3("PrivateNode",oo("cc.PrivateNode")(LS=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._objFlags|=BS,t}return p(i,f_),i}())||LS);cc.PrivateNode=PS;function DS(e){e.start(),e._objFlags|=VS}function FS(e,t){e.update(t)}function NS(e,t){e.lateUpdate(t)}var US=$e.fastRemoveAt,VS=Ho.Flags.IsStartCalled,GS=Ho.Flags.IsOnEnableCalled;Ho.Flags.IsEditorOnEnableCalled;function HS(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,s=a>>>1;r<=a;s=r+a>>>1){var o=e[s],l=o.constructor._executionOrder;if(i<l)a=s-1;else if(l<i)r=s+1;else{var u=o._id;if(n<u)a=s-1;else{if(!(u<n))return s;r=s+1}}}return~r}function WS(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}function qS(e){y(this,qS),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ce;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}function jS(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}qS.stableRemoveInactive=WS;var XS=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,qS),v(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){WS(this._zero,e),WS(this._neg,e),WS(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;0<e.array.length&&(e.array.sort(jS),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;0<t.array.length&&(t.array.sort(jS),this._invoke(t),t.array.length=0)}}]),e}(),YS=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,qS),v(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=HS(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=HS(i.array,e);0<=n&&i.removeAt(n)}}},{key:"invoke",value:function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)}}]),e}();function KS(r,e){if("function"==typeof r)return e?function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];r(n,t)}}:function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];r(i)}};var t="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+r+"}";return e?Function("it","dt",t):Function("it",t)}var QS=function(){function e(){y(this,e),this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this.scheduleInNextFrame=void 0,this._updating=void 0,this.unscheduleAll()}return v(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new XS(KS(DS)),this.updateInvoker=new YS(KS(FS,!0)),this.lateUpdateInvoker=new YS(KS(NS,!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=GS,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~GS;var t=this.scheduleInNextFrame.indexOf(e);0<=t?US(this.scheduleInNextFrame,t):(!e.start||e._objFlags&VS||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&GS)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&GS&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,0<this.scheduleInNextFrame.length&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&VS||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var n=e[t];this._scheduleImmediate(n)}e.length=0}}]),e}();QS.LifeCycleInvoker=qS,QS.OneOffInvoker=XS,QS.createInvokeImpl=KS,QS.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),n.node._activeInHierarchy&&t._onEnabled(n)}};function ZS(e){e.__preload()}function JS(e){e.onLoad(),e._objFlags|=tw}var $S=Ho.Flags.IsPreloadStarted,ew=Ho.Flags.IsOnLoadStarted,tw=Ho.Flags.IsOnLoadCalled,iw=Ho.Flags.Deactivating,nw=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,QS.LifeCycleInvoker),v(e,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){QS.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),e}(),rw=QS.createInvokeImpl(ZS),aw=QS.createInvokeImpl(JS),sw=new Je(4);sw.get=function(){var e=this._get()||{preload:new nw(rw),onLoad:new QS.OneOffInvoker(aw),onEnable:new QS.OneOffInvoker(QS.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var ow=q3("NodeActivator",function(){function e(){y(this,e),this.resetComp=void 0,this._activatingStack=void 0,this.reset()}return v(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=sw.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),sw.put(i)}else{this._deactivateNodeRecursively(e);var n=this._activatingStack,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.preload.cancelInactive($S),o.onLoad.cancelInactive(ew),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&$S||(e._objFlags|=$S,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&ew||(e._objFlags|=ew,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=tw):e._objFlags|=tw),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&tw&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&iw)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r,a,s,o=e._components.length,l=0;l<o;++l){var u=e._components[l];u instanceof cc.Component?this.activateComp(u,t,i,n):(r=e,s=l,(a=u)?r._removeComponent(a):$e.removeAt(r._components,s),--l,--o)}e._childArrivalOrder=e._children.length;for(var c=0,h=e._children.length;c<h;++c){var d=e._children[c];d._active&&this._activateNodeRecursively(d,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=iw,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~iw)}for(var r=0,a=e._children.length;r<a;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~iw)}e._onPostActivated(!1),e._objFlags&=~iw}}]),e}());sr(Zp.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),or(f_.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),or(ah,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),sr(ah,"Layers",[{name:"Default",newName:"DEFAULT",target:ah.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:ah.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:ah.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:ah.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:ah.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:ah.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:ah.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:ah.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:ah,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:ah,targetName:"Layers"}]),or(ah.Enum,"Layers.Enum",[{name:"ALWAYS"}]),or(ah.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var lw=new Float32Array(4),uw=new Fi,cw=new ji(0,0,0,0),hw=function(){function t(e){y(this,t),this._root=void 0,this._device=void 0,this._name="BasePipeline",this._renderObjects=[],this._renderPasses=new Map,this._flows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._shadingPass=null,this._fboCount=0,this._msaaShadingTex=null,this._msaaShadingTexView=null,this._msaaDepthStencilTex=null,this._msaaDepthStencilTexView=null,this._msaaShadingFBO=null,this._colorFmt=Ou.UNKNOWN,this._depthStencilFmt=Ou.UNKNOWN,this._shadingTextures=[],this._shadingTexViews=[],this._depthStencilTex=null,this._depthStencilTexView=null,this._shadingFBOs=[],this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx=0,this._prevIdx=1,this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._smaaPass=null,this._smaaEdgeFBO=null,this._smaaEdgeTex=null,this._smaaEdgeTexView=null,this._smaaBlendFBO=null,this._smaaBlendTex=null,this._smaaBlendTexView=null,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new fh,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._useDynamicBatching=!1,this._root=e,this._device=e.device}return v(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return this._name}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"curShadingTexView",get:function(){return this._shadingTexViews[this._curIdx]}},{key:"prevShadingTexView",get:function(){return this._shadingTexViews[this._prevIdx]}},{key:"curShadingFBO",get:function(){return this._shadingFBOs[this._curIdx]}},{key:"prevShadingFBO",get:function(){return this._shadingFBOs[this._prevIdx]}},{key:"msaaShadingFBO",get:function(){return this._msaaShadingFBO}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"smaaEdgeTexView",get:function(){return this._smaaEdgeTexView}},{key:"smaaEdgeFBO",get:function(){return this._smaaEdgeFBO}},{key:"smaaBlendTexView",get:function(){return this._smaaBlendTexView}},{key:"smaaBlendFBO",get:function(){return this._smaaBlendFBO}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}},{key:"useDynamicBatching",get:function(){return this._useDynamicBatching}}]),v(t,[{key:"render",value:function(e){e.camera.update(),this.sceneCulling(e),this.updateUBOs(e);var t=e.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);var r=this._flows,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.resize(e,t)}}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"createFlow",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._flows.push(i),this._flows.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyFlows",value:function(){var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._flows=[]}},{key:"getFlow",value:function(e){var t=this._flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===e)return a}return null}},{key:"updateMacros",value:function(){Vh.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;var e=this._root.scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}}},{key:"_initialize",value:function(e){if(void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:this._usePostProcess=!1,this._usePostProcess&&((this._device.hasFeature(eh.FORMAT_R11G11B10F)||this._device.hasFeature(eh.TEXTURE_HALF_FLOAT)||this._device.hasFeature(eh.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._shadingTextures=new Array(this._fboCount),this._shadingTexViews=new Array(this._fboCount),this._shadingFBOs=new Array(this._fboCount),this._isHDR=void 0===e.enableHDR||e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,this._useMSAA&&(this._useMSAA=this.device.hasFeature(eh.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(eh.COLOR_HALF_FLOAT)&&this._device.hasFeature(eh.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(eh.FORMAT_R11G11B10F)?(this._colorFmt=Ou.R11G11B10F,this._isHDR=!0):this._device.hasFeature(eh.TEXTURE_HALF_FLOAT)&&(this._colorFmt=Ou.RGBA16F,this._isHDR=!0):this._device.hasFeature(eh.COLOR_FLOAT)&&this._device.hasFeature(eh.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(eh.TEXTURE_FLOAT)&&(this._colorFmt=Ou.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=Ou.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=Ou.D24S8:this._depthStencilFmt=Ou.D24:this._depthStencilFmt=Ou.D16,this.updateMacros(),this._shadingScale=1,this._shadingWidth=Math.floor(this._device.nativeWidth),this._shadingHeight=Math.floor(this._device.nativeHeight),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+Xc[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+Xc[this._depthStencilFmt].name),this._shadingPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ec.CLEAR,storeOp:Ac.STORE,sampleCount:1,beginLayout:Rc.COLOR_ATTACHMENT_OPTIMAL,endLayout:Rc.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ec.CLEAR,depthStoreOp:Ac.STORE,stencilLoadOp:Ec.CLEAR,stencilStoreOp:Ac.STORE,sampleCount:1,beginLayout:Rc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Rc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),this._useMSAA&&(this._msaaShadingTex=this._device.createTexture({type:lc.TEX2D,usage:hc.COLOR_ATTACHMENT|hc.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaShadingTexView=this._device.createTextureView({texture:this._msaaShadingTex,type:mc.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex=this._device.createTexture({type:lc.TEX2D,usage:hc.DEPTH_STENCIL_ATTACHMENT|hc.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaDepthStencilTexView=this._device.createTextureView({texture:this._msaaDepthStencilTex,type:mc.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),0<this._fboCount){this._depthStencilTex=this._device.createTexture({type:lc.TEX2D,usage:hc.DEPTH_STENCIL_ATTACHMENT|hc.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:mc.TV2D,format:this._depthStencilFmt});for(var t=0;t<this._fboCount;++t)this._shadingTextures[t]=this._device.createTexture({type:lc.TEX2D,usage:hc.COLOR_ATTACHMENT|hc.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._shadingTexViews[t]=this._device.createTextureView({texture:this._shadingTextures[t],type:mc.TV2D,format:this._colorFmt}),this._shadingFBOs[t]=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[t]],depthStencilView:this._depthStencilTexView})}if(this._useSMAA){var i=Ou.RGBA8;this._smaaPass=this._device.createRenderPass({colorAttachments:[{format:i,loadOp:Ec.CLEAR,storeOp:Ac.STORE,sampleCount:1,beginLayout:Rc.COLOR_ATTACHMENT_OPTIMAL,endLayout:Rc.COLOR_ATTACHMENT_OPTIMAL}]}),this._smaaEdgeTex=this._device.createTexture({type:lc.TEX2D,usage:hc.COLOR_ATTACHMENT|hc.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaEdgeTexView=this._device.createTextureView({texture:this._smaaEdgeTex,type:mc.TV2D,format:i}),this._smaaEdgeFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex=this._device.createTexture({type:lc.TEX2D,usage:hc.COLOR_ATTACHMENT|hc.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaBlendTexView=this._device.createTextureView({texture:this._smaaBlendTex,type:mc.TV2D,format:i}),this._smaaBlendFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}return!!this.createQuadInputAssembler()&&!!this.createUBOs()}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs(),this._smaaEdgeTexView&&(this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView=null),this._smaaEdgeTex&&(this._smaaEdgeTex.destroy(),this._smaaEdgeTex=null),this._smaaEdgeFBO&&(this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO=null),this._smaaBlendTexView&&(this._smaaBlendTexView.destroy(),this._smaaBlendTexView=null),this._smaaBlendTex&&(this._smaaBlendTex.destroy(),this._smaaBlendTex=null),this._smaaBlendFBO&&(this._smaaBlendFBO.destroy(),this._smaaBlendFBO=null),this._msaaShadingTexView&&(this._msaaShadingTexView.destroy(),this._msaaShadingTexView=null),this._msaaShadingTex&&(this._msaaShadingTex.destroy(),this._msaaShadingTex=null),this._msaaDepthStencilTexView&&(this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView=null),this._msaaDepthStencilTex&&(this._msaaDepthStencilTex.destroy(),this._msaaDepthStencilTex=null),this._msaaShadingFBO&&(this._msaaShadingFBO.destroy(),this._msaaShadingFBO=null);for(var e=0;e<this._shadingTexViews.length;++e)this._shadingTexViews[e]&&this._shadingTexViews[e].destroy(),this._shadingTextures[e]&&this._shadingTextures[e].destroy(),this._shadingFBOs[e]&&this._shadingFBOs[e].destroy();this._shadingTexViews.splice(0),this._shadingTextures.splice(0),this._shadingFBOs.splice(0),this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._shadingPass&&(this._shadingPass.destroy(),this._shadingPass=null)}},{key:"resizeFBOs",value:function(e,t){this._shadingWidth=e,this._shadingHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:mc.TV2D,format:this._depthStencilFmt}));for(var i=0;i<this._fboCount;++i)this._shadingTextures[i].resize(e,t),this._shadingTexViews[i].destroy(),this._shadingTexViews[i].initialize({texture:this._shadingTextures[i],type:mc.TV2D,format:this._colorFmt}),this._shadingFBOs[i].destroy(),this._shadingFBOs[i].initialize({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[i]],depthStencilView:this._depthStencilTexView});if(this._useMSAA&&(this._msaaShadingTex.resize(e,t),this._msaaShadingTexView.destroy(),this._msaaShadingTexView.initialize({texture:this._msaaShadingTex,type:mc.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex.resize(e,t),this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView.initialize({texture:this._msaaDepthStencilTex,type:mc.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO.destroy(),this._msaaShadingFBO.initialize({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._useSMAA){var n=this._smaaEdgeTex.format;this._smaaEdgeTex.resize(e,t),this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView.initialize({texture:this._smaaEdgeTex,type:mc.TV2D,format:n}),this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex.resize(e,t),this._smaaBlendTexView.destroy(),this._smaaBlendTexView.initialize({texture:this._smaaBlendTex,type:mc.TV2D,format:n}),this._smaaBlendFBO.destroy(),this._smaaBlendFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,this._quadIB.update(s);var o=[{name:"a_position",format:Ou.RG32F},{name:"a_texCoord",format:Ou.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(fh.BLOCK.name)){var e=this._root.device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:fh.SIZE});this._globalBindings.set(fh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:fh.BLOCK,buffer:e})}if(!this._globalBindings.get(ph.BLOCK.name)){var t=this._root.device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:ph.SIZE});this._globalBindings.set(ph.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:ph.BLOCK,buffer:t})}return this._globalBindings.get(vh.name)||this._globalBindings.set(vh.name,{type:xc.SAMPLER,samplerInfo:vh}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(fh.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(fh.BLOCK.name));var t=this._globalBindings.get(ph.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(ph.BLOCK.name))}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,s=this._uboGlobal.view;s[fh.TIME_OFFSET]=this._root.cumulativeTime,s[fh.SCREEN_SIZE_OFFSET]=n.width,s[fh.SCREEN_SIZE_OFFSET+1]=n.height,s[fh.SCREEN_SIZE_OFFSET+2]=1/s[fh.SCREEN_SIZE_OFFSET],s[fh.SCREEN_SIZE_OFFSET+3]=1/s[fh.SCREEN_SIZE_OFFSET+1],s[fh.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,s[fh.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,s[fh.SCREEN_SCALE_OFFSET+2]=1/s[fh.SCREEN_SCALE_OFFSET],s[fh.SCREEN_SCALE_OFFSET+3]=1/s[fh.SCREEN_SCALE_OFFSET+1],s[fh.NATIVE_SIZE_OFFSET]=this._shadingWidth,s[fh.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,s[fh.NATIVE_SIZE_OFFSET+2]=1/s[fh.NATIVE_SIZE_OFFSET],s[fh.NATIVE_SIZE_OFFSET+3]=1/s[fh.NATIVE_SIZE_OFFSET+1],zn.toArray(s,t.matView,fh.MAT_VIEW_OFFSET),zn.toArray(s,t.node.worldMatrix,fh.MAT_VIEW_INV_OFFSET),zn.toArray(s,t.matProj,fh.MAT_PROJ_OFFSET),zn.toArray(s,t.matProjInv,fh.MAT_PROJ_INV_OFFSET),zn.toArray(s,t.matViewProj,fh.MAT_VIEW_PROJ_OFFSET),zn.toArray(s,t.matViewProjInv,fh.MAT_VIEW_PROJ_INV_OFFSET),Fi.toArray(s,t.position,fh.CAMERA_POS_OFFSET);var o=t.exposure;if(s[fh.EXPOSURE_OFFSET]=o,s[fh.EXPOSURE_OFFSET+1]=1/o,s[fh.EXPOSURE_OFFSET+2]=this._isHDR?1:0,s[fh.EXPOSURE_OFFSET+3]=this._fpScale/o,Fi.toArray(s,r.direction,fh.MAIN_LIT_DIR_OFFSET),r.enabled){if(Fi.toArray(s,r.color,fh.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;s[fh.MAIN_LIT_COLOR_OFFSET]*=l.x,s[fh.MAIN_LIT_COLOR_OFFSET+1]*=l.y,s[fh.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?s[fh.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:s[fh.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*o}else ji.toArray(s,cw,fh.MAIN_LIT_COLOR_OFFSET);lw.set(a.skyColor),this._isHDR?lw[3]=a.skyIllum*this._fpScale:lw[3]=a.skyIllum*o,this._uboGlobal.view.set(lw,fh.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,fh.AMBIENT_GROUND_OFFSET),this._globalBindings.get(fh.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.splice(0);var n=i.mainLight;n&&n.enabled&&n.update();var r=i.planarShadows;r.enabled&&n.node.hasChangedFlags&&r.updateDirLight(n),i.skybox.enabled&&t.clearFlag&gS&&this.addVisibleModel(i.skybox,t);var a=i.models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;if(u._resetUBOUpdateFlag(),u.enabled)if(e.visibility&ah.BitMask.UI_2D)(u.node&&e.visibility===u.node.layer||e.visibility===u.visFlags)&&(u.updateTransform(),u.updateUBOs(),this.addVisibleModel(u,t));else if(u.node&&(e.visibility&u.node.layer)===u.node.layer||e.visibility&u.visFlags){if(u.updateTransform(),u.worldBounds&&!Ga.aabb_frustum(u.worldBounds,t.frustum))continue;u.updateUBOs(),this.addVisibleModel(u,t)}}r.enabled&&r.updateCommandBuffers()}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(e.node.getWorldPosition(uw),Fi.subtract(uw,uw,t.position),i=Fi.dot(uw,t.forward)),this._renderObjects.push({model:e,depth:i})}}]),t}(),dw=function(){function i(e,t){y(this,i),this.array=void 0,this.length=0,this.cache=void 0,this._compareFn=void 0,this.array=new Array(e),this.cache=this.array,this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}return v(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[this.length--]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.cache.fill(null),this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e.array[t]}},{key:"append",value:function(e){var t=e,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;this.array[this.length++]=a}}}]),i}();function fw(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function pw(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var _w=function(){function t(e){y(this,t),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passDesc=e,this.cmdBuffs=new dw(64),this.queue=new dw(64,this._passDesc.sortFunc)}return v(t,[{key:"clear",value:function(){this.queue.clear(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i;return this.queue.push({hash:s,depth:e.depth,shaderId:a.shader.id,subModel:n,cmdBuff:n.commandBuffers[i]}),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),t}(),vw=[],mw=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._uiQueue=void 0,t._uiQueue=new _w({isTransparent:!0,phases:om("default"),sortFunc:pw}),t}return p(i,Sx),v(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:wc.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._uiQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._uiQueue.insertRenderPass(a,s,o)}this._uiQueue.sort();var l=e.window.framebuffer,u=this._cmdBuff,c=e.camera,h=c.viewport;this._renderArea.x=h.x*c.width,this._renderArea.y=h.y*c.height,this._renderArea.width=h.width*c.width,this._renderArea.height=h.height*c.height,u.begin(),u.beginRenderPass(l,this._renderArea,c.clearFlag,[c.clearColor],c.clearDepth,c.clearStencil),u.execute(this._uiQueue.cmdBuffs.array,this._uiQueue.cmdBuffCount),u.endRenderPass(),u.end(),vw[0]=u,this._device.queue.submit(vw)}}]),i}(),yw=function(){function i(e){return y(this,i),x(this,g(i).call(this,e))}return p(i,xx),v(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._pipeline.root.mainWindow;return!(!t||!t.framebuffer)&&(this.createStage(mw,{name:"UIStage",priority:0,framebuffer:t.framebuffer}),!0)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=this.pipeline.defaultGlobalUBOData[fh.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[fh.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(fh.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),_(g(i.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[fh.EXPOSURE_OFFSET+2]=t,this.pipeline.globalBindings.get(fh.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),i}();var gw,bw,xw=function(){function e(){y(this,e),this.queue=new Set}return v(e,[{key:"clear",value:function(){var e=this.queue.values(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.clear()}this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){var t=this.queue.values(),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=!1,o=0;o<a.batches.length;++o){var l=a.batches[o];if(l.mergeCount){for(var u=0;u<l.vbs.length;++u)l.vbs[u].update(l.vbDatas[u]);l.vbIdx.update(l.vbIdxData.buffer),l.ubo.update(l.uboData.view),s||(e.bindPipelineState(l.pso),s=!0),e.bindBindingLayout(l.pso.pipelineLayout.layouts[0]),e.bindInputAssembler(l.ia),e.draw(l.ia)}}}}}]),e}(),Sw=[],ww=[],Tw=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._opaqueQueue=void 0,t._transparentQueue=void 0,t._opaqueBatchedQueue=void 0,t._opaqueQueue=new _w({isTransparent:!1,phases:om("default"),sortFunc:fw}),t._transparentQueue=new _w({isTransparent:!0,phases:om("default")|om("planarShadow"),sortFunc:pw}),t._opaqueBatchedQueue=new xw,t}return p(i,Sx),v(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:wc.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueBatchedQueue.clear(),this._opaqueQueue.clear(),this._transparentQueue.clear();for(var t=this._pipeline.renderObjects,i=0;i<t.length;++i){var n=t[i];if(n.model.isDynamicBatching)for(var r=0;r<n.model.subModels.length;++r)for(var a=n.model.subModels[r],s=a.passes,o=0;o<s.length;++o){var l=a.passes[o];if(l.batchedBuffer){var u=a.psos[o];if(u.blendState.targets[0].blend){var c=0|l.priority<<16|a.priority<<8|o;this._transparentQueue.queue.push({hash:c,depth:n.depth,shaderId:u.shader.id,subModel:a,cmdBuff:a.commandBuffers[o]})}else l.batchedBuffer.merge(a,n,u),this._opaqueBatchedQueue.queue.add(l.batchedBuffer)}}else for(var h=n.model.subModels,d=0;d<h.length;++d)for(var f=h[d],p=f.passes,_=0;_<p.length;++_){var v=f.passes[_],m=f.psos[_],y=m.blendState.targets[0].blend,g=0|v.priority<<16|f.priority<<8|_;y?this._transparentQueue.queue.push({hash:g,depth:n.depth,shaderId:m.shader.id,subModel:f,cmdBuff:f.commandBuffers[_]}):this._opaqueQueue.queue.push({hash:g,depth:n.depth,shaderId:m.shader.id,subModel:f,cmdBuff:f.commandBuffers[_]})}}this._opaqueQueue.sort(),this._transparentQueue.sort();var b=e.camera,x=this._cmdBuff,S=b.viewport;if(this._renderArea.x=S.x*b.width,this._renderArea.y=S.y*b.height,this._renderArea.width=S.width*b.width*this.pipeline.shadingScale,this._renderArea.height=S.height*b.height*this.pipeline.shadingScale,b.clearFlag&Nc.COLOR){if(Sw[0]=b.clearColor,this._pipeline.isHDR){Sw[0]=function(e){return{r:Math.pow(e.r,2.2),g:Math.pow(e.g,2.2),b:Math.pow(e.b,2.2),a:1}}(Sw[0]);var w=this._pipeline.fpScale/b.exposure;Sw[0].r*=w,Sw[0].g*=w,Sw[0].b*=w}Sw.length=1}this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.msaaShadingFBO:this._framebuffer=this._pipeline.curShadingFBO:this._framebuffer=e.window.framebuffer;var T=b.scene.planarShadows;x.begin(),x.beginRenderPass(this._framebuffer,this._renderArea,b.clearFlag,Sw,b.clearDepth,b.clearStencil),x.execute(this._opaqueQueue.cmdBuffs.array,this._opaqueQueue.cmdBuffCount),this._opaqueBatchedQueue.recordCommandBuffer(x),b.visibility&ah.BitMask.DEFAULT&&x.execute(T.cmdBuffs.array,T.cmdBuffCount),x.execute(this._transparentQueue.cmdBuffs.array,this._transparentQueue.cmdBuffCount),x.endRenderPass(),x.end(),ww[0]=x,this._device.queue.submit(ww),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.curShadingFBO,this._renderArea,this._renderArea,rc.POINT)}}]),i}();(bw=gw=gw||{})[bw.FORWARD=0]="FORWARD";var Ew,Cw,Aw=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return p(t,xx),v(t,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this.createStage(Tw,{name:"ForwardStage",priority:gw.FORWARD}),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}();(Cw=Ew=Ew||{})[Cw.FORWARD=0]="FORWARD",Cw[Cw.UI=10]="UI";var kw,Rw,Ow=new Float32Array(4),Mw=$a.create(0,0,0,1),Iw=[],Lw=[],zw=new Fi,Bw=function(){function d(e){var t;return y(this,d),(t=x(this,g(d).call(this,e)))._uboLights=new gh,t._lightsUBO=null,t._validLights=void 0,t._lightIndexOffset=void 0,t._lightIndices=void 0,t._validLights=[],t._lightIndexOffset=[],t._lightIndices=[],t}return p(d,hw),v(d,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),v(d,[{key:"initialize",value:function(e){if(!this._initialize(e))return!1;if(this._name="ForwardPipeline",!this._globalBindings.get(gh.BLOCK.name)){var t=this._root.device.createBuffer({usage:Iu.UNIFORM|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:gh.SIZE});if(!t)return!1;this._globalBindings.set(gh.BLOCK.name,{type:xc.UNIFORM_BUFFER,blockInfo:gh.BLOCK,buffer:t})}var i=this._root.mainWindow,n=null;return i&&(n=i.renderPass),n?(this.addRenderPass(sh.DEFAULT,n),this.createFlow(Aw,{name:"ForwardFlow",priority:Ew.FORWARD}),this._usePostProcess&&(this._useSMAA,this.createFlow(Ex,{name:"ToneMapFlow",priority:0})),this.createFlow(yw,{name:"UIFlow",priority:Ew.UI}),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"destroy",value:function(){var e=this._globalBindings.get(gh.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(gh.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){_(g(d.prototype),"rebuild",this).call(this);var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}},{key:"updateUBOs",value:function(e){_(g(d.prototype),"updateUBOs",this).call(this,e);for(var t=e.camera.exposure,i=0;i<this._renderObjects.length;i++){this._uboLights.view.fill(0);var n=i+1<this._renderObjects.length?this._lightIndexOffset[i+1]:this._lightIndices.length;if(this._renderObjects[i].model.localBindings.get(gh.BLOCK.name)){for(var r=0,a=0,s=this._lightIndexOffset[i];s<n;s++){var o=this._validLights[this._lightIndices[s]];if(o&&o.enabled)switch(o.type){case ex.SPHERE:if(gh.MAX_SPHERE_LIGHTS<=r)continue;var l=o;if(Fi.toArray(Ow,l.position),this._uboLights.view.set(Ow,gh.SPHERE_LIGHT_POS_OFFSET+4*r),Ow[0]=l.size,Ow[1]=l.range,Ow[2]=0,this._uboLights.view.set(Ow,gh.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*r),Fi.toArray(Ow,o.color),o.useColorTemperature){var u=o.colorTemperatureRGB;Ow[0]*=u.x,Ow[1]*=u.y,Ow[2]*=u.z}this._isHDR?Ow[3]=l.luminance*this._fpScale*this._lightMeterScale:Ow[3]=l.luminance*t*this._lightMeterScale,this._uboLights.view.set(Ow,gh.SPHERE_LIGHT_COLOR_OFFSET+4*r),r++;break;case ex.SPOT:if(gh.MAX_SPOT_LIGHTS<=a)continue;var c=o;if(Fi.toArray(Ow,c.position),Ow[3]=c.size,this._uboLights.view.set(Ow,gh.SPOT_LIGHT_POS_OFFSET+4*a),Ow[0]=c.size,Ow[1]=c.range,Ow[2]=c.spotAngle,this._uboLights.view.set(Ow,gh.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*a),Fi.toArray(Ow,c.direction),this._uboLights.view.set(Ow,gh.SPOT_LIGHT_DIR_OFFSET+4*a),Fi.toArray(Ow,o.color),o.useColorTemperature){var h=o.colorTemperatureRGB;Ow[0]*=h.x,Ow[1]*=h.y,Ow[2]*=h.z}this._isHDR?Ow[3]=c.luminance*this._fpScale*this._lightMeterScale:Ow[3]=c.luminance*t*this._lightMeterScale,this._uboLights.view.set(Ow,gh.SPOT_LIGHT_COLOR_OFFSET+4*a),a++}}this._renderObjects[i].model.localBindings.get(gh.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){_(g(d.prototype),"sceneCulling",this).call(this,e),this._validLights.splice(0);var t=e.camera.scene.sphereLights,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.enabled&&(a.update(),$a.set(Mw,a.position.x,a.position.y,a.position.z,a.range),Ga.sphere_frustum(Mw,e.camera.frustum)&&this._validLights.push(a))}var s=e.camera.scene.spotLights,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;c.enabled&&(c.update(),$a.set(Mw,c.position.x,c.position.y,c.position.z,c.range),Ga.sphere_frustum(Mw,e.camera.frustum)&&this._validLights.push(c))}this._lightIndexOffset.splice(0),this._lightIndices.splice(0);for(var h=0;h<this._renderObjects.length;h++)this._lightIndexOffset[h]=this._lightIndices.length,this._renderObjects[h].model.localBindings.get(gh.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[h].model)}},{key:"cullLightPerModel",value:function(e){var t,i,n,r,a;Iw.splice(0);for(var s=0;s<this._validLights.length;s++){var o=!1;switch(this._validLights[s].type){case ex.DIRECTIONAL:this._validLights[s],o=!1;break;case ex.SPHERE:r=this._validLights[s],o=!(!(a=e).worldBounds||Ga.aabb_aabb(a.worldBounds,r.aabb));break;case ex.SPOT:i=this._validLights[s],o=!(!(n=e).worldBounds||Ga.aabb_aabb(n.worldBounds,i.aabb)&&Ga.aabb_frustum(n.worldBounds,i.frustum))}o||(Iw.push(s),this._validLights[s].type===ex.DIRECTIONAL?Lw[s]=0:Lw[s]=Fi.distance(this._validLights[s].position,e.node.getWorldPosition(zw)))}Iw.sort(this.sortLight),(t=this._lightIndices).push.apply(t,Iw)}},{key:"sortLight",value:function(e,t){return Lw[e]-Lw[t]}}]),d}();(Rw=kw=kw||{})[Rw.GENERAL=100]="GENERAL";var Pw=function(){function i(e,t){y(this,i),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=Rh,this._camera=void 0,this._isEnable=!0,this._flows=[],this._root=e,this._camera=t}return v(i,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(e){e._createViewFun=function(e,t){return new i(e,t)}}}]),v(i,[{key:"initialize",value:function(e){return this._name=e.name,this.priority=e.priority,e.flows||(e.flows=["ForwardFlow","ToneMapFlow","SMAAFlow"]),this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){this.flows.length=0;var t=cc.director.root.pipeline.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;-1!==e.indexOf(a.name)&&this.flows.push(a)}}}]),i}(),Dw=new Fi(0,0,-1),Fw=new Fi,Nw=new hn,Uw=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._dir=new Fi(1,-1,-1),n._illum=65e3,n._type=ex.DIRECTIONAL,n}return p(r,cx),v(r,[{key:"direction",set:function(e){this._dir=e,Fi.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),v(r,[{key:"update",value:function(){this._node&&(this._dir=Fi.transformQuat(Fw,Dw,this._node.getWorldRotation(Nw)),Fi.normalize(this._dir,this._dir))}}]),r}(),Vw=new Fi(0,0,-1),Gw=new Fi,Hw=new hn,Ww=function(){function n(e){y(this,n),this._scene=void 0,this._enabled=!1,this._normal=new Fi(0,1,0),this._distance=0,this._matLight=new zn,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._cmdBuffs=void 0,this._cmdBuffCount=0,this._psoRecord=new Map,this._cbRecord=new Map,this._passNormal=void 0,this._passSkinning=void 0,this._scene=e,this._globalBindings=e.root.pipeline.globalBindings.get(ph.BLOCK.name),this._cmdBuffs=new dw(64);var t=bd.get("pipeline/planar-shadow"),i={CC_USE_SKINNING:A_(e.root.device)};this._passNormal=dm.createPasses(t,{techIdx:0,defines:[],states:[]})[0],this._passSkinning=dm.createPasses(t,{techIdx:0,defines:[i],states:[]})[0]}return v(n,[{key:"enabled",set:function(e){this._enabled=e,this.updateDirLight(),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){Fi.copy(this._normal,e),this.updateDirLight()},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this.updateDirLight()},get:function(){return this._distance}},{key:"shadowColor",set:function(e){rr.toArray(this._data,e,ph.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),v(n,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(Gw);var t=this._normal,i=this._distance,n=Fi.dot(t,Gw),r=Gw.x,a=Gw.y,s=Gw.z,o=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=n-i-r*o,c.m01=-a*o,c.m02=-s*o,c.m03=-o,c.m04=-r*l,c.m05=n-i-a*l,c.m06=-s*l,c.m07=-l,c.m08=-r*u,c.m09=-a*u,c.m10=n-i-s*u,c.m11=-u,c.m12=r*i,c.m13=a*i,c.m14=s*i,c.m15=n,zn.toArray(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(e){(0<arguments.length&&void 0!==e?e:this._scene.mainLight).node.getWorldRotation(Hw),Fi.transformQuat(Gw,Vw,Hw);var t=this._normal,i=this._distance,n=1/Fi.dot(t,Gw),r=Gw.x*n,a=Gw.y*n,s=Gw.z*n,o=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=1-o*r,c.m01=-o*a,c.m02=-o*s,c.m03=0,c.m04=-l*r,c.m05=1-l*a,c.m06=-l*s,c.m07=0,c.m08=-u*r,c.m09=-u*a,c.m10=1-u*s,c.m11=0,c.m12=r*i,c.m13=a*i,c.m14=s*i,c.m15=1,zn.toArray(this.data,this._matLight,ph.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(){if(this._cmdBuffs.clear(),this._scene.mainLight.enabled){var e=this._scene.models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(r.enabled&&r.node&&r.castShadow){var a=this._psoRecord.get(r),s=!1;a||(a=this._createPSO(r),this._psoRecord.set(r,a),s=!0),r.UBOUpdated||r.updateUBOs();for(var o=0;o<r.subModelNum;o++){var l=r.getSubModel(o).inputAssembler;if(l){var u=this._cbRecord.get(l);!s&&u||((u=this._createOrReuseCommandBuffer(u)).begin(),u.bindPipelineState(a),u.bindBindingLayout(a.pipelineLayout.layouts[0]),u.bindInputAssembler(l),u.draw(l),u.end(),this._cbRecord.set(l,u)),this.cmdBuffs.push(u)}}}}}}},{key:"destroyShadowModel",value:function(e){var t=this._psoRecord.get(e);t&&(this._destroyPSO(e,t),this._psoRecord.delete(e));for(var i=0;i<e.subModelNum;i++){var n=e.getSubModel(i).inputAssembler,r=this._cbRecord.get(n);n&&r&&(r.destroy(),this._cbRecord.delete(n))}}},{key:"onPipelineChange",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._psoRecord.keys(),n=i.next();!n.done;)this._destroyPSO(n.value,this._psoRecord.get(n.value)),n=i.next();this._psoRecord.clear()}},{key:"destroy",value:function(){this.onPipelineChange(),this._passNormal.destroy(),this._passSkinning.destroy()}},{key:"_createPSO",value:function(e){var t=e instanceof xv?this._passSkinning:this._passNormal,i=e._doCreatePSO(t);return e.insertImplantPSO(i),i.pipelineLayout.layouts[0].update(),i}},{key:"_destroyPSO",value:function(e,t){var i=e instanceof xv?this._passSkinning:this._passNormal;e.removeImplantPSO(t),i.destroyPipelineState(t)}},{key:"_createOrReuseCommandBuffer",value:function(e){var t=this._scene.root.device,i={allocator:t.commandAllocator,type:wc.SECONDARY};return e?(e.status===bu.SUCCESS&&e.destroy(),e.initialize(i)):e=t.createCommandBuffer(i),e}}]),n}();function qw(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function jw(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,s=(e.length||1)/2,_=[Fi.set(Zw,-r,-a,s),Fi.set(Jw,r,-a,s),Fi.set($w,r,a,s),Fi.set(eT,-r,a,s),Fi.set(tT,r,-a,-s),Fi.set(iT,-r,-a,-s),Fi.set(nT,-r,a,-s),Fi.set(rT,r,a,-s)],v=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],y=[],g=[],b=[],x=[],o=new Fi(-r,-a,-s),l=new Fi(r,a,s),u=Math.sqrt(r*r+a*a+s*s);function c(e,t,i){var n,r,a,s,o=y.length/3,l=v[e],u=m[e];for(s=0;s<=i;s++)for(a=0;a<=t;a++)if(n=a/t,r=s/i,Fi.lerp(Xw,_[l[0]],_[l[1]],n),Fi.lerp(Yw,_[l[0]],_[l[2]],r),Fi.subtract(Kw,Yw,_[l[0]]),Fi.add(Qw,Xw,Kw),y.push(Qw.x,Qw.y,Qw.z),g.push(u[0],u[1],u[2]),b.push(n,r),a<t&&s<i){var c=t+1,h=a+s*c,d=a+(s+1)*c,f=a+1+(s+1)*c,p=a+1+s*c;x.push(o+h,o+p,o+d),x.push(o+d,o+p,o+f)}}return c(0,t,i),c(4,n,i),c(1,t,i),c(5,n,i),c(3,t,n),c(2,t,n),{positions:y,normals:g,uvs:b,indices:x,minPos:o,maxPos:l,boundingRadius:u}}var Xw=new Fi,Yw=new Fi,Kw=new Fi,Qw=new Fi,Zw=new Fi,Jw=new Fi,$w=new Fi,eT=new Fi,tT=new Fi,iT=new Fi,nT=new Fi,rT=new Fi,aT=new Fi(0,0,0),sT=new Fi(0,0,0);function oT(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},x=.5*b,S=e.radialSegments||32,w=e.heightSegments||1,t=void 0===e.capped||e.capped,T=e.arc||2*Math.PI,i=0;t||(0<y&&i++,0<g&&i++);var n=(S+1)*(w+1);t&&(n+=(S+1)*i+S*i);var r=S*w*2*3;t&&(r+=S*i*3);var E=new Array(r),C=new Array(3*n),A=new Array(3*n),k=new Array(2*n),a=Math.max(y,g),s=new Fi(-a,-x,-a),o=new Fi(a,x,a),l=Math.sqrt(a*a+x*x),R=0,O=0;return function(){for(var e=[],t=y-g,i=t*t/b*Math.sign(t),n=0;n<=w;n++){for(var r=[],a=n/w,s=a*t+g,o=0;o<=S;++o){var l=o/S,u=l*T,c=Math.sin(u),h=Math.cos(u);C[3*R]=s*c,C[3*R+1]=a*b-x,C[3*R+2]=s*h,Fi.normalize(aT,Fi.set(sT,c,-i,h)),A[3*R]=aT.x,A[3*R+1]=aT.y,A[3*R+2]=aT.z,k[2*R]=2*(1-l)%1,k[2*R+1]=a,r.push(R),++R}e.push(r)}for(var d=0;d<w;++d)for(var f=0;f<S;++f){var p=e[d][f],_=e[d+1][f],v=e[d+1][f+1],m=e[d][f+1];E[O]=p,E[++O]=m,E[++O]=_,E[++O]=m,E[++O]=v,E[++O]=_,++O}}(),t&&(0<g&&u(!1),0<y&&u(!0)),{positions:C,normals:A,uvs:k,indices:E,minPos:s,maxPos:o,boundingRadius:l};function u(e){for(var t=e?y:g,i=e?1:-1,n=R,r=1;r<=S;++r)C[3*R]=0,C[3*R+1]=x*i,C[3*R+2]=0,A[3*R]=0,A[3*R+1]=i,A[3*R+2]=0,k[2*R]=.5,k[2*R+1]=.5,++R;for(var a=R,s=0;s<=S;++s){var o=s/S*T,l=Math.cos(o),u=Math.sin(o);C[3*R]=t*u,C[3*R+1]=x*i,C[3*R+2]=t*l,A[3*R]=0,A[3*R+1]=i,A[3*R+2]=0,k[2*R]=.5-.5*u*i,k[2*R+1]=.5+.5*l,++R}for(var c=0;c<S;++c){var h=n+c,d=a+c;e?(E[O]=d+1,E[++O]=h):(E[O]=h,E[++O]=d+1),E[++O]=d,++O}}}var lT=new Fi(0,0,0),uT=new Fi(0,0,0),cT=new Fi(0,0,0),hT=new Fi(0,0,0),dT=new Fi(0,0,0),fT=new Fi(0,0,0),pT=new Fi(0,0,0);var _T=new Fi(0,0,0),vT=new Fi(0,0,0);var mT=Object.freeze({box:jw,cone:function(){return oT(0,0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:{})},cylinder:oT,plane:function(e){var t=function(e){return(e=qw(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,s=.5*i,o=.5*n,l=[],u=[],c=[],h=new Fi(-s,0,-o),d=new Fi(s,0,o),f=Math.sqrt(i*i+n*n);Fi.set(dT,-s,0,o),Fi.set(fT,s,0,o),Fi.set(pT,-s,0,-o);for(var p=0;p<=a;p++)for(var _=0;_<=r;_++){var v=_/r,m=p/a;if(Fi.lerp(lT,dT,fT,v),Fi.lerp(uT,dT,pT,m),Fi.subtract(cT,uT,dT),Fi.add(hT,lT,cT),l.push(hT.x,hT.y,hT.z),t.includeUV&&u.push(v,m),_<r&&p<a){var y=r+1,g=_+p*y,b=_+(p+1)*y,x=_+1+(p+1)*y,S=_+1+p*y;c.push(g,S,b),c.push(S,x,b)}}var w={positions:l,indices:c,minPos:h,maxPos:d,boundingRadius:f};if(t.includeNormal){var T=(a+1)*(r+1),E=new Array(3*T);w.normals=E;for(var C=0;C<T;++C)E[3*C+0]=0,E[3*C+1]=1,E[3*C+2]=0}return t.includeUV&&(w.uvs=u),w},quad:function(e){var t=qw(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],s=[],o=new Fi(-e,-e,-e),l=new Fi(e,e,e),u=e,c=0;c<=i;++c)for(var h=c*Math.PI/i,d=Math.sin(h),f=-Math.cos(h),p=0;p<=i;++p){var _=2*p*Math.PI/i-Math.PI/2,v=Math.sin(_)*d,m=f,y=Math.cos(_)*d,g=p/i,b=c/i;if(n.push(v*e,m*e,y*e),r.push(v,m,y),a.push(g,b),c<i&&p<i){var x=i+1,S=x*c+p,w=x*(c+1)+p,T=x*(c+1)+p+1,E=x*c+p+1;s.push(S,E,w),s.push(E,T,w)}}return{positions:n,indices:s,normals:r,uvs:a,minPos:o,maxPos:l,boundingRadius:u}},torus:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,s=[],o=[],l=[],u=[],c=new Fi(-e-t,-t,-e-t),h=new Fi(e+t,t,e+t),d=e+t,f=0;f<=n;f++)for(var p=0;p<=r;p++){var _=p/r,v=f/n,m=_*a,y=v*Math.PI*2,g=(e+t*Math.cos(y))*Math.sin(m),b=t*Math.sin(y),x=(e+t*Math.cos(y))*Math.cos(m),S=Math.sin(m)*Math.cos(y),w=Math.sin(y),T=Math.cos(m)*Math.cos(y);if(s.push(g,b,x),o.push(S,w,T),l.push(_,v),p<r&&f<n){var E=r+1,C=E*f+p,A=E*(f+1)+p,k=E*(f+1)+p+1,R=E*f+p+1;u.push(C,R,A),u.push(R,k,A)}}return{positions:s,normals:o,uvs:l,indices:u,minPos:c,maxPos:h,boundingRadius:d}},capsule:function(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},m=e-y-g,b=t.sides||32,x=t.heightSegments||32,S=g/e,w=m/e,T=y/e,E=Math.floor(x*S),C=Math.floor(x*T),A=Math.floor(x*w),k=m+g-e/2,R=g-e/2,O=g-e/2,M=t.arc||2*Math.PI,I=[],L=[],z=[],B=[],i=Math.max(y,g),n=new Fi(-i,-e/2,-i),r=new Fi(i,e/2,i),a=e/2,P=0,D=[];return function(){for(var e=0;e<=E;++e)for(var t=e*Math.PI/E/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,u=n,c=o*i,h=r/b,d=e/x;if(I.push(l*g,u*g+O,c*g),L.push(l,u,c),z.push(h,d),e<E&&r<b){var f=b+1,p=f*e+r,_=f*(e+1)+r,v=f*(e+1)+r+1,m=f*e+r+1;B.push(p,m,_),B.push(m,v,_)}++P}}(),function(){for(var e=(y-g)/m,t=0;t<=A;t++){for(var i=[],n=t/A,r=n*(y-g)+g,a=0;a<=b;++a){var s=a/b,o=n*w+S,l=s*M-M/4,u=Math.sin(l),c=Math.cos(l);I.push(r*u),I.push(n*m+R),I.push(r*c),Fi.normalize(_T,Fi.set(vT,u,-e,c)),L.push(_T.x),L.push(_T.y),L.push(_T.z),z.push(s,o),i.push(P),++P}D.push(i)}for(var h=0;h<A;++h)for(var d=0;d<b;++d){var f=D[h][d],p=D[h+1][d],_=D[h+1][d+1],v=D[h][d+1];B.push(f),B.push(v),B.push(p),B.push(v),B.push(_),B.push(p)}}(),function(){for(var e=0;e<=C;++e)for(var t=e*Math.PI/C/2+Math.PI/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,u=n,c=o*i,h=r/b,d=e/x+(1-T);if(I.push(l*y,u*y+k,c*y),L.push(l,u,c),z.push(h,d),e<C&&r<b){var f=b+1,p=f*e+r+D[A][b]+1,_=f*(e+1)+r+D[A][b]+1,v=f*(e+1)+r+1+D[A][b]+1,m=f*e+r+1+D[A][b]+1;B.push(p,m,_),B.push(m,v,_)}}}(),{positions:I,normals:L,uvs:z,indices:B,minPos:n,maxPos:r,boundingRadius:a}},circle:function(e){var t=function(e){return(e=qw(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var s=r*a,o=Math.cos(s),l=Math.sin(s),u=3*(a+1);i[0+u]=o,i[1+u]=l,i[2+u]=0;var c=2*a;n[1+c]=a+1,n[1+c+1]=a+2}return 0<t&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Uu.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,u=3*s+2;e.positions[o]=e.positions[o]+i,e.positions[l]=e.positions[l]+n,e.positions[u]=e.positions[u]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,u=3*s+2;e.positions[o]*=i,e.positions[l]*=n,e.positions[u]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Uu.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var s=0;s<3;++s){var o=t[a+i[s][0]],l=t[a+i[s][1]],u=l<o?l<<16|o:o<<16|l;void 0===r[u]&&(r[u]=0,n.push(o,l))}return e.indices=n,e.primitiveMode=Uu.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var s=e[r+t[a][0]],o=e[r+t[a][1]],l=o<s?o<<16|s:s<<16|o;void 0===n[l]&&(n[l]=0,i.push(s,o))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Uu.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,s=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},o="",l=0;l<i.length;l+=3)o+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var u=0;u<n.length;u+=2)o+="vt ".concat(n[u]," ").concat(n[u+1],"\n");for(var c=0;c<r.length;c+=3)o+="vn ".concat(r[c]," ").concat(r[c+1]," ").concat(r[c+2],"\n");for(var h=0;h<a.length;h+=3)o+="f ".concat(s(h)," ").concat(s(h+1)," ").concat(s(h+2),"\n");return o},normals:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,s=6*r;n[0+s]=e[0+a],n[1+s]=e[1+a],n[2+s]=e[2+a],n[3+s]=e[0+a]+t[0+a]*i,n[4+s]=e[1+a]+t[1+a]*i,n[5+s]=e[2+a]+t[2+a]*i}return n},applyDefaultGeometryOptions:qw});q3("primitives",mT);var yT,gT,bT=null,xT=null,ST=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e,null)))._default=G_.get("default-cube-texture"),t._envmap=t._default,t._isRGBE=!1,t._useIBL=!1,t._globalBinding=void 0,t._scene=e,t._globalBinding=t._scene.root.pipeline.globalBindings.get(vh.name),xT||(xT=new fm).initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t._isRGBE}}),bT=bT||Tv(jw({width:2,height:2,length:2})),t.initSubModel(0,bT.renderingMesh.getSubmesh(0),xT),t}return p(i,_v),v(i,[{key:"useIBL",set:function(e){this._useIBL=e,this._updatePipeline()},get:function(){return this._useIBL}},{key:"isRGBE",set:function(e){this._isRGBE=e,xT.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,xT),this._updateGlobalBinding(),this._updatePipeline()},get:function(){return this._isRGBE}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._scene.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,this._updateGlobalBinding()},get:function(){return this._envmap}}]),v(i,[{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=this._scene.root.pipeline;t.macros.CC_USE_IBL!==e&&(t.macros.CC_USE_IBL=e,this._scene.onPipelineChange())}},{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=Yd.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=xT;i.passes[0].bindSampler(vh.binding,t),i.passes[0].bindTextureView(vh.binding,e);var n=this._matPSORecord.get(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s.pipelineLayout.layouts[0].update()}}}]),i}(),wT=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._size=.15,n._range=1,n._luminance=1700/ux(n._size),n._pos=void 0,n._aabb=void 0,n._type=ex.SPHERE,n._aabb=as.create(),n._pos=new Fi,n}return p(r,cx),v(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),v(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),as.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range))}}]),r}(),TT=new Fi(0,0,-1),ET=new Fi,CT=new hn,AT=new zn,kT=new zn,RT=new zn,OT=new zn,MT=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._dir=new Fi(1,-1,-1),n._size=.15,n._range=5,n._luminance=1700/ux(n._size),n._spotAngle=Math.cos(Math.PI/6),n._pos=void 0,n._aabb=void 0,n._frustum=void 0,n._angle=0,n._type=ex.SPOT,n._aabb=as.create(),n._frustum=ds.create(),n._pos=new Fi,n}return p(r,cx),v(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),v(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),this._dir=Fi.transformQuat(ET,TT,this._node.getWorldRotation(CT)),Fi.normalize(this._dir,this._dir),as.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(AT),zn.invert(AT,AT),zn.perspective(kT,this._angle,1,.001,this._range),zn.multiply(RT,kT,AT),zn.invert(OT,RT),this._frustum.update(RT,OT))}}]),r}(),IT=function(){function t(e){y(this,t),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._mainLight=void 0,this._defaultMainLightNode=void 0,this._sphereLights=[],this._spotLights=[],this._models=[],this._modelId=0,this._texturePool=void 0,this._root=e,this._ambient=new xS(this),this._defaultMainLightNode=new f_("Main Light"),this._mainLight=new Uw(this,"Main Light",this._defaultMainLightNode),this._mainLight.illuminance=xS.SUN_ILLUM,this._mainLight.enabled=!1,this._ambient=new xS(this),this._skybox=new ST(this),this._planarShadows=new Ww(this),this._texturePool=new N_(e.device)}return v(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"defaultMainLightNode",get:function(){return this._defaultMainLightNode}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"texturePool",get:function(){return this._texturePool}},{key:"rayResultCanvas",get:function(){return GT}},{key:"rayResultModels",get:function(){return NT}},{key:"rayResultAll",get:function(){return HT}},{key:"rayResultSingleModel",get:function(){return WT}}],[{key:"registerCreateFunc",value:function(e){e._createSceneFun=function(e){return new t(e)}}}]),v(t,[{key:"initialize",value:function(e){return this._name=e.name,this._texturePool.initialize(),!0}},{key:"destroy",value:function(){this.destroyCameras(),this.destroyPointLights(),this.destroySpotLights(),this.destroyModels(),this._skybox.destroy(),this._planarShadows.destroy(),this._texturePool.destroy()}},{key:"createCamera",value:function(e){var t=new bS(this,e);return this._cameras.push(t),t}},{key:"destroyCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return e.destroy(),void this._cameras.splice(t,1)}},{key:"destroyCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._cameras.splice(0)}},{key:"createSphereLight",value:function(e,t){var i=new wT(this,e,t);return this._sphereLights.push(i),i}},{key:"destroySphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return void this._sphereLights.splice(t,1)}},{key:"createSpotLight",value:function(e,t){var i=new MT(this,e,t);return this._spotLights.push(i),i}},{key:"destroySpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return void this._spotLights.splice(t,1)}},{key:"destroyPointLights",value:function(){this._sphereLights=[]}},{key:"destroySpotLights",value:function(){this._spotLights=[]}},{key:"createModel",value:function(e,t){var i=new e(this,t);return this._models.push(i),i}},{key:"destroyModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._planarShadows.destroyShadowModel(e),void this._models.splice(t,1)[0].destroy()}},{key:"destroyModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._planarShadows.destroyShadowModel(r),r.destroy()}this._models=[]}},{key:"onPipelineChange",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}this._skybox.onPipelineChange(),this._planarShadows.onPipelineChange()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:ah.Enum.DEFAULT|ah.Enum.UI_2D,r=2<arguments.length&&void 0!==i?i:1/0,a=this.raycastAllModels(e,n,r),s=this.raycastAllCanvas(e,n,r),o=a||s;return HT.length=0,o&&(Array.prototype.push.apply(HT,NT),Array.prototype.push.apply(HT,GT)),o}},{key:"raycastAllModels",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:ah.Enum.DEFAULT,r=2<arguments.length&&void 0!==i?i:1/0;FT.reset();var a=this._models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=u.transform;if(c&&u.enabled&&!(u.node.layer&ah.Enum.IGNORE_RAYCAST)&&u.node.layer&n&&u.modelBounds){zn.invert(BT,c.getWorldMatrix(BT)),Fi.transformMat4(LT.o,e.o,BT),Fi.normalize(LT.d,Fi.transformMat4Normal(LT.d,e.d,BT));var h=Ga.ray_aabb(LT,u.modelBounds);if(!(h<=0||r<h))for(var d=0;d<u.subModelNum;++d){var f=u.getSubModel(d).subMeshData;if(f&&f.geometricInfo){var p=f.geometricInfo,_=p.positions,v=p.indices,m=p.doubleSided;qT(_,v,f.primitiveMode,m,r)}if(PT<r){var y=FT.add();y.node=u.node,y.distance=PT*Fi.multiply(zT,LT.d,c.worldScale).length(),NT[FT.length-1]=y}}}}return NT.length=FT.length,0<NT.length}},{key:"raycastSingleModel",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:ah.Enum.DEFAULT,a=3<arguments.length&&void 0!==n?n:1/0;FT.reset();var s=t,o=s.transform;if(!o||!s.enabled||s.node.layer&ah.Enum.IGNORE_RAYCAST||!(s.node.layer&r)||!s.modelBounds)return!1;zn.invert(BT,o.getWorldMatrix(BT)),Fi.transformMat4(LT.o,e.o,BT),Fi.normalize(LT.d,Fi.transformMat4Normal(LT.d,e.d,BT));var l=Ga.ray_aabb(LT,s.modelBounds);if(l<=0||a<l)return!1;for(var u=0;u<s.subModelNum;++u){var c=s.getSubModel(u).subMeshData;if(c&&c.geometricInfo){var h=c.geometricInfo,d=h.positions,f=h.indices,p=h.doubleSided;qT(d,f,c.primitiveMode,p,a)}if(PT<a){var _=FT.add();_.node=s.node,_.distance=PT*Fi.multiply(zT,LT.d,o.worldScale).length(),WT[FT.length-1]=_}}return WT.length=FT.length,0<WT.length}},{key:"raycastAllCanvas",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:ah.Enum.UI_2D,r=2<arguments.length&&void 0!==i?i:1/0;VT.reset();var a=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=a&&0<a.length)for(var s=0;s<a.length;s++){var o=a[s].node;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,n,r)}return GT.length=VT.length,0<GT.length}},{key:"_raycastUI2DNode",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:ah.Enum.UI_2D,a=3<arguments.length&&void 0!==n?n:1/0;var s=t.uiTransfromComp;if(!(null==s||t.layer&ah.Enum.IGNORE_RAYCAST)&&t.layer&r){s.getComputeAABB(UT);var o=Ga.ray_aabb(e,UT);if(!(o<=0)&&o<a){var l=VT.add();return l.node=t,l.distance=o,l}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:ah.Enum.UI_2D,a=3<arguments.length&&void 0!==n?n:1/0,s=this._raycastUI2DNode(e,t,r,a);null!=s&&(GT[VT.length-1]=s);var o=t.children,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;null!=h&&h.active&&this._raycastUI2DNodeRecursiveChildren(e,h,r,a)}}}]),t}(),LT=ta.create(),zT=new Fi,BT=new zn,PT=1/0,DT=Ka.create(),FT=new Es(function(){return{node:null,distance:1/0}},8),NT=[],UT=new as,VT=new Es(function(){return{node:null,distance:1/0}},8),GT=[],HT=[],WT=[],qT=function(e,t,i,n,r){if(PT=4<arguments.length&&void 0!==r?r:1/0,i===Uu.TRIANGLE_LIST)for(var a=t.length,s=0;s<a;s+=3){var o=3*t[s],l=3*t[s+1],u=3*t[s+2];Fi.set(DT.a,e[o],e[1+o],e[2+o]),Fi.set(DT.b,e[l],e[1+l],e[2+l]),Fi.set(DT.c,e[u],e[1+u],e[2+u]);var c=Ga.ray_triangle(LT,DT,n);c<=0||PT<c||(PT=c)}else if(i===Uu.TRIANGLE_STRIP)for(var h=t.length-2,d=0,f=0;f<h;f+=1){var p=3*t[f-d],_=3*t[f+d+1],v=3*t[f+2];Fi.set(DT.a,e[p],e[1+p],e[2+p]),Fi.set(DT.b,e[_],e[1+_],e[2+_]),Fi.set(DT.c,e[v],e[1+v],e[2+v]),d=~d;var m=Ga.ray_triangle(LT,DT,n);m<=0||PT<m||(PT=m)}else if(i===Uu.TRIANGLE_FAN){var y=t.length-1,g=3*t[0];Fi.set(DT.a,e[g],e[1+g],e[2+g]);for(var b=1;b<y;b+=1){var x=3*t[b],S=3*t[b+1];Fi.set(DT.b,e[x],e[1+x],e[2+x]),Fi.set(DT.c,e[S],e[1+S],e[2+S]);var w=Ga.ray_triangle(LT,DT,n);w<=0||PT<w||(PT=w)}}},jT=q3("MeshBuffer",function(){function t(e){y(this,t),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=e}return v(t,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:4,n=1<arguments.length&&void 0!==t?t:6,r=this.byteOffset+i*this._vertexFormatBytes,a=this.indiceOffset+n;if(65535<i+this.vertexOffset)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,i,n),!1;var s=this.vData.byteLength,o=this.iData.length;if(s<r||o<a){for(;s<r||o<a;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=i,this.indiceOffset+=n,this.byteOffset=r,this.dirty=!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),t}());(gT=yT=yT||{})[gT.DISABLED=0]="DISABLED",gT[gT.CLEAR=1]="CLEAR",gT[gT.ENTER_LEVEL=2]="ENTER_LEVEL",gT[gT.ENABLED=3]="ENABLED",gT[gT.EXIT_LEVEL=4]="EXIT_LEVEL";var XT=q3("StencilManager",function(){function e(){y(this,e),this.stage=yT.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Yu.ALWAYS,stencilMask:4294967295,writeMask:4294967295,failOp:Qu.KEEP,zFailOp:Qu.KEEP,passOp:Qu.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return v(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=yT.CLEAR}},{key:"enterLevel",value:function(){this.stage=yT.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=yT.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=yT.DISABLED:this.stage=yT.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;this.stage===yT.DISABLED?(t.stencilTest=!1,t.func=Yu.ALWAYS,t.failOp=Qu.KEEP,t.stencilMask=t.writeMask=4294967295,t.ref=1):(t.stencilTest=!0,this.stage===yT.ENABLED?(t.func=Yu.EQUAL,t.failOp=Qu.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):this.stage===yT.CLEAR?(t.func=Yu.NEVER,t.failOp=Qu.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):this.stage===yT.ENTER_LEVEL&&(t.func=Yu.NEVER,t.failOp=Qu.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()));var i=e.passes[0];if(this._changed(i)){var n=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:n.stencilTest,stencilFuncFront:n.func,stencilReadMaskFront:n.stencilMask,stencilWriteMaskFront:n.writeMask,stencilFailOpFront:n.failOp,stencilZFailOpFront:n.zFailOp,stencilPassOpFront:n.passOp,stencilRefFront:n.ref,stencilTestBack:n.stencilTest,stencilFuncBack:n.func,stencilReadMaskBack:n.stencilMask,stencilWriteMaskBack:n.writeMask,stencilFailOpBack:n.failOp,stencilZFailOpBack:n.zFailOp,stencilPassOpBack:n.passOp,stencilRefBack:n.ref},this._defaultPipelineState.blendState=i.blendState,this._defaultPipelineState.rasterizerState=i.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getInvertedRef",value:function(){for(var e=0,t=0;t<this._maskStack.length-1;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=yT.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}());XT.sharedManager=null,XT.sharedManager=new XT;var YT=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e,null)))._subModel=void 0,t._subModel=new KT,t}return p(i,_v),v(i,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"initialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),i}(),KT=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).psos=[],e}return p(t,hv),v(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){0<this.commandBuffers.length&&this.commandBuffers[0].destroy()}}]),t}(),QT=function(){function e(){y(this,e),this._material=null,this._pass=null,this._psos=void 0,this._refCount=0,this._psos=null}return v(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),v(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=new fm,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._psos=new Ts(function(){return t._pass.createPipelineState()},1),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var t=this;this._psos&&this._psos.clear(function(e){t._pass.destroyPipelineState(e)}),this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}]),e}(),ZT=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RG32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA32F}],JT=Object.freeze({vfmt:ZT});q3("UIVertexFormat",JT);function $T(e,t,i,n){y(this,$T),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=n}var eE=function(){function e(){y(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null}return v(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null}}]),e}(),tE=function(){function i(e){var t=this;y(this,i),this._root=e,this.device=void 0,this._screens=[],this._bufferBatchPool=new Es(function(){return new jT(t)},128),this._drawBatchPool=new Ts(function(){return new eE},128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new fm,this._currMeshBuffer=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=-1,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new Ts(function(){var e=t._scene.createModel(YT,null);return e.visFlags|=ah.Enum.UI_3D,e},2),this._modelInUse=new dw(10),this._batches=new dw(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return v(i,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer}}]),v(i,[{key:"initialize",value:function(){return this._attributes=ZT,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:wc.PRIMARY}),!0}},{key:"destroy",value:function(){this._destroyUIMaterials();var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy(this)}var r=this._meshBuffers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.destroy()}this._meshBuffers.splice(0);for(var l=this._uiMaterials.values(),u=l.next();!u.done;){u.value.destroy(),u=l.next()}this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new QT;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){this._screens.push(e),e.camera&&(e.camera.view.visibility=ah.BitMask.UI_2D|this._screens.length,this._canvasMaterials.set(e.camera.view.visibility,new Map)),this._screens.sort(this._screenSort)}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);if(-1!==t){if(this._screens.splice(t,1),e.camera)for(var i=this._canvasMaterials.get(e.camera.view.visibility).keys(),n=i.next();!n.done;)this._removeUIMaterial(n.value),n=i.next();for(var r,a=t;a<this._screens.length;a++)if(r=this._screens[a].camera){var s=this._canvasMaterials.get(r.view.visibility);r.view.visibility=ah.BitMask.UI_2D|a+1,this._canvasMaterials.set(r.view.visibility,s)}}}},{key:"update",value:function(e){if(this._renderScreens(),0<this._batches.length)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._modelInUse.get(t).enabled=!1,this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){if(n.camera){var r=n.camera.view.visibility;n.model.visFlags=r,n.model.node.layer=r}for(var a=0;a<n.model.subModelNum;a++)n.model.getSubModel(a).priority=e++}else{var s=n.bindingLayout;s.bindTextureView(ch.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),s.update();var o=n.bufferBatch.ia;o.firstIndex=n.firstIdx,o.indexCount=n.idxCount;var l=this._uiModelPool.alloc();l.initialize(o,n),l.enabled=!0,l.getSubModel(0).priority=e++,n.camera&&(l.visFlags=n.camera.view.visibility,null==this._canvasMaterials.get(n.camera.view.visibility).get(n.material.hash)&&(this._uiMaterials.get(n.material.hash).increase(),this._canvasMaterials.get(n.camera.view.visibility).set(n.material.hash,1))),this._modelInUse.push(l)}}}},{key:"commitComp",value:function(e,t,i){var n=2<arguments.length?i:void 0,r=e,a=1<arguments.length&&void 0!==t?t:null;this._currMaterial.hash===r.material.hash&&this._currTexView===a&&this._currCanvas===r.visibility||(this.autoMergeBatches(),this._currMaterial=r.material,this._currTexView=a,this._currCanvas=r.visibility),n&&n.fillBuffers(r,this)}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(XT.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this.getScreen(e.visibility),a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=e.visibility,this._batches.push(a)}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this.getScreen(this._currCanvas);XT.sharedManager.handleMaterial(e);var a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=this._currMeshBuffer,a.material=e,a.texView=this._currTexView,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"_deleteUIMaterial",value:function(e){this._uiMaterials.has(e.hash)&&(this._uiMaterials.get(e.hash).destroy(),this._uiMaterials.delete(e.hash))}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0,n=e.children.length;if(this._preprocess(e),0<n)for(var r=e.children,a=0;a<r.length;++a){var s=r[a];this._walk(s,i)}this._postprocess(e),i+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&this._recursiveScreenNode(i.node)}}},{key:"_preprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}},{key:"_postprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.clear(this),this._drawBatchPool.free(t)}this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=-1,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),XT.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(e,t){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(e,t)}},{key:"_screenSort",value:function(e,t){return e.priority-t.priority}}]),i}(),iE=function(){function t(e){y(this,t),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=e,IT.registerCreateFunc(this),Pw.registerCreateFunc(this)}return v(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){0<e?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}}]),v(t,[{key:"initialize",value:function(e){var i=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,G_.initBuiltinRes(this._device),this._pipeline=new Bw(this),this._pipeline.initialize(e)?(this._ui=new tE(this),this._ui.initialize()?(cc.view.on("design-resolution-changed",function(){var e=cc.game.canvas.width,t=cc.game.canvas.height;i.resize(e,t)},this),!0):(this.destroy(),!1)):(this.destroy(),!1))}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.isOffscreen||s.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var o=this._views,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;h.camera.isWindowSize&&h.camera.resize(e,t)}}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._views.sort(function(e,t){return e.priority-t.priority});var t=this._views,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.isEnable&&a.window&&(a.window.isOffscreen||!a.window.isOffscreen&&a.window===this._curWindow)&&this._pipeline.render(a)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._views=[]}}]),t}(),nE=new ve("Scheduler");$T.get=function(e,t,i,n){var r=$T._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new $T(e,t,i,n),r},$T.put=function(e){$T._listEntries.length<20&&(e.target=null,$T._listEntries.push(e))},$T._listEntries=[];function rE(e,t,i,n){y(this,rE),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=n}rE.get=function(e,t,i,n){var r=rE._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new rE(e,t,i,n),r},rE.put=function(e){rE._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,rE._hashUpdateEntries.push(e))},rE._hashUpdateEntries=[];function aE(e,t,i,n,r,a){y(this,aE),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=r,this.paused=a}aE.get=function(e,t,i,n,r,a){var s=aE._hashTimerEntries.pop();return s?(s.timers=e,s.target=t,s.timerIndex=i,s.currentTimer=n,s.currentTimerSalvaged=r,s.paused=a):s=new aE(e,t,i,n,r,a),s},aE.put=function(e){aE._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,aE._hashTimerEntries.push(e))},aE._hashTimerEntries=[];var sE=function(){function e(){y(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return v(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=0<this._delay,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();sE._timers=[],sE.get=function(){return sE._timers.pop()||new sE},sE.put=function(e){sE._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,sE._timers.push(e))};var oE=q3("Scheduler",function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=ke(!0),e._hashForTimers=ke(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return p(t,lx),v(t,null,[{key:"enableForTarget",value:function(e){var t=!1;e.uuid?t=!0:e.id&&(t=!0),t||(e.__instanceId?cc.warnID(1513):e.id=nE.getNewId())}}]),v(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var s=this._arrayForTimers;for(t=0;t<s.length;t++){if(a=s[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var s=e;e=t,t=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var o=t.uuid||t.id;if(o){var l,u,c=this._hashForTimers[o];if(c?c.paused!==a&&cc.warnID(1511):(c=aE.get(null,t,0,null,null,a),this._arrayForTimers.push(c),this._hashForTimers[o]=c),null==c.timers)c.timers=[];else for(u=0;u<c.timers.length;++u)if((l=c.timers[u])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=sE.get()).initWithCallback(this,e,t,i,n,r),c.timers.push(l),this._currentTarget===c&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else cc.errorID(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,s=$T.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,s)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,s,t)),this._hashForUpdates[n]=rE.get(a,s,e,null)}else cc.errorID(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,s=r.length;a<s;a++){var o=r[a];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),sE.put(o),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else cc.errorID(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else cc.errorID(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;-1<n.indexOf(i.currentTimer)&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)sE.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else cc.errorID(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;0<=t;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}cc.errorID(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],s=this._arrayForTimers;for(i=0,n=s.length;i<n;i++)(t=s[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else cc.errorID(1510)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else cc.errorID(1510)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e.uuid||e.id;if(!t)return cc.errorID(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}aE.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,s=n.length;a<s;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],$T.put(r),rE.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}());oE.PRIORITY_SYSTEM=1<<31,oE.PRIORITY_NON_SYSTEM=oE.PRIORITY_SYSTEM+1,oE.ID="scheduler",cc.Scheduler=oE;var lE=q3("Director",function(){function r(){var e;y(this,r),(e=x(this,g(r).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e.invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._systems=void 0,e.invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new oE,e._compScheduler=new QS,e._nodeActivator=new ow,e._systems=[];var t=l(e);return cc.game.on(_m.EVENT_SHOW,function(){t._lastUpdate=performance.now()}),cc.game.once(_m.EVENT_RENDERER_INITED,e.initOnRenererInited,l(e)),cc.game.once(_m.EVENT_ENGINE_INITED,e.initOnEngineInited,l(e)),e}return p(r,Ml),v(r,[{key:"initOnRenererInited",value:function(){this._root=new iE(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"initOnEngineInited",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,cc.loader.init(this),Nf&&Nf.setEnabled(!0),this.registerSystem(oE.ID,this._scheduler,200),this.emit(r.EVENT_INIT)}},{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=i._devicePixelRatio*(e.x-r),o=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?cc.v2(i._viewportRect.width-o,s):cc.v2(s,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=cc.v2(0,0);return i._isRotated?(s.x=r+e.y/i._devicePixelRatio,s.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(s.x=r+e.x*i._devicePixelRatio,s.y=a+n.height-e.y*i._devicePixelRatio),s}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return cc.size(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return cc.size(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Nf&&Nf.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(r.EVENT_RESET),Nf&&Nf.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map(function(e){return cc.game._persistRootNodes[e]}),a=0;a<r.length;a++){var s=r[a];s.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(s.uuid);if(o){var l=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(s,l)}else s.parent=e}var u=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=ke();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var s=0;s<i.length;s++)Uy(i[s],r);if(e)for(var o=0;o<e.length;o++){var l=e[o];!1===n[l]||r[l]||cc.loader.release(l)}for(var u=Object.keys(n),c=0;c<u.length;c++){var h=u[c];!0!==n[h]||r[h]||cc.loader.release(h)}}(u&&u.autoReleaseAssets&&u.dependAssets,e.dependAssets,r),cc.isValid(u)&&u.destroy(),this._scene=null,Ho._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,function(){n.runSceneImmediate(e,t,i)})}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(i,e,n){void 0===n&&(n=e,e=null);var t=this._getSceneUuid(i);if(t)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,i),cc.loader.load({uuid:t.uuid,type:"uuid"},e,function(e,t){e&&cc.errorID(1210,i,e.message),n&&n(e,t)});else{var r='Can not preload the scene "'+i+'" because it is not in the build settings.';n(new Error(r)),cc.error("preloadScene: "+r)}}},{key:"_loadSceneByUuid",value:function(r,e,t,i){var a=1<arguments.length&&void 0!==e?e:null,s=2<arguments.length&&void 0!==t?t:null;console.time("LoadScene "+r),cc.AssetLibrary.loadAsset(r,function(e,t){console.timeEnd("LoadScene "+r);var i=qE;if(i._loadingScene="",e)e="Failed to load scene: "+e,cc.error(e);else{if(t instanceof cc.SceneAsset){var n=t.scene;return n._id=t._uuid,n._name=t._name,void i.runSceneImmediate(n,s,a)}e="The asset "+r+" is not a scene",cc.error(e)}a&&a(e)})}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(oE.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(lx.sortByPriority)}},{key:"unregisterSystem",value:function(e){$e.fastRemove(this._systems,e),this._systems.sort(lx.sortByPriority)}},{key:"getSystem",value:function(t){return this._systems.find(function(e){return e.id===t})}},{key:"getAnimationManager",value:function(){return this.getSystem(cc.AnimationManager.ID)}},{key:"startAnimation",value:function(){this.invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this.invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this.invalid){this.calculateDeltaTime();var t=this._deltaTime;if(!this._paused){this.emit(r.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(r.EVENT_AFTER_UPDATE),Ho._deferredDestroy();for(var n=0;n<this._systems.length;++n)this._systems[n].postUpdate(t)}this.emit(r.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(r.EVENT_AFTER_DRAW),Nf.frameUpdateListeners(),f_.bookOfChange.clear(),this._totalFrames++}}},{key:"root",get:function(){return this._root}}]),r}());lE.EVENT_INIT="director_init",lE.EVENT_RESET="director_reset",lE.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",lE.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",lE.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",lE.EVENT_BEFORE_UPDATE="director_before_update",lE.EVENT_AFTER_UPDATE="director_after_update",lE.EVENT_BEFORE_DRAW="director_before_draw",lE.EVENT_AFTER_DRAW="director_after_draw",lE.EVENT_BEFORE_PHYSICS="director_before_physics",lE.EVENT_AFTER_PHYSICS="director_after_physics",lE.instance=void 0,cc.Director=lE;var uE,cE,hE,dE,fE,pE,_E,vE,mE,yE,gE,bE,xE,SE,wE,TE,EE,CE,AE,kE,RE,OE,ME,IE,LE,zE,BE,PE,DE,FE,NE,UE,VE,GE,HE,WE,qE=q3("director",lE.instance=cc.director=new lE),jE=new Mi,XE=new Mi,YE=new zn,KE=new zn,QE=new zn,ZE=new Zn,JE=q3("UITransformComponent",(uE=oo("cc.UITransformComponent"),cE=_o(110),hE=po("UI/UITransform"),dE=lo({displayOrder:0}),fE=lo({displayOrder:1}),uE(pE=cE(pE=hE(pE=ho((gE=yE=function(){function h(){var e,t;y(this,h);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(h)).call.apply(e,[this].concat(n))),"_contentSize",vE,l(t)),m(t,"_anchorPoint",mE,l(t)),t}return p(h,rp),v(h,[{key:"__preload",value:function(){this.node.uiTransfromComp=this}},{key:"onDestroy",value:function(){this.node.uiTransfromComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(gf.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(gf.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=jE,a=XE,s=-1,o=this.node.getComponent(cc.UIRenderComponent);s=o?o.visibility:this._getVisibility();var l=qE.root.ui.getScreen(s);if(l){l.node.getWorldRT(YE);var u=YE.m12,c=YE.m13,h=cc.visibleRect.center;if(YE.m12=h.x-(YE.m00*u+YE.m04*c),YE.m13=h.y-(YE.m01*u+YE.m05*c),zn.invert(YE,YE),Mi.transformMat4(r,e,YE),this.node.getWorldMatrix(QE),zn.invert(YE,QE),Mi.transformMat4(a,r,YE),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,0<=a.x&&0<=a.y&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var d=t.mask,f=this.node,p=0;f&&p<d.index;++p,f=f.parent);if(f!==d.node)return!(t.mask=null);var _=f.getComponent(cc.MaskComponent);return!_||!_.enabledInHierarchy||_.isHit(r)}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(QE),zn.invert(YE,QE),t=t||new Fi,Fi.transformMat4(t,e,YE)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(QE),t=t||new Fi,Fi.transformMat4(t,e,QE)}},{key:"getBoundingBox",value:function(){zn.fromRTS(KE,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Zn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(KE),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(QE),this.getBoundingBoxTo(QE)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){zn.fromRTS(KE,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,n=new Zn(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(zn.multiply(QE,e,KE),n.transformMat4(QE),!this.node.children)return n;var r=this.node.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;if(l&&l.active){var u=l.getComponent(h);if(u){var c=u.getBoundingBoxTo(e);c&&Zn.union(n,n,c)}}}return n}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,i=this._contentSize.height;ZE.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),ZE.transformMat4(this.node.worldMatrix);var n=ZE.x+.5*ZE.width,r=ZE.y+.5*ZE.height,a=this.node.worldPosition.z,s=ZE.width/2,o=ZE.height/2;if(null==e)return new as(n,r,a,s,o,.001);as.set(e,n,r,a,s,o,.001)}},{key:"_getVisibility",value:function(){for(var e=-1,t=this.node;t;){if(t){var i=t.getComponent("cc.CanvasComponent");if(i){e=i.visibility;break}}t=t.parent}return e}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(gf.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(gf.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(gf.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(gf.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(gf.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(gf.ANCHOR_CHANGED,this._anchorPoint))}}]),h}(),yE.EventType=gf,b((_E=gE).prototype,"contentSize",[dE],Object.getOwnPropertyDescriptor(_E.prototype,"contentSize"),_E.prototype),b(_E.prototype,"anchorPoint",[fE],Object.getOwnPropertyDescriptor(_E.prototype,"anchorPoint"),_E.prototype),vE=b(_E.prototype,"_contentSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qn(100,100)}}),mE=b(_E.prototype,"_anchorPoint",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(.5,.5)}}),pE=_E))||pE)||pE)||pE)||pE));cc.UITransformComponent=JE;var $E,eC,tC,iC,nC,rC,aC,sC,oC,lC,uC,cC,hC,dC,fC,pC,_C,vC,mC,yC,gC=vt({ORTHO:0,PERSPECTIVE:1}),bC=vt({SKYBOX:gS|Nc.DEPTH_STENCIL,SOLID_COLOR:Nc.ALL,DEPTH_ONLY:Nc.DEPTH_STENCIL,DONT_CLEAR:Nc.NONE}),xC=q3("CameraComponent",(bE=oo("cc.CameraComponent"),xE=po("Components/Camera"),SE=lo({type:gC}),wE=lo({type:bC}),TE=lo({visible:!1}),EE=lo({type:ah.BitMask}),CE=lo({type:Jd}),bE(AE=xE(AE=ho((WE=HE=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_projection",RE,l(t)),m(t,"_priority",OE,l(t)),m(t,"_fov",ME,l(t)),m(t,"_orthoHeight",IE,l(t)),m(t,"_near",LE,l(t)),m(t,"_far",zE,l(t)),m(t,"_color",BE,l(t)),m(t,"_depth",PE,l(t)),m(t,"_stencil",DE,l(t)),m(t,"_clearFlags",FE,l(t)),m(t,"_rect",NE,l(t)),m(t,"_screenScale",UE,l(t)),m(t,"_visibility",VE,l(t)),m(t,"_targetTexture",GE,l(t)),t._camera=null,t._inEditorMode=!1,t}return p(a,rp),v(a,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this)}},{key:"onEnable",value:function(){this._camera||this._createCamera(),this._camera.enabled=!0}},{key:"onDisable",value:function(){this._camera&&(this._camera.enabled=!1)}},{key:"onDestroy",value:function(){this._camera&&(this._getRenderScene().destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i=i||ta.create(),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t=t||new Fi,this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t=t||this.node.getWorldPosition(),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"_createCamera",value:function(){var t=this;if(this.node.scene){var e=this._getRenderScene();if(!this._camera||!e.cameras.find(function(e){return e===t._camera})){if(this._camera=e.createCamera({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow,priority:this._priority}),this._camera){this._camera.viewport=this._rect,this._camera.fov=mi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var i=this._color.x,n=this._color.y,r=this._color.z,a=this._color.w;this._camera.clearColor={r:i,g:n,b:r,a:a},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility}this._updateTargetTexture()}}}},{key:"onSceneChanged",value:function(e){this._camera&&this._camera.scene!==e.renderScene&&(this._createCamera(),this._camera.enabled=!0)}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=mi(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=e.x,this._camera.clearColor.g=e.y,this._camera.clearColor.b=e.z,this._camera.clearColor.a=e.w)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow)}},{key:"flows",set:function(e){this._camera&&(this._camera.flows=e)}}]),a}(),HE.ProjectionType=gC,HE.CameraClearFlag=bC,RE=b((kE=WE).prototype,"_projection",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gC.PERSPECTIVE}}),OE=b(kE.prototype,"_priority",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ME=b(kE.prototype,"_fov",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),IE=b(kE.prototype,"_orthoHeight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),LE=b(kE.prototype,"_near",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zE=b(kE.prototype,"_far",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),BE=b(kE.prototype,"_color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr("#334C78")}}),PE=b(kE.prototype,"_depth",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),DE=b(kE.prototype,"_stencil",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FE=b(kE.prototype,"_clearFlags",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bC.SOLID_COLOR}}),NE=b(kE.prototype,"_rect",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(0,0,1,1)}}),UE=b(kE.prototype,"_screenScale",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VE=b(kE.prototype,"_visibility",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rh}}),GE=b(kE.prototype,"_targetTexture",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(kE.prototype,"projection",[SE],Object.getOwnPropertyDescriptor(kE.prototype,"projection"),kE.prototype),b(kE.prototype,"priority",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"priority"),kE.prototype),b(kE.prototype,"fov",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"fov"),kE.prototype),b(kE.prototype,"orthoHeight",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"orthoHeight"),kE.prototype),b(kE.prototype,"near",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"near"),kE.prototype),b(kE.prototype,"far",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"far"),kE.prototype),b(kE.prototype,"color",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"color"),kE.prototype),b(kE.prototype,"depth",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"depth"),kE.prototype),b(kE.prototype,"stencil",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"stencil"),kE.prototype),b(kE.prototype,"clearFlags",[wE],Object.getOwnPropertyDescriptor(kE.prototype,"clearFlags"),kE.prototype),b(kE.prototype,"rect",[lo],Object.getOwnPropertyDescriptor(kE.prototype,"rect"),kE.prototype),b(kE.prototype,"screenScale",[TE],Object.getOwnPropertyDescriptor(kE.prototype,"screenScale"),kE.prototype),b(kE.prototype,"visibility",[EE],Object.getOwnPropertyDescriptor(kE.prototype,"visibility"),kE.prototype),b(kE.prototype,"targetTexture",[CE],Object.getOwnPropertyDescriptor(kE.prototype,"targetTexture"),kE.prototype),AE=kE))||AE)||AE)||AE)),SC=new Fi,wC=vt({SOLID_COLOR:Nc.ALL,DEPTH_STENCIL:Nc.DEPTH_STENCIL,NONE:Nc.NONE}),TC=vt({OVERLAY:0,INTERSPERSE:1}),EC=q3("CanvasComponent",($E=oo("cc.CanvasComponent"),eC=_o(100),tC=fo(JE),iC=po("UI/Canvas"),nC=lo({type:wC}),rC=lo({type:TC}),aC=lo(),sC=lo({type:Jd}),oC=lo({type:wC}),lC=lo({type:TC}),$E(uC=eC(uC=tC(uC=iC(uC=ho(uC=vo((b((cC=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_priority",hC,l(e)),m(e,"_targetTexture",dC,l(e)),m(e,"_clearFlag",fC,l(e)),m(e,"_color",pC,l(e)),m(e,"_renderMode",_C,l(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new Fi,e._thisOnResized=e.alignWithScreen.bind(l(e)),e}return p(t,rp),v(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){rr.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),v(t,[{key:"__preload",value:function(){var e=new f_("UICamera_"+this.node.name);e.setPosition(0,0,1e3),this._camera=qE.root.ui.renderScene.createCamera({name:"ui_"+this.node.name,node:e,projection:xC.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this.color=this._color;var t=qE.root.device;if(this._camera.resize(t.width,t.height),this._targetTexture){var i=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(i),this._camera.setFixedSize(i.width,i.height)}Tm.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),qE.root.ui.addScreen(this)}},{key:"onDestroy",value:function(){this._camera&&qE.root.ui.renderScene.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),Tm.off("design-resolution-changed",this._thisOnResized),qE.root.ui.removeScreen(this)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=Gl;e=i,t=Tm.getDesignResolutionSize();var n=0,r=0;if(Tm.getResolutionPolicy()===wm.NO_BORDER&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),Fi.set(SC,.5*i.width+n,.5*i.height+r,0),this._pos.equals(SC)||this.node.setPosition(SC),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(SC),this._camera){var a=vm.canvas;this._camera.resize(a.width,a.height),this._camera.orthoHeight=vm.canvas.height/Tm.getScaleY()/2,this._camera.node.setPosition(SC.x,SC.y,1e3),this._camera.update()}}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera)if(this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}else this._camera.changeTargetWindow(),this._camera.isWindowSize=!0}},{key:"_getViewPriority",value:function(){return this._renderMode===TC.OVERLAY?this._priority|1<<30:this._priority}}]),t}()).prototype,"clearFlag",[nC],Object.getOwnPropertyDescriptor(cC.prototype,"clearFlag"),cC.prototype),b(cC.prototype,"color",[lo],Object.getOwnPropertyDescriptor(cC.prototype,"color"),cC.prototype),b(cC.prototype,"renderMode",[rC],Object.getOwnPropertyDescriptor(cC.prototype,"renderMode"),cC.prototype),b(cC.prototype,"priority",[aC],Object.getOwnPropertyDescriptor(cC.prototype,"priority"),cC.prototype),b(cC.prototype,"targetTexture",[sC],Object.getOwnPropertyDescriptor(cC.prototype,"targetTexture"),cC.prototype),hC=b(cC.prototype,"_priority",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dC=b(cC.prototype,"_targetTexture",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fC=b(cC.prototype,"_clearFlag",[oC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wC.NONE}}),pC=b(cC.prototype,"_color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(0,0,0,0)}}),_C=b(cC.prototype,"_renderMode",[lC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TC.OVERLAY}}),uC=cC))||uC)||uC)||uC)||uC)||uC)||uC));cc.CanvasComponent=EC;var CC,AC,kC,RC,OC,MC,IC,LC,zC,BC,PC,DC,FC,NC,UC,VC,GC,HC=q3("UIComponent",oo("cc.UIComponent")(vC=_o(110)(vC=vo(vC=ho((b((mC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_priority",yC,l(t)),t._followScreen=null,t._lastParent=null,t}return p(a,rp),v(a,[{key:"__preload",value:function(){this.node._uiComp=this}},{key:"onEnable",value:function(){this._lastParent=this.node.parent,this._updateVisibility(),this._lastParent&&this.node.on(gf.CHILD_REMOVED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this._cancelEventFromParent()}},{key:"onDestroy",value:function(){this.node._uiComp===this&&(this.node._uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}},{key:"_setScreen",value:function(e){this._followScreen=e}},{key:"_parentChanged",value:function(e){return e===this.node&&(this._updateVisibility(),this._cancelEventFromParent(),this._lastParent=this.node.parent,this._sortSiblings(),!0)}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort(function(e,t){var i=e._uiComp,n=t._uiComp,r=(i?i.priority:0)-(n?n.priority:0);return 0==r?e.getSiblingIndex()-t.getSiblingIndex():r}),this.node.parent._updateSiblingIndex())}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent(EC);if(t){this._followScreen=t;break}}e=e.parent}}},{key:"_cancelEventFromParent",value:function(){this._lastParent&&(this._lastParent.off(gf.CHILD_REMOVED,this._parentChanged,this),this._lastParent=null),this._followScreen=null}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._priority=e,this._sortSiblings())}},{key:"visibility",get:function(){return this._screen?this._screen.visibility:-1}},{key:"_screen",get:function(){return this._followScreen}}]),a}()).prototype,"priority",[lo],Object.getOwnPropertyDescriptor(mC.prototype,"priority"),mC.prototype),yC=b(mC.prototype,"_priority",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vC=mC))||vC)||vC)||vC)||vC);mt(ec),(GC=VC=VC||q3("InstanceMaterialType",{}))[GC.ADDCOLOR=0]="ADDCOLOR",GC[GC.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE",GC[GC.GRAYSCALE=2]="GRAYSCALE";var WC,qC,jC,XC,YC,KC,QC,ZC,JC,$C,eA,tA,iA,nA,rA,aA,sA,oA,lA,uA,cA,hA,dA,fA,pA,_A,vA,mA,yA,gA,bA,xA=q3("UIRenderComponent",(CC=oo("cc.UIRenderComponent"),AC=_o(110),kC=fo(JE),RC=lo({type:ec,displayOrder:0}),OC=lo({type:ec,displayOrder:1}),MC=lo({displayOrder:2}),IC=lo({type:fm,displayOrder:3}),CC(LC=AC(LC=kC(LC=ho((UC=NC=function(){function s(){var e,t;y(this,s);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(s)).call.apply(e,[this].concat(n))),"_srcBlendFactor",BC,l(t)),m(t,"_dstBlendFactor",PC,l(t)),m(t,"_color",DC,l(t)),m(t,"_sharedMaterial",FC,l(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._material=null,t._instanceMaterialType=VC.ADDCOLORANDTEXTURE,t._blendTemplate={blendState:{targets:[{blendSrc:ec.SRC_ALPHA,blendDst:ec.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},t._simulate=!1,t}return p(s,HC),v(s,[{key:"__preload",value:function(){_(g(s.prototype),"__preload",this).call(this),this._instanceMaterial(),this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){_(g(s.prototype),"onEnable",this).call(this),this.node.on(gf.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(gf.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){_(g(s.prototype),"onDisable",this).call(this),this.node.off(gf.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(gf.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){_(g(s.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._material&&this._material.destroy(),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;if(this._renderFlag=this._canRender(),t&&this._renderFlag){var i=this._renderData;i&&(i.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}},{key:"requestRenderData",value:function(){var e=ix.add();return this._renderData=e}},{key:"destroyRenderData",value:function(){this._renderData&&(ix.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){_(g(s.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){_(g(s.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&(!!this._simulate||this.enabledInHierarchy)}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();var t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.getComponent(s);a&&a.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(this._sharedMaterial)e=fm.getInstantiatedMaterial(this._sharedMaterial,new ox,!1);else switch(this._instanceMaterialType){case VC.ADDCOLOR:e=fm.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new ox,!1);break;case VC.ADDCOLORANDTEXTURE:e=fm.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-material"),new ox,!1);break;case VC.GRAYSCALE:e=fm.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-gray-material"),new ox,!1)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}},{key:"simulate",set:function(e){this._simulate=e}}]),s}(),NC.BlendState=ec,NC.Assembler=null,NC.PostAssembler=null,b((zC=UC).prototype,"srcBlendFactor",[RC],Object.getOwnPropertyDescriptor(zC.prototype,"srcBlendFactor"),zC.prototype),b(zC.prototype,"dstBlendFactor",[OC],Object.getOwnPropertyDescriptor(zC.prototype,"dstBlendFactor"),zC.prototype),b(zC.prototype,"color",[MC],Object.getOwnPropertyDescriptor(zC.prototype,"color"),zC.prototype),b(zC.prototype,"sharedMaterial",[IC],Object.getOwnPropertyDescriptor(zC.prototype,"sharedMaterial"),zC.prototype),BC=b(zC.prototype,"_srcBlendFactor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ec.SRC_ALPHA}}),PC=b(zC.prototype,"_dstBlendFactor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ec.ONE_MINUS_SRC_ALPHA}}),DC=b(zC.prototype,"_color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),FC=b(zC.prototype,"_sharedMaterial",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LC=zC))||LC)||LC)||LC)||LC));cc.UIRenderComponent=xA,(vA=_A=_A||{})[vA.SIMPLE=0]="SIMPLE",vA[vA.SLICED=1]="SLICED",vA[vA.FILLED=3]="FILLED",mt(_A),(yA=mA=mA||{})[yA.HORIZONTAL=0]="HORIZONTAL",yA[yA.VERTICAL=1]="VERTICAL",yA[yA.RADIAL=2]="RADIAL",mt(mA),(bA=gA=gA||{})[bA.CUSTOM=0]="CUSTOM",bA[bA.TRIMMED=1]="TRIMMED",bA[bA.RAW=2]="RAW",mt(gA);var SA,wA,TA,EA,CA,AA,kA,RA=q3("SpriteComponent",(WC=oo("cc.SpriteComponent"),qC=_o(110),jC=po("UI/Render/Sprite"),XC=lo({type:wy,displayOrder:4}),YC=lo({type:yf,displayOrder:5}),KC=lo({type:_A,displayOrder:6}),QC=lo({type:mA}),ZC=lo({range:[0,1,.1]}),JC=lo({range:[0,1,.1]}),$C=lo({displayOrder:8}),eA=lo({type:gA,displayOrder:7}),WC(tA=qC(tA=jC((pA=fA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_spriteFrame",nA,l(t)),m(t,"_type",rA,l(t)),m(t,"_fillType",aA,l(t)),m(t,"_sizeMode",sA,l(t)),m(t,"_fillCenter",oA,l(t)),m(t,"_fillStart",lA,l(t)),m(t,"_fillRange",uA,l(t)),m(t,"_isTrimmedMode",cA,l(t)),m(t,"_useGrayscale",hA,l(t)),m(t,"_atlas",dA,l(t)),t}return p(a,xA),v(a,[{key:"__preload",value:function(){this._useGrayscale&&(this._instanceMaterialType=VC.GRAYSCALE),_(g(a.prototype),"__preload",this)&&_(g(a.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){_(g(a.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler)}},{key:"_canRender",value:function(){if(!_(g(a.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=a.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData(),this._updateColor())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(gA.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(gA.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_applyAtlas",value:function(e){}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e,this.spriteFrame=null)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===mA.RADIAL||this._fillType===mA.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===_A.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=pi(e,-1,1),this._type===_A.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=pi(e,0,1),this._type===_A.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===_A.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?VC.GRAYSCALE:VC.ADDCOLORANDTEXTURE,this._instanceMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e)!==gA.CUSTOM&&this._applySpriteSize()}}]),a}(),fA.FillType=mA,fA.Type=_A,fA.SizeMode=gA,b((iA=pA).prototype,"spriteAtlas",[XC],Object.getOwnPropertyDescriptor(iA.prototype,"spriteAtlas"),iA.prototype),b(iA.prototype,"spriteFrame",[YC],Object.getOwnPropertyDescriptor(iA.prototype,"spriteFrame"),iA.prototype),b(iA.prototype,"type",[KC],Object.getOwnPropertyDescriptor(iA.prototype,"type"),iA.prototype),b(iA.prototype,"fillType",[QC],Object.getOwnPropertyDescriptor(iA.prototype,"fillType"),iA.prototype),b(iA.prototype,"fillCenter",[lo],Object.getOwnPropertyDescriptor(iA.prototype,"fillCenter"),iA.prototype),b(iA.prototype,"fillStart",[ZC],Object.getOwnPropertyDescriptor(iA.prototype,"fillStart"),iA.prototype),b(iA.prototype,"fillRange",[JC],Object.getOwnPropertyDescriptor(iA.prototype,"fillRange"),iA.prototype),b(iA.prototype,"trim",[$C],Object.getOwnPropertyDescriptor(iA.prototype,"trim"),iA.prototype),b(iA.prototype,"grayscale",[lo],Object.getOwnPropertyDescriptor(iA.prototype,"grayscale"),iA.prototype),b(iA.prototype,"sizeMode",[eA],Object.getOwnPropertyDescriptor(iA.prototype,"sizeMode"),iA.prototype),nA=b(iA.prototype,"_spriteFrame",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rA=b(iA.prototype,"_type",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _A.SIMPLE}}),aA=b(iA.prototype,"_fillType",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mA.HORIZONTAL}}),sA=b(iA.prototype,"_sizeMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gA.TRIMMED}}),oA=b(iA.prototype,"_fillCenter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),lA=b(iA.prototype,"_fillStart",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uA=b(iA.prototype,"_fillRange",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cA=b(iA.prototype,"_isTrimmedMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hA=b(iA.prototype,"_useGrayscale",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dA=b(iA.prototype,"_atlas",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tA=iA))||tA)||tA)||tA));cc.SpriteComponent=RA;var OA,MA,IA,LA,zA,BA,PA,DA,FA,NA=q3("SubContextView",(SA=oo("cc.SubContextView"),wA=_o(110),TA=po("Components/SubContextView"),EA=lo({type:Number}),SA(CA=wA(CA=TA((b((AA=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_fps",kA,l(e)),e._sprite=void 0,e._imageAsset=void 0,e._context=void 0,e._updatedTime=0,e._updateInterval=0,e._sprite=null,e._imageAsset=new Td,e._context=null,e._updatedTime=performance.now(),e}return p(t,rp),v(t,[{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1/e,this._updateSubContextFrameRate())}}]),v(t,[{key:"onLoad",value:function(){if(wx.getOpenDataContext){this._updateInterval=1e3/this._fps,this._context=wx.getOpenDataContext(),this.reset();var e=this._imageAsset,t=this._context.canvas;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this.node.getComponent(RA),this._sprite||(this._sprite=this.node.addComponent(RA)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{var i=new yf;i.texture=this._imageAsset._texture,this._sprite.spriteFrame=i}}else this.enabled=!1}},{key:"onEnable",value:function(){this._runSubContextMainLoop(),this._registerNodeEvent(),this._updateSubContextFrameRate(),this.updateSubContextViewport()}},{key:"onDisable",value:function(){this._unregisterNodeEvent(),this._stopSubContextMainLoop()}},{key:"update",value:function(e){if(void 0===e)return this._context&&this._context.postMessage({fromEngine:!0,event:"step"}),void this._updateSubContextTexture();performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"reset",value:function(){if(this._context){this.updateSubContextViewport();var e=this._context.canvas;e&&(e.width=this.node.getComponent(JE).width,e.height=this.node.getComponent(JE).height)}}},{key:"updateSubContextViewport",value:function(){if(this._context){var e=this.node.getComponent(JE).getBoundingBoxToWorld(),t=Tm.getScaleX(),i=Tm.getScaleY(),n=Tm.getViewportRect();this._context.postMessage({fromEngine:!0,event:"viewport",x:e.x*t+n.x,y:e.y*i+n.y,width:e.width*t,height:e.height*i})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._context&&!(e.width<=0||e.height<=0)){var t=this._context.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._imageAsset._texture.create(t.width,t.height),this._imageAsset._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on(f_.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.on(f_.EventType.SCALE_PART,this.updateSubContextViewport,this),this.node.on(f_.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(f_.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.off(f_.EventType.SCALE_PART,this.updateSubContextViewport,this),this.node.off(f_.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_runSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!0})}},{key:"_stopSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!1})}},{key:"_updateSubContextFrameRate",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"frameRate",value:this._fps})}}]),t}()).prototype,"fps",[lo],Object.getOwnPropertyDescriptor(AA.prototype,"fps"),AA.prototype),kA=b(AA.prototype,"_fps",[EA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),CA=AA))||CA)||CA)||CA));cc.SubContextView=NA,cc.RenderPassStage=sh;var UA,VA,GA,HA,WA,qA,jA,XA,YA,KA,QA,ZA,JA,$A=q3("EventHandler",(OA=oo("cc.ClickEvent"),MA=lo(cc.Node),OA((b((LA=function(){function o(){y(this,o),m(this,"target",zA,this),m(this,"component",BA,this),m(this,"_componentId",PA,this),m(this,"handler",DA,this),m(this,"customEventData",FA,this)}return v(o,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=e.length;r<a;r++){var s=e[r];s instanceof o&&s.emit(i)}}}]),o}()).prototype,"_componentName",[lo],Object.getOwnPropertyDescriptor(LA.prototype,"_componentName"),LA.prototype),zA=b(LA.prototype,"target",[MA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BA=b(LA.prototype,"component",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PA=b(LA.prototype,"_componentId",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DA=b(LA.prototype,"handler",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),FA=b(LA.prototype,"customEventData",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IA=LA))||IA));cc.Component.EventHandler=$A;var ek,tk=(UA=oo("cc.MissingClass"),VA=lo({visible:!1,editorOnly:!0}),UA((WA=b((HA=function e(){y(this,e),m(this,"_$erialized",WA,this)}).prototype,"_$erialized",[VA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GA=HA))||GA),ik=q3("MissingScript",(qA=oo("cc.MissingScript"),jA=yo("packages://inspector/inspectors/comps/missing-script.js"),XA=lo({serializable:!1}),YA=lo({visible:!1,editorOnly:!0}),qA(KA=jA((ZA=b((QA=function(){function n(){var e;return y(this,n),m(e=x(this,g(n).call(this)),"compiled",ZA,l(e)),m(e,"_$erialized",JA,l(e)),e}return p(n,rp),v(n,null,[{key:"safeFindClass",value:function(e,t){var i=Ke(e);return i||(e?(cc.deserialize.reportMissingClass(e),n.getMissingWrapper(e,t)):null)}},{key:"getMissingWrapper",value:function(e,t){return t.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||tt.test(e))?n:tk}}]),v(n,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),n}()).prototype,"compiled",[XA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JA=b(QA.prototype,"_$erialized",[YA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KA=QA))||KA)||KA));cc._MissingScript=ik;var nk=[gf.TOUCH_START,gf.TOUCH_END,gf.TOUCH_MOVE,gf.MOUSE_DOWN,gf.MOUSE_MOVE,gf.MOUSE_UP,gf.MOUSE_ENTER,gf.MOUSE_LEAVE,gf.MOUSE_WHEEL];function rk(e){e.propagationStopped=!0}var ak,sk,ok,lk,uk,ck,hk,dk,fk,pk,_k,vk,mk,yk=q3("BlockInputEventsComponent",oo("cc.BlockInputEventsComponent")(ek=po("Components/BlockInputEvents")(ek=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,rp),v(e,[{key:"onEnable",value:function(){for(var e=0;e<nk.length;e++)this.node.on(nk[e],rk,this)}},{key:"onDisable",value:function(){for(var e=0;e<nk.length;e++)this.node.off(nk[e],rk,this)}}]),e}())||ek)||ek);cc.BlockInputEventsComponent=yk,or(HC.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]);var gk,bk,xk,Sk,wk,Tk,Ek,Ck,Ak,kk,Rk,Ok,Mk,Ik,Lk,zk,Bk,Pk,Dk,Fk,Nk,Uk,Vk,Gk,Hk,Wk,qk,jk,Xk,Yk,Kk,Qk,Zk,Jk,$k,eR,tR,iR,nR,rR,aR,sR,oR,lR,uR,cR,hR,dR,fR,pR,_R,vR,mR,yR,gR,bR,xR,SR,wR,TR,ER,CR,AR,kR,RR,OR,MR,IR,LR,zR,BR,PR,DR,FR,NR,UR=vt({OFF:0,ON:1}),VR=q3("ModelComponent",(ak=oo("cc.ModelComponent"),sk=_o(100),ok=po("Components/Model"),lk=lo({type:rv}),uk=lo({type:UR}),ak(ck=sk(ck=ok(ck=ho((mk=vk=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._model=null,m(t,"_enableDynamicBatching",dk,l(t)),m(t,"_mesh",fk,l(t)),m(t,"_shadowCastingMode",pk,l(t)),m(t,"_receiveShadows",_k,l(t)),t}return p(a,ox),v(a,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model&&(this._model.inited||this._updateModels(),this._model.enabled=!0)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"onDestroy",value:function(){this._model&&(this._model.scene.destroyModel(this._model),this._model=null,this._models.length=0)}},{key:"_changeSceneInModel",value:function(){this.isValid&&(this._model&&(this._model.destroy(),this._model.scene.destroyModel(this._model),this._model=null),this._updateModels())}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy&&this._mesh&&(this._createModel(),this._updateModelParams(),this._model&&(this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0,this._enableDynamicBatching))){this._mesh.hasFlatBuffers||this._mesh.createFlatBuffers();for(var e=0;e<this._model.subModels.length;++e)for(var t=this._model.subModels[e],i=0;i<t.passes.length;++i){var n=t.passes[i];n.batchedBuffer||n.createBatchedBuffer()}}}},{key:"_createModel",value:function(){if(this.node.scene){var e=this._getRenderScene();this._model&&e.destroyModel(this._model),this._model=e.createModel(this._getModelConstructor(),this.node),this._model.visFlags=this.visibility,this._models.length=0,this._models.push(this._model)}}},{key:"_getModelConstructor",value:function(){return _v}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags=this._model.transform.hasChangedFlags=Fp.POSITION,this._model.isDynamicBatching=this._enableDynamicBatching;for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getSharedMaterial(t),n=this._mesh.renderingMesh;if(n){var r=n.getSubmesh(t);r&&this._model.initSubModel(t,r,i||this._getBuiltinMaterial())}}}}},{key:"_onMaterialModified",value:function(e,t){if(null!=this._model&&(this._onRebuildPSO(e,t||this._getBuiltinMaterial()),this._enableDynamicBatching&&t))for(var i=0;i<t.passes.length;++i){var n=t.passes[i];n.batchedBuffer||n.createBatchedBuffer()}}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(null!=this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return G_.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===UR.OFF?this._model.castShadow=!1:this._shadowCastingMode===UR.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_updateReceiveShadow",value:function(){this.enabledInHierarchy&&this._model}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows=e,this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableDynamicBatching",set:function(e){if(this._enableDynamicBatching!==e&&(this._enableDynamicBatching=e,this._mesh&&(e?this._mesh.createFlatBuffers():this._mesh.destroyFlatBuffers()),this._model)){this._model.isDynamicBatching=e,this._model.onPipelineChange();for(var t=0;t<this._model.subModels.length;++t)for(var i=this._model.subModels[t],n=0;n<i.passes.length;++n){var r=i.passes[n];e?r.createBatchedBuffer():r.clearBatchedBuffer()}}},get:function(){return this._enableDynamicBatching}}]),a}(),vk.ShadowCastingMode=UR,b((hk=mk).prototype,"mesh",[lk],Object.getOwnPropertyDescriptor(hk.prototype,"mesh"),hk.prototype),b(hk.prototype,"shadowCastingMode",[uk],Object.getOwnPropertyDescriptor(hk.prototype,"shadowCastingMode"),hk.prototype),b(hk.prototype,"enableDynamicBatching",[lo],Object.getOwnPropertyDescriptor(hk.prototype,"enableDynamicBatching"),hk.prototype),dk=b(hk.prototype,"_enableDynamicBatching",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fk=b(hk.prototype,"_mesh",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pk=b(hk.prototype,"_shadowCastingMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UR.OFF}}),_k=b(hk.prototype,"_receiveShadows",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ck=hk))||ck)||ck)||ck)||ck)),GR=q3("SkinningModelComponent",(gk=oo("cc.SkinningModelComponent"),bk=_o(100),xk=po("Components/SkinningModel"),Sk=lo(Wb),wk=lo(f_),Tk=lo({type:Wb}),Ek=lo({type:f_}),gk(Ck=bk(Ck=ho(Ck=xk((kk=b((Ak=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_skeleton",kk,l(t)),m(t,"_skinningRoot",Rk,l(t)),t._clip=null,t}return p(a,VR),v(a,[{key:"uploadAnimation",value:function(e){this._clip=e,this._model&&this._model.uploadAnimation(e)}},{key:"_updateModelParams",value:function(){this._update(),_(g(a.prototype),"_updateModelParams",this).call(this)}},{key:"_getModelConstructor",value:function(){return xv}},{key:"_getBuiltinMaterial",value:function(){return G_.get("missing-skinning-material")}},{key:"_update",value:function(){if(this._model){var e=this._model;e.bindSkeleton(this._skeleton,this._skinningRoot),e.uploadAnimation(this._clip)}}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._update()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._update()}},{key:"model",get:function(){return this._model}}]),a}()).prototype,"_skeleton",[Sk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rk=b(Ak.prototype,"_skinningRoot",[wk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(Ak.prototype,"skeleton",[Tk],Object.getOwnPropertyDescriptor(Ak.prototype,"skeleton"),Ak.prototype),b(Ak.prototype,"skinningRoot",[Ek],Object.getOwnPropertyDescriptor(Ak.prototype,"skinningRoot"),Ak.prototype),Ck=Ak))||Ck)||Ck)||Ck)||Ck)),HR={name:Cu.ATTR_BATCH_ID,format:Ou.R32F,isNormalized:!1},WR={name:Cu.ATTR_BATCH_UV,format:Ou.RG32F,isNormalized:!1},qR=Xc[HR.format].size+Xc[WR.format].size,jR=q3("SkinningModelUnit",(Ok=oo("cc.SkinningModelUnit"),Mk=lo(rv),Ik=lo(Wb),Lk=lo(fm),zk=lo({type:GR}),Ok((Dk=b((Pk=function(){function e(){y(this,e),m(this,"mesh",Dk,this),m(this,"skeleton",Fk,this),m(this,"material",Nk,this),m(this,"_offset",Uk,this),m(this,"_size",Vk,this)}return v(e,[{key:"offset",set:function(e){Mi.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){Mi.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getSharedMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[Mk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fk=b(Pk.prototype,"skeleton",[Ik],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nk=b(Pk.prototype,"material",[Lk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uk=b(Pk.prototype,"_offset",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),Vk=b(Pk.prototype,"_size",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),b(Pk.prototype,"offset",[lo],Object.getOwnPropertyDescriptor(Pk.prototype,"offset"),Pk.prototype),b(Pk.prototype,"size",[lo],Object.getOwnPropertyDescriptor(Pk.prototype,"size"),Pk.prototype),b(Pk.prototype,"copyFrom",[zk],Object.getOwnPropertyDescriptor(Pk.prototype,"copyFrom"),Pk.prototype),Bk=Pk))||Bk)),XR=q3("BatchedSkinningModelComponent",(Gk=oo("cc.BatchedSkinningModelComponent"),Hk=_o(100),Wk=po("Components/BatchedSkinningModel"),qk=lo({type:[Ot]}),jk=lo({type:[jR]}),Xk=lo({override:!0,visible:!1}),Yk=lo({override:!0,visible:!1}),Gk(Kk=Hk(Kk=ho(Kk=Wk((Zk=b((Qk=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"atlasSize",Zk,l(t)),m(t,"batchableTextureNames",Jk,l(t)),m(t,"units",$k,l(t)),t._textures={},t._batchMaterial=null,t}return p(a,GR),v(a,[{key:"onLoad",value:function(){_(g(a.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),_(g(a.prototype),"onDestroy",this).call(this)}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var d=this;this._batchMaterial||(this._batchMaterial=this.getSharedMaterial(0));var f=this.getMaterial(0);if(f&&this._batchMaterial&&this._batchMaterial.effectAsset){f.copy(this._batchMaterial),this.resizeAtlases();for(var t=f.effectAsset.techniques[f.technique],e=function(l){var u=t.passes[l];if(!u.properties)return"continue";for(var e=function(){var t=h[c];if(u.properties[t].type>=ku.SAMPLER1D){var i=null;d.batchableTextureNames.find(function(e){return e===t})?(i=(i=d._textures[t])||d.createTexture(t),d.cookTextures(i,t,l)):d.units.some(function(e){return i=e.material&&e.material.getProperty(t,l)}),i&&f.setProperty(t,i,l)}else{var e=[],n=d.units,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.material&&e.push(o.material.getProperty(t.slice(0,-3),l))}f.setProperty(t,e,l)}},c=0,h=Object.keys(u.properties);c<h.length;c++)e()},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){var i=new Wb,n=[],e=this.units,t=Array.isArray(e),r=0;for(e=t?e:e[Symbol.iterator]();;){var a;if(t){if(r>=e.length)break;a=e[r++]}else{if((r=e.next()).done)break;a=r.value}var s=a;if(s&&s.skeleton)for(var o=s.skeleton,l=function(e){var t=o.joints[e];if(0<=i.joints.findIndex(function(e){return e===t}))return"continue";i.joints.push(t),n.push(o.bindposes[e]||new zn)},u=0;u<o.joints.length;u++)l(u)}var c=Array.from(Array(i.joints.length).keys()).sort(function(e,t){return i.joints[e]>i.joints[t]?1:i.joints[e]<i.joints[t]?-1:0});i.joints=i.joints.map(function(e,t,i){return i[c[t]]}),i.bindposes=n.map(function(e,t,i){return i[c[t]]}),this._skeleton&&this._skeleton.destroy(),this.skeleton=i}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){var W=this,e=!1,t=this.units,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new rv,e&&this._skinningRoot){for(var q,j=0,X=Ou.UNKNOWN,Y=0,K=Ou.UNKNOWN,Q=new Array(this.units.length),a=this.units.length,s=0;s<a;s++){var o=this.units[s];o&&o.skeleton&&(Q[s]=o.skeleton.joints.map(function(t){return W._skeleton.joints.findIndex(function(e){return t===e})}))}for(var l=function(d){var e=W.units[d];if(!e||!e.mesh||!e.mesh.data)return"continue";var t=JSON.parse(JSON.stringify(e.mesh.struct)),i=0,n=t.vertexBundles,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.attributes.push(HR),o.attributes.push(WR),o.view.offset=i,o.view.length+=o.view.count*qR,o.view.stride+=qR,i+=o.view.length}var l=t.primitives,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}var f=h;f.indexView&&(f.indexView.offset=i,i+=f.indexView.length),f.geometricInfo&&(i=4*Math.ceil(i/4),f.geometricInfo.view.offset=i,i+=f.geometricInfo.view.length)}var p=e.mesh.data,_=0,v=new Uint8Array(i);q=new DataView(v.buffer);for(var m=0;m<t.vertexBundles.length;m++){var y=e.mesh.readAttribute(m,Cu.ATTR_TEX_COORD),g=e.mesh.struct.vertexBundles[m].view,b=t.vertexBundles[m].view,x=g.stride,S=b.stride;_=g.offset,i=b.offset;for(var w=0;w<b.count;w++){var T=p.subarray(_,_+x);v.set(T,i),q.setFloat32(i+x,d,cc.sys.isLittleEndian),q.setFloat32(i+x+4,y[2*w],cc.sys.isLittleEndian),q.setFloat32(i+x+8,y[2*w+1],cc.sys.isLittleEndian),i+=S,_+=x}}for(var E=0;E<t.primitives.length;E++){var C=e.mesh.struct.primitives[E],A=t.primitives[E];if(C.indexView&&A.indexView){var k=C.indexView.stride,R=A.indexView.stride;_=C.indexView.offset,i=A.indexView.offset;for(var O=0;O<A.indexView.count;O++){var M=p.subarray(_,_+k);v.set(M,i),i+=R,_+=k}}if(C.geometricInfo&&A.geometricInfo){var I=C.geometricInfo.view.stride,L=A.geometricInfo.view.stride;_=C.geometricInfo.view.offset,i=A.geometricInfo.view.offset;for(var z=0;z<A.geometricInfo.view.count;z++){var B=p.subarray(_,_+I);v.set(B,i),i+=L,_+=I}}}var P=new rv;P.reset({struct:t,data:v});function D(){if(V){if(G>=U.length)return"break";H=U[G++]}else{if((G=U.next()).done)return"break";H=G.value}var e=H;j=e.view.offset,X=Ou.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===Cu.ATTR_BATCH_UV){X=a.format;break}j+=Xc[a.format].size}X&&Ov(q,function(e,t){var i=0===t?"x":"y";return(e=function(e){return e-Math.floor(e)}(e))*N[i]+F[i]},X,j,e.view.length,e.view.stride,q);var s=Q[d];if(!s)return"continue";Y=e.view.offset,K=Ou.UNKNOWN;var o=e.attributes,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;if(h.name===Cu.ATTR_JOINTS){K=h.format;break}Y+=Xc[h.format].size}K&&Ov(q,function(e){return s[e]},K,Y,e.view.length,e.view.stride,q)}var F=e.offset,N=e.size;var U=t.vertexBundles,V=Array.isArray(U),G=0;e:for(U=V?U:U[Symbol.iterator]();;){var H;switch(D()){case"break":break e;case"continue":continue}}W._mesh.merge(P)},u=0;u<a;u++)l(u);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var n=[],r=[],a=[],s=[],o=this.units,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;if(h.material){var d=h.material.getProperty(t,i);if(d&&d.image&&d.image.data){var f=new jc;f.texOffset.x=h.offset.x*this.atlasSize,f.texOffset.y=h.offset.y*this.atlasSize,f.texExtent.width=h.size.x*this.atlasSize,f.texExtent.height=h.size.y*this.atlasSize;var p=d.image.data;p instanceof HTMLCanvasElement||p instanceof HTMLImageElement?(n.push(p),r.push(f)):(a.push(p.buffer),s.push(f))}}}var _=e.getGFXTexture(),v=cc.director.root.device;0<a.length&&v.copyBuffersToTexture(a,_,s),0<n.length&&v.copyTexImagesToTexture(n,_,r)}},{key:"createTexture",value:function(e){var t=new uf;return t.setFilters(ud.LINEAR,ud.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:ad.RGBA8888}),t.loaded=!0,this._textures[e]=t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:ad.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){r(g(a.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){r(g(a.prototype),"skeleton",e,this,!0)}}]),a}()).prototype,"atlasSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),Jk=b(Qk.prototype,"batchableTextureNames",[qk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$k=b(Qk.prototype,"units",[jk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),b(Qk.prototype,"mesh",[Xk],Object.getOwnPropertyDescriptor(Qk.prototype,"mesh"),Qk.prototype),b(Qk.prototype,"skeleton",[Yk],Object.getOwnPropertyDescriptor(Qk.prototype,"skeleton"),Qk.prototype),Kk=Qk))||Kk)||Kk)||Kk)||Kk)),YR=vt({LUMINOUS_POWER:0,LUMINANCE:1}),KR=q3("LightComponent",(eR=oo("cc.LightComponent"),tR=lo({slide:!0,range:[1e3,15e3,1]}),eR((lR=oR=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_color",rR,l(t)),m(t,"_useColorTemperature",aR,l(t)),m(t,"_colorTemperature",sR,l(t)),t._type=ex.UNKNOWN,t._light=null,t}return p(a,rp),v(a,[{key:"onEnable",value:function(){this._light?this._light.enabled=!0:this._createLight()}},{key:"onDisable",value:function(){this._light&&(this._light.enabled=!1)}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(e){this._light&&(this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.enabled=this.enabledInHierarchy)}},{key:"_destroyLight",value:function(e){this._light=null}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),a}(),oR.Type=ex,oR.PhotometricTerm=YR,rR=b((nR=lR).prototype,"_color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),aR=b(nR.prototype,"_useColorTemperature",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sR=b(nR.prototype,"_colorTemperature",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),b(nR.prototype,"color",[lo],Object.getOwnPropertyDescriptor(nR.prototype,"color"),nR.prototype),b(nR.prototype,"useColorTemperature",[lo],Object.getOwnPropertyDescriptor(nR.prototype,"useColorTemperature"),nR.prototype),b(nR.prototype,"colorTemperature",[tR],Object.getOwnPropertyDescriptor(nR.prototype,"colorTemperature"),nR.prototype),iR=nR))||iR)),QR=q3("DirectionalLightComponent",(uR=oo("cc.DirectionalLightComponent"),cR=po("Light/DirectionalLight"),hR=lo({unit:"lx"}),uR(dR=cR(dR=ho((pR=b((fR=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_illuminance",pR,l(t)),t._type=ex.DIRECTIONAL,t._light=null,t}return p(a,KR),v(a,[{key:"_createLight",value:function(e){this.node.scene&&((e=e||this._getRenderScene()).mainLight.node.activeInHierarchy?console.warn("there can be only one directional(main) light."):(this._light=e.mainLight,this.illuminance=this._illuminance,_(g(a.prototype),"_createLight",this).call(this,e)))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(this._light.enabled=!1,e=e||this._getRenderScene(),this._light.node=e.defaultMainLightNode,_(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),a}()).prototype,"_illuminance",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),b(fR.prototype,"illuminance",[hR],Object.getOwnPropertyDescriptor(fR.prototype,"illuminance"),fR.prototype),dR=fR))||dR)||dR)||dR)),ZR=oo("cc.EditorCameraComponent")(_R=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._uiEditorCamera=null,t}return p(a,xC),v(a,[{key:"onLoad",value:function(){_(g(a.prototype),"onLoad",this).call(this),this._inEditorMode=!0}},{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this)}},{key:"onDisable",value:function(){_(g(a.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){_(g(a.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;_(g(a.prototype),"_createCamera",this).call(this),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.ui.renderScene.createCamera({name:"Editor UICamera",node:this._camera.node,projection:this._projection,window:cc.director.root.mainWindow,priority:this._priority+1,flows:["UIFlow"]}),this._uiEditorCamera.visibility=Oh,this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=Nc.DEPTH_STENCIL)}},{key:"projection",set:function(e){r(g(a.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){r(g(a.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=mi(e))}},{key:"orthoHeight",set:function(e){r(g(a.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){r(g(a.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){r(g(a.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){r(g(a.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=e)}},{key:"depth",set:function(e){r(g(a.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){r(g(a.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){r(g(a.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){r(g(a.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){r(g(a.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}}]),a}())||_R,JR=q3("SphereLightComponent",(vR=oo("cc.SphereLightComponent"),mR=po("Light/SphereLight"),yR=lo({unit:"lm"}),gR=lo({unit:"cd/m"}),bR=lo({type:YR}),vR(xR=mR(xR=ho((wR=b((SR=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_size",wR,l(t)),m(t,"_luminance",TR,l(t)),m(t,"_term",ER,l(t)),m(t,"_range",CR,l(t)),t._type=ex.SPHERE,t._light=null,t}return p(a,KR),v(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.sphereLights.find(function(e){return e===t._light})||(this._light=e.createSphereLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,_(g(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySphereLight(this._light),_(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*ux(this._size)},set:function(e){this._luminance=e/ux(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),a}()).prototype,"_size",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),TR=b(SR.prototype,"_luminance",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/ux(.15)}}),ER=b(SR.prototype,"_term",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YR.LUMINOUS_POWER}}),CR=b(SR.prototype,"_range",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b(SR.prototype,"luminousPower",[yR],Object.getOwnPropertyDescriptor(SR.prototype,"luminousPower"),SR.prototype),b(SR.prototype,"luminance",[gR],Object.getOwnPropertyDescriptor(SR.prototype,"luminance"),SR.prototype),b(SR.prototype,"term",[bR],Object.getOwnPropertyDescriptor(SR.prototype,"term"),SR.prototype),b(SR.prototype,"size",[lo],Object.getOwnPropertyDescriptor(SR.prototype,"size"),SR.prototype),b(SR.prototype,"range",[lo],Object.getOwnPropertyDescriptor(SR.prototype,"range"),SR.prototype),xR=SR))||xR)||xR)||xR)),$R=q3("SpotLightComponent",(AR=oo("cc.SpotLightComponent"),kR=po("Light/SpotLight"),RR=lo({unit:"lm"}),OR=lo({unit:"cd/m"}),MR=lo({type:YR}),IR=lo({slide:!0,range:[2,180,1]}),AR(LR=kR(LR=ho((BR=b((zR=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_size",BR,l(t)),m(t,"_luminance",PR,l(t)),m(t,"_term",DR,l(t)),m(t,"_range",FR,l(t)),m(t,"_spotAngle",NR,l(t)),t._type=ex.SPOT,t._light=null,t}return p(a,KR),v(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.spotLights.find(function(e){return e===t._light})||(this._light=e.createSpotLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,_(g(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySpotLight(this._light),_(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*ux(this._size)},set:function(e){this._luminance=e/ux(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=mi(e))}}]),a}()).prototype,"_size",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),PR=b(zR.prototype,"_luminance",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/ux(.15)}}),DR=b(zR.prototype,"_term",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YR.LUMINOUS_POWER}}),FR=b(zR.prototype,"_range",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NR=b(zR.prototype,"_spotAngle",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),b(zR.prototype,"luminousPower",[RR],Object.getOwnPropertyDescriptor(zR.prototype,"luminousPower"),zR.prototype),b(zR.prototype,"luminance",[OR],Object.getOwnPropertyDescriptor(zR.prototype,"luminance"),zR.prototype),b(zR.prototype,"term",[MR],Object.getOwnPropertyDescriptor(zR.prototype,"term"),zR.prototype),b(zR.prototype,"size",[lo],Object.getOwnPropertyDescriptor(zR.prototype,"size"),zR.prototype),b(zR.prototype,"range",[lo],Object.getOwnPropertyDescriptor(zR.prototype,"range"),zR.prototype),b(zR.prototype,"spotAngle",[IR],Object.getOwnPropertyDescriptor(zR.prototype,"spotAngle"),zR.prototype),LR=zR))||LR)||LR)||LR));function eO(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}cc.CameraComponent=xC,cc.EditorComponent=ZR,cc.RenderableComponent=ox,cc.ModelComponent=VR,cc.SkinningModelComponent=GR,cc.BatchedSkinningModelComponent=XR,cc.SkinningModelUnit=jR,cc.LightComponent=KR,cc.DirectionalLightComponent=QR,cc.SphereLightComponent=JR,cc.SpotLightComponent=$R,cc.utils=Nv,cc.bezier=eO;var tO=Math.cos,iO=Math.acos,nO=Math.max,rO=2*Math.PI,aO=Math.sqrt;function sO(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function oO(e,t){var i=function(e,t){var i,n,r,a,s=t-0,o=t-e[0],l=3*s,u=3*o,c=3*(t-e[2]),h=1/(u-s-c+(t-1)),d=(l-6*o+c)*h,f=1/3*d,p=(u-l)*h,_=1/3*(3*p-d*d),v=1/3*_,m=(2*d*d*d-9*d*p+27*(s*h))/27,y=m/2,g=y*y+v*v*v;if(g<0){var b=1/3*-_,x=aO(b*b*b),S=-m/(2*x),w=iO(S<-1?-1:1<S?1:S),T=2*sO(x);return n=T*tO(w*(1/3))-f,r=T*tO((w+rO)*(1/3))-f,a=T*tO((w+2*rO)*(1/3))-f,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?nO(n,r,a):nO(n,r):0<=a&&a<=1?nO(n,a):n:0<=r&&r<=1?0<=a&&a<=1?nO(r,a):r:a}if(0==g)return r=-(i=y<0?sO(-y):-sO(y))-f,0<=(n=2*i-f)&&n<=1?0<=r&&r<=1?nO(n,r):n:r;var E=aO(g);return n=(i=sO(-y+E))-sO(y+E)-f}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}cc.bezierByTime=oO;var lO,uO,cO,hO,dO=1e-6;function fO(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+dO<a)n=r-1;else{if(!(a<t-dO))return r;i=r+1}}return~i}(uO=lO=lO||{})[uO.Loop=2]="Loop",uO[uO.ShouldWrap=4]="ShouldWrap",uO[uO.PingPong=22]="PingPong",uO[uO.Reverse=36]="Reverse",(hO=cO=cO||{})[hO.Default=0]="Default",hO[hO.Normal=1]="Normal",hO[hO.Reverse=lO.Reverse]="Reverse",hO[hO.Loop=lO.Loop]="Loop",hO[hO.LoopReverse=lO.Loop|lO.Reverse]="LoopReverse",hO[hO.PingPong=lO.PingPong]="PingPong",hO[hO.PingPongReverse=lO.PingPong|lO.Reverse]="PingPongReverse",mt(cO);var pO,_O=function(){function t(e){y(this,t),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return v(t,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),t}();var vO=q3("RatioSampler",function(){function s(e){var t,i;y(this,s),this.ratios=void 0;for(var n=!(this._findRatio=void 0),r=1,a=(this.ratios=e).length;r<a;r++)if(t=e[r]-e[r-1],1===r)i=t;else if(1e-6<Math.abs(t-i)){n=!1;break}this._findRatio=n?xO:fO}return v(s,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),s}());cc.RatioSampler=vO;var mO=q3("AnimCurve",function(){function r(e,t){y(this,r),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._stepfiedValues=void 0,this._duration=void 0,this._duration=t,this._values=e.values;function i(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?r.Linear:r.Bezier(e):r.Linear}void 0!==e.easingMethod?this.type=i(e.easingMethod):void 0!==e.easingMethods?this.types=e.easingMethods.map(i):this.type=null;var n=e.values[0];void 0!==e.interpolate&&!e.interpolate||(this._lerp=SO(n))}return v(r,null,[{key:"Bezier",value:function(e){return e}}]),v(r,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,s=r-i,o=(e-i)/s;a&&(o=bO(o,a));var l=this._values[t],u=this._values[n];return this._lerp(l,u,o,s*this._duration)}return this.valueAt(t)}},{key:"empty",value:function(){return 0===this._values.length}}]),r}());mO.Linear=null,cc.AnimCurve=mO;q3("EventInfo",function(){function e(){y(this,e),this.events=[]}return v(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}());var yO=q3("CurveValueAdapter",oo("cc.CurveValueAdapter")(pO=function(){function e(){y(this,e)}return v(e,[{key:"forTarget",value:function(e){return{set:function(e){}}}}]),e}())||pO);function gO(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function bO(e,t){if("string"==typeof t){var i=mu[t];i?e=i(e):D(3906,t)}else Array.isArray(t)&&(e=oO(t,e));return e}function xO(e,t){var i=e.length-1;if(0==i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(r<t)return i;var a=(t=(t-n)/(r-n))/(1/i),s=0|a;return a-s<1e-6?s:1+s-a<1e-6?1+s:~(1+s)}cc.CurveValueAdapter=yO,cc.sampleAnimationCurve=gO;var SO=function(e){if(null!==e){if("number"==typeof e)return vi;if("object"===_e(e)&&e.constructor){if(e instanceof hn)return function(){var r=new hn;return function(e,t,i,n){return hn.slerp(r,e,t,i)}}();if(e instanceof yt)return function(n){var r=new n;return function(e,t,i){return n.lerp(r,e,t,i),r}}(e.constructor);if(e.constructor===Number)return vi;if(function(e){return"function"==typeof e.lerp}(e))return wO}}};function wO(e,t,i,n){return e.lerp(t,i,n)}var TO,EO,CO,AO,kO,RO,OO,MO,IO,LO,zO,BO,PO,DO,FO;var NO=q3("AnimationClip",(TO=oo("cc.AnimationClip"),EO=lo({visible:!1}),TO((FO=DO=function(){function o(){var e,t;y(this,o);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(o)).call.apply(e,[this].concat(n))),"sample",kO,l(t)),m(t,"speed",RO,l(t)),m(t,"wrapMode",OO,l(t)),m(t,"events",MO,l(t)),m(t,"_duration",IO,l(t)),m(t,"_keys",LO,l(t)),m(t,"_stepness",zO,l(t)),m(t,"curveDatas",BO,l(t)),m(t,"_curves",PO,l(t)),t._hash=0,t.frameRate=0,t._ratioSamplers=[],t._runtimeCurves=void 0,t._runtimeEvents=void 0,t._data=null,t}return p(o,rd),v(o,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._migrateCurveDatas(),this._decodeCVTAs()}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateCurveDatas",value:function(){this._migrateCurveDatas(),delete this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+1e-6<a)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"_createPropertyCurves",value:function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new vO(e.map(function(e){return e/t._duration}))}),this._runtimeCurves=this._curves.map(function(e){return{curve:new mO(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys]}}),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var n=this;var r=[],a=[],e=function(){if(o){if(l>=s.length)return"break";u=s[l++]}else{if((l=s.next()).done)return"break";u=l.value}var e=u,t=e.frame/n._duration,i=r.findIndex(function(e){return e===t});i<0&&(i=r.length,r.push(t),a.push({events:[]})),a[i].events.push({functionName:e.func,parameters:e.params})},s=this.events.sort(function(e,t){return e.frame-t.frame}),o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if("break"===e())break}this._runtimeEvents={ratios:r,eventGroups:a}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_migrateCurveDatas",value:function(){if(this.curveDatas){for(var e=0,t=Object.keys(this.curveDatas);e<t.length;e++){var i=t[e],n=new m_;n.path=i;var r=this.curveDatas[i];if(r.props)for(var a=0,s=Object.keys(r.props);a<s.length;a++){var o=s[a],l=r.props[o];this._curves.push({modifiers:[n,o],data:l})}if(r.comps)for(var u=0,c=Object.keys(r.comps);u<c.length;u++){var h=c[u],d=new y_;d.component=h;for(var f=r.comps[h],p=0,_=Object.keys(f);p<_.length;p++){var v=_[p],m=f[v];this._curves.push({modifiers:[n,d,v],data:m})}}}delete this.curveDatas}}},{key:"_decodeCVTAs",value:function(){var e=this._nativeAsset;if(e){for(var t=this._keys,i=0;i<t.length;++i){var n=t[i];n instanceof yl&&(t[i]=n.decompress(e))}for(var r=0;r<this._curves.length;++r){var a=this._curves[r];a.data.values instanceof yl&&(a.data.values=a.data.values.decompress(e))}}}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){return this._hash||(this._hash=xd(JSON.stringify(this._curves),666)),this._hash}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"data",get:function(){return this._data}}],[{key:"createWithSpriteFrames",value:function(e,t){if(!Array.isArray(e))return D(3905),null;var i=new o;i.sample=t||i.sample,i.duration=e.length/i.sample;for(var n=1/i.sample,r=new Array(e.length),a=new Array(r.length),s=0;s<e.length;s++)r[s]=s*n,a[s]=e[s];return i.keys=[r],i.curves=[{modifiers:[new y_("cc.SpriteComponent"),"spriteFrame"],data:{keys:0,values:a}}],i}}]),o}(),DO.preventDeferredLoadDependents=!0,DO.WrapMode=cO,kO=b((AO=FO).prototype,"sample",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),RO=b(AO.prototype,"speed",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),OO=b(AO.prototype,"wrapMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cO.Normal}}),MO=b(AO.prototype,"events",[EO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IO=b(AO.prototype,"_duration",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LO=b(AO.prototype,"_keys",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zO=b(AO.prototype,"_stepness",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BO=b(AO.prototype,"curveDatas",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),PO=b(AO.prototype,"_curves",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CO=AO))||CO));cc.AnimationClip=NO;var UO,VO,GO,HO=function(){function e(){y(this,e),this._blendTargets=[]}return v(e,[{key:"refPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.find(function(e){return e.target===t});e||(e={target:t,properties:[]},this._blendTargets.push(e));var n=e.properties,r=n.find(function(e){return e.name===i});return r||(r={name:i,weight:0,value:void 0,refCount:0},n.push(r)),++r.refCount,r}},{key:"derefPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.findIndex(function(e){return e.target===t});if(!(e<0)){var n=this._blendTargets[e].properties,r=n.findIndex(function(e){return e.name===i});if(!(r<0)){var a=n[r];--a.refCount,0<a.refCount||(2<=n.length?n.splice(r,1):this._blendTargets.splice(e,1))}}}},{key:"apply",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.target,s=r.properties,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;0!==c.weight&&(a instanceof f_?"position"===c.name?a.setPosition(c.value):"rotation"===c.name?a.setRotation(c.value):a.setScale(c.value):a[c.name]=c.value)}}}},{key:"clear",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n.properties,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.weight=0}}}}]),e}(),WO=q3("AnimationManager",oo((GO=VO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._anims=new ce([]),t._delayEvents=[],t._blendState=new HO,t._crossFades=[],t}return p(a,lx),v(a,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){de(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update(e)}this._blendState.clear();var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var o=s[a.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var l=this._delayEvents,u=0,c=l.length;u<c;u++){var h=l[u];h.target[h.func].apply(h.target,h.args)}l.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);0<=t?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):D(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),a}(),VO.ID="animation",UO=GO))||UO);function qO(e,t,i){return i.value||(i.value=new Fi),0===i.weight&&Fi.zero(i.value),0===t?i.value:1===t?Fi.copy(i.value,e):Fi.scaleAndAdd(i.value,i.value,e,t)}function jO(e,t,i){if(i.value||(i.value=new hn),0===i.weight&&hn.identity(i.value),0===t)return i.value;if(1===t)return hn.copy(i.value,e);var n=t/(i.weight+t);return hn.slerp(i.value,i.value,e,n)}qE.on(lE.EVENT_INIT,function(){var e=new WO;qE.registerSystem(WO.ID,e,oE.PRIORITY_SYSTEM)}),cc.AnimationManager=WO;var XO,YO,KO=function(){function e(){y(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return v(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(G(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();(YO=XO=XO||{})[YO.NodePosition=0]="NodePosition",YO[YO.NodeScale=1]="NodeScale",YO[YO.NodeRotation=2]="NodeRotation",YO[YO.None=3]="None";var QO=function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(y(this,n),this._curve=void 0,this._boundTarget=void 0,this._curveValueProxy=void 0,this._rootTarget=void 0,this._rootTargetProperty=void 0,this._isNodeTarget=void 0,this._propertySpecialization=void 0,this._blendTarget=void 0,this._blendFunction=void 0,this._cached=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=new g_(t,e.modifiers,e.valueAdapter),this._rootTarget=t,this._isNodeTarget=t instanceof f_,this._propertySpecialization=XO.None,this._blendFunction=null,this._isNodeTarget&&1===e.modifiers.length)switch(e.modifiers[0]){case"position":this._propertySpecialization=XO.NodePosition,this._blendFunction=qO;break;case"rotation":this._propertySpecialization=XO.NodeRotation,this._blendFunction=jO;break;case"scale":this._propertySpecialization=XO.NodeScale,this._blendFunction=qO}this._blendTarget=i}return v(n,[{key:"attachToBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=e.refPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"dettachFromBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=null,e.derefPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){if(!this._blendFunction||!this._blendTarget||this._blendTarget.refCount<=1)switch(this._propertySpecialization){case XO.NodePosition:this._rootTarget.setPosition(e);break;case XO.NodeRotation:this._rootTarget.setRotation(e);break;case XO.NodeScale:this._rootTarget.setScale(e);break;default:this._boundTarget.setValue(e)}else this._blendTarget.value=this._blendFunction(e,t,this._blendTarget),this._blendTarget.weight+=t}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),n}();var ZO,JO,$O,eM,tM,iM=q3("AnimationState",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._lastframeEventOn=!1,i._wrapMode=cO.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new _O,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._curveLoaded=!1,i._ignoreIndex=-1,i._clip=e,i._name=t||e&&e.name,i}return p(n,KO),v(n,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&lO.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&lO.ShouldWrap,i=(this.wrapMode&lO.Reverse)===lO.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),v(n,[{key:"initialize",value:function(n){var r=this;if(!this._curveLoaded){this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=n;var e=this._clip;this.duration=e.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,(this.wrapMode&lO.Loop)===lO.Loop?this.repeatCount=1/0:this.repeatCount=1;for(var a=e.getPropertyCurves(),t=function(e){var t=a[e],i=r._samplerSharedGroups.find(function(e){return e.sampler===t.sampler});i||(i=function(e){return{sampler:e,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}}}(t.sampler),r._samplerSharedGroups.push(i));try{i.curves.push(new QO(t,n))}catch(e){}},i=0;i<a.length;++i)t(i)}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];cc.director.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var n=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,function(e){t.call(i,e),n._lastframeEventOn=!1})):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&lO.PingPong)===lO.PingPong&&(e-(0|e)==0&&0<e&&(e-=1),1&e&&(i=!i));return(t&lO.Reverse)===lO.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new _O;var i=!1,n=this.duration,r=this.repeatCount,a=0<e?e/n:-e/n;if(r<=a){i=!0;var s=(a=r)-(0|r);0===s&&(s=1),e=s*n*(0<e?1:-1)}if(n<e){var o=e%n;e=0==o?n:o}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,u=this._wrapMode&lO.ShouldWrap;u&&(l=this._needReverse(a));var c=l?-1:1;return this.speed<0&&(c*=-1),u&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=c,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new _O(t),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.time,t=this.duration;t<e?0===(e%=t)&&(e=t):e<0&&0!==(e%=t)&&(e+=t);var i=e/t;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(0<this.time&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.attachToBlendState(e)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.dettachFromBlendState(e)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,cc.director.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||cc.director.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){cc.director.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){cc.director.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){for(var t=0,i=this._samplerSharedGroups.length;t<i;++t){var n=this._samplerSharedGroups[t],r=n.sampler,a=n.samplerResultCache,s=0,o=!1;r?(s=r.sample(e))<0&&((s=~s)<=0?s=0:s>=r.ratios.length?s=r.ratios.length-1:(o=!0,a.from=s-1,a.fromRatio=r.ratios[a.from],a.to=s,a.toRatio=r.ratios[a.to])):s=0;for(var l=0,u=n.curves.length;l<u;++l){n.curves[l].applySample(e,s,o,a,this.weight)}}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new _O(e));var r=this.wrapMode,a=nM(e.iterations),s=this._lastWrapInfoEvent,o=nM(s.iterations),l=s.frameIndex,u=s.direction,c=-1!==o&&a!==o;if(l===n&&c&&1===t)this._fireEvent(0);else if(l!==n||c){i=u;do{if(l!==n){if(-1===i&&0===l&&0<n?((r&lO.PingPong)===lO.PingPong?i*=-1:l=t,o++):1===i&&l===t-1&&n<t-1&&((r&lO.PingPong)===lO.PingPong?i*=-1:l=-1,o++),l===n)break;if(a<o)break}l+=i,cc.director.getAnimationManager().pushDelayEvent(this,"_fireEvent",[l])}while(l!==n&&-1<l&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],n=this._targetNode.components,r=i.events,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u=l.functionName,c=n,h=Array.isArray(c),d=0;for(c=h?c:c[Symbol.iterator]();;){var f;if(h){if(d>=c.length)break;f=c[d++]}else{if((d=c.next()).done)break;f=d.value}var p=f,_=p[u];"function"==typeof _&&_.apply(p,l.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),n}());function nM(e){return e-(0|e)==0&&(e-=1),0|e}function rM(e,r,c,h){var t,i,a,s,o,d=new r,f=new r,p=new r,n=oo(e)((a=b((i=function(){function n(e,t,i){y(this,n),m(this,"dataPoint",a,this),m(this,"inTangent",s,this),m(this,"outTangent",o,this),this.dataPoint=e||new r,this.inTangent=t||new r,this.outTangent=i||new r}return v(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint;f=c(f,this.inTangent,i),p=c(p,e.outTangent,i);var a=t*t*t,s=t*t,o=a-2*s+t,l=-2*a+3*s,u=a-s;return d=c(d,n,2*a-3*s+1),d=h(d,d,f,o),d=h(d,d,r,l),d=h(d,d,p,u)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),s=b(i.prototype,"inTangent",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),o=b(i.prototype,"outTangent",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),t=i))||t;if(r===hn){var l=n.prototype.lerp;n.prototype.lerp=function(e,t,i){var n=l.call(this,e,t,i);return hn.normalize(n,n),n}}return n}cc.AnimationState=iM;var aM=q3("CubicSplineVec2Value",rM("cc.CubicSplineVec2Value",Mi,Mi.multiplyScalar,Mi.scaleAndAdd));cc.CubicSplineVec2Value=aM;var sM=q3("CubicSplineVec3Value",rM("cc.CubicSplineVec3Value",Fi,Fi.multiplyScalar,Fi.scaleAndAdd));cc.CubicSplineVec3Value=sM;var oM=q3("CubicSplineVec4Value",rM("cc.CubicSplineVec4Value",ji,ji.multiplyScalar,ji.scaleAndAdd));cc.CubicSplineVec4Value=oM;var lM=q3("CubicSplineQuatValue",rM("cc.CubicSplineQuatValue",hn,hn.multiplyScalar,hn.scaleAndAdd));cc.CubicSplineQuatValue=lM;var uM=q3("CubicSplineNumberValue",oo("cc.CubicSplineNumberValue")(($O=b((JO=function(){function n(e,t,i){y(this,n),m(this,"dataPoint",$O,this),m(this,"inTangent",eM,this),m(this,"outTangent",tM,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}return v(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,s=t*t;return n*(2*a-3*s+1)+this.outTangent*i*(a-2*s+t)+r*(-2*a+3*s)+e.inTangent*i*(a-s)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eM=b(JO.prototype,"inTangent",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tM=b(JO.prototype,"outTangent",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZO=JO))||ZO);cc.CubicSplineNumberValue=uM;var cM,hM,dM,fM,pM,_M,vM,mM,yM,gM,bM,xM,SM,wM,TM,EM=function(){function i(){var e;return y(this,i),(e=x(this,g(i).call(this)))._managedStates=[],e._fadings=[],e}return p(i,KO),v(i,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){if(0===n){r=a;break}var s=this._fadings[a];s.easeTime+=e;var o=_i(s.easeTime/s.easeDuration),l=o*n;n*=1-o,s.target.state&&(s.target.state.weight+=l)}if(r!==this._fadings.length){for(var u=r;u<this._fadings.length;++u){var c=this._fadings[u];--c.target.reference,c.target.reference<=0&&(c.target.state&&c.target.state.stop(),de(this._managedStates,c.target))}this._fadings.splice(r)}}}},{key:"crossFade",value:function(t,e){0===e&&this.clear();var i=this._managedStates.find(function(e){return e.state===t});i||(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){_(g(i.prototype),"onPlay",this).call(this),cc.director.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){_(g(i.prototype),"onPause",this).call(this),cc.director.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}}},{key:"onResume",value:function(){_(g(i.prototype),"onResume",this).call(this),cc.director.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}}},{key:"onStop",value:function(){_(g(i.prototype),"onStop",this).call(this),cc.director.getAnimationManager().removeCrossFade(this),this.clear()}}]),i}();(TM=wM=wM||q3("EventType",{})).PLAY="play",TM.STOP="stop",TM.PAUSE="pause",TM.RESUME="resume",TM.LASTFRAME="lastframe",TM.FINISHED="finished",mt(wM);var CM=q3("AnimationComponent",(cM=oo("cc.AnimationComponent"),hM=_o(99),dM=po("Components/Animation"),fM=lo({type:[NO]}),pM=lo({type:NO}),_M=lo({type:[NO]}),cM(vM=hM(vM=ho(vM=dM((SM=xM=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"playOnLoad",yM,l(t)),t._callbackTable=ke(!0),t._crossFade=new EM,t._nameToState=ke(!0),m(t,"_clips",gM,l(t)),m(t,"_defaultClip",bM,l(t)),t}return p(a,rp),v(a,[{key:"onLoad",value:function(){this.clips=this._clips;for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}}},{key:"start",value:function(){this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade.stop();for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=ke(!0)}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:.3,n=this._nameToState[e];n&&(this._crossFade.play(),this._crossFade.crossFade(n,i))}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return fe(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(t,e){for(var i,n=0,r=Object.keys(this._nameToState);n<r.length;n++){var a=r[n];if((i=this._nameToState[a]).clip===t)break}if(t===this._defaultClip){if(!e)return void B(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void B(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var n=Ml.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var r=0,a=Object.keys(this._nameToState);r<a.length;r++){var s=a[r];this._nameToState[s]._lastframeEventOn=!0}return n}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var n=this._nameToState,r=0,a=Object.keys(n);r<a.length;r++){n[a[r]]._lastframeEventOn=!1}Ml.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_createState",value:function(e,t){return new iM(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];OM(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s&&this._removeStateOfAutomaticClip(s)}var o=e,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;h&&this.createState(h)}var d=e.find(function(e){return OM(e,t._defaultClip)});this._defaultClip=d||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){(this._defaultClip=t)&&(0<=this._clips.findIndex(function(e){return OM(e,t)})||(this._clips.push(t),this.createState(t)))}}]),a}(),xM.EventType=wM,b((mM=SM).prototype,"clips",[fM],Object.getOwnPropertyDescriptor(mM.prototype,"clips"),mM.prototype),b(mM.prototype,"defaultClip",[pM],Object.getOwnPropertyDescriptor(mM.prototype,"defaultClip"),mM.prototype),yM=b(mM.prototype,"playOnLoad",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gM=b(mM.prototype,"_clips",[_M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bM=b(mM.prototype,"_defaultClip",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vM=mM))||vM)||vM)||vM)||vM)),AM=CM.prototype,kM=AM.on,RM=AM.off;function OM(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}Gh(CM,[Rl,Ml]),CM.prototype.on=kM,CM.prototype.off=RM,cc.AnimationComponent=CM;var MM=new zn;function IM(e,t){for(var i=e,n="";null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)}function LM(e,t,i){for(zn.identity(i);e!==t;)zn.fromRTS(MM,e.rotation,e.position,e.scale),zn.multiply(i,MM,i),e=e.parent}var zM=new zn;var BM,PM,DM,FM,NM,UM,VM,GM,HM,WM,qM,jM,XM,YM,KM,QM,ZM=q3("SkeletalAnimationState",function(){function n(){return y(this,n),x(this,g(n).apply(this,arguments))}return p(n,iM),v(n,[{key:"initialize",value:function(e){b_.getOrExtract(this.clip),_(g(n.prototype),"initialize",this).call(this,e)}},{key:"onPlay",value:function(){_(g(n.prototype),"onPlay",this).call(this);for(var e=this._targetNode.getComponentsInChildren(GR),t=0;t<e.length;++t){var i=e[t];i.skinningRoot===this._targetNode&&i.uploadAnimation(this.clip)}}},{key:"rebuildSocketCurves",value:function(e){if(this._samplerSharedGroups.length){for(var t,i=this._samplerSharedGroups[0].curves,n=0;n<i.length;n++){var r=i[n].curveDetail;3===(t=r.modifiers).length&&t[0]instanceof m_&&t[1]instanceof y_&&"frameID"===t[2]||i.splice(n--,1)}for(var a=0;a<e.length;++a){var s=this._buildSocketData(e[a]);s&&i.push(s)}}}},{key:"_buildSocketData",value:function(e){if(!this._targetNode)return null;var t=this._targetNode,i=t.getChildByPath(e.path);if(!i||!e.target)return null;for(var n=e.path,r=b_.getOrExtract(this.clip),a=n,s=r[a],o=i;!s||!s.props;){var l=a.lastIndexOf("/");if(s=r[a=a.substring(0,l)],o=o.parent,l<0)return null}var u={matrix:{keys:0,interpolate:!1,values:s.props.worldMatrix.values.map(function(e){return e.clone()})}},c=u.matrix.values;LM(i,o,zM);for(var h=0;h<c.length;h++){var d=c[h];zn.multiply(d,d,zM)}var f=this.clip.duration,p=new m_;return new QO({curve:new mO(u.matrix,f),modifiers:[p,"matrix"]},e.target)}}]),n}());cc.SkeletalAnimationState=ZM;var JM=q3("Socket",(BM=oo("cc.SkeletalAnimationComponent.Socket"),PM=lo(f_),BM((NM=b((FM=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;y(this,e),m(this,"path",NM,this),m(this,"target",UM,this),this.path=t,this.target=i}).prototype,"path",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),UM=b(FM.prototype,"target",[PM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DM=FM))||DM)),$M=new zn,eI=new zn;function tI(e,t,i){for(var n=1<arguments.length&&void 0!==t?t:"",r=2<arguments.length&&void 0!==i?i:[],a=0;a<e.children.length;a++){var s=e.children[a];if(s){var o=n?"".concat(n,"/").concat(s.name):s.name;r.push(o),tI(s,o,r)}}return r}var iI,nI,rI,aI,sI=q3("SkeletalAnimationComponent",(VM=oo("cc.SkeletalAnimationComponent"),GM=_o(99),HM=po("Components/SkeletalAnimation"),WM=lo({type:[JM]}),qM=lo({type:[JM]}),VM(jM=GM(jM=ho(jM=HM((QM=KM=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_sockets",YM,l(t)),t._animInfo=null,t}return p(a,CM),v(a,[{key:"onLoad",value:function(){_(g(a.prototype),"onLoad",this).call(this),this._animInfo=vv.create(this.node.uuid)}},{key:"onDestroy",value:function(){this._animInfo&&(vv.destroy(this.node.uuid),this._animInfo=null),_(g(a.prototype),"onDestroy",this).call(this)}},{key:"start",value:function(){_(g(a.prototype),"start",this).call(this),this.sockets=this._sockets}},{key:"querySockets",value:function(){var e=this._defaultClip&&Object.keys(b_.getOrExtract(this._defaultClip)).sort().reduce(function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e},[])||[];if(!e.length)return["default animation clip missing/invalid"];for(var t=[],i=0;i<e.length;i++){var n=e[i],r=this.node.getChildByPath(n);r&&(t.push(n),tI(r,n,t))}return t}},{key:"rebuildSocketAnimations",value:function(){var e=this._sockets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this.node.getChildByPath(r.path),s=r.target;a&&s&&(s.name="".concat(r.path.substring(r.path.lastIndexOf("/")+1)," Socket"),s.parent=this.node,LM(a,this.node,$M),zn.fromRTS(eI,s.rotation,s.position,s.scale),zn.equals(eI,$M)||(s.matrix=$M))}for(var o=0,l=Object.keys(this._nameToState);o<l.length;o++){var u=l[o];this._nameToState[u].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(t){var e=this._sockets.find(function(e){return e.path===t});if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new f_;return i.parent=this.node,this._sockets.push(new JM(t,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new ZM(e,t)}},{key:"_doCreateState",value:function(e,t){var i=_(g(a.prototype),"_doCreateState",this).call(this,e,t);return i.rebuildSocketCurves(this._sockets),i}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this.rebuildSocketAnimations()}},{key:"frameID",set:function(e){if(this._animInfo){var t=this._animInfo,i=t.data,n=t.buffer;i[1]=e,n.update(i)}},get:function(){return this._animInfo&&this._animInfo.data[1]||0}}]),a}(),KM.Socket=JM,YM=b((XM=QM).prototype,"_sockets",[WM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),b(XM.prototype,"sockets",[qM],Object.getOwnPropertyDescriptor(XM.prototype,"sockets"),XM.prototype),jM=XM))||jM)||jM)||jM)||jM));cc.SkeletalAnimationComponent=sI;var oI,lI=q3("UniformCurveValueAdapter",oo("cc.UniformCurveValueAdapter")((rI=b((nI=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"passIndex",rI,l(t)),m(t,"uniformName",aI,l(t)),t}return p(a,yO),v(a,[{key:"forTarget",value:function(e){var i=e.passes[this.passIndex],t=i.getHandle(this.uniformName);if(void 0===t)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var n=dm.getBindingTypeFromHandle(t);if(n===xc.UNIFORM_BUFFER)return function(e,t){var i=e.shaderInfo.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a.members,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;if(c.name===t)return 1<c.count}}return!1}(i,this.uniformName)?{set:function(e){i.setUniformArray(t,e)}}:{set:function(e){i.setUniform(t,e)}};if(n!==xc.SAMPLER)throw new Error("Animations are not avaiable for uniforms with binding type ".concat(n,"."));var r=dm.getBindingFromHandle(t),a=i.properties[this.uniformName],s=a&&a.value?a.value+"-texture":Bh[a.type],o=G_.get(s);return o||(console.warn("illegal texture default value: "+s),o=G_.get("default-texture")),{set:function(e){var t=(e=e||o).getGFXTextureView();t&&t.texture.width&&t.texture.height&&(i.bindTextureView(r,t),e instanceof Qd&&i.bindSampler(r,Yd.getSampler(cc.game._gfxDevice,e.getSamplerHash())))}}}}]),a}()).prototype,"passIndex",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aI=b(nI.prototype,"uniformName",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iI=nI))||iI);cc.UniformCurveValueAdapter=lI,sr(CM.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"removeClip",newName:"removeState",customFunction:function(e){var t=arguments.length<=0?void 0:e;return CM.prototype.removeState.call(this,t.name)}}]),cc.easing=mu;var uI,cI=oo("cc.Counter")(oI=function(){function n(e,t,i){y(this,n),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}return v(n,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),v(n,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e,i=this._opts.average?this._averageValue:this._value;return t?Math.round(100*i)/100:Math.round(i)}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var n=i;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}}}]),n}())||oI,hI=oo("cc.PerfCounter")(uI=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._time=void 0,n._time=i,n}return p(r,cI),v(r,[{key:"start",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._time=t}},{key:"end",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._value=t-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,(this._opts.average||1e3)<i&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),r}())||uI,dI="0123456789. ",fI=q3("Profiler",function(){function e(){y(this,e),this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._fontSize=24,this._lineHeight=this._fontSize+2,this._wordHeight=0,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._textureView=null,this._region=new jc,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._rowNumber=9,this._columnNumber=8,this._posWordWidth=.18,this._posBaseHeight=.18,this._posNumWidth=.09,this._eachNumWidth=0,this.lastTime=0,this._string2offset={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},this._uvOffset=[],this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new jc,this._canvasArr.push(this._canvas)}return v(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),qE.off(lE.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),qE.off(lE.EVENT_AFTER_UPDATE,this.afterUpdate,this),qE.off(lE.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),qE.off(lE.EVENT_AFTER_PHYSICS,this.afterPhysics,this),qE.off(lE.EVENT_BEFORE_DRAW,this.beforeDraw,this),qE.off(lE.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this.initDevice(),this.generateCanvas(),this.generateStats(),this._rootNode&&(this._rootNode.active=!0),qE.on(lE.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),qE.on(lE.EVENT_AFTER_UPDATE,this.afterUpdate,this),qE.on(lE.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),qE.on(lE.EVENT_AFTER_PHYSICS,this.afterPhysics,this),qE.on(lE.EVENT_BEFORE_DRAW,this.beforeDraw,this),qE.on(lE.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"initDevice",value:function(){this._device||(this._device=qE.root.device)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(this._fontSize,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:lc.TEX2D,usage:hc.SAMPLED,format:Ou.RGBA8,width:256,height:256,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:mc.TV2D,format:Ou.RGBA8}),this._region.texExtent.width=256,this._region.texExtent.height=256)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null,this._inited=!1;var e=performance.now(),t={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500},draws:{desc:"Draw call"},tricount:{desc:"Triangle"},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}};this._ctx.textAlign="left";var i=0;for(var n in t){var r=t[n];this._ctx.fillText(r.desc,0,i*this._lineHeight),r.counter=new hI(n,r,e),i++}this._wordHeight=i*this._lineHeight/this._canvas.height,this._eachNumWidth=this._ctx.measureText("0").width/this._canvas.width;for(var a=this._eachNumWidth*this._canvas.width,s=new Array,o=0,l=s[0]=0;l<dI.length;++l)this._ctx.fillText(dI[l],l*a,i*this._lineHeight),o+=this._eachNumWidth,s[l+1]=o;for(var u=Math.ceil(s.length/4),c=0;c<u;c++)this._uvOffset.push(new ji(s[4*c],s[4*c+1],s[4*c+2],s[4*c+3]));this._stats=t,this._canvasArr[0]=this._canvas,this.updateTexture(),this._inited=!0}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new f_("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new f_("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=xC.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=ah.BitMask.PROFILER,t.clearFlags=Nc.NONE,t.priority=4294967295;var i=new f_("Profiler_Root");i.parent=this._rootNode;for(var n,r=this._posNumWidth/this._columnNumber,a=this._posBaseHeight/this._rowNumber,s=[0,this._posBaseHeight,0,this._posBaseHeight,this._posBaseHeight,0,this._posWordWidth,0,0,0,0,0],o=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0;u<this._rowNumber;u++)for(var c=0;c<this._columnNumber;c++){s.push(this._posWordWidth+c*r,this._posBaseHeight-u*a,0),s.push(this._posWordWidth+(c+1)*r,this._posBaseHeight-u*a,0),s.push(this._posWordWidth+(c+1)*r,this._posBaseHeight-(u+1)*a,0),s.push(this._posWordWidth+c*r,this._posBaseHeight-(u+1)*a,0),n=4*(u*this._columnNumber+c+1),o.push(0+n,2+n,1+n,0+n,3+n,2+n);var h=u*this._columnNumber+c,d=Math.floor(h/4),f=h-4*d;l.push(0,this._wordHeight,d,f),l.push(this._eachNumWidth,this._wordHeight,d,f),l.push(this._eachNumWidth,1,d,f),l.push(0,1,d,f)}var p=i.addComponent("cc.ModelComponent");p.mesh=Tv({positions:s,indices:o,colors:l});var _=new fm;_.initialize({effectName:"util/profiler"}),_.setProperty("offset",new ji(-.9,-.9,0,0)),_.setProperty("symbols",this._uvOffset);var v=_.passes[0],m=v.getBinding("mainTexture");v.bindTextureView(m,this._textureView);var y=v.getBinding("digits");this.digitsData=v.blocks[y],p.material=_,p.node.layer=ah.Enum.PROFILER}}},{key:"beforeUpdate",value:function(){if(this._stats){this.generateNode();var e=performance.now();this.getCounter("frame").end(e),this.getCounter("frame").start(e),this.getCounter("logic").start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();qE.isPaused()?this.getCounter("frame").start(e):this.getCounter("logic").end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this.getCounter("render").start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this.getCounter("fps").frame(e),this.getCounter("render").end(e),!(e-this.lastTime<500)){this.lastTime=e;var t=this._device;this.getCounter("draws").value=t.numDrawCalls,this.getCounter("bufferMemory").value=t.memoryStatus.bufferSize/1048576,this.getCounter("textureMemory").value=t.memoryStatus.textureSize/1048576,this.getCounter("tricount").value=t.numTris;var i=0,n=this.digitsData.view;for(var r in this._stats){var a=this._stats[r];a.counter.sample(e);for(var s=a.counter.human(!("Framerate (FPS)"===a.desc)).toString(),o=this._columnNumber-1;0<=o;o--){var l=i*this._columnNumber+o,u=s[s.length-(this._columnNumber-o)],c=this._string2offset[u];void 0===c&&(c=11),n[l]=c}i++}this.digitsData.dirty=!0}}}},{key:"getCounter",value:function(e){return this._stats[e].counter}},{key:"updateTexture",value:function(){qE.root.device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}]),e}()),pI=q3("profiler",new fI);cc.profiler=pI;var _I={};sr(_I,"vmath",[{name:"vec2",newName:"Vec2",target:pr,targetName:"math"},{name:"vec3",newName:"Vec3",target:pr,targetName:"math"},{name:"vec4",newName:"Vec4",target:pr,targetName:"math"},{name:"quat",newName:"Quat",target:pr,targetName:"math"},{name:"mat3",newName:"Mat3",target:pr,targetName:"math"},{name:"mat4",newName:"Mat4",target:pr,targetName:"math"},{name:"color4",newName:"Color",target:pr,targetName:"math"},{name:"rect",newName:"Rect",target:pr,targetName:"math"},{name:"approx",newName:"approx",target:pr,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:pr,targetName:"math"},{name:"equals",newName:"equals",target:pr,targetName:"math"},{name:"clamp",newName:"clamp",target:pr,targetName:"math"},{name:"clamp01",newName:"clamp01",target:pr,targetName:"math"},{name:"lerp",newName:"lerp",target:pr,targetName:"math"},{name:"toRadian",newName:"toRadian",target:pr,targetName:"math"},{name:"toDegree",newName:"toDegree",target:pr,targetName:"math"},{name:"random",newName:"random",target:pr,targetName:"math"},{name:"randomRange",newName:"randomRange",target:pr,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:pr,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:pr,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:pr,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:pr,targetName:"math"},{name:"repeat",newName:"repeat",target:pr,targetName:"math"},{name:"pingPong",newName:"pingPong",target:pr,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:pr,targetName:"math"}]),cc.vmath=_I,sr(oE.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:oE,targetName:"Scheduler"}]),cc.math=pr,cc.geometry=Ds;var vI,mI,yI,gI,bI=0,xI={},SI=function(e){if(void 0===xI[e]){var t=1<<bI;xI[e]=t,bI+=1}};(mI=vI=vI||{})[mI.OPAQUE=0]="OPAQUE",mI[mI.TRANSPARENT=1]="TRANSPARENT",mI[mI.OVERLAY=2]="OVERLAY",(gI=yI=yI||{})[gI.DEFAULT=1]="DEFAULT",gI[gI.FORWARD=2]="FORWARD",gI[gI.SHADOWCAST=4]="SHADOWCAST",sr(IT.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),or(IT.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]);var wI={};or(wI,"CameraVisFlags",[{name:"GENERAL"}]),sr(wI,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:ah.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ah.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ah.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ah.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ah.BitMask,targetName:"UI_2D"}]),cc.CameraVisFlags=wI;var TI={};or(TI,"VisibilityFlags",[{name:"GENERAL"}]),sr(TI,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:ah.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:ah.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ah.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ah.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ah.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ah.Enum,targetName:"UI_2D"}]),cc.VisibilityFlags=TI;var EI=SI;cc.samplerLib=Yd;var CI=Object.freeze({addStage:EI,samplerLib:Yd,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:Cu.ATTR_POSITION,format:Ou.RGB32F}),t.normals&&a.push({name:Cu.ATTR_NORMAL,format:Ou.RGB32F}),t.uvs&&a.push({name:Cu.ATTR_TEX_COORD,format:Ou.RG32F}),t.colors&&a.push({name:Cu.ATTR_COLOR,format:Ou.RGB32F});var s=e.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:4*i.length,stride:4*i.length/n});s.update(new Float32Array(i));var o=e.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[s],indexBuffer:o})},get RenderQueue(){return vI},get PassStage(){return yI},Pass:dm,programLib:Vh,Light:cx,Camera:bS,Model:_v,SkinningModel:xv,TextureBufferPool:E_,get JointsMediumType(){return w_},selectJointsMediumType:A_,JointsTexturePool:N_});q3("renderer",CI);var AI,kI,RI,OI,MI,II,LI,zI,BI=q3("NodePool",function(){function t(e){y(this,t),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}return v(t,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),t}());cc.NodePool=BI,(zI=LI=LI||{})[zI.BOX=0]="BOX",zI[zI.SPHERE=1]="SPHERE",zI[zI.CYLINDER=2]="CYLINDER",zI[zI.CONE=3]="CONE",zI[zI.CAPSULE=4]="CAPSULE",zI[zI.TORUS=5]="TORUS",zI[zI.PLANE=6]="PLANE",zI[zI.QUAD=7]="QUAD",mt(LI);var PI=q3("Primitive",(AI=oo("cc.Primitive"),kI=lo({type:LI}),AI((MI=b((OI=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"type",MI,l(t)),m(t,"info",II,l(t)),t}return p(a,rv),v(a,[{key:"onLoaded",value:function(){Tv(mT[LI[this.type]](this.info),this)}}]),a}()).prototype,"type",[kI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LI.BOX}}),II=b(OI.prototype,"info",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),RI=OI))||RI));cc.Primitive=PI,cc.renderer=CI;q3("cclegacy",cc);cc.primitives=mT;var DI,FI,NI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.BINDING_LAYOUT)))._device=void 0,t._bindingUnits=[],t._isDirty=!1,t._device=e,t}return p(i,Vc),v(i,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===xc.UNIFORM_BUFFER?s.buffer!==t&&(s.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===xc.SAMPLER?s.sampler!==t&&(s.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===xc.SAMPLER?s.texView!==t&&(s.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.binding===e)return a}return null}}]),i}(),UI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBindingLayout=null,t}return p(i,NI),v(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),v(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.bindingType,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.bindingType,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=bu.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case xc.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case xc.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}();function VI(e,t){switch(e){case Ou.R8:return t.UNSIGNED_BYTE;case Ou.R8SN:return t.BYTE;case Ou.R8UI:return t.UNSIGNED_BYTE;case Ou.R8I:return t.BYTE;case Ou.R16F:return DI.HALF_FLOAT_OES;case Ou.R16UI:return t.UNSIGNED_SHORT;case Ou.R16I:return t.SHORT;case Ou.R32F:return t.FLOAT;case Ou.R32UI:return t.UNSIGNED_INT;case Ou.R32I:return t.INT;case Ou.RG8:return t.UNSIGNED_BYTE;case Ou.RG8SN:return t.BYTE;case Ou.RG8UI:return t.UNSIGNED_BYTE;case Ou.RG8I:return t.BYTE;case Ou.RG16F:return DI.HALF_FLOAT_OES;case Ou.RG16UI:return t.UNSIGNED_SHORT;case Ou.RG16I:return t.SHORT;case Ou.RG32F:return t.FLOAT;case Ou.RG32UI:return t.UNSIGNED_INT;case Ou.RG32I:return t.INT;case Ou.RGB8:case Ou.SRGB8:return t.UNSIGNED_BYTE;case Ou.RGB8SN:return t.BYTE;case Ou.RGB8UI:return t.UNSIGNED_BYTE;case Ou.RGB8I:return t.BYTE;case Ou.RGB16F:return DI.HALF_FLOAT_OES;case Ou.RGB16UI:return t.UNSIGNED_SHORT;case Ou.RGB16I:return t.SHORT;case Ou.RGB32F:return t.FLOAT;case Ou.RGB32UI:return t.UNSIGNED_INT;case Ou.RGB32I:return t.INT;case Ou.RGBA8:case Ou.SRGB8_A8:return t.UNSIGNED_BYTE;case Ou.RGBA8SN:return t.BYTE;case Ou.RGBA8UI:return t.UNSIGNED_BYTE;case Ou.RGBA8I:return t.BYTE;case Ou.RGBA16F:return DI.HALF_FLOAT_OES;case Ou.RGBA16UI:return t.UNSIGNED_SHORT;case Ou.RGBA16I:return t.SHORT;case Ou.RGBA32F:return t.FLOAT;case Ou.RGBA32UI:return t.UNSIGNED_INT;case Ou.RGBA32I:return t.INT;case Ou.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ou.R11G11B10F:return t.FLOAT;case Ou.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ou.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ou.RGB10A2:return t.UNSIGNED_BYTE;case Ou.RGB10A2UI:return t.UNSIGNED_INT;case Ou.RGB9E5:return t.UNSIGNED_BYTE;case Ou.D16:case Ou.D16S8:return t.UNSIGNED_SHORT;case Ou.D24:return t.UNSIGNED_INT;case Ou.D24S8:return DI.UNSIGNED_INT_24_8_WEBGL;case Ou.D32F:case Ou.D32F_S8:return t.FLOAT;case Ou.BC1:case Ou.BC1_SRGB:case Ou.BC2:case Ou.BC2_SRGB:case Ou.BC3:case Ou.BC3_SRGB:case Ou.BC4:return t.UNSIGNED_BYTE;case Ou.BC4_SNORM:return t.BYTE;case Ou.BC5:return t.UNSIGNED_BYTE;case Ou.BC5_SNORM:return t.BYTE;case Ou.BC6H_SF16:case Ou.BC6H_UF16:return t.FLOAT;case Ou.BC7:case Ou.BC7_SRGB:case Ou.ETC_RGB8:case Ou.ETC2_RGB8:case Ou.ETC2_SRGB8:case Ou.ETC2_RGB8_A1:case Ou.ETC2_SRGB8_A1:case Ou.ETC2_RGB8:case Ou.ETC2_SRGB8:case Ou.EAC_R11:return t.UNSIGNED_BYTE;case Ou.EAC_R11SN:return t.BYTE;case Ou.EAC_RG11:return t.UNSIGNED_BYTE;case Ou.EAC_RG11SN:return t.BYTE;case Ou.PVRTC_RGB2:case Ou.PVRTC_RGBA2:case Ou.PVRTC_RGB4:case Ou.PVRTC_RGBA4:case Ou.PVRTC2_2BPP:case Ou.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function GI(e,t){switch(e){case Ou.A8:return t.ALPHA;case Ou.L8:return t.LUMINANCE;case Ou.LA8:return t.LUMINANCE_ALPHA;case Ou.RGB8:case Ou.RGB16F:case Ou.RGB32F:return t.RGB;case Ou.RGBA8:case Ou.RGBA16F:case Ou.RGBA32F:return t.RGBA;case Ou.R5G6B5:return t.RGB565;case Ou.RGB5A1:return t.RGB5_A1;case Ou.RGBA4:return t.RGBA4;case Ou.D16:return t.DEPTH_COMPONENT;case Ou.D16S8:return t.DEPTH_STENCIL;case Ou.D24:return t.DEPTH_COMPONENT;case Ou.D24S8:return t.DEPTH_STENCIL;case Ou.D32F:return t.DEPTH_COMPONENT;case Ou.D32F_S8:return t.DEPTH_STENCIL;case Ou.BC1:return DI.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ou.BC1_ALPHA:return DI.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ou.BC1_SRGB:return DI.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ou.BC1_SRGB_ALPHA:return DI.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ou.BC2:return DI.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ou.BC2_SRGB:return DI.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ou.BC3:return DI.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ou.BC3_SRGB:return DI.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ou.ETC_RGB8:return DI.COMPRESSED_RGB_ETC1_WEBGL;case Ou.PVRTC_RGB2:return DI.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ou.PVRTC_RGBA2:return DI.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ou.PVRTC_RGB4:return DI.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ou.PVRTC_RGBA4:return DI.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function HI(e,t){switch(e){case Ou.A8:return t.ALPHA;case Ou.L8:return t.LUMINANCE;case Ou.LA8:return t.LUMINANCE_ALPHA;case Ou.RGB8:case Ou.RGB16F:case Ou.RGB32F:return t.RGB;case Ou.RGBA8:case Ou.RGBA16F:case Ou.RGBA32F:return t.RGBA;case Ou.R5G6B5:return t.RGB;case Ou.RGB5A1:case Ou.RGBA4:return t.RGBA;case Ou.D16:return t.DEPTH_COMPONENT;case Ou.D16S8:return t.DEPTH_STENCIL;case Ou.D24:return t.DEPTH_COMPONENT;case Ou.D24S8:return t.DEPTH_STENCIL;case Ou.D32F:return t.DEPTH_COMPONENT;case Ou.D32F_S8:return t.DEPTH_STENCIL;case Ou.BC1:return DI.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ou.BC1_ALPHA:return DI.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ou.BC1_SRGB:return DI.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ou.BC1_SRGB_ALPHA:return DI.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ou.BC2:return DI.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ou.BC2_SRGB:return DI.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ou.BC3:return DI.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ou.BC3_SRGB:return DI.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ou.ETC_RGB8:return DI.COMPRESSED_RGB_ETC1_WEBGL;case Ou.ETC2_RGB8:return DI.COMPRESSED_RGB8_ETC2;case Ou.ETC2_SRGB8:return DI.COMPRESSED_SRGB8_ETC2;case Ou.ETC2_RGB8_A1:return DI.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ou.ETC2_SRGB8_A1:return DI.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ou.ETC2_RGBA8:return DI.COMPRESSED_RGBA8_ETC2_EAC;case Ou.ETC2_SRGB8_A8:return DI.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ou.EAC_R11:return DI.COMPRESSED_R11_EAC;case Ou.EAC_R11SN:return DI.COMPRESSED_SIGNED_R11_EAC;case Ou.EAC_RG11:return DI.COMPRESSED_RG11_EAC;case Ou.EAC_RG11SN:return DI.COMPRESSED_SIGNED_RG11_EAC;case Ou.PVRTC_RGB2:return DI.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ou.PVRTC_RGBA2:return DI.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ou.PVRTC_RGB4:return DI.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ou.PVRTC_RGBA4:return DI.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function WI(e,t){switch(e){case ku.BOOL:return t.BOOL;case ku.BOOL2:return t.BOOL_VEC2;case ku.BOOL3:return t.BOOL_VEC3;case ku.BOOL4:return t.BOOL_VEC4;case ku.INT:return t.INT;case ku.INT2:return t.INT_VEC2;case ku.INT3:return t.INT_VEC3;case ku.INT4:return t.INT_VEC4;case ku.UINT:return t.UNSIGNED_INT;case ku.FLOAT:return t.FLOAT;case ku.FLOAT2:return t.FLOAT_VEC2;case ku.FLOAT3:return t.FLOAT_VEC3;case ku.FLOAT4:return t.FLOAT_VEC4;case ku.MAT2:return t.FLOAT_MAT2;case ku.MAT3:return t.FLOAT_MAT3;case ku.MAT4:return t.FLOAT_MAT4;case ku.SAMPLER2D:return t.SAMPLER_2D;case ku.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),ku.UNKNOWN}}function qI(e,t){switch(e){case t.BOOL:return ku.BOOL;case t.BOOL_VEC2:return ku.BOOL2;case t.BOOL_VEC3:return ku.BOOL3;case t.BOOL_VEC4:return ku.BOOL4;case t.INT:return ku.INT;case t.INT_VEC2:return ku.INT2;case t.INT_VEC3:return ku.INT3;case t.INT_VEC4:return ku.INT4;case t.UNSIGNED_INT:return ku.UINT;case t.FLOAT:return ku.FLOAT;case t.FLOAT_VEC2:return ku.FLOAT2;case t.FLOAT_VEC3:return ku.FLOAT3;case t.FLOAT_VEC4:return ku.FLOAT4;case t.FLOAT_MAT2:return ku.MAT2;case t.FLOAT_MAT3:return ku.MAT3;case t.FLOAT_MAT4:return ku.MAT4;case t.SAMPLER_2D:return ku.SAMPLER2D;case t.SAMPLER_CUBE:return ku.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),ku.UNKNOWN}}function jI(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function XI(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}(FI=DI=DI||{})[FI.RGBA16F_EXT=34842]="RGBA16F_EXT",FI[FI.RGB16F_EXT=34843]="RGB16F_EXT",FI[FI.RGBA32F_EXT=34836]="RGBA32F_EXT",FI[FI.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",FI[FI.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",FI[FI.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",FI[FI.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",FI[FI.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",FI[FI.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",FI[FI.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",FI[FI.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",FI[FI.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",FI[FI.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",FI[FI.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",FI[FI.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",FI[FI.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",FI[FI.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",FI[FI.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",FI[FI.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",FI[FI.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",FI[FI.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",FI[FI.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",FI[FI.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",FI[FI.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",FI[FI.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",FI[FI.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",FI[FI.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",FI[FI.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",FI[FI.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",FI[FI.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC";var YI,KI,QI=[512,513,514,515,516,517,518,519],ZI=[0,7680,7681,7682,7683,5386,34055,34056],JI=[32774,32778,32779,32774,32774],$I=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(KI=YI=YI||{})[KI.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",KI[KI.END_RENDER_PASS=1]="END_RENDER_PASS",KI[KI.BIND_STATES=2]="BIND_STATES",KI[KI.DRAW=3]="DRAW",KI[KI.UPDATE_BUFFER=4]="UPDATE_BUFFER",KI[KI.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",KI[KI.COUNT=6]="COUNT";function eL(e){y(this,eL),this.cmdType=void 0,this.refCount=0,this.cmdType=e}var tL=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,YI.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=Nc.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return p(t,eL),v(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),iL=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,YI.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return p(t,eL),v(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),nL=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,YI.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return p(t,eL),v(t,[{key:"clear",value:function(){}}]),t}(),rL=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,YI.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return p(t,eL),v(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),aL=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,YI.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return p(t,eL),v(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),sL=function(){function e(){y(this,e),this.cmds=new dw(1),this.beginRenderPassCmds=new dw(1),this.bindStatesCmds=new dw(1),this.drawCmds=new dw(1),this.updateBufferCmds=new dw(1),this.copyBufferToTextureCmds=new dw(1)}return v(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function oL(e,t,i,n,r){if(t.usage&Iu.UNIFORM)i instanceof Float32Array?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Iu.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r))}}var lL=new Array(YI.COUNT);function uL(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<YI.COUNT;++r)lL[r]=0;for(var a,s,o,l=null,u=null,c=!1,h=null,d=i.TRIANGLES,f=0;f<t.cmds.length;++f){var p=t.cmds.array[f],_=lL[p]++;switch(p){case YI.BEGIN_RENDER_PASS:var v=t.beginRenderPassCmds.array[_],m=0;if(v.gpuFramebuffer){n.glFramebuffer!==v.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,v.gpuFramebuffer.glFramebuffer),n.glFramebuffer=v.gpuFramebuffer.glFramebuffer),n.viewport.left===v.renderArea.x&&n.viewport.top===v.renderArea.y&&n.viewport.width===v.renderArea.width&&n.viewport.height===v.renderArea.height||(i.viewport(v.renderArea.x,v.renderArea.y,v.renderArea.width,v.renderArea.height),n.viewport.left=v.renderArea.x,n.viewport.top=v.renderArea.y,n.viewport.width=v.renderArea.width,n.viewport.height=v.renderArea.height),n.scissorRect.x===v.renderArea.x&&n.scissorRect.y===v.renderArea.y&&n.scissorRect.width===v.renderArea.width&&n.scissorRect.height===v.renderArea.height||(i.scissor(v.renderArea.x,v.renderArea.y,v.renderArea.width,v.renderArea.height),n.scissorRect.x=v.renderArea.x,n.scissorRect.y=v.renderArea.y,n.scissorRect.width=v.renderArea.width,n.scissorRect.height=v.renderArea.height);var y=v.gpuFramebuffer.gpuRenderPass,g=v.clearColors.length;e.WEBGL_draw_buffers||(g=1);for(var b=0;b<g;++b){var x=y.colorAttachments[b];if(x.format!==Ou.UNKNOWN)switch(x.loadOp){case Ec.LOAD:break;case Ec.CLEAR:if(v.clearFlag&Nc.COLOR){n.bs.targets[0].blendColorMask!==ic.ALL&&i.colorMask(!0,!0,!0,!0);var S=v.clearColors[0];i.clearColor(S.r,S.g,S.b,S.a),m|=i.COLOR_BUFFER_BIT}break;case Ec.DISCARD:}}if(y.depthStencilAttachment&&y.depthStencilAttachment.format!==Ou.UNKNOWN){switch(y.depthStencilAttachment.depthLoadOp){case Ec.LOAD:break;case Ec.CLEAR:v.clearFlag&Nc.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(v.clearDepth),m|=i.DEPTH_BUFFER_BIT);break;case Ec.DISCARD:}if(Xc[y.depthStencilAttachment.format].hasStencil)switch(y.depthStencilAttachment.stencilLoadOp){case Ec.LOAD:break;case Ec.CLEAR:v.clearFlag&Nc.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(v.clearStencil),m|=i.STENCIL_BUFFER_BIT);break;case Ec.DISCARD:}}if(m&&i.clear(m),m&i.COLOR_BUFFER_BIT){var w=n.bs.targets[0].blendColorMask;if(w!==ic.ALL){var T=(w&ic.R)!==ic.NONE,E=(w&ic.G)!==ic.NONE,C=(w&ic.B)!==ic.NONE,A=(w&ic.A)!==ic.NONE;i.colorMask(T,E,C,A)}}m&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),m&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case YI.BIND_STATES:var k=t.bindStatesCmds.array[_];if(c=!1,k.gpuPipelineState){if(l=k.gpuPipelineState,d=k.gpuPipelineState.glPrimitive,k.gpuPipelineState.gpuShader){var R=k.gpuPipelineState.gpuShader.glProgram;n.glProgram!==R&&(i.useProgram(R),n.glProgram=R,c=!0),u=k.gpuPipelineState.gpuShader}var O=k.gpuPipelineState.rs;if(O){if(n.rs.cullMode!==O.cullMode){switch(O.cullMode){case ju.NONE:i.disable(i.CULL_FACE);break;case ju.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case ju.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}n.rs.cullMode=O.cullMode}n.rs.isFrontFaceCCW!==O.isFrontFaceCCW&&(i.frontFace(O.isFrontFaceCCW?i.CCW:i.CW),n.rs.isFrontFaceCCW=O.isFrontFaceCCW),n.rs.depthBias===O.depthBias&&n.rs.depthBiasSlop===O.depthBiasSlop||(i.polygonOffset(O.depthBias,O.depthBiasSlop),n.rs.depthBias=O.depthBias,n.rs.depthBiasSlop=O.depthBiasSlop),n.rs.lineWidth!==O.lineWidth&&(i.lineWidth(O.lineWidth),n.rs.lineWidth=O.lineWidth)}var M=k.gpuPipelineState.dss;M&&(n.dss.depthTest!==M.depthTest&&(M.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=M.depthTest),n.dss.depthWrite!==M.depthWrite&&(i.depthMask(M.depthWrite),n.dss.depthWrite=M.depthWrite),n.dss.depthFunc!==M.depthFunc&&(i.depthFunc(QI[M.depthFunc]),n.dss.depthFunc=M.depthFunc),n.dss.stencilTestFront===M.stencilTestFront&&n.dss.stencilTestBack===M.stencilTestBack||(M.stencilTestFront||M.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=M.stencilTestFront,n.dss.stencilTestBack=M.stencilTestBack),n.dss.stencilFuncFront===M.stencilFuncFront&&n.dss.stencilRefFront===M.stencilRefFront&&n.dss.stencilReadMaskFront===M.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,QI[M.stencilFuncFront],M.stencilRefFront,M.stencilReadMaskFront),n.dss.stencilFuncFront=M.stencilFuncFront,n.dss.stencilRefFront=M.stencilRefFront,n.dss.stencilReadMaskFront=M.stencilReadMaskFront),n.dss.stencilFailOpFront===M.stencilFailOpFront&&n.dss.stencilZFailOpFront===M.stencilZFailOpFront&&n.dss.stencilPassOpFront===M.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,ZI[M.stencilFailOpFront],ZI[M.stencilZFailOpFront],ZI[M.stencilPassOpFront]),n.dss.stencilFailOpFront=M.stencilFailOpFront,n.dss.stencilZFailOpFront=M.stencilZFailOpFront,n.dss.stencilPassOpFront=M.stencilPassOpFront),n.dss.stencilWriteMaskFront!==M.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,M.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=M.stencilWriteMaskFront),n.dss.stencilFuncBack===M.stencilFuncBack&&n.dss.stencilRefBack===M.stencilRefBack&&n.dss.stencilReadMaskBack===M.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,QI[M.stencilFuncBack],M.stencilRefBack,M.stencilReadMaskBack),n.dss.stencilFuncBack=M.stencilFuncBack,n.dss.stencilRefBack=M.stencilRefBack,n.dss.stencilReadMaskBack=M.stencilReadMaskBack),n.dss.stencilFailOpBack===M.stencilFailOpBack&&n.dss.stencilZFailOpBack===M.stencilZFailOpBack&&n.dss.stencilPassOpBack===M.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,ZI[M.stencilFailOpBack],ZI[M.stencilZFailOpBack],ZI[M.stencilPassOpBack]),n.dss.stencilFailOpBack=M.stencilFailOpBack,n.dss.stencilZFailOpBack=M.stencilZFailOpBack,n.dss.stencilPassOpBack=M.stencilPassOpBack),n.dss.stencilWriteMaskBack!==M.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,M.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=M.stencilWriteMaskBack));var I=k.gpuPipelineState.bs;if(I){n.bs.isA2C!==I.isA2C&&(I.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=I.isA2C),n.bs.blendColor[0]===I.blendColor[0]&&n.bs.blendColor[1]===I.blendColor[1]&&n.bs.blendColor[2]===I.blendColor[2]&&n.bs.blendColor[3]===I.blendColor[3]||(i.blendColor(I.blendColor[0],I.blendColor[1],I.blendColor[2],I.blendColor[3]),n.bs.blendColor[0]=I.blendColor[0],n.bs.blendColor[1]=I.blendColor[1],n.bs.blendColor[2]=I.blendColor[2],n.bs.blendColor[3]=I.blendColor[3]);var L=I.targets[0],z=n.bs.targets[0];z.blend!==L.blend&&(L.blend?i.enable(i.BLEND):i.disable(i.BLEND),z.blend=L.blend),z.blendEq===L.blendEq&&z.blendAlphaEq===L.blendAlphaEq||(i.blendEquationSeparate(JI[L.blendEq],JI[L.blendAlphaEq]),z.blendEq=L.blendEq,z.blendAlphaEq=L.blendAlphaEq),z.blendSrc===L.blendSrc&&z.blendDst===L.blendDst&&z.blendSrcAlpha===L.blendSrcAlpha&&z.blendDstAlpha===L.blendDstAlpha||(i.blendFuncSeparate($I[L.blendSrc],$I[L.blendDst],$I[L.blendSrcAlpha],$I[L.blendDstAlpha]),z.blendSrc=L.blendSrc,z.blendDst=L.blendDst,z.blendSrcAlpha=L.blendSrcAlpha,z.blendDstAlpha=L.blendDstAlpha),z.blendColorMask!==L.blendColorMask&&(i.colorMask((L.blendColorMask&ic.R)!==ic.NONE,(L.blendColorMask&ic.G)!==ic.NONE,(L.blendColorMask&ic.B)!==ic.NONE,(L.blendColorMask&ic.A)!==ic.NONE),z.blendColorMask=L.blendColorMask)}}if(k.gpuBindingLayout&&u)for(var B=k.gpuBindingLayout.gpuBindings.length,P=0;P<B;P++){var D=k.gpuBindingLayout.gpuBindings[P];switch(D.type){case xc.UNIFORM_BUFFER:if(D.gpuBuffer&&D.gpuBuffer.buffer){for(var F=null,N=u.glBlocks.length,U=0;U<N;U++){var V=u.glBlocks[U];if(V.binding===D.binding){F=V;break}}if(F&&D.gpuBuffer.vf32)for(var G=F.glActiveUniforms.length,H=0;H<G;H++){var W=F.glActiveUniforms[H];switch(W.glType){case i.BOOL:case i.INT:for(var q=0;q<W.array.length;++q){var j=W.begin+q;if(D.gpuBuffer.vf32[j]!==W.array[q]){for(var X=q,Y=W.begin+q;X<W.array.length;++X,++Y)W.array[X]=D.gpuBuffer.vf32[Y];i.uniform1iv(W.glLoc,W.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var K=0;K<W.array.length;++K){var Q=W.begin+K;if(D.gpuBuffer.vf32[Q]!==W.array[K]){for(var Z=K,J=W.begin+K;Z<W.array.length;++Z,++J)W.array[Z]=D.gpuBuffer.vf32[J];i.uniform2iv(W.glLoc,W.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var $=0;$<W.array.length;++$){var ee=W.begin+$;if(D.gpuBuffer.vf32[ee]!==W.array[$]){for(var te=$,ie=W.begin+$;te<W.array.length;++te,++ie)W.array[te]=D.gpuBuffer.vf32[ie];i.uniform3iv(W.glLoc,W.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var ne=0;ne<W.array.length;++ne){var re=W.begin+ne;if(D.gpuBuffer.vf32[re]!==W.array[ne]){for(var ae=ne,se=W.begin+ne;ae<W.array.length;++ae,++se)W.array[ae]=D.gpuBuffer.vf32[se];i.uniform4iv(W.glLoc,W.array);break}}break;case i.FLOAT:for(var oe=0;oe<W.array.length;++oe){var le=W.begin+oe;if(D.gpuBuffer.vf32[le]!==W.array[oe]){for(var ue=oe,ce=W.begin+oe;ue<W.array.length;++ue,++ce)W.array[ue]=D.gpuBuffer.vf32[ce];i.uniform1fv(W.glLoc,W.array);break}}break;case i.FLOAT_VEC2:for(var he=0;he<W.array.length;++he){var de=W.begin+he;if(D.gpuBuffer.vf32[de]!==W.array[he]){for(var fe=he,pe=W.begin+he;fe<W.array.length;++fe,++pe)W.array[fe]=D.gpuBuffer.vf32[pe];i.uniform2fv(W.glLoc,W.array);break}}break;case i.FLOAT_VEC3:for(var _e=0;_e<W.array.length;++_e){var ve=W.begin+_e;if(D.gpuBuffer.vf32[ve]!==W.array[_e]){for(var me=_e,ye=W.begin+_e;me<W.array.length;++me,++ye)W.array[me]=D.gpuBuffer.vf32[ye];i.uniform3fv(W.glLoc,W.array);break}}break;case i.FLOAT_VEC4:for(var ge=0;ge<W.array.length;++ge){var be=W.begin+ge;if(D.gpuBuffer.vf32[be]!==W.array[ge]){for(var xe=ge,Se=W.begin+ge;xe<W.array.length;++xe,++Se)W.array[xe]=D.gpuBuffer.vf32[Se];i.uniform4fv(W.glLoc,W.array);break}}break;case i.FLOAT_MAT2:for(var we=0;we<W.array.length;++we){var Te=W.begin+we;if(D.gpuBuffer.vf32[Te]!==W.array[we]){for(var Ee=we,Ce=W.begin+we;Ee<W.array.length;++Ee,++Ce)W.array[Ee]=D.gpuBuffer.vf32[Ce];i.uniformMatrix2fv(W.glLoc,!1,W.array);break}}break;case i.FLOAT_MAT3:for(var Ae=0;Ae<W.array.length;++Ae){var ke=W.begin+Ae;if(D.gpuBuffer.vf32[ke]!==W.array[Ae]){for(var Re=Ae,Oe=W.begin+Ae;Re<W.array.length;++Re,++Oe)W.array[Re]=D.gpuBuffer.vf32[Oe];i.uniformMatrix3fv(W.glLoc,!1,W.array);break}}break;case i.FLOAT_MAT4:for(var Me=0;Me<W.array.length;++Me){var Ie=W.begin+Me;if(D.gpuBuffer.vf32[Ie]!==W.array[Me]){for(var Le=Me,ze=W.begin+Me;Le<W.array.length;++Le,++ze)W.array[Le]=D.gpuBuffer.vf32[ze];i.uniformMatrix4fv(W.glLoc,!1,W.array);break}}}}}break;case xc.SAMPLER:if(D.gpuSampler){for(var Be=null,Pe=u.glSamplers.length,De=0;De<Pe;De++){var Fe=u.glSamplers[De];if(Fe.binding===D.binding){Be=Fe;break}}if(Be)for(var Ne=Be.units.length,Ue=0;Ue<Ne;Ue++){var Ve=Be.units[Ue];if(D.gpuTexView&&0<D.gpuTexView.gpuTexture.size){var Ge=D.gpuTexView.gpuTexture,He=n.glTexUnits[Ve];He.glTexture!==Ge.glTexture&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),Ge.glTexture?i.bindTexture(Ge.glTarget,Ge.glTexture):i.bindTexture(Ge.glTarget,e.nullTex2D.gpuTexture.glTexture),He.glTexture=Ge.glTexture);var We=D.gpuSampler;s=Ge.isPowerOf2?(a=We.glWrapS,We.glWrapT):(a=i.CLAMP_TO_EDGE,i.CLAMP_TO_EDGE),o=Ge.isPowerOf2?Ge.mipLevel<=1&&(We.glMinFilter===i.LINEAR_MIPMAP_NEAREST||We.glMinFilter===i.LINEAR_MIPMAP_LINEAR)?i.LINEAR:We.glMinFilter:We.glMinFilter===i.LINEAR||We.glMinFilter===i.LINEAR_MIPMAP_NEAREST||We.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,Ge.glWrapS!==a&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_WRAP_S,a),Ge.glWrapS=a),Ge.glWrapT!==s&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_WRAP_T,s),Ge.glWrapT=s),Ge.glMinFilter!==o&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_MIN_FILTER,o),Ge.glMinFilter=o),Ge.glMagFilter!==We.glMagFilter&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_MAG_FILTER,We.glMagFilter),Ge.glMagFilter=We.glMagFilter)}}}else console.error("Not found sampler on binding unit "+D.binding)}}if(k.gpuInputAssembler&&u&&(c||h!==k.gpuInputAssembler))if(h=k.gpuInputAssembler,e.useVAO){var qe=e.OES_vertex_array_object,je=e.ANGLE_instanced_arrays,Xe=h.glVAOs.get(u.glProgram);if(!Xe){Xe=qe.createVertexArrayOES(),h.glVAOs.set(u.glProgram,Xe),qe.bindVertexArrayOES(Xe),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(var Ye=void 0,Ke=u.glInputs.length,Qe=0;Qe<Ke;Qe++){var Ze=u.glInputs[Qe];Ye=null;for(var Je=h.glAttribs.length,$e=0;$e<Je;$e++){var et=h.glAttribs[$e];if(et.name===Ze.name){Ye=et;break}}if(Ye){i.bindBuffer(i.ARRAY_BUFFER,Ye.glBuffer);for(var tt=0;tt<Ye.componentCount;++tt){var it=Ze.glLoc+tt,nt=Ye.offset+Ye.size*tt;i.enableVertexAttribArray(it),n.glCurrentAttribLocs[it]=!0,i.vertexAttribPointer(it,Ye.count,Ye.glType,Ye.isNormalized,Ye.stride,nt),je&&je.vertexAttribDivisorANGLE(it,Ye.isInstanced?1:0)}}}var rt=h.gpuIndexBuffer;rt&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,rt.glBuffer),qe.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==Xe&&(qe.bindVertexArrayOES(Xe),n.glVAO=Xe)}else{for(var at=0;at<e.maxVertexAttributes;++at)n.glCurrentAttribLocs[at]=!1;for(var st=u.glInputs.length,ot=0;ot<st;ot++){for(var lt=u.glInputs[ot],ut=null,ct=h.glAttribs.length,ht=0;ht<ct;ht++){var dt=h.glAttribs[ht];if(dt.name===lt.name){ut=dt;break}}if(ut){n.glArrayBuffer!==ut.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,ut.glBuffer),n.glArrayBuffer=ut.glBuffer);for(var ft=0;ft<ut.componentCount;++ft){var pt=lt.glLoc+ft,_t=ut.offset+ut.size*ft;!n.glEnabledAttribLocs[pt]&&0<=pt&&(i.enableVertexAttribArray(pt),n.glEnabledAttribLocs[pt]=!0),n.glCurrentAttribLocs[pt]=!0,i.vertexAttribPointer(pt,ut.count,ut.glType,ut.isNormalized,ut.stride,_t)}}}var vt=h.gpuIndexBuffer;vt&&n.glElementArrayBuffer!==vt.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,vt.glBuffer),n.glElementArrayBuffer=vt.glBuffer);for(var mt=0;mt<e.maxVertexAttributes;++mt)n.glEnabledAttribLocs[mt]!==n.glCurrentAttribLocs[mt]&&(i.disableVertexAttribArray(mt),n.glEnabledAttribLocs[mt]=!1)}if(l)for(var yt=l.dynamicStates.length,gt=0;gt<yt;gt++){switch(l.dynamicStates[gt]){case Lc.VIEWPORT:k.viewport&&(n.viewport.left===k.viewport.left&&n.viewport.top===k.viewport.top&&n.viewport.width===k.viewport.width&&n.viewport.height===k.viewport.height||(i.viewport(k.viewport.left,k.viewport.top,k.viewport.width,k.viewport.height),n.viewport.left=k.viewport.left,n.viewport.top=k.viewport.top,n.viewport.width=k.viewport.width,n.viewport.height=k.viewport.height));break;case Lc.SCISSOR:k.scissor&&(n.scissorRect.x===k.scissor.x&&n.scissorRect.y===k.scissor.y&&n.scissorRect.width===k.scissor.width&&n.scissorRect.height===k.scissor.height||(i.scissor(k.scissor.x,k.scissor.y,k.scissor.width,k.scissor.height),n.scissorRect.x=k.scissor.x,n.scissorRect.y=k.scissor.y,n.scissorRect.width=k.scissor.width,n.scissorRect.height=k.scissor.height));break;case Lc.LINE_WIDTH:k.lineWidth&&n.rs.lineWidth!==k.lineWidth&&(i.lineWidth(k.lineWidth),n.rs.lineWidth=k.lineWidth);break;case Lc.DEPTH_BIAS:k.depthBias&&(n.rs.depthBias===k.depthBias.constantFactor&&n.rs.depthBiasSlop===k.depthBias.slopeFactor||(i.polygonOffset(k.depthBias.constantFactor,k.depthBias.slopeFactor),n.rs.depthBias=k.depthBias.constantFactor,n.rs.depthBiasSlop=k.depthBias.slopeFactor));break;case Lc.BLEND_CONSTANTS:k.blendConstants&&(n.bs.blendColor[0]===k.blendConstants[0]&&n.bs.blendColor[1]===k.blendConstants[1]&&n.bs.blendColor[2]===k.blendConstants[2]&&n.bs.blendColor[3]===k.blendConstants[3]||(i.blendColor(k.blendConstants[0],k.blendConstants[1],k.blendConstants[2],k.blendConstants[3]),n.bs.blendColor[0]=k.blendConstants[0],n.bs.blendColor[1]=k.blendConstants[1],n.bs.blendColor[2]=k.blendConstants[2],n.bs.blendColor[3]=k.blendConstants[3]));break;case Lc.STENCIL_WRITE_MASK:if(k.stencilWriteMask)switch(k.stencilWriteMask.face){case Bc.FRONT:n.dss.stencilWriteMaskFront!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask);break;case Bc.BACK:n.dss.stencilWriteMaskBack!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask);break;case Bc.ALL:n.dss.stencilWriteMaskFront===k.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===k.stencilWriteMask.writeMask||(i.stencilMask(k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask)}break;case Lc.STENCIL_COMPARE_MASK:if(k.stencilCompareMask)switch(k.stencilCompareMask.face){case Bc.FRONT:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,QI[n.dss.stencilFuncFront],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask);break;case Bc.BACK:n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,QI[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask);break;case Bc.ALL:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask&&n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFunc(QI[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask,n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask)}}}break;case YI.DRAW:var bt=t.drawCmds.array[_];if(h&&u)if(h.gpuIndirectBuffer){if(h.gpuIndirectBuffer)for(var xt=h.gpuIndirectBuffer.indirects.length,St=0;St<xt;St++){var wt=h.gpuIndirectBuffer.indirects[St],Tt=h.gpuIndexBuffer;if(Tt&&-1<wt.indexCount){var Et=wt.firstIndex*Tt.stride;i.drawElements(d,wt.indexCount,h.glIndexType,Et)}else i.drawArrays(d,wt.firstVertex,wt.vertexCount)}}else{var Ct=h.gpuIndexBuffer;if(Ct&&-1<bt.drawInfo.indexCount){var At=bt.drawInfo.firstIndex*Ct.stride;i.drawElements(d,bt.drawInfo.indexCount,h.glIndexType,At)}else i.drawArrays(d,bt.drawInfo.firstVertex,bt.drawInfo.vertexCount)}break;case YI.UPDATE_BUFFER:var kt=t.updateBufferCmds.array[_];oL(e,kt.gpuBuffer,kt.buffer,kt.offset,kt.size);break;case YI.COPY_BUFFER_TO_TEXTURE:var Rt=t.copyBufferToTextureCmds.array[_];cL(e,[Rt.gpuBuffer.buffer],Rt.gpuTexture,Rt.regions)}}}function cL(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=1,u=1,c=0,h=Xc[i.format],d=h.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var f=n,p=Array.isArray(f),_=0;for(f=p?f:f[Symbol.iterator]();;){var v;if(p){if(_>=f.length)break;v=f[_++]}else{if((_=f.next()).done)break;v=_.value}var m=v;for(l=m.texExtent.width,u=m.texExtent.height,s=m.texSubres.baseMipLevel;s<m.texSubres.levelCount;++s){var y=h.type!==Gc.FLOAT||d?new Uint8Array(t[o++]):new Float32Array(t[o++]);d?i.glInternelFmt!==DI.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,s,i.glInternelFmt,l,u,0,y):r.texSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,i.glType,y),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=n,b=Array.isArray(g),x=0;for(g=b?g:g[Symbol.iterator]();;){var S;if(b){if(x>=g.length)break;S=g[x++]}else{if((x=g.next()).done)break;S=x.value}var w=S;o=0;var T=w.texSubres.baseArrayLayer+w.texSubres.layerCount;for(c=w.texSubres.baseArrayLayer;c<T;++c){l=w.texExtent.width,u=w.texExtent.height;var E=w.texSubres.baseMipLevel+w.texSubres.levelCount;for(s=w.texSubres.baseMipLevel;s<E;++s){var C=h.type!==Gc.FLOAT||d?new Uint8Array(t[o++]):new Float32Array(t[o++]);d?i.glInternelFmt!==DI.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,w.texOffset.x,w.texOffset.y,l,u,i.glFormat,C):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,i.glInternelFmt,l,u,0,C):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,w.texOffset.x,w.texOffset.y,l,u,i.glFormat,i.glType,C),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&_c.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}function hL(){y(this,hL),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(wu),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new W_,this.dss=new q_,this.bs=new D_,this.glEnabledAttribLocs=new Array(Su),this.glCurrentAttribLocs=new Array(Su),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var e=0;e<wu;++e)this.glTexUnits[e]={glTexture:null}}var dL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBuffer=null,t._uniformBuffer=null,t._indirectBuffer=null,t}return p(i,Y_),v(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),v(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:Pu.NONE,this._usage&Iu.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&Iu.UNIFORM&&0<this._size&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._flags&Pu.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&Iu.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&Iu.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&zu.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Iu.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Iu.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Iu.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer))):(t.usage&Iu.INDIRECT||t.usage&Iu.TRANSFER_DST||t.usage&Iu.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBuffer&&(function(e,t){t.glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=bu.UNREADY}},{key:"resize",value:function(e){var t=this._size;if(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._bufferView&&t!==e){var i=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(i),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView.buffer)}this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,0<this._size&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&zu.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&Iu.VERTEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Iu.INDEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Iu.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer)):(t.usage&Iu.INDIRECT||t.usage&Iu.TRANSFER_DST||t.usage&Iu.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&Iu.INDIRECT?0:e.byteLength,this._bufferView&&e!==this._bufferView.buffer){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}oL(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),fL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.COMMAND_ALLOCATOR)))._device=void 0,t._device=e,t}return p(i,Vc),i}(),pL=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new dw(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return v(n,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,s=0;a<t;++a,++s)this._frees[a]=i[s];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),_L=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new pL(tL,1),t.bindStatesCmdPool=new pL(iL,1),t.drawCmdPool=new pL(nL,1),t.updateBufferCmdPool=new pL(rL,1),t.copyBufferToTextureCmdPool=new pL(aL,1),t}return p(i,fL),v(i,[{key:"initialize",value:function(e){return this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._status=bu.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),vL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).cmdPackage=new sL,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return p(i,K_),v(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=bu.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=bu.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(tL);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i,s.clearColors.length=n.length;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(YI.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===wc.PRIMARY&&this._isInRenderPass||this._type===wc.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(nL);e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(YI.DRAW),++this._numDrawCalls;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===wc.PRIMARY&&!this._isInRenderPass||this._type===wc.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(rL);if(a){var s;s=void 0!==n?n:e.usage&Iu.INDIRECT?0:t.byteLength;var o=t;a.gpuBuffer=r,a.buffer=o,a.offset=void 0!==i?i:0,a.size=s,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(YI.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===wc.PRIMARY&&!this._isInRenderPass||this._type===wc.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(aL);s&&(s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(YI.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var u=n.cmdPackage.drawCmds.array[l];++u.refCount,this.cmdPackage.drawCmds.push(u)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var h=n.cmdPackage.updateBufferCmds.array[c];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var d=0;d<n.cmdPackage.copyBufferToTextureCmds.length;++d){var f=n.cmdPackage.copyBufferToTextureCmds.array[d];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(iL);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(YI.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),mL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuFramebuffer=null,t}return p(i,Q_),v(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),v(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=Xc[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:!1,glFramebuffer:null};return this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._isOffscreen&&this._gpuFramebuffer&&function(e,t){t.glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)}(this._device,this._gpuFramebuffer),this._gpuFramebuffer=null,this._status=bu.UNREADY}}]),i}(),yL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuInputAssembler=null,t}return p(i,Uv),v(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),v(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=VI(a.format,i),u=Xc[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:u,count:Xc[a.format].count,stride:o.stride,componentCount:XI(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=u}}(this._device,this._gpuInputAssembler),this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.OES_vertex_array_object.deleteVertexArrayOES(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=bu.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),gL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineLayout=null,t}return p(i,Vv),v(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),v(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._status=bu.UNREADY}}]),i}(),bL=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],xL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineState=null,t}return p(i,X_),v(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),v(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.inputState,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._dynamicStates=e.dynamicStates||[],this._hash=e.hash,this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:bL[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=bu.UNREADY}}]),i}(),SL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return p(i,Gv),v(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._status=bu.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,n=0;n<i;n++){var r=e[n];uL(this._device,r.cmdPackage),this.numDrawCalls+=r.numDrawCalls,this.numTris+=r.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),wL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuRenderPass=null,t}return p(i,Hv),v(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),v(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=bu.UNREADY}}]),i}(),TL=[10497,33648,33071,33071],EL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuSampler=null,t._state=new Wv,t}return p(i,qv),v(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),v(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===rc.LINEAR||n===rc.ANISOTROPIC?a===rc.LINEAR||a===rc.ANISOTROPIC?9987:a===rc.POINT?9985:9729:a===rc.LINEAR||a===rc.ANISOTROPIC?9986:a===rc.POINT?9984:9728,i=r===rc.LINEAR||r===rc.ANISOTROPIC?9729:9728;var s=TL[this._state.addressU],o=TL[this._state.addressV],l=TL[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:s,glWrapT:o,glWrapR:l},this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=bu.UNREADY}}]),i}(),CL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuShader=null,t}return p(i,jv),v(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),v(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){function t(){if(l){if(u>=o.length)return"break";c=o[u++]}else{if((u=o.next()).done)return"break";c=u.value}var e=c,t=0,i="",n=1;switch(e.type){case gc.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case gc.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);if(r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),!s.getShaderParameter(e.glShader,s.COMPILE_STATUS)))return console.error(i+" in '"+a.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null,{v:void 0}}var s=e.gl,o=a.gpuStages,l=Array.isArray(o),u=0;e:for(o=l?o:o[Symbol.iterator]();;){var c,i=t();switch(i){case"break":break e;default:if("object"===_e(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),d=0;for(r=h?r:r[Symbol.iterator]();;){var f;if(h){if(d>=r.length)break;f=r[d++]}else{if((d=r.next()).done)break;f=d.value}var p=f;s.attachShader(a.glProgram,p.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS)){console.info("Shader '"+a.name+"' compilation successed.");var _=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(_);for(var v=0;v<_;++v){var m=s.getActiveAttrib(a.glProgram,v);if(m){var y=void 0,g=m.name.indexOf("[");y=-1!==g?m.name.substr(0,g):m.name;var b=s.getAttribLocation(a.glProgram,y),x=qI(m.type,s),S=jI(m.type,s);a.glInputs[v]={binding:b,name:y,type:x,stride:S,count:m.size,size:S*m.size,glType:m.type,glLoc:b}}}if(0<a.blocks.length){a.glBlocks=new Array(a.blocks.length);for(var w=0;w<a.blocks.length;++w){var T=a.blocks[w],E={binding:T.binding,name:T.name,size:0,glUniforms:new Array(T.members.length),glActiveUniforms:[],isUniformPackage:!0};a.glBlocks[w]=E;for(var C=0;C<T.members.length;++C){var A=T.members[C],k=WI(A.type,s),R=jI(k,s),O=R*A.count,M=E.size/4,I=new Array(O/4);I.fill(0),E.glUniforms[C]={binding:-1,name:A.name,type:A.type,stride:R,count:A.count,size:O,offset:E.size,glType:k,glLoc:-1,array:I,begin:M},E.size+=O}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var L=0;L<a.samplers.length;++L){var z=a.samplers[L];a.glSamplers[L]={binding:z.binding,name:z.name,type:z.type,units:[],glType:WI(z.type,s),glLoc:-1}}}for(var B=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),P=0,D=[],F=0;F<B;++F){var N=s.getActiveUniform(a.glProgram,F);if(N){var U=s.getUniformLocation(a.glProgram,N.name);if(U){var V=void 0,G=N.name.indexOf("[");if(V=-1!==G?N.name.substr(0,G):N.name,N.type===s.SAMPLER_2D||N.type===s.SAMPLER_CUBE){var H=a.glSamplers,W=Array.isArray(H),q=0;for(H=W?H:H[Symbol.iterator]();;){var j;if(W){if(q>=H.length)break;j=H[q++]}else{if((q=H.next()).done)break;j=q.value}var X=j;if(X.name===V){for(var Y=0;Y<N.size;++Y)X.units.push(P+Y);X.glLoc=U,P+=N.size,D.push(X);break}}}else{var K=a.glBlocks,Q=Array.isArray(K),Z=0;for(K=Q?K:K[Symbol.iterator]();;){var J;if(Q){if(Z>=K.length)break;J=K[Z++]}else{if((Z=K.next()).done)break;J=Z.value}var $=J,ee=$.glUniforms,te=Array.isArray(ee),ie=0;for(ee=te?ee:ee[Symbol.iterator]();;){var ne;if(te){if(ie>=ee.length)break;ne=ee[ie++]}else{if((ie=ee.next()).done)break;ne=ie.value}var re=ne;if(re.name===V){re.glLoc=U,$.glActiveUniforms.push(re);break}}}}}}}if(D.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);var ae=D,se=Array.isArray(ae),oe=0;for(ae=se?ae:ae[Symbol.iterator]();;){var le;if(se){if(oe>=ae.length)break;le=ae[oe++]}else{if((oe=ae.next()).done)break;le=oe.value}var ue=le;s.uniform1iv(ue.glLoc,ue.units)}}}else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var ce=a.gpuStages,he=Array.isArray(ce),de=0;for(ce=he?ce:ce[Symbol.iterator]();;){var fe;if(he){if(de>=ce.length)break;fe=ce[de++]}else{if((de=ce.next()).done)break;fe=de.value}var pe=fe;pe.glShader&&(s.deleteShader(pe.glShader),pe.glShader=null)}}}}(this._device,this._gpuShader),this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=bu.UNREADY}}]),i}();function AL(e){return 0<e&&0==(e&e-1)}var kL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTexture=null,t}return p(i,Xv),v(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),v(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=AL(this._width)&&AL(this._height),this._size=Kc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&_c.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case lc.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?mc.TV1D:mc.TV1D_ARRAY:mc.TV1D;break;case lc.TEX2D:var i=_c.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?mc.TV2D:i&_c.CUBEMAP?mc.CUBE:mc.TV2D_ARRAY:mc.TV2D;break;case lc.TEX3D:t=mc.TV3D;break;default:t=mc.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternelFmt=GI(t.format,i),t.glFormat=HI(t.format,i),t.glType=VI(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case mc.TV2D:t.viewType=mc.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&D(9100,a,e.maxTextureSize),t.samples===fc.X1){var s=i.createTexture();if(s&&0<t.size){t.glTexture=s;var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),Xc[t.format].isCompressed)if(t.glInternelFmt!==DI.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var u=Yc(t.format,n,r,1),c=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,l,t.glInternelFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=Yc(t.format,2,2,1),d=new Uint8Array(h);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,d)}else for(var f=0;f<t.mipLevel;++f)i.texImage2D(i.TEXTURE_2D,f,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case mc.CUBE:t.viewType=mc.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var p=Math.max(n,r);p>e.maxCubeMapTextureSize&&D(9100,p,e.maxTextureSize);var _=i.createTexture();if(_&&0<t.size){t.glTexture=_;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),Xc[t.format].isCompressed)if(t.glInternelFmt!==DI.COMPRESSED_RGB_ETC1_WEBGL)for(var m=0;m<6;++m){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var g=Yc(t.format,n,r,1),b=new Uint8Array(g);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+m,y,t.glInternelFmt,n,r,0,b),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var x=0;x<6;++x){var S=Yc(t.format,2,2,1),w=new Uint8Array(S);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,t.glInternelFmt,2,2,0,w)}else for(var T=0;T<6;++T){n=t.width,r=t.height;for(var E=0;E<t.mipLevel;++E)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,E,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=mc.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTexture&&(function(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=bu.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Kc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternelFmt=GI(t.format,i),t.glFormat=HI(t.format,i),t.glType=VI(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case mc.TV2D:t.viewType=mc.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&D(9100,a,e.maxTextureSize),t.samples===fc.X1){var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),Xc[t.format].isCompressed){if(t.glInternelFmt!==DI.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=Yc(t.format,n,r,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case mc.CUBE:t.viewType=mc.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);h>e.maxCubeMapTextureSize&&D(9100,h,e.maxTextureSize);var d=e.stateCache.glTexUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),d.glTexture=t.glTexture),Xc[t.format].isCompressed){if(t.glInternelFmt!==DI.COMPRESSED_RGB_ETC1_WEBGL)for(var f=0;f<6;++f){n=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var _=Yc(t.format,n,r,1),v=new Uint8Array(_);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternelFmt,n,r,0,v),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var m=0;m<6;++m){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+m,y,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=mc.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=bu.UNREADY}}]),i}(),RL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTextureView=null,t}return p(i,H_),v(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),v(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=bu.UNREADY}}]),i}(),OL=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,yu.WINDOW)))._device=void 0,t._title="",t._left=0,t._top=0,t._width=0,t._height=0,t._nativeWidth=0,t._nativeHeight=0,t._colorFmt=Ou.UNKNOWN,t._depthStencilFmt=Ou.UNKNOWN,t._isOffscreen=!1,t._renderPass=null,t._colorTex=null,t._colorTexView=null,t._depthStencilTex=null,t._depthStencilTexView=null,t._framebuffer=null,t._device=e,t}return p(i,Vc),v(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),i}(),ML=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return p(t,OL),v(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ec.CLEAR,storeOp:Ac.STORE,sampleCount:1,beginLayout:Rc.COLOR_ATTACHMENT_OPTIMAL,endLayout:Rc.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ec.CLEAR,depthStoreOp:Ac.STORE,stencilLoadOp:Ec.CLEAR,stencilStoreOp:Ac.STORE,sampleCount:1,beginLayout:Rc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Rc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==Ou.UNKNOWN&&(this._colorTex=this._device.createTexture({type:lc.TEX2D,usage:hc.COLOR_ATTACHMENT|hc.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:_c.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:mc.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==Ou.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:lc.TEX2D,usage:hc.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:_c.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:mc.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=bu.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=bu.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:mc.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:mc.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),IL=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).stateCache=new hL,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return p(t,nh),v(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),v(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Jc.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=Ou.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Ou.D24S8:this._depthStencilFmt=Ou.D24:8===this._stencilBits?this._depthStencilFmt=Ou.D16S8:this._depthStencilFmt=Ou.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[eh.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[eh.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[eh.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[eh.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[eh.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[eh.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[eh.FORMAT_D24S8]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[eh.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[eh.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[eh.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[eh.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[eh.FORMAT_ASTC]=!0,l+="astc "),this._features[eh.MSAA]=!1,this._OES_vertex_array_object&&(Ll.platform===Ll.WECHAT_GAME&&Ll.os===Ll.OS_IOS||(this._useVAO=!0)),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:Dc.GRAPHICS});var u=this._webGLRC.canvas;this._mainWindow=this.createWindow({title:u.title||"",left:u.offsetLeft||0,top:u.offsetTop||0,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new kL(this),this.nullTex2D.initialize({type:lc.TEX2D,usage:hc.SAMPLED,format:Ou.RGBA8,width:2,height:2,flags:_c.GEN_MIPMAP}),this.nullTexCube=new kL(this),this.nullTexCube.initialize({type:lc.TEX2D,usage:hc.SAMPLED,format:Ou.RGBA8,width:2,height:2,arrayLayer:6,flags:_c.CUBEMAP|_c.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},h=new Uint8Array(this.nullTex2D.size);return h.fill(0),this.copyBuffersToTexture([h],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new dL(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new kL(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new RL(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new EL(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new UI(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new CL(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new yL(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new wL(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new mL(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new gL(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new xL(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new _L(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new vL(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new SL(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new ML(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){cL(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:var u=n,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var d;if(c){if(h>=u.length)break;d=u[h++]}else{if((h=u.next()).done)break;d=h.value}var f=d;for(s=f.texSubres.baseMipLevel;s<f.texSubres.levelCount;++s)r.texSubImage2D(r.TEXTURE_2D,s,f.texOffset.x,f.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:var p=n,_=Array.isArray(p),v=0;for(p=_?p:p[Symbol.iterator]();;){var m;if(_){if(v>=p.length)break;m=p[v++]}else{if((v=p.next()).done)break;m=v.value}var y=m,g=y.texSubres.baseArrayLayer+y.texSubres.layerCount;for(l=y.texSubres.baseArrayLayer;l<g;++l){var b=y.texSubres.baseMipLevel+y.texSubres.levelCount;for(s=y.texSubres.baseMipLevel;s<b;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,y.texOffset.x,y.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&_c.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c,d=h.buffOffset+h.buffTexHeight*h.buffStride,f=h.texExtent.width,p=h.texExtent.height,_=Yc(Ou.RGBA8,f,p,1),v=s.subarray(d,d+_);n.readPixels(h.texOffset.x,h.texOffset.y,f,p,n.RGBA,n.UNSIGNED_BYTE,v)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGLRC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.WebGLGFXDevice=IL;var LL,zL,BL,PL,DL,FL,NL,UL,VL,GL,HL,WL,qL,jL,XL,YL,KL,QL,ZL,JL,$L,ez,tz,iz,nz,rz,az,sz,oz,lz,uz,cz,hz,dz,fz=new Fi,pz=new zn;function _z(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,u=l=o=0);var c=a.vData,h=a.iData;e.getWorldMatrix(pz);for(var d=0;d<o;d++){var f=r[d];Fi.set(fz,f.x,f.y,0),Fi.transformMat4(fz,fz,pz),c[s++]=fz.x,c[s++]=fz.y,c[s++]=fz.z,c[s++]=f.u,c[s++]=f.v,rr.toArray(c,n,s),s+=4}for(var p=0,_=o/4;p<_;p++){var v=u+4*p;h[l++]=v,h[l++]=v+1,h[l++]=v+2,h[l++]=v+1,h[l++]=v+3,h[l++]=v+2}}(cz=uz=uz||{})[cz.NONE=0]="NONE",cz[cz.COLOR=1]="COLOR",cz[cz.SPRITE=2]="SPRITE",cz[cz.SCALE=3]="SCALE",mt(uz),(dz=hz=hz||{}).NORMAL="normal",dz.HOVER="hover",dz.PRESSED="pressed",dz.DISABLED="disabled";var vz=q3("ButtonComponent",(LL=oo("cc.ButtonComponent"),zL=_o(110),BL=po("UI/Button"),PL=lo({displayOrder:1}),DL=lo({type:uz,displayOrder:2}),FL=lo({min:0,max:10}),NL=lo({type:yf}),UL=lo({type:yf}),VL=lo({type:yf}),GL=lo({type:yf}),HL=lo({type:f_,displayOrder:0}),WL=lo({type:[$A],displayOrder:3}),LL(qL=zL(qL=BL((lz=oz=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"clickEvents",XL,l(t)),m(t,"_interactable",YL,l(t)),m(t,"_transition",KL,l(t)),m(t,"_normalColor",QL,l(t)),m(t,"_hoverColor",ZL,l(t)),m(t,"_pressColor",JL,l(t)),m(t,"_disabledColor",$L,l(t)),m(t,"_normalSprite",ez,l(t)),m(t,"_hoverSprite",tz,l(t)),m(t,"_pressedSprite",iz,l(t)),m(t,"_disabledSprite",nz,l(t)),m(t,"_duration",rz,l(t)),m(t,"_zoomScale",az,l(t)),m(t,"_target",sz,l(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new rr,t._toColor=new rr,t._time=0,t._transitionFinished=!0,t._fromScale=new Fi,t._toScale=new Fi,t._originalScale=new Fi,t._sprite=null,t._targetScale=new Fi,t}return p(a,rp),v(a,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(RA);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(gf.TOUCH_START,this._onTouchBegan,this),this.node.off(gf.TOUCH_MOVE,this._onTouchMove,this),this.node.off(gf.TOUCH_END,this._onTouchEnded,this),this.node.off(gf.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(gf.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(gf.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===uz.COLOR||this._transition===uz.SCALE)){this._time+=e;var i=1;0<this._duration&&(i=this._time/this._duration),1<=i&&(i=1,this._transitionFinished=!0);var n=t.getComponent(xA);n&&(this._transition===uz.COLOR?rr.lerp(n.color,this._fromColor,this._toColor,i):this.transition===uz.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=vi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=vi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(xA);if(t){var i=this._transition;i===uz.COLOR&&this._interactable?t.color=this._normalColor:i===uz.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(gf.TOUCH_START,this._onTouchBegan,this),this.node.on(gf.TOUCH_MOVE,this._onTouchMove,this),this.node.on(gf.TOUCH_END,this._onTouchEnded,this),this.node.on(gf.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(gf.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(gf.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(RA)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Fi.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node.uiTransfromComp.isHit(t.getUILocation());if(this._transition===uz.SCALE&&this._target)n?(Fi.copy(this._fromScale,this._originalScale),Fi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?hz.PRESSED:hz.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&($A.emitEvents(this.clickEvents,e),this.node.emit("click",this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition===uz.SPRITE&&!this._hoverSprite||this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=hz.NORMAL;return this._interactable?this._pressed?e=hz.PRESSED:this._hovered&&(e=hz.HOVER):e=hz.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(xA);n&&(e===hz.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===hz.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Fi.copy(this._fromScale,this._originalScale),Fi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Fi.copy(this._fromScale,this._target.getScale()),Fi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===uz.COLOR?this._updateColorTransition(e):t===uz.SPRITE?this._updateSpriteTransition(e):t===uz.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(RA);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),a}(),oz.Transition=uz,b((jL=lz).prototype,"interactable",[PL],Object.getOwnPropertyDescriptor(jL.prototype,"interactable"),jL.prototype),b(jL.prototype,"transition",[DL],Object.getOwnPropertyDescriptor(jL.prototype,"transition"),jL.prototype),b(jL.prototype,"normalColor",[lo],Object.getOwnPropertyDescriptor(jL.prototype,"normalColor"),jL.prototype),b(jL.prototype,"pressedColor",[lo],Object.getOwnPropertyDescriptor(jL.prototype,"pressedColor"),jL.prototype),b(jL.prototype,"hoverColor",[lo],Object.getOwnPropertyDescriptor(jL.prototype,"hoverColor"),jL.prototype),b(jL.prototype,"disabledColor",[lo],Object.getOwnPropertyDescriptor(jL.prototype,"disabledColor"),jL.prototype),b(jL.prototype,"duration",[FL],Object.getOwnPropertyDescriptor(jL.prototype,"duration"),jL.prototype),b(jL.prototype,"zoomScale",[lo],Object.getOwnPropertyDescriptor(jL.prototype,"zoomScale"),jL.prototype),b(jL.prototype,"normalSprite",[NL],Object.getOwnPropertyDescriptor(jL.prototype,"normalSprite"),jL.prototype),b(jL.prototype,"pressedSprite",[UL],Object.getOwnPropertyDescriptor(jL.prototype,"pressedSprite"),jL.prototype),b(jL.prototype,"hoverSprite",[VL],Object.getOwnPropertyDescriptor(jL.prototype,"hoverSprite"),jL.prototype),b(jL.prototype,"disabledSprite",[GL],Object.getOwnPropertyDescriptor(jL.prototype,"disabledSprite"),jL.prototype),b(jL.prototype,"target",[HL],Object.getOwnPropertyDescriptor(jL.prototype,"target"),jL.prototype),XL=b(jL.prototype,"clickEvents",[WL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YL=b(jL.prototype,"_interactable",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KL=b(jL.prototype,"_transition",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uz.NONE}}),QL=b(jL.prototype,"_normalColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(214,214,214,255)}}),ZL=b(jL.prototype,"_hoverColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(211,211,211,255)}}),JL=b(jL.prototype,"_pressColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),$L=b(jL.prototype,"_disabledColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(124,124,124,255)}}),ez=b(jL.prototype,"_normalSprite",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tz=b(jL.prototype,"_hoverSprite",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iz=b(jL.prototype,"_pressedSprite",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nz=b(jL.prototype,"_disabledSprite",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rz=b(jL.prototype,"_duration",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),az=b(jL.prototype,"_zoomScale",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),sz=b(jL.prototype,"_target",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qL=jL))||qL)||qL)||qL));cc.ButtonComponent=vz;var mz,yz,gz,bz,xz,Sz,wz,Tz,Ez,Cz,Az,kz,Rz,Oz,Mz,Iz,Lz,zz,Bz,Pz,Dz,Fz,Nz,Uz,Vz,Gz,Hz,Wz,qz,jz,Xz,Yz,Kz,Qz,Zz,Jz,$z,eB,tB,iB,nB,rB,aB,sB,oB,lB,uB=q3("CanvasPool",function(){function e(){y(this,e),this.pool=[]}return v(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){32<=this.pool.length||this.pool.push(e)}}]),e}());(iB=tB=tB||q3("HorizontalTextAlignment",{}))[iB.LEFT=0]="LEFT",iB[iB.CENTER=1]="CENTER",iB[iB.RIGHT=2]="RIGHT",mt(tB),(rB=nB=nB||q3("VerticalTextAlignment",{}))[rB.TOP=0]="TOP",rB[rB.CENTER=1]="CENTER",rB[rB.BOTTOM=2]="BOTTOM",mt(nB),(sB=aB=aB||q3("Overflow",{}))[sB.NONE=0]="NONE",sB[sB.CLAMP=1]="CLAMP",sB[sB.SHRINK=2]="SHRINK",sB[sB.RESIZE_HEIGHT=3]="RESIZE_HEIGHT",mt(aB),(lB=oB=oB||{})[lB.NONE=0]="NONE",lB[lB.BITMAP=1]="BITMAP",lB[lB.CHAR=2]="CHAR",mt(oB);var cB,hB,dB,fB,pB,_B,vB,mB=q3("LabelComponent",(mz=oo("cc.LabelComponent"),yz=_o(110),gz=po("UI/Render/Label"),bz=lo({displayOrder:4,multiline:!0}),xz=lo({type:tB,displayOrder:5}),Sz=lo({type:nB,displayOrder:6}),wz=lo({readonly:!0,displayName:"Actual Font Size",visible:!1}),Tz=lo({displayOrder:7}),Ez=lo({displayOrder:8}),Cz=lo({displayOrder:8}),Az=lo({type:aB,displayOrder:9}),kz=lo({displayOrder:10}),Rz=lo({type:Ng,displayOrder:11}),Oz=lo({displayOrder:12}),Mz=lo({type:oB,displayOrder:13}),Iz=lo({displayOrder:15}),Lz=lo({displayOrder:16}),zz=lo({displayOrder:17}),mz(Bz=yz(Bz=gz((eB=$z=function(){function i(){var e;return y(this,i),m(e=x(this,g(i).call(this)),"_useOriginalSize",Dz,l(e)),m(e,"_string",Fz,l(e)),m(e,"_horizontalAlign",Nz,l(e)),m(e,"_verticalAlign",Uz,l(e)),m(e,"_actualFontSize",Vz,l(e)),m(e,"_fontSize",Gz,l(e)),m(e,"_fontFamily",Hz,l(e)),m(e,"_lineHeight",Wz,l(e)),m(e,"_overflow",qz,l(e)),m(e,"_enableWrapText",jz,l(e)),m(e,"_font",Xz,l(e)),m(e,"_isSystemFontUsed",Yz,l(e)),e._spacingX=0,m(e,"_isItalic",Kz,l(e)),m(e,"_isBold",Qz,l(e)),m(e,"_isUnderline",Zz,l(e)),m(e,"_cacheMode",Jz,l(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return p(i,xA),v(i,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,"string"==typeof(this._font=e)&&B(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===oB.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof Qg?this._font.fontSize:-1}}]),v(i,[{key:"onEnable",value:function(){_(g(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){_(g(i.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture&&(this._letterTexture.destroy(),this._letterTexture=null),_(g(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.markForUpdateRenderData(),t&&(this._flushAssembler(),this._applyFontTexture(t))}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler)}},{key:"_updateColor",value:function(){this._font instanceof Qg?_(g(i.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!_(g(i.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof Qg){var t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){var e=this._material;e&&e.setProperty("mainTexture",this._texture),this._updateMaterial(e)}},{key:"_applyFontTexture",value:function(e){var t=this,i=this._font;if(i instanceof Qg){var n=i.spriteFrame,r=this;n&&n.loaded&&(r._texture=n,r._flushMaterial(),e&&t._renderFlag&&t._assembler&&t._renderData&&t._assembler.updateRenderData(t))}else{if(this.cacheMode===oB.CHAR&&Ll.browserType!==Ll.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new yf,this._assemblerData=this._assembler.getAssemblerData();var a=new Td(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=a}this.cacheMode!==oB.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial()}e&&this._renderFlag&&this._assembler&&this._renderData&&this._assembler.updateRenderData(this)}}]),i}(),$z.HorizontalAlign=tB,$z.VerticalAlign=nB,$z.Overflow=aB,$z.CacheMode=oB,$z.CanvasPool=new uB,b((Pz=eB).prototype,"string",[bz],Object.getOwnPropertyDescriptor(Pz.prototype,"string"),Pz.prototype),b(Pz.prototype,"horizontalAlign",[xz],Object.getOwnPropertyDescriptor(Pz.prototype,"horizontalAlign"),Pz.prototype),b(Pz.prototype,"verticalAlign",[Sz],Object.getOwnPropertyDescriptor(Pz.prototype,"verticalAlign"),Pz.prototype),b(Pz.prototype,"actualFontSize",[wz],Object.getOwnPropertyDescriptor(Pz.prototype,"actualFontSize"),Pz.prototype),b(Pz.prototype,"fontSize",[Tz],Object.getOwnPropertyDescriptor(Pz.prototype,"fontSize"),Pz.prototype),b(Pz.prototype,"fontFamily",[Ez],Object.getOwnPropertyDescriptor(Pz.prototype,"fontFamily"),Pz.prototype),b(Pz.prototype,"lineHeight",[Cz],Object.getOwnPropertyDescriptor(Pz.prototype,"lineHeight"),Pz.prototype),b(Pz.prototype,"overflow",[Az],Object.getOwnPropertyDescriptor(Pz.prototype,"overflow"),Pz.prototype),b(Pz.prototype,"enableWrapText",[kz],Object.getOwnPropertyDescriptor(Pz.prototype,"enableWrapText"),Pz.prototype),b(Pz.prototype,"font",[Rz],Object.getOwnPropertyDescriptor(Pz.prototype,"font"),Pz.prototype),b(Pz.prototype,"useSystemFont",[Oz],Object.getOwnPropertyDescriptor(Pz.prototype,"useSystemFont"),Pz.prototype),b(Pz.prototype,"cacheMode",[Mz],Object.getOwnPropertyDescriptor(Pz.prototype,"cacheMode"),Pz.prototype),b(Pz.prototype,"isBold",[Iz],Object.getOwnPropertyDescriptor(Pz.prototype,"isBold"),Pz.prototype),b(Pz.prototype,"isItalic",[Lz],Object.getOwnPropertyDescriptor(Pz.prototype,"isItalic"),Pz.prototype),b(Pz.prototype,"isUnderline",[zz],Object.getOwnPropertyDescriptor(Pz.prototype,"isUnderline"),Pz.prototype),Dz=b(Pz.prototype,"_useOriginalSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fz=b(Pz.prototype,"_string",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),Nz=b(Pz.prototype,"_horizontalAlign",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tB.CENTER}}),Uz=b(Pz.prototype,"_verticalAlign",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nB.CENTER}}),Vz=b(Pz.prototype,"_actualFontSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gz=b(Pz.prototype,"_fontSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Hz=b(Pz.prototype,"_fontFamily",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Wz=b(Pz.prototype,"_lineHeight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),qz=b(Pz.prototype,"_overflow",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aB.NONE}}),jz=b(Pz.prototype,"_enableWrapText",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xz=b(Pz.prototype,"_font",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yz=b(Pz.prototype,"_isSystemFontUsed",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kz=b(Pz.prototype,"_isItalic",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qz=b(Pz.prototype,"_isBold",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zz=b(Pz.prototype,"_isUnderline",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jz=b(Pz.prototype,"_cacheMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oB.NONE}}),Bz=Pz))||Bz)||Bz)||Bz));cc.LabelComponent=mB,(hB=cB=cB||{})[hB.DEFAULT=0]="DEFAULT",hB[hB.DONE=1]="DONE",hB[hB.SEND=2]="SEND",hB[hB.SEARCH=3]="SEARCH",hB[hB.GO=4]="GO",hB[hB.NEXT=5]="NEXT",vt(cB),(fB=dB=dB||{})[fB.ANY=0]="ANY",fB[fB.EMAIL_ADDR=1]="EMAIL_ADDR",fB[fB.NUMERIC=2]="NUMERIC",fB[fB.PHONE_NUMBER=3]="PHONE_NUMBER",fB[fB.URL=4]="URL",fB[fB.DECIMAL=5]="DECIMAL",fB[fB.SINGLE_LINE=6]="SINGLE_LINE",vt(dB),(_B=pB=pB||{})[_B.PASSWORD=0]="PASSWORD",_B[_B.SENSITIVE=1]="SENSITIVE",_B[_B.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",_B[_B.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",_B[_B.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",_B[_B.DEFAULT=5]="DEFAULT",vt(pB);var yB=new zn,gB=new zn,bB=new Fi,xB=null,SB={zoomInvalid:!1};Ll.OS_ANDROID!==Ll.os||Ll.browserType!==Ll.BROWSER_TYPE_SOUGOU&&Ll.browserType!==Ll.BROWSER_TYPE_360||(SB.zoomInvalid=!0);var wB,TB,EB,CB,AB,kB,RB,OB,MB,IB,LB,zB,BB,PB,DB,FB,NB,UB,VB,GB,HB,WB,qB,jB,XB,YB,KB,QB,ZB,JB,$B,eP,tP,iP,nP,rP=oo(vB=function(){function e(){y(this,e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=cB.DEFAULT,this._maxLength=50,this._text="",this._placeholderText="",this._alwaysOnTop=!1,this._size=new qn,this._node=null,this._editing=!1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__rotateScreen=!1,this.__orientationChanged=void 0,this._edTxt=null,this._textColor=rr.WHITE.clone(),this._edFontSize=14,this._isTextArea=!1}return v(e,[{key:"onEnable",value:function(){this._edTxt&&(this._alwaysOnTop?this._edTxt.style.display="":this._edTxt.style.display="none")}},{key:"onDisable",value:function(){this._edTxt&&(this._edTxt.style.display="none")}},{key:"setTabIndex",value:function(e){this._edTxt&&(this._edTxt.tabIndex=e)}},{key:"setFocus",value:function(){this._beginEditing()}},{key:"isFocused",value:function(){return this._edTxt?document.activeElement===this._edTxt:(B(4700),!1)}},{key:"stayOnTop",value:function(e){this._alwaysOnTop!==e&&this._edTxt&&(this._alwaysOnTop=e,this._edTxt.style.display=e?"":"none")}},{key:"setMaxLength",value:function(e){isNaN(e)||(e<0&&(e=65535),this._maxLength=e,this._edTxt&&(this._edTxt.maxLength=e))}},{key:"setString",value:function(e){this._text=e,this._edTxt&&(this._edTxt.value=e)}},{key:"getString",value:function(){return this._text}},{key:"setPlaceholderText",value:function(e){this._placeholderText=e}},{key:"getPlaceholderText",value:function(){return this._placeholderText}},{key:"setDelegate",value:function(e){this._delegate=e}},{key:"setInputMode",value:function(e){this._inputMode!==e&&(this._inputMode=e,this.createInput(),this._updateDomInputType(),this._updateSize(this._size.width,this._size.height))}},{key:"setInputFlag",value:function(e){if(this._inputFlag!==e){this._inputFlag=e,this._updateDomInputType();var t="none";e===pB.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":e===pB.INITIAL_CAPS_WORD&&(t="capitalize"),this._edTxt&&(this._edTxt.style.textTransform=t,this._edTxt.value=this._text)}}},{key:"setReturnType",value:function(e){this._returnType=e,this._updateDomInputType()}},{key:"setFontSize",value:function(e){this._edFontSize=e||this._edFontSize,this._edTxt&&(this._edTxt.style.fontSize=this._edFontSize+"px")}},{key:"setFontColor",value:function(e){this._textColor=e,this._edTxt&&(this._edTxt.style.color=e.toCSS("rgba"))}},{key:"setSize",value:function(e,t){this._size.width=e,this._size.height=t,this._updateSize(e,t)}},{key:"setNode",value:function(e){this._node=e}},{key:"update",value:function(){this._updateMatrix()}},{key:"clear",value:function(){this._node=null,this.setDelegate(null),this.removeDom()}},{key:"_onTouchBegan",value:function(e){}},{key:"_onTouchEnded",value:function(){this._beginEditing()}},{key:"_beginEditing",value:function(){Ll.isMobile&&!this._editing&&this._beginEditingOnMobile();var e=this;function t(){e._edTxt&&e._edTxt.focus()}this._edTxt&&(this._edTxt.style.display="",Ll.browserType===Ll.BROWSER_TYPE_UC?setTimeout(t,400):Ll.browserType===Ll.BROWSER_TYPE_FIREFOX?setTimeout(t,0):t()),this._editing=!0}},{key:"_endEditing",value:function(){function e(){!t._alwaysOnTop&&t._edTxt&&(t._edTxt.style.display="none"),t._delegate&&t._delegate.editBoxEditingDidEnded&&t._delegate.editBoxEditingDidEnded()}var t=this;this._editing&&(Ll.isMobile?setTimeout(function(){t._endEditingOnMobile(),e()},400):e()),this._editing=!1}},{key:"_updateDomInputType",value:function(){var e=this._inputMode,t=this._edTxt;if(t){if(this._isTextArea){t=t;var i="none";return this._inputFlag===pB.INITIAL_CAPS_ALL_CHARACTERS?i="uppercase":this._inputFlag===pB.INITIAL_CAPS_WORD&&(i="capitalize"),void(t.style.textTransform=i)}if(t=t,this._inputFlag!==pB.PASSWORD){var n=t.type;e===dB.EMAIL_ADDR?n="email":e===dB.NUMERIC||e===dB.DECIMAL?n="number":e===dB.PHONE_NUMBER?(n="number",t.pattern="[0-9]*"):e===dB.URL?n="url":(n="text",this._returnType===cB.SEARCH&&(n="search")),t.type=n}else t.type="password"}}},{key:"_updateSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._node,t=Tm.getScaleX(),i=Tm.getScaleY(),n=Tm.getViewportRect(),r=Tm.getDevicePixelRatio();e.getWorldMatrix(yB);var a=e.uiTransfromComp;a&&Fi.set(bB,-a.anchorX*a.width,-a.anchorY*a.height,bB.z),zn.transform(yB,yB,bB);var s=e.getComponent(xA);if(!s)return!1;var o=qE.root.ui.getScreen(s.visibility);if(o){o.node.getWorldRT(gB);var l=gB.m12,u=gB.m13,c=Gl.center;gB.m12=c.x-(gB.m00*l+gB.m04*u),gB.m13=c.y-(gB.m01*l+gB.m05*u),zn.multiply(gB,gB,yB),t/=r,i/=r;var h=vm.container,d=gB.m00*t,f=yB.m01,p=yB.m04,_=gB.m05*i,v=parseInt(h&&h.style.paddingLeft||"0");v+=n.x/r;var m=parseInt(h&&h.style.paddingBottom||"0");m+=n.y/r;var y=gB.m12*t+v,g=gB.m13*i+m;SB.zoomInvalid&&(this._updateSize(this._size.width*d,this._size.height*_),_=d=1);var b="matrix("+d+","+-f+","+-p+","+_+","+y+","+-g+")";this._edTxt.style.transform=b,this._edTxt.style["-webkit-transform"]=b,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_adjustEditBoxPosition",value:function(){this._node.getWorldMatrix(yB);var t=yB.m13,i=Gl.height,e=Gl.width,n=.5;i<e&&(n=.7),setTimeout(function(){if(window.scrollY<40&&t<i*n){var e=i*n-t-window.scrollY;e<35&&(e=35),320<e&&(e=320),window.scrollTo(0,e)}},400)}},{key:"createInput",value:function(){this._isTextArea=!1,this._inputMode===dB.ANY?(this._isTextArea=!0,this._createDomTextArea()):this._createDomInput()}},{key:"_beginEditingOnMobile",value:function(){var e=this;this.__orientationChanged=function(){e._adjustEditBoxPosition()},window.addEventListener("orientationchange",this.__orientationChanged),Tm.isAutoFullScreenEnabled()?(this.__fullscreen=!0,Tm.enableAutoFullScreen(!1),Nm.exitFullScreen()):this.__fullscreen=!1,this.__autoResize=Tm._resizeWithBrowserSize,Tm.resizeWithBrowserSize(!1),xB=this}},{key:"_endEditingOnMobile",value:function(){if(this.__rotateScreen){vm.container&&(vm.container.style["-webkit-transform"]="rotate(90deg)",vm.container.style.transform="rotate(90deg)");var e=Tm._originalDesignResolutionSize.width,t=Tm._originalDesignResolutionSize.height;0<e&&Tm.setDesignResolutionSize(e,t,Tm.getResolutionPolicy()),this.__rotateScreen=!1}this.__orientationChanged&&window.removeEventListener("orientationchange",this.__orientationChanged),this.__fullscreen&&Tm.enableAutoFullScreen(!0),this.__autoResize&&xB===this&&Tm.resizeWithBrowserSize(!0)}},{key:"_createDomInput",value:function(){this.removeDom();var e=this._edTxt=document.createElement("input");return e.type="text",e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.style["-moz-appearance"]="textfield",e.className="cocosEditBox",e.style.fontFamily="Arial",sP(e,this),e}},{key:"_createDomTextArea",value:function(){this.removeDom();var e=this._edTxt=document.createElement("textarea");return e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.resize="none",e.style.textTransform="uppercase",e.style.overflowY="scroll",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",sP(e,this,!0),e}},{key:"_addDomToGameContainer",value:function(){vm.container&&this._edTxt&&vm.container.appendChild(this._edTxt)}},{key:"removeDom",value:function(){var e=this._edTxt;if(e){var t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionstart),e.removeEventListener("compositionend",t.compositionend),e.removeEventListener("input",t.input),e.removeEventListener("focus",t.focus),e.removeEventListener("keypress",t.keypress),e.removeEventListener("blur",t.blur),t.compositionstart=null,t.compositionend=null,t.input=null,t.focus=null,t.keypress=null,t.blur=null,ut(vm.container,e)&&vm.container&&vm.container.removeChild(e)}this._edTxt=null}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"textColor",get:function(){return this._textColor}},{key:"fontSize",get:function(){return this._edFontSize}},{key:"returnType",set:function(e){this._returnType=e}},{key:"alwayOnTop",get:function(){return this._alwaysOnTop}},{key:"editing",get:function(){return this._editing},set:function(e){this._editing=e}},{key:"delegate",get:function(){return this._delegate}},{key:"eventListeners",get:function(){return this.__eventListeners}}]),e}())||vB;function aP(e,t){e.value.length>t._maxLength&&(e.value=e.value.slice(0,t._maxLength)),t._delegate&&t._delegate.editBoxTextChanged&&t._text!==e.value&&(t._text=e.value,t._delegate.editBoxTextChanged(t._text))}function sP(e,t,i){var n=2<arguments.length&&void 0!==i&&i,r=!1,a=t.eventListeners;a.compositionstart=function(){r=!0},e.addEventListener("compositionstart",a.compositionstart),a.compositionend=function(){r=!1,aP(this,t)},e.addEventListener("compositionend",a.compositionend),a.input=function(){r||aP(this,t)},e.addEventListener("input",a.input),a.focus=function(){this.style.fontSize=t.fontSize+"px",this.style.color=t.textColor.toCSS("rgba"),t.alwayOnTop&&(t.editing=!0),Ll.isMobile&&t._beginEditingOnMobile(),t.delegate&&t.delegate.editBoxEditingDidBegan&&t.delegate.editBoxEditingDidBegan()},e.addEventListener("focus",a.focus),a.keypress=function(e){e.keyCode===Vl.KEY.enter&&(e.propagationStopped=!0,t.delegate&&t.delegate.editBoxEditingReturn&&t.delegate.editBoxEditingReturn(),n||(t.text=this.value,t._endEditing(),vm.canvas&&vm.canvas.focus()))},e.addEventListener("keypress",a.keypress),a.blur=function(){t.text=this.value,t._endEditing()},e.addEventListener("blur",a.blur),t._addDomToGameContainer()}var oP,lP,uP,cP,hP,dP,fP,pP,_P,vP,mP,yP,gP,bP,xP,SP,wP,TP,EP,CP,AP,kP,RP,OP,MP,IP,LP=q3("EditBoxComponent",(wB=oo("cc.EditBoxComponent"),TB=_o(100),EB=po("UI/EditBox"),CB=lo({type:yf}),AB=lo({type:cB}),kB=lo({type:pB}),RB=lo({type:dB}),OB=lo({type:rr}),MB=lo({type:[$A]}),IB=lo({type:[$A]}),LB=lo({type:[$A]}),zB=lo({type:[$A]}),wB(BB=TB(BB=EB(BB=ho((nP=iP=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"editingDidBegan",DB,l(t)),m(t,"textChanged",FB,l(t)),m(t,"editingDidEnded",NB,l(t)),m(t,"editingReturn",UB,l(t)),t._impl=null,t._textLabel=null,t._placeholderLabel=null,t._background=null,m(t,"_returnType",VB,l(t)),m(t,"_useOriginalSize",GB,l(t)),m(t,"_string",HB,l(t)),m(t,"_tabIndex",WB,l(t)),m(t,"_backgroundImage",qB,l(t)),m(t,"_inputFlag",jB,l(t)),m(t,"_inputMode",XB,l(t)),m(t,"_fontSize",YB,l(t)),m(t,"_lineHeight",KB,l(t)),m(t,"_maxLength",QB,l(t)),m(t,"_fontColor",ZB,l(t)),m(t,"_placeholder",JB,l(t)),m(t,"_placeholderFontSize",$B,l(t)),m(t,"_placeholderFontColor",eP,l(t)),m(t,"_stayOnTop",tP,l(t)),t}return p(a,rp),v(a,[{key:"onEnable",value:function(){this._impl&&this._impl.onEnable()}},{key:"onDisable",value:function(){this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"_init",value:function(){this._createBackgroundSprite(),this._createLabels(),this.node.on(gf.SIZE_CHANGED,this._resizeChildNodes,this);var e=this._impl=new rP;e.setDelegate(this),e.setNode(this.node),e.setInputMode(this._inputMode),e.setMaxLength(this._maxLength),e.setInputFlag(this._inputFlag),e.setReturnType(this._returnType),e.setTabIndex(this._tabIndex),e.setFontColor(this._fontColor),e.setFontSize(this._fontSize),e.setPlaceholderText(this._placeholder),this._updateStayOnTop(),this._updateString(this._string),this._syncSize()}},{key:"__preload",value:function(){this._registerEvent(),this._init()}},{key:"_registerEvent",value:function(){this.node.on(gf.TOUCH_START,this._onTouchBegan,this),this.node.on(gf.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateStayOnTop",value:function(){this.stayOnTop?this._hideLabels():this._showLabels(),this._impl&&this._impl.stayOnTop(this.stayOnTop)}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node.setAnchorPoint(this.node.getAnchorPoint()),this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.setPosition(2+i,n+e.height,a.node.getPosition().z),a.verticalAlign=this._inputMode===dB.ANY?nB.TOP:nB.CENTER,a.enableWrapText=this._inputMode===dB.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(2+i,n+e.height,r.node.getPosition().z),r.verticalAlign=this._inputMode===dB.ANY?nB.TOP:nB.CENTER,r.enableWrapText=this._inputMode===dB.ANY)}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(RA),this._background||(this._background=this.node.addComponent(RA))),this._background.type=RA.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_createLabels",value:function(){if(!this._textLabel){var e=this.node.getChildByName("TEXT_LABEL"),t=(e=e||new f_("TEXT_LABEL")).getComponent(mB);e.parent=this.node,t=t||e.addComponent(mB),e.getComponent(JE).setAnchorPoint(0,1),t.color=this._fontColor,t.overflow=mB.Overflow.CLAMP,t.fontSize=this._fontSize,t.lineHeight=this.lineHeight,this._textLabel=t}if(!this._placeholderLabel){var i=this.node.getChildByName("PLACEHOLDER_LABEL"),n=(i=i||new f_("PLACEHOLDER_LABEL")).getComponent(mB);n=n||i.addComponent(mB);var r=i.getComponent(JE);i.parent=this.node,n.color=this._placeholderFontColor,r.setAnchorPoint(0,1),n.overflow=mB.Overflow.CLAMP,n.fontSize=this._placeholderFontSize,n.string=this._placeholder,this._placeholderLabel=n}}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-this.node.width/2,this.node.height/2,e.getPosition().z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.setPosition(-this.node.width/2,this.node.height/2,t.getPosition().z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"_showLabels",value:function(){if(this._textLabel){var e=this._textLabel.string;this._textLabel.node.active=""!==e,this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_hideLabels",value:function(){this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i=i&&this._updateLabelStringStyle(i),t.string=i,this._impl&&(this._impl.setString(e),this._impl.editing||this.stayOnTop||this._showLabels())}}},{key:"_updateLabelStringStyle",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t,n=this._inputFlag;if(i||n!==pB.PASSWORD)n===pB.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():n===pB.INITIAL_CAPS_WORD?e=function(e){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}(e):n===pB.INITIAL_CAPS_SENTENCE&&(e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e));else{for(var r="",a=e.length,s=0;s<a;++s)r+="";e=r}return e}},{key:"editBoxEditingDidBegan",value:function(){this._hideLabels(),$A.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}},{key:"editBoxEditingDidEnded",value:function(){this.stayOnTop||this._showLabels(),$A.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this)}},{key:"editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,$A.emitEvents(this.textChanged,e,this),this.node.emit("text-changed",this)}},{key:"editBoxEditingReturn",value:function(){$A.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this)}},{key:"_onTouchBegan",value:function(e){this._impl&&this._impl._onTouchBegan(e.touch),e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl._onTouchEnded(),e.propagationStopped=!0}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus()}},{key:"isFocused",value:function(){var e=!1;return this._impl&&(e=this._impl.isFocused()),e}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._impl&&this._updateString(e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e,this._impl&&(this._impl.returnType=this._returnType)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._impl&&(this._impl.setInputFlag(this._inputFlag),this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode=e,this._impl&&this._impl.setInputMode(this._inputMode)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._textLabel&&(this._textLabel.fontSize=this._fontSize),this._impl&&this._impl.setFontSize(this._fontSize))}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._textLabel&&(this._textLabel.lineHeight=this._lineHeight))}},{key:"fontColor",get:function(){return this._fontColor},set:function(e){if(this._fontColor!==e){if(this._fontColor.set(e),this._textLabel){var t=this._textLabel.node.getComponent(xA);t&&(t.color=this._fontColor)}this._impl&&this._impl.setFontColor(this._fontColor)}}},{key:"placeholder",get:function(){return this._placeholder},set:function(e){this._placeholder!==e&&(this._placeholder=e,this._placeholderLabel&&(this._placeholderLabel.string=this._placeholder),this._impl&&this._impl.setPlaceholderText(this._placeholder))}},{key:"placeholderFontSize",get:function(){return this._placeholderFontSize},set:function(e){this._placeholderFontSize!==e&&(this._placeholderFontSize=e,this._placeholderLabel&&(this._placeholderLabel.fontSize=this._placeholderFontSize))}},{key:"placeholderFontColor",get:function(){return this._placeholderFontColor},set:function(e){if(this._placeholderFontColor!==e&&(this._placeholderFontColor=e,this._placeholderLabel)){var t=this._placeholderLabel.node.getComponent(xA);t&&(t.color=this._placeholderFontColor)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength!==e&&(this._maxLength=e,this._impl&&this._impl.setMaxLength(this._maxLength))}},{key:"stayOnTop",get:function(){return this._stayOnTop},set:function(e){this._stayOnTop=e,this._impl&&this._updateStayOnTop()}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex=e,this._impl&&this._impl.setTabIndex(e)}}]),a}(),iP._EditBoxImpl=rP,iP.KeyboardReturnType=cB,iP.InputFlag=pB,iP.InputMode=dB,b((PB=nP).prototype,"string",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"string"),PB.prototype),b(PB.prototype,"backgroundImage",[CB],Object.getOwnPropertyDescriptor(PB.prototype,"backgroundImage"),PB.prototype),b(PB.prototype,"returnType",[AB],Object.getOwnPropertyDescriptor(PB.prototype,"returnType"),PB.prototype),b(PB.prototype,"inputFlag",[kB],Object.getOwnPropertyDescriptor(PB.prototype,"inputFlag"),PB.prototype),b(PB.prototype,"inputMode",[RB],Object.getOwnPropertyDescriptor(PB.prototype,"inputMode"),PB.prototype),b(PB.prototype,"fontSize",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"fontSize"),PB.prototype),b(PB.prototype,"lineHeight",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"lineHeight"),PB.prototype),b(PB.prototype,"fontColor",[OB],Object.getOwnPropertyDescriptor(PB.prototype,"fontColor"),PB.prototype),b(PB.prototype,"placeholder",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"placeholder"),PB.prototype),b(PB.prototype,"placeholderFontSize",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"placeholderFontSize"),PB.prototype),b(PB.prototype,"placeholderFontColor",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"placeholderFontColor"),PB.prototype),b(PB.prototype,"maxLength",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"maxLength"),PB.prototype),b(PB.prototype,"stayOnTop",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"stayOnTop"),PB.prototype),b(PB.prototype,"tabIndex",[lo],Object.getOwnPropertyDescriptor(PB.prototype,"tabIndex"),PB.prototype),DB=b(PB.prototype,"editingDidBegan",[MB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FB=b(PB.prototype,"textChanged",[IB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NB=b(PB.prototype,"editingDidEnded",[LB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UB=b(PB.prototype,"editingReturn",[zB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VB=b(PB.prototype,"_returnType",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cB.DEFAULT}}),GB=b(PB.prototype,"_useOriginalSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HB=b(PB.prototype,"_string",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),WB=b(PB.prototype,"_tabIndex",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qB=b(PB.prototype,"_backgroundImage",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jB=b(PB.prototype,"_inputFlag",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pB.DEFAULT}}),XB=b(PB.prototype,"_inputMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dB.ANY}}),YB=b(PB.prototype,"_fontSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),KB=b(PB.prototype,"_lineHeight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),QB=b(PB.prototype,"_maxLength",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),ZB=b(PB.prototype,"_fontColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),JB=b(PB.prototype,"_placeholder",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Enter text here..."}}),$B=b(PB.prototype,"_placeholderFontSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),eP=b(PB.prototype,"_placeholderFontColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.GRAY.clone()}}),tP=b(PB.prototype,"_stayOnTop",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BB=PB))||BB)||BB)||BB)||BB));cc.EditBoxComponent=LP;var zP,BP,PP,DP,FP,NP,UP,VP,GP,HP,WP=gf;(BP=zP=zP||{})[BP.NONE=0]="NONE",BP[BP.HORIZONTAL=1]="HORIZONTAL",BP[BP.VERTICAL=2]="VERTICAL",BP[BP.GRID=3]="GRID",mt(zP),(DP=PP=PP||{})[DP.NONE=0]="NONE",DP[DP.CONTAINER=1]="CONTAINER",DP[DP.CHILDREN=2]="CHILDREN",mt(PP),(NP=FP=FP||{})[NP.HORIZONTAL=0]="HORIZONTAL",NP[NP.VERTICAL=1]="VERTICAL",mt(FP),(VP=UP=UP||{})[VP.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",VP[VP.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM",mt(UP),(HP=GP=GP||{})[HP.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",HP[HP.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT",mt(GP);var qP,jP,XP,YP,KP,QP,ZP,JP,$P,eD,tD,iD,nD,rD,aD,sD,oD,lD,uD,cD,hD,dD,fD=new Fi,pD=new Fi,_D=q3("LayoutComponent",(oP=oo("cc.LayoutComponent"),lP=_o(110),uP=po("UI/Layout"),cP=lo({type:zP}),hP=lo({type:PP}),dP=lo({type:FP}),fP=lo({type:UP}),pP=lo({type:GP}),oP(_P=lP(_P=uP(_P=ho((IP=MP=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._layoutDirty=!0,m(t,"_resizeMode",mP,l(t)),m(t,"_N$layoutType",yP,l(t)),m(t,"_N$padding",gP,l(t)),m(t,"_cellSize",bP,l(t)),m(t,"_startAxis",xP,l(t)),m(t,"_paddingLeft",SP,l(t)),m(t,"_paddingRight",wP,l(t)),m(t,"_paddingTop",TP,l(t)),m(t,"_paddingBottom",EP,l(t)),m(t,"_spacingX",CP,l(t)),m(t,"_spacingY",AP,l(t)),t._layoutSize=new qn(300,200),m(t,"_verticalDirection",kP,l(t)),m(t,"_horizontalDirection",RP,l(t)),m(t,"_affectedByScale",OP,l(t)),t}return p(a,rp),v(a,[{key:"updateLayout",value:function(){this._layoutDirty&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new qn)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){qE.on(lE.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(WP.SIZE_CHANGED,this._resized,this),this.node.on(WP.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(WP.CHILD_ADDED,this._childAdded,this),this.node.on(WP.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){qE.off(lE.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(WP.SIZE_CHANGED,this._resized,this),this.node.off(WP.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(WP.CHILD_ADDED,this._childAdded,this),this.node.off(WP.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.on(WP.SCALE_PART,this._doScaleDirty,this),r.on(WP.SIZE_CHANGED,this._doLayoutDirty,this),r.on(WP.TRANSFORM_CHANGED,this._transformDirty,this),r.on(WP.ANCHOR_CHANGED,this._doLayoutDirty,this),r.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.off(WP.SCALE_PART,this._doScaleDirty,this),r.off(WP.SIZE_CHANGED,this._doLayoutDirty,this),r.off(WP.TRANSFORM_CHANGED,this._transformDirty,this),r.off(WP.ANCHOR_CHANGED,this._doLayoutDirty,this),r.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(WP.SCALE_PART,this._doScaleDirty,this),e.on(WP.SIZE_CHANGED,this._doLayoutDirty,this),e.on(WP.TRANSFORM_CHANGED,this._transformDirty,this),e.on(WP.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(WP.SCALE_PART,this._doScaleDirty,this),e.off(WP.SIZE_CHANGED,this._doLayoutDirty,this),e.off(WP.TRANSFORM_CHANGED,this._transformDirty,this),e.off(WP.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingLeft,l=-r.x*e;this._horizontalDirection===GP.RIGHT_TO_LEFT&&(s=-1,l=(1-r.x)*e,o=this._paddingRight);var u=l+s*o-s*this._spacingX,c=0,h=0,d=0,f=0,p=0,_=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var x=this._cellSize.width;this._N$layoutType!==zP.GRID&&this._resizeMode===PP.CHILDREN&&(x=(e-(this._paddingLeft+this._paddingRight)-(v-1)*this._spacingX)/v);var S=a,w=Array.isArray(S),T=0;for(S=w?S:S[Symbol.iterator]();;){var E;if(w){if(T>=S.length)break;E=S[T++]}else{if((T=S.next()).done)break;E=T.value}var C=E;if(C.activeInHierarchy){C.getScale(pD);var A=this._getUsedScaleValue(pD.x),k=this._getUsedScaleValue(pD.y);this._resizeMode===PP.CHILDREN&&(C.width=x/A,this._N$layoutType===zP.GRID&&(C.height=this._cellSize.height/k));var R=C.anchorX,O=C.width*A,M=C.height*k;h<d&&(h=d),h<=M&&(d=h,h=M,_=C.getAnchorPoint().y),this._horizontalDirection===GP.RIGHT_TO_LEFT&&(R=1-C.anchorX),u=u+s*R*O+s*this._spacingX;var I=s*(1-R)*O;if(t){var L=u+I+s*(0<s?this._paddingRight:this._paddingLeft),z=!1;this._horizontalDirection===GP.LEFT_TO_RIGHT&&L>(1-r.x)*e&&(z=!0);var B=!1;this._horizontalDirection===GP.RIGHT_TO_LEFT&&L<-r.x*e&&(B=!0),(z||B)&&(h<=M?(0===d&&(d=h),c+=d,d=h):(c+=h,d=M,h=0),u=l+s*(o+R*O),f++)}var P=i(C,c,f);e>=O+this._paddingLeft+this._paddingRight&&n&&(C.getPosition(fD),C.setPosition(u,P,fD.z));var D=1,F=void 0,N=0===h?M:h;this._verticalDirection===UP.TOP_TO_BOTTOM?(p=p||this.node.getContentSize().height,(F=P+(D=-1)*(N*_+this._paddingBottom))<p&&(p=F)):(p=p||-this.node.getContentSize().height)<(F=P+D*(N*_+this._paddingTop))&&(p=F),u+=I}}return p}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingBottom,l=-r.y*e;this._verticalDirection===UP.TOP_TO_BOTTOM&&(s=-1,l=(1-r.y)*e,o=this._paddingTop);var u=l+s*o-s*this._spacingY,c=0,h=0,d=0,f=0,p=0,_=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var x=this._cellSize.height;this._N$layoutType!==zP.GRID&&this._resizeMode===PP.CHILDREN&&(x=(e-(this._paddingTop+this._paddingBottom)-(v-1)*this._spacingY)/v);var S=a,w=Array.isArray(S),T=0;for(S=w?S:S[Symbol.iterator]();;){var E;if(w){if(T>=S.length)break;E=S[T++]}else{if((T=S.next()).done)break;E=T.value}var C=E;if(C){var A=C.getScale(),k=this._getUsedScaleValue(A.x),R=this._getUsedScaleValue(A.y);if(C.activeInHierarchy){this._resizeMode===PP.CHILDREN&&(C.height=x/R,this._N$layoutType===zP.GRID&&(C.width=this._cellSize.width/k));var O=C.anchorY,M=C.width*k,I=C.height*R;h<d&&(h=d),h<=M&&(d=h,h=M,_=C.getAnchorPoint().x),this._verticalDirection===UP.TOP_TO_BOTTOM&&(O=1-C.anchorY),u=u+s*O*I+s*this._spacingY;var L=s*(1-O)*I;if(t){var z=u+L+s*(0<s?this._paddingTop:this._paddingBottom),B=!1;this._verticalDirection===UP.BOTTOM_TO_TOP&&z>(1-r.y)*e&&(B=!0);var P=!1;this._verticalDirection===UP.TOP_TO_BOTTOM&&z<-r.y*e&&(P=!0),(B||P)&&(h<=M?(0===d&&(d=h),c+=d,d=h):(c+=h,d=M,h=0),u=l+s*(o+O*I),f++)}var D=i(C,c,f);e>=I+(this._paddingTop+this._paddingBottom)&&n&&(C.getPosition(fD),C.setPosition(D,u,fD.z));var F=1,N=void 0,U=0===h?M:h;this._horizontalDirection===GP.RIGHT_TO_LEFT?(F=-1,p=p||this.node.getContentSize().width,(N=D+F*(U*_+this._paddingLeft))<p&&(p=N)):(p=p||-this.node.getContentSize().width)<(N=D+F*(U*_+this._paddingRight))&&(p=N),u+=L}}}return p}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.getComponent(JE);s&&a.activeInHierarchy&&(e?Zn.union(e,e,s.getBoundingBoxToWorld()):e=s.getBoundingBoxToWorld())}if(e){var o=this.node.parent.getComponent(JE);if(!o)return;Fi.set(fD,e.x,e.y,0);var l=new Fi;o.convertToNodeSpaceAR(fD,l),Fi.set(l,l.x-this._paddingLeft,l.y-this._paddingBottom,l.z),Fi.set(fD,e.x+e.width,e.y+e.height,0);var u=new Fi;o.convertToNodeSpaceAR(fD,u),Fi.set(u,u.x+this._paddingRight,u.y+this._paddingTop,u.z);var c=cc.size(parseFloat((u.x-l.x).toFixed(2)),parseFloat((u.y-l.y).toFixed(2)));if(this.node.getPosition(fD),0!==c.width){var h=(fD.x-l.x)/c.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==c.height){var d=(fD.y-l.y)/c.height;this.node.anchorY=parseFloat(d.toFixed(2))}this.node.setContentSize(c)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,s=this._paddingBottom;this._verticalDirection===UP.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,s=this._paddingTop);function o(e,t,i){return a+r*(t+e.anchorY*e.height*l._getUsedScaleValue(e.getScale().y)+s+i*n._spacingY)}var l=this,u=0;if(this._resizeMode===PP.CONTAINER){var c=this._doLayoutHorizontally(i,!0,o,!1);(u=a-c)<0&&(u*=-1),a=-e.y*u,this._verticalDirection===UP.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*u)}this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===PP.CONTAINER&&this.node.setContentSize(i,u)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,s=this._paddingLeft;this._horizontalDirection===GP.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,s=this._paddingRight);function o(e,t,i){return a+r*(t+e.anchorX*e.width*l._getUsedScaleValue(e.getScale().x)+s+i*n._spacingX)}var l=this,u=0;if(this._resizeMode===PP.CONTAINER){var c=this._doLayoutVertically(i,!0,o,!1);(u=a-c)<0&&(u*=-1),a=-e.x*u,this._horizontalDirection===GP.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*u)}this._doLayoutVertically(i,!0,o,!0),this._resizeMode===PP.CONTAINER&&this.node.setContentSize(u,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===FP.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===FP.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===PP.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(pD),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(pD.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===PP.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(pD),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(pD.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){if(this._N$layoutType===zP.HORIZONTAL){var e=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(e,!1,function(e){return e.getPosition(fD),fD.y},!0),this.node.width=e}else if(this._N$layoutType===zP.VERTICAL){var t=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(t,!1,function(e){return e.getPosition(fD),fD.x},!0),this.node.height=t}else this._N$layoutType===zP.NONE?this._resizeMode===PP.CONTAINER&&this._doLayoutBasic():this._N$layoutType===zP.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e===gf.POSITION_PART&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(){this._layoutDirty=this._layoutDirty||this._affectedByScale}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===zP.NONE&&e===PP.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),a}(),MP.Type=zP,MP.VerticalDirection=UP,MP.HorizontalDirection=GP,MP.ResizeMode=PP,MP.AxisDirection=FP,b((vP=IP).prototype,"type",[cP],Object.getOwnPropertyDescriptor(vP.prototype,"type"),vP.prototype),b(vP.prototype,"resizeMode",[hP],Object.getOwnPropertyDescriptor(vP.prototype,"resizeMode"),vP.prototype),b(vP.prototype,"cellSize",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"cellSize"),vP.prototype),b(vP.prototype,"startAxis",[dP],Object.getOwnPropertyDescriptor(vP.prototype,"startAxis"),vP.prototype),b(vP.prototype,"paddingLeft",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"paddingLeft"),vP.prototype),b(vP.prototype,"paddingRight",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"paddingRight"),vP.prototype),b(vP.prototype,"paddingTop",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"paddingTop"),vP.prototype),b(vP.prototype,"paddingBottom",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"paddingBottom"),vP.prototype),b(vP.prototype,"spacingX",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"spacingX"),vP.prototype),b(vP.prototype,"spacingY",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"spacingY"),vP.prototype),b(vP.prototype,"verticalDirection",[fP],Object.getOwnPropertyDescriptor(vP.prototype,"verticalDirection"),vP.prototype),b(vP.prototype,"horizontalDirection",[pP],Object.getOwnPropertyDescriptor(vP.prototype,"horizontalDirection"),vP.prototype),b(vP.prototype,"padding",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"padding"),vP.prototype),b(vP.prototype,"affectedByScale",[lo],Object.getOwnPropertyDescriptor(vP.prototype,"affectedByScale"),vP.prototype),mP=b(vP.prototype,"_resizeMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PP.NONE}}),yP=b(vP.prototype,"_N$layoutType",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zP.NONE}}),gP=b(vP.prototype,"_N$padding",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bP=b(vP.prototype,"_cellSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qn(40,40)}}),xP=b(vP.prototype,"_startAxis",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FP.HORIZONTAL}}),SP=b(vP.prototype,"_paddingLeft",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wP=b(vP.prototype,"_paddingRight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TP=b(vP.prototype,"_paddingTop",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EP=b(vP.prototype,"_paddingBottom",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CP=b(vP.prototype,"_spacingX",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AP=b(vP.prototype,"_spacingY",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kP=b(vP.prototype,"_verticalDirection",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UP.TOP_TO_BOTTOM}}),RP=b(vP.prototype,"_horizontalDirection",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GP.LEFT_TO_RIGHT}}),OP=b(vP.prototype,"_affectedByScale",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_P=vP))||_P)||_P)||_P)||_P));cc.LayoutComponent=_D,(jP=qP=qP||{})[jP.BUTT=0]="BUTT",jP[jP.ROUND=1]="ROUND",jP[jP.SQUARE=2]="SQUARE",mt(qP),(YP=XP=XP||{})[YP.BEVEL=0]="BEVEL",YP[YP.ROUND=1]="ROUND",YP[YP.MITER=2]="MITER",mt(XP),(QP=KP=KP||{})[QP.PT_CORNER=1]="PT_CORNER",QP[QP.PT_LEFT=2]="PT_LEFT",QP[QP.PT_BEVEL=4]="PT_BEVEL",QP[QP.PT_INNERBEVEL=8]="PT_INNERBEVEL",mt(KP);var vD,mD,yD,gD,bD,xD,SD,wD,TD,ED,CD,AD,kD,RD=q3("GraphicsComponent",(ZP=oo("cc.GraphicsComponent"),JP=_o(110),$P=po("UI/Render/Graphics"),eD=lo({type:XP}),tD=lo({type:qP}),iD=lo({override:!0,visible:!1}),ZP(nD=JP(nD=$P((dD=hD=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).impl=null,e.model=null,m(e,"_lineWidth",aD,l(e)),m(e,"_strokeColor",sD,l(e)),m(e,"_lineJoin",oD,l(e)),m(e,"_lineCap",lD,l(e)),m(e,"_fillColor",uD,l(e)),m(e,"_miterLimit",cD,l(e)),e._instanceMaterialType=VC.ADDCOLOR,e}return p(t,xA),v(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color}}]),v(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){_(g(t.prototype),"__preload",this)&&_(g(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=qE.root.ui.getRenderSceneGetter()}},{key:"onEnable",value:function(){_(g(t.prototype),"onEnable",this).call(this),this.model&&(this.model.enabled=!0),this._activateMaterial()}},{key:"onDisable",value:function(){this.model&&(this.model.enabled=!1)}},{key:"onDestroy",value:function(){_(g(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this._getRenderScene().destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.impl&&(this.impl.clear(t),this.model&&(this.model.scene.destroyModel(this.model),this.model=null),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"helpInstanceMaterial",value:function(){var e=null;this._sharedMaterial?e=fm.getInstantiatedMaterial(this._sharedMaterial,new ox,!1):((e=fm.getInstantiatedMaterial(G_.get("ui-base-material"),new ox,!1)).recompileShaders({USE_LOCAL:!0}),e.onLoaded()),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!_(g(t.prototype),"_canRender",this).call(this)&&!!this.model}}]),t}(),hD.LineJoin=XP,hD.LineCap=qP,b((rD=dD).prototype,"lineJoin",[eD],Object.getOwnPropertyDescriptor(rD.prototype,"lineJoin"),rD.prototype),b(rD.prototype,"lineCap",[tD],Object.getOwnPropertyDescriptor(rD.prototype,"lineCap"),rD.prototype),b(rD.prototype,"strokeColor",[lo],Object.getOwnPropertyDescriptor(rD.prototype,"strokeColor"),rD.prototype),b(rD.prototype,"fillColor",[lo],Object.getOwnPropertyDescriptor(rD.prototype,"fillColor"),rD.prototype),b(rD.prototype,"miterLimit",[lo],Object.getOwnPropertyDescriptor(rD.prototype,"miterLimit"),rD.prototype),b(rD.prototype,"color",[iD],Object.getOwnPropertyDescriptor(rD.prototype,"color"),rD.prototype),aD=b(rD.prototype,"_lineWidth",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sD=b(rD.prototype,"_strokeColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.BLACK.clone()}}),oD=b(rD.prototype,"_lineJoin",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XP.MITER}}),lD=b(rD.prototype,"_lineCap",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qP.BUTT}}),uD=b(rD.prototype,"_fillColor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),cD=b(rD.prototype,"_miterLimit",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),nD=rD))||nD)||nD)||nD));cc.GraphicsComponent=RD;var OD,MD,ID=new zn,LD=new Mi,zD=new zn,BD=[];(MD=OD=OD||{})[MD.RECT=0]="RECT",MD[MD.ELLIPSE=1]="ELLIPSE",mt(OD);var PD,DD,FD,ND,UD,VD,GD,HD,WD,qD,jD,XD,YD,KD,QD,ZD,JD,$D=q3("MaskComponent",(vD=oo("cc.MaskComponent"),mD=_o(110),yD=po("UI/Render/Mask"),gD=lo({type:OD,displayOrder:4}),bD=lo({visible:!1,override:!0}),xD=lo({visible:!1,override:!0}),SD=lo({visible:!1,override:!0}),vD(wD=mD(wD=yD((kD=AD=function(){function i(){var e;return y(this,i),m(e=x(this,g(i).call(this)),"_type",ED,l(e)),m(e,"_segments",CD,l(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=VC.ADDCOLOR,e}return p(i,xA),v(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._activateMaterial())}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments=pi(e,3,1e4),this._updateGraphics()}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),v(i,[{key:"onLoad",value:function(){this._createGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){_(g(i.prototype),"onEnable",this).call(this),this._flushVisibility(),this._clearGraphics&&this._clearGraphics.onEnable(),this._updateGraphics(),this._activateMaterial(),this.node.on(gf.TRANSFORM_CHANGED,this._nodeStateChange,this),Tm.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){_(g(i.prototype),"onDisable",this).call(this),this._disableGraphics(),this.node.off(gf.TRANSFORM_CHANGED,this._nodeStateChange),Tm.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){_(g(i.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=LD;this.node.getWorldMatrix(ID),zn.invert(zD,ID),Mi.transformMat4(a,e,zD);var s=t.getAnchorPoint();a.x+=s.x*n,a.y+=s.y*r;var o=!1;if(this.type===OD.RECT)o=0<=a.x&&0<=a.y&&a.x<=n&&a.y<=r;else if(this.type===OD.ELLIPSE){var l=n/2,u=r/2,c=a.x-.5*n,h=a.y-.5*r;o=c*c/(l*l)+h*h/(u*u)<1}return o}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){e!==gf.POSITION_PART&&(_(g(i.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics())}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!_(g(i.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this),t=i.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_parentChanged",value:function(e){return!!_(g(i.prototype),"_parentChanged",this).call(this,e)&&(this._flushVisibility(),!0)}},{key:"_onTextureLoaded",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderData.vertDirty=!0),this.enabledInHierarchy&&this._activateMaterial()}},{key:"_applySpriteFrame",value:function(e){}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=this._clearGraphics=new RD;e.node=new f_("clear-graphics"),e.helpInstanceMaterial(),e._activateMaterial(),e.lineWidth=0;var t=rr.WHITE.clone();t.a=0,e.fillColor=t,e.simulate=!0,this._updateClearGraphics()}if(!this._graphics){var i=this._graphics=new RD;i.node=this.node,i.node.getWorldMatrix(),i.helpInstanceMaterial(),i.lineWidth=0;var n=rr.WHITE.clone();n.a=0,i.fillColor=n}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=Gl;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),s=-n*a.x,o=-r*a.y;if(this._type===OD.RECT)t.rect(s,o,n,r);else if(this._type===OD.ELLIPSE){for(var l=function(e,t,i){BD.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)BD.push(new Fi(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return BD}(new Fi(s+n/2,o+r/2,0),new Fi(n/2,r/2,0),this._segments),u=0;u<l.length;++u){var c=l[u];0===u?t.moveTo(c.x,c.y):t.lineTo(c.x,c.y)}t.close()}t.fill()}}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},{key:"_flushVisibility",value:function(){this._clearGraphics&&this._clearGraphics._setScreen(this._screen),this._graphics&&this._graphics._setScreen(this._screen)}},{key:"_activateMaterial",value:function(){}}]),i}(),AD.Type=OD,b((TD=kD).prototype,"type",[gD],Object.getOwnPropertyDescriptor(TD.prototype,"type"),TD.prototype),b(TD.prototype,"segments",[lo],Object.getOwnPropertyDescriptor(TD.prototype,"segments"),TD.prototype),b(TD.prototype,"dstBlendFactor",[bD],Object.getOwnPropertyDescriptor(TD.prototype,"dstBlendFactor"),TD.prototype),b(TD.prototype,"srcBlendFactor",[xD],Object.getOwnPropertyDescriptor(TD.prototype,"srcBlendFactor"),TD.prototype),b(TD.prototype,"color",[SD],Object.getOwnPropertyDescriptor(TD.prototype,"color"),TD.prototype),ED=b(TD.prototype,"_type",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OD.RECT}}),CD=b(TD.prototype,"_segments",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),wD=TD))||wD)||wD)||wD));cc.MaskComponent=$D,(JD=ZD=ZD||{})[JD.HORIZONTAL=0]="HORIZONTAL",JD[JD.VERTICAL=1]="VERTICAL",JD[JD.FILLED=2]="FILLED",vt(ZD);var eF,tF,iF,nF,rF=q3("ProgressBarComponent",(PD=oo("cc.ProgressBarComponent"),DD=_o(110),FD=po("UI/ProgressBar"),ND=lo({type:RA}),UD=lo({type:ZD}),VD=lo({range:[0,1,.1],slide:!0}),PD(GD=DD(GD=FD((QD=KD=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_barSprite",WD,l(t)),m(t,"_mode",qD,l(t)),m(t,"_totalLength",jD,l(t)),m(t,"_progress",XD,l(t)),m(t,"_reverse",YD,l(t)),t}return p(a,rp),v(a,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===RA.FillType.RADIAL&&(this._mode=ZD.FILLED),this._mode===ZD.HORIZONTAL?this.totalLength=n.width:this._mode===ZD.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new Mi(0,.5),a=_i(this._progress),s=this._totalLength*a,o=i,l=0,u=0;switch(this._mode){case ZD.HORIZONTAL:this._reverse&&(r=new Mi(1,.5)),o=new qn(s,i.height),l=this._totalLength,u=i.height;break;case ZD.VERTICAL:r=this._reverse?new Mi(.5,1):new Mi(.5,0),o=new qn(i.width,s),l=i.width,u=this._totalLength}if(this._mode===ZD.FILLED)this._barSprite.type!==RA.Type.FILLED?C("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==RA.Type.FILLED){var c=r.x-t.x,h=r.y-t.y,d=new Fi(l*c,u*h,0);e.setPosition(n.x+d.x,n.y+d.y,n.z),e.setAnchorPoint(r),e.setContentSize(o)}else C("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===ZD.HORIZONTAL?this.totalLength=i.width:this._mode===ZD.VERTICAL?this.totalLength=i.height:this._mode===ZD.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===ZD.FILLED&&(e=_i(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),a}(),KD.Mode=ZD,b((HD=QD).prototype,"barSprite",[ND],Object.getOwnPropertyDescriptor(HD.prototype,"barSprite"),HD.prototype),b(HD.prototype,"mode",[UD],Object.getOwnPropertyDescriptor(HD.prototype,"mode"),HD.prototype),b(HD.prototype,"totalLength",[lo],Object.getOwnPropertyDescriptor(HD.prototype,"totalLength"),HD.prototype),b(HD.prototype,"progress",[VD],Object.getOwnPropertyDescriptor(HD.prototype,"progress"),HD.prototype),b(HD.prototype,"reverse",[lo],Object.getOwnPropertyDescriptor(HD.prototype,"reverse"),HD.prototype),WD=b(HD.prototype,"_barSprite",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qD=b(HD.prototype,"_mode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZD.HORIZONTAL}}),jD=b(HD.prototype,"_totalLength",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XD=b(HD.prototype,"_progress",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),YD=b(HD.prototype,"_reverse",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GD=HD))||GD)||GD)||GD));cc.ProgressBarComponent=rF;var aF,sF,oF,lF,uF,cF,hF,dF,fF,pF,_F,vF,mF,yF,gF,bF,xF,SF,wF,TF=q3("LabelOutlineComponent",oo("cc.LabelOutlineComponent")(eF=_o(110)(eF=po("UI/Render/LabelOutline")((iF=b((tF=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_color",iF,l(t)),m(t,"_width",nF,l(t)),t}return p(a,rp),v(a,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(mB);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),a}()).prototype,"_color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rr(255,255,255,255)}}),nF=b(tF.prototype,"_width",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b(tF.prototype,"color",[lo],Object.getOwnPropertyDescriptor(tF.prototype,"color"),tF.prototype),b(tF.prototype,"width",[lo],Object.getOwnPropertyDescriptor(tF.prototype,"width"),tF.prototype),eF=tF))||eF)||eF)||eF);cc.LabelOutlineComponent=TF;var EF=new Ks,CF="RICHTEXT_CHILD",AF="RICHTEXT_Image_CHILD";var kF=new Je(function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(TF)},20);kF.get=function(e,t){var i=this._get(),n=(i=i||{node:new PS(CF),comp:null,lineCount:0,styleIndex:0,clickHandler:""}).node,r=(n=n||new PS(CF)).getComponent(mB);return r=r=r||n.addComponent(mB),n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof Ng?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=tB.LEFT,r.verticalAlign=nB.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var RF,OF,MF,IF,LF,zF,BF,PF,DF,FF,NF,UF,VF,GF,HF=q3("RichTextComponent",(aF=oo("cc.RichTextComponent"),sF=_o(110),oF=po("UI/Render/RichText"),lF=lo({multiline:!0}),uF=lo({type:tB}),cF=lo({type:Yg}),hF=lo({type:wy}),aF(dF=sF(dF=oF(dF=ho((wF=SF=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_lineHeight",pF,l(e)),m(e,"_string",_F,l(e)),m(e,"_horizontalAlign",vF,l(e)),m(e,"_fontSize",mF,l(e)),m(e,"_maxWidth",yF,l(e)),m(e,"_font",gF,l(e)),m(e,"_imageAtlas",bF,l(e)),m(e,"_handleTouchEvent",xF,l(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return p(t,HC),v(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),v(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded()}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.node.removeFromParent(),kF.put(r)}}},{key:"_addEventListeners",value:function(){this.node.on(f_.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(f_.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var t=this;this._labelSegments.forEach(function(e){t._applyTextAttribute(e)})}},{key:"_createFontLabel",value:function(e){return kF.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof Yg)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var i=this;Bb.load(this._font.nativeUrl,function(e,t){i._layoutDirty=!0,i._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(i,e){function t(e){var t;return 0===n._labelSegmentsCache.length?(t=n._createFontLabel(e),n._labelSegmentsCache.push(t)):(t=n._labelSegmentsCache[0]).node.getComponent(mB).string=e,t.styleIndex=i,n._applyTextAttribute(t),t.node.getContentSize().width}var n=this;return e?t(e):t}},{key:"_onTouchEnded",value:function(n){var t=this,r=this.node.getComponents(HC),a=this,e=function(){if(o){if(l>=s.length)return"break";u=s[l++]}else{if((l=s.next()).done)return"break";u=l.value}var e=u,i=e.clickHandler;i&&t._containsTouchLocation(e,n.touch.getUILocation())&&(r.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(a,n)}),n.propagationStopped=!0)},s=this._labelSegments,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if("break"===e())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(JE);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var n=this,r=this.node.children,e=function(e){var t=r[e];if((t.name===CF||t.name===AF)&&(t.parent===n.node?t.parent=null:r.splice(e,1),t.name===CF)){var i=n._labelSegments.findIndex(function(e){return e.node===t});-1!==i&&kF.put(n._labelSegments[i])}},t=r.length-1;0<=t;t--)e(t);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==CF&&i.name!==AF||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(mB);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(0<this._lineOffsetX&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),o=this._measureText(i,s);if(!(this._lineOffsetX+o<=this.maxWidth)){if(0<r){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=a}if(n>this.maxWidth)for(var u=js(e,n,this.maxWidth,this._measureText(i)),c=0;c<u.length;++c){var h=u[c],d=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=d.width,1<u.length&&c<u.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new PS(AF),r=n.addComponent(RA);n.setAnchorPoint(0,0),r.type=RA.Type.SLICED,r.sizeMode=RA.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var s=i.getRect(),o=1,l=s.width,u=s.height,c=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&0<h&&h<this.lineHeight?l*=o=h/u:l*=o=this.lineHeight/u,u*=o,void 0!==c&&0<c&&(l=c),0<this.maxWidth?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,u),a.lineCount=this._lineCount,e.style.event){e.style.event.click&&(a.clickHandler=e.style.event.click)}}else B(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=EF.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var s=a.split("\n"),o=0;o<s.length;++o){var l=s[o];if(""!==l)if(i=!1,0<this.maxWidth){var u=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,u,n),1<s.length&&o<s.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),1<s.length&&o<s.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&o===s.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),0<this.maxWidth&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(Hs(n)||Ws(n))return 1;for(var r=1,a=t+1;a<i&&(!Ws(n=e.charAt(a))&&!Hs(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,n=this._labelSegments,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.lineCount;t<l&&(e=0,t=l);var u=0;switch(this.horizontalAlign){case tB.LEFT:u=-this._labelWidth/2;break;case tB.CENTER:u=-this._linesWidth[l-1]/2;break;case tB.RIGHT:u=this._labelWidth/2-this._linesWidth[l-1]}var c=o.node.getContentSize(),h=o.node.getPosition();o.node.setPosition(e+u,this.lineHeight*(i-l)-this._labelHeight/2,h.z),l===t&&(e+=c.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return rr[t]?rr[t]:(new rr).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(mB);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=tB.LEFT,t.verticalAlign=nB.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(mB);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent(TF);(a=a||e.node.addComponent(TF)).color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){i.event.click&&(e.clickHandler=i.event.click)}}}}]),t}(),SF.HorizontalAlign=tB,SF.VerticalAlign=nB,b((fF=wF).prototype,"string",[lF],Object.getOwnPropertyDescriptor(fF.prototype,"string"),fF.prototype),b(fF.prototype,"horizontalAlign",[uF],Object.getOwnPropertyDescriptor(fF.prototype,"horizontalAlign"),fF.prototype),b(fF.prototype,"fontSize",[lo],Object.getOwnPropertyDescriptor(fF.prototype,"fontSize"),fF.prototype),b(fF.prototype,"font",[cF],Object.getOwnPropertyDescriptor(fF.prototype,"font"),fF.prototype),b(fF.prototype,"maxWidth",[lo],Object.getOwnPropertyDescriptor(fF.prototype,"maxWidth"),fF.prototype),b(fF.prototype,"lineHeight",[lo],Object.getOwnPropertyDescriptor(fF.prototype,"lineHeight"),fF.prototype),b(fF.prototype,"imageAtlas",[hF],Object.getOwnPropertyDescriptor(fF.prototype,"imageAtlas"),fF.prototype),b(fF.prototype,"handleTouchEvent",[lo],Object.getOwnPropertyDescriptor(fF.prototype,"handleTouchEvent"),fF.prototype),pF=b(fF.prototype,"_lineHeight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),_F=b(fF.prototype,"_string",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),vF=b(fF.prototype,"_horizontalAlign",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tB.LEFT}}),mF=b(fF.prototype,"_fontSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),yF=b(fF.prototype,"_maxWidth",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gF=b(fF.prototype,"_font",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bF=b(fF.prototype,"_imageAtlas",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xF=b(fF.prototype,"_handleTouchEvent",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dF=fF))||dF)||dF)||dF)||dF));cc.RichTextComponent=HF;var WF,qF,jF=new Fi,XF=new Fi,YF=new Fi,KF=new Mi,QF=new rr;(qF=WF=WF||{})[qF.HORIZONTAL=0]="HORIZONTAL",qF[qF.VERTICAL=1]="VERTICAL",mt(WF);var ZF,JF=q3("ScrollBarComponent",(RF=oo("cc.ScrollBarComponent"),OF=_o(110),MF=po("UI/ScrollBar"),IF=lo({type:RA}),LF=lo({type:WF}),RF(zF=OF(zF=MF((GF=VF=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_scrollView",PF,l(t)),m(t,"_handle",DF,l(t)),m(t,"_direction",FF,l(t)),m(t,"_enableAutoHide",NF,l(t)),m(t,"_autoHideTime",UF,l(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}return p(a,rp),v(a,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,s=0,o=0,l=0,u=0;this._direction===WF.HORIZONTAL?(a=i.width,s=n.width,u=r.width,o=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===WF.VERTICAL&&(a=i.height,s=n.height,u=r.height,o=e.y,l=-this._convertToScrollViewSpace(t).y);var c=this._calculateLength(a,s,u,o),h=this._calculatePosition(a,s,u,l,o,c);this._updateLength(c),this._updateHanlderPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(RA);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return jF;var t=e.getAnchorPoint(),i=e.getContentSize(),n=new Fi(-t.x*i.width,-t.y*i.height,0);return e.uiTransfromComp.convertToWorldSpaceAR(n,n),t=this._scrollView.node.getAnchorPoint(),i=this._scrollView.node.getContentSize(),n.x+=t.x*i.width,n.y+=t.y*i.height,this._scrollView.node.uiTransfromComp.convertToNodeSpaceAR(n,n),n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(RA);t&&(QF.set(t.color),QF.a=e,t.color=QF),(t=this._handle.getComponent(RA))&&(QF.set(t.color),QF.a=e,t.color=QF)}}},{key:"_updateHanlderPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;Fi.set(XF,-e.width*t.x,-e.height*t.y,0);var r=this.node.uiTransfromComp.convertToWorldSpaceAR(XF,YF),a=new Fi;return n.uiTransfromComp.convertToNodeSpaceAR(r,a),this.direction===WF.HORIZONTAL?a=new Fi(a.x,a.y+(e.height-i.height)/2,0):this.direction===WF.VERTICAL&&(a=new Fi(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===WF.HORIZONTAL||e.height<=t.height&&this._direction===WF.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(0<n?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var s=e-t;r&&(s+=Math.abs(r));var o=0;s&&(o=_i(o=n/s));var l=(i-a)*o;return this._direction===WF.VERTICAL?new Fi(0,l,0):new Fi(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===KF.x&&n.y===KF.y||t.setAnchorPoint(KF),this._direction===WF.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(new Fi(0,0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Fi))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),a}(),VF.Direction=WF,b((BF=GF).prototype,"handle",[IF],Object.getOwnPropertyDescriptor(BF.prototype,"handle"),BF.prototype),b(BF.prototype,"direction",[LF],Object.getOwnPropertyDescriptor(BF.prototype,"direction"),BF.prototype),b(BF.prototype,"enableAutoHide",[lo],Object.getOwnPropertyDescriptor(BF.prototype,"enableAutoHide"),BF.prototype),b(BF.prototype,"autoHideTime",[lo],Object.getOwnPropertyDescriptor(BF.prototype,"autoHideTime"),BF.prototype),PF=b(BF.prototype,"_scrollView",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DF=b(BF.prototype,"_handle",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FF=b(BF.prototype,"_direction",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WF.HORIZONTAL}}),NF=b(BF.prototype,"_enableAutoHide",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UF=b(BF.prototype,"_autoHideTime",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zF=BF))||zF)||zF)||zF));cc.ScrollBarComponent=JF;var $F,eN,tN,iN,nN,rN,aN,sN,oN,lN,uN,cN,hN,dN,fN,pN,_N,vN,mN,yN,gN,bN,xN,SN,wN=q3("ViewGroupComponent",oo("cc.ViewGroupComponent")(ZF=_o(110)(ZF=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,rp),e}())||ZF)||ZF);cc.ViewGroupComponent=wN;function TN(){return(new Date).getMilliseconds()}var EN,CN,AN=1e-4,kN=new Fi,RN=new Fi,ON=new Mi,MN=new Mi;(CN=EN=EN||{})[CN.SCROLL_TO_TOP=0]="SCROLL_TO_TOP",CN[CN.SCROLL_TO_BOTTOM=1]="SCROLL_TO_BOTTOM",CN[CN.SCROLL_TO_LEFT=2]="SCROLL_TO_LEFT",CN[CN.SCROLL_TO_RIGHT=3]="SCROLL_TO_RIGHT",CN[CN.SCROLLING=4]="SCROLLING",CN[CN.BOUNCE_TOP=5]="BOUNCE_TOP",CN[CN.BOUNCE_BOTTOM=6]="BOUNCE_BOTTOM",CN[CN.BOUNCE_LEFT=7]="BOUNCE_LEFT",CN[CN.BOUNCE_RIGHT=8]="BOUNCE_RIGHT",CN[CN.SCROLL_ENDED=9]="SCROLL_ENDED",CN[CN.TOUCH_UP=10]="TOUCH_UP",CN[CN.AUTOSCROLL_ENDED_WITH_THRESHOLD=11]="AUTOSCROLL_ENDED_WITH_THRESHOLD",CN[CN.SCROLL_BEGAN=12]="SCROLL_BEGAN",mt(EN);var IN,LN,zN,BN,PN,DN,FN,NN,UN,VN,GN,HN,WN,qN,jN,XN={"scroll-to-top":EN.SCROLL_TO_TOP,"scroll-to-bottom":EN.SCROLL_TO_BOTTOM,"scroll-to-left":EN.SCROLL_TO_LEFT,"scroll-to-right":EN.SCROLL_TO_RIGHT,scrolling:EN.SCROLLING,"bounce-bottom":EN.BOUNCE_BOTTOM,"bounce-left":EN.BOUNCE_LEFT,"bounce-right":EN.BOUNCE_RIGHT,"bounce-top":EN.BOUNCE_TOP,"scroll-ended":EN.SCROLL_ENDED,"touch-up":EN.TOUCH_UP,"scroll-ended-with-threshold":EN.AUTOSCROLL_ENDED_WITH_THRESHOLD,"scroll-began":EN.SCROLL_BEGAN},YN=q3("ScrollViewComponent",($F=oo("cc.ScrollViewComponent"),eN=_o(110),tN=po("UI/ScrollView"),iN=lo({type:f_}),nN=lo({type:JF}),rN=lo({type:JF}),aN=lo({range:[0,1,.1]}),sN=lo({range:[0,10]}),oN=lo({type:[$A]}),$F(lN=eN(lN=tN((SN=xN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"horizontal",cN,l(t)),m(t,"vertical",hN,l(t)),m(t,"inertia",dN,l(t)),m(t,"brake",fN,l(t)),m(t,"elastic",pN,l(t)),m(t,"bounceDuration",_N,l(t)),m(t,"scrollEvents",vN,l(t)),m(t,"cancelInnerEvents",mN,l(t)),t._autoScrolling=!1,t._scrolling=!1,m(t,"_content",yN,l(t)),m(t,"_horizontalScrollBar",gN,l(t)),m(t,"_verticalScrollBar",bN,l(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Fi,t._autoScrollTargetDelta=new Fi,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Fi,t._outOfBoundaryAmount=new Fi,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Fi,t._deltaPos=new Fi,t}return p(a,wN),v(a,[{key:"scrollToBottom",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Mi(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t,i){var n=this.getMaxScrollOffset(),r=new Mi(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Fi(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node.getContentSize(),t=this._content.getContentSize(),i=t.width-e.width,n=t.height-e.height;return new Fi(i=0<=i?i:0,n=0<=n?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Mi(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){e.equals(this.getContentPosition(),AN)||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._content.getPosition(this._contentPos),this._contentPos):kN}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return AN}},{key:"start",value:function(){this._calculateBoundary(),this._content&&qE.once(lE.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(f_.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(f_.EventType.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.on(f_.EventType.POSITION_PART,this._calculateBoundary,this),this.view.on(f_.EventType.SCALE_PART,this._calculateBoundary,this),this.view.on(f_.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._showScrollbar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(f_.EventType.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(f_.EventType.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.off(f_.EventType.POSITION_PART,this._calculateBoundary,this),this.view.off(f_.EventType.SCALE_PART,this._calculateBoundary,this),this.view.off(f_.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollbar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(f_.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(f_.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(f_.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(f_.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(f_.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(f_.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(f_.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(f_.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(f_.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(f_.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Fi;this.vertical?i=new Fi(0,-.1*e.getScrollY(),0):this.horizontal&&(i=new Fi(-.1*e.getScrollY(),0,0)),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var n=i.getUILocation(ON);if(n.subtract(i.getUIStartLocation(MN)),7<n.length()&&!this._touchMoved&&e.target!==this.node){var r=new Tf(e.getTouches(),e.bubbles);r.type=f_.EventType.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent("touch-up");var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(_D);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view.getContentSize(),i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===Sl.CAPTURING_PHASE){if(t){var i=t,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(this.node===s)return!(!e.target||!e.target.getComponent(wN));if(s.getComponent(wN))return!0}}return!1}}},{key:"_handleReleaseLogic",value:function(e){var t=e.getUIDelta();Fi.set(this._deltaPos,t.x,t.y,0),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_startInertiaScroll",value:function(e){var t=new Fi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitalSpeed(t.length()),n=new Fi(e);n.normalize();var r=this._content.getContentSize(),a=this.node.getContentSize(),s=r.width-a.width,o=r.height-a.height,l=this._calculateAttenuatedFactor(s),u=this._calculateAttenuatedFactor(o);n.x=n.x*s*(1-this.brake)*l,n.y=n.y*o*u*(1-this.brake),n.z=0;var c=e.length(),h=n.length()/c;if(n.add(e),0<this.brake&&7<h){h=Math.sqrt(h);var d=new Fi(e);d.multiplyScalar(h),n.set(d),n.add(e)}0<this.brake&&3<h&&(i*=h=3),0===this.brake&&1<h&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitalSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t,i){var n=2<arguments.length&&void 0!==i&&i,r=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=r,this._autoScrollAttenuate=n,Fi.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Fi,this._getHowMuchOutOfBoundary().equals(kN,AN)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},e))<=0||.5<=e)return new Fi;var t=new Fi;return t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t),e},t),new Fi(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);RN.set(this.getContentPosition()),RN.add(i),this.setContentPosition(RN);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.getAnchorPoint().x*this._content.getContentSize().width}},{key:"_getContentRightBoundary",value:function(){var e=this._content.getContentSize();return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){var e=this._content.getContentSize();return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.getAnchorPoint().y*this._content.getContentSize().height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Fi).equals(kN,AN)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Fi;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(kN,AN)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if("scroll-ended"===e)this._scrollEventEmitMask=0;else if("scroll-to-top"===e||"scroll-to-bottom"===e||"scroll-to-left"===e||"scroll-to-right"===e){var t=1<<XN[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}$A.emitEvents(this.scrollEvents,this,XN[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();RN.set(this.getContentPosition()),RN.add(e),this._content&&(this._content.setPosition(RN),this._updateScrollBar(kN))}}},{key:"_hideScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this.verticalScrollBar&&this.verticalScrollBar.hide()}},{key:"_showScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this.verticalScrollBar&&this.verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===Sl.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){var t=e.getUIDelta();Fi.set(this._deltaPos,t.x,t.y,0),this._processDeltaMove(this._deltaPos)}},{key:"_scrollChildren",value:function(e){var t,i=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t));var n="",r=new Fi;if(this._content.getPosition(r),0<i.y)r.y-this._content.anchorY*this._content.height+i.y>this._bottomBoundary&&(n="scroll-to-bottom");else if(i.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+i.y<=this._topBoundary&&(n="scroll-to-top")}else if(i.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+i.x<=this._rightBoundary&&(n="scroll-to-right")}else if(0<i.x){r.x-this._content.anchorX*this._content.width+i.x>=this._leftBoundary&&(n="scroll-to-left")}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent("scroll-began")),this._dispatchEvent("scrolling")),0<n.length&&this._dispatchEvent(n)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent("scroll-ended"),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=TN(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content.getContentSize(),i=this.node.getContentSize();return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);5<=this._touchMoveDisplacements.length;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var i=TN();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals(kN,AN))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent("bounce-top"),e.y<0&&this._dispatchEvent("bounce-bottom"),0<e.x&&this._dispatchEvent("bounce-right"),e.x<0&&this._dispatchEvent("bounce-left"),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(RN,AN)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(kN,AN)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=function(e){return(e-=1)*e*e*e*e+1}(n));var r=new Fi(this._autoScrollTargetDelta);r.multiplyScalar(n);var a=new Fi(this._autoScrollStartPosition);a.add(r);var s=Math.abs(n-1)<=AN;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent("scroll-ended-with-threshold"),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var o=new Fi(a);o.subtract(this._autoScrollBrakingStartPosition),t&&o.multiplyScalar(i),a.set(this._autoScrollBrakingStartPosition),a.add(o)}else{var l=new Fi(a);l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(kN,AN)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var c=new Fi(a);c.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(c),s),this._dispatchEvent("scrolling"),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent("scroll-ended"))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(kN,AN))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new Mi(0,0),new Mi(1,1));var r=this.node.getContentSize(),a=this._content.getContentSize(),s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var l=new Fi,u=0;return i&&(u=a.width-r.width,l.x=o-u*t.x),n&&(u=a.height-r.height,l.y=s-u*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content.getContentSize(),i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new Fi,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(kN)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(kN)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),a}(),xN.EventType=EN,b((uN=SN).prototype,"content",[iN],Object.getOwnPropertyDescriptor(uN.prototype,"content"),uN.prototype),b(uN.prototype,"horizontalScrollBar",[nN],Object.getOwnPropertyDescriptor(uN.prototype,"horizontalScrollBar"),uN.prototype),b(uN.prototype,"verticalScrollBar",[rN],Object.getOwnPropertyDescriptor(uN.prototype,"verticalScrollBar"),uN.prototype),cN=b(uN.prototype,"horizontal",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hN=b(uN.prototype,"vertical",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dN=b(uN.prototype,"inertia",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fN=b(uN.prototype,"brake",[aN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),pN=b(uN.prototype,"elastic",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_N=b(uN.prototype,"bounceDuration",[sN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),vN=b(uN.prototype,"scrollEvents",[oN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mN=b(uN.prototype,"cancelInnerEvents",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yN=b(uN.prototype,"_content",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gN=b(uN.prototype,"_horizontalScrollBar",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bN=b(uN.prototype,"_verticalScrollBar",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lN=uN))||lN)||lN)||lN));cc.ScrollViewComponent=YN;var KN,QN,ZN=new Fi;(QN=KN=KN||{})[QN.Horizontal=0]="Horizontal",QN[QN.Vertical=1]="Vertical",mt(KN);var JN,$N,eU,tU,iU,nU,rU,aU,sU=q3("SliderComponent",(IN=oo("cc.SliderComponent"),LN=_o(110),zN=po("UI/Slider"),BN=lo({type:RA}),PN=lo({type:KN}),DN=lo({slide:!0,range:[0,1,.01]}),FN=lo({type:$A}),IN(NN=LN(NN=zN((jN=qN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"slideEvents",VN,l(t)),m(t,"_handle",GN,l(t)),m(t,"_direction",HN,l(t)),m(t,"_progress",WN,l(t)),t._offset=new Fi,t._dragging=!1,t._touchHandle=!1,t._handlelocalPos=new Fi,t._touchPos=new Fi,t}return p(a,rp),v(a,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(gf.TOUCH_START,this._onTouchBegan,this),this.node.on(gf.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(gf.TOUCH_END,this._onTouchEnded,this),this.node.on(gf.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(gf.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(gf.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(gf.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(gf.TOUCH_START,this._onTouchBegan,this),this.node.off(gf.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(gf.TOUCH_END,this._onTouchEnded,this),this.node.off(gf.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(gf.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(gf.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(gf.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node.uiTransfromComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Fi.set(this._touchPos,t.x,t.y,0),this._handle.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Fi,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){$A.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Fi.set(this._touchPos,t.x,t.y,0);var i=this.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,ZN);this.direction===KN.Horizontal?this.progress=_i(.5+(i.x-this._offset.x)/this.node.width):this.progress=_i(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===KN.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"_changeLayout",value:function(){var e=this.node.getContentSize();if(this.node.setContentSize(e.height,e.width),this._handle){var t=this._handle.node.position;this._direction===KN.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),a}(),qN.Direction=KN,b((UN=jN).prototype,"handle",[BN],Object.getOwnPropertyDescriptor(UN.prototype,"handle"),UN.prototype),b(UN.prototype,"direction",[PN],Object.getOwnPropertyDescriptor(UN.prototype,"direction"),UN.prototype),b(UN.prototype,"progress",[DN],Object.getOwnPropertyDescriptor(UN.prototype,"progress"),UN.prototype),VN=b(UN.prototype,"slideEvents",[FN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GN=b(UN.prototype,"_handle",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HN=b(UN.prototype,"_direction",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KN.Horizontal}}),WN=b(UN.prototype,"_progress",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),NN=UN))||NN)||NN)||NN));cc.SliderComponent=sU;var oU,lU,uU,cU,hU,dU,fU,pU,_U,vU,mU,yU,gU=q3("ToggleContainerComponent",(JN=oo("cc.ToggleContainerComponent"),$N=_o(110),eU=po("UI/ToggleContainer"),tU=lo({type:[$A]}),JN(iU=$N(iU=eU(iU=ho((rU=b((nU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"checkEvents",rU,l(t)),m(t,"_allowSwitchOff",aU,l(t)),t._toggleItems=[],t}return p(a,rp),v(a,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(t){this.enabledInHierarchy&&t.isChecked&&(this.toggleItems.forEach(function(e){e!==t&&e.isChecked&&e.enabled&&(e.isChecked=!1)}),this.checkEvents&&$A.emitEvents(this.checkEvents,t))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);-1<t&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var t=!1;return this._toggleItems.forEach(function(e){t&&e.enabled&&(e.isChecked=!1),e.isChecked&&e.enabled&&(t=!0)}),t}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||0<this._toggleItems.length&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),a}()).prototype,"checkEvents",[tU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aU=b(nU.prototype,"_allowSwitchOff",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b(nU.prototype,"allowSwitchOff",[lo],Object.getOwnPropertyDescriptor(nU.prototype,"allowSwitchOff"),nU.prototype),iU=nU))||iU)||iU)||iU)||iU));cc.ToggleContainerComponent=gU;var bU,xU=q3("ToggleComponent",(oU=oo("cc.ToggleComponent"),lU=_o(110),uU=po("UI/Toggle"),cU=lo({type:gU}),hU=lo({type:RA}),dU=lo({type:[$A]}),oU(fU=lU(fU=uU((b((pU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"checkEvents",_U,l(t)),m(t,"_isChecked",vU,l(t)),m(t,"_toggleGroup",mU,l(t)),m(t,"_checkMark",yU,l(t)),t}return p(a,vz),v(a,[{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){_(g(a.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on("click",this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off("click",this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit("toggle",this),this.checkEvents&&$A.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),a}()).prototype,"isChecked",[lo],Object.getOwnPropertyDescriptor(pU.prototype,"isChecked"),pU.prototype),b(pU.prototype,"toggleGroup",[cU],Object.getOwnPropertyDescriptor(pU.prototype,"toggleGroup"),pU.prototype),b(pU.prototype,"checkMark",[hU],Object.getOwnPropertyDescriptor(pU.prototype,"checkMark"),pU.prototype),_U=b(pU.prototype,"checkEvents",[dU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vU=b(pU.prototype,"_isChecked",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mU=b(pU.prototype,"_toggleGroup",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yU=b(pU.prototype,"_checkMark",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fU=pU))||fU)||fU)||fU));cc.ToggleComponent=xU;var SU,wU,TU,EU=q3("UIModelComponent",oo("cc.UIModelComponent")(bU=_o(110)(bU=po("UI/Model")(bU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._models=null,t._modelComponent=null,t}return p(a,HC),v(a,[{key:"onLoad",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=qE.root.ui.getRenderSceneGetter(),this._modelComponent._changeSceneInModel(),this._models=this._modelComponent._collectModels()):console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onDestroy",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,cc.isValid(this.node,!0)&&this._modelComponent._changeSceneInModel(),this._models=null)}},{key:"updateAssembler",value:function(e){if(this._models){var t=this._models,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;e.commitModel.call(e,this,a,this._modelComponent.material)}return!0}return!1}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterial(t);if(null!=i){for(var n=i.passes,r=i.effectAsset,a=i.technique,s=n.length,o=!1,l=0;l<s;l++){if(!n[l].blendState.targets[0].blend)o=!0,n[l].blendState.targets[0].blend=!0,n[l].overridePipelineStates(r.techniques[a].passes[l],{blendState:n[l].blendState})}o&&i._onPassesChange()}}for(var u=0;u<e;u++){var c=this._modelComponent.getMaterial(u);if(null!=c){var h=c.passes,d=Array.isArray(h),f=0;for(h=d?h:h[Symbol.iterator]();;){var p;if(d){if(f>=h.length)break;p=h[f++]}else{if((f=h.next()).done)break;p=f.value}p._priority=lh.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),a}())||bU)||bU)||bU);cc.UIModelComponent=EU;var CU,AU,kU=new zn;(AU=CU=CU||{})[AU.LOADING=0]="LOADING",AU[AU.LOADED=1]="LOADED",AU[AU.ERROR=2]="ERROR";var RU={devicePixelRatio:!(AU[AU.JS_EVALUATED=3]="JS_EVALUATED"),enableDiv:!1};Ll.os===Ll.OS_IOS&&(RU.enableDiv=!0),Ll.isMobile?Ll.browserType===Ll.BROWSER_TYPE_FIREFOX&&(RU.enableBG=!0):Ll.browserType===Ll.BROWSER_TYPE_IE&&(RU.closeHistory=!0);var OU,MU,IU,LU,zU,BU,PU,DU,FU,NU,UU=oo("cc.WebviewImpl")((TU=wU=function(){function n(){y(this,n),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return v(n,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(ut(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(e){var t=this._iframe;if(t){t.src=e;var i=this;t.addEventListener("load",function e(){i._updateVisibility(),t.removeEventListener("load",e)}),this._dispatchEvent(n.EventType.LOADING)}}},{key:"stopLoading",value:function(){L(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return L(7801),!0}},{key:"canGoForward",value:function(){return L(7802),!0}},{key:"goBack",value:function(){try{if(n.Polyfill.closeHistory)return L(7803);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.back.call(t)}}catch(e){E(e)}}},{key:"goForward",value:function(){try{if(n.Polyfill.closeHistory)return L(7804);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.forward.call(t)}}catch(e){E(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){L(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(kU);var t=e.getContentSize();if(this._forceUpdate||this._m00!==kU.m00||this._m01!==kU.m01||this._m04!==kU.m04||this._m05!==kU.m05||this._m12!==kU.m12||this._m13!==kU.m13||this._w!==t.width||this._h!==t.height){this._m00=kU.m00,this._m01=kU.m01,this._m04=kU.m04,this._m05=kU.m05,this._m12=kU.m12,this._m13=kU.m13,this._w=t.width,this._h=t.height;var i=Tm.getScaleX(),n=Tm.getScaleY(),r=Tm.getDevicePixelRatio();i/=r,n/=r;var a=cc.game.container,s=kU.m00*i,o=kU.m01,l=kU.m04,u=kU.m05*n,c=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var d=this._div.clientWidth*i,f=this._div.clientHeight*n,p=e.getAnchorPoint(),_=d*kU.m00*p.x,v=f*kU.m05*p.y,m="matrix("+s+","+-o+","+-l+","+u+","+(kU.m12*i-_+c)+","+-(kU.m13*n-v+h)+")";this._div.style.transform=m,this._div.style["-webkit-transform"]=m,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var y=e.getComponent(xA);y&&this._setOpacity(y.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var e=this._iframe;if(e){var t=this._eventListeners,i=this;t.load=function(){i._dispatchEvent(n.EventType.LOADED)},t.error=function(){i._dispatchEvent(n.EventType.ERROR)},e.addEventListener("load",t.load),e.addEventListener("error",t.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(e,t){n.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),n.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=t+"px",this._div.style.width=e+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),n}(),wU.Polyfill=RU,wU.EventType=CU,SU=TU))||SU,VU=CU;function GU(){}var HU,WU,qU,jU,XU,YU,KU,QU,ZU,JU,$U,eV,tV,iV,nV,rV,aV,sV,oV,lV,uV,cV,hV,dV,fV,pV,_V,vV,mV,yV=q3("WebviewComponent",(OU=oo("cc.WebviewComponent"),MU=po("UI/WebView"),IU=_o(100),LU=lo({type:$A}),OU(zU=MU(zU=IU((NU=FU=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"webviewEvents",PU,l(e)),m(e,"_url",DU,l(e)),e._impl=null,e._impl=new UU,e}return p(t,HC),v(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),v(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new UU)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(VU.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(VU.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(VU.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(VU.LOADED,GU),e.setEventListener(VU.LOADING,GU),e.setEventListener(VU.ERROR,GU)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){$A.emitEvents(this.webviewEvents,this,VU.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return $A.emitEvents(this.webviewEvents,this,VU.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){$A.emitEvents(this.webviewEvents,this,VU.ERROR),this.node.emit("error",this)}}]),t}(),FU.EventType=VU,b((BU=NU).prototype,"url",[lo],Object.getOwnPropertyDescriptor(BU.prototype,"url"),BU.prototype),PU=b(BU.prototype,"webviewEvents",[LU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DU=b(BU.prototype,"_url",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zU=BU))||zU)||zU)||zU));cc.WebviewComponent=yV;var gV,bV,xV,SV,wV=new Fi;function TV(e){return e instanceof zS?Gl:e.getContentSize()}function EV(e,t,i,n){for(var r=e.parent?e.parent.getScale():wV,a=r.x,s=r.y,o=0,l=0,u=e.parent;;){if(!u)return i.x=i.y=0,void(n.x=n.y=1);var c=u.getPosition();if(o+=c.x,l+=c.y,(u=u.parent)===t)break;var h=(r=u?u.getScale():wV).x,d=r.y;o*=h,l*=d,a*=h,s*=d}n.x=0!==a?1/a:1,n.y=0!==s?1/s:1,i.x=-o,i.y=-l}(bV=gV=gV||{})[bV.ONCE=0]="ONCE",bV[bV.ALWAYS=1]="ALWAYS",mt(gV),(SV=xV=xV||{})[SV.TOP=1]="TOP",SV[SV.MID=2]="MID",SV[SV.BOT=4]="BOT",SV[SV.LEFT=8]="LEFT",SV[SV.CENTER=16]="CENTER",SV[SV.RIGHT=32]="RIGHT",SV[SV.HORIZONTAL=56]="HORIZONTAL",SV[SV.VERTICAL=7]="VERTICAL";var CV,AV=xV.TOP|xV.BOT,kV=xV.LEFT|xV.RIGHT,RV=q3("WidgetComponent",(HU=oo("cc.WidgetComponent"),WU=_o(110),qU=po("UI/Widget"),jU=fo(JE),XU=lo({type:f_}),YU=lo({visible:!1}),KU=lo({visible:!1}),QU=lo({type:gV}),HU(ZU=WU(ZU=qU(ZU=jU(ZU=ho((mV=vV=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._lastPos=new Fi,t._lastSize=new qn,t._dirty=!0,m(t,"_alignFlags",$U,l(t)),m(t,"_target",eV,l(t)),m(t,"_left",tV,l(t)),m(t,"_right",iV,l(t)),m(t,"_top",nV,l(t)),m(t,"_bottom",rV,l(t)),m(t,"_horizontalCenter",aV,l(t)),m(t,"_verticalCenter",sV,l(t)),m(t,"_isAbsLeft",oV,l(t)),m(t,"_isAbsRight",lV,l(t)),m(t,"_isAbsTop",uV,l(t)),m(t,"_isAbsBottom",cV,l(t)),m(t,"_isAbsHorizontalCenter",hV,l(t)),m(t,"_isAbsVerticalCenter",dV,l(t)),m(t,"_originalWidth",fV,l(t)),m(t,"_originalHeight",pV,l(t)),m(t,"_alignMode",_V,l(t)),t}return p(a,rp),v(a,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e===gf.POSITION_PART&&!cc._widgetManager.isAligning){var t=this,i=t.node.getPosition(),n=this._lastPos,r=new Fi(i);r.subtract(n);var a=t.node.parent,s=new Fi(1,1,1);if(t.target&&(a=t.target,EV(t.node,a,new Fi,s)),a){var o=TV(a),l=new Fi;0!==o.width&&0!==o.height&&Fi.set(l,r.x/o.width,r.y/o.height,l.z),t.isAlignTop&&(t._top-=(t._isAbsTop?r.y:l.y)*s.y),t.isAlignBottom&&(t._bottom+=(t._isAbsBottom?r.y:l.y)*s.y),t.isAlignLeft&&(t._left+=(t._isAbsLeft?r.x:l.x)*s.x),t.isAlignRight&&(t._right-=(t._isAbsRight?r.x:l.x)*s.x),t.isAlignHorizontalCenter&&(t._horizontalCenter+=(t._isAbsHorizontalCenter?r.x:l.x)*s.x),t.isAlignVerticalCenter&&(t._verticalCenter+=(t._isAbsVerticalCenter?r.y:l.y)*s.y),this._recursiveDirty()}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!cc._widgetManager.isAligning){this.setDirty();var e=this,t=e.node.getContentSize(),i=this._lastSize,n=new Fi(t.width-i.width,t.height-i.height,0),r=e.node.parent,a=new Fi(1,1,1);if(e.target&&(r=e.target,EV(e.node,r,new Fi,a)),r){var s=TV(r),o=new Fi;0!==s.width&&0!==s.height&&Fi.set(o,n.x/s.width,n.y/s.height,o.z);var l=e.node.getAnchorPoint();e.isAlignTop&&(e._top-=(e._isAbsTop?n.y:o.y)*(1-l.y)*a.y),e.isAlignBottom&&(e._bottom-=(e._isAbsBottom?n.y:o.y)*l.y*a.y),e.isAlignLeft&&(e._left-=(e._isAbsLeft?n.x:o.x)*l.x*a.x),e.isAlignRight&&(e._right-=(e._isAbsRight?n.x:o.x)*(1-l.x)*a.x),this._recursiveDirty()}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(gf.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(gf.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(gf.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(gf.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(gf.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(gf.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(gf.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(gf.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if(0<(this._alignFlags&e)&&this.node.parent&&this.node.parent.uiTransfromComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===xV.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===xV.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===xV.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===xV.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===xV.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===xV.MID&&(this._verticalCenter=this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(JE)?(e.on(gf.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(gf.SIZE_CHANGED,this._targetChangedOperation,this)):cc.warnID(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(gf.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(gf.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(gf.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(gf.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==0<(this._alignFlags&e)){var i=0<(e&kV);t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&xV.TOP)},set:function(e){this._setAlign(xV.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&xV.BOT)},set:function(e){this._setAlign(xV.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&xV.LEFT)},set:function(e){this._setAlign(xV.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&xV.RIGHT)},set:function(e){this._setAlign(xV.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&xV.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=xV.MID):this._alignFlags&=~xV.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&xV.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=xV.CENTER):this._alignFlags&=~xV.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&kV)==kV}},{key:"isStretchHeight",get:function(){return(this._alignFlags&AV)==AV}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(xV.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(xV.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(xV.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(xV.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(xV.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(xV.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),a}(),vV.AlignMode=gV,b((JU=mV).prototype,"target",[XU],Object.getOwnPropertyDescriptor(JU.prototype,"target"),JU.prototype),b(JU.prototype,"isAlignTop",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAlignTop"),JU.prototype),b(JU.prototype,"isAlignBottom",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAlignBottom"),JU.prototype),b(JU.prototype,"isAlignLeft",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAlignLeft"),JU.prototype),b(JU.prototype,"isAlignRight",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAlignRight"),JU.prototype),b(JU.prototype,"isAlignVerticalCenter",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAlignVerticalCenter"),JU.prototype),b(JU.prototype,"isAlignHorizontalCenter",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAlignHorizontalCenter"),JU.prototype),b(JU.prototype,"isStretchWidth",[YU],Object.getOwnPropertyDescriptor(JU.prototype,"isStretchWidth"),JU.prototype),b(JU.prototype,"isStretchHeight",[KU],Object.getOwnPropertyDescriptor(JU.prototype,"isStretchHeight"),JU.prototype),b(JU.prototype,"editorTop",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"editorTop"),JU.prototype),b(JU.prototype,"editorBottom",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"editorBottom"),JU.prototype),b(JU.prototype,"editorLeft",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"editorLeft"),JU.prototype),b(JU.prototype,"editorRight",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"editorRight"),JU.prototype),b(JU.prototype,"editorHorizontalCenter",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"editorHorizontalCenter"),JU.prototype),b(JU.prototype,"editorVerticalCenter",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"editorVerticalCenter"),JU.prototype),b(JU.prototype,"isAbsoluteTop",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAbsoluteTop"),JU.prototype),b(JU.prototype,"isAbsoluteBottom",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAbsoluteBottom"),JU.prototype),b(JU.prototype,"isAbsoluteLeft",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAbsoluteLeft"),JU.prototype),b(JU.prototype,"isAbsoluteRight",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAbsoluteRight"),JU.prototype),b(JU.prototype,"alignMode",[QU],Object.getOwnPropertyDescriptor(JU.prototype,"alignMode"),JU.prototype),b(JU.prototype,"isAbsoluteHorizontalCenter",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAbsoluteHorizontalCenter"),JU.prototype),b(JU.prototype,"isAbsoluteVerticalCenter",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"isAbsoluteVerticalCenter"),JU.prototype),b(JU.prototype,"alignFlags",[lo],Object.getOwnPropertyDescriptor(JU.prototype,"alignFlags"),JU.prototype),$U=b(JU.prototype,"_alignFlags",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eV=b(JU.prototype,"_target",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tV=b(JU.prototype,"_left",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iV=b(JU.prototype,"_right",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nV=b(JU.prototype,"_top",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rV=b(JU.prototype,"_bottom",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aV=b(JU.prototype,"_horizontalCenter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sV=b(JU.prototype,"_verticalCenter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oV=b(JU.prototype,"_isAbsLeft",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lV=b(JU.prototype,"_isAbsRight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uV=b(JU.prototype,"_isAbsTop",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cV=b(JU.prototype,"_isAbsBottom",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hV=b(JU.prototype,"_isAbsHorizontalCenter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dV=b(JU.prototype,"_isAbsVerticalCenter",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fV=b(JU.prototype,"_originalWidth",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pV=b(JU.prototype,"_originalHeight",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_V=b(JU.prototype,"_alignMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gV.ALWAYS}}),ZU=JU))||ZU)||ZU)||ZU)||ZU)||ZU));cc.WidgetComponent=RV;var OV,MV,IV,LV,zV,BV,PV,DV,FV,NV,UV,VV,GV,HV,WV=q3("UIReorderComponent",oo("cc.UIReorderComponent")(CV=po("UI/Reorder")(CV=_o(110)(CV=vo(CV=ho(CV=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,HC),e}())||CV)||CV)||CV)||CV)||CV);cc.UIReorderComponent=WV;var qV,jV,XV=new rr;(jV=qV=qV||{})[jV.HORIZONTAL=0]="HORIZONTAL",jV[jV.VERTICAL=1]="VERTICAL",mt(qV);var YV,KV,QV,ZV,JV,$V,eG,tG,iG,nG,rG,aG,sG,oG,lG,uG,cG,hG,dG,fG,pG,_G,vG,mG,yG,gG,bG,xG,SG,wG,TG,EG=q3("PageViewIndicatorComponent",(OV=oo("cc.PageViewIndicatorComponent"),MV=_o(110),IV=po("UI/PageViewIndicator"),LV=lo({type:yf}),zV=lo({type:qV}),BV=lo({type:qn}),OV(PV=MV(PV=IV((HV=GV=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"spacing",FV,l(t)),m(t,"_spriteFrame",NV,l(t)),m(t,"_direction",UV,l(t)),m(t,"_cellSize",VV,l(t)),t._layout=null,t._pageView=null,t._indicators=[],t}return p(a,rp),v(a,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(_D),this._layout||(this._layout=this.addComponent(_D));var e=this._layout;this.direction===qV.HORIZONTAL?(e.type=_D.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===qV.VERTICAL&&(e.type=_D.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=_D.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new f_;return e.addComponent(RA).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiComp){var r=n._uiComp;XV.set(r.color),XV.a=127.5,r.color=XV}}if(e[t]._uiComp){var a=e[t]._uiComp;XV.set(a.color),XV.a=255,a.color=XV}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;0<i;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),a}(),GV.Direction=qV,b((DV=HV).prototype,"spriteFrame",[LV],Object.getOwnPropertyDescriptor(DV.prototype,"spriteFrame"),DV.prototype),b(DV.prototype,"direction",[zV],Object.getOwnPropertyDescriptor(DV.prototype,"direction"),DV.prototype),b(DV.prototype,"cellSize",[BV],Object.getOwnPropertyDescriptor(DV.prototype,"cellSize"),DV.prototype),FV=b(DV.prototype,"spacing",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NV=b(DV.prototype,"_spriteFrame",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UV=b(DV.prototype,"_direction",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qV.HORIZONTAL}}),VV=b(DV.prototype,"_cellSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qn(20,20)}}),PV=DV))||PV)||PV)||PV));cc.PageViewIndicatorComponent=EG;var CG,AG,kG,RG,OG,MG,IG=new Mi;(AG=CG=CG||{})[AG.Unified=0]="Unified",AG[AG.Free=1]="Free",mt(CG),(RG=kG=kG||{})[RG.Horizontal=0]="Horizontal",RG[RG.Vertical=1]="Vertical",mt(kG),(MG=OG=OG||{})[MG.PAGE_TURNING=0]="PAGE_TURNING",mt(OG);var LG=q3("PageViewComponent",(YV=oo("cc.PageViewComponent"),KV=_o(110),QV=po("UI/PageView"),ZV=lo({type:CG}),JV=lo({type:kG}),$V=lo({slide:!0,range:[0,1,.01]}),eG=lo({slide:!0,range:[0,1,.01]}),tG=lo({type:EG}),iG=lo({type:JF,visible:!1,override:!0}),nG=lo({type:JF,visible:!1,override:!0}),rG=lo({visible:!1,override:!0}),aG=lo({visible:!1,override:!0}),sG=lo({visible:!1,override:!0}),oG=lo({visible:!1,override:!0,type:[$A]}),lG=lo({type:[$A]}),YV(uG=KV(uG=QV((TG=wG=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"autoPageTurningThreshold",hG,l(t)),m(t,"horizontal",dG,l(t)),m(t,"vertical",fG,l(t)),m(t,"cancelInnerEvents",pG,l(t)),m(t,"scrollEvents",_G,l(t)),m(t,"pageTurningSpeed",vG,l(t)),m(t,"pageEvents",mG,l(t)),m(t,"_sizeMode",yG,l(t)),m(t,"_direction",gG,l(t)),m(t,"_scrollThreshold",bG,l(t)),m(t,"_pageTurningEventTiming",xG,l(t)),m(t,"_indicator",SG,l(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Fi,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Fi,t._touchEndPosition=new Fi,t}return p(a,YN),v(a,[{key:"__preload",value:function(){this.node.on(gf.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){_(g(a.prototype),"onEnable",this).call(this),this.node.on("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){_(g(a.prototype),"onDisable",this).call(this),this.node.off("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(gf.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(this._pages.length<=t?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):B(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;e<0||e>=this._pages.length||(i=void 0!==i?i:.3,this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),i,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(_D);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===kG.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===CG.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,n=e.length;i<n;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation(IG),Fi.set(this._touchBeganPosition,IG.x,IG.y,0),_(g(a.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){_(g(a.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation(IG),Fi.set(this._touchEndPosition,IG.x,IG.y,0),_(g(a.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation(IG),Fi.set(this._touchEndPosition,IG.x,IG.y,0),_(g(a.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===kG.Horizontal,this.vertical=this.direction===kG.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(_D);if(t){if(this._sizeMode===CG.Free&&0<this._pages.length){var i=this._pages[this._pages.length-1];this.direction===kG.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===kG.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];0<=this._pages.indexOf(i)||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,$A.emitEvents(this.pageEvents,this,OG.PAGE_TURNING),this.node.emit("page-turning",this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===kG.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===kG.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new Fi;if(this._sizeMode===CG.Free)this.direction===kG.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===kG.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===kG.Horizontal?t.x=e*i.width:this.direction===kG.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===kG.Horizontal?0===e.x?0:0<e.x?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===CG.Free){var n=0,r=0;if(this.direction===kG.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===kG.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===kG.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===kG.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new Fi;if(Fi.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=0<i?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var n=this._curPageIdx,r=n+this._getDragDirection(t),a=this.pageTurningSpeed*Math.abs(n-r);if(r<this._pages.length){if(this._isScrollable(t,n,r))return void this.scrollToPage(r,a);var s=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(s))return void this.scrollToPage(r,a)}this.scrollToPage(n,a)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar}}]),a}(),wG.SizeMode=CG,wG.Direction=kG,wG.EventType=OG,b((cG=TG).prototype,"sizeMode",[ZV],Object.getOwnPropertyDescriptor(cG.prototype,"sizeMode"),cG.prototype),b(cG.prototype,"direction",[JV],Object.getOwnPropertyDescriptor(cG.prototype,"direction"),cG.prototype),b(cG.prototype,"scrollThreshold",[$V],Object.getOwnPropertyDescriptor(cG.prototype,"scrollThreshold"),cG.prototype),b(cG.prototype,"pageTurningEventTiming",[eG],Object.getOwnPropertyDescriptor(cG.prototype,"pageTurningEventTiming"),cG.prototype),b(cG.prototype,"indicator",[tG],Object.getOwnPropertyDescriptor(cG.prototype,"indicator"),cG.prototype),hG=b(cG.prototype,"autoPageTurningThreshold",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),b(cG.prototype,"verticalScrollBar",[iG],Object.getOwnPropertyDescriptor(cG.prototype,"verticalScrollBar"),cG.prototype),b(cG.prototype,"horizontalScrollBar",[nG],Object.getOwnPropertyDescriptor(cG.prototype,"horizontalScrollBar"),cG.prototype),dG=b(cG.prototype,"horizontal",[rG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fG=b(cG.prototype,"vertical",[aG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pG=b(cG.prototype,"cancelInnerEvents",[sG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_G=b(cG.prototype,"scrollEvents",[oG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vG=b(cG.prototype,"pageTurningSpeed",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),mG=b(cG.prototype,"pageEvents",[lG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yG=b(cG.prototype,"_sizeMode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CG.Unified}}),gG=b(cG.prototype,"_direction",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kG.Horizontal}}),bG=b(cG.prototype,"_scrollThreshold",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),xG=b(cG.prototype,"_pageTurningEventTiming",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),SG=b(cG.prototype,"_indicator",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uG=cG))||uG)||uG)||uG));cc.PageViewComponent=LG;var zG=new Fi,BG=new Mi,PG=new Fi,DG=new Fi(1,1,1);function FG(e,t){var i,n=t.target,r=PG,a=DG;if(n?EV(e,i=n,r,a):i=e.parent,i.getComponent(JE)){var s=TV(i),o=i instanceof zS,l=o?BG:i.getAnchorPoint(),u=o;e.getPosition(zG);var c=zG.x,h=zG.y,d=e.getAnchorPoint(),f=e.getScale();if(t.alignFlags&xV.HORIZONTAL){var p=0,_=0,v=s.width;_=u?(p=Gl.left.x,Gl.right.x):(p=-l.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,_-=t.isAbsoluteRight?t.right:t.right*v,n&&(p+=r.x,p*=a.x,_+=r.x,_*=a.x);var m=0,y=d.x,g=f.x;if(g<0&&(y=1-y,g=-g),t.isStretchWidth)m=_-p,0!==g&&(e.width=m/g),c=p+y*m;else if(m=e.width*g,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,x=(.5-l.x)*s.width;n&&(b*=a.x,x+=r.x,x*=a.x),c=x+(y-.5)*m+b}else c=t.isAlignLeft?p+y*m:_+(y-1)*m;t._lastSize.width=m}if(t.alignFlags&xV.VERTICAL){var S=0,w=0,T=s.height;S=u?(w=Gl.bottom.y,Gl.top.y):(w=-l.y*T)+T,w+=t.isAbsoluteBottom?t.bottom:t.bottom*T,S-=t.isAbsoluteTop?t.top:t.top*T,n&&(w+=r.y,w*=a.y,S+=r.y,S*=a.y);var E=0,C=d.y,A=f.y;if(A<0&&(C=1-C,A=-A),t.isStretchHeight)E=S-w,0!==A&&(e.height=E/A),h=w+C*E;else if(E=e.height*A,t.isAlignVerticalCenter){var k=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*T,R=(.5-l.y)*s.height;n&&(k*=a.y,R+=r.y,R*=a.y),h=R+(C-.5)*E+k}else h=t.isAlignBottom?w+C*E:S+(C-1)*E;t._lastSize.height=E}e.setPosition(c,h,zG.z),Fi.set(t._lastPos,c,h,zG.z)}}function NG(){var e=qE.getScene();if(e){if(GG.isAligning=!0,GG._nodesOrderDirty)UG.length=0,function e(t){var i=t.getComponent(RV);if(i)if(FG(t,i),i.alignMode!==gV.ALWAYS)i.enabled=!1;else{if(!cc.isValid(t,!0))return;UG.push(i)}var n=t.children,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.active&&e(o)}}(e),GG._nodesOrderDirty=!1;else{var t=null,i=GG._activeWidgetsIterator;for(i.i=0;i.i<UG.length;++i.i)(t=UG[i.i])._dirty&&(FG(t.node,t),t._dirty=!1)}GG.isAligning=!1}}var UG=[];var VG=[],GG=q3("widgetManager",cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new $e.MutableForwardIterator(UG),animationState:null,init:function(e){e.on(lE.EVENT_AFTER_UPDATE,NG),Ll.isMobile?window.addEventListener("resize",this.onResized.bind(this)):bm.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=e.node.getComponent(xA);if(t){var i=qE.root.ui.getScreen(t.visibility);i&&-1===VG.indexOf(i)&&(VG.push(i),i.node.on("design-resolution-changed",this.onResized,this))}},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=qE.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(f_.isNode(e)){var t=e.getComponent(RV);if(t&&t.alignFlags===gV.ALWAYS)return}var i=e.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;this.refreshWidgetOnResized(s)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var n=e.node,r=n.parent;if(r){var a=new Fi,s=new Fi(1,1,1);if(e.target&&EV(n,r=e.target,a,s),!t)return;if(!r.getComponent(JE))return void cc.warnID(6501,e.node.name);var o=r.getAnchorPoint(),l=TV(r),u=n.getAnchorPoint(),c=n.getPosition(),h=xV,d=n.getScale(),f=0;if(t&h.LEFT){var p=-o.x*l.width;p+=a.x,p*=s.x,f=c.x-u.x*n.width*d.x-p,e.isAbsoluteLeft||(f/=l.width),f/=s.x,e.left=i(e.left,f)}if(t&h.RIGHT){var _=(1-o.x)*l.width;_+=a.x,f=(_*=s.x)-(c.x+(1-u.x)*n.width*d.x),e.isAbsoluteRight||(f/=l.width),f/=s.x,e.right=i(e.right,f)}if(t&h.TOP){var v=(1-o.y)*l.height;v+=a.y,f=(v*=s.y)-(c.y+(1-u.y)*n.height*d.y),e.isAbsoluteTop||(f/=l.height),f/=s.y,e.top=i(e.top,f)}if(t&h.BOT){var m=-o.y*l.height;m+=a.y,m*=s.y,f=c.y-u.y*n.height*d.y-m,e.isAbsoluteBottom||(f/=l.height),f/=s.y,e.bottom=i(e.bottom,f)}}},updateAlignment:function e(t){var i=t.parent;i&&f_.isNode(i)&&e(i);var n=t.getComponent(RV);n&&i&&FG(t,n)},AlignMode:gV,AlignFlags:xV});qE.on(lE.EVENT_INIT,function(){GG.init(qE)});var HG=function e(t,i,n){y(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=n};function WG(e,t,i,n,r){var a=0,s=null;if(r===0<function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}(e,t,i,n))for(a=t;a<i;a+=n)s=oH(a,e[a],e[a+1],s);else for(a=i-n;t<=a;a-=n)s=oH(a,e[a],e[a+1],s);return s&&nH(s,s.next)&&(lH(s),s=s.next),s}function qG(e,t){var i=1<arguments.length&&void 0!==t?t:null;if(!e)return e;i=i||e;var n=e,r=!1;do{if(r=!1,n.steiner||!nH(n,n.next)&&0!==iH(n.prev,n,n.next))n=n.next;else{if(lH(n),(n=i=n.prev)===n.next)return null;r=!0}}while(r||n!==i);return i}function jG(e,t,i,n,r,a,s){var o=6<arguments.length&&void 0!==s?s:0;if(e){!o&&a&&function(e,t,i,n){var r=e;for(;null===r.z&&(r.z=$G(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next,r!==e;);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,s=0,o=0,l=0,u=1;do{for(i=e,a=e=null,s=0;i;){for(s++,n=i,t=o=0;t<u&&(o++,n=n.nextZ);t++);for(l=u;0<o||0<l&&n;)0===o?(n=(r=n).nextZ,l--):0!==l&&n?i.z<=n.z?(i=(r=i).nextZ,o--):(n=(r=n).nextZ,l--):(i=(r=i).nextZ,o--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,u*=2}while(1<s)}(r)}(e,n,r,a);for(var l=e,u=null,c=null;e.prev!==e.next;)if(u=e.prev,c=e.next,a?YG(e,n,r,a):XG(e))t.push(u.i/i),t.push(e.i/i),t.push(c.i/i),lH(e),e=c.next,l=c.next;else if((e=c)===l){o?1===o?jG(e=KG(e,t,i),t,i,n,r,a,2):2===o&&QG(e,t,i,n,r,a):jG(qG(e),t,i,n,r,a,1);break}}}function XG(e){var t=e.prev,i=e,n=e.next;if(0<=iH(t,i,n))return!1;for(var r=e.next.next;r!==e.prev;){if(tH(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=iH(r.prev,r,r.next))return!1;r=r.next}return!0}function YG(e,t,i,n){var r=e.prev,a=e,s=e.next;if(0<=iH(r,a,s))return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,u=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,c=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,h=$G(o,l,t,i,n),d=$G(u,c,t,i,n),f=e.nextZ;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&tH(r.x,r.y,a.x,a.y,s.x,s.y,f.x,f.y)&&0<=iH(f.prev,f,f.next))return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&tH(r.x,r.y,a.x,a.y,s.x,s.y,f.x,f.y)&&0<=iH(f.prev,f,f.next))return!1;f=f.prevZ}return!0}function KG(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!nH(r,a)&&rH(r,n,n.next,a)&&aH(r,a)&&aH(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),lH(n),lH(n.next),n=e=a),n=n.next}while(n!==e);return n}function QG(e,t,i,n,r,a){var s,o,l=e;do{for(var u=l.next.next;u!==l.prev;){if(l.i!==u.i&&(o=u,(s=l).next.i!==o.i&&s.prev.i!==o.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&rH(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(s,o)&&aH(s,o)&&aH(o,s)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;for(;i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next,i!==e;);return n}(s,o))){var c=sH(l,u);return l=qG(l,l.next),c=qG(c,c.next),jG(l,t,i,n,r,a),void jG(c,t,i,n,r,a)}u=u.next}l=l.next}while(l!==e)}function ZG(e,t){return e.x-t.x}function JG(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,s=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&a<o){if((a=o)===n){if(r===i.y)return i;if(r===i.next.y)return i.next}s=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!s)return null;if(n===a)return s.prev;var l,u=s,c=s.x,h=s.y,d=1/0;i=s.next;for(;i!==u;)n>=i.x&&i.x>=c&&tH(r<h?n:a,r,c,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<d||l===d&&i.x>s.x)&&aH(i,e)&&(s=i,d=l),i=i.next;return s}(e,t)){var i=sH(t,e);qG(i,i.next)}}function $G(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function eH(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}function tH(e,t,i,n,r,a,s,o){return 0<=(r-s)*(t-o)-(e-s)*(a-o)&&0<=(e-s)*(n-o)-(i-s)*(t-o)&&0<=(i-s)*(a-o)-(r-s)*(n-o)}function iH(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function nH(e,t){return e.x===t.x&&e.y===t.y}function rH(e,t,i,n){return!!(nH(e,t)&&nH(i,n)||nH(e,n)&&nH(i,t))||0<iH(e,t,i)!=0<iH(e,t,n)&&0<iH(i,n,e)!=0<iH(i,n,t)}function aH(e,t){return iH(e.prev,e,e.next)<0?0<=iH(e,t,e.next)&&0<=iH(e,e.prev,t):iH(e,t,e.prev)<0||iH(e,e.next,t)<0}function sH(e,t){var i=new HG(e.i,e.x,e.y),n=new HG(t.i,t.x,t.y),r=e.next,a=t.prev;return(e.next=t).prev=e,(i.next=r).prev=i,(n.next=i).prev=n,(a.next=n).prev=a,n}function oH(e,t,i,n){var r=new HG(e,t,i);return n?(r.next=n.next,(r.prev=n).next.prev=r,n.next=r):(r.prev=r).next=r,r}function lH(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function uH(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=WG(e,0,r,i,!0),s=[];if(!a)return s;var o=0,l=0,u=0,c=0,h=0,d=0,f=0;if(n&&(a=function(e,t,i,n){var r,a=[],s=0,o=null;for(s=0,r=t.length;s<r;s++)(o=WG(e,t[s]*n,s<r-1?t[s+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),a.push(eH(o)));if(a.sort(ZG),!i)return i;for(s=0;s<a.length;s++)JG(a[s],i),i=qG(i,i.next);return i}(e,t,a,i)),e.length>80*i){o=u=e[0],l=c=e[1];for(var p=i;p<r;p+=i)(h=e[p])<o&&(o=h),(d=e[p+1])<l&&(l=d),u<h&&(u=h),c<d&&(c=d);f=Math.max(u-o,c-l)}return jG(a,s,i,o,l,f),s}var cH=Math.PI,hH=Math.min,dH=Math.max,fH=Math.cos,pH=Math.sin,_H=Math.abs,vH=Math.sign,mH=.5522847493;function yH(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*mH,t-n*mH,i+r,t,i+r),e.bezierCurveTo(t+n*mH,i+r,t+n,i+r*mH,t+n,i),e.bezierCurveTo(t+n,i-r*mH,t+n*mH,i-r,t,i-r),e.bezierCurveTo(t-n*mH,i-r,t-n,i-r*mH,t-n,i),e.close()}for(var gH=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t))).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return p(n,Mi),v(n,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),n}(),bH=function(){function e(){y(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return v(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),xH=function(){function e(){y(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=rr.WHITE.clone(),this.lineCap=qP.BUTT,this.strokeColor=rr.BLACK.clone(),this.lineJoin=XP.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new Es(function(){return new nx},16),this._renderDatas=[],this._curPath=null}return v(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,KP.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,KP.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var s=this._curPath,o=s.points[s.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==a?(function e(t,i,n,r,a,s,o,l,u,c,h){var d,f,p,_,v,m,y,g,b,x,S,w,T,E,C,A;10<c||(v=.5*(s+l),m=.5*(o+u),y=.5*((d=.5*(i+r))+(p=.5*(r+s))),g=.5*((f=.5*(n+a))+(_=.5*(a+o))),((C=_H((r-l)*(E=u-n)-(a-u)*(T=l-i)))+(A=_H((s-l)*E-(o-u)*T)))*(C+A)<t.tessTol*(T*T+E*E)?t.addPoint(l,u,0===h?h|KP.PT_BEVEL:h):(e(t,i,n,d,f,y,g,S=.5*(y+(b=.5*(p+v))),w=.5*(g+(x=.5*(_+m))),c+1,0),e(t,S,w,b,x,v,m,l,u,c+1,h)))}(this,o.x,o.y,e,t,i,n,r,a,0,KP.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,s){var o,l,u=0,c=0,h=0,d=0,f=0,p=0,_=0,v=0,m=0,y=0,g=0,b=0,x=0,S=0;if(c=a-r,s=s||!1)if(_H(c)>=2*cH)c=2*cH;else for(;c<0;)c+=2*cH;else if(_H(c)>=2*cH)c=2*-cH;else for(;0<c;)c-=2*cH;for(l=0|dH(1,hH(_H(c)/(.5*cH)+.5,5)),h=_H(4/3*(1-fH(o=c/l/2))/pH(o)),s||(h=-h),S=0;S<=l;S++)p=t+(d=fH(u=r+c*(S/l)))*n,_=i+(f=pH(u))*n,v=-f*n*h,m=d*n*h,0===S?e.moveTo(p,_):e.bezierCurveTo(y+b,g+x,p-v,_-m,p,_),y=p,g=_,b=v,x=m}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){yH(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){yH(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var s=hH(a,.5*_H(n))*vH(n),o=hH(a,.5*_H(r))*vH(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-mH),t+s*(1-mH),i+r,t+s,i+r),e.lineTo(t+n-s,i+r),e.bezierCurveTo(t+n-s*(1-mH),i+r,t+n,i+r-o*(1-mH),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-mH),t+n-s*(1-mH),i,t+n-s,i),e.lineTo(t+s,i),e.bezierCurveTo(t+s*(1-mH),i,t,i+o*(1-mH),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var i=this._renderDatas,n=0,r=i.length;n<r;n++){var a=i[n];a&&a.reset()}this._renderDatas.length=0,t&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,s=r[this.pointsOffset++];s?(s.x=e,s.y=t):(s=new gH(e,t),r.push(s)),s.flags=i,a.push(s)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new bH,this.paths.push(t)),this.pathLength++,this._curPath=t}}]),e}(),SH=Math.PI,wH=Math.min,TH=Math.max,EH=Math.ceil,CH=Math.acos,AH=Math.cos,kH=Math.sin,RH=Math.atan2,OH=ZT,MH=[],IH=[],LH=[],zH=[],BH=null,PH=null,DH=new rr,FH=[],NH=0;NH<4;NH++)FH.push(new Fi);function UH(e,t,i){return e<t?t:i<e?i:e}var VH=q3("graphics",{useModel:!0,createImpl:function(e){return new xH},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!PH)return null;var i=PH.getRenderDatas(),n=i[PH.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(65535<a||131070<3*a)&&(++PH.dataOffset,PH.dataOffset<i.length?n=i[PH.dataOffset]:(n=PH.requestRenderData(),i[PH.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){rr.copy(DH,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){rr.copy(DH,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=qE.root.ui.renderScene;e.model&&(e.model.destroy(),t.destroyModel(e.model),e.model=null);var i=e.impl,n=Uu.TRIANGLE_LIST,r=i&&i.getRenderDatas();if(r){var a=0;MH.length=0,IH.length=0,LH.length=0,zH.length=0;var s=r,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u,h=c.byteCount>>2,d=c.vData;for(a=0;a<h;)MH.push(d[a++]),MH.push(d[a++]),MH.push(d[a++]),IH.push(d[a++]),IH.push(d[a++]),LH.push(d[a++]),LH.push(d[a++]),LH.push(d[a++]),LH.push(d[a++]);h=c.indiceCount;var f=c.iData;for(a=0;a<h;)zH.push(f[a++])}var p=Tv({primitiveMode:n,positions:MH,uvs:IH,colors:LH,attributes:OH,indices:zH},void 0,{calculateBounds:!1});e.model=t.createModel(_v,e.node),e.model.initSubModel(0,p.getSubMesh(0),e.material),e.model.enabled=!0,e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(PH=e.impl){var a=function(e,t,i){var n=2*CH(e/(e+i));return TH(2,EH(t/n))}(t,SH,PH.tessTol);this._calculateJoins(PH,t,n,r);for(var s=PH.paths,o=0,l=PH.pathOffset,u=PH.pathLength;l<u;l++){var c=s[l],h=c.points.length;n===XP.ROUND?o+=2*(h+c.nbevel*(a+2)+1):o+=2*(h+5*c.nbevel+1),c.closed||(i===qP.ROUND?o+=2*(2*a+2):o+=12)}var d=BH=this.getRenderData(e,o);if(d){for(var f=d.vData,p=d.iData,_=PH.pathOffset,v=PH.pathLength;_<v;_++){var m=s[_],y=m.points,g=y.length,b=d.vertexStart,x=void 0,S=void 0,w=0,T=0,E=m.closed;if(T=E?(x=y[g-1],S=y[0],w=0,g):(x=y[0],S=y[1],g-(w=1)),!E){var C=new gH(S.x,S.y);C.subtract(x),C.normalize();var A=C.x,k=C.y;i===qP.BUTT?this._buttCap(x,A,k,t,0):i===qP.SQUARE?this._buttCap(x,A,k,t,t):i===qP.ROUND&&this._roundCapStart(x,A,k,t,a)}for(var R=w;R<T;++R)n===XP.ROUND?this._roundJoin(x,S,t,t,a):0!=(S.flags&(KP.PT_BEVEL|KP.PT_INNERBEVEL))?this._bevelJoin(x,S,t,t):(this._vset(S.x+S.dmx*t,S.y+S.dmy*t),this._vset(S.x-S.dmx*t,S.y-S.dmy*t)),x=S,S=y[R+1];if(E){var O=9*b,M=f.slice(O,O+9);f.set(M,9*d.vertexStart),O+=9,d.vertexStart++,M=f.slice(O,O+9),f.set(M,9*d.vertexStart),d.vertexStart++}else{var I=new gH(S.x,S.y);I.subtract(x),I.normalize();var L=I.x,z=I.y;i===qP.BUTT?this._buttCap(S,L,z,t,0):i===qP.SQUARE?this._buttCap(S,L,z,t,t):i===qP.ROUND&&this._roundCapEnd(S,L,z,t,a)}for(var B=d.indiceStart,P=b+2,D=d.vertexStart;P<D;P++)p[B++]=P-2,p[B++]=P-1,p[B++]=P;if((d.indiceStart=B)!==d.indiceCount){var F=new Array(d.indiceCount-B);d.iData.set(F,B)}}PH=BH=null}}},_expandFill:function(e){if(PH=e.impl){for(var t=PH.paths,i=0,n=PH.pathOffset,r=PH.pathLength;n<r;n++){i+=t[n].points.length}var a=BH=this.getRenderData(e,i);if(a){for(var s=a,o=s.vData,l=s.iData,u=PH.pathOffset,c=PH.pathLength;u<c;u++){var h=t[u],d=h.points,f=d.length;if(0!==f){for(var p=a.vertexStart,_=0;_<f;++_)this._vset(d[_].x,d[_].y);var v=a.indiceStart;if(h.complex){for(var m=[],y=p,g=a.vertexStart;y<g;y++){var b=9*y;m.push(o[b++]),m.push(o[b++]),m.push(o[b++])}var x=uH(m,null,3);if(!x||0===x.length)continue;for(var S=0,w=x.length;S<w;S++)l[v++]=x[S]+p}else for(var T=p,E=p+2,C=s.vertexStart;E<C;E++)l[v++]=T,l[v++]=E-1,l[v++]=E;if((s.indiceStart=v)!==s.indiceCount){var A=new Array(s.indiceCount-v);s.iData.set(A,v)}}}PH=BH=null}}},_calculateJoins:function(e,t,i,n){var r=0;0<t&&(r=1/t);for(var a=e.paths,s=e.pathOffset,o=e.pathLength;s<o;s++)for(var l=a[s],u=l.points,c=u.length,h=u[c-1],d=u[0],f=l.nbevel=0;f<c;f++){var p,_,v=h.dy,m=-h.dx,y=d.dy,g=-d.dx;if(d.dmx=.5*(v+y),d.dmy=.5*(m+g),1e-6<(p=d.dmx*d.dmx+d.dmy*d.dmy)){var b=1/p;600<b&&(b=600),d.dmx*=b,d.dmy*=b}0<d.dx*h.dy-h.dx*d.dy&&(d.flags|=KP.PT_LEFT),p*(_=TH(11,wH(h.len,d.len)*r))*_<1&&(d.flags|=KP.PT_INNERBEVEL),d.flags&KP.PT_CORNER&&(p*n*n<1||i===XP.BEVEL||i===XP.ROUND)&&(d.flags|=KP.PT_BEVEL),0!=(d.flags&(KP.PT_BEVEL|KP.PT_INNERBEVEL))&&l.nbevel++,h=d,d=u[f+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,s=a[a.length-1],o=a[0];s.equals(o)&&(r.closed=!0,a.pop(),s=a[a.length-1]);for(var l=0,u=a.length;l<u;l++){var c=new gH(o.x,o.y);c.subtract(s),s.len=c.length(),(c.x||c.y)&&c.normalize(),s.dx=c.x,s.dy=c.y,s=o,o=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,s=0,o=0,l=0,u=0;return 0!==e?(s=r+t.dy*n,o=a-t.dx*n,l=r+i.dy*n,u=a-i.dx*n):(s=l=r+i.dmx*n,o=u=a+i.dmy*n),[s,o,l,u]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,s=e.y-i*r,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,s=e.y,o=i,l=-t,u=0;u<r;u++){var c=u/(r-1)*SH,h=AH(c)*n,d=kH(c)*n;this._vset(a-o*h-t*d,s-l*h-i*d),this._vset(a,s)}this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,s=e.y,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n);for(var u=0;u<r;u++){var c=u/(r-1)*SH,h=AH(c)*n,d=kH(c)*n;this._vset(a,s),this._vset(a-o*h+t*d,s-l*h+i*d)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,s=-e.dx,o=t.dy,l=-t.dx,u=t.x,c=t.y;if(0!=(t.flags&KP.PT_LEFT)){var h=this._chooseBevel(t.flags&KP.PT_INNERBEVEL,e,t,i),d=h[0],f=h[1],p=h[2],_=h[3],v=RH(-s,-a),m=RH(-l,-o);v<m&&(m-=2*SH),this._vset(d,f),this._vset(u-a*n,t.y-s*n);for(var y=UH(EH((v-m)/SH)*r,2,r),g=0;g<y;g++){var b=v+g/(y-1)*(m-v),x=u+AH(b)*n,S=c+kH(b)*n;this._vset(u,c),this._vset(x,S)}this._vset(p,_),this._vset(u-o*n,c-l*n)}else{var w=this._chooseBevel(t.flags&KP.PT_INNERBEVEL,e,t,-n),T=w[0],E=w[1],C=w[2],A=w[3],k=RH(s,a),R=RH(l,o);R<k&&(R+=2*SH),this._vset(u+a*n,c+s*n,0),this._vset(T,E,0);for(var O=UH(EH((R-k)/SH)*r,2,r),M=0;M<O;M++){var I=k+M/(O-1)*(R-k),L=u+AH(I)*i,z=c+kH(I)*i;this._vset(L,z,0),this._vset(u,c,0)}this._vset(u+o*n,c+l*n),this._vset(C,A)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,s=0,o=0,l=0,u=0,c=0,h=0,d=e.dy,f=-e.dx,p=t.dy,_=-t.dx;if(t.flags&KP.PT_LEFT){var v=this._chooseBevel(t.flags&KP.PT_INNERBEVEL,e,t,i);l=v[0],u=v[1],c=v[2],h=v[3],this._vset(l,u,0),this._vset(t.x-d*n,t.y-f*n,0),this._vset(c,h,0),this._vset(t.x-p*n,t.y-_*n,0)}else{var m=this._chooseBevel(t.flags&KP.PT_INNERBEVEL,e,t,-n);r=m[0],a=m[1],s=m[2],o=m[3],this._vset(t.x+d*i,t.y+f*i,0),this._vset(r,a),this._vset(t.x+p*i,t.y+_*i,0),this._vset(s,o)}},_vset:function(e,t){if(BH){var i=BH,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,rr.toArray(r,DH,n),i.vertexStart++}}}),GH=q3("graphicsAssembler",{getAssembler:function(e){return VH}});RD.Assembler=GH;function HH(){y(this,HH),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0}var WH=function(){function e(){y(this,e),this._letterDefinitions={}}return v(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new HH;Ne(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n];Ne(this._letterDefinitions[n],r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions.hasOwnProperty(e.charCodeAt(0))?this._letterDefinitions[e.charCodeAt(0)]:null}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();cc.FontAtlas=WH;function qH(){y(this,qH),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0}var jH=new Zn,XH=null,YH=[],KH=[],QH=[],ZH=[],JH=new qn,$H=null,eW=null,tW=0,iW=0,nW=0,rW=0,aW=0,sW=1,oW=null,lW="",uW=0,cW=0,hW=new qn,dW=0,fW=0,pW=0,_W=0,vW=0,mW=!1,yW=0,gW=0,bW=0,xW={updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&XH!==e&&(XH=e,this._updateProperties(),this._updateContent(),XH.actualFontSize=uW,XH.node.setContentSize(hW),XH.renderData.vertDirty=XH.renderData.uvDirty=!1,XH=null,this._resetProperties())},_updateFontScale:function(){sW=uW/cW},_updateProperties:function(){if(XH){var e=XH.font;if(e){if(oW=e.spriteFrame,eW=e.fntConfig,!($H=XH.fontAtlas)){$H=new WH;for(var t=eW.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new HH,s=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=s.width,a.height=s.height,a.u=s.x,a.v=s.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,$H.addLetterDefinitions(r,a)}XH.fontAtlas=$H}lW=XH.string.toString(),uW=XH.fontSize,cW=eW.fontSize;var o=XH.node.getContentSize();hW.width=o.width,hW.height=o.height,dW=XH.horizontalAlign,fW=XH.verticalAlign,pW=XH.spacingX,vW=XH.overflow,_W=XH.lineHeight,mW=vW!==aB.NONE&&(vW===aB.RESIZE_HEIGHT||XH.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){oW=eW=$H=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=lW,t=e.length,i=eW.kerningDict,n=YH,r=-1,a=0;a<t;++a){var s=e.charCodeAt(a),o=i[r<<16|65535&s]||0;n[a]=a<t-1?o:0,r=s}},_multilineTextWrap:function(e){var t=lW.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,u=null,c=new Mi;this._updateFontScale();for(var h=$H.letterDefinitions,d=0;d<t;){var f=lW.charAt(d);if("\n"!==f){for(var p=e(lW,d,t),_=o,v=l,m=s,y=n,g=!1,b=0;b<p;++b){var x=d+b;if("\r"!==(f=lW.charAt(x)))if(u=$H&&$H.getLetterDefinitionForChar(f)){var S=y+u.offsetX*sW;if(mW&&0<bW&&0<n&&S+u.width*sW>bW&&!Ws(f)){QH.push(s),i++,r-=_W*sW+(n=s=0),g=!0;break}c.x=S,c.y=r-u.offsetY*sW,this._recordLetterInfo(h,c,f,x,i),x+1<YH.length&&x<t-1&&(y+=YH[x+1]),y+=u.xAdvance*sW+pW,m=c.x+u.width*sW,_<c.y&&(_=c.y),v>c.y-u.height*sW&&(v=c.y-u.height*sW)}else this._recordPlaceholderInfo(x,f),console.log("Can't find letter definition in texture atlas "+eW.atlasName+" for letter:"+f);else this._recordPlaceholderInfo(x,f)}g||(n=y,o<_&&(o=_),v<l&&(l=v),a<(s=m)&&(a=s),d+=p)}else QH.push(s),i++,r-=_W*sW+(n=s=0),this._recordPlaceholderInfo(d,f),d++}return QH.push(s),iW=(tW=i+1)*_W*sW,1<tW&&(iW+=0*(tW-1)),hW.width=yW,hW.height=gW,yW<=0&&(hW.width=parseFloat(a.toFixed(2))),gW<=0&&(hW.height=parseFloat(iW.toFixed(2))),rW=hW.height,(aW=0)<o&&(rW=hW.height+o),l<-iW&&(aW=iW+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Hs(n)||"\n"===n||Ws(n))return 1;var r=1,a=$H&&$H.getLetterDefinitionForChar(n);if(!a)return r;for(var s=a._xAdvance*sW+pW,o=t+1;o<i&&(n=e.charAt(o),a=$H&&$H.getLetterDefinitionForChar(n));++o){if(s+a._offsetX*sW+a._width*sW>bW&&!Ws(n)&&0<bW)return r;if(s+=a._xAdvance*sW+pW,"\n"===n||Ws(n)||Hs(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=KH.length){var i=new qH;KH.push(i)}KH[e].char=t,KH[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=KH.length){var a=new qH;KH.push(a)}var s=i.charCodeAt(0);KH[n].lineIndex=r,KH[n].char=i,KH[n].valid=e[s].validDefinition,KH[n].positionX=t.x,KH[n].positionY=t.y},_alignText:function(){iW=0,QH.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),vW===aB.SHRINK&&0<uW&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||vW===aB.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),uW=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=uW,i=_W,n=$H,r=0,a=n?n.cloneLetterDefinition():{},s=!0;e();){var o=t-++r;if(s=!1,o<=0)break;var l=o/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),_W=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}_W=i,n&&n.assignLetterDefinitions(a),s||0<=t-r&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return iW>hW.height},_isHorizontalClamp:function(){if($H){for(var e=$H.letterDefinitions,t=!1,i=0,n=lW.length;i<n;++i){var r=KH[i];if(r.valid){var a=e[r.char],s=r.positionX+a.width/2*sW,o=r.lineIndex;if(0<yW)if(mW){if(QH[o]>hW.width&&(s>hW.width||s<0)){t=!0;break}}else if(s>hW.width){t=!0;break}}}return t}},_isHorizontalClamped:function(e,t){var i=QH[t],n=e>hW.width||e<0;return mW?i>hW.width&&n:n},_updateQuads:function(){if(!XH)return!1;var e=$H?$H.letterDefinitions:{},t=oW,i=XH.node,n=XH.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=hW,s=r.x*a.width,o=r.y*a.height,l=!0,u=0,c=lW.length;u<c;++u){var h=KH[u];if(h.valid){var d=e[h.char.charCodeAt(0)];if(d){jH.height=d.height,jH.width=d.width,jH.x=d.u,jH.y=d.v;var f=h.positionY+nW;if(0<gW){if(rW<f){var p=f-rW;jH.y+=p,jH.height-=p,f-=p}f-d.height*sW<aW&&(jH.height=f<aW?0:f-aW)}var _=h.lineIndex,v=h.positionX+d.width/2*sW+ZH[_];if(0<yW&&this._isHorizontalClamped(v,_))if(vW===aB.CLAMP)jH.width=0;else if(vW===aB.SHRINK){if(hW.width>d.width){l=!1;break}jH.width=0}if(oW&&0<jH.height&&0<jH.width){var m=oW.isRotated(),y=oW.getOriginalSize(),g=oW.getRect(),b=oW.getOffset(),x=b.x+(y.width-g.width)/2,S=b.y-(y.height-g.height)/2;if(m){var w=jH.x;jH.x=g.x+g.height-jH.y-jH.height-S,jH.y=w+g.y-x,jH.y<0&&(jH.height=jH.height+S)}else jH.x+=g.x-x,jH.y+=g.y+S;var T=h.positionX+ZH[h.lineIndex];this.appendQuad(XH,t,jH,m,T-s,f-o,sW)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(ZH.length=0,dW){case tB.LEFT:for(var e=0;e<tW;++e)ZH.push(0);break;case tB.CENTER:for(var t=0,i=QH.length;t<i;t++)ZH.push((hW.width-QH[t])/2);break;case tB.RIGHT:for(var n=0,r=QH.length;n<r;n++)ZH.push(hW.width-QH[n])}switch(fW){case nB.TOP:nW=hW.height;break;case nB.CENTER:nW=(hW.height+iW)/2;break;case nB.BOTTOM:nW=iW}},_setupBMFontOverflowMetrics:function(){var e=hW.width,t=hW.height;vW===aB.RESIZE_HEIGHT&&(t=0),vW===aB.NONE&&(t=e=0),yW=e,gW=t,JH.width=e,JH.height=t,bW=e}},SW=q3("bmfont",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){_z(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,s){var o=e.renderData;if(o){var l=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var u=o.datas,c=t.width,h=t.height,d=i.width,f=i.height,p=0,_=0,v=0,m=0;n?(p=i.x/c,m=(i.x+f)/c,_=(i.y+d)/h,v=i.y/h,u[l].u=p,u[l].v=v,u[l+1].u=p,u[l+1].v=_,u[l+2].u=m,u[l+2].v=v,u[l+3].u=m,u[l+3].v=_):(p=i.x/c,m=(i.x+d)/c,_=(i.y+f)/h,v=i.y/h,u[l].u=p,u[l].v=_,u[l+1].u=m,u[l+1].v=_,u[l+2].u=p,u[l+2].v=v,u[l+3].u=m,u[l+3].v=v),u[l].x=r,u[l].y=a-f*s,u[l+1].x=r+d*s,u[l+1].y=a-f*s,u[l+2].x=r,u[l+2].y=a,u[l+3].x=r+d*s,u[l+3].y=a}}});Fe(SW,xW);function wW(){y(this,wW),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}function TW(){y(this,TW),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}var EW=mB.Overflow,CW=rr.WHITE.clone(),AW=mB.HorizontalAlign,kW=mB.VerticalAlign,RW=function(){function i(e,t){y(this,i),this.spriteframe=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this._lastImage=null,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}return v(i,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.spriteframe&&(this.spriteframe.texture.destroy(),this.spriteframe.destroy(),this.spriteframe=null)}},{key:"_updateProperties",value:function(){if(this.spriteframe=new yf,this.data=mB.CanvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=qs(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this._lastImage&&(this._lastImage._texture.destroy(),this._lastImage.destroy());var t=new Td(this.canvas),i=(this._lastImage=t)._texture;this.spriteframe.texture=i}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var o=t.out||CW;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a),this.spriteframe.texture.updateImage()}}}]),i}(),OW=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,uf),v(e,[{key:"initWithSize",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:ad.RGBA8888;this.destroy(),this.reset({width:e,height:t,format:n}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e._image&&n){var r=this._getGFXDevice();if(r){var a={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e._image.width,height:e._image.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};r.copyTexImagesToTexture([e._image.data],n,[a])}else console.warn("Unable to get device")}}}]),e}(),MW=function(){function i(e,t){y(this,i),this.texture=void 0,this._x=2,this._y=2,this._nexty=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._imageAssets=[],this._dirty=!1,this.texture=new OW,this.texture.initWithSize(e,t),this._width=e,this._height=t,qE.on(lE.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return v(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),v(i,[{key:"insertLetterTexture",value:function(e){var t=e.spriteframe,i=qE.root.device;if(!(t&&this.texture&&i&&t._image))return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nexty),this._y+r>this._nexty&&(this._nexty=this._y+r+2),this._nexty>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new TW;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new OW;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new TW;Ne(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var i=this;e.forEach(function(e,t){Ne(i._letterDefinitions[t],e)})}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new RW(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),i}(),IW=new Zn,LW=null,zW=[],BW=[],PW=[],DW=[],FW=new qn,NW=null,UW=0,VW=0,GW=0,HW=0,WW=0,qW=1,jW="",XW=0,YW=0,KW=new qn,QW=0,ZW=0,JW=0,$W=0,eq=0,tq=!1,iq=0,nq=0,rq=0,aq="",sq=!1,oq={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:CW,isOutlined:!1,out:CW,margin:0},lq={getAssemblerData:function(){return(NW=NW||new MW(1024,1024)).texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&LW!==e&&(LW=e,this._updateFontFamily(e),oq.fontFamily=aq,this._updateProperties(),oq.fontDesc=this._getFontDesc(),this._updateContent(),LW.actualFontSize=XW,LW.node.setContentSize(KW),LW.renderData.vertDirty=LW.renderData.uvDirty=!1,LW=null,this._resetProperties())},_updateFontScale:function(){qW=XW/YW},_updateProperties:function(){if(LW){jW=LW.string.toString(),XW=LW.fontSize,YW=XW;var e=LW.node.getContentSize();KW.width=e.width,KW.height=e.height,QW=LW.horizontalAlign,ZW=LW.verticalAlign,JW=LW.spacingX,eq=LW.overflow,$W=LW.lineHeight,sq=LW.isBold,tq=eq!==EW.NONE&&(eq===EW.RESIZE_HEIGHT||LW.enableWrapText);var t=LW.getComponent(TF);t&&t.enabled?(oq.isOutlined=!0,oq.margin=t.width,oq.out=t.color,oq.out.a=t.color.a*LW.color.a/255):(oq.isOutlined=!1,oq.margin=0),oq.lineHeight=$W,oq.fontSize=XW,oq.fontFamily=aq,oq.color=LW.color,oq.hash=this._computeHash(oq),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(i){i.useSystemFont?aq=i.fontFamily:i.font?i.font._nativeAsset?aq=i.font._nativeAsset:(aq=Bb.getRes(i.font.nativeUrl)||"")||Bb.load(i.font.nativeUrl,function(e,t){aq=t||"Arial",i.font&&(i.font._nativeAsset=t),i.updateRenderData(!0)}):aq="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=XW.toString()+"px ";return e+=aq,sq&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=jW.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,u=null,c=new Mi(0,0);this._updateFontScale();for(var h=0;h<t;){var d=jW.charAt(h);if("\n"!==d){for(var f=e(jW,h,t),p=o,_=l,v=s,m=n,y=!1,g=0;g<f;++g){var b=h+g;if("\r"!==(d=jW.charAt(b)))if(u=NW&&NW.getLetterDefinitionForChar(d,oq)){var x=m+u.offsetX*qW;if(tq&&0<rq&&0<n&&x+u.w*qW>rq&&!Ws(d)){PW.push(s),i++,r-=$W*qW+(n=s=0),y=!0;break}c.x=x,c.y=r-u.offsetY*qW,this._recordLetterInfo(c,d,b,i),b+1<zW.length&&b<t-1&&(m+=zW[b+1]),m+=u.xAdvance*qW+JW,v=c.x+u.w*qW,p<c.y&&(p=c.y),_>c.y-u.h*qW&&(_=c.y-u.h*qW)}else this._recordPlaceholderInfo(b,d);else this._recordPlaceholderInfo(b,d)}y||(n=m,o<p&&(o=p),_<l&&(l=_),a<(s=v)&&(a=s),h+=f)}else PW.push(s),i++,r-=$W*qW+(n=s=0),this._recordPlaceholderInfo(h,d),h++}return PW.push(s),VW=(UW=i+1)*$W*qW,1<UW&&(VW+=0*(UW-1)),KW.width=iq,KW.height=nq,iq<=0&&(KW.width=parseFloat(a.toFixed(2))),nq<=0&&(KW.height=parseFloat(VW.toFixed(2))),HW=KW.height,(WW=0)<o&&(HW=KW.height+o),l<-VW&&(WW=VW+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Hs(n)||"\n"===n||Ws(n))return 1;if(NW){var r=1,a=NW.getLetterDefinitionForChar(n,oq);if(!a)return r;for(var s=a.xAdvance*qW+JW,o=t+1;o<i&&(n=e.charAt(o),a=NW.getLetterDefinitionForChar(n,oq));++o){if(s+a.offsetX*qW+a.w*qW>rq&&!Ws(n)&&0<rq)return r;if(s+=a.xAdvance*qW+JW,"\n"===n||Ws(n)||Hs(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=BW.length){var i=new wW;BW.push(i)}BW[e].char=t,BW[e].hash=t.charCodeAt(0)+oq.hash,BW[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=BW.length){var r=new wW;BW.push(r)}var a=t.charCodeAt(0)+oq.hash;BW[i].line=n,BW[i].char=t,BW[i].hash=a;var s=NW&&NW.getLetter(a);BW[i].valid=!!s&&!!s.valid,BW[i].x=e.x,BW[i].y=e.y},_alignText:function(){VW=0,PW.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),XW=e,t&&this._updateContent()},_isVerticalClamp:function(){return VW>KW.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=jW.length;t<i;++t){var n=BW[t];if(n.valid){var r=NW.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*qW,s=n.line;if(0<iq)if(tq){if(PW[s]>KW.width&&(a>KW.width||a<0)){e=!0;break}}else if(a>KW.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=PW[t],n=e>KW.width||e<0;return tq?i>KW.width&&n:n},_updateQuads:function(){if(LW&&NW){var e=NW.texture,t=LW.node,i=LW.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=KW,r=t.getAnchorPoint(),a=r.x*n.width,s=r.y*n.height,o=!0,l=0,u=jW.length;l<u;++l){var c=BW[l];if(c.valid){var h=NW.getLetter(c.hash);if(h){IW.height=h.h,IW.width=h.w,IW.x=h.u,IW.y=h.v;var d=c.y+GW;if(0<nq){if(HW<d){var f=d-HW;IW.y+=f,IW.height-=f,d-=f}d-h.h*qW<WW&&(IW.height=d<WW?0:d-WW)}var p=c.line,_=c.x+h.w/2*qW+DW[p];if(0<iq&&this._isHorizontalClamped(_,p))if(eq===EW.CLAMP)IW.width=0;else if(eq===EW.SHRINK){if(KW.width>h.w){o=!1;break}IW.width=0}if(0<IW.height&&0<IW.width){var v=c.x+DW[c.line];this.appendQuad(i,e,IW,!1,v-a,d-s,qW)}}}}return o}},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(DW.length=0,QW){case AW.LEFT:for(var e=0;e<UW;++e)DW.push(0);break;case AW.CENTER:for(var t=0,i=PW.length;t<i;t++)DW.push((KW.width-PW[t])/2);break;case AW.RIGHT:for(var n=0,r=PW.length;n<r;n++)DW.push(KW.width-PW[n])}switch(ZW){case kW.TOP:GW=KW.height;break;case kW.CENTER:GW=(KW.height+VW)/2-($W-XW)/2;break;case kW.BOTTOM:GW=(KW.height+VW)/2-($W-XW)}},_setupBMFontOverflowMetrics:function(){var e=KW.width,t=KW.height;eq===EW.RESIZE_HEIGHT&&(t=0),eq===EW.NONE&&(t=e=0),iq=e,nq=t,FW.width=e,FW.height=t,rq=e}},uq=new rr(255,255,255,255),cq=q3("letter",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;uq.a=e.color.a,_z(i,t,e.renderData,uq)}},appendQuad:SW.appendQuad});Fe(cq,lq);var hq=mB.Overflow,dq=rr.WHITE.clone(),fq=Ge(TF,rp),pq=null,_q=null,vq=null,mq="",yq="",gq=0,bq=0,xq=[],Sq=new qn,wq=0,Tq=0,Eq=0,Cq=new rr,Aq="",kq=hq.NONE,Rq=!1,Oq=!1,Mq=new rr,Iq=0,Lq=0,zq=!1,Bq=!1,Pq=!1,Dq=new uB,Fq={getAssemblerData:function(){var e=document.createElement("canvas"),t={canvas:e,context:e.getContext("2d")};return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(e){cc.game.renderType===cc.game.RENDER_TYPE_CANVAS&&e&&Dq.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=gq,e.node.setContentSize(Sq),this.updateVerts(e),e.markForUpdateRenderData(!1),vq=_q=pq=null)},updateVerts:function(e){},_updateFontFamly:function(i){i.useSystemFont?Aq=i.fontFamily:i.font?i.font._nativeAsset?Aq=i.font._nativeAsset:Bb.load(i.font.nativeUrl,function(e,t){Aq=t||"Arial",i.updateRenderData(!0)}):Aq="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){pq=t.context,_q=t.canvas,vq=e.spriteFrame,yq=e.string.toString(),gq=e.fontSize,bq=gq,kq=e.overflow,Sq.width=e.node.width,Sq.height=e.node.height,wq=e.lineHeight,Tq=e.horizontalAlign,Eq=e.verticalAlign,Cq=e.color,zq=e.isBold,Bq=e.isItalic,Pq=e.isUnderline,Rq=kq!==hq.NONE&&(kq===hq.RESIZE_HEIGHT||e.enableWrapText);var i=fq&&e.getComponent(TF);i&&i.enabled?(Oq=!0,Lq=Iq=i.width,(Mq=i.color.clone()).a=Mq.a*e.color.a/255):(Oq=!1,Lq=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=xq.length;return e=Tq===tB.RIGHT?Sq.width-Lq:Tq===tB.CENTER?Sq.width/2:0+Lq,t=Eq===nB.TOP?0:Eq===nB.CENTER?Sq.height/2-i*(n-1)/2:Sq.height-i*(n-1),new Mi(e,t)},_updateTexture:function(){if(pq&&_q){pq.clearRect(0,0,_q.width,_q.height),pq.font=mq;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();pq.lineJoin="round",pq.fillStyle="rgba(".concat(Cq.r,", ").concat(Cq.g,", ").concat(Cq.b,", ").concat(Cq.a/255,")");for(var n=0;n<xq.length;++n){if(Oq){var r=Mq||dq;pq.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),pq.lineWidth=2*Iq,pq.strokeText(xq[n],t.x,t.y+n*i)}pq.fillText(xq[n],t.x,t.y+n*i),Pq&&(e=this._calculateUnderlineStartPosition(),pq.save(),pq.beginPath(),pq.lineWidth=gq/8,pq.strokeStyle="rgba(".concat(Cq.r,", ").concat(Cq.g,", ").concat(Cq.b,", ").concat(Cq.a/255,")"),pq.moveTo(e.x,e.y+n*i-1),pq.lineTo(e.x+_q.width,e.y+n*i-1),pq.stroke(),pq.restore())}if(vq){var a;a=vq instanceof yf?vq.texture:vq;var s=0===_q.width||0===_q.height;a.reset({width:_q.width,height:_q.height,mipmapLevel:s?0:1}),s||a.uploadData(_q)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=xq.length;return e=0+Lq,t=Eq===nB.TOP?gq:Eq===nB.CENTER?Sq.height/2-i*(n-1)/2+gq/2:Sq.height-i*(n-1),new Mi(e,t)},_updateLabelDimensions:function(){if(pq){var e=yq.split("\n");if(kq===hq.RESIZE_HEIGHT)Sq.height=xq.length*this._getLineHeight();else if(kq===hq.NONE){var t=0,i=0,n=xq=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=qs(pq,s);t=o<t?t:o}i=xq.length*this._getLineHeight(),Sq.width=parseFloat(t.toFixed(2))+2*Lq,Sq.height=parseFloat(i.toFixed(2)),Bq&&(Sq.width+=bq*Math.tan(.20943951))}_q&&(_q.width=Sq.width,_q.height=Sq.height)}},_calculateTextBaseline:function(){var e,t;e=Tq===tB.RIGHT?"right":Tq===tB.CENTER?"center":"left",t=Eq===nB.TOP?"top":Eq===nB.CENTER?"middle":"bottom",pq&&(pq.textAlign=e,pq.textBaseline=t)},_calculateSplitedStrings:function(){if(pq){var e=yq.split("\n");if(Rq){xq=[];var t=Sq.width-2*Lq,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=js(a,qs(pq,a),t,this._measureText(pq));xq=xq.concat(s)}}else xq=e}},_getFontDesc:function(){var e=gq.toString()+"px ";return e+=Aq,zq&&(e="bold "+e),Bq&&(e="italic "+e),e},_getLineHeight:function(){var e=wq;return 0|(e=0===e?gq:e*gq/bq)},_calculateParagraphLength:function(e,t){var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=qs(t,s);i.push(o)}return i},_measureText:function(t){return function(e){return qs(t,e)}},_calculateLabelFont:function(){if(pq&&(mq=this._getFontDesc(),pq.font=mq,kq===hq.SHRINK)){var e=yq.split("\n"),t=this._calculateParagraphLength(e,pq);xq=e;var i=0,n=0,r=0;if(Rq){var a=Sq.width-2*Lq,s=Sq.height-2*Lq;if(a<0||s<0)return mq=this._getFontDesc(),void(pq.font=mq);n=1+s,r=1+a;for(var o=gq+1,l=[],u=!0,c=0|o;s<n||a<r;){if(u?o=c/2|0:c=o=c-1,o<=0){L(4003);break}for(gq=o,mq=this._getFontDesc(),pq.font=mq,xq=[],i=n=0;i<e.length;++i){var h=0,d=qs(pq,e[i]);for(l=js(e[i],d,a,this._measureText(pq));h<l.length;){r=qs(pq,l[h]),n+=this._getLineHeight(),++h}xq=xq.concat(l)}u&&(s<n?c=0|o:(u=!1,n=1+s))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var f=(Sq.width-2*Lq)/r,p=Sq.height/n;gq=bq*Math.min(1,f,p)|0,mq=this._getFontDesc(),pq.font=mq}}}},Nq=rr.WHITE.clone(),Uq=q3("ttf",{createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)rr.toArray(i,Nq,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.datas,r=e.node,a=t.currBufferBatch,s=a.byteOffset>>2,o=a.indiceOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,l=o=0);var u=a.vData,c=a.iData,h=i.vData,d=n[0],f=n[3];r.updateWorldTransform();var p=r._pos,_=r._rot,v=r._scale,m=d.x*v.x,y=f.x*v.x,g=d.y*v.y,b=f.y*v.y,x=_.x,S=_.y,w=_.z,T=_.w,E=x*S,C=w*T,A=x*x-S*S,k=T*T-w*w,R=k+A,O=2*(E-C),M=k-A,I=2*(E+C),L=p.x,z=p.y;h[0]=R*m+O*g+L,h[1]=M*g+I*m+z,h[9]=R*y+O*g+L,h[10]=M*g+I*y+z,h[18]=R*m+O*b+L,h[19]=M*b+I*m+z,h[27]=R*y+O*b+L,h[28]=M*b+I*y+z,u.set(h,s),c[o++]=l,c[o++]=l+1,c[o++]=l+2,c[o++]=l+2,c[o++]=l+1,c[o++]=l+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,s=i.anchorY*r,o=t.datas;o[0].x=-a,o[0].y=-s,o[3].x=n-a,o[3].y=r-s}}});Fe(Uq,Fq);var Vq=q3("labelAssembler",{getAssembler:function(e){var t=Uq;return e.font instanceof Qg?t=SW:e.cacheMode===mB.CacheMode.CHAR&&(Ll.browserType===Ll.BROWSER_TYPE_WECHAT_GAME_SUB?C("sorry, subdomain does not support CHAR mode currently!"):t=cq),t}});mB.Assembler=Vq;var Gq=XT.sharedManager,Hq=q3("mask",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,s=e.node,o=t.datas,l=s.width,u=s.height,c=s.anchorX*l,h=s.anchorY*u;i=-c,n=-h,r=l-c,a=u-h,o[0].x=i,o[0].y=n,o[3].x=r,o[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){Gq.pushMask(e),Gq.clear(),e.clearGraphics.updateAssembler(t),Gq.enterLevel(),e.graphics.updateAssembler(t),Gq.enableMask()}}),Wq=q3("maskEnd",{fillBuffers:function(e,t){Gq.exitMask()}}),qq={getAssembler:function(){return Hq}},jq={getAssembler:function(){return Wq}};$D.Assembler=qq,$D.PostAssembler=jq;var Xq=RA.FillType,Yq=new zn,Kq=q3("barFilled",{useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,s=e.fillRange;s<0&&(a+=s,s=-s),s=(s=1<(s=a+s)?1:s)<0?0:s;var o=(a=(a=1<a?1:a)<0?0:a)+(s=(s-=a)<0?0:s);o=1<o?1:o,n&&this.updateUVs(e,a,o),r&&(this.updateVerts&&this.updateVerts(e,a,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,s=n.width,o=n.height,l=n.getRect(),u=0,c=0,h=0,d=0,f=0,p=0,_=0,v=0,m=0,y=0;switch(n.isRotated()?(u=l.x/s,c=(l.y+l.width)/o,h=f=u,_=m=(l.x+l.height)/s,p=y=c,d=v=l.y/o):(u=l.x/s,c=(l.y+l.height)/o,h=_=u,f=m=(l.x+l.width)/s,d=p=c,v=y=l.y/o),e.fillType){case Xq.HORIZONTAL:a[0].u=h+(f-h)*t,a[0].v=d+(p-d)*t,a[1].u=h+(f-h)*i,a[1].v=d+(p-d)*i,a[2].u=_+(m-_)*t,a[2].v=v+(y-v)*t,a[3].u=_+(m-_)*i,a[3].v=v+(y-v)*i;break;case Xq.VERTICAL:a[0].u=h+(_-h)*t,a[0].v=d+(v-d)*t,a[1].u=f+(m-f)*t,a[1].v=p+(y-p)*t,a[2].u=h+(_-h)*i,a[2].v=d+(v-d)*i,a[3].u=f+(m-f)*i,a[3].v=p+(y-p)*i;break;default:D(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,s=a.width,o=a.height,l=a.anchorX*s,u=a.anchorY*o,c=-l,h=-u,d=s-l,f=o-u,p=0;switch(e.fillType){case Xq.HORIZONTAL:p=c+(d-c)*i,c=c+(d-c)*t,d=p;break;case Xq.VERTICAL:p=h+(f-h)*i,h=h+(f-h)*t,f=p;break;default:D(2626)}r[4].x=c,r[4].y=h,r[5].x=d,r[5].y=h,r[6].x=c,r[6].y=f,r[7].x=d,r[7].y=f,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(Yq);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];Fi.transformMat4(a,r,Yq)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,u=l=o=0);for(var c=a.vData,h=0;h<o;h++){var d=r[h];c[s++]=d.x,c[s++]=d.y,c[s++]=d.z,c[s++]=d.u,c[s++]=d.v,rr.toArray(c,n,s),s+=4}var f=a.iData;f[l++]=u,f[l++]=u+1,f[l++]=u+2,f[l++]=u+1,f[l++]=u+3,f[l++]=u+2}(0,t,e.renderData,e.color)}}),Qq=2*Math.PI,Zq=[new Mi,new Mi,new Mi,new Mi],Jq=new Array(4),$q=new Array(8),ej=[new Mi,new Mi,new Mi,new Mi],tj=[new Mi,new Mi,new Mi,new Mi],ij=new Mi,nj=[new Mi,new Mi,new Mi,new Mi];function rj(e,t,i,n,r,a,s){var o=Math.sin(a);o=1e-6<Math.abs(o)?o:0;var l=Math.cos(a),u=0,c=0;if(0!==(l=1e-6<Math.abs(l)?l:0)){if(u=o/l,0<(e-r.x)*l){var h=r.y+u*(e-r.x);s[0].x=e,s[0].y=h}if(0<(t-r.x)*l){var d=r.y+u*(t-r.x);s[2].x=t,s[2].y=d}}if(0!==o){if(c=l/o,0<(n-r.y)*o){var f=r.x+c*(n-r.y);s[3].x=f,s[3].y=n}if(0<(i-r.y)*o){var p=r.x+c*(i-r.y);s[1].x=p,s[1].y=i}}}function aj(e,t){var i=t.x-e.x,n=t.y-e.y;if(0==i&&0==n)return 0;if(0==i)return 0<n?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function sj(e,t,i,n,r){var a=Jq,s=a[0],o=a[1],l=a[2],u=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;oj((i.x-s)/(l-s),(i.y-o)/(u-o),e,t),oj((n.x-s)/(l-s),(n.y-o)/(u-o),e,t+1),oj((r.x-s)/(l-s),(r.y-o)/(u-o),e,t+2)}function oj(e,t,i,n){var r=$q,a=r[0]+(r[2]-r[0])*e,s=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,u=i[n];u.u=a+(s-a)*t,u.v=o+(l-o)*t}for(var lj=q3("radialFilled",{useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.datas,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);1<=r;)r-=1;for(;r<0;)r+=1;var s=(r*=Qq)+(a*=Qq);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,s=-r,o=-a,l=i-r,u=n-a,c=Jq;c[0]=s,c[1]=o,c[2]=l,c[3]=u;var h=e.fillCenter,d=ij.x=Math.min(Math.max(0,h.x),1)*(l-s)+s,f=ij.y=Math.min(Math.max(0,h.y),1)*(u-o)+o;Zq[0].x=Zq[3].x=s,Zq[1].x=Zq[2].x=l,Zq[0].y=Zq[1].y=o,Zq[2].y=Zq[3].y=u;var p=nj,_=Array.isArray(p),v=0;for(p=_?p:p[Symbol.iterator]();;){var m;if(_){if(v>=p.length)break;m=p[v++]}else{if((v=p.next()).done)break;m=v.value}var y=m;Mi.set(y,0,0)}d!==c[0]&&Mi.set(nj[0],3,0),d!==c[2]&&Mi.set(nj[2],1,2),f!==c[1]&&Mi.set(nj[1],0,1),f!==c[3]&&Mi.set(nj[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,s=0,o=0,l=$q;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,s=n.y/i,o=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=o,l[1]=l[5]=s):(r=n.x/t,a=(n.x+n.width)/t,s=n.y/i,o=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=o,l[5]=l[7]=s)}(t),rj(Jq[0],Jq[2],Jq[1],Jq[3],ij,r,ej),rj(Jq[0],Jq[2],Jq[1],Jq[3],ij,r+a,tj);for(var o=0,l=0;l<4;++l){var u=nj[l];if(u)if(Qq<=a)i.dataLength=o+3,sj(n,o,ij,Zq[u.x],Zq[u.y]),o+=3;else{var c=aj(ij,Zq[u.x]),h=aj(ij,Zq[u.y]);h<c&&(h+=Qq),c-=Qq,h-=Qq;for(var d=0;d<3;++d)s<=c||(r<=c?(i.dataLength=o+3,sj(n,o,ij,Zq[u.x],s<=h?tj[l]:Zq[u.y]),o+=3):h<=r||(h<=s?(i.dataLength=o+3,sj(n,o,ij,ej[l],Zq[u.y])):(i.dataLength=o+3,sj(n,o,ij,ej[l],tj[l])),o+=3)),c+=Qq,h+=Qq}}i.indiceCount=i.vertexCount=o,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,u=l=o=0);var c=a.vData;e.getWorldMatrix(pz);for(var h=0;h<o;h++){var d=r[h];Fi.set(fz,d.x,d.y,0),Fi.transformMat4(fz,fz,pz),c[s++]=fz.x,c[s++]=fz.y,c[s++]=fz.z,c[s++]=d.u,c[s++]=d.v,rr.toArray(c,n,s),s+=4}for(var f=a.iData,p=0;p<i.dataLength;p++)f[l+p]=u+p}(e.node,t,e.renderData,e.color)}}),uj=[],cj=0;cj<4;cj++)uj.push(new Fi);var hj,dj,fj,pj,_j,vj,mj,yj,gj,bj,xj=q3("simple",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,s=r.indiceOffset,o=r.vertexOffset;r.request()||(r=t.currBufferBatch,o=s=a=0);var l=r.vData,u=r.iData,c=e.renderData.vData,h=i[0],d=i[3],f=n.worldMatrix,p=f.m00,_=f.m01,v=f.m04,m=f.m05,y=f.m12,g=f.m13,b=h.x,x=d.x,S=h.y,w=d.y,T=p*b,E=p*x,C=_*b,A=_*x,k=v*S,R=v*w,O=m*S,M=m*w;c[0]=T+k+y,c[1]=C+O+g,c[9]=E+k+y,c[10]=A+O+g,c[18]=T+R+y,c[19]=C+M+g,c[27]=E+R+y,c[28]=A+M+g,l.set(c,a),u[s++]=o,u[s++]=o+1,u[s++]=o+2,u[s++]=o+2,u[s++]=o+1,u[s++]=o+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,s=i.anchorX*r,o=i.anchorY*a,l=0,u=0,c=0,h=0;if(e.trim)l=-s,u=-o,c=r-s,h=a-o;else{var d=e.spriteFrame,f=d.getOriginalSize(),p=d.getRect(),_=f.width,v=f.height,m=p.width,y=p.height,g=d.getOffset(),b=r/_,x=a/v,S=g.x+(_-m)/2,w=g.x-(_-m)/2;l=S*b-s,u=(g.y+(v-y)/2)*x-o,c=r+w*b-s,h=a+(g.y-(v-y)/2)*x-o}n[0].x=l,n[0].y=u,n[0].z=0,n[3].x=c,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,s=n.b/255,o=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=s,t[i+3]=o,i+=9}}),Sj=new Fi,wj=new zn,Tj=q3("sliced",{useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,s=n.anchorX*r,o=n.anchorY*a,l=e.spriteFrame,u=l.insetLeft,c=l.insetRight,h=l.insetTop,d=l.insetBottom,f=r-u-c,p=a-h-d,_=r/(u+c),v=a/(h+d);_=isNaN(_)||1<_?1:_,v=isNaN(v)||1<v?1:v,f=f<0?0:f,p=p<0?0:p,i[0].x=-s,i[0].y=-o,i[1].x=u*_-s,i[1].y=d*v-o,i[2].x=i[1].x+f,i[2].y=i[1].y+p,i[3].x=r-s,i[3].y=a-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,s=n.vertexCount,o=i.indiceOffset,l=i.vertexOffset,u=e.spriteFrame.uvSliced;i.request(s,n.indiceCount)||(i=t.currBufferBatch,l=o=a=0);for(var c=i.vData,h=i.iData,d=4;d<20;++d){var f=r[d],p=u[d-4];c[a++]=f.x,c[a++]=f.y,c[a++]=f.z,c[a++]=p.u,c[a++]=p.v,rr.toArray(c,e.color,a),a+=4}for(var _=0;_<3;++_)for(var v=0;v<3;++v){var m=l+4*_+v;h[o++]=m,h[o++]=m+1,h[o++]=m+4,h[o++]=m+1,h[o++]=m+5,h[o++]=m+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(wj);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var s=i[a],o=i[4+4*n+a];Fi.set(Sj,s.x,r.y,0),Fi.transformMat4(o,Sj,wj)}}}),Ej=RA.Type,Cj=RA.FillType,Aj=q3("spriteAssembler",{getAssembler:function(e){var t=xj,i=e;switch(i.type){case Ej.SLICED:t=Tj;break;case Ej.FILLED:t=i.fillType===Cj.RADIAL?lj:Kq}return t}});RA.Assembler=Aj,cc.UI={MeshBuffer:jT,UIVertexFormat:JT,barFilled:Kq,radialFilled:lj,simple:xj,sliced:Tj,ttf:Uq,bmfont:SW,letter:cq,mask:Hq,maskEnd:Wq,graphics:VH,spriteAssembler:Aj,graphicsAssembler:GH,labelAssembler:Vq};var kj,Rj,Oj,Mj,Ij,Lj,zj,Bj,Pj,Dj,Fj,Nj,Uj,Vj,Gj,Hj,Wj,qj,jj,Xj,Yj,Kj,Qj,Zj,Jj,$j,eX,tX,iX,nX,rX,aX,sX,oX,lX,uX,cX,hX,dX,fX,pX,_X,vX,mX,yX,gX,bX,xX,SX,wX,TX,EX,CX,AX,kX,RX,OX,MX,IX,LX,zX,BX,PX,DX,FX,NX,UX,VX,GX,HX,WX,qX,jX,XX,YX,KX,QX,ZX,JX,$X,eY,tY,iY,nY,rY,aY,sY,oY,lY,uY,cY,hY=q3("BillboardComponent",(hj=oo("cc.BillboardComponent"),dj=po("Components/Billboard"),fj=lo({type:uf}),pj=lo({type:uf}),hj(_j=dj(_j=ho((mj=b((vj=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_texture",mj,l(e)),m(e,"_height",yj,l(e)),m(e,"_width",gj,l(e)),m(e,"_rotation",bj,l(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new ji(1,1,0,0),e}return p(t,rp),v(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*yi(this._rotation))/100},set:function(e){this._rotation=mi(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),v(t,[{key:"onEnable",value:function(){this._model||this.createModel(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"createModel",value:function(){this._mesh=Tv({primitiveMode:Uu.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a,rr.WHITE.r,rr.WHITE.g,rr.WHITE.b,rr.WHITE.a],attributes:[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RG32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=this._getRenderScene().createModel(_v,this.node),null==this._material&&(this._material=new fm,this._material.copy(G_.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}()).prototype,"_texture",[fj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(vj.prototype,"texture",[pj],Object.getOwnPropertyDescriptor(vj.prototype,"texture"),vj.prototype),yj=b(vj.prototype,"_height",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b(vj.prototype,"height",[lo],Object.getOwnPropertyDescriptor(vj.prototype,"height"),vj.prototype),gj=b(vj.prototype,"_width",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b(vj.prototype,"width",[lo],Object.getOwnPropertyDescriptor(vj.prototype,"width"),vj.prototype),bj=b(vj.prototype,"_rotation",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b(vj.prototype,"rotation",[lo],Object.getOwnPropertyDescriptor(vj.prototype,"rotation"),vj.prototype),_j=vj))||_j)||_j)||_j)),dY=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RGBA32F},{name:Cu.ATTR_TEX_COORD1,format:Ou.RGB32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA8,isNormalized:!0}],fY=new Fi,pY=new Fi,_Y=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t)))._capacity=void 0,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=null,i._vertCount=0,i._indexCount=0,i._capacity=100,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:Iu.INDIRECT,memUsage:zu.HOST|zu.DEVICE,size:56,stride:1}),i}return p(n,_v),v(n,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;var e=dY,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.offset=this._vertSize,this._vertSize+=Xc[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=1+a,i[n++]=2+a,i[n++]=3+a,i[n++]=2+a,i[n++]=1+a}var s=this._device.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:s,indirectBuffer:this._iaInfoBuffer,attributes:dY,primitiveMode:Uu.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(1<e.length){var n=0;Fi.subtract(fY,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=fY.x,this._vdataF32[n++]=fY.y,this._vdataF32[n++]=fY.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=fY.x,this._vdataF32[n++]=fY.y,this._vdataF32[n++]=fY.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Fi.subtract(fY,e[r-1],e[r]),Fi.subtract(pY,e[r+1],e[r]),Fi.subtract(pY,pY,fY);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=pY.x,this._vdataF32[n++]=pY.y,this._vdataF32[n++]=pY.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=pY.x,this._vdataF32[n++]=pY.y,this._vdataF32[n++]=pY.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}Fi.subtract(fY,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=fY.x,this._vdataF32[n++]=fY.y,this._vdataF32[n++]=fY.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=fY.x,this._vdataF32[n++]=fY.y,this._vdataF32[n++]=fY.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),vY=vt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),mY=(kj=oo("cc.CurveRange"),Rj=lo({type:vY}),Oj=lo({type:Ps}),Mj=lo({type:Ps}),Ij=lo({type:Ps}),kj((Wj=Hj=function(){function e(){y(this,e),m(this,"mode",Bj,this),m(this,"curve",Pj,this),m(this,"curveMin",Dj,this),m(this,"curveMax",Fj,this),m(this,"constant",Nj,this),m(this,"constantMin",Uj,this),m(this,"constantMax",Vj,this),m(this,"multiplier",Gj,this)}return v(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case vY.Constant:return this.constant;case vY.Curve:return this.curve.evaluate(e)*this.multiplier;case vY.TwoCurves:return vi(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case vY.TwoConstants:return vi(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case vY.Constant:return this.constant;case vY.Curve:return this.multiplier;case vY.TwoConstants:return this.constantMax;case vY.TwoCurves:return this.multiplier}return 0}}]),e}(),Hj.Mode=vY,Bj=b((zj=Wj).prototype,"mode",[Rj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vY.Constant}}),Pj=b(zj.prototype,"curve",[Oj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ps}}),Dj=b(zj.prototype,"curveMin",[Mj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ps}}),Fj=b(zj.prototype,"curveMax",[Ij],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ps}}),Nj=b(zj.prototype,"constant",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uj=b(zj.prototype,"constantMin",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vj=b(zj.prototype,"constantMax",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gj=b(zj.prototype,"multiplier",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Lj=zj))||Lj),yY=vt({Blend:0,Fixed:1}),gY=(oo("cc.ColorKey")((Xj=b((jj=function e(){y(this,e),m(this,"color",Xj,this),m(this,"time",Yj,this)}).prototype,"color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),Yj=b(jj.prototype,"time",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qj=jj)),oo("cc.AlphaKey")((Zj=b((Qj=function e(){y(this,e),m(this,"alpha",Zj,this),m(this,"time",Jj,this)}).prototype,"alpha",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Jj=b(Qj.prototype,"time",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kj=Qj)),oo("cc.Gradient")((aX=rX=function(){function e(){y(this,e),m(this,"colorKeys",tX,this),m(this,"alphaKeys",iX,this),m(this,"mode",nX,this),this._color=void 0,this._color=rr.WHITE.clone()}return v(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(rr.WHITE),this._color;e=Ci(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(i<=e&&e<n){if(this.mode===yY.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return rr.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?rr.lerp(this._color,rr.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&rr.lerp(this._color,this.colorKeys[a].color,rr.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Ci(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(i<=e&&e<n){if(this.mode===yY.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return vi(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?vi(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?vi(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),rX.Mode=yY,tX=b((eX=aX).prototype,"colorKeys",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),iX=b(eX.prototype,"alphaKeys",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),nX=b(eX.prototype,"mode",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yY.Blend}}),$j=eX))||$j),bY=vt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),xY=(sX=oo("cc.GradientRange"),oX=lo({type:bY}),lX=lo({type:gY}),uX=lo({type:gY}),cX=lo({type:gY}),hX=lo({type:bY}),sX((SX=xX=function(){function e(){y(this,e),m(this,"color",pX,this),m(this,"colorMin",_X,this),m(this,"colorMax",vX,this),m(this,"gradient",mX,this),m(this,"gradientMin",yX,this),m(this,"gradientMax",gX,this),m(this,"_mode",bX,this),this._color=rr.WHITE.clone()}return v(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case bY.Color:return this.color;case bY.TwoColors:return rr.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case bY.RandomColor:return this.gradient.randomColor();case bY.Gradient:return this.gradient.evaluate(e);case bY.TwoGradients:return rr.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),xX.Mode=bY,b((fX=SX).prototype,"mode",[oX],Object.getOwnPropertyDescriptor(fX.prototype,"mode"),fX.prototype),pX=b(fX.prototype,"color",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),_X=b(fX.prototype,"colorMin",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),vX=b(fX.prototype,"colorMax",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rr.WHITE.clone()}}),mX=b(fX.prototype,"gradient",[lX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gY}}),yX=b(fX.prototype,"gradientMin",[uX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gY}}),gX=b(fX.prototype,"gradientMax",[cX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gY}}),bX=b(fX.prototype,"_mode",[hX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bY.Color}}),dX=fX))||dX),SY="CC_USE_WORLD_SPACE",wY={CC_USE_WORLD_SPACE:!1},TY=q3("LineComponent",(wX=oo("cc.LineComponent"),TX=po("Components/Line"),EX=lo({type:uf}),CX=lo({type:uf,displayOrder:0}),AX=lo({displayOrder:1}),kX=lo({type:[Fi]}),RX=lo({type:[Fi],displayOrder:2}),OX=lo({type:mY}),MX=lo({type:mY,displayOrder:3}),IX=lo({type:Mi,displayOrder:4}),LX=lo({type:Mi,displayOrder:5}),zX=lo({type:xY}),BX=lo({type:xY,displayOrder:6}),wX(PX=TX(PX=ho((FX=b((DX=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_texture",FX,l(e)),e._material=null,m(e,"_worldSpace",NX,l(e)),m(e,"_positions",UX,l(e)),m(e,"_width",VX,l(e)),m(e,"_tile",GX,l(e)),m(e,"_offset",HX,l(e)),m(e,"_color",WX,l(e)),e._model=null,e._tile_offset=new ji,e}return p(t,rp),v(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(wY[SY]=this.worldSpace,this._material.recompileShaders(wY),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),v(t,[{key:"onEnable",value:function(){this._model||(this._model=this._getRenderScene().createModel(_Y,this.node),this._model.setCapacity(100),null==this._material&&(this._material=new fm,this._material.copy(G_.get("default-trail-material")),wY[SY]=this.worldSpace,this._material.recompileShaders(wY)),this._model.setSubModelMaterial(0,this._material)),this._model.enabled=!0,this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}}]),t}()).prototype,"_texture",[EX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(DX.prototype,"texture",[CX],Object.getOwnPropertyDescriptor(DX.prototype,"texture"),DX.prototype),NX=b(DX.prototype,"_worldSpace",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b(DX.prototype,"worldSpace",[AX],Object.getOwnPropertyDescriptor(DX.prototype,"worldSpace"),DX.prototype),UX=b(DX.prototype,"_positions",[kX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),b(DX.prototype,"positions",[RX],Object.getOwnPropertyDescriptor(DX.prototype,"positions"),DX.prototype),VX=b(DX.prototype,"_width",[OX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),b(DX.prototype,"width",[MX],Object.getOwnPropertyDescriptor(DX.prototype,"width"),DX.prototype),GX=b(DX.prototype,"_tile",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),b(DX.prototype,"tile",[IX],Object.getOwnPropertyDescriptor(DX.prototype,"tile"),DX.prototype),HX=b(DX.prototype,"_offset",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0)}}),b(DX.prototype,"offset",[LX],Object.getOwnPropertyDescriptor(DX.prototype,"offset"),DX.prototype),WX=b(DX.prototype,"_color",[zX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xY}}),b(DX.prototype,"color",[BX],Object.getOwnPropertyDescriptor(DX.prototype,"color"),DX.prototype),PX=DX))||PX)||PX)||PX)),EY=(qX=oo("cc.ColorOvertimeModule"),jX=lo({displayOrder:0}),XX=lo({type:xY,displayOrder:1}),qX((QX=b((KX=function(){function e(){y(this,e),m(this,"enable",QX,this),m(this,"color",ZX,this)}return v(e,[{key:"animate",value:function(e){this.enable&&(e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Si(e.randomSeed+91041))))}}]),e}()).prototype,"enable",[jX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZX=b(KX.prototype,"color",[XX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xY}}),YX=KX))||YX),CY=vt({World:0,Local:1,Custom:2}),AY=vt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),kY=vt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),RY=vt({Base:0,Edge:1,Shell:2,Volume:3}),OY=vt({Random:0,Loop:1,PingPong:2}),MY=vt({Particles:0,Ribbon:1}),IY=vt({Stretch:0,Repeat:1}),LY=new Fi(0,0,-1);function zY(e,t,i,n){return t!==e?(e===CY.World||zn.invert(i,i),zn.getRotation(n,i),!0):(hn.set(n,0,0,0,1),!1)}function BY(e,t){Mi.set(e,Math.cos(t),Math.sin(t))}function PY(e){var t=bi(-1,1),i=bi(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);Fi.set(e,r,a,t)}function DY(e,t,i){PY(e),Fi.multiplyScalar(e,e,t+(i-t)*gi())}function FY(e,t,i,n){BY(e,n),e.z=0,Fi.multiplyScalar(e,e,t+(i-t)*gi())}function NY(e){for(var t=0;t<e.length;t++){var i=t+xi(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function UY(){var e=bi(-1,1);return 0===e&&e++,se(e)}var VY,GY,HY,WY,qY,jY,XY,YY,KY,QY,ZY,JY,$Y,eK,tK,iK,nK,rK,aK,sK,oK,lK,uK,cK,hK,dK,fK,pK,_K,vK,mK,yK,gK=212165,bK=new Fi,xK=(JX=oo("cc.ForceOvertimeModule"),$X=lo({displayOrder:0}),eY=lo({type:mY,range:[-1,1],displayOrder:2}),tY=lo({type:mY,range:[-1,1],displayOrder:3}),iY=lo({type:mY,range:[-1,1],displayOrder:4}),nY=lo({type:CY,displayOrder:1}),JX((sY=b((aY=function(){function e(){y(this,e),m(this,"enable",sY,this),m(this,"x",oY,this),m(this,"y",lY,this),m(this,"z",uY,this),m(this,"space",cY,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new hn,this.needTransform=!1}return v(e,[{key:"update",value:function(e,t){this.needTransform=zY(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Fi.set(bK,this.x.evaluate(i,Si(e.randomSeed+gK)),this.y.evaluate(i,Si(e.randomSeed+gK)),this.z.evaluate(i,Si(e.randomSeed+gK)));this.needTransform&&Fi.transformQuat(n,n,this.rotation),Fi.scaleAndAdd(e.velocity,e.velocity,n,t)}}]),e}()).prototype,"enable",[$X],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oY=b(aY.prototype,"x",[eY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),lY=b(aY.prototype,"y",[tY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),uY=b(aY.prototype,"z",[iY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),cY=b(aY.prototype,"space",[nY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CY.Local}}),rY=aY))||rY),SK=23541,wK=new Fi,TK=new Fi,EK=(VY=oo("cc.LimitVelocityOvertimeModule"),GY=lo({displayOrder:0}),HY=lo({type:mY,range:[-1,1],displayOrder:4}),WY=lo({type:mY,range:[-1,1],displayOrder:5}),qY=lo({type:mY,range:[-1,1],displayOrder:6}),jY=lo({type:mY,range:[-1,1],displayOrder:3}),XY=lo({displayOrder:7}),YY=lo({displayOrder:2}),KY=lo({type:CY,displayOrder:1}),VY((JY=b((ZY=function(){function e(){y(this,e),m(this,"enable",JY,this),m(this,"limitX",$Y,this),m(this,"limitY",eK,this),m(this,"limitZ",tK,this),m(this,"limit",iK,this),m(this,"dampen",nK,this),m(this,"separateAxes",rK,this),m(this,"space",aK,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new hn,this.needTransform=!1}return v(e,[{key:"update",value:function(e,t){this.needTransform=zY(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=wK;this.separateAxes?(Fi.set(TK,this.limitX.evaluate(t,Si(e.randomSeed+SK)),this.limitY.evaluate(t,Si(e.randomSeed+SK)),this.limitZ.evaluate(t,Si(e.randomSeed+SK))),this.needTransform&&Fi.transformQuat(TK,TK,this.rotation),Fi.set(i,CK(e.ultimateVelocity.x,TK.x,this.dampen),CK(e.ultimateVelocity.y,TK.y,this.dampen),CK(e.ultimateVelocity.z,TK.z,this.dampen))):(Fi.normalize(i,e.ultimateVelocity),Fi.multiplyScalar(i,i,CK(e.ultimateVelocity.length(),this.limit.evaluate(t,Si(e.randomSeed+SK)),this.dampen))),Fi.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[GY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$Y=b(ZY.prototype,"limitX",[HY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),eK=b(ZY.prototype,"limitY",[WY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),tK=b(ZY.prototype,"limitZ",[qY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),iK=b(ZY.prototype,"limit",[jY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),nK=b(ZY.prototype,"dampen",[XY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),rK=b(ZY.prototype,"separateAxes",[YY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),aK=b(ZY.prototype,"space",[KY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CY.Local}}),QY=ZY))||QY);function CK(e,t,i){var n=Math.sign(e),r=Math.abs(e);return t<r&&(r=vi(r,t,i)),r*n}var AK,kK,RK,OK,MK,IK,LK,zK,BK,PK,DK,FK,NK,UK,VK,GK,HK,WK,qK,jK,XK,YK,KK,QK,ZK,JK,$K,eQ,tQ,iQ,nQ,rQ,aQ,sQ,oQ,lQ,uQ,cQ,hQ,dQ,fQ,pQ,_Q,vQ,mQ,yQ,gQ,bQ,xQ,SQ,wQ,TQ,EQ,CQ,AQ,kQ,RQ,OQ,MQ,IQ,LQ,zQ,BQ,PQ,DQ,FQ,NQ,UQ,VQ,GQ,HQ,WQ,qQ,jQ,XQ,YQ,KQ,QQ,ZQ,JQ,$Q,eZ,tZ,iZ,nZ,rZ,aZ,sZ,oZ,lZ,uZ,cZ,hZ,dZ,fZ,pZ,_Z,vZ,mZ,yZ,gZ,bZ,xZ,SZ,wZ,TZ,EZ,CZ,AZ,kZ=(sK=oo("cc.RotationOvertimeModule"),oK=lo({displayOrder:0}),lK=lo({displayOrder:1}),uK=lo({type:mY,range:[-1,1],radian:!0,displayOrder:2}),cK=lo({type:mY,range:[-1,1],radian:!0,displayOrder:3}),hK=lo({type:mY,range:[-1,1],radian:!0,displayOrder:4}),sK((pK=b((fK=function(){function e(){y(this,e),m(this,"enable",pK,this),m(this,"_separateAxes",_K,this),m(this,"x",vK,this),m(this,"y",mK,this),m(this,"z",yK,this)}return v(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),v(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=Si(e.randomSeed+125292);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,Si(e.randomSeed+125292))*t}}]),e}()).prototype,"enable",[oK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_K=b(fK.prototype,"_separateAxes",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b(fK.prototype,"separateAxes",[lK],Object.getOwnPropertyDescriptor(fK.prototype,"separateAxes"),fK.prototype),vK=b(fK.prototype,"x",[uK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),mK=b(fK.prototype,"y",[cK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),yK=b(fK.prototype,"z",[hK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),dK=fK))||dK),RZ=(AK=oo("cc.SizeOvertimeModule"),kK=lo({displayOrder:0}),RK=lo({displayOrder:1}),OK=lo({type:mY,displayOrder:2}),MK=lo({type:mY,displayOrder:3}),IK=lo({type:mY,displayOrder:4}),LK=lo({type:mY,displayOrder:5}),AK((PK=b((BK=function(){function e(){y(this,e),m(this,"enable",PK,this),m(this,"separateAxes",DK,this),m(this,"size",FK,this),m(this,"x",NK,this),m(this,"y",UK,this),m(this,"z",VK,this)}return v(e,[{key:"animate",value:function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,i=Si(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else Fi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Si(e.randomSeed+39825)))}}]),e}()).prototype,"enable",[kK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DK=b(BK.prototype,"separateAxes",[RK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FK=b(BK.prototype,"size",[OK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),NK=b(BK.prototype,"x",[MK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),UK=b(BK.prototype,"y",[IK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),VK=b(BK.prototype,"z",[LK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),zK=BK))||zK),OZ=90794,MZ=vt({Grid:0}),IZ=vt({WholeSheet:0,SingleRow:1}),LZ=(GK=oo("cc.TextureAnimationModule"),HK=lo({displayOrder:0}),WK=lo({type:MZ}),qK=lo({type:MZ,displayOrder:1}),jK=lo({displayOrder:2}),XK=lo({displayOrder:3}),YK=lo({type:IZ,displayOrder:4}),KK=lo({type:mY,displayOrder:7}),QK=lo({type:mY,displayOrder:8}),ZK=lo({displayOrder:9}),JK=lo({displayOrder:5}),$K=lo({displayOrder:6}),GK((iQ=b((tQ=function(){function e(){y(this,e),m(this,"_enable",iQ,this),m(this,"_mode",nQ,this),m(this,"numTilesX",rQ,this),m(this,"numTilesY",aQ,this),m(this,"animation",sQ,this),m(this,"frameOverTime",oQ,this),m(this,"startFrame",lQ,this),m(this,"cycleCount",uQ,this),m(this,"_flipU",cQ,this),m(this,"_flipV",hQ,this),m(this,"_uvChannelMask",dQ,this),m(this,"randomRow",fQ,this),m(this,"rowIndex",pQ,this),this.ps=null}return v(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,Si(e.randomSeed+OZ))/(this.numTilesX*this.numTilesY);if(this.animation===IZ.WholeSheet)e.frameIndex=Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Si(e.randomSeed+OZ))+i),1);else if(this.animation===IZ.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Si(e.randomSeed+OZ))+i),1),a=e.startRow*n,s=a+n;e.frameIndex=vi(a,s,r)}else{var o=this.rowIndex*n,l=o+n;e.frameIndex=vi(o,l,Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Si(e.randomSeed+OZ))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps&&this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e===MZ.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b(tQ.prototype,"enable",[HK],Object.getOwnPropertyDescriptor(tQ.prototype,"enable"),tQ.prototype),nQ=b(tQ.prototype,"_mode",[WK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MZ.Grid}}),b(tQ.prototype,"mode",[qK],Object.getOwnPropertyDescriptor(tQ.prototype,"mode"),tQ.prototype),rQ=b(tQ.prototype,"numTilesX",[jK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aQ=b(tQ.prototype,"numTilesY",[XK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sQ=b(tQ.prototype,"animation",[YK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IZ.WholeSheet}}),oQ=b(tQ.prototype,"frameOverTime",[KK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),lQ=b(tQ.prototype,"startFrame",[QK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),uQ=b(tQ.prototype,"cycleCount",[ZK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cQ=b(tQ.prototype,"_flipU",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hQ=b(tQ.prototype,"_flipV",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dQ=b(tQ.prototype,"_uvChannelMask",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),fQ=b(tQ.prototype,"randomRow",[JK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pQ=b(tQ.prototype,"rowIndex",[$K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eQ=tQ))||eQ),zZ=new Fi,BZ=(_Q=oo("cc.VelocityOvertimeModule"),vQ=lo({displayOrder:0}),mQ=lo({type:mY,range:[-1,1],displayOrder:2}),yQ=lo({type:mY,range:[-1,1],displayOrder:3}),gQ=lo({type:mY,range:[-1,1],displayOrder:4}),bQ=lo({type:mY,range:[-1,1],displayOrder:5}),xQ=lo({type:CY,displayOrder:1}),_Q((TQ=b((wQ=function(){function e(){y(this,e),m(this,"enable",TQ,this),m(this,"x",EQ,this),m(this,"y",CQ,this),m(this,"z",AQ,this),m(this,"speedModifier",kQ,this),m(this,"space",RQ,this),this.rotation=void 0,this.needTransform=void 0,this.rotation=new hn,this.speedModifier.constant=1,this.needTransform=!1}return v(e,[{key:"update",value:function(e,t){this.needTransform=zY(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Fi.set(zZ,this.x.evaluate(t,Si(197866^e.randomSeed)),this.y.evaluate(t,Si(156497^e.randomSeed)),this.z.evaluate(t,Si(984136^e.randomSeed)));this.needTransform&&Fi.transformQuat(i,i,this.rotation),Fi.add(e.animatedVelocity,e.animatedVelocity,i),Fi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Fi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Si(e.randomSeed+197866)))}}]),e}()).prototype,"enable",[vQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EQ=b(wQ.prototype,"x",[mQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),CQ=b(wQ.prototype,"y",[yQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),AQ=b(wQ.prototype,"z",[gQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),kQ=b(wQ.prototype,"speedModifier",[bQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),RQ=b(wQ.prototype,"space",[xQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CY.Local}}),SQ=wQ))||SQ),PZ=(OQ=oo("cc.Burst"),MQ=lo({type:mY}),OQ((zQ=b((LQ=function(){function e(){y(this,e),m(this,"_time",zQ,this),m(this,"minCount",BQ,this),m(this,"maxCount",PQ,this),m(this,"_repeatCount",DQ,this),m(this,"repeatInterval",FQ,this),m(this,"count",NQ,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=1,this._curTime=0}return v(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),v(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount){var i=Ci(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=0<i?i:0;var n=Ci(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b(LQ.prototype,"time",[lo],Object.getOwnPropertyDescriptor(LQ.prototype,"time"),LQ.prototype),BQ=b(LQ.prototype,"minCount",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),PQ=b(LQ.prototype,"maxCount",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),DQ=b(LQ.prototype,"_repeatCount",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b(LQ.prototype,"repeatCount",[lo],Object.getOwnPropertyDescriptor(LQ.prototype,"repeatCount"),LQ.prototype),FQ=b(LQ.prototype,"repeatInterval",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NQ=b(LQ.prototype,"count",[MQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),IQ=LQ))||IQ),DZ=new Fi(0,0,0),FZ=new Array,NZ=new Fi(.5,.5,.5),UZ=(UQ=oo("cc.ShapeModule"),VQ=lo({displayOrder:13}),GQ=lo({displayOrder:14}),HQ=lo({displayOrder:15}),WQ=lo({displayOrder:6}),qQ=lo({displayOrder:5}),jQ=lo({displayOrder:0}),XQ=lo({type:kY,displayOrder:1,formerlySerializedAs:"shapeType"}),YQ=lo({type:kY}),KQ=lo({type:RY,displayOrder:2}),QQ=lo({displayOrder:16}),ZQ=lo({displayOrder:17}),JQ=lo({displayOrder:18}),$Q=lo({displayOrder:19}),eZ=lo({displayOrder:3}),tZ=lo({displayOrder:4}),iZ=lo({type:OY,displayOrder:7}),nZ=lo({displayOrder:9}),rZ=lo({type:mY,displayOrder:10}),aZ=lo({displayOrder:11}),sZ=lo({displayOrder:12}),UQ((b((lZ=function(){function e(){y(this,e),m(this,"enable",uZ,this),m(this,"_shapeType",cZ,this),m(this,"emitFrom",hZ,this),m(this,"alignToDirection",dZ,this),m(this,"randomDirectionAmount",fZ,this),m(this,"sphericalDirectionAmount",pZ,this),m(this,"randomPositionAmount",_Z,this),m(this,"radius",vZ,this),m(this,"radiusThickness",mZ,this),m(this,"arcMode",yZ,this),m(this,"arcSpread",gZ,this),m(this,"arcSpeed",bZ,this),m(this,"length",xZ,this),m(this,"boxThickness",SZ,this),m(this,"_position",wZ,this),m(this,"_rotation",TZ,this),m(this,"_scale",EZ,this),m(this,"_arc",CZ,this),m(this,"_angle",AZ,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new zn,this.quat=new hn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return v(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return yi(this._arc)},set:function(e){this._arc=mi(e)}},{key:"angle",get:function(){return Math.round(100*yi(this._angle))/100},set:function(e){this._angle=mi(e)}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case kY.Box:this.emitFrom===RY.Base&&(this.emitFrom=RY.Volume);break;case kY.Cone:this.emitFrom===RY.Edge&&(this.emitFrom=RY.Base);break;case kY.Sphere:case kY.Hemisphere:this.emitFrom!==RY.Base&&this.emitFrom!==RY.Edge||(this.emitFrom=RY.Volume)}}}]),v(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case kY.Box:!function(e,t,i,n){switch(e){case RY.Volume:!function(e,t){Fi.set(e,bi(-t.x,t.x),bi(-t.y,t.y),bi(-t.z,t.z))}(i,NZ);break;case RY.Shell:FZ.splice(0,FZ.length),FZ.push(bi(-.5,.5)),FZ.push(bi(-.5,.5)),FZ.push(.5*UY()),NY(FZ),VZ(FZ,t),Fi.set(i,FZ[0],FZ[1],FZ[2]);break;case RY.Edge:FZ.splice(0,FZ.length),FZ.push(bi(-.5,.5)),FZ.push(.5*UY()),FZ.push(.5*UY()),NY(FZ),VZ(FZ,t),Fi.set(i,FZ[0],FZ[1],FZ[2]);break;default:console.warn(e+" is not supported for box emitter.")}Fi.copy(n,LY)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case kY.Circle:!function(e,t,i,n,r){FY(n,e*(1-t),e,i),Fi.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case kY.Cone:!function(e,t,i,n,r,a,s,o){switch(e){case RY.Base:FY(s,t*(1-i),t,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Fi.normalize(o,o),s.z=0;break;case RY.Shell:BY(s,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r),Fi.normalize(o,o),Mi.multiplyScalar(s,s,t),s.z=0;break;case RY.Volume:FY(s,t*(1-i),t,n),Mi.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Fi.normalize(o,o),s.z=0,Fi.add(s,s,Fi.multiplyScalar(DZ,o,a*gi()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case kY.Sphere:!function(e,t,i,n,r){switch(e){case RY.Volume:DY(n,t*(1-i),t),Fi.copy(r,n),Fi.normalize(r,r);break;case RY.Shell:PY(n),Fi.multiplyScalar(n,n,t),Fi.copy(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case kY.Hemisphere:!function(e,t,i,n,r){switch(e){case RY.Volume:DY(n,t*(1-i),t),0<n.z&&(n.z*=-1),Fi.copy(r,n),Fi.normalize(r,r);break;case RY.Shell:PY(n),Fi.multiplyScalar(n,n,t),0<n.z&&(n.z*=-1),Fi.copy(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(0<this.randomPositionAmount&&(e.position.x+=bi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=bi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=bi(-this.randomPositionAmount,this.randomPositionAmount)),Fi.transformQuat(e.velocity,e.velocity,this.quat),Fi.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount){var t=Fi.normalize(DZ,e.position);Fi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){hn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),zn.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===OY.Random)return bi(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case OY.Loop:return Ci(e,this._arc);case OY.PingPong:return Ai(e,this._arc)}}}]),e}()).prototype,"position",[VQ],Object.getOwnPropertyDescriptor(lZ.prototype,"position"),lZ.prototype),b(lZ.prototype,"rotation",[GQ],Object.getOwnPropertyDescriptor(lZ.prototype,"rotation"),lZ.prototype),b(lZ.prototype,"scale",[HQ],Object.getOwnPropertyDescriptor(lZ.prototype,"scale"),lZ.prototype),b(lZ.prototype,"arc",[WQ],Object.getOwnPropertyDescriptor(lZ.prototype,"arc"),lZ.prototype),b(lZ.prototype,"angle",[qQ],Object.getOwnPropertyDescriptor(lZ.prototype,"angle"),lZ.prototype),uZ=b(lZ.prototype,"enable",[jQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cZ=b(lZ.prototype,"_shapeType",[XQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kY.Cone}}),b(lZ.prototype,"shapeType",[YQ],Object.getOwnPropertyDescriptor(lZ.prototype,"shapeType"),lZ.prototype),hZ=b(lZ.prototype,"emitFrom",[KQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RY.Volume}}),dZ=b(lZ.prototype,"alignToDirection",[QQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fZ=b(lZ.prototype,"randomDirectionAmount",[ZQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pZ=b(lZ.prototype,"sphericalDirectionAmount",[JQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_Z=b(lZ.prototype,"randomPositionAmount",[$Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vZ=b(lZ.prototype,"radius",[eZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mZ=b(lZ.prototype,"radiusThickness",[tZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yZ=b(lZ.prototype,"arcMode",[iZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OY.Random}}),gZ=b(lZ.prototype,"arcSpread",[nZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bZ=b(lZ.prototype,"arcSpeed",[rZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),xZ=b(lZ.prototype,"length",[aZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),SZ=b(lZ.prototype,"boxThickness",[sZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),wZ=b(lZ.prototype,"_position",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),TZ=b(lZ.prototype,"_rotation",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),EZ=b(lZ.prototype,"_scale",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),CZ=b(lZ.prototype,"_arc",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi(360)}}),AZ=b(lZ.prototype,"_angle",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mi(25)}}),oZ=lZ))||oZ);function VZ(e,t){0<t.x&&(e[0]+=.5*bi(-t.x,t.x),e[0]=pi(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*bi(-t.y,t.y),e[1]=pi(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*bi(-t.z,t.z),e[2]=pi(e[2],-.5,.5))}function GZ(e){y(this,GZ),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new Fi(0,0,0),this.velocity=new Fi(0,0,0),this.animatedVelocity=new Fi(0,0,0),this.ultimateVelocity=new Fi(0,0,0),this.angularVelocity=new Fi(0,0,0),this.axisOfRotation=new Fi(0,0,0),this.rotation=new Fi(0,0,0),this.startSize=new Fi(0,0,0),this.size=new Fi(0,0,0),this.startColor=rr.WHITE.clone(),this.color=rr.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}var HZ,WZ,qZ,jZ,XZ,YZ,KZ,QZ,ZZ,JZ,$Z,eJ,tJ,iJ,nJ,rJ,aJ,sJ,oJ,lJ,uJ,cJ,hJ,dJ,fJ,pJ,_J,vJ,mJ,yJ,gJ,bJ,xJ,SJ,wJ,TJ,EJ,CJ,AJ,kJ,RJ,OJ,MJ,IJ,LJ,zJ,BJ,PJ,DJ,FJ=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t)))._capacity=void 0,i._vertAttrs=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._mesh=void 0,i._vertCount=0,i._indexCount=0,i._type="particle-batch",i._capacity=0,i._vertAttrs=null,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:Iu.INDIRECT,memUsage:zu.HOST|zu.DEVICE,size:56,stride:1}),i._subMeshData=null,i._mesh=null,i}return p(n,_v),v(n,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.offset=this._vertSize,this._vertSize+=Xc[s.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex(function(e){return e.name===Cu.ATTR_TEX_COORD3}),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,Cu.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Cu.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===Cu.ATTR_TEX_COORD})].offset,this._mesh.copyAttribute(0,Cu.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Cu.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=rr.WHITE._val;for(var s=new Float32Array(t),o=1;o<this._capacity;o++)s.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var u=1;u<this._capacity;u++)for(var c=0;c<this._indexCount;c++)l[u*this._indexCount+c]=l[c]+u*this._vertCount}else for(var h=0,d=0;d<this._capacity;++d){var f=4*d;l[h++]=f,l[h++]=1+f,l[h++]=2+f,l[h++]=3+f,l[h++]=2+f,l[h++]=1+f}var p=this._device.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return p.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:p,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Uu.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),_(g(n.prototype),"setSubModelMaterial",this).call(this,e,t)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){_(g(n.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),NJ=new Fi,UJ=(new Mi,new zn),VJ=[0,0,1,0,0,1,1,1],GJ="CC_USE_WORLD_SPACE",HJ="CC_USE_BILLBOARD",WJ="CC_USE_STRETCHED_BILLBOARD",qJ="CC_USE_HORIZONTAL_BILLBOARD",jJ="CC_USE_VERTICAL_BILLBOARD",XJ="CC_USE_MESH",YJ=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD1,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD2,format:Ou.RGB32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA8,isNormalized:!0}],KJ=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD1,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD2,format:Ou.RGB32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA8,isNormalized:!0},{name:Cu.ATTR_COLOR1,format:Ou.RGB32F}],QJ=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD1,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD2,format:Ou.RGB32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA8,isNormalized:!0},{name:Cu.ATTR_TEX_COORD3,format:Ou.RGB32F},{name:Cu.ATTR_NORMAL,format:Ou.RGB32F},{name:Cu.ATTR_COLOR1,format:Ou.RGBA8,isNormalized:!0}],ZJ=(HZ=oo("cc.ParticleSystemRenderer"),WZ=lo({type:AY,displayOrder:0}),qZ=lo({displayOrder:1}),jZ=lo({displayOrder:2}),XZ=lo({type:AY,displayOrder:3}),YZ=lo({displayOrder:4}),KZ=lo({displayOrder:5}),QZ=lo({displayOrder:6}),ZZ=lo({type:cc.ParticleSystemComponent,visible:!1}),JZ=lo({type:rv,displayOrder:7}),$Z=lo({type:fm,displayOrder:8}),eJ=lo({type:fm,displayOrder:9}),HZ((b((iJ=function(){function e(){y(this,e),m(this,"_renderMode",nJ,this),m(this,"_velocityScale",rJ,this),m(this,"_lengthScale",aJ,this),m(this,"_mesh",sJ,this),m(this,"_particleSystem",oJ,this),this._defines=void 0,this._trailDefines=void 0,this._model=void 0,this.frameTile_velLenScale=void 0,this._node_scale=void 0,this.attrs=void 0,this._vertAttrs=[],this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new ji(1,1,0,0),this._node_scale=new ji,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return v(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===AY.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}}]),v(e,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this._particles=new Es(function(){return new GZ(t)},16),this._setVertexAttrib(),this.onEnable(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this._particleSystem&&(null==this._model&&(this._model=this._particleSystem._getRenderScene().createModel(FJ,this._particleSystem.node),this._model.visFlags=this._particleSystem.visibility),this._model.inited||(this._model.setCapacity(this._particleSystem.capacity),this._model.node=this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDestroy",value:function(){this._model&&(this._model.scene.destroyModel(this._model),this._model=null)}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this._particleSystem.node.getWorldMatrix(UJ),this._particleSystem.scaleSpace){case CY.Local:this._particleSystem.node.getScale(this._node_scale);break;case CY.World:this._particleSystem.node.getWorldScale(this._node_scale)}(this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat).setProperty("scale",this._node_scale),this._particleSystem.velocityOvertimeModule.enable&&this._particleSystem.velocityOvertimeModule.update(this._particleSystem._simulationSpace,UJ),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.update(this._particleSystem._simulationSpace,UJ),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.update(this._particleSystem._simulationSpace,UJ),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,Fi.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this._particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this._particleSystem.sizeOvertimeModule.enable&&this._particleSystem.sizeOvertimeModule.animate(i),this._particleSystem.colorOverLifetimeModule.enable&&this._particleSystem.colorOverLifetimeModule.animate(i),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.animate(i,e),this._particleSystem.velocityOvertimeModule.enable?this._particleSystem.velocityOvertimeModule.animate(i):Fi.copy(i.ultimateVelocity,i.velocity),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.animate(i),this._particleSystem.rotationOvertimeModule.enable&&this._particleSystem.rotationOvertimeModule.animate(i,e),this._particleSystem.textureAnimationModule.enable&&this._particleSystem.textureAnimationModule.animate(i),Fi.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===AY.StrecthedBillboard,i=0;i<this._particles.length;++i){var n=this._particles.data[i],r=0;this._particleSystem.textureAnimationModule.enable&&(r=n.frameIndex),e=4*i;var a=0;if(this._renderMode!==AY.Mesh)for(var s=0;s<4;++s)a=0,this.attrs[a++]=n.position,NJ.x=VJ[2*s],NJ.y=VJ[2*s+1],NJ.z=r,this.attrs[a++]=NJ,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this.attrs[a++]=t?n.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else a=0,this.attrs[a++]=n.position,NJ.z=r,this.attrs[a++]=NJ,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this._updateMaterialParams()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this._particleSystem.trailModule._trailModel&&1===e&&this._particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case AY.StrecthedBillboard:this._vertAttrs=KJ.slice();break;case AY.Mesh:this._vertAttrs=QJ.slice();break;default:this._vertAttrs=YJ.slice()}}},{key:"_updateMaterialParams",value:function(){if(this._particleSystem){null!=this._particleSystem.sharedMaterial&&-1===this._particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this._particleSystem.setMaterial(null,0,!1),null==this._particleSystem.sharedMaterial&&null==this._defaultMat&&(this._defaultMat=fm.getInstantiatedMaterial(G_.get("default-particle-material"),this._particleSystem,!0));var e=this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat;this._particleSystem._simulationSpace===CY.World?this._defines[GJ]=!0:this._defines[GJ]=!1,this._renderMode===AY.Billboard?(this._defines[HJ]=!0,this._defines[WJ]=!1,this._defines[qJ]=!1,this._defines[jJ]=!1,this._defines[XJ]=!1):this._renderMode===AY.StrecthedBillboard?(this._defines[HJ]=!1,this._defines[WJ]=!0,this._defines[qJ]=!1,this._defines[jJ]=!1,this._defines[XJ]=!1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===AY.HorizontalBillboard?(this._defines[HJ]=!1,this._defines[WJ]=!1,this._defines[qJ]=!0,this._defines[jJ]=!1,this._defines[XJ]=!1):this._renderMode===AY.VerticalBillboard?(this._defines[HJ]=!1,this._defines[WJ]=!1,this._defines[qJ]=!1,this._defines[jJ]=!0,this._defines[XJ]=!1):this._renderMode===AY.Mesh?(this._defines[HJ]=!1,this._defines[WJ]=!1,this._defines[qJ]=!1,this._defines[jJ]=!1,this._defines[XJ]=!0):console.warn("particle system renderMode ".concat(this._renderMode," not support.")),this._particleSystem.textureAnimationModule.enable&&Mi.set(this.frameTile_velLenScale,this._particleSystem.textureAnimationModule.numTilesX,this._particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,this._particleSystem.sharedMaterial||this._defaultMat)}}},{key:"_updateTrailMaterial",value:function(){if(this._particleSystem.trailModule.enable){this._particleSystem._simulationSpace===CY.World||this._particleSystem.trailModule.space===CY.World?this._trailDefines[GJ]=!0:this._trailDefines[GJ]=!1;var e=this.trailMaterial;null===e&&null===this._defaultTrailMat&&(this._defaultTrailMat=fm.getInstantiatedMaterial(G_.get("default-trail-material"),this._particleSystem,!0)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this._particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model&&this._model.setVertexAttributes(this._renderMode===AY.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[WZ],Object.getOwnPropertyDescriptor(iJ.prototype,"renderMode"),iJ.prototype),b(iJ.prototype,"velocityScale",[qZ],Object.getOwnPropertyDescriptor(iJ.prototype,"velocityScale"),iJ.prototype),b(iJ.prototype,"lengthScale",[jZ],Object.getOwnPropertyDescriptor(iJ.prototype,"lengthScale"),iJ.prototype),nJ=b(iJ.prototype,"_renderMode",[XZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AY.Billboard}}),rJ=b(iJ.prototype,"_velocityScale",[YZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),aJ=b(iJ.prototype,"_lengthScale",[KZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sJ=b(iJ.prototype,"_mesh",[QZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oJ=b(iJ.prototype,"_particleSystem",[ZZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(iJ.prototype,"mesh",[JZ],Object.getOwnPropertyDescriptor(iJ.prototype,"mesh"),iJ.prototype),b(iJ.prototype,"particleMaterial",[$Z],Object.getOwnPropertyDescriptor(iJ.prototype,"particleMaterial"),iJ.prototype),b(iJ.prototype,"trailMaterial",[eJ],Object.getOwnPropertyDescriptor(iJ.prototype,"trailMaterial"),iJ.prototype),tJ=iJ))||tJ);Object.assign(ZJ,{uv:VJ});var JJ,$J,e$,t$,i$,n$,r$,a$,s$,o$,l$,u$,c$,h$,d$,f$,p$,_$,v$,m$,y$,g$,b$,x$,S$,w$,T$,E$,C$,A$,k$,R$,O$,M$,I$,L$,z$,B$,P$,D$,F$,N$,U$,V$,G$,H$,W$,q$,j$,X$,Y$,K$,Q$,Z$,J$,$$,e0,t0,i0,n0,r0,a0,s0,o0,l0,u0,c0,h0,d0,f0,p0,_0,v0,m0,y0,g0,b0,x0,S0=Math.cos(mi(100)),w0={position:new Fi,velocity:new Fi},T0=new hn,E0=new zn,C0=new Fi,A0=new Fi,k0=new rr,R0=function(){function t(e){for(y(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new Fi,lifetime:0,width:0,velocity:new Fi,direction:0,color:new rr})}return v(t,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Fi,lifetime:0,width:0,velocity:new Fi,direction:0,color:new rr}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),O0=(lJ=oo("cc.TrailModule"),uJ=lo({displayOrder:0}),cJ=lo({type:MY,displayOrder:1}),hJ=lo({type:mY,displayOrder:3}),dJ=lo({displayOrder:5}),fJ=lo({type:CY,displayOrder:6}),pJ=lo({displayOrder:7}),_J=lo({type:IY,displayOrder:8}),vJ=lo({displayOrder:9}),mJ=lo({type:mY,displayOrder:10}),yJ=lo({displayOrder:11}),gJ=lo({type:xY,displayOrder:12}),bJ=lo({type:xY,displayOrder:13}),xJ=lo({type:CY}),SJ=lo({type:cc.ParticleSystemComponent,visible:!1}),lJ((b((TJ=function(){function a(){y(this,a),m(this,"_enable",EJ,this),m(this,"mode",CJ,this),m(this,"lifeTime",AJ,this),m(this,"_minParticleDistance",kJ,this),m(this,"existWithParticles",RJ,this),m(this,"textureMode",OJ,this),m(this,"widthFromParticle",MJ,this),m(this,"widthRatio",IJ,this),m(this,"colorFromParticle",LJ,this),m(this,"colorOverTrail",zJ,this),m(this,"colorOvertime",BJ,this),m(this,"_space",PJ,this),m(this,"_particleSystem",DJ,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RGBA32F},{name:Cu.ATTR_TEX_COORD1,format:Ou.RGB32F},{name:Cu.ATTR_COLOR,format:Ou.RGBA8,isNormalized:!0}],this._vertSize=0;var e=this._vertAttrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._vertSize+=Xc[r.format].size}this._particleTrail=new Map}return v(a,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.renderer._updateTrailMaterial()}}]),v(a,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;var t=0,i=this._particleSystem.bursts,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t+=a.getMaxCount(this._particleSystem)}this._trailNum=Math.ceil(this._particleSystem.startLifetime.getMax()*this.lifeTime.getMax()*60*(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration+t)),this._trailSegments=new Ts(function(){return new R0(10)},Math.ceil(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!0)}},{key:"onDisable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!1)}},{key:"destroy",value:function(){this._trailModel&&(this._trailModel.scene.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.clear(function(e){e.trailElements.length=0}),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.renderer.trailMaterial;e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===CY.World&&this._particleSystem._simulationSpace===CY.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(E0),this._particleSystem.node.getWorldRotation(T0)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);i||(i=this._trailSegments.alloc(),this._particleTrail.set(e,i));var n=i.getElement(i.end-1);if(this._needTransform?Fi.transformMat4(C0,e.position,E0):Fi.copy(C0,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),Fi.squaredDistance(n.position,C0)<this._minSquaredDistance))&&(n=i.addElement())){Fi.copy(n.position,C0),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);Fi.subtract(a.velocity,n.position,a.position)}else if(2<r){var s=i.getElement(i.end-2),o=i.getElement(i.end-3);Fi.subtract(C0,o.position,s.position),Fi.subtract(A0,n.position,s.position),Fi.subtract(s.velocity,A0,C0),Fi.equals(Fi.ZERO,s.velocity)&&Fi.copy(s.velocity,C0),Fi.normalize(s.velocity,s.velocity),this._checkDirectionReverse(s,o)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this._particleTrail.get(r);if(-1!==a.start){var s=4*this.vbOffset/this._vertSize,o=a.start>=a.end?a.end+a.trailElements.length:a.end,l=o-a.start,u=1/l,c=a.trailElements[a.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),s,1,0,4);for(var h=a.start+1;h<o;h++){var d=a.trailElements[h%a.trailElements.length],f=h-a.start;this._fillVertexBuffer(d,this.colorOverTrail.evaluate(1-f/l,1),s,1-f*u,f,5)}if(this._needTransform?Fi.transformMat4(w0.position,r.position,E0):Fi.copy(w0.position,r.position),1==l||2==l){var p=a.getElement(a.end-1);Fi.subtract(p.velocity,w0.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Fi.subtract(w0.velocity,w0.position,p.position),this._checkDirectionReverse(w0,p)}else if(2<l){var _=a.getElement(a.end-1),v=a.getElement(a.end-2);Fi.subtract(C0,v.position,_.position),Fi.subtract(A0,w0.position,_.position),Fi.normalize(C0,C0),Fi.normalize(A0,A0),Fi.subtract(_.velocity,A0,C0),Fi.normalize(_.velocity,_.velocity),this._checkDirectionReverse(_,v),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(_,this.colorOverTrail.evaluate(u,1),s,u,l-1,5),Fi.subtract(w0.velocity,w0.position,_.position),Fi.normalize(w0.velocity,w0.velocity),this._checkDirectionReverse(w0,_)}this.widthFromParticle?w0.width=r.size.x*this.widthRatio.evaluate(0,1):w0.width=this.widthRatio.evaluate(0,1),w0.color=r.color,Fi.equals(w0.velocity,Fi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(w0,this.colorOverTrail.evaluate(0,1),s,0,l,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&0<this._trailModel.subModelNum){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,t.inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=qE.root.device,t=e.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:Iu.INDIRECT,memUsage:zu.HOST|zu.DEVICE,size:56,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:n,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Uu.TRIANGLE_LIST,flatBuffers:[]},this._trailModel=this._particleSystem._getRenderScene().createModel(_v,this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,k0.set(e.color),k0.multiply(t),this._vbUint32[this.vbOffset++]=k0._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=k0._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}},{key:"_checkDirectionReverse",value:function(e,t){Fi.dot(e.velocity,t.velocity)<S0?e.direction=1-t.direction:e.direction=t.direction}}]),a}()).prototype,"enable",[uJ],Object.getOwnPropertyDescriptor(TJ.prototype,"enable"),TJ.prototype),EJ=b(TJ.prototype,"_enable",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CJ=b(TJ.prototype,"mode",[cJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MY.Particles}}),AJ=b(TJ.prototype,"lifeTime",[hJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),kJ=b(TJ.prototype,"_minParticleDistance",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),b(TJ.prototype,"minParticleDistance",[dJ],Object.getOwnPropertyDescriptor(TJ.prototype,"minParticleDistance"),TJ.prototype),b(TJ.prototype,"space",[fJ],Object.getOwnPropertyDescriptor(TJ.prototype,"space"),TJ.prototype),RJ=b(TJ.prototype,"existWithParticles",[pJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),OJ=b(TJ.prototype,"textureMode",[_J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IY.Stretch}}),MJ=b(TJ.prototype,"widthFromParticle",[vJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),IJ=b(TJ.prototype,"widthRatio",[mJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),LJ=b(TJ.prototype,"colorFromParticle",[yJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zJ=b(TJ.prototype,"colorOverTrail",[gJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xY}}),BJ=b(TJ.prototype,"colorOvertime",[bJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xY}}),PJ=b(TJ.prototype,"_space",[xJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CY.World}}),DJ=b(TJ.prototype,"_particleSystem",[SJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wJ=TJ))||wJ),M0=new zn,I0=q3("ParticleSystemComponent",(JJ=oo("cc.ParticleSystemComponent"),$J=po("Components/ParticleSystem"),e$=_o(99),t$=lo({displayOrder:1}),i$=lo({type:xY,displayOrder:8}),n$=lo({type:CY,displayOrder:9}),r$=lo({displayOrder:10}),a$=lo({type:mY,displayOrder:10,formerlySerializedAs:"startSize"}),s$=lo({type:mY,displayOrder:10}),o$=lo({type:mY,displayOrder:10}),l$=lo({type:mY,range:[-1,1],displayOrder:11}),u$=lo({displayOrder:12}),c$=lo({type:mY,range:[-1,1],radian:!0,displayOrder:12}),h$=lo({type:mY,range:[-1,1],radian:!0,displayOrder:12}),d$=lo({type:mY,range:[-1,1],radian:!0,displayOrder:12,formerlySerializedAs:"startRotation"}),f$=lo({type:mY,displayOrder:6}),p$=lo({type:mY,displayOrder:7}),_$=lo({displayOrder:0}),v$=lo({displayOrder:2}),m$=lo({displayOrder:3}),y$=lo({type:CY,displayOrder:4}),g$=lo({displayOrder:5}),b$=lo({displayOrder:2}),x$=lo({type:mY,range:[-1,1],displayOrder:13}),S$=lo({type:mY,displayOrder:14}),w$=lo({type:mY,displayOrder:15}),T$=lo({type:[PZ],displayOrder:16}),E$=lo({type:fm,displayName:"Materials",visible:!1,override:!0}),C$=lo({type:EY,displayOrder:23}),A$=lo({type:UZ,displayOrder:17}),k$=lo({type:RZ,displayOrder:21}),R$=lo({type:BZ,displayOrder:18}),O$=lo({type:xK,displayOrder:19}),M$=lo({type:EK,displayOrder:20}),I$=lo({type:kZ,displayOrder:22}),L$=lo({type:LZ,displayOrder:24}),z$=lo({type:O0,displayOrder:25}),B$=lo({type:ZJ,displayOrder:26}),JJ(P$=$J(P$=e$(P$=ho((b((D$=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"startColor",F$,l(e)),m(e,"scaleSpace",N$,l(e)),m(e,"startSize3D",U$,l(e)),m(e,"startSizeX",V$,l(e)),m(e,"startSizeY",G$,l(e)),m(e,"startSizeZ",H$,l(e)),m(e,"startSpeed",W$,l(e)),m(e,"startRotation3D",q$,l(e)),m(e,"startRotationX",j$,l(e)),m(e,"startRotationY",X$,l(e)),m(e,"startRotationZ",Y$,l(e)),m(e,"startDelay",K$,l(e)),m(e,"startLifetime",Q$,l(e)),m(e,"duration",Z$,l(e)),m(e,"loop",J$,l(e)),m(e,"simulationSpeed",$$,l(e)),m(e,"playOnAwake",e0,l(e)),m(e,"gravityModifier",t0,l(e)),m(e,"rateOverTime",i0,l(e)),m(e,"rateOverDistance",n0,l(e)),m(e,"bursts",r0,l(e)),m(e,"colorOverLifetimeModule",a0,l(e)),m(e,"shapeModule",s0,l(e)),m(e,"sizeOvertimeModule",o0,l(e)),m(e,"velocityOvertimeModule",l0,l(e)),m(e,"forceOvertimeModule",u0,l(e)),m(e,"limitVelocityOvertimeModule",c0,l(e)),m(e,"rotationOvertimeModule",h0,l(e)),m(e,"textureAnimationModule",d0,l(e)),m(e,"trailModule",f0,l(e)),m(e,"renderer",p0,l(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,m(e,"_prewarm",_0,l(e)),m(e,"_capacity",v0,l(e)),m(e,"_simulationSpace",m0,l(e)),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Fi,e._curWPos=new Fi,e._customData1=new Mi,e._customData2=new Mi,e._subEmitters=[],e}return p(t,ox),v(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return _(g(t.prototype),"sharedMaterials",this)},set:function(e){r(g(t.prototype),"sharedMaterials",e,this,!0)}}]),v(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.onInit(this),this.textureAnimationModule.onInit(this),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_collectModels",value:function(){return this._models.length=0,this._models.push(this.renderer._model),this.trailModule.enable&&this.trailModule._trailModel&&this._models.push(this.trailModule._trailModel),this._models}},{key:"_changeSceneInModel",value:function(){if(this.isValid){var e=this.renderer;e&&e._model&&(e._model.scene.destroyModel(e._model),e._model=null,e.onEnable(),e._updateModel(),e._updateMaterialParams());var t=this.trailModule;t&&t._trailModel&&(t._trailModel.scene.destroyModel(t._trailModel),t._trailModel=null,t.enable=t._enable,e._updateTrailMaterial())}}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.renderer.clear(),this.trailModule.clear())}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){Mi.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){Mi.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.visFlags=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var n=this.renderer._getFreeParticle();if(null===n)return;var r=Si(xi(0,ae));switch(this.shapeModule.enable?this.shapeModule.emit(n):(Fi.set(n.position,0,0,0),Fi.copy(n.velocity,LY)),this.textureAnimationModule.enable&&this.textureAnimationModule.init(n),Fi.multiplyScalar(n.velocity,n.velocity,this.startSpeed.evaluate(this._time/this.duration,r)),this._simulationSpace){case CY.Local:break;case CY.World:this.node.getWorldMatrix(M0),Fi.transformMat4(n.position,n.position,M0);var a=new hn;this.node.getWorldRotation(a),Fi.transformQuat(n.velocity,n.velocity,a);break;case CY.Custom:}Fi.copy(n.ultimateVelocity,n.velocity),this.startRotation3D?Fi.set(n.rotation,this.startRotationX.evaluate(this._time/this.duration,r),this.startRotationY.evaluate(this._time/this.duration,r),this.startRotationZ.evaluate(this._time/this.duration,r)):Fi.set(n.rotation,0,0,this.startRotationZ.evaluate(this._time/this.duration,r)),this.startSize3D?Fi.set(n.startSize,this.startSizeX.evaluate(this._time/this.duration,r),this.startSizeY.evaluate(this._time/this.duration,r),this.startSizeZ.evaluate(this._time/this.duration,r)):(Fi.set(n.startSize,this.startSizeX.evaluate(this._time/this.duration,r),1,1),n.startSize.y=n.startSize.x),Fi.copy(n.size,n.startSize),n.startColor.set(this.startColor.evaluate(this._time/this.duration,r)),n.color.set(n.startColor),n.startLifetime=this.startLifetime.evaluate(this._time/this.duration,r)+t,n.remainingLifetime=n.startLifetime,n.randomSeed=xi(0,233280),this.renderer._setNewParticle(n)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=vY.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=Fi.distance(this._curWPos,this._oldWPos);if(Fi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}var a=this.bursts,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),Fi.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[t$],Object.getOwnPropertyDescriptor(D$.prototype,"capacity"),D$.prototype),F$=b(D$.prototype,"startColor",[i$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xY}}),N$=b(D$.prototype,"scaleSpace",[n$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CY.Local}}),U$=b(D$.prototype,"startSize3D",[r$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),V$=b(D$.prototype,"startSizeX",[a$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),G$=b(D$.prototype,"startSizeY",[s$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),H$=b(D$.prototype,"startSizeZ",[o$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),W$=b(D$.prototype,"startSpeed",[l$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),q$=b(D$.prototype,"startRotation3D",[u$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j$=b(D$.prototype,"startRotationX",[c$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),X$=b(D$.prototype,"startRotationY",[h$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),Y$=b(D$.prototype,"startRotationZ",[d$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),K$=b(D$.prototype,"startDelay",[f$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),Q$=b(D$.prototype,"startLifetime",[p$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),Z$=b(D$.prototype,"duration",[_$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),J$=b(D$.prototype,"loop",[v$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),b(D$.prototype,"prewarm",[m$],Object.getOwnPropertyDescriptor(D$.prototype,"prewarm"),D$.prototype),b(D$.prototype,"simulationSpace",[y$],Object.getOwnPropertyDescriptor(D$.prototype,"simulationSpace"),D$.prototype),$$=b(D$.prototype,"simulationSpeed",[g$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),e0=b(D$.prototype,"playOnAwake",[b$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),t0=b(D$.prototype,"gravityModifier",[x$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),i0=b(D$.prototype,"rateOverTime",[S$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),n0=b(D$.prototype,"rateOverDistance",[w$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mY}}),r0=b(D$.prototype,"bursts",[T$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),b(D$.prototype,"sharedMaterials",[E$],Object.getOwnPropertyDescriptor(D$.prototype,"sharedMaterials"),D$.prototype),a0=b(D$.prototype,"colorOverLifetimeModule",[C$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EY}}),s0=b(D$.prototype,"shapeModule",[A$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UZ}}),o0=b(D$.prototype,"sizeOvertimeModule",[k$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RZ}}),l0=b(D$.prototype,"velocityOvertimeModule",[R$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BZ}}),u0=b(D$.prototype,"forceOvertimeModule",[O$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xK}}),c0=b(D$.prototype,"limitVelocityOvertimeModule",[M$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EK}}),h0=b(D$.prototype,"rotationOvertimeModule",[I$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kZ}}),d0=b(D$.prototype,"textureAnimationModule",[L$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LZ}}),f0=b(D$.prototype,"trailModule",[z$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new O0}}),p0=b(D$.prototype,"renderer",[B$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZJ}}),_0=b(D$.prototype,"_prewarm",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v0=b(D$.prototype,"_capacity",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),m0=b(D$.prototype,"_simulationSpace",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CY.Local}}),P$=D$))||P$)||P$)||P$)||P$)),L0=q3("ParticleUtils",function(){function e(){y(this,e)}return v(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(qE.on(lE.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Ts(function(){return fl(e)},1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach(function(e){e.clear(function(e){e.destroy()})}),this.particleSystemPool.clear()}},{key:"play",value:function(e){var t=e.getComponentsInChildren(I0),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(I0),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.stop()}}}]),e}());function z0(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function B0(e,t){return e(t={exports:{}},t.exports),t.exports}L0.particleSystemPool=new Map,L0.registeredSceneEvent=!1,cc.ParticleSystemComponent=I0,cc.BillboardComponent=hY,cc.LineComponent=TY,cc.ParticleUtils=L0;var P0,D0,F0,N0,U0=B0(function(e,t){e.exports=function r(a,s,o){function l(i,e){if(!s[i]){if(!a[i]){var t=z0;if(!e&&t)return t(i,!0);if(u)return u(i,!0);throw new Error("Cannot find module '"+i+"'")}var n=s[i]={exports:{}};a[i][0].call(n.exports,function(e){var t=a[i][1][e];return l(t||e)},n,n.exports,r,a,s,o)}return s[i].exports}for(var u=z0,e=0;e<o.length;e++)l(o[e]);return l}({1:[function(e,t,i){t.exports={name:"@cocos/cannon",version:"1.0.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -d doProfiling=false,DEBUG=false -c -m"},main:"./build/cannon.min.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t,i){var n=e("../math/Vec3");function r(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=r;var u=new n;r.prototype.setFromPoints=function(e,t,i,n){var r=this.lowerBound,a=this.upperBound,s=i;r.copy(e[0]),s&&s.vmult(r,r),a.copy(r);for(var o=1;o<e.length;o++){var l=e[o];s&&(s.vmult(l,u),l=u),l.x>a.x&&(a.x=l.x),l.x<r.x&&(r.x=l.x),l.y>a.y&&(a.y=l.y),l.y<r.y&&(r.y=l.y),l.z>a.z&&(a.z=l.z),l.z<r.z&&(r.z=l.z)}return t&&(t.vadd(r,r),t.vadd(a,a)),n&&(r.x-=n,r.y-=n,r.z-=n,a.x+=n,a.y+=n,a.z+=n),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},r.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound,a=n.x<=i.x&&i.x<=r.x||t.x<=r.x&&r.x<=i.x,s=n.y<=i.y&&i.y<=r.y||t.y<=r.y&&r.y<=i.y,o=n.z<=i.z&&i.z<=r.z||t.z<=r.z&&r.z<=i.z;return a&&s&&o},r.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},r.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound;return t.x<=n.x&&i.x>=r.x&&t.y<=n.y&&i.y>=r.y&&t.z<=n.z&&i.z>=r.z},r.prototype.getCorners=function(e,t,i,n,r,a,s,o){var l=this.lowerBound,u=this.upperBound;e.copy(l),t.set(u.x,l.y,l.z),i.set(u.x,u.y,l.z),n.set(l.x,u.y,u.z),r.set(u.x,l.y,l.z),a.set(l.x,u.y,l.z),s.set(l.x,l.y,u.z),o.copy(u)};var f=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(e,t){var i=f,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],u=i[6],c=i[7];this.getCorners(n,r,a,s,o,l,u,c);for(var h=0;8!==h;h++){var d=i[h];e.pointToLocal(d,d)}return t.setFromPoints(i)},r.prototype.toWorldFrame=function(e,t){var i=f,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],u=i[6],c=i[7];this.getCorners(n,r,a,s,o,l,u,c);for(var h=0;8!==h;h++){var d=i[h];e.pointToWorld(d,d)}return t.setFromPoints(i)},r.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,a=(this.upperBound.x-e.from.x)*t,s=(this.lowerBound.y-e.from.y)*i,o=(this.upperBound.y-e.from.y)*i,l=(this.lowerBound.z-e.from.z)*n,u=(this.upperBound.z-e.from.z)*n,c=Math.max(Math.max(Math.min(r,a),Math.min(s,o)),Math.min(l,u)),h=Math.min(Math.min(Math.max(r,a),Math.max(s,o)),Math.max(l,u));return!(h<0||h<c)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t,i){function n(){this.matrix=[]}(t.exports=n).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){var n=e("../objects/Body"),r=e("../math/Vec3"),a=e("../math/Quaternion");function s(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=s).prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},s.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(0==(e.type&n.STATIC)&&e.sleepState!==n.SLEEPING||0==(t.type&n.STATIC)&&t.sleepState!==n.SLEEPING)},s.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var o=new r;new r,new a,new r,s.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var r=o;t.position.vsub(e.position,r);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<a&&(i.push(e),n.push(t))},s.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))};var h={keys:[]},d=[],f=[];s.prototype.makePairsUnique=function(e,t){for(var i=h,n=d,r=f,a=e.length,s=0;s!==a;s++)n[s]=e[s],r[s]=t[s];for(e.length=0,s=t.length=0;s!==a;s++){var o=n[s].id,l=r[s].id;i[u=o<l?o+","+l:l+","+o]=s,i.keys.push(u)}for(s=0;s!==i.keys.length;s++){var u=i.keys.pop(),c=i[u];e.push(n[c]),t.push(r[c]),delete i[u]}},s.prototype.setWorld=function(e){};var l=new r;s.boundingSphereCheck=function(e,t){var i=l;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},s.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t,i){t.exports=n;var o=e("./Broadphase"),l=e("../math/Vec3"),ie=e("../shapes/Shape");function n(e,t,i,n,r){o.apply(this),this.nx=i||10,this.ny=n||10,this.nz=r||10,this.aabbMin=e||new l(100,100,100),this.aabbMax=t||new l(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var s=0;s<a;s++)this.bins[s]=[],this.binLengths[s]=0}(n.prototype=new o).constructor=n;var ne=new l;new l,n.prototype.collisionPairs=function(e,t,i){for(var n=e.numObjects(),r=e.bodies,a=this.aabbMax,s=this.aabbMin,m=this.nx,y=this.ny,g=this.nz,b=y*g,x=g,S=1,o=a.x,l=a.y,u=a.z,w=s.x,T=s.y,E=s.z,C=m/(o-w),A=y/(l-T),k=g/(u-E),c=(o-w)/m,h=(l-T)/y,d=(u-E)/g,f=.5*Math.sqrt(c*c+h*h+d*d),p=ie.types,_=p.SPHERE,v=p.PLANE,R=(p.BOX,p.COMPOUND,p.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,M=this.bins.length,I=0;I!==M;I++)O[I]=0;var L=Math.ceil;function z(e,t,i,n,r,a,s){var o=(e-w)*C|0,l=(t-T)*A|0,u=(i-E)*k|0,c=L((n-w)*C),h=L((r-T)*A),d=L((a-E)*k);o<0?o=0:m<=o&&(o=m-1),l<0?l=0:y<=l&&(l=y-1),u<0?u=0:g<=u&&(u=g-1),c<0?c=0:m<=c&&(c=m-1),h<0?h=0:y<=h&&(h=y-1),d<0?d=0:g<=d&&(d=g-1),l*=x,u*=S,c*=b,h*=x,d*=S;for(var f=o*=b;f<=c;f+=b)for(var p=l;p<=h;p+=x)for(var _=u;_<=d;_+=S){var v=f+p+_;R[v][O[v]++]=s}}for(s=Math.min,a=Math.max,I=0;I!==n;I++){var B=(ee=r[I]).shape;switch(B.type){case _:var P=ee.position.x,D=ee.position.y,F=ee.position.z,N=B.radius;z(P-N,D-N,F-N,P+N,D+N,F+N,ee);break;case v:B.worldNormalNeedsUpdate&&B.computeWorldNormal(ee.quaternion);var U=B.worldNormal,V=w+.5*c-ee.position.x,G=T+.5*h-ee.position.y,H=E+.5*d-ee.position.z,W=ne;W.set(V,G,H);for(var q=0,j=0;q!==m;q++,j+=b,W.y=G,W.x+=c)for(var X=0,Y=0;X!==y;X++,Y+=x,W.z=H,W.y+=h)for(var K=0,Q=0;K!==g;K++,Q+=S,W.z+=d)if(W.dot(U)<f){var Z=j+Y+Q;R[Z][O[Z]++]=ee}break;default:ee.aabbNeedsUpdate&&ee.computeAABB(),z(ee.aabb.lowerBound.x,ee.aabb.lowerBound.y,ee.aabb.lowerBound.z,ee.aabb.upperBound.x,ee.aabb.upperBound.y,ee.aabb.upperBound.z,ee)}}for(I=0;I!==M;I++){var J=O[I];if(1<J){var $=R[I];for(q=0;q!==J;q++){var ee=$[q];for(X=0;X!==q;X++){var te=$[X];this.needBroadphaseCollision(ee,te)&&this.intersectionTest(ee,te,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t,i){t.exports=a;var n=e("./Broadphase"),r=e("./AABB");function a(){n.apply(this)}((a.prototype=new n).constructor=a).prototype.collisionPairs=function(e,t,i){var n,r,a,s,o=e.bodies,l=o.length;for(n=0;n!==l;n++)for(r=0;r!==n;r++)a=o[n],s=o[r],this.needBroadphaseCollision(a,s)&&this.intersectionTest(a,s,t,i)},new r,a.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var r=e.bodies[n];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function n(){this.matrix={}}(t.exports=n).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var n=t;t=e,e=n}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function n(){this.current=[],this.previous=[]}function c(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=n).prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},n.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,r=0;i>n[r];)r++;if(i!==n[r]){for(t=n.length-1;r<=t;t--)n[t+1]=n[t];n[r]=i}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.reset=function(){this.previous.length=0,this.current.length=0},n.prototype.getDiff=function(e,t){for(var i=this.current,n=this.previous,r=i.length,a=n.length,s=0,o=0;o<r;o++){for(var l=i[o];l>n[s];)s++;l===n[s]||c(e,l)}for(o=s=0;o<a;o++){for(var u=n[o];u>i[s];)s++;i[s]===u||c(t,u)}},n.prototype.copy=function(e){this.current.length=0,this.previous.length=0,this.current=e.current.slice(),this.previous=e.previous.slice()}},{}],10:[function(e,t,i){t.exports=u;var v=e("../math/Vec3"),n=e("../math/Quaternion"),C=e("../math/Transform"),r=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),a=e("../shapes/Shape"),p=e("../collision/AABB");function u(e,t){this.from=e?e.clone():new v,this.to=t?t.clone():new v,this._direction=new v,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=u.ANY,this.result=new r,this.hasHit=!1,this.callback=function(e){}}(u.prototype.constructor=u).CLOSEST=1,u.ANY=2,u.ALL=4;var s=new p,o=[];u.prototype.intersectWorld=function(e,t){return this.mode=t.mode||u.ANY,this.result=t.result||new r,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(s),o.length=0,e.broadphase.aabbQuery(e,s,o),this.intersectBodies(o),this.hasHit};var h=new v,d=new v;function k(e,t,i,n){n.vsub(t,f),i.vsub(t,h),e.vsub(t,d);var r,a,s=f.dot(f),o=f.dot(h),l=f.dot(d),u=h.dot(h),c=h.dot(d);return 0<=(r=u*l-o*c)&&0<=(a=s*c-o*l)&&r+a<s*u-o*o}u.pointInTriangle=k;var l=new v,c=new n;u.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var n=l,r=c,a=0,s=e.shapes.length;a<s;a++){var o=e.shapes[a];if((!i||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[a],r),e.quaternion.vmult(e.shapeOffsets[a],n),n.vadd(e.position,n),this.intersectShape(o,r,n,e),this.result._shouldStop))break}},u.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},u.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},u.prototype.intersectShape=function(e,t,i,n){if(!(function(e,t,i){i.vsub(e,f);var n=f.dot(t);return t.mult(n,S),S.vadd(e,S),i.distanceTo(S)}(this.from,this._direction,i)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,i,n,e)}},new v,new v;var R=new v,O=new v,M=new v,I=new v;new v,new r,u.prototype.intersectBox=function(e,t,i,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,r)},u.prototype[a.types.BOX]=u.prototype.intersectBox,u.prototype.intersectPlane=function(e,t,i,n,r){var a=this.from,s=this.to,o=this._direction,l=new v(0,0,1);t.vmult(l,l);var u=new v;a.vsub(i,u);var c=u.dot(l);if(s.vsub(i,u),!(0<c*u.dot(l)||a.distanceTo(s)<c)){var h=l.dot(o);if(!(Math.abs(h)<this.precision)){var d=new v,f=new v,p=new v;a.vsub(i,d);var _=-l.dot(d)/h;o.scale(_,f),a.vadd(f,p),this.reportIntersection(l,p,r,n,-1)}}},u.prototype[a.types.PLANE]=u.prototype.intersectPlane,u.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var _={faceList:[0]},m=new v,y=new u,g=[];u.prototype.intersectHeightfield=function(e,t,i,n,r){e.data,e.elementSize;var a=y;a.from.copy(this.from),a.to.copy(this.to),C.pointToLocalFrame(i,t,a.from,a.from),C.pointToLocalFrame(i,t,a.to,a.to),a._updateDirection();var s,o,l,u,c=g;s=o=0,l=u=e.data.length-1;var h=new p;a.getAABB(h),e.getIndexOfPosition(h.lowerBound.x,h.lowerBound.y,c,!0),s=Math.max(s,c[0]),o=Math.max(o,c[1]),e.getIndexOfPosition(h.upperBound.x,h.upperBound.y,c,!0),l=Math.min(l,c[0]+1),u=Math.min(u,c[1]+1);for(var d=s;d<l;d++)for(var f=o;f<u;f++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(d,f,h),h.overlapsRay(a)){if(e.getConvexTrianglePillar(d,f,!1),C.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,_),this.result._shouldStop)return;e.getConvexTrianglePillar(d,f,!0),C.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,_)}}},u.prototype[a.types.HEIGHTFIELD]=u.prototype.intersectHeightfield;var b=new v,x=new v;u.prototype.intersectSphere=function(e,t,i,n,r){var a=this.from,s=this.to,o=e.radius,l=Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2)+Math.pow(s.z-a.z,2),u=2*((s.x-a.x)*(a.x-i.x)+(s.y-a.y)*(a.y-i.y)+(s.z-a.z)*(a.z-i.z)),c=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(o,2),h=Math.pow(u,2)-4*l*c,d=b,f=x;if(!(h<0))if(0==h)a.lerp(s,h,d),d.vsub(i,f),f.normalize(),this.reportIntersection(f,d,r,n,-1);else{var p=(-u-Math.sqrt(h))/(2*l),_=(-u+Math.sqrt(h))/(2*l);if(0<=p&&p<=1&&(a.lerp(s,p,d),d.vsub(i,f),f.normalize(),this.reportIntersection(f,d,r,n,-1)),this.result._shouldStop)return;0<=_&&_<=1&&(a.lerp(s,_,d),d.vsub(i,f),f.normalize(),this.reportIntersection(f,d,r,n,-1))}},u.prototype[a.types.SPHERE]=u.prototype.intersectSphere;var L=new v,z=(new v,new v,new v);u.prototype.intersectConvex=function(e,t,i,n,r,a){for(var s=L,o=z,l=a&&a.faceList||null,u=e.faces,c=e.vertices,h=e.faceNormals,d=this._direction,f=this.from,p=this.to,_=f.distanceTo(p),v=l?l.length:u.length,m=this.result,y=0;!m._shouldStop&&y<v;y++){var g=l?l[y]:y,b=u[g],x=h[g],S=t,w=i;o.copy(c[b[0]]),S.vmult(o,o),o.vadd(w,o),o.vsub(f,o),S.vmult(x,s);var T=d.dot(s);if(!(Math.abs(T)<this.precision)){var E=s.dot(o)/T;if(!(E<0)){d.mult(E,R),R.vadd(f,R),O.copy(c[b[0]]),S.vmult(O,O),w.vadd(O,O);for(var C=1;!m._shouldStop&&C<b.length-1;C++){M.copy(c[b[C]]),I.copy(c[b[C+1]]),S.vmult(M,M),S.vmult(I,I),w.vadd(M,M),w.vadd(I,I);var A=R.distanceTo(f);!k(R,O,M,I)&&!k(R,M,O,I)||_<A||this.reportIntersection(s,R,r,n,g)}}}}},u.prototype[a.types.CONVEXPOLYHEDRON]=u.prototype.intersectConvex;var A=new v,B=new v,P=new v,D=new v,F=new v,N=new v,U=(new p,[]),V=new C;u.prototype.intersectTrimesh=function(e,t,i,n,r,a){var s=A,o=U,l=V,u=z,c=B,h=P,d=D,f=N,p=F,_=(a&&a.faceList,e.indices),v=(e.vertices,e.faceNormals,this.from),m=this.to,y=this._direction;l.position.copy(i),l.quaternion.copy(t),C.vectorToLocalFrame(i,t,y,c),C.pointToLocalFrame(i,t,v,h),C.pointToLocalFrame(i,t,m,d),d.x*=e.scale.x,d.y*=e.scale.y,d.z*=e.scale.z,h.x*=e.scale.x,h.y*=e.scale.y,h.z*=e.scale.z,d.vsub(h,c),c.normalize();var g=h.distanceSquared(d);e.tree.rayQuery(this,l,o);for(var b=0,x=o.length;!this.result._shouldStop&&b!==x;b++){var S=o[b];e.getNormal(S,s),e.getVertex(_[3*S],O),O.vsub(h,u);var w=c.dot(s),T=s.dot(u)/w;if(!(T<0)){c.scale(T,R),R.vadd(h,R),e.getVertex(_[3*S+1],M),e.getVertex(_[3*S+2],I);var E=R.distanceSquared(h);!k(R,M,O,I)&&!k(R,O,M,I)||g<E||(C.vectorToWorldFrame(t,s,p),C.pointToWorldFrame(i,t,R,f),this.reportIntersection(p,f,r,n,S))}}o.length=0},u.prototype[a.types.TRIMESH]=u.prototype.intersectTrimesh,u.prototype.reportIntersection=function(e,t,i,n,r){var a=this.from,s=this.to,o=a.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case u.ALL:this.hasHit=!0,l.set(a,s,e,t,i,n,o),l.hasHit=!0,this.callback(l);break;case u.CLOSEST:(o<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o));break;case u.ANY:this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o),l._shouldStop=!0}};var f=new v,S=new v},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t,i){var n=e("../math/Vec3");function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=r).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,i,n,r,a,s){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=r,this.body=a,this.distance=s}},{"../math/Vec3":31}],12:[function(e,t,i){e("../shapes/Shape");var n=e("../collision/Broadphase");function c(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(e){i.push(e.body)},this._removeBodyHandler=function(e){var t=i.indexOf(e.body);-1!==t&&i.splice(t,1)},e&&this.setWorld(e)}((t.exports=c).prototype=new n).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},c.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.x<=n.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=n}return e},c.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.y<=n.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=n}return e},c.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.z<=n.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=n}return e},c.prototype.collisionPairs=function(e,t,i){var n,r,a=this.axisList,s=a.length,o=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==s;n++){var l=a[n];for(r=n+1;r<s;r++){var u=a[r];if(this.needBroadphaseCollision(l,u)){if(!c.checkBounds(l,u,o))break;this.intersectionTest(l,u,t,i)}}}},c.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var r=e[n];r.aabbNeedsUpdate&&r.computeAABB()}0===t?c.insertionSortX(e):1===t?c.insertionSortY(e):2===t&&c.insertionSortZ(e)},c.checkBounds=function(e,t,i){var n,r;0===i?(n=e.position.x,r=t.position.x):1===i?(n=e.position.y,r=t.position.y):2===i&&(n=e.position.z,r=t.position.z);var a=e.boundingRadius,s=t.boundingRadius;return r-s<n+a},c.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,r=0,a=0,s=this.axisList,o=s.length,l=1/o,u=0;u!==o;u++){var c=s[u],h=c.position.x;e+=h,t+=h*h;var d=c.position.y;i+=d,n+=d*d;var f=c.position.z;r+=f,a+=f*f}var p=t-e*e*l,_=n-i*i*l,v=a-r*r*l;this.axisIndex=_<p?v<p?0:2:v<_?1:2},c.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,r="x";1===n&&(r="y"),2===n&&(r="z");for(var a=this.axisList,s=(t.lowerBound[r],t.upperBound[r],0);s<a.length;s++){var o=a[s];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t,i){t.exports=n,e("./Constraint");var l=e("./PointToPointConstraint"),u=e("../equations/ConeEquation"),c=e("../equations/RotationalEquation"),h=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new h,a=i.pivotB?i.pivotB.clone():new h;this.axisA=i.axisA?i.axisA.clone():new h,this.axisB=i.axisB?i.axisB.clone():new h,l.call(this,e,r,t,a,n),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var s=this.coneEquation=new u(e,t,i),o=this.twistEquation=new c(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,s.maxForce=0,s.minForce=-n,o.maxForce=0,o.minForce=-n,this.equations.push(s,o)}n.prototype=new l,n.constructor=n,new h,new h,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;l.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),e.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t,i){t.exports=r;var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":54}],15:[function(e,t,i){t.exports=n;var a=e("./Constraint"),s=e("../equations/ContactEquation");function n(e,t,i,n){a.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===n&&(n=1e6),this.distance=i;var r=this.distanceEquation=new s(e,t);this.equations.push(r),r.minForce=-n,r.maxForce=n}(n.prototype=new a).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,r=i.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(n,i.ri),r.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t,i){t.exports=n,e("./Constraint");var u=e("./PointToPointConstraint"),c=e("../equations/RotationalEquation"),h=e("../equations/RotationalMotorEquation"),d=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new d,a=i.pivotB?i.pivotB.clone():new d;u.call(this,e,r,t,a,n),(this.axisA=i.axisA?i.axisA.clone():new d(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new d(1,0,0)).normalize();var s=this.rotationalEquation1=new c(e,t,i),o=this.rotationalEquation2=new c(e,t,i),l=this.motorEquation=new h(e,t,n);l.enabled=!1,this.equations.push(s,o,l)}n.prototype=new u,(n.constructor=n).prototype.enableMotor=function(){this.motorEquation.enabled=!0},n.prototype.disableMotor=function(){this.motorEquation.enabled=!1},n.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},n.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var f=new d,p=new d;n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,n=this.rotationalEquation1,r=this.rotationalEquation2,a=f,s=p,o=this.axisA,l=this.axisB;u.prototype.update.call(this),e.quaternion.vmult(o,a),t.quaternion.vmult(l,s),a.tangents(n.axisA,r.axisA),n.axisB.copy(s),r.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t,i){t.exports=n,e("./Constraint");var c=e("./PointToPointConstraint"),h=e("../equations/RotationalEquation"),d=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=new d,a=new d,s=new d;e.position.vadd(t.position,s),s.scale(.5,s),t.pointToLocalFrame(s,a),e.pointToLocalFrame(s,r),c.call(this,e,r,t,a,n),this.xA=e.vectorToLocalFrame(d.UNIT_X),this.xB=t.vectorToLocalFrame(d.UNIT_X),this.yA=e.vectorToLocalFrame(d.UNIT_Y),this.yB=t.vectorToLocalFrame(d.UNIT_Y),this.zA=e.vectorToLocalFrame(d.UNIT_Z),this.zB=t.vectorToLocalFrame(d.UNIT_Z);var o=this.rotationalEquation1=new h(e,t,i),l=this.rotationalEquation2=new h(e,t,i),u=this.rotationalEquation3=new h(e,t,i);this.equations.push(o,l,u)}n.prototype=new c,n.constructor=n,new d,new d,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),n=this.rotationalEquation2,r=this.rotationalEquation3;c.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,n.axisA),t.vectorToWorldFrame(this.zB,n.axisB),e.vectorToWorldFrame(this.zA,r.axisA),t.vectorToWorldFrame(this.xB,r.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t,i){t.exports=n;var l=e("./Constraint"),u=e("../equations/ContactEquation"),c=e("../math/Vec3");function n(e,t,i,n,r){l.call(this,e,i),r=void 0!==r?r:1e6,this.pivotA=t?t.clone():new c,this.pivotB=n?n.clone():new c;var a=this.equationX=new u(e,i),s=this.equationY=new u(e,i),o=this.equationZ=new u(e,i);this.equations.push(a,s,o),a.minForce=s.minForce=o.minForce=-r,a.maxForce=s.maxForce=o.maxForce=r,a.ni.set(1,0,0),s.ni.set(0,1,0),o.ni.set(0,0,1)}(n.prototype=new l).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(n.prototype=new a).constructor=n;var u=new r,c=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=u,s=c,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.angle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){i=void 0!==i?i:1e6,n.call(this,e,t,0,i),this.si=null,this.sj=null,this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var g=new r,b=new r,x=new r;a.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,r=this.bj,a=this.ri,s=this.rj,o=g,l=b,u=n.velocity,c=n.angularVelocity,h=(n.force,n.torque,r.velocity),d=r.angularVelocity,f=(r.force,r.torque,x),p=this.jacobianElementA,_=this.jacobianElementB,v=this.ni;a.cross(v,o),s.cross(v,l),v.negate(p.spatial),o.negate(p.rotational),_.spatial.copy(v),_.rotational.copy(l),f.copy(r.position),f.vadd(s,f),f.vsub(n.position,f),f.vsub(a,f);var m=v.dot(f),y=this.restitution+1;return-m*t-(y*h.dot(v)-y*u.dot(v)+d.dot(l)-c.dot(o))*i-e*this.computeGiMf()};var s=new r,o=new r,l=new r,u=new r,c=new r;a.prototype.getImpactVelocityAlongNormal=function(){var e=s,t=o,i=l,n=u,r=c;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t,i){t.exports=a;var r=e("../math/JacobianElement"),n=e("../math/Vec3");function a(e,t,i,n){this.id=a.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===n?1e6:n,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new r,this.jacobianElementB=new r,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(a.prototype.constructor=a).id=0,a.prototype.setSpookParams=function(e,t,i){var n=t,r=e,a=i;this.a=4/(a*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(a*a*r*(1+4*n))},a.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.position,a=n.position;return e.spatial.dot(r)+t.spatial.dot(a)},new n,a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.velocity,a=n.velocity,s=i.angularVelocity,o=n.angularVelocity;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)},a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.vlambda,a=n.vlambda,s=i.wlambda,o=n.wlambda;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)};var c=new n,h=new n,d=new n,f=new n;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.force,a=i.torque,s=n.force,o=n.torque,l=i.invMassSolve,u=n.invMassSolve;return r.scale(l,c),s.scale(u,h),i.invInertiaWorldSolve.vmult(a,d),n.invInertiaWorldSolve.vmult(o,f),e.multiplyVectors(c,d)+t.multiplyVectors(h,f)};var u=new n;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.invMassSolve,a=n.invMassSolve,s=i.invInertiaWorldSolve,o=n.invInertiaWorldSolve,l=r+a;return s.vmult(e.rotational,u),l+=u.dot(e.rotational),o.vmult(t.rotational,u),l+=u.dot(t.rotational)};var s=new n;new n,new n,new n,new n,new n,a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,r=this.bj,a=s;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,i.spatial,r.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,a),n.wlambda.addScaledVector(e,a,n.wlambda),r.invInertiaWorldSolve.vmult(i.rotational,a),r.wlambda.addScaledVector(e,a,r.wlambda)},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){n.call(this,e,t,-i,i),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var u=new r,c=new r;a.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,r=u,a=c,s=this.t;i.cross(s,r),n.cross(s,a);var o=this.jacobianElementA,l=this.jacobianElementB;return s.negate(o.spatial),r.negate(o.rotational),l.spatial.copy(s),l.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.maxAngle=Math.PI/2}(n.prototype=new a).constructor=n;var u=new r,c=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=u,s=c,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.maxAngle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function a(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}((a.prototype=new r).constructor=a).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,r=this.jacobianElementA,a=this.jacobianElementB;return r.rotational.copy(i),n.negate(a.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t,i){var r=e("../utils/Utils");(t.exports=function e(t,i,n){n=r.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}).idCounter=0},{"../utils/Utils":54}],26:[function(e,t,i){(t.exports=function e(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=e.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}).idCounter=0},{}],27:[function(e,t,i){t.exports=r;var n=e("./Vec3");function r(){this.spatial=new n,this.rotational=new n}r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t,i){t.exports=u;var c=e("./Vec3");function u(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}u.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},u.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},u.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},u.prototype.getTrace=function(e){e=e||new c;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},u.prototype.vmult=function(e,t){t=t||new c;var i=this.elements,n=e.x,r=e.y,a=e.z;return t.x=i[0]*n+i[1]*r+i[2]*a,t.y=i[3]*n+i[4]*r+i[5]*a,t.z=i[6]*n+i[7]*r+i[8]*a,t},u.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},u.prototype.mmult=function(e,t){for(var i=t||new u,n=0;n<3;n++)for(var r=0;r<3;r++){for(var a=0,s=0;s<3;s++)a+=e.elements[n+3*s]*this.elements[s+3*r];i.elements[n+3*r]=a}return i},u.prototype.scale=function(e,t){t=t||new u;for(var i=this.elements,n=t.elements,r=0;3!==r;r++)n[3*r+0]=e.x*i[3*r+0],n[3*r+1]=e.y*i[3*r+1],n[3*r+2]=e.z*i[3*r+2];return t},u.prototype.solve=function(e,t){t=t||new c;for(var i,n=[],r=0;r<12;r++)n.push(0);for(r=0;r<3;r++)for(i=0;i<3;i++)n[r+4*i]=this.elements[r+3*i];n[3]=e.x,n[7]=e.y,n[11]=e.z;var a,s,o=3,l=o;do{if(0===n[(r=l-o)+4*r])for(i=r+1;i<l;i++)if(0!==n[r+4*i]){for(a=4;n[(s=4-a)+4*r]+=n[s+4*i],--a;);break}if(0!==n[r+4*r])for(i=r+1;i<l;i++){var u=n[r+4*i]/n[r+4*r];for(a=4;n[(s=4-a)+4*i]=s<=r?0:n[s+4*i]-n[s+4*r]*u,--a;);}}while(--o);if(t.z=n[11]/n[10],t.y=(n[7]-n[6]*t.z)/n[5],t.x=(n[3]-n[2]*t.z-n[1]*t.y)/n[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},u.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},u.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},u.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},u.prototype.reverse=function(e){e=e||new u;for(var t,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(t=0;t<3;t++)i[n+6*t]=this.elements[n+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,a,s=3,o=s;do{if(0===i[(n=o-s)+6*n])for(t=n+1;t<o;t++)if(0!==i[n+6*t]){for(r=6;i[(a=6-r)+6*n]+=i[a+6*t],--r;);break}if(0!==i[n+6*n])for(t=n+1;t<o;t++){var l=i[n+6*t]/i[n+6*n];for(r=6;i[(a=6-r)+6*t]=a<=n?0:i[a+6*t]-i[a+6*n]*l,--r;);}}while(--s);n=2;do{t=n-1;do{for(l=i[n+6*t]/i[n+6*n],r=6;i[(a=6-r)+6*t]=i[a+6*t]-i[a+6*n]*l,--r;);}while(t--)}while(--n);n=2;do{for(l=1/i[n+6*n],r=6;i[(a=6-r)+6*n]=i[a+6*n]*l,--r;);}while(n--);n=2;do{t=2;do{if(a=i[3+t+6*n],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(n,t,a)}while(t--)}while(n--);return e},u.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=t*s,c=t*o,h=i*s,d=i*o,f=n*o,p=r*a,_=r*s,v=r*o,m=this.elements;return m[0]=1-(h+f),m[1]=u-v,m[2]=c+_,m[3]=u+v,m[4]=1-(l+f),m[5]=d-p,m[6]=c-_,m[7]=d+p,m[8]=1-(l+h),this},u.prototype.transpose=function(e){for(var t=(e=e||new u).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)t[3*n+r]=i[3*r+n];return e}},{"./Vec3":31}],29:[function(e,t,i){t.exports=v;var f=e("./Vec3");function v(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}v.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},v.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},v.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},v.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},v.prototype.toAxisAngle=function(e){e=e||new f,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var a=new f,s=new f;v.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=a,n=s;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new f,new f,new f,v.prototype.mult=function(e,t){t=t||new v;var i=this.x,n=this.y,r=this.z,a=this.w,s=e.x,o=e.y,l=e.z,u=e.w;return t.x=i*u+a*s+n*l-r*o,t.y=n*u+a*o+r*s-i*l,t.z=r*u+a*l+i*o-n*s,t.w=a*u-i*s-n*o-r*l,t},v.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,r=this.w;e=e||new v,this.conjugate(e);var a=1/(t*t+i*i+n*n+r*r);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},v.prototype.conjugate=function(e){return(e=e||new v).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},v.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.vmult=function(e,t){t=t||new f;var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z,l=this.w,u=l*i+s*r-o*n,c=l*n+o*i-a*r,h=l*r+a*n-s*i,d=-a*i-s*n-o*r;return t.x=u*l+d*-a+c*-o-h*-s,t.y=c*l+d*-s+h*-a-u*-o,t.z=h*l+d*-o+u*-s-c*-a,t},v.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},v.prototype.toEuler=function(e,t){var i,n,r;t=t||"YZX";var a=this.x,s=this.y,o=this.z,l=this.w;switch(t){case"YZX":var u=a*s+o*l;if(.499<u&&(i=2*Math.atan2(a,l),n=Math.PI/2,r=0),u<-.499&&(i=-2*Math.atan2(a,l),n=-Math.PI/2,r=0),isNaN(i)){var c=a*a,h=s*s,d=o*o;i=Math.atan2(2*s*l-2*a*o,1-2*h-2*d),n=Math.asin(2*u),r=Math.atan2(2*a*l-2*s*o,1-2*c-2*d)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=n,e.x=r},v.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var r=Math.cos(e/2),a=Math.cos(t/2),s=Math.cos(i/2),o=Math.sin(e/2),l=Math.sin(t/2),u=Math.sin(i/2);return"XYZ"===n?(this.x=o*a*s+r*l*u,this.y=r*l*s-o*a*u,this.z=r*a*u+o*l*s,this.w=r*a*s-o*l*u):"YXZ"===n?(this.x=o*a*s+r*l*u,this.y=r*l*s-o*a*u,this.z=r*a*u-o*l*s,this.w=r*a*s+o*l*u):"ZXY"===n?(this.x=o*a*s-r*l*u,this.y=r*l*s+o*a*u,this.z=r*a*u+o*l*s,this.w=r*a*s-o*l*u):"ZYX"===n?(this.x=o*a*s-r*l*u,this.y=r*l*s+o*a*u,this.z=r*a*u-o*l*s,this.w=r*a*s+o*l*u):"YZX"===n?(this.x=o*a*s+r*l*u,this.y=r*l*s+o*a*u,this.z=r*a*u-o*l*s,this.w=r*a*s-o*l*u):"XZY"===n&&(this.x=o*a*s-r*l*u,this.y=r*l*s-o*a*u,this.z=r*a*u+o*l*s,this.w=r*a*s+o*l*u),this},v.prototype.clone=function(){return new v(this.x,this.y,this.z,this.w)},v.prototype.slerp=function(e,t,i){i=i||new v;var n,r,a,s,o,l=this.x,u=this.y,c=this.z,h=this.w,d=e.x,f=e.y,p=e.z,_=e.w;return(r=l*d+u*f+c*p+h*_)<0&&(r=-r,d=-d,f=-f,p=-p,_=-_),o=1e-6<1-r?(n=Math.acos(r),a=Math.sin(n),s=Math.sin((1-t)*n)/a,Math.sin(t*n)/a):(s=1-t,t),i.x=s*l+o*d,i.y=s*u+o*f,i.z=s*c+o*p,i.w=s*h+o*_,i},v.prototype.integrate=function(e,t,i,n){n=n||new v;var r=e.x*i.x,a=e.y*i.y,s=e.z*i.z,o=this.x,l=this.y,u=this.z,c=this.w,h=.5*t;return n.x+=h*(r*c+a*u-s*l),n.y+=h*(a*c+s*o-r*u),n.z+=h*(s*c+r*l-a*o),n.w+=h*(-r*o-a*l-s*u),n}},{"./Vec3":31}],30:[function(e,t,i){var r=e("./Vec3"),n=e("./Quaternion");function a(e){e=e||{},this.position=new r,e.position&&this.position.copy(e.position),this.quaternion=new n,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=a;var s=new n;a.pointToLocalFrame=function(e,t,i,n){return n=n||new r,i.vsub(e,n),t.conjugate(s),s.vmult(n,n),n},a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)},a.pointToWorldFrame=function(e,t,i,n){return n=n||new r,t.vmult(i,n),n.vadd(e,n),n},a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)},a.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t},a.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},a.vectorToLocalFrame=function(e,t,i,n){return n=n||new r,t.w*=-1,t.vmult(i,n),t.w*=-1,n}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t,i){t.exports=l;var n=e("./Mat3");function l(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}l.ZERO=new l(0,0,0),l.UNIT_X=new l(1,0,0),l.UNIT_Y=new l(0,1,0),l.UNIT_Z=new l(0,0,1),l.prototype.cross=function(e,t){var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z;return(t=t||new l).x=s*r-o*n,t.y=o*i-a*r,t.z=a*n-s*i,t},l.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},l.prototype.setZero=function(){this.x=this.y=this.z=0},l.prototype.vadd=function(e,t){if(!t)return new l(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},l.prototype.vsub=function(e,t){if(!t)return new l(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},l.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},l.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(0<n){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},l.prototype.unit=function(e){e=e||new l;var t=this.x,i=this.y,n=this.z,r=Math.sqrt(t*t+i*i+n*n);return 0<r?(r=1/r,e.x=t*r,e.y=i*r,e.z=n*r):(e.x=1,e.y=0,e.z=0),e},l.prototype.length=l.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},l.prototype.lengthSquared=l.prototype.norm2=function(){return this.dot(this)},l.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return Math.sqrt((r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n))},l.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return(r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n)},l.prototype.mult=function(e,t){t=t||new l;var i=this.x,n=this.y,r=this.z;return t.x=e*i,t.y=e*n,t.z=e*r,t},l.prototype.vmul=function(e,t){return(t=t||new l).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},l.prototype.scale=l.prototype.mult,l.prototype.addScaledVector=function(e,t,i){return(i=i||new l).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},l.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},l.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},l.prototype.negate=function(e){return(e=e||new l).x=-this.x,e.y=-this.y,e.z=-this.z,e};var s=new l,o=new l;l.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var n=s,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var a=o;Math.abs(n.x)<.9?a.set(1,0,0):a.set(0,1,0),n.cross(a,e),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},l.prototype.toString=function(){return this.x+","+this.y+","+this.z},l.prototype.toArray=function(){return[this.x,this.y,this.z]},l.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},l.prototype.lerp=function(e,t,i){var n=this.x,r=this.y,a=this.z;i.x=n+(e.x-n)*t,i.y=r+(e.y-r)*t,i.z=a+(e.z-a)*t},l.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},l.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var r=new l;l.prototype.isAntiparallelTo=function(e,t){return this.negate(r),r.almostEquals(e,t)},l.prototype.clone=function(){return new l(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t,i){t.exports=y;var n=e("../utils/EventTarget"),a=(e("../shapes/Shape"),e("../math/Vec3")),r=e("../math/Mat3"),s=e("../math/Quaternion"),o=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box"),u=e("../world/World");function y(e){e=e||{},n.apply(this),this.id=y.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new a,this.previousPosition=new a,this.interpolatedPosition=new a,this.initPosition=new a,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new a,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new a,this.force=new a;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?y.STATIC:y.DYNAMIC,typeof e.type==typeof y.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new s,this.initQuaternion=new s,this.previousQuaternion=new s,this.interpolatedQuaternion=new s,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new a,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new a,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new a(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new a(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new o,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new a,e.shape&&this.addShape(e.shape),this.updateMassProperties()}((y.prototype=new n).constructor=y).COLLIDE_EVENT_NAME="collide",y.DYNAMIC=1,y.STATIC=2,y.KINEMATIC=4,y.AWAKE=0,y.SLEEPY=1,y.SLEEPING=2,y.idCounter=0,y.wakeupEvent={type:"wakeup"},y.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===y.SLEEPING&&this.dispatchEvent(y.wakeupEvent)},y.prototype.sleep=function(){this.sleepState=y.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},y.sleepyEvent={type:"sleepy"},y.sleepEvent={type:"sleep"},y.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===y.AWAKE&&i<n?(this.sleepState=y.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(y.sleepyEvent)):t===y.SLEEPY&&n<i?this.wakeUp():t===y.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(y.sleepEvent))}},y.prototype.updateSolveMassProperties=function(){this.sleepState===y.SLEEPING||this.type===y.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},y.prototype.pointToLocalFrame=function(e,t){return t=t||new a,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},y.prototype.vectorToLocalFrame=function(e,t){return t=t||new a,this.quaternion.conjugate().vmult(e,t),t},y.prototype.pointToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},y.prototype.vectorToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t};var h=new a,d=new s;y.prototype.addShape=function(e,t,i){if(-1===this.shapes.indexOf(e)){var n=new a,r=new s;return t&&n.copy(t),i&&r.copy(i),u.idToShapeMap[e.id]=e,this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(r),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this}},y.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0)},y.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,r=0;r!==i;r++){var a=e[r];a.updateBoundingSphereRadius();var s=t[r].norm(),o=a.boundingSphereRadius;n<s+o&&(n=s+o)}this.boundingRadius=n};var f=new o;y.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,r=h,a=d,s=this.quaternion,o=this.aabb,l=f,u=0;u!==n;u++){var c=e[u];s.vmult(t[u],r),r.vadd(this.position,r),i[u].mult(s,a),c.calculateWorldAABB(r,a,l.lowerBound,l.upperBound),0===u?o.copy(l):o.extend(l)}this.aabbNeedsUpdate=!1};var c=new r,p=new r;new r,y.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=c,n=p;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}};var _=new a;y.prototype.applyForce=function(e,t){if(this.type===y.DYNAMIC){var i=_;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new a,m=new a;y.prototype.applyLocalForce=function(e,t){if(this.type===y.DYNAMIC){var i=v,n=m;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyForce(i,n)}};var g=new a,b=new a;y.prototype.applyImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=t,n=g;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=b;i.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var x=new a,S=new a;y.prototype.applyLocalImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=x,n=S;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyImpulse(i,n)}};var w=new a;y.prototype.updateMassProperties=function(){var e=w;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},y.prototype.getVelocityAtWorldPoint=function(e,t){var i=new a;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},y.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===y.DYNAMIC||this.type===y.KINEMATIC)&&this.sleepState!==y.SLEEPING){var n=this.velocity,r=this.angularVelocity,a=this.position,s=this.force,o=this.torque,l=this.quaternion,u=this.invMass,c=this.invInertiaWorld,h=this.linearFactor,d=u*e;n.x+=s.x*d*h.x,n.y+=s.y*d*h.y,n.z+=s.z*d*h.z;var f=c.elements,p=this.angularFactor,_=o.x*p.x,v=o.y*p.y,m=o.z*p.z;r.x+=e*(f[0]*_+f[1]*v+f[2]*m),r.y+=e*(f[3]*_+f[4]*v+f[5]*m),r.z+=e*(f[6]*_+f[7]*v+f[8]*m),a.x+=n.x*e,a.y+=n.y*e,a.z+=n.z*e,l.integrate(this.angularVelocity,e,this.angularFactor,l),t&&(i?l.normalizeFast():l.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},y.prototype.isSleeping=function(){return this.sleepState===y.SLEEPING},y.prototype.isSleepy=function(){return this.sleepState===y.SLEEPY},y.prototype.isAwake=function(){return this.sleepState===y.AWAKE}},{"../collision/AABB":3,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t,i){e("./Body");var E=e("../math/Vec3"),c=e("../math/Quaternion"),n=(e("../collision/RaycastResult"),e("../collision/Ray")),r=e("../objects/WheelInfo");function a(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=a,new E,new E,new E;var h=new E,d=new E,f=new E;new n,a.prototype.addWheel=function(e){var t=new r(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},a.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new E,a.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},a.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},a.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},a.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},a.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,n=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var a=new E;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<i;r++)this.castRay(t[r]);this.updateSuspension(e);var s=new E,o=new E;for(r=0;r<i;r++){var l=(d=t[r]).suspensionForce;l>d.maxSuspensionForce&&(l=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(l*e,s),d.raycastResult.hitPointWorld.vsub(n.position,o),n.applyImpulse(s,o)}this.updateFriction(e);var u=new E,c=new E,h=new E;for(r=0;r<i;r++){var d=t[r];n.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,h);var f=1;switch(this.indexUpAxis){case 1:f=-1}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,c);var p=c.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(p,u),c.vsub(u,c);var _=c.dot(h);d.deltaRotation=f*_*e/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(0<d.engineForce?1:-1)*d.customSlidingRotationalSpeed*e),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},a.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,n=i.length,r=0;r<n;r++){var a=i[r];if(a.isInContact){var s,o=a.suspensionRestLength-a.suspensionLength;s=a.suspensionStiffness*o*a.clippedInvContactDotSuspension;var l=a.suspensionRelativeVelocity;s-=(l<0?a.dampingCompression:a.dampingRelaxation)*l,a.suspensionForce=s*t,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},a.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var m=new E,y=new E;a.prototype.castRay=function(e){var t=m,i=y;this.updateWheelTransformWorld(e);var n=this.chassisBody,r=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var o=e.raycastResult;o.reset();var l=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(s,i,o),n.collisionResponse=l;var u=o.body;if(e.raycastResult.groundObject=0,u){r=o.distance,e.raycastResult.hitNormalWorld=o.hitNormalWorld,e.isInContact=!0;var c=o.distance;e.suspensionLength=c-e.radius;var h=e.suspensionRestLength-e.maxSuspensionTravel,d=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<h&&(e.suspensionLength=h),e.suspensionLength>d&&(e.suspensionLength=d,e.raycastResult.reset());var f=e.raycastResult.hitNormalWorld.dot(e.directionWorld),p=new E;n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,p);var _=e.raycastResult.hitNormalWorld.dot(p);if(-.1<=f)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var v=-1/f;e.suspensionRelativeVelocity=_*v,e.clippedInvContactDotSuspension=v}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return r},a.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},a.prototype.updateWheelTransform=function(e){var t=h,i=d,n=f,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),r.directionLocal.scale(-1,t),i.copy(r.axleLocal),t.cross(i,n),n.normalize(),i.normalize();var a=r.steering,s=new c;s.setFromAxisAngle(t,a);var o=new c;o.setFromAxisAngle(i,r.rotation);var l=r.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,l),l.mult(o,l),l.normalize();var u=r.worldTransform.position;u.copy(r.directionWorld),u.scale(r.suspensionLength,u),u.vadd(r.chassisConnectionPointWorld,u)};var C=[new E(1,0,0),new E(0,1,0),new E(0,0,1)];a.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var A=new E,k=[],R=[];a.prototype.updateFriction=function(e){for(var t=A,i=this.wheelInfos,n=i.length,r=this.chassisBody,a=R,s=k,o=0;o<n;o++)h=(b=i[o]).raycastResult.body,b.sideImpulse=0,b.forwardImpulse=0,a[o]||(a[o]=new E),s[o]||(s[o]=new E);for(o=0;o<n;o++)if(h=(b=i[o]).raycastResult.body){var l=s[o];this.getWheelTransformWorld(o).vectorToWorldFrame(C[this.indexRightAxis],l);var u=b.raycastResult.hitNormalWorld,c=l.dot(u);u.scale(c,t),l.vsub(t,l),l.normalize(),u.cross(l,a[o]),a[o].normalize(),b.sideImpulse=M(r,b.raycastResult.hitPointWorld,h,b.raycastResult.hitPointWorld,l),b.sideImpulse*=1}for(this.sliding=!1,o=0;o<n;o++){var h=(b=i[o]).raycastResult.body,d=0;if(b.slipInfo=1,h){var f=b.brake?b.brake:0;d=O(r,h,b.raycastResult.hitPointWorld,a[o],f);var p=f/(d+=b.engineForce*e);b.slipInfo*=p}if(b.forwardImpulse=0,b.skidInfo=1,h){b.skidInfo=1;var _=b.suspensionForce*e*b.frictionSlip,v=_*_;b.forwardImpulse=d;var m=.5*b.forwardImpulse,y=1*b.sideImpulse,g=m*m+y*y;b.sliding=!1,v<g&&(this.sliding=!0,b.sliding=!0,p=_/Math.sqrt(g),b.skidInfo*=p)}}if(this.sliding)for(o=0;o<n;o++)0!==(b=i[o]).sideImpulse&&b.skidInfo<1&&(b.forwardImpulse*=b.skidInfo,b.sideImpulse*=b.skidInfo);for(o=0;o<n;o++){var b=i[o],x=new E;if(b.raycastResult.hitPointWorld.vsub(r.position,x),0!==b.forwardImpulse){var S=new E;a[o].scale(b.forwardImpulse,S),r.applyImpulse(S,x)}if(0!==b.sideImpulse){h=b.raycastResult.body;var w=new E;b.raycastResult.hitPointWorld.vsub(h.position,w);var T=new E;s[o].scale(b.sideImpulse,T),r.vectorToLocalFrame(x,x),x["xyz"[this.indexUpAxis]]*=b.rollInfluence,r.vectorToWorldFrame(x,x),r.applyImpulse(T,x),T.scale(-1,T),h.applyImpulse(T,w)}}};var p=new E,_=new E,v=new E;function O(e,t,i,n,r){var a=0,s=i,o=p,l=_,u=v;return e.getVelocityAtWorldPoint(s,o),t.getVelocityAtWorldPoint(s,l),o.vsub(l,u),r<(a=-n.dot(u)*(1/(b(e,i,n)+b(t,i,n))))&&(a=r),a<-r&&(a=-r),a}var o=new E,l=new E,u=new E,g=new E;function b(e,t,i){var n=o,r=l,a=u,s=g;return t.vsub(e.position,n),n.cross(i,r),e.invInertiaWorld.vmult(r,s),s.cross(n,a),e.invMass+i.dot(a)}var x=new E,S=new E,w=new E;function M(e,t,i,n,r){if(1.1<r.norm2())return 0;var a=x,s=S,o=w;return e.getVelocityAtWorldPoint(t,a),i.getVelocityAtWorldPoint(n,s),a.vsub(s,o),-.2*r.dot(o)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t,i){var s=e("./Body"),o=e("../shapes/Sphere"),n=e("../shapes/Box"),l=e("../math/Vec3"),u=e("../constraints/HingeConstraint");function r(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new n(new l(5,2,.5));this.chassisBody=new s(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=r).prototype.addWheel=function(e){var t=(e=e||{}).body;t=t||new s(1,new o(1.2)),this.wheelBodies.push(t),this.wheelForces.push(0),new l;var i=void 0!==e.position?e.position.clone():new l,n=new l;this.chassisBody.pointToWorldFrame(i,n),t.position.set(n.x,n.y,n.z);var r=void 0!==e.axis?e.axis.clone():new l(0,1,0);this.wheelAxes.push(r);var a=new u(this.chassisBody,t,{pivotA:i,axisA:r,pivotB:l.ZERO,axisB:r,collideConnected:!1});return this.constraints.push(a),this.wheelBodies.length-1},r.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=Math.cos(e),r=Math.sin(e),a=i.x,s=i.y;this.constraints[t].axisA.set(n*a-r*s,r*a+n*s,0)},r.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},r.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var a=new l;r.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},r.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],n=this.wheelBodies[t],r=n.torque;i.scale(e,a),n.vectorToWorldFrame(a,a),r.vadd(a,r)},r.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},r.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},r.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])};var c=new l;r.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,c),i.dot(c)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t,i){t.exports=r,e("../shapes/Shape");var n=e("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var l=new n;r.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,r=this.smoothingRadius*this.smoothingRadius,a=l,s=0;s!==i;s++){var o=this.particles[s];o.position.vsub(e.position,a),n!==o.id&&a.norm2()<r&&t.push(o)}};var S=new n,w=new n,T=new n,E=new n,C=new n,A=new n;r.prototype.update=function(){for(var e=this.particles.length,t=S,i=this.speedOfSound,n=this.eps,r=0;r!==e;r++){var a=this.particles[r];(y=this.neighbors[r]).length=0,this.getNeighbors(a,y),y.push(this.particles[r]);for(var s=y.length,o=0,l=0;l!==s;l++){a.position.vsub(y[l].position,t);var u=t.norm(),c=this.w(u);o+=y[l].mass*c}this.densities[r]=o,this.pressures[r]=i*i*(this.densities[r]-this.density)}var h=w,d=T,f=E,p=C,_=A;for(r=0;r!==e;r++){var v,m,y,g=this.particles[r];for(h.set(0,0,0),d.set(0,0,0),s=(y=this.neighbors[r]).length,l=0;l!==s;l++){var b=y[l];g.position.vsub(b.position,p);var x=p.norm();v=-b.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[l]/(this.densities[l]*this.densities[l]+n)),this.gradw(p,f),f.mult(v,f),h.vadd(f,h),b.velocity.vsub(g.velocity,_),_.mult(1/(1e-4+this.densities[r]*this.densities[l])*this.viscosity*b.mass,_),m=this.nablaw(x),_.mult(m,_),d.vadd(_,d)}d.mult(g.mass,d),h.mult(g.mass,h),g.force.vadd(d,g.force),g.force.vadd(h,g.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t,i){var n=e("../math/Vec3");function r(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=r).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var m=new n,y=new n,g=new n,b=new n,x=new n,S=new n,w=new n,T=new n,E=new n,C=new n,A=new n;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,r=this.bodyB,a=m,s=y,o=g,l=b,u=A,c=x,h=S,d=w,f=T,p=E,_=C;this.getWorldAnchorA(c),this.getWorldAnchorB(h),c.vsub(n.position,d),h.vsub(r.position,f),h.vsub(c,a);var v=a.norm();s.copy(a),s.normalize(),r.velocity.vsub(n.velocity,o),r.angularVelocity.cross(f,u),o.vadd(u,o),n.angularVelocity.cross(d,u),o.vsub(u,o),s.mult(-e*(v-i)-t*o.dot(s),l),n.force.vsub(l,n.force),r.force.vadd(l,r.force),d.cross(l,p),f.cross(l,_),n.torque.vsub(p,n.torque),r.torque.vadd(_,r.torque)}},{"../math/Vec3":31}],37:[function(e,t,i){var n=e("../math/Vec3"),r=e("../math/Transform"),a=e("../collision/RaycastResult"),s=e("../utils/Utils");function o(e){e=s.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new r,this.isInContact=!1}t.exports=o;var l=new n,u=new n;l=new n,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,u),e.getVelocityAtWorldPoint(u,l);var n=t.hitNormalWorld.dot(l);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/i;this.suspensionRelativeVelocity=n*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t,i){t.exports=r;var n=e("./Shape"),s=e("../math/Vec3"),o=e("./ConvexPolyhedron");function r(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((r.prototype=new n).constructor=r).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=s,r=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],a=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new o(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=a).material=this.material},r.prototype.calculateLocalInertia=function(e,t){return t=t||new s,r.calculateInertia(this.halfExtents,e,t),t},r.calculateInertia=function(e,t,i){var n=e;n.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x))},r.prototype.getSideNormals=function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var r=0;r!==i.length;r++)t.vmult(i[r],i[r]);return i},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new s;new s,r.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;a<r.length;a++)l.set(r[a][0],r[a][1],r[a][2]),t.vmult(l,l),e.vadd(l,l),i(l.x,l.y,l.z)};var c=[new s,new s,new s,new s,new s,new s,new s,new s];r.prototype.calculateWorldAABB=function(e,t,i,n){var r=this.halfExtents;c[0].set(r.x,r.y,r.z),c[1].set(-r.x,r.y,r.z),c[2].set(-r.x,-r.y,r.z),c[3].set(-r.x,-r.y,-r.z),c[4].set(r.x,-r.y,-r.z),c[5].set(r.x,r.y,-r.z),c[6].set(-r.x,r.y,-r.z),c[7].set(r.x,-r.y,r.z);var a=c[0];t.vmult(a,a),e.vadd(a,a),n.copy(a),i.copy(a);for(var s=1;s<8;s++){a=c[s],t.vmult(a,a),e.vadd(a,a);var o=a.x,l=a.y,u=a.z;o>n.x&&(n.x=o),l>n.y&&(n.y=l),u>n.z&&(n.z=u),o<i.x&&(i.x=o),l<i.y&&(i.y=l),u<i.z&&(i.z=u)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t,i){t.exports=d;var n=e("./Shape"),b=e("../math/Vec3"),_=(e("../math/Quaternion"),e("../math/Transform"));function d(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(d.prototype=new n).constructor=d;var h=new b;d.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=h,r=0;r!==e.length;r++)for(var a=e[r],s=a.length,o=0;o!==s;o++){var l=(o+1)%s;t[a[o]].vsub(t[a[l]],n),n.normalize();for(var u=!1,c=0;c!==i.length;c++)if(i[c].almostEquals(n)||i[c].almostEquals(n)){u=!0;break}u||i.push(n.clone())}},d.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new b;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var n=this.vertices[this.faces[e][0]];if(i.dot(n)<0)for(console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var r=new b,a=new b;d.computeNormal=function(e,t,i,n){t.vsub(e,a),i.vsub(t,r),r.cross(a,n),n.isZero()||n.normalize()},d.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],r=this.vertices[i[1]],a=this.vertices[i[2]];return d.computeNormal(n,r,a,t)};var x=new b;d.prototype.clipAgainstHull=function(e,t,i,n,r,a,s,o,l){for(var u=x,c=-1,h=-Number.MAX_VALUE,d=0;d<i.faces.length;d++){u.copy(i.faceNormals[d]),r.vmult(u,u);var f=u.dot(a);h<f&&(h=f,c=d)}for(var p=[],_=i.faces[c],v=_.length,m=0;m<v;m++){var y=i.vertices[_[m]],g=new b;g.copy(y),r.vmult(g,g),n.vadd(g,g),p.push(g)}0<=c&&this.clipFaceAgainstHull(a,e,t,p,s,o,l)};var T=new b,E=new b,C=new b,A=new b,k=new b,R=new b;d.prototype.findSeparatingAxis=function(e,t,i,n,r,a,s,o){var l=T,u=E,c=C,h=A,d=k,f=R,p=Number.MAX_VALUE,_=this;if(_.uniqueAxes)for(m=0;m!==_.uniqueAxes.length;m++){if(i.vmult(_.uniqueAxes[m],l),!1===(b=_.testSepAxis(l,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(l))}else for(var v=s?s.length:_.faces.length,m=0;m<v;m++){var y=s?s[m]:m;if(l.copy(_.faceNormals[y]),i.vmult(l,l),!1===(b=_.testSepAxis(l,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(l))}if(e.uniqueAxes)for(m=0;m!==e.uniqueAxes.length;m++){if(r.vmult(e.uniqueAxes[m],u),!1===(b=_.testSepAxis(u,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(u))}else for(var g=o?o.length:e.faces.length,m=0;m<g;m++){var b;if(y=o?o[m]:m,u.copy(e.faceNormals[y]),r.vmult(u,u),!1===(b=_.testSepAxis(u,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(u))}for(var x=0;x!==_.uniqueEdges.length;x++){i.vmult(_.uniqueEdges[x],h);for(var S=0;S!==e.uniqueEdges.length;S++)if(r.vmult(e.uniqueEdges[S],d),h.cross(d,f),!f.almostZero()){f.normalize();var w=_.testSepAxis(f,e,t,i,n,r);if(!1===w)return!1;w<p&&(p=w,a.copy(f))}}return n.vsub(t,c),0<c.dot(a)&&a.negate(a),!0};var f=[],p=[];d.prototype.testSepAxis=function(e,t,i,n,r,a){d.project(this,e,i,n,f),d.project(t,e,r,a,p);var s=f[0],o=f[1],l=p[0],u=p[1];if(s<u||l<o)return!1;var c=s-u,h=l-o;return c<h?c:h};var s=new b,o=new b;d.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(s,o);var i=o.x-s.x,n=o.y-s.y,r=o.z-s.z;t.x=1/12*e*(2*n*2*n+2*r*2*r),t.y=1/12*e*(2*i*2*i+2*r*2*r),t.z=1/12*e*(2*n*2*n+2*i*2*i)},d.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)};var z=new b,B=new b,P=new b,D=new b,F=new b,N=new b,U=new b,V=new b;d.prototype.clipFaceAgainstHull=function(e,t,i,n,r,a,s){for(var o=z,l=B,u=P,c=D,h=F,d=N,f=U,p=V,_=n,v=[],m=-1,y=Number.MAX_VALUE,g=0;g<this.faces.length;g++){o.copy(this.faceNormals[g]),i.vmult(o,o);var b=o.dot(e);b<y&&(y=b,m=g)}if(!(m<0)){var x=this.faces[m];x.connectedFaces=[];for(var S=0;S<this.faces.length;S++)for(var w=0;w<this.faces[S].length;w++)-1!==x.indexOf(this.faces[S][w])&&S!==m&&-1===x.connectedFaces.indexOf(S)&&x.connectedFaces.push(S);_.length;for(var T=x.length,E=0;E<T;E++){var C=this.vertices[x[E]],A=this.vertices[x[(E+1)%T]];C.vsub(A,l),u.copy(l),i.vmult(u,u),t.vadd(u,u),c.copy(this.faceNormals[m]),i.vmult(c,c),t.vadd(c,c),u.cross(c,h),h.negate(h),d.copy(C),i.vmult(d,d),t.vadd(d,d),d.dot(h);var k=x.connectedFaces[E];f.copy(this.faceNormals[k]);var R=this.getPlaneConstantOfFace(k);p.copy(f),i.vmult(p,p);var O=R-p.dot(t);for(this.clipFaceAgainstPlane(_,v,p,O);_.length;)_.shift();for(;v.length;)_.push(v.shift())}for(f.copy(this.faceNormals[m]),R=this.getPlaneConstantOfFace(m),p.copy(f),i.vmult(p,p),O=R-p.dot(t),S=0;S<_.length;S++){var M=p.dot(_[S])+O;if(M<=r&&(M=r),M<=a){var I=_[S];if(M<=0){var L={point:I,normal:p,depth:M};s.push(L)}}}}},d.prototype.clipFaceAgainstPlane=function(e,t,i,n){var r,a,s=e.length;if(s<2)return t;var o=e[e.length-1],l=e[0];r=i.dot(o)+n;for(var u=0;u<s;u++){if(l=e[u],a=i.dot(l)+n,r<0)if(a<0)(c=new b).copy(l),t.push(c);else{var c=new b;o.lerp(l,r/(r-a),c),t.push(c)}else a<0&&(c=new b,o.lerp(l,r/(r-a),c),t.push(c),t.push(l));o=l,r=a}return t},d.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new b);for(var n=this.vertices,r=this.worldVertices,a=0;a!==i;a++)t.vmult(n[a],r[a]),e.vadd(r[a],r[a]);this.worldVerticesNeedsUpdate=!1},new b,d.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<i;r++){var a=n[r];a.x<e.x?e.x=a.x:a.x>t.x&&(t.x=a.x),a.y<e.y?e.y=a.y:a.y>t.y&&(t.y=a.y),a.z<e.z?e.z=a.z:a.z>t.z&&(t.z=a.z)}},d.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new b);for(var i=this.faceNormals,n=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(i[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},d.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var r=t[i].norm2();e<r&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var v=new b;d.prototype.calculateWorldAABB=function(e,t,i,n){for(var r,a,s,o,l,u,c=this.vertices.length,h=this.vertices,d=0;d<c;d++){v.copy(h[d]),t.vmult(v,v),e.vadd(v,v);var f=v;f.x<r||void 0===r?r=f.x:(f.x>o||void 0===o)&&(o=f.x),f.y<a||void 0===a?a=f.y:(f.y>l||void 0===l)&&(l=f.y),f.z<s||void 0===s?s=f.z:(f.z>u||void 0===u)&&(u=f.z)}i.set(r,a,s),n.set(o,l,u)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.prototype.getAveragePointLocal=function(e){e=e||new b;for(var t=this.vertices.length,i=this.vertices,n=0;n<t;n++)e.vadd(i[n],e);return e.mult(1/t,e),e},d.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var r=0;r<i;r++){var a=n[r];t.vmult(a,a)}for(r=0;r<this.faceNormals.length;r++)a=this.faceNormals[r],t.vmult(a,a)}if(e)for(r=0;r<i;r++)(a=n[r]).vadd(e,a)};var m=new b,y=new b,g=new b;d.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,a=this.faces.length,s=m;this.getAveragePointLocal(s);for(var o=0;o<a;o++){this.faces[o].length,t=r[o];var l=i[n[o][0]],u=y;e.vsub(l,u);var c=t.dot(u),h=g;s.vsub(l,h);var d=t.dot(h);if(c<0&&0<d||0<c&&d<0)return!1}return-1},new b;var S=new b,w=new b;d.project=function(e,t,i,n,r){var a=e.vertices.length,s=S,o=0,l=0,u=w,c=e.vertices;u.setZero(),_.vectorToLocalFrame(i,n,t,s),_.pointToLocalFrame(i,n,u,u);var h=u.dot(s);l=o=c[0].dot(s);for(var d=1;d<a;d++){var f=c[d].dot(s);o<f&&(o=f),f<l&&(l=f)}if((o-=h)<(l-=h)){var p=l;l=o,o=p}r[0]=o,r[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t,i){t.exports=n,e("./Shape");var v=e("../math/Vec3"),m=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function n(e,t,i,n){var r=n,a=[],s=[],o=[],l=[],u=[],c=Math.cos,h=Math.sin;a.push(new v(t*c(0),t*h(0),.5*-i)),l.push(0),a.push(new v(e*c(0),e*h(0),.5*i)),u.push(1);for(var d=0;d<r;d++){var f=2*Math.PI/r*(d+1),p=2*Math.PI/r*(d+.5);d<r-1?(a.push(new v(t*c(f),t*h(f),.5*-i)),l.push(2*d+2),a.push(new v(e*c(f),e*h(f),.5*i)),u.push(2*d+3),o.push([2*d+2,2*d+3,2*d+1,2*d])):o.push([0,1,2*d+1,2*d]),(r%2==1||d<r/2)&&s.push(new v(c(p),h(p),0))}o.push(u),s.push(new v(0,0,1));var _=[];for(d=0;d<l.length;d++)_.push(l[l.length-d-1]);o.push(_),m.call(this,a,o,s)}n.prototype=new m},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t,i){var n=e("./Shape"),h=e("./ConvexPolyhedron"),d=e("../math/Vec3"),r=e("../utils/Utils");function a(e,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new h,this.pillarOffset=new d,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=a).prototype=new n).update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];r<t&&(t=r)}this.minValue=t},a.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];t<r&&(t=r)}this.maxValue=t},a.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},a.prototype.getRectMinMax=function(e,t,i,n,r){r=r||[];for(var a=this.data,s=this.minValue,o=e;o<=i;o++)for(var l=t;l<=n;l++){var u=a[o][l];s<u&&(s=u)}r[0]=this.minValue,r[1]=s},a.prototype.getIndexOfPosition=function(e,t,i,n){var r=this.elementSize,a=this.data,s=Math.floor(e/r),o=Math.floor(t/r);return i[0]=s,i[1]=o,n&&(s<0&&(s=0),o<0&&(o=0),s>=a.length-1&&(s=a.length-1),o>=a[0].length-1&&(o=a[0].length-1)),!(s<0||o<0||s>=a.length-1||o>=a[0].length-1)};var f=[],p=new d,_=new d,v=new d,m=new d;a.prototype.getTriangleAt=function(e,t,i,n,r,a){var s=f;this.getIndexOfPosition(e,t,s,i);var o=s[0],l=s[1],u=this.data;i&&(o=Math.min(u.length-2,Math.max(0,o)),l=Math.min(u[0].length-2,Math.max(0,l)));var c=this.elementSize,h=Math.pow(e/c-o,2)+Math.pow(t/c-l,2),d=Math.pow(e/c-(o+1),2)+Math.pow(t/c-(l+1),2)<h;return this.getTriangle(o,l,d,n,r,a),d};var u=new d,c=new d,y=new d,g=new d,b=new d;a.prototype.getNormalAt=function(e,t,i,n){var r=u,a=c,s=y,o=g,l=b;this.getTriangleAt(e,t,i,r,a,s),a.vsub(r,o),s.vsub(r,l),o.cross(l,n),n.normalize()},a.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,r=this.elementSize;i.lowerBound.set(e*r,t*r,n[e][t]),i.upperBound.set((e+1)*r,(t+1)*r,n[e+1][t+1])},a.prototype.getHeightAt=function(e,t,i){var n=this.data,r=_,a=v,s=m,o=f;this.getIndexOfPosition(e,t,o,i);var l=o[0],u=o[1];i&&(l=Math.min(n.length-2,Math.max(0,l)),u=Math.min(n[0].length-2,Math.max(0,u)));var c=this.getTriangleAt(e,t,i,r,a,s);!function(e,t,i,n,r,a,s,o,l){l.x=((a-o)*(e-s)+(s-r)*(t-o))/((a-o)*(i-s)+(s-r)*(n-o)),l.y=((o-n)*(e-s)+(i-s)*(t-o))/((a-o)*(i-s)+(s-r)*(n-o)),l.z=1-l.x-l.y}(e,t,r.x,r.y,a.x,a.y,s.x,s.y,p);var h=p;return c?n[l+1][u+1]*h.x+n[l][u+1]*h.y+n[l+1][u]*h.z:n[l][u]*h.x+n[l+1][u]*h.y+n[l][u+1]*h.z},a.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},a.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.getTriangle=function(e,t,i,n,r,a){var s=this.data,o=this.elementSize;i?(n.set((e+1)*o,(t+1)*o,s[e+1][t+1]),r.set(e*o,(t+1)*o,s[e][t+1]),a.set((e+1)*o,t*o,s[e+1][t])):(n.set(e*o,t*o,s[e][t]),r.set((e+1)*o,t*o,s[e+1][t]),a.set(e*o,(t+1)*o,s[e][t+1]))},a.prototype.getConvexTrianglePillar=function(e,t,i){var n=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);n=new h,r=new d,this.pillarConvex=n,this.pillarOffset=r}var a=this.data,s=this.elementSize,o=n.faces;n.vertices.length=6;for(var l=0;l<6;l++)n.vertices[l]||(n.vertices[l]=new d);for(o.length=5,l=0;l<5;l++)o[l]||(o[l]=[]);var u=n.vertices,c=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;i?(r.set((e+.75)*s,(t+.75)*s,c),u[0].set(.25*s,.25*s,a[e+1][t+1]-c),u[1].set(-.75*s,.25*s,a[e][t+1]-c),u[2].set(.25*s,-.75*s,a[e+1][t]-c),u[3].set(.25*s,.25*s,-c-1),u[4].set(-.75*s,.25*s,-c-1),u[5].set(.25*s,-.75*s,-c-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=2,o[2][1]=5,o[2][2]=3,o[2][3]=0,o[3][0]=3,o[3][1]=4,o[3][2]=1,o[3][3]=0,o[4][0]=1,o[4][1]=4,o[4][2]=5,o[4][3]=2):(r.set((e+.25)*s,(t+.25)*s,c),u[0].set(-.25*s,-.25*s,a[e][t]-c),u[1].set(.75*s,-.25*s,a[e+1][t]-c),u[2].set(-.25*s,.75*s,a[e][t+1]-c),u[3].set(-.25*s,-.25*s,-c-1),u[4].set(.75*s,-.25*s,-c-1),u[5].set(-.25*s,.75*s,-c-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=0,o[2][1]=2,o[2][2]=5,o[2][3]=3,o[3][0]=1,o[3][1]=0,o[3][2]=3,o[3][3]=4,o[4][0]=4,o[4][1]=5,o[4][2]=2,o[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,r)},a.prototype.calculateLocalInertia=function(e,t){return(t=t||new d).set(0,0,0),t},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new d(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0);var r=n.getImageData(0,0,e.width,e.height),a=this.data;a.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var s=0;s<r.height;s++){for(var o=[],l=0;l<r.width;l++){var u=(r.data[4*(s*r.height+l)]+r.data[4*(s*r.height+l)+1]+r.data[4*(s*r.height+l)+2])/4/255*t.z;t.x<0?o.push(u):o.unshift(u)}t.y<0?a.unshift(o):a.push(o)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PARTICLE})}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((a.prototype=new n).constructor=a).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(e,t){return t=t||new r},a.prototype.volume=function(){return Number.MAX_VALUE};var s=new r;a.prototype.calculateWorldAABB=function(e,t,i,n){s.set(0,0,1),t.vmult(s,s);var r=Number.MAX_VALUE;i.set(-r,-r,-r),n.set(r,r,r),1===s.x&&(n.x=e.x),1===s.y&&(n.y=e.y),1===s.z&&(n.z=e.z),-1===s.x&&(i.x=e.x),-1===s.y&&(i.y=e.y),-1===s.z&&(i.z=e.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t,i){t.exports=r;var n=e("../utils/EventTarget"),r=e("./Shape");function r(e){e=e||{},n.apply(this),this.id=r.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),r.prototype=new n,(r.prototype.constructor=r).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},r.idCounter=0,r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){t=t||new r;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(e,t,i,n){for(var r=this.radius,a=["x","y","z"],s=0;s<a.length;s++){var o=a[s];i[o]=e[o]-r,n[o]=e[o]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t,i){t.exports=y;var n=e("./Shape"),u=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),c=e("../collision/AABB"),a=e("../utils/Octree");function y(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new c,this.edges=null,this.scale=new u(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(y.prototype=new n).constructor=y;var o=new u;y.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new c,n=new u,r=new u,a=new u,s=[n,r,a],o=0;o<this.indices.length/3;o++){var l=3*o;this._getUnscaledVertex(this.indices[l],n),this._getUnscaledVertex(this.indices[1+l],r),this._getUnscaledVertex(this.indices[2+l],a),i.setFromPoints(s),e.insert(i,o)}e.removeEmptyNodes()};var l=new c;y.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var i=this.scale,n=i.x,r=i.y,a=i.z,s=l.lowerBound,o=l.upperBound;return s.x/=n,s.y/=r,s.z/=a,o.x/=n,o.y/=r,o.z/=a,this.tree.aabbQuery(l,t)},y.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},y.prototype.updateNormals=function(){for(var e=o,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],a=this.indices[1+n],s=this.indices[2+n];this.getVertex(r,p),this.getVertex(a,_),this.getVertex(s,v),y.computeNormal(_,p,v,e),t[n]=e.x,t[1+n]=e.y,t[2+n]=e.z}},y.prototype.updateEdges=function(){function e(e,t){i[r<a?r+"_"+a:a+"_"+r]=!0}for(var i={},t=0;t<this.indices.length/3;t++){var n=3*t,r=this.indices[n],a=this.indices[1+n];this.indices[2+n],e(),e(),e()}var s=Object.keys(i);for(this.edges=new Int16Array(2*s.length),t=0;t<s.length;t++){var o=s[t].split("_");this.edges[2*t]=parseInt(o[0],10),this.edges[2*t+1]=parseInt(o[1],10)}},y.prototype.getEdgeVertex=function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)};var s=new u,h=new u;y.prototype.getEdgeVector=function(e,t){var i=s,n=h;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)};var d=new u,f=new u;y.computeNormal=function(e,t,i,n){t.vsub(e,f),i.vsub(t,d),d.cross(f,n),n.isZero()||n.normalize()};var p=new u,_=new u,v=new u;y.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},y.prototype._getUnscaledVertex=function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[1+i],n[2+i])},y.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),r.pointToWorldFrame(t,i,n,n),n},y.prototype.getTriangleVertices=function(e,t,i,n){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[1+r],i),this.getVertex(this.indices[2+r],n)},y.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[1+i],this.normals[2+i])};var m=new c;y.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(m);var i=m.upperBound.x-m.lowerBound.x,n=m.upperBound.y-m.lowerBound.y,r=m.upperBound.z-m.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*r*2*r),1/12*e*(2*i*2*i+2*r*2*r),1/12*e*(2*n*2*n+2*i*2*i))};var g=new u;y.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length,r=(this.vertices,g);this.getVertex(0,r),t.copy(r),i.copy(r);for(var a=0;a!==n;a++)this.getVertex(a,r),r.x<t.x?t.x=r.x:r.x>i.x&&(i.x=r.x),r.y<t.y?t.y=r.y:r.y>i.y&&(i.y=r.y),r.z<t.z?t.z=r.z:r.z>i.z&&(i.z=r.z)},y.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},y.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new u,n=0,r=t.length/3;n!==r;n++){this.getVertex(n,i);var a=i.norm2();e<a&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new u;var b=new r,x=new c;y.prototype.calculateWorldAABB=function(e,t,i,n){var r=b,a=x;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,a),i.copy(a.lowerBound),n.copy(a.upperBound)},y.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},y.createTorus=function(e,t,i,n,r){e=e||1,t=t||.5,i=i||8,n=n||6,r=r||2*Math.PI;for(var a=[],s=[],o=0;o<=i;o++)for(var l=0;l<=n;l++){var u=l/n*r,c=o/i*Math.PI*2,h=(e+t*Math.cos(c))*Math.cos(u),d=(e+t*Math.cos(c))*Math.sin(u),f=t*Math.sin(c);a.push(h,d,f)}for(o=1;o<=i;o++)for(l=1;l<=n;l++){var p=(n+1)*o+l-1,_=(n+1)*(o-1)+l-1,v=(n+1)*(o-1)+l,m=(n+1)*o+l;s.push(p,_,m),s.push(_,v,m)}return new y(a,s)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t,i){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new n;var k=[],R=[],O=[];r.prototype.solve=function(e,t){var i,n,r,a,s,o=0,l=this.iterations,u=this.tolerance*this.tolerance,c=this.equations,h=c.length,d=t.bodies,f=d.length,p=e;if(0!==h)for(var _=0;_!==f;_++)d[_].updateSolveMassProperties();var v=R,m=O,y=k;for(v.length=h,m.length=h,y.length=h,_=0;_!==h;_++){var g=c[_];y[_]=0,m[_]=g.computeB(p),v[_]=1/g.computeC()}if(0!==h){for(_=0;_!==f;_++){var b=(w=d[_]).vlambda,x=w.wlambda;b.set(0,0,0),x.set(0,0,0)}for(o=0;o!==l;o++){for(var S=a=0;S!==h;S++)g=c[S],i=m[S],n=v[S],(s=y[S])+(r=n*(i-g.computeGWlambda()-g.eps*s))<g.minForce?r=g.minForce-s:s+r>g.maxForce&&(r=g.maxForce-s),y[S]+=r,a+=0<r?r:-r,g.addToWlambda(r);if(a*a<u)break}for(_=0;_!==f;_++){var w,T=(w=d[_]).velocity,E=w.angularVelocity;w.vlambda.vmul(w.linearFactor,w.vlambda),T.vadd(w.vlambda,T),w.wlambda.vmul(w.angularFactor,w.wlambda),E.vadd(w.wlambda,E)}for(var C=c.length,A=1/p;C--;)c[C].multiplier=y[C]*A}return o}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t,i){function n(){this.equations=[]}(t.exports=n).prototype.solve=function(e,t){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t,i){t.exports=a,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),r=e("../objects/Body");function a(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new n;var x=[],S=[],w={bodies:[]},s=r.STATIC;function T(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&s))return n}return!1}var o=[];function E(e,t,i,n){for(o.push(e),e.visited=!0,t(e,i,n);o.length;)for(var r,a=o.pop();r=T(a.children);)r.visited=!0,t(r,i,n),o.push(r)}function C(e,t,i){t.push(e.body);for(var n=e.eqs.length,r=0;r!==n;r++){var a=e.eqs[r];-1===i.indexOf(a)&&i.push(a)}}function A(e,t){return t.id-e.id}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(e,t){for(var i=x,n=this.nodePool,r=t.bodies,a=this.equations,s=a.length,o=r.length,l=this.subsolver;n.length<o;)n.push(this.createNode());i.length=o;for(var u=0;u<o;u++)i[u]=n[u];for(u=0;u!==o;u++){var c=i[u];c.body=r[u],c.children.length=0,c.eqs.length=0,c.visited=!1}for(var h=0;h!==s;h++){var d=a[h],f=(u=r.indexOf(d.bi),r.indexOf(d.bj)),p=i[u],_=i[f];p.children.push(_),p.eqs.push(d),_.children.push(p),_.eqs.push(d)}var v,m=0,y=S;l.tolerance=this.tolerance,l.iterations=this.iterations;for(var g=w;v=T(i);){y.length=0,g.bodies.length=0,E(v,C,g.bodies,y);var b=y.length;for(y=y.sort(A),u=0;u!==b;u++)l.addEquation(y[u]);l.solve(e,g),l.removeAllEquations(),m++}return m}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t,i){function n(){}(t.exports=n).prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t,i){var l=e("../collision/AABB"),u=e("../math/Vec3");function c(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new l,this.data=[],this.children=[]}(t.exports=function(e,t){(t=t||{}).root=null,t.aabb=e,c.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}).prototype=new c,c.prototype.reset=function(e,t){this.children.length=this.data.length=0},c.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var a=!1;r.length||(this.subdivide(),a=!0);for(var s=0;8!==s;s++)if(r[s].insert(e,t,i+1))return!0;a&&(r.length=0)}return n.push(t),!0};var h=new u;c.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,n=this.children;n.push(new c({aabb:new l({lowerBound:new u(0,0,0)})}),new c({aabb:new l({lowerBound:new u(1,0,0)})}),new c({aabb:new l({lowerBound:new u(1,1,0)})}),new c({aabb:new l({lowerBound:new u(1,1,1)})}),new c({aabb:new l({lowerBound:new u(0,1,1)})}),new c({aabb:new l({lowerBound:new u(0,0,1)})}),new c({aabb:new l({lowerBound:new u(1,0,1)})}),new c({aabb:new l({lowerBound:new u(0,1,0)})})),i.vsub(t,h),h.scale(.5,h);for(var r=this.root||this,a=0;8!==a;a++){var s=n[a];s.root=r;var o=s.aabb.lowerBound;o.x*=h.x,o.y*=h.y,o.z*=h.z,o.vadd(t,o),o.vadd(h,s.aabb.upperBound)}},c.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t};var n=new l;c.prototype.rayQuery=function(e,t,i){return e.getAABB(n),n.toLocalFrame(t,n),this.aabbQuery(n,i),i},c.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;0<=i;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t,i){function n(){this.objects=[],this.type=Object}(t.exports=n).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t,i){function n(){this.data={keys:[]}}(t.exports=n).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},n.prototype.set=function(e,t,i){if(t<e){var n=t;t=e,e=n}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=i,this.data[r]},n.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;)delete e[t.pop()]},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t,i){(t.exports=function(){}).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=e("./Pool");function a(){r.call(this),this.type=n}(a.prototype=new r).constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t,i){t.exports=o;var n=e("../collision/AABB"),w=e("../objects/Body"),r=e("../shapes/Shape"),B=e("../collision/Ray"),y=e("../math/Vec3"),P=e("../math/Transform"),a=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),s=(e("../solver/Solver"),e("../utils/Vec3Pool")),c=e("../equations/ContactEquation"),v=e("../equations/FrictionEquation");function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new s,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}o.prototype.createContactEquation=function(e,t,i,n,r,a){var s;this.contactPointPool.length?((s=this.contactPointPool.pop()).bi=e,s.bj=t):s=new c(e,t);var o=this.currentContactMaterial;s.restitution=o.restitution,s.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,u=n.material||t.material;return l&&u&&0<=l.restitution&&0<=u.restitution&&(s.restitution=l.restitution*u.restitution),s.si=r||i,s.sj=a||n,s},o.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,n=e.bj,r=e.si,a=e.sj,s=this.world,o=this.currentContactMaterial,l=o.friction,u=r.material||i.material,c=a.material||n.material;if(u&&c&&0<=u.friction&&0<=c.friction&&(l=u.friction*c.friction),0<l){var h=l*s.gravity.length(),d=i.invMass+n.invMass;0<d&&(d=1/d);var f=this.frictionEquationPool,p=f.length?f.pop():new v(i,n,h*d),_=f.length?f.pop():new v(i,n,h*d);return p.bi=_.bi=i,p.bj=_.bj=n,p.minForce=_.minForce=-h*d,p.maxForce=_.maxForce=h*d,p.ri.copy(e.ri),p.rj.copy(e.rj),_.ri.copy(e.ri),_.rj.copy(e.rj),e.ni.tangents(p.t,_.t),p.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),_.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),p.enabled=_.enabled=e.enabled,t.push(p,_),!0}return!1};var l=new y,u=new y,h=new y;o.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];l.setZero(),u.setZero(),h.setZero();for(var r=t.bi,a=(t.bj,0);a!==e;a++)(t=this.result[this.result.length-1-a]).bodyA!==r?(l.vadd(t.ni,l),u.vadd(t.ri,u),h.vadd(t.rj,h)):(l.vsub(t.ni,l),u.vadd(t.rj,u),h.vadd(t.ri,h));var s=1/e;u.scale(s,i.ri),h.scale(s,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),l.normalize(),l.tangents(i.t,n.t)}};var T=new y,E=new y,C=new a,A=new a;o.prototype.getContacts=function(e,t,i,n,r,a,s){this.frictionEquationPool=s,this.result=n,this.frictionResult=a;for(var o=C,l=A,u=T,c=E,h=0,d=e.length;h!==d;h++){var f=e[h],p=t[h],_=null;f.material&&p.material&&(_=i.getContactMaterial(f.material,p.material)||null);for(var v=0==f.collisionResponse||0==p.collisionResponse||f.type&w.KINEMATIC&&p.type&w.STATIC||f.type&w.STATIC&&p.type&w.KINEMATIC||f.type&w.KINEMATIC&&p.type&w.KINEMATIC,m=0;m<f.shapes.length;m++){f.quaternion.mult(f.shapeOrientations[m],o),f.quaternion.vmult(f.shapeOffsets[m],u),u.vadd(f.position,u);for(var y=f.shapes[m],g=0;g<p.shapes.length;g++){p.quaternion.mult(p.shapeOrientations[g],l),p.quaternion.vmult(p.shapeOffsets[g],c),c.vadd(p.position,c);var b=p.shapes[g];if(y.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&y.collisionFilterGroup&&!(u.distanceTo(c)>y.boundingSphereRadius+b.boundingSphereRadius)){v|=0==y.collisionResponse||0==b.collisionResponse;var x=null;y.material&&b.material&&(x=i.getContactMaterial(y.material,b.material)||null),this.currentContactMaterial=x||_||i.defaultContactMaterial;var S=this[y.type|b.type];S&&(y.type<b.type?S.call(this,y,b,u,c,o,l,f,p,y,b,v):S.call(this,b,y,c,u,l,o,p,f,y,b,v))&&v&&(i.shapeOverlapKeeper.set(y.id,b.id),i.shapeOverlapKeeperExit.set(y.id,b.id))}}}}},o.prototype[r.types.BOX|r.types.BOX]=o.prototype.boxBox=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,c)},o.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,c)},o.prototype[r.types.BOX|r.types.PARTICLE]=o.prototype.boxParticle=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,c)},o.prototype[r.types.SPHERE]=o.prototype.sphereSphere=function(e,t,i,n,r,a,s,o,l,u,c){if(c)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(s,o,e,t,l,u);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(s.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var g=new y,b=new y,x=new y;o.prototype[r.types.PLANE|r.types.TRIMESH]=o.prototype.planeTrimesh=function(e,t,i,n,r,a,s,o,l,u,c){var h=new y,d=g;d.set(0,0,1),r.vmult(d,d);for(var f=0;f<t.vertices.length/3;f++){t.getVertex(f,h);var p=new y;p.copy(h),P.pointToWorldFrame(n,a,p,h);var _=b;if(h.vsub(i,_),d.dot(_)<=0){if(c)return!0;var v=this.createContactEquation(s,o,e,t,l,u);v.ni.copy(d);var m=x;d.scale(_.dot(d),m),h.vsub(m,m),v.ri.copy(m),v.ri.vsub(s.position,v.ri),v.rj.copy(h),v.rj.vsub(o.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}};var D=new y,F=new y,N=(new y,new y),U=new y,V=new y,G=new y,H=new y,W=new y,q=new y,j=new y,X=new y,Y=new y,K=new y,Q=new n,Z=[];o.prototype[r.types.SPHERE|r.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,t,i,n,r,a,s,o,l,u,c){var h=V,d=G,f=H,p=W,_=q,v=j,m=Q,y=U,g=F,b=Z;P.pointToLocalFrame(n,a,i,_);var x=e.radius;m.lowerBound.set(_.x-x,_.y-x,_.z-x),m.upperBound.set(_.x+x,_.y+x,_.z+x),t.getTrianglesInAABB(m,b);for(var S=N,w=e.radius*e.radius,T=0;T<b.length;T++)for(var E=0;E<3;E++)if(t.getVertex(t.indices[3*b[T]+E],S),S.vsub(_,g),g.norm2()<=w){if(y.copy(S),P.pointToWorldFrame(n,a,y,S),S.vsub(i,g),c)return!0;(k=this.createContactEquation(s,o,e,t,l,u)).ni.copy(g),k.ni.normalize(),k.ri.copy(k.ni),k.ri.scale(e.radius,k.ri),k.ri.vadd(i,k.ri),k.ri.vsub(s.position,k.ri),k.rj.copy(S),k.rj.vsub(o.position,k.rj),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}for(T=0;T<b.length;T++)for(E=0;E<3;E++){t.getVertex(t.indices[3*b[T]+E],h),t.getVertex(t.indices[3*b[T]+(E+1)%3],d),d.vsub(h,f),_.vsub(d,v);var C=v.dot(f);_.vsub(h,v);var A=v.dot(f);if(0<A&&C<0&&(_.vsub(h,v),p.copy(f),p.normalize(),A=v.dot(p),p.scale(A,v),v.vadd(h,v),(z=v.distanceTo(_))<e.radius)){if(c)return!0;var k=this.createContactEquation(s,o,e,t,l,u);v.vsub(_,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),P.pointToWorldFrame(n,a,v,v),v.vsub(o.position,k.rj),P.vectorToWorldFrame(a,k.ni,k.ni),P.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}for(var R=X,O=Y,M=K,I=D,L=(T=0,b.length);T!==L;T++){t.getTriangleVertices(b[T],R,O,M),t.getNormal(b[T],I),_.vsub(R,v);var z=v.dot(I);if(I.scale(z,v),_.vsub(v,v),z=v.distanceTo(_),B.pointInTriangle(v,R,O,M)&&z<e.radius){if(c)return!0;k=this.createContactEquation(s,o,e,t,l,u),v.vsub(_,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),P.pointToWorldFrame(n,a,v,v),v.vsub(o.position,k.rj),P.vectorToWorldFrame(a,k.ni,k.ni),P.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}b.length=0};var p=new y,_=new y,m=new y,S=new y,k=new y;o.prototype[r.types.SPHERE|r.types.PLANE]=o.prototype.spherePlane=function(e,t,i,n,r,a,s,o,l,u,c){if(m.set(0,0,1),a.vmult(m,m),m.negate(m),m.normalize(),m.mult(e.radius,S),i.vsub(n,p),m.mult(m.dot(p),_),p.vsub(_,k),-p.dot(m)<=e.radius){if(c)return!0;var h=this.createContactEquation(s,o,e,t,l,u);h.ni.copy(m),h.ri.copy(S),h.rj.copy(k);var d=h.ri,f=h.rj;d.vadd(i,d),d.vsub(s.position,d),f.vadd(n,f),f.vsub(o.position,f),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var d=new y,f=new y,R=new y;function J(e,t,i){for(var n=null,r=e.length,a=0;a!==r;a++){var s=e[a],o=d;e[(a+1)%r].vsub(s,o);var l=f;o.cross(t,l);var u=R;i.vsub(s,u);var c=l.dot(u);if(!(null===n||0<c&&!0===n||c<=0&&!1===n))return!1;null===n&&(n=0<c)}return!0}var $=new y,ee=new y,te=new y,ie=new y,ne=[new y,new y,new y,new y,new y,new y],re=new y,ae=new y,se=new y,oe=new y;o.prototype[r.types.SPHERE|r.types.BOX]=o.prototype.sphereBox=function(e,t,i,n,r,a,s,o,l,u,c){var h=this.v3pool,d=ne;i.vsub(n,$),t.getSideNormals(d,a);for(var f=e.radius,p=!1,_=ae,v=se,m=oe,y=null,g=0,b=0,x=0,S=null,w=0,T=d.length;w!==T&&!1===p;w++){var E=ee;E.copy(d[w]);var C=E.norm();E.normalize();var A=$.dot(E);if(A<C+f&&0<A){var k=te,R=ie;k.copy(d[(w+1)%3]),R.copy(d[(w+2)%3]);var O=k.norm(),M=R.norm();k.normalize(),R.normalize();var I=$.dot(k),L=$.dot(R);if(I<O&&-O<I&&L<M&&-M<L){var z=Math.abs(A-C-f);if((null===S||z<S)&&(S=z,b=I,x=L,y=C,_.copy(E),v.copy(k),m.copy(R),g++,c))return!0}}}if(g){p=!0;var B=this.createContactEquation(s,o,e,t,l,u);_.mult(-f,B.ri),B.ni.copy(_),B.ni.negate(B.ni),_.mult(y,_),v.mult(b,v),_.vadd(v,_),m.mult(x,m),_.vadd(m,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(s.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(o.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var P=h.get(),D=re,F=0;2!==F&&!p;F++)for(var N=0;2!==N&&!p;N++)for(var U=0;2!==U&&!p;U++)if(P.set(0,0,0),F?P.vadd(d[0],P):P.vsub(d[0],P),N?P.vadd(d[1],P):P.vsub(d[1],P),U?P.vadd(d[2],P):P.vsub(d[2],P),n.vadd(P,D),D.vsub(i,D),D.norm2()<f*f){if(c)return!0;p=!0,(B=this.createContactEquation(s,o,e,t,l,u)).ri.copy(D),B.ri.normalize(),B.ni.copy(B.ri),B.ri.mult(f,B.ri),B.rj.copy(P),B.ri.vadd(i,B.ri),B.ri.vsub(s.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(o.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}h.release(P),P=null;var V=h.get(),G=h.get(),H=(B=h.get(),h.get()),W=(z=h.get(),d.length);for(F=0;F!==W&&!p;F++)for(N=0;N!==W&&!p;N++)if(F%3!=N%3){d[N].cross(d[F],V),V.normalize(),d[F].vadd(d[N],G),B.copy(i),B.vsub(G,B),B.vsub(n,B);var q=B.dot(V);for(V.mult(q,H),U=0;U===F%3||U===N%3;)U++;z.copy(i),z.vsub(H,z),z.vsub(G,z),z.vsub(n,z);var j=Math.abs(q),X=z.norm();if(j<d[U].norm()&&X<f){if(c)return!0;p=!0;var Y=this.createContactEquation(s,o,e,t,l,u);G.vadd(H,Y.rj),Y.rj.copy(Y.rj),z.negate(Y.ni),Y.ni.normalize(),Y.ri.copy(Y.rj),Y.ri.vadd(n,Y.ri),Y.ri.vsub(i,Y.ri),Y.ri.normalize(),Y.ri.mult(f,Y.ri),Y.ri.vadd(i,Y.ri),Y.ri.vsub(s.position,Y.ri),Y.rj.vadd(n,Y.rj),Y.rj.vsub(o.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult)}}h.release(V,G,B,H,z)};var le=new y,ue=new y,ce=new y,he=new y,de=new y,fe=new y,pe=new y,_e=new y,ve=new y,me=new y;o.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,t,i,n,r,a,s,o,l,u,c){var h=this.v3pool;i.vsub(n,le);for(var d=t.faceNormals,f=t.faces,p=t.vertices,_=e.radius,v=0;v!==p.length;v++){var m=p[v],y=de;a.vmult(m,y),n.vadd(y,y);var g=he;if(y.vsub(i,g),g.norm2()<_*_)return!!c||(b=!0,(z=this.createContactEquation(s,o,e,t,l,u)).ri.copy(g),z.ri.normalize(),z.ni.copy(z.ri),z.ri.mult(_,z.ri),y.vsub(n,z.rj),z.ri.vadd(i,z.ri),z.ri.vsub(s.position,z.ri),z.rj.vadd(n,z.rj),z.rj.vsub(o.position,z.rj),this.result.push(z),void this.createFrictionEquationsFromContact(z,this.frictionResult))}for(var b=!1,x=(v=0,f.length);v!==x&&!1===b;v++){var S=d[v],w=f[v],T=fe;a.vmult(S,T);var E=pe;a.vmult(p[w[0]],E),E.vadd(n,E);var C=_e;T.mult(-_,C),i.vadd(C,C);var A=ve;C.vsub(E,A);var k=A.dot(T),R=me;if(i.vsub(E,R),k<0&&0<R.dot(T)){for(var O=[],M=0,I=w.length;M!==I;M++){var L=h.get();a.vmult(p[w[M]],L),n.vadd(L,L),O.push(L)}if(J(O,T,i)){if(c)return!0;b=!0;var z=this.createContactEquation(s,o,e,t,l,u);T.mult(-_,z.ri),T.negate(z.ni);var B=h.get();T.mult(-k,B);var P=h.get();T.mult(-_,P),i.vsub(n,z.rj),z.rj.vadd(P,z.rj),z.rj.vadd(B,z.rj),z.rj.vadd(n,z.rj),z.rj.vsub(o.position,z.rj),z.ri.vadd(i,z.ri),z.ri.vsub(s.position,z.ri),h.release(B),h.release(P),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult),M=0;for(var D=O.length;M!==D;M++)h.release(O[M]);return}for(M=0;M!==w.length;M++){var F=h.get(),N=h.get();a.vmult(p[w[(M+1)%w.length]],F),a.vmult(p[w[(M+2)%w.length]],N),n.vadd(F,F),n.vadd(N,N);var U=ue;N.vsub(F,U);var V=ce;U.unit(V);var G=h.get(),H=h.get();i.vsub(F,H);var W=H.dot(V);V.mult(W,G),G.vadd(F,G);var q=h.get();if(G.vsub(i,q),0<W&&W*W<U.norm2()&&q.norm2()<_*_){if(c)return!0;for(z=this.createContactEquation(s,o,e,t,l,u),G.vsub(n,z.rj),G.vsub(i,z.ni),z.ni.normalize(),z.ni.mult(_,z.ri),z.rj.vadd(n,z.rj),z.rj.vsub(o.position,z.rj),z.ri.vadd(i,z.ri),z.ri.vsub(s.position,z.ri),this.result.push(z),this.createFrictionEquationsFromContact(z,this.frictionResult),M=0,D=O.length;M!==D;M++)h.release(O[M]);return h.release(F),h.release(N),h.release(G),h.release(q),void h.release(H)}h.release(F),h.release(N),h.release(G),h.release(q),h.release(H)}for(M=0,D=O.length;M!==D;M++)h.release(O[M])}}},new y,new y,o.prototype[r.types.PLANE|r.types.BOX]=o.prototype.planeBox=function(e,t,i,n,r,a,s,o,l,u,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,c)};var O=new y,M=new y,I=new y,L=new y;o.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,t,i,n,r,a,s,o,l,u,c){var h=O,d=M;d.set(0,0,1),r.vmult(d,d);for(var f=0,p=I,_=0;_!==t.vertices.length;_++)if(h.copy(t.vertices[_]),a.vmult(h,h),n.vadd(h,h),h.vsub(i,p),d.dot(p)<=0){if(c)return!0;var v=this.createContactEquation(s,o,e,t,l,u),m=L;d.mult(d.dot(p),m),h.vsub(m,m),m.vsub(i,v.ri),v.ni.copy(d),h.vsub(n,v.rj),v.ri.vadd(i,v.ri),v.ri.vsub(s.position,v.ri),v.rj.vadd(n,v.rj),v.rj.vsub(o.position,v.rj),this.result.push(v),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)};var z=new y,ye=new y;o.prototype[r.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,t,i,n,r,a,s,o,l,u,c,h,d){var f=z;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,r,n,a,f,h,d)){var p=[],_=ye;e.clipAgainstHull(i,r,t,n,a,f,-100,100,p);for(var v=0,m=0;m!==p.length;m++){if(c)return!0;var y=this.createContactEquation(s,o,e,t,l,u),g=y.ri,b=y.rj;f.negate(y.ni),p[m].normal.negate(_),_.mult(p[m].depth,_),p[m].point.vadd(_,g),b.copy(p[m].point),g.vsub(i,g),b.vsub(n,b),g.vadd(i,g),g.vsub(s.position,g),b.vadd(n,b),b.vsub(o.position,b),this.result.push(y),v++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&v&&this.createFrictionFromAverage(v)}};var ge=new y,be=new y,xe=new y;o.prototype[r.types.PLANE|r.types.PARTICLE]=o.prototype.planeParticle=function(e,t,i,n,r,a,s,o,l,u,c){var h=ge;h.set(0,0,1),s.quaternion.vmult(h,h);var d=be;if(n.vsub(s.position,d),h.dot(d)<=0){if(c)return!0;var f=this.createContactEquation(o,s,t,e,l,u);f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0);var p=xe;h.mult(h.dot(n),p),n.vsub(p,p),f.rj.copy(p),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var Se=new y;o.prototype[r.types.PARTICLE|r.types.SPHERE]=o.prototype.sphereParticle=function(e,t,i,n,r,a,s,o,l,u,c){var h=Se;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=e.radius*e.radius){if(c)return!0;var d=this.createContactEquation(o,s,t,e,l,u);h.normalize(),d.rj.copy(h),d.rj.mult(e.radius,d.rj),d.ni.copy(h),d.ni.negate(d.ni),d.ri.set(0,0,0),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}};var we=new a,Te=new y,Ee=(new y,new y),Ce=new y,Ae=new y;o.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,t,i,n,r,a,s,o,l,u,c){var h=-1,d=Ee,f=Ae,p=null,_=Te;if(_.copy(n),_.vsub(i,_),r.conjugate(we),we.vmult(_,_),e.pointIsInside(_)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var v=0,m=e.faces.length;v!==m;v++){var y=[e.worldVertices[e.faces[v][0]]],g=e.worldFaceNormals[v];n.vsub(y[0],Ce);var b=-g.dot(Ce);if(null===p||Math.abs(b)<Math.abs(p)){if(c)return!0;p=b,h=v,d.copy(g)}}if(-1!==h){var x=this.createContactEquation(o,s,t,e,l,u);d.mult(p,f),f.vadd(n,f),f.vsub(i,f),x.rj.copy(f),d.negate(x.ni),x.ri.set(0,0,0);var S=x.ri,w=x.rj;S.vadd(n,S),S.vsub(o.position,S),w.vadd(i,w),w.vsub(s.position,w),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[r.types.BOX|r.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,c)};var ke=new y,Re=new y,Oe=[0];o.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,t,i,n,r,a,s,o,l,u,c){var h=t.data,d=t.elementSize,f=e.boundingSphereRadius,p=Re,_=Oe,v=ke;P.pointToLocalFrame(n,a,i,v);var m=Math.floor((v.x-f)/d)-1,y=Math.ceil((v.x+f)/d)+1,g=Math.floor((v.y-f)/d)-1,b=Math.ceil((v.y+f)/d)+1;if(!(y<0||b<0||m>h.length||g>h[0].length)){m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),b<0&&(b=0),m>=h.length&&(m=h.length-1),y>=h.length&&(y=h.length-1),b>=h[0].length&&(b=h[0].length-1),g>=h[0].length&&(g=h[0].length-1);var x=[];t.getRectMinMax(m,g,y,b,x);var S=x[0],w=x[1];if(!(v.z-f>w||v.z+f<S))for(var T=m;T<y;T++)for(var E=g;E<b;E++){var C=!1;if(t.getConvexTrianglePillar(T,E,!1),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.convexConvex(e,t.pillarConvex,i,p,r,a,s,o,null,null,c,_,null)),c&&C)return!0;if(t.getConvexTrianglePillar(T,E,!0),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.convexConvex(e,t.pillarConvex,i,p,r,a,s,o,null,null,c,_,null)),c&&C)return!0}}};var Me=new y,Ie=new y;o.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,t,i,n,r,a,s,o,l,u,c){var h=t.data,d=e.radius,f=t.elementSize,p=Ie,_=Me;P.pointToLocalFrame(n,a,i,_);var v=Math.floor((_.x-d)/f)-1,m=Math.ceil((_.x+d)/f)+1,y=Math.floor((_.y-d)/f)-1,g=Math.ceil((_.y+d)/f)+1;if(!(m<0||g<0||v>h.length||g>h[0].length)){v<0&&(v=0),m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),v>=h.length&&(v=h.length-1),m>=h.length&&(m=h.length-1),g>=h[0].length&&(g=h[0].length-1),y>=h[0].length&&(y=h[0].length-1);var b=[];t.getRectMinMax(v,y,m,g,b);var x=b[0],S=b[1];if(!(_.z-d>S||_.z+d<x))for(var w=this.result,T=v;T<m;T++)for(var E=y;E<g;E++){var C=w.length,A=!1;if(t.getConvexTrianglePillar(T,E,!1),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.sphereConvex(e,t.pillarConvex,i,p,r,a,s,o,e,t,c)),c&&A)return!0;if(t.getConvexTrianglePillar(T,E,!0),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.sphereConvex(e,t.pillarConvex,i,p,r,a,s,o,e,t,c)),c&&A)return!0;if(2<w.length-C)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(b,x,e){(function(e){x.exports=f,b("../shapes/Shape");var t=b("../math/Vec3"),i=(b("../math/Quaternion"),b("../solver/GSSolver")),n=(b("../equations/ContactEquation"),b("../equations/FrictionEquation"),b("./Narrowphase")),r=b("../utils/EventTarget"),a=(b("../collision/ArrayCollisionMatrix"),b("../collision/ObjectCollisionMatrix")),s=b("../collision/OverlapKeeper"),o=b("../material/Material"),l=b("../material/ContactMaterial"),L=b("../objects/Body"),u=b("../utils/TupleDictionary"),c=b("../collision/RaycastResult"),h=(b("../collision/AABB"),b("../collision/Ray")),d=b("../collision/NaiveBroadphase");function f(e){e=e||{},r.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.contactsDic=new u,this.oldContactsDic=new u,this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new t,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new d,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new i,this.constraints=[],this.narrowphase=new n(this),this.collisionMatrix=new a,this.triggerMatrix=new a,this.shapeOverlapKeeper=new s,this.shapeOverlapKeeperExit=new s,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new u,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new l(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.broadphase.setWorld(this)}e?(e.doProfiling=!1,e.DEBUG=!0):window&&(window.doProfiling=!1,window.DEBUG=!0),f.idToBodyMap={},f.idToShapeMap={},f.prototype=new r;var p=new h;f.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},f.prototype.numObjects=function(){return this.bodies.length},f.prototype.collisionMatrixTick=function(){},f.prototype.add=f.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof L&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,f.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},f.prototype.addConstraint=function(e){this.constraints.push(e)},f.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},f.prototype.rayTest=function(e,t,i){i instanceof c?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},f.prototype.raycastAll=function(e,t,i,n){return i.mode=h.ALL,i.from=e,i.to=t,i.callback=n,p.intersectWorld(this,i)},f.prototype.raycastAny=function(e,t,i,n){return i.mode=h.ANY,i.from=e,i.to=t,i.result=n,p.intersectWorld(this,i)},f.prototype.raycastClosest=function(e,t,i,n){return i.mode=h.CLOSEST,i.from=e,i.to=t,i.result=n,p.intersectWorld(this,i)},f.prototype.removeBody=f.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete f.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}},f.prototype.getBodyById=function(e){return f.idToBodyMap[e]},f.prototype.getShapeById=function(e){return f.idToShapeMap[e]},f.prototype.addMaterial=function(e){this.materials.push(e)},f.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},f.prototype.step=function(e,t,i){if(i=i||10,t=t||0,v=this.contacts.slice(),0===t)this.internalStep(e),this.time+=e;else{this.accumulator+=t;for(var n=0;this.accumulator>=e&&n<i;)this.internalStep(e),this.accumulator-=e,n++;for(var r=this.accumulator%e/e,a=0;a!==this.bodies.length;a++){var s=this.bodies[a];s.previousPosition.lerp(s.position,r,s.interpolatedPosition),s.previousQuaternion.slerp(s.quaternion,r,s.interpolatedQuaternion),s.previousQuaternion.normalize()}this.time+=t}for(var o=this.contacts,l=this.contacts.length;l--;){var u=o[l],c=u.si,h=u.sj,d=this.contactsDic.get(c.id,h.id);null==d&&(d=this.contactsDic.set(c.id,h.id,[])),d.push(u)}};var _={type:"collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},v=[],z=[],B=[],P=[];f.prototype.internalStep=function(e){this.dt=e;var t=this.contacts,i=B,n=P,r=this.numObjects(),a=this.bodies,s=this.solver,o=this.gravity,l=(this.profile,L.DYNAMIC),u=this.constraints,c=z,h=o.x,d=o.y,f=o.z,p=0;for(p=0;p!==r;p++)if((C=a[p]).useGravity&&C.type===l){var _=C.force,v=C.mass;_.x+=v*h,_.y+=v*d,_.z+=v*f}p=0;for(var m=this.subsystems.length;p!==m;p++)this.subsystems[p].update();i.length=0,n.length=0,this.broadphase.collisionPairs(this,i,n);var y=u.length;for(p=0;p!==y;p++)if(!(S=u[p]).collideConnected)for(var g=i.length-1;0<=g;g-=1)(S.bodyA===i[g]&&S.bodyB===n[g]||S.bodyB===i[g]&&S.bodyA===n[g])&&(i.splice(g,1),n.splice(g,1));t.length=0;var b=this.frictionEquations.length;for(p=0;p!==b;p++)c.push(this.frictionEquations[p]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,n,this,t,null,this.frictionEquations,c),p=0;p<this.frictionEquations.length;p++)s.addEquation(this.frictionEquations[p]);var x=t.length;for(p=0;p!==x;p++)s.addEquation(t[p]);for(y=u.length,p=0;p!==y;p++){var S;(S=u[p]).update(),g=0;for(var w=S.equations.length;g!==w;g++){var T=S.equations[g];s.addEquation(T)}}s.solve(e,this),s.removeAllEquations();var E=Math.pow;for(r=this.numObjects(),p=0;p!==r;p++){var C;if((C=a[p]).type&l){var A=E(1-C.linearDamping,e),k=C.velocity;k.mult(A,k);var R=C.angularVelocity;if(R){var O=E(1-C.angularDamping,e);R.mult(O,R)}}}var M=this.stepnumber%(this.quatNormalizeSkip+1)==0,I=this.quatNormalizeFast;for(p=0;p!==r;p++)a[p].integrate(e,M,I);if(this.clearForces(),this.broadphase.dirty=!0,this.time+=e,this.stepnumber+=1,this.allowSleep)for(p=0;p!==r;p++)a[p].sleepTick(this.time)};var m=[],y=[],g={type:"triggered",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null};f.prototype.emitTriggeredEvents=function(){m.length=y.length=0,this.shapeOverlapKeeperExit.getDiff(m,y);for(var e=0,t=y.length;e<t;e+=2){g.event="onTriggerExit";var i=this.getShapeById(y[e]),n=this.getShapeById(y[e+1]);this.triggerMatrix.set(i,n,!1),g.selfShape=i,g.otherShape=n,g.selfBody=i.body,g.otherBody=n.body,i.dispatchEvent(g),g.selfShape=n,g.otherShape=i,g.selfBody=n.body,g.otherBody=i.body,n.dispatchEvent(g)}for(m.length=y.length=0,this.shapeOverlapKeeper.getDiff(m,y),e=0,t=m.length;e<t;e+=2){var r=m[e],a=m[e+1];i=this.getShapeById(r),n=this.getShapeById(a),this.triggerMatrix.get(i,n)?g.event="onTriggerStay":(this.triggerMatrix.set(i,n,!0),g.event="onTriggerEnter"),g.selfShape=i,g.otherShape=n,g.selfBody=i.body,g.otherBody=n.body,i.dispatchEvent(g),g.selfShape=n,g.otherShape=i,g.selfBody=n.body,g.otherBody=i.body,n.dispatchEvent(g)}this.shapeOverlapKeeper.reset(),this.shapeOverlapKeeperExit.tick()},f.prototype.emitCollisionEvents=function(){for(var e,t,i=this.contactsDic.getLength();i--;)if(e=this.contactsDic.getKeyByIndex(i),null!=(t=this.contactsDic.getDataByKey(e))){var n=t[0].bi,r=t[0].bj,a=t[0].si,s=t[0].sj;if(n.allowSleep&&n.type===L.DYNAMIC&&n.sleepState===L.SLEEPING&&r.sleepState===L.AWAKE&&r.type!==L.STATIC){var o=r.velocity.norm2()+r.angularVelocity.norm2();2*Math.pow(r.sleepSpeedLimit,2)<=o&&n.wakeUp()}if(r.allowSleep&&r.type===L.DYNAMIC&&r.sleepState===L.SLEEPING&&n.sleepState===L.AWAKE&&n.type!==L.STATIC){var l=n.velocity.norm2()+n.angularVelocity.norm2();2*Math.pow(n.sleepSpeedLimit,2)<=l&&r.wakeUp()}this.collisionMatrix.get(n,r)?_.event="onCollisionStay":(this.collisionMatrix.set(n,r,!0),_.event="onCollisionEnter"),_.contacts=t,_.body=s.body,_.selfShape=a,_.otherShape=s,a.body.dispatchEvent(_),_.body=a.body,_.selfShape=s,_.otherShape=a,s.body.dispatchEvent(_)}var u=v;for(i=u.length;i--;){var c=u[i];a=c.si,s=c.sj,null==this.oldContactsDic.get(a.id,s.id)&&this.oldContactsDic.set(a.id,s.id,c)}for(i=this.oldContactsDic.getLength();i--;)e=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(e)&&(n=(t=this.oldContactsDic.getDataByKey(e)).bi,r=t.bj,a=t.si,s=t.sj,this.collisionMatrix.get(n,r)&&(n.isSleeping()&&r.isSleeping()||(this.collisionMatrix.set(n,r,!1),_.event="onCollisionExit",_.body=s.body,_.selfShape=a,_.otherShape=s,_.contacts.length=0,_.contacts.push(t),a.body.dispatchEvent(_),_.body=a.body,_.selfShape=s,_.otherShape=a,s.body.dispatchEvent(_))));this.contactsDic.reset(),this.oldContactsDic.reset()},f.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force.set(0,0,0),n.torque.set(0,0,0)}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)});U0.CANNON;function V0(e){return Fi.strictEquals(e,new Fi)?"<origin>":"(x: ".concat(e.x,", y: ").concat(e.y,", z: ").concat(e.z,")")}function G0(e,t){e.__cc_wrapper__=t}function H0(e){return e.__cc_wrapper__}(D0=P0=P0||{})[D0.DYNAMIC=1]="DYNAMIC",D0[D0.STATIC=2]="STATIC",D0[D0.KINEMATIC=4]="KINEMATIC",(N0=F0=F0||{})[N0.SCENE=0]="SCENE",N0[N0.PHYSIC=1]="PHYSIC";var W0=function(){function t(e){y(this,t),this._body=void 0,this._onCollidedListener=void 0,this._collisionCallbacks=[],this._shapes=[],this._userData=void 0,this._world=null,this._name=void 0,e=e||{},this._name=e.name||"",this._body=new U0.Body({type:P0.DYNAMIC}),G0(this._body,this),this._body.sleepSpeedLimit=.1,this._body.sleepTimeLimit=1,this._onCollidedListener=this._onCollided.bind(this)}return v(t,[{key:"impl",get:function(){return this._body}}]),v(t,[{key:"getAllowSleep",value:function(){return this._body.allowSleep}},{key:"setAllowSleep",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.allowSleep=e}},{key:"getGroup",value:function(){return this._body.collisionFilterGroup}},{key:"setGroup",value:function(e){this._body.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this._body.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this._body.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this._body.collisionFilterMask}},{key:"setMask",value:function(e){this._body.collisionFilterMask=e}},{key:"addMask",value:function(e){this._body.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this._body.collisionFilterMask&=~e}},{key:"wakeUp",value:function(){return this._body.wakeUp()}},{key:"sleep",value:function(){return this._body.sleep()}},{key:"name",value:function(){return this._name}},{key:"getType",value:function(){return this._body.type}},{key:"setType",value:function(e){this._body.type=e}},{key:"isAwake",value:function(){return this._body.isAwake()}},{key:"isSleepy",value:function(){return this._body.isSleepy()}},{key:"isSleeping",value:function(){return this._body.isSleeping()}},{key:"addShape",value:function(e,t){this._shapes.push(e),null!=t?this._body.addShape(e.impl,Fi.copy(X0,t)):this._body.addShape(e.impl),e.setBody(this._body,this._shapes.length-1)}},{key:"removeShape",value:function(e){var t=this._shapes.indexOf(e);0<=t&&(this._shapes.splice(t,1),this._body.removeShape(e.impl),e.setBody(null,-1))}},{key:"getMass",value:function(){return this._body.mass}},{key:"setMass",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.mass=e,this._body.updateMassProperties()}},{key:"getIsKinematic",value:function(){return this._body.type===U0.Body.KINEMATIC}},{key:"setIsKinematic",value:function(e){this._body.type=e?U0.Body.KINEMATIC:U0.Body.DYNAMIC}},{key:"getLinearDamping",value:function(){return this._body.linearDamping}},{key:"setLinearDamping",value:function(e){this._body.linearDamping=e}},{key:"getAngularDamping",value:function(){return this._body.angularDamping}},{key:"setAngularDamping",value:function(e){this._body.angularDamping=e}},{key:"getUseGravity",value:function(){return this._body.useGravity}},{key:"setUseGravity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.useGravity=e}},{key:"getCollisionResponse",value:function(){return this._body.collisionResponse}},{key:"setCollisionResponse",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.collisionResponse=!e}},{key:"getLinearVelocity",value:function(e){return Fi.copy(e,this._body.velocity),e}},{key:"setLinearVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.velocity,e)}},{key:"getAngularVelocity",value:function(e){return Fi.copy(e,this._body.angularVelocity),e}},{key:"setAngularVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.angularVelocity,e)}},{key:"getLinearFactor",value:function(e){return Fi.copy(e,this._body.linearFactor),e}},{key:"setLinearFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.linearFactor,e)}},{key:"getAngularFactor",value:function(e){return Fi.copy(e,this._body.angularFactor),e}},{key:"setAngularFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(this._body.angularFactor,e)}},{key:"getFreezeRotation",value:function(){return this._body.fixedRotation}},{key:"setFreezeRotation",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.fixedRotation=e,this._body.updateMassProperties()}},{key:"applyForce",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyForce(Fi.copy(X0,e),Fi.copy(Y0,t))}},{key:"applyImpulse",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyImpulse(Fi.copy(X0,e),Fi.copy(Y0,t))}},{key:"applyLocalForce",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalForce(Fi.copy(X0,e),Fi.copy(Y0,t))}},{key:"applyLocalImpulse",value:function(e,t){null==t&&(t=Fi.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalImpulse(Fi.copy(X0,e),Fi.copy(Y0,t))}},{key:"applyTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.torque.x+=e.x,this._body.torque.y+=e.y,this._body.torque.z+=e.z}},{key:"applyLocalTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Fi.copy(X0,e),this._body.vectorToWorldFrame(X0,X0),this._body.torque.x+=X0.x,this._body.torque.y+=X0.y,this._body.torque.z+=X0.z}},{key:"setWorld",value:function(e){this._world&&(this._body.removeEventListener("collide",this._onCollidedListener),this._body.world.remove(this._body),this._world=null);var t=e;t&&(t.impl.addBody(this._body),this._body.addEventListener("collide",this._onCollidedListener),null==this._body.material&&(this._body.material=t.impl.defaultMaterial)),this._world=t}},{key:"getPosition",value:function(e){Fi.copy(e,this._body.position)}},{key:"setPosition",value:function(e){Fi.copy(this._body.position,e)}},{key:"getRotation",value:function(e){hn.copy(e,this._body.quaternion)}},{key:"setRotation",value:function(e){hn.copy(this._body.quaternion,e)}},{key:"translateAndRotate",value:function(e,t){zn.getTranslation(this._body.position,e),hn.copy(this._body.quaternion,t)}},{key:"scaleAllShapes",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setScale(e)}}},{key:"addCollisionCallback",value:function(e){this._collisionCallbacks.push(e)}},{key:"removeCollisionCllback",value:function(e){var t=this._collisionCallbacks.indexOf(e);0<=t&&this._collisionCallbacks.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"_stringfyThis",value:function(){return"".concat(this._name.length?this._name:"<No-name>")}},{key:"_devStrinfy",value:function(){var e=this._body.shapes.map(function(e){return H0(e)._devStrinfy()}).join("; ");return"Name: [[".concat(this._name.length?this._name:"<No-name>","]], position: ").concat(V0(this._body.position),", shapes: [").concat(e,"]")}},{key:"_onCollided",value:function(e){q0.type=e.event,q0.selfCollider=H0(e.selfShape).getUserData(),q0.otherCollider=H0(e.otherShape).getUserData();var t=0;for(t=q0.contacts.length;t--;)j0.push(q0.contacts.pop());for(t=0;t<e.contacts.length;t++){var i=e.contacts[t];if(0<j0.length){var n=j0.pop();Fi.copy(n.contactA,i.ri),Fi.copy(n.contactB,i.rj),Fi.copy(n.normal,i.ni),q0.contacts.push(n)}else{var r={contactA:Fi.copy(new Fi,i.ri),contactB:Fi.copy(new Fi,i.rj),normal:Fi.copy(new Fi,i.ni)};q0.contacts.push(r)}}for(t=0;t<this._collisionCallbacks.length;t++){(0,this._collisionCallbacks[t])(q0)}}}]),t}(),q0={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[]},j0=[],X0=new U0.Vec3,Y0=new U0.Vec3;function K0(e,t){e.checkCollisionResponse=!t.queryTrigger,e.skipBackFaces=!1}function Q0(e,t){e._assign(Fi.copy(new Fi,t.hitPointWorld),t.distance,H0(t.shape))}function Z0(e){e.updateMassProperties(),e.updateBoundingRadius(),e.aabbNeedsUpdate=!0}var J0=function(){function t(){y(this,t),this._scale=new Fi(1,1,1),this._shape=null,this._body=null,this._index=-1,this._center=new Fi(0,0,0),this._userData=void 0,this._onTriggerListener=void 0,this._triggeredCB=[],this._onTriggerListener=this.onTrigger.bind(this)}return v(t,[{key:"impl",get:function(){return this._shape}},{key:"material",set:function(e){null==e?this._shape.material=null:(null==t.idToMaterial[e._uuid]&&(t.idToMaterial[e._uuid]=new U0.Material(e._uuid)),this._shape.material=t.idToMaterial[e._uuid],this._shape.material.friction=e.friction,this._shape.material.restitution=e.restitution)}}]),v(t,[{key:"addTriggerCallback",value:function(e){this._triggeredCB.push(e)}},{key:"removeTriggerCallback",value:function(e){var t=this._triggeredCB.indexOf(e);0<=t&&this._triggeredCB.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"setBody",value:function(e,t){null==e?this._shape.removeEventListener("triggered",this._onTriggerListener):this._shape.addEventListener("triggered",this._onTriggerListener),this._body=e,this._index=t}},{key:"setCenter",value:function(e){Fi.copy(this._center,e),this._recalcCenter()}},{key:"setScale",value:function(e){Fi.copy(this._scale,e),this._recalcCenter()}},{key:"setRotation",value:function(e){}},{key:"getCollisionResponse",value:function(){return this.impl.collisionResponse}},{key:"setCollisionResponse",value:function(e){this.impl.collisionResponse=e}},{key:"_devStrinfy",value:function(){return this._body?"centerOffset: ".concat(V0(this._body.shapeOffsets[this._index])):"<NotAttached>"}},{key:"onTrigger",value:function(e){$0.type=e.event,$0.selfCollider=H0(e.selfShape).getUserData(),$0.otherCollider=H0(e.otherShape).getUserData();var t=this._triggeredCB,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r($0)}}},{key:"_recalcCenter",value:function(){if(this._body){var e=this._body.shapeOffsets[this._index];Fi.copy(e,this._center),Fi.multiply(e,e,this._scale),Z0(this._body)}}}]),t}();J0.idToMaterial={};var $0={type:"",selfCollider:null,otherCollider:null},e1=function(){function e(){y(this,e),this._world=void 0,this._customBeforeStepListener=[],this._customAfterStepListener=[],this._raycastResult=new U0.RaycastResult,this._world=new U0.World,G0(this._world,this),this._world.broadphase=new U0.NaiveBroadphase}return v(e,[{key:"impl",get:function(){return this._world}}]),v(e,[{key:"getAllowSleep",value:function(){return this._world.allowSleep}},{key:"setAllowSleep",value:function(e){this._world.allowSleep=e}},{key:"setGravity",value:function(e){Fi.copy(this._world.gravity,e)}},{key:"getGravity",value:function(e){Fi.copy(e,this._world.gravity)}},{key:"destroy",value:function(){}},{key:"step",value:function(e,t,i){this._callCustomBeforeSteps(),this._world.step(e,t,i),this._callCustomAfterSteps(),this._world.emitTriggeredEvents(),this._world.emitCollisionEvents(),this._callCustomBeforeSteps()}},{key:"addBeforeStep",value:function(e){this._customBeforeStepListener.push(e)}},{key:"removeBeforeStep",value:function(e){var t=this._customBeforeStepListener.indexOf(e);t<0||this._customBeforeStepListener.splice(t,1)}},{key:"addAfterStep",value:function(e){this._customAfterStepListener.push(e)}},{key:"removeAfterStep",value:function(e){var t=this._customAfterStepListener.indexOf(e);t<0||this._customAfterStepListener.splice(t,1)}},{key:"raycastClosest",value:function(e,t,i){n1(e,t.maxDistance),K0(c1,t);var n=this._world.raycastClosest(t1,i1,c1,this._raycastResult);return n&&Q0(i,this._raycastResult),n}},{key:"raycast",value:function(e,t,i,n){return n1(e,t.maxDistance),K0(c1,t),this._world.raycastAll(t1,i1,c1,function(e){var t=i.add();Q0(t,e),n.push(t)})}},{key:"addConstraint",value:function(e){this._world.addConstraint(e.impl)}},{key:"removeConstraint",value:function(e){this._world.removeConstraint(e.impl)}},{key:"_callCustomBeforeSteps",value:function(){this._customBeforeStepListener.forEach(function(e){return e()})}},{key:"_callCustomAfterSteps",value:function(){this._customAfterStepListener.forEach(function(e){return e()})}},{key:"defaultMaterial",set:function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=J0.idToMaterial[e._uuid]&&(J0.idToMaterial[e._uuid]=this._world.defaultMaterial)}}]),e}(),t1=new U0.Vec3,i1=new U0.Vec3;function n1(e,t){Fi.copy(t1,e.o),e.computeHit(i1,t)}var r1,a1,s1,o1,l1,u1,c1={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackFaces:!1};y0=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this)))._box=void 0,t._halfExtent=new U0.Vec3,Fi.multiplyScalar(t._halfExtent,e,.5),t._box=new U0.Box(t._halfExtent.clone()),G0(t._box,l(t)),t._shape=t._box,t._shape.addEventListener("trigger",t.onTrigger),t}return p(i,J0),v(i,[{key:"setScale",value:function(e){_(g(i.prototype),"setScale",this).call(this,e),this._recalcExtents()}},{key:"setSize",value:function(e){Fi.multiplyScalar(this._halfExtent,e,.5),this._recalcExtents()}},{key:"_stringfyThis",value:function(){return"".concat(this._body?H0(this._body)._stringfyThis():"<No-body>","(Box)")}},{key:"_devStrinfy",value:function(){return"Box(".concat(_(g(i.prototype),"_devStrinfy",this).call(this),", halfExtents: ").concat(V0(this._box.halfExtents),")")}},{key:"_recalcExtents",value:function(){Fi.multiply(this._box.halfExtents,this._halfExtent,this._scale),this._box.updateConvexPolyhedronRepresentation(),null!=this._body&&Z0(this._body)}}]),i}(),g0=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this)))._sphere=void 0,t._radius=0,t._radius=e,t._sphere=new U0.Sphere(t._radius),G0(t._sphere,l(t)),t._shape=t._sphere,t}return p(i,J0),v(i,[{key:"setScale",value:function(e){_(g(i.prototype),"setScale",this).call(this,e),this._recalcRadius()}},{key:"setRadius",value:function(e){this._radius=e,this._recalcRadius()}},{key:"_devStrinfy",value:function(){return"Sphere(".concat(_(g(i.prototype),"_devStrinfy",this).call(this),", radius: ").concat(this._sphere.radius,")")}},{key:"_recalcRadius",value:function(){this._sphere.radius=this._radius*function(e){return Math.max(e.x,Math.max(e.y,e.z))}(this._scale),null!=this._body&&Z0(this._body)}}]),i}(),b0=W0,x0=e1;var h1=q3("PhysicMaterial",oo("cc.PhysicMaterial")((u1=l1=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_friction",s1,l(e)),m(e,"_restitution",o1,l(e)),t.allMaterials.push(l(e)),""==e._uuid&&(e._uuid="pm_"+t._idCounter++),e}return p(t,rd),v(t,[{key:"friction",get:function(){return this._friction},set:function(e){di(this._friction,e)||(this._friction=e,this.emit("physics_material_update"))}},{key:"restitution",get:function(){return this._restitution},set:function(e){di(this._restitution,e)||(this._restitution=e,this.emit("physics_material_update"))}}]),v(t,[{key:"clone",value:function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e}},{key:"destroy",value:function(){if(_(g(t.prototype),"destroy",this).call(this)){var e=t.allMaterials.indexOf(this);return 0<=e&&t.allMaterials.splice(e,1),!0}return!1}}]),t}(),l1.allMaterials=[],l1._idCounter=0,s1=b((a1=u1).prototype,"_friction",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),o1=b(a1.prototype,"_restitution",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),b(a1.prototype,"friction",[lo],Object.getOwnPropertyDescriptor(a1.prototype,"friction"),a1.prototype),b(a1.prototype,"restitution",[lo],Object.getOwnPropertyDescriptor(a1.prototype,"restitution"),a1.prototype),r1=a1))||r1),d1=q3("PhysicsRayResult",function(){function t(){y(this,t),this._hitPoint=new Fi,this._distance=0,this._collidier=null}return v(t,[{key:"_assign",value:function(e,t,i){Fi.copy(this._hitPoint,e),this._distance=t,this._collidier=i.getUserData()}},{key:"clone",value:function(){var e=new t;return Fi.copy(e._hitPoint,this._hitPoint),e._distance=this._distance,e._collidier=this._collidier,e}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collidier}}]),t}());cc.createRaycastResult=function(){return new d1};var f1=q3("PhysicsSystem",function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._world=void 0,e._enable=!0,e._deltaTime=1/60,e._maxSubStep=2,e._allowSleep=!0,e._gravity=new Fi(0,-10,0),e._material=null,e.raycastClosestResult=new d1,e.raycastResults=[],e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},e.raycastResultPool=new Es(function(){return new d1},1),e._world=new x0,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e._material=new h1,e._material.friction=.6,e._material.restitution=-1,e._material.on("physics_material_update",e._updateMaterial,l(e)),e._world.defaultMaterial=e._material,e}return p(t,lx),v(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._world.setAllowSleep(this._allowSleep)}},{key:"maxSubStep",get:function(){return this._maxSubStep},set:function(e){this._maxSubStep=e}},{key:"deltaTime",get:function(){return this._deltaTime},set:function(e){this._deltaTime=e}},{key:"gravity",get:function(){return this._world.getGravity(this._gravity),this._gravity},set:function(e){this._gravity.x=e.x,this._gravity.y=e.y,this._gravity.z=e.z,this._world.setGravity(e)}},{key:"defaultMaterial",get:function(){return this._material}}]),v(t,[{key:"postUpdate",value:function(e){this._enable&&(qE.emit(lE.EVENT_BEFORE_PHYSICS),this._world.step(this._deltaTime,e,this._maxSubStep),qE.emit(lE.EVENT_AFTER_PHYSICS))}},{key:"raycast",value:function(e,t,i,n){var r=1<arguments.length&&void 0!==t?t:ah.Enum.DEFAULT,a=2<arguments.length&&void 0!==i?i:1e7,s=!(3<arguments.length&&void 0!==n)||n;return this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=r,this.raycastOptions.maxDistance=a,this.raycastOptions.queryTrigger=s,this._world.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults)}},{key:"raycastClosest",value:function(e,t,i,n){var r=1<arguments.length&&void 0!==t?t:ah.Enum.DEFAULT,a=2<arguments.length&&void 0!==i?i:1e7,s=!(3<arguments.length&&void 0!==n)||n;return this.raycastOptions.mask=r,this.raycastOptions.maxDistance=a,this.raycastOptions.queryTrigger=s,this._world.raycastClosest(e,this.raycastOptions,this.raycastClosestResult)}},{key:"_updateMaterial",value:function(){this._world.defaultMaterial=this._material}}]),t}());f1.instance=void 0,f1.ID=void 0,cc.PhysicsSystem=f1,qE.on(lE.EVENT_INIT,function(){var e=new cc.PhysicsSystem;cc.PhysicsSystem.instance=e,qE.registerSystem(f1.ID,e,0)});var p1,_1,v1,m1,y1,g1,b1,x1,S1,w1,T1=function(){function o(){var e;return y(this,o),(e=x(this,g(o).call(this)))._sharedBody=void 0,e._isPreLoaded=!1,e}return p(o,rp),v(o,[{key:"_body",get:function(){return this._sharedBody.body}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_assertPreload",get:function(){return this._isPreLoaded||A("Physic Error: Please make sure that the node has been added to the scene"),this._isPreLoaded}}]),v(o,[{key:"setGroup",value:function(e){if(this._assertPreload)return this._body.setGroup(e)}},{key:"getGroup",value:function(){return this._assertPreload?this._body.getGroup():0}},{key:"addGroup",value:function(e){if(this._assertPreload)return this._body.addGroup(e)}},{key:"removeGroup",value:function(e){if(this._assertPreload)return this._body.removeGroup(e)}},{key:"getMask",value:function(){return this._assertPreload?this._body.getMask():0}},{key:"setMask",value:function(e){if(this._assertPreload)return this._body.setMask(e)}},{key:"addMask",value:function(e){if(this._assertPreload)return this._body.addMask(e)}},{key:"removeMask",value:function(e){if(this._assertPreload)return this._body.removeMask(e)}},{key:"__preload",value:function(){if(null==this._sharedBody){var e=null,t=this.node.getComponents(o),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a._sharedBody){e=a._sharedBody;break}}if(!e){var s=this.getComponent(cc.RigidBodyComponent);e=new E1(this.node,s,f1.instance._world)}e.ref(),this._sharedBody=e}this._isPreLoaded=!0}},{key:"onEnable",value:function(){this.sharedBody.enable()}},{key:"onDisable",value:function(){this.sharedBody.disable()}},{key:"onDestroy",value:function(){this._sharedBody.deref(),this._sharedBody=null}},{key:"_findRigidbody",value:function(e){var t=e.getComponent(cc.RigidBodyComponent);return t||(e.parent?e.parent===e.scene?null:this._findRigidbody(e.parent):null)}}]),o}(),E1=function(){function n(e,t,i){y(this,n),this._body=void 0,this._refCount=0,this._actived=!1,this._world=void 0,this._rigidBody=void 0,this._node=void 0,this._worldScale=new Fi(1,1,1),this._beforeStepCallback=void 0,this._afterStepCallback=void 0,this._isShapeOnly=!0,this._body=function(e){return new b0(e)}({name:e.name}),this._node=e,this._rigidBody=t,this._world=i,this._body.setUserData(this._rigidBody),this._beforeStepCallback=this._beforeStep.bind(this),this._afterStepCallback=this._afterStep.bind(this),this._rigidBody?this._isShapeOnly=!1:(this._isShapeOnly=!0,this._body.setUseGravity(!1))}return v(n,[{key:"body",get:function(){return this._body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isShapeOnly",get:function(){return this._isShapeOnly},set:function(e){this._isShapeOnly=e}}]),v(n,[{key:"ref",value:function(){++this._refCount}},{key:"deref",value:function(){--this._refCount,this._refCount||this.destroy()}},{key:"enable",value:function(){this._activeBody()}},{key:"disable",value:function(){this._deactiveBody()}},{key:"destroy",value:function(){this._deactiveBody(),this._body.setUserData(null),this._body=null,this._beforeStepCallback=null,this._afterStepCallback=null,this._world=null,this._node=null,this._rigidBody&&(this._rigidBody=null)}},{key:"syncPhysWithScene",value:function(){this._syncPhysWithScene(this._node)}},{key:"_syncPhysWithScene",value:function(e){e.getWorldMatrix(n._tempMat4),e.getWorldRotation(n._tempQuat),this._body.translateAndRotate(n._tempMat4,n._tempQuat)}},{key:"_syncSceneWithPhys",value:function(){this._node&&(this._body.getPosition(n._tempVec3),this._node.setWorldPosition(n._tempVec3),this._body.getFreezeRotation()||(this._body.getRotation(n._tempQuat),this._node.setWorldRotation(n._tempQuat)))}},{key:"_activeBody",value:function(){this._syncPhysWithScene(this._node),this._actived||(this._actived=!0,this._body.setWorld(this._world),this._world.addBeforeStep(this._beforeStepCallback),this._world.addAfterStep(this._afterStepCallback),this._body.wakeUp())}},{key:"_deactiveBody",value:function(){this._actived&&(this._actived=!1,this._world.removeBeforeStep(this._beforeStepCallback),this._world.removeAfterStep(this._afterStepCallback),this._body.sleep(),this._body.setWorld(null))}},{key:"_beforeStep",value:function(){this._node.hasChangedFlags&&(this._node.hasChangedFlags&Fp.SCALE&&this._body.scaleAllShapes(this._node.worldScale),this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}},{key:"_afterStep",value:function(){this._body.getType()!==P0.STATIC?this._syncSceneWithPhys():this._node.hasChangedFlags&&(this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}}]),n}();E1._tempMat4=new zn,E1._tempQuat=new hn,E1._tempVec3=new Fi;var C1=q3("ColliderComponent",(p1=oo("cc.ColliderComponent"),_1=lo({type:h1,displayName:"Material",displayOrder:-1}),v1=lo({displayOrder:0}),m1=lo({type:Fi,displayOrder:1,tooltip:"The center of the collider, in local space"}),y1=lo({type:h1}),p1((b((b1=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._callbackTable=ke(!0),e._shapeBase=void 0,e._isSharedMaterial=!0,e._trrigerCallback=void 0,e._collisionCallBack=void 0,m(e,"_material",x1,l(e)),m(e,"_isTrigger",S1,l(e)),m(e,"_center",w1,l(e)),e._trrigerCallback=e._onTrigger.bind(l(e)),e._collisionCallBack=e._onCollision.bind(l(e)),e}return p(t,T1),v(t,[{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=this._material.clone(),this._material.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){null!=e&&null!=this._material?this._material._uuid!=e._uuid&&(this._material.off("physics_material_update",this._updateMaterial,this),e.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):null!=e&&null==this._material?(e.on("physics_material_update",this._updateMaterial,this),this._material=e):null==e&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=e),this._updateMaterial()}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){if(this._isTrigger=e,this.sharedBody){var t=this._isTrigger?P0.DYNAMIC:P0.STATIC;this.sharedBody.body.setType(t),this._shapeBase.setCollisionResponse(!this._isTrigger)}}},{key:"center",get:function(){return this._center},set:function(e){Fi.copy(this._center,e);var t=this.sharedBody.rigidBody;null!=t?(Fi.subtract(y2,this.node.worldPosition,t.node.worldPosition),Fi.add(y2,y2,this._center),this._shapeBase.setCenter(y2)):this._shapeBase.setCenter(this._center)}},{key:"attachedRigidbody",get:function(){return this.sharedBody.rigidBody}}]),v(t,[{key:"on",value:function(e,t,i,n){}},{key:"off",value:function(e,t,i,n){}},{key:"once",value:function(e,t,i,n){}},{key:"targetOff",value:function(e){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"onLoad",value:function(){this.isTrigger=this._isTrigger,this.sharedMaterial=null==this._material?f1.instance.defaultMaterial:this._material,this.center=this._center}},{key:"onEnable",value:function(){_(g(t.prototype),"onEnable",this).call(this);var e=this.sharedBody.rigidBody;null!=e?(Fi.subtract(y2,this.node.worldPosition,e.node.worldPosition),Fi.add(y2,y2,this._center),this.sharedBody.body.addShape(this._shapeBase,y2)):this.sharedBody.body.addShape(this._shapeBase,this._center),this.center=this._center,this._shapeBase.addTriggerCallback(this._trrigerCallback),this.sharedBody.body.addCollisionCallback(this._collisionCallBack),this.sharedBody.syncPhysWithScene()}},{key:"onDisable",value:function(){this._shapeBase.removeTriggerCallback(this._trrigerCallback),this.sharedBody.body.removeCollisionCllback(this._collisionCallBack),this.sharedBody.body.removeShape(this._shapeBase),this.sharedBody.isShapeOnly&&_(g(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this.sharedBody.body.removeShape(this._shapeBase),null!=this._material&&this._material._uuid!=f1.instance.defaultMaterial._uuid&&(this._material.destroy(),this._material=null),_(g(t.prototype),"onDestroy",this).call(this)}},{key:"_updateMaterial",value:function(){this._shapeBase.material=this._material}},{key:"_onTrigger",value:function(e){this.emit(e.type,e)}},{key:"_onCollision",value:function(e){this.emit(e.type,e)}}]),t}()).prototype,"sharedMaterial",[_1],Object.getOwnPropertyDescriptor(b1.prototype,"sharedMaterial"),b1.prototype),b(b1.prototype,"isTrigger",[v1],Object.getOwnPropertyDescriptor(b1.prototype,"isTrigger"),b1.prototype),b(b1.prototype,"center",[m1],Object.getOwnPropertyDescriptor(b1.prototype,"center"),b1.prototype),x1=b(b1.prototype,"_material",[y1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S1=b(b1.prototype,"_isTrigger",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w1=b(b1.prototype,"_center",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cc.Vec3(0,0,0)}}),g1=b1))||g1));Gh(C1,[Rl,Ml]);var A1,k1,R1,O1,M1,I1,L1,z1,B1,P1,D1,F1,N1,U1,V1,G1,H1,W1,q1,j1,X1,Y1,K1,Q1,Z1,J1,$1,e2,t2,i2,n2,r2,a2,s2,o2,l2,u2,c2,h2,d2,f2,p2,_2,v2,m2,y2=new Fi,g2=q3("BoxColliderComponent",(A1=oo("cc.BoxColliderComponent"),k1=_o(98),R1=po("Components/BoxCollider"),O1=lo({type:Fi}),A1(M1=k1(M1=R1(M1=ho((L1=b((I1=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._shape=void 0,m(e,"_size",L1,l(e)),e._shape=function(e){return new y0(e)}(e._size),e._shape.setUserData(l(e)),e._shapeBase=e._shape,e}return p(t,C1),v(t,[{key:"onLoad",value:function(){_(g(t.prototype),"onLoad",this).call(this),this.size=this._size,this._shape.setScale(this.node.worldScale)}},{key:"size",get:function(){return this._size},set:function(e){Fi.copy(this._size,e),this._shape.setSize(this._size)}}]),t}()).prototype,"_size",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(0,0,0)}}),b(I1.prototype,"size",[O1],Object.getOwnPropertyDescriptor(I1.prototype,"size"),I1.prototype),M1=I1))||M1)||M1)||M1)||M1)),b2=q3("SphereColliderComponent",oo("cc.SphereColliderComponent")(z1=_o(98)(z1=po("Components/SphereCollider")(z1=ho((P1=b((B1=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._shape=void 0,m(e,"_radius",P1,l(e)),e._shape=function(e){return new g0(e)}(e._radius),e._shape.setUserData(l(e)),e._shapeBase=e._shape,e}return p(t,C1),v(t,[{key:"onLoad",value:function(){_(g(t.prototype),"onLoad",this).call(this),this.radius=this._radius,this._shape.setScale(this.node.worldScale)}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shape.setRadius(this._radius)}}]),t}()).prototype,"_radius",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b(B1.prototype,"radius",[lo],Object.getOwnPropertyDescriptor(B1.prototype,"radius"),B1.prototype),z1=B1))||z1)||z1)||z1)||z1),x2=10,S2=0,w2=0,T2=q3("RigidBodyComponent",(D1=oo("cc.RigidBodyComponent"),F1=_o(99),N1=po("Components/RigidBody"),U1=lo({displayOrder:0}),V1=lo({displayOrder:1}),G1=lo({displayOrder:2}),H1=lo({displayOrder:3}),W1=lo({displayOrder:4}),q1=lo({displayOrder:5}),j1=lo({displayOrder:6}),X1=lo({displayOrder:7}),D1(Y1=F1(Y1=N1(Y1=ho(Y1=vo((b((K1=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._allowSleep=!0,m(e,"_mass",Q1,l(e)),m(e,"_linearDamping",Z1,l(e)),m(e,"_angularDamping",J1,l(e)),m(e,"_fixedRotation",$1,l(e)),m(e,"_isKinematic",e2,l(e)),m(e,"_useGravity",t2,l(e)),m(e,"_linearFactor",i2,l(e)),m(e,"_angularFactor",n2,l(e)),e}return p(t,T1),v(t,[{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.sharedBody.body.setAllowSleep(e)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._body.setMass(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body.setAngularDamping(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._body.setIsKinematic(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body.setUseGravity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body.setFreezeRotation(e)}},{key:"linearFactor",get:function(){return this._body.getLinearFactor(this._linearFactor)},set:function(e){Fi.copy(this._linearFactor,e),this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._body.getAngularFactor(this._angularFactor)},set:function(e){Fi.copy(this._angularFactor,e),this._body.setAngularFactor(this._angularFactor)}},{key:"isAwake",get:function(){return!!this._assertPreload&&this._body.isAwake()}},{key:"isSleepy",get:function(){return!!this._assertPreload&&this._body.isSleepy()}},{key:"isSleeping",get:function(){return!!this._assertPreload&&this._body.isSleeping()}}]),v(t,[{key:"applyForce",value:function(e,t){this._assertPreload&&this._body.applyForce(e,t)}},{key:"applyLocalForce",value:function(e,t){this._assertPreload&&this._body.applyLocalForce(e,t)}},{key:"applyImpulse",value:function(e,t){this._assertPreload&&this._body.applyImpulse(e,t)}},{key:"applyLocalImpulse",value:function(e,t){this._assertPreload&&this._body.applyLocalImpulse(e,t)}},{key:"applyTorque",value:function(e){this._assertPreload&&this._body.applyTorque(e)}},{key:"applyLocalTorque",value:function(e){this._assertPreload&&this._body.applyLocalTorque(e)}},{key:"wakeUp",value:function(){this._assertPreload&&this._body.wakeUp()}},{key:"sleep",value:function(){this._assertPreload&&this._body.sleep()}},{key:"getLinearVelocity",value:function(e){this._assertPreload&&this._body.getLinearVelocity(e)}},{key:"setLinearVelocity",value:function(e){this._assertPreload&&this._body.setLinearVelocity(e)}},{key:"getAngularVelocity",value:function(e){this._assertPreload&&this._body.getAngularVelocity(e)}},{key:"setAngularVelocity",value:function(e){this._assertPreload&&this._body.setAngularVelocity(e)}},{key:"onEnable",value:function(){_(g(t.prototype),"onEnable",this).call(this),this.sharedBody&&(this.allowSleep=this._allowSleep,this.mass=this._mass,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.useGravity=this._useGravity,this.isKinematic=this._isKinematic,this.fixedRotation=this._fixedRotation,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.sharedBody.isShapeOnly=!1)}}]),t}()).prototype,"mass",[U1],Object.getOwnPropertyDescriptor(K1.prototype,"mass"),K1.prototype),b(K1.prototype,"linearDamping",[V1],Object.getOwnPropertyDescriptor(K1.prototype,"linearDamping"),K1.prototype),b(K1.prototype,"angularDamping",[G1],Object.getOwnPropertyDescriptor(K1.prototype,"angularDamping"),K1.prototype),b(K1.prototype,"isKinematic",[H1],Object.getOwnPropertyDescriptor(K1.prototype,"isKinematic"),K1.prototype),b(K1.prototype,"useGravity",[W1],Object.getOwnPropertyDescriptor(K1.prototype,"useGravity"),K1.prototype),b(K1.prototype,"fixedRotation",[q1],Object.getOwnPropertyDescriptor(K1.prototype,"fixedRotation"),K1.prototype),b(K1.prototype,"linearFactor",[j1],Object.getOwnPropertyDescriptor(K1.prototype,"linearFactor"),K1.prototype),b(K1.prototype,"angularFactor",[X1],Object.getOwnPropertyDescriptor(K1.prototype,"angularFactor"),K1.prototype),Q1=b(K1.prototype,"_mass",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return x2}}),Z1=b(K1.prototype,"_linearDamping",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S2}}),J1=b(K1.prototype,"_angularDamping",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w2}}),$1=b(K1.prototype,"_fixedRotation",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),e2=b(K1.prototype,"_isKinematic",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),t2=b(K1.prototype,"_useGravity",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i2=b(K1.prototype,"_linearFactor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),n2=b(K1.prototype,"_angularFactor",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi(1,1,1)}}),Y1=K1))||Y1)||Y1)||Y1)||Y1)||Y1)),E2=q3("ConstantForce",(r2=oo("cc.ConstantForce"),a2=_o(98),s2=fo(T2),o2=po("Components/ConstantForce"),l2=lo({displayOrder:0}),u2=lo({displayOrder:1}),c2=lo({displayOrder:2}),h2=lo({displayOrder:3}),r2(d2=a2(d2=s2(d2=o2(d2=vo(d2=ho((p2=b((f2=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._rigidbody=null,m(t,"_force",p2,l(t)),m(t,"_localForce",_2,l(t)),m(t,"_torque",v2,l(t)),m(t,"_localTorque",m2,l(t)),t._mask=0,t}return p(a,rp),v(a,[{key:"onLoad",value:function(){this._rigidbody=this.node.getComponent(T2),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}},{key:"lateUpdate",value:function(e){null!=this._rigidbody&&0!=this._mask&&(1&this._mask&&this._rigidbody.applyForce(this._force),2&this._mask&&this._rigidbody.applyLocalForce(this.localForce),4&this._mask&&this._rigidbody.applyTorque(this._torque),8&this._mask&&this._rigidbody.applyLocalTorque(this._localTorque))}},{key:"_maskUpdate",value:function(e,t){e.strictEquals(Fi.ZERO)?this._mask&=~t:this._mask|=t}},{key:"force",get:function(){return this._force},set:function(e){Fi.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){Fi.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){Fi.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){Fi.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),a}()).prototype,"_force",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),_2=b(f2.prototype,"_localForce",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),v2=b(f2.prototype,"_torque",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),m2=b(f2.prototype,"_localTorque",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fi}}),b(f2.prototype,"force",[l2],Object.getOwnPropertyDescriptor(f2.prototype,"force"),f2.prototype),b(f2.prototype,"localForce",[u2],Object.getOwnPropertyDescriptor(f2.prototype,"localForce"),f2.prototype),b(f2.prototype,"torque",[c2],Object.getOwnPropertyDescriptor(f2.prototype,"torque"),f2.prototype),b(f2.prototype,"localTorque",[h2],Object.getOwnPropertyDescriptor(f2.prototype,"localTorque"),f2.prototype),d2=f2))||d2)||d2)||d2)||d2)||d2)||d2));cc.ConstantForce=E2,sr(f1,"PhysicsSystem",[{name:"ins",newName:"instance"}]),cc.ColliderComponent=C1,cc.BoxColliderComponent=g2,cc.SphereColliderComponent=b2,cc.RigidBodyComponent=T2,cc.PhysicMaterial=h1,cc.PhysicsRayResult=d1;var C2,A2,k2,R2,O2,M2,I2,L2,z2={INITIALIZING:0,PLAYING:1,STOPPED:2},B2=function(){function i(e){var t=this;y(this,i),this._state=z2.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=e.duration,this._eventTarget=e.eventTarget,this._onHide=function(){t._blocking=!0,t._state===z2.PLAYING&&(t.pause(),t._interrupted=!0)},this._onShow=function(){t._blocking=!1,t._interrupted&&(t.play(),t._interrupted=!1)},cc.game.on(cc.Game.EVENT_HIDE,this._onHide),cc.game.on(cc.Game.EVENT_SHOW,this._onShow)}return v(i,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){cc.game.off(cc.Game.EVENT_HIDE,this._onHide),cc.game.off(cc.Game.EVENT_SHOW,this._onShow)}}]),i}(),P2=(Ll.__audioSupport,function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._audio=e.clip,t._audio.play(),t._audio.stop(),t._audio.onPlay(function(){t._state!==z2.PLAYING&&(t._state=z2.PLAYING,t._startTime=performance.now(),t._eventTarget.emit("started"))}),t._audio.onPause(function(){t._state!==z2.STOPPED&&(t._state=z2.STOPPED,t._offset+=performance.now()-t._startTime)}),t._audio.onStop(function(){t._state!==z2.STOPPED&&(t._state=z2.STOPPED,t._offset=0,t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1))}),t._audio.onEnded(function(){t._state!==z2.STOPPED&&(t._state=z2.STOPPED,t._offset=0,t._eventTarget.emit("ended"),t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1))}),t._audio.onError(function(e){return console.error(e.errMsg)}),t}return p(i,B2),v(i,[{key:"play",value:function(){this._audio&&this._state!==z2.PLAYING&&(this._blocking?this._interrupted=!0:this._audio.play())}},{key:"pause",value:function(){this._audio&&this._state===z2.PLAYING&&this._audio.pause()}},{key:"stop",value:function(){this._audio&&this._audio.stop()}},{key:"playOneShot",value:function(e){var t=0<arguments.length&&void 0!==e?e:1;this._audio&&(this._offset=0,this._oneShoting=!0,this._audio.stop(),this._audio.loop=!1,this._audio.volume=t,this._audio.play())}},{key:"getCurrentTime",value:function(){if(this._state!==z2.PLAYING)return this._offset/1e3;var e=(performance.now()-this._startTime+this._offset)/1e3;return e>this._duration&&(e-=this._duration,this._startTime+=1e3*this._duration),e}},{key:"setCurrentTime",value:function(e){this._audio&&(this._offset=1e3*pi(e,0,this._duration),this._startTime=performance.now(),this._audio.seek(e))}},{key:"getVolume",value:function(){return this._volume}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"destroy",value:function(){this._audio&&this._audio.destroy(),wx.offAudioInterruptionBegin(this._onHide),wx.offAudioInterruptionEnd(this._onShow),_(g(i.prototype),"destroy",this).call(this)}}]),i}()),D2=vt({WEB_AUDIO:0,DOM_AUDIO:1,WX_GAME_AUDIO:2,UNKNOWN_AUDIO:3}),F2=q3("AudioClip",(C2=oo("cc.AudioClip"),A2=lo({type:D2}),C2((L2=I2=function(){function t(){var e;return y(this,t),m(e=x(this,g(t).call(this)),"_duration",O2,l(e)),m(e,"_loadMode",M2,l(e)),e._audio=null,e._player=null,e.loaded=!1,e}return p(t,rd),v(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),_(g(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_nativeAsset",set:function(e){var t;(this._audio=e)?(t=P2,this._loadMode=D2.WX_GAME_AUDIO,this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")):(this._player=null,this._loadMode=D2.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():z2.INITIALIZING}}]),t}(),I2.PlayingState=z2,I2.AudioType=D2,I2.preventDeferredLoadDependents=!0,O2=b((R2=L2).prototype,"_duration",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M2=b(R2.prototype,"_loadMode",[A2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D2.UNKNOWN_AUDIO}}),k2=R2))||k2));cc.AudioClip=F2;var N2,U2,V2,G2,H2,W2,q2,j2,X2,Y2,K2=Ll.__audioSupport,Q2=K2.format;function Z2(e,t){var i=wx.createInnerAudioContext();i.src=e.url,i.onCanplay(function(){return t(null,i)})}function J2(e,t){if(0===Q2.length)return new Error(G(4927));Z2(e,t)}Bb.downloader.addHandlers({mp3:J2,ogg:J2,wav:J2,m4a:J2});var $2=q3("AudioSourceComponent",(N2=oo("cc.AudioSourceComponent"),U2=po("Components/AudioSource"),V2=lo(F2),G2=lo({type:F2}),N2(H2=U2((q2=b((W2=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return m(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_clip",q2,l(t)),m(t,"_loop",j2,l(t)),m(t,"_playOnAwake",X2,l(t)),m(t,"_volume",Y2,l(t)),t._cachedCurrentTime=0,t}return p(a,rp),v(a,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"onDisable",value:function(){this.pause()}},{key:"onDestroy",value:function(){this.stop()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:1;e.playOneShot(this._volume*i)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){isNaN(e)?console.warn("illegal audio volume!"):(e=pi(e,0,1),this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e)},get:function(){return this._volume}},{key:"currentTime",set:function(e){isNaN(e)?console.warn("illegal audio time!"):(e=pi(e,0,this.duration),this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:F2.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===F2.PlayingState.PLAYING}}]),a}()).prototype,"_clip",[V2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j2=b(W2.prototype,"_loop",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X2=b(W2.prototype,"_playOnAwake",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y2=b(W2.prototype,"_volume",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b(W2.prototype,"clip",[G2],Object.getOwnPropertyDescriptor(W2.prototype,"clip"),W2.prototype),b(W2.prototype,"loop",[lo],Object.getOwnPropertyDescriptor(W2.prototype,"loop"),W2.prototype),b(W2.prototype,"playOnAwake",[lo],Object.getOwnPropertyDescriptor(W2.prototype,"playOnAwake"),W2.prototype),b(W2.prototype,"volume",[lo],Object.getOwnPropertyDescriptor(W2.prototype,"volume"),W2.prototype),H2=W2))||H2)||H2));cc.AudioSourceComponent=$2;function e3(e,t,i,n){if(y(this,e3),this.id=void 0,this.tween=void 0,this._opts=void 0,this._props=void 0,this.id=e3._idCounter++,this.tween=new t3.Tween(e),this._props=i,this._opts=n,this.tween.to(i,t),null!=n){if(null!=n.delay&&this.tween.delay(n.delay),null!=n.repeat&&this.tween.repeat(n.repeat),null!=n.repeatDelay&&this.tween.repeatDelay(n.repeatDelay),null!=n.yoyo&&this.tween.yoyo(n.yoyo),null!=n.easing)if("string"==typeof n.easing){var r=n.easing.split("-");if(2<=r.length){var a=r[0],s=r[1];"Linear"===a?"None"===s&&this.tween.easing(t3.Easing[a][s]):"In"!==s&&"Out"!==s&&"InOut"!==s||this.tween.easing(t3.Easing[a][s])}}else this.tween.easing(n.easing);if(null!=n.interpolation)if("string"==typeof n.interpolation){var o=n.interpolation.split("-");if(1<=o.length){var l=o[0];this.tween.interpolation(t3.Interpolation[l])}}else this.tween.interpolation(n.interpolation);null!=n.onStart&&this.tween.onStart(n.onStart),null!=n.onStop&&this.tween.onStop(n.onStop),null!=n.onUpdate&&this.tween.onUpdate(n.onUpdate),null!=n.onComplete&&this.tween.onComplete(n.onComplete)}}var t3=B0(function(e,t){function i(){this._tweens={},this._tweensAddedDuringUpdate={}}i.prototype={getAll:function(){return Object.keys(this._tweens).map(function(e){return this._tweens[e]}.bind(this))},removeAll:function(){this._tweens={}},add:function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},remove:function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},update:function(e,t){var i=Object.keys(this._tweens);if(0===i.length)return!1;for(e=void 0!==e?e:l.now();0<i.length;){this._tweensAddedDuringUpdate={};for(var n=0;n<i.length;n++){var r=this._tweens[i[n]];r&&!1===r.update(e)&&(r._isPlaying=!1,t||delete this._tweens[i[n]])}i=Object.keys(this._tweensAddedDuringUpdate)}return!0}};var n,l=new i;l.Group=i,l._nextId=0,l.nextId=function(){return l._nextId++},"undefined"==typeof self&&"undefined"!=typeof process&&process.hrtime?l.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof self&&void 0!==self.performance&&void 0!==self.performance.now?l.now=self.performance.now.bind(self.performance):void 0!==Date.now?l.now=Date.now:l.now=function(){return(new Date).getTime()},l.Tween=function(e,t){this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._repeatDelayTime=void 0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=l.Easing.Linear.None,this._interpolationFunction=l.Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onRepeatCallback=null,this._onCompleteCallback=null,this._onStopCallback=null,this._group=t||l,this._id=l.nextId(),this._onCompleteCallbackForCocos=null},l.Tween.prototype={getId:function(){return this._id},isPlaying:function(){return this._isPlaying},to:function(e,t){return this._valuesEnd=JSON.parse(JSON.stringify(e)),void 0!==t&&(this._duration=t),this},duration:function(e){return this._duration=e,this},start:function(e){return this._group.add(this),this._isPlaying=!0,this._onStartCallbackFired=!1,this._startTime=void 0!==e?"string"==typeof e?l.now()+parseFloat(e):e:l.now(),this._startTime+=this._delayTime,l._recursiveObjetCopy(this._valuesEnd,this._valuesStart,this._valuesStartRepeat,this._object),this},stop:function(){return this._isPlaying&&(this._group.remove(this),this._isPlaying=!1,null!==this._onStopCallback&&this._onStopCallback(this._object),this.stopChainedTweens()),this},end:function(){return this.update(1/0),this},stopChainedTweens:function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop()},group:function(e){return this._group=e,this},delay:function(e){return this._delayTime=e,this},repeat:function(e){return this._repeat=e,this},repeatDelay:function(e){return this._repeatDelayTime=e,this},yoyo:function(e){return this._yoyo=e,this},easing:function(e){return this._easingFunction=e,this},interpolation:function(e){return this._interpolationFunction=e,this},chain:function(){return this._chainedTweens=arguments,this},onStart:function(e){return this._onStartCallback=e,this},onUpdate:function(e){return this._onUpdateCallback=e,this},onRepeat:function(e){return this._onRepeatCallback=e,this},onComplete:function(e){return this._onCompleteCallback=e,this},onStop:function(e){return this._onStopCallback=e,this},update:function(e){var t,i,n;if(e<this._startTime)return!0;if(!1===this._onStartCallbackFired&&(null!==this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),i=(e-this._startTime)/this._duration,i=0===this._duration||1<i?1:i,n=this._easingFunction(i),l._recursiveObjetUpdate(this._valuesEnd,this._valuesStart,n,this._object,this),null!==this._onUpdateCallback&&this._onUpdateCallback(this._object,i),1!==i)return!0;if(0<this._repeat){for(t in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var r=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=r}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,null!==this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}if(null!==this._onCompleteCallback&&this._onCompleteCallback(this._object),null!==this._onCompleteCallbackForCocos)this._onCompleteCallbackForCocos(this);else for(var a=0,s=this._chainedTweens.length;a<s;a++)this._chainedTweens[a].start(this._startTime+this._duration);return!1},cc_onCompleteCallback:function(e){this._onCompleteCallbackForCocos=e}},l._recursiveObjetUpdate=function(e,t,i,n,r){var a,s;for(var o in e)a=e[o],s=t[o],a instanceof Array?n[o]=r._interpolationFunction(a,i):("string"==typeof a&&(a="+"===a.charAt(0)||"-"===a.charAt(0)?s+parseFloat(a):parseFloat(a)),"number"==typeof a?n[o]=s+(a-s)*i:"object"==typeof a&&l._recursiveObjetUpdate(a,s,i,n[o],r))},l._recursiveObjetCopy=function(e,t,i,n){for(var r in e){if(e[r]instanceof Array){if(0===e[r].length)continue;e[r]=[n[r]].concat(e[r])}void 0!==n[r]&&("object"==typeof n[r]?(t[r]={},i[r]={},l._recursiveObjetCopy(e[r],t[r],i[r],n[r])):(t[r]=n[r],"string"==typeof t[r]&&(t[r]*=1),i[r]=t[r]||0))}},l.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)}},Bounce:{In:function(e){return 1-l.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*l.Easing.Bounce.In(2*e):.5*l.Easing.Bounce.Out(2*e-1)+.5}}},l.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=l.Interpolation.Utils.Linear;return t<0?a(e[0],e[1],n):1<t?a(e[i],e[i-1],i-n):a(e[r],e[i<r+1?i:r+1],n-r)},Bezier:function(e,t){for(var i=0,n=e.length-1,r=Math.pow,a=l.Interpolation.Utils.Bernstein,s=0;s<=n;s++)i+=r(1-t,n-s)*r(t,s)*e[s]*a(n,s);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=l.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(n=i*(1+t))),a(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-n)-e[0]):1<t?e[i]-(a(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):a(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=l.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:(n=[1],function(e){var t=1;if(n[e])return n[e];for(var i=e;1<i;i--)t*=i;return n[e]=t}),CatmullRom:function(e,t,i,n,r){var a=.5*(i-e),s=.5*(n-t),o=r*r;return r*o*(2*t-2*i+a+s)+(-3*t+3*i-2*a-s)*o+a*r+t}}},e.exports=l});t3.TWEEN;function i3(e,t){e.__cc_wrapper__=t}e3._idCounter=0,cc.TweenAction=e3,window.TWEEN=t3;var n3=function(){function e(){y(this,e),this.quene=[]}return v(e,[{key:"updateChain",value:function(){for(var e=this.length,t=0,i=1;t<e;){var n=this.quene[t];if(i<e){if(0<n.length){var r=this.quene[i];if(0===n.repeatTimes){if(0<r.length)n.lastAction.tween.chain(r.lastAction.tween)}else this.wrapAndEvent(n)}}else if(0<n.length&&0!==n.repeatTimes){var a=n.lastAction;i3(a.tween,n),a.tween.cc_onCompleteCallback(this._onComplete.bind(this))}++t,++i}}},{key:"start",value:function(){this.updateChain(),0<this.length&&this.firstUnion.start()}},{key:"stop",value:function(){for(var e=0;e<this.length;e++){if(this.quene[e].stop())break}}},{key:"union",value:function(e){this.quene.push(e)}},{key:"isExistUnion",value:function(e){return-1!==this.quene.indexOf(e)}},{key:"wrapAndEvent",value:function(e){var t=e.lastAction;i3(t.tween,e),t.tween.cc_onCompleteCallback(this._onComplete.bind(this))}},{key:"_onComplete",value:function(e){var t=function(e){return e.__cc_wrapper__}(e);if(0<t.repeatTimes&&0<t.lastCount){t.runTimes++;var i=this.quene.indexOf(t);if(0<=i){for(var n=0;n<i;n++)this.quene[n].runTimes=0;this.firstUnion.start()}}else if(-1===t.repeatTimes){var r=this.quene.indexOf(t);if(0<=r){for(var a=0;a<r;a++)this.quene[a].runTimes=0;this.firstUnion.start()}}else{t.onCompeleteCallback&&t.onCompeleteCallback(e._object);var s=this.quene.indexOf(t);if(s!==this.length-1)this.quene[s+1].start()}}},{key:"length",get:function(){return this.quene.length}},{key:"firstUnion",get:function(){return this.quene[0]}},{key:"lastUnion",get:function(){return this.quene[this.quene.length-1]}}]),e}();cc.TweenCommand=n3;var r3=function(){function t(e){y(this,t),this.id=void 0,this._actions=[],this._target=void 0,this._runTimes=0,this._repeatTimes=0,this._onCompeleteCallback=void 0,this._delay=0,this.id=t._idCounter++,this._target=e}return v(t,[{key:"actions",get:function(){return this._actions}},{key:"length",get:function(){return this._actions.length}},{key:"firstAction",get:function(){return this._actions[0]}},{key:"lastAction",get:function(){return this._actions[this._actions.length-1]}},{key:"target",get:function(){return this._target}},{key:"runTimes",get:function(){return this._runTimes},set:function(e){this._runTimes=e}},{key:"repeatTimes",get:function(){return this._repeatTimes},set:function(e){this._repeatTimes=e}},{key:"lastCount",get:function(){return this._repeatTimes-this._runTimes}},{key:"onCompeleteCallback",set:function(e){this._onCompeleteCallback=e},get:function(){return this._onCompeleteCallback}},{key:"delay",get:function(){return this._delay},set:function(e){this._delay=e}}]),v(t,[{key:"start",value:function(){if(0<this.length)if(0<this.delay){var e=this.actions[0].tween;setTimeout(e.start.bind(e),this.delay)}else this.actions[0].tween.start()}},{key:"stop",value:function(){for(var e=0;e<this._actions.length;e++){var t=this._actions[e].tween;if(t.isPlaying())return t.stop(),!0}return!1}}]),t}();r3._idCounter=0,cc.TweenUnion=r3;var a3=q3("Tween",function(){function r(e){y(this,r),this._command=new n3,this._default=void 0,this._uionDirty=!1,this._default=new r3(e)}return v(r,null,[{key:"_recursiveForBy",value:function(e){var t;for(var i in e)if("number"==typeof(t=e[i])){var n=0<t?"+":"-";e[i]=n+t}else"object"===_e(t)&&r._recursiveForBy(t)}}]),v(r,[{key:"to",value:function(e,t,i){this._uionDirty&&(this._default=new r3(this._default.target),this._uionDirty=!1);var n=new e3(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(n.tween),this._default.actions.push(n),this}},{key:"by",value:function(e,t,i){this._uionDirty&&(this._default=new r3(this._default.target),this._uionDirty=!1),r._recursiveForBy(t);var n=new e3(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(n.tween),this._default.actions.push(n),this}},{key:"union",value:function(){return this._command.isExistUnion(this._default)||(this._command.union(this._default),this._uionDirty=!0),this}},{key:"start",value:function(){return 0<this._default.length&&(this._command.isExistUnion(this._default)||this._command.union(this._default)),this._command.start(),this}},{key:"stop",value:function(){return this._command.stop(),this}},{key:"repeat",value:function(e){return this._uionDirty?this._default.repeatTimes=e:0<this._default.length&&this._default.lastAction.tween.repeat(e),this}},{key:"repeatForever",value:function(){return this._uionDirty?this._default.repeatTimes=-1:0<this._default.length&&this._default.lastAction.tween.repeat(1/0),this}},{key:"delay",value:function(e){return this._uionDirty?this._default.delay=1e3*e:0<this._default.length&&this._default.lastAction.tween.delay(1e3*e),this}},{key:"call",value:function(e){return this._uionDirty?this._default.onCompeleteCallback=e:0<this._default.length&&this._default.lastAction.tween.onComplete(e),this}}]),r}());function s3(e){return new a3(e)}cc.Tween=a3,cc.tweenUtil=s3;var o3=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return p(e,lx),v(e,[{key:"postUpdate",value:function(e){window.TWEEN&&window.TWEEN.update(performance.now())}}]),e}();function l3(e){return C("tween' is deprecated, please use 'tweenUtil' instead "),s3(e)}o3.ID="tween",qE.on(lE.EVENT_INIT,function(){var e=new o3;qE.registerSystem(o3.ID,e,100)}),cc.tween=l3;q3("HeightField",function(){function n(e,t){y(this,n),this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=t,this.data=new Uint16Array(e*t);for(var i=0;i<e*t;++i)this.data[i]=0}return v(n,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=pi(e,0,this.w-1),t=pi(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e/this.w,n=t/this.h,r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;r=pi(r,0,this.w-1),a=pi(a,0,this.h-1),s=pi(s,0,this.w-1),o=pi(o,0,this.h-1);var c=this.get(r,a),h=this.get(s,a),d=this.get(r,o),f=this.get(s,o),p=.5*(h+d);return l+u<=1?f=p-c+p:c=p-f+p,(c*(1-l)+h*l)*(1-u)+(d*(1-l)+f*l)*u}}]),n}()),q3("TERRAIN_MAX_LEVELS",4),q3("TERRAIN_MAX_BLEND_LAYERS",4);var u3,c3,h3,d3,f3,p3,_3,v3,m3,y3,g3,b3,x3,S3,w3,T3,E3,C3,A3,k3,R3,O3,M3,I3,L3,z3,B3,P3=q3("TERRAIN_MAX_LAYER_COUNT",256),D3=q3("TERRAIN_BLOCK_TILE_COMPLEXITY",32),F3=q3("TERRAIN_BLOCK_VERTEX_COMPLEXITY",33),N3=q3("TERRAIN_BLOCK_VERTEX_SIZE",8),U3=(q3("TERRAIN_NORTH_INDEX",0),q3("TERRAIN_SOUTH_INDEX",1),q3("TERRAIN_WEST_INDEX",2),q3("TERRAIN_EAST_INDEX",3),q3("TerrainInfo",oo("cc.TerrainInfo")((h3=b((c3=function(){function e(){y(this,e),m(this,"tileSize",h3,this),m(this,"blockCount",d3,this),m(this,"weightMapSize",f3,this),m(this,"lightMapSize",p3,this),this._tileCount=[0,0],this._vertexCount=[0,0],this._size=new qn(0,0)}return v(e,[{key:"initialize",value:function(){this._tileCount[0]=this.blockCount[0]*D3,this._tileCount[1]=this.blockCount[1]*D3,this._vertexCount[0]=this._tileCount[0]+1,this._vertexCount[1]=this._tileCount[1]+1,this._size.width=this._tileCount[0]*this.tileSize,this._size.height=this._tileCount[1]*this.tileSize}},{key:"tileCount",get:function(){return this._tileCount}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"tileSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),d3=b(c3.prototype,"blockCount",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),f3=b(c3.prototype,"weightMapSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),p3=b(c3.prototype,"lightMapSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),u3=c3))||u3)),V3=q3("TerrainLayer",oo("cc.TerrainLayer")((m3=b((v3=function e(){y(this,e),m(this,"detailMap",m3,this),m(this,"tileSize",y3,this)}).prototype,"detailMap",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y3=b(v3.prototype,"tileSize",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_3=v3))||_3),G3=(q3("TerrainVertex",function e(){y(this,e),this.position=new Fi(0,0,0),this.normal=new Fi(0,1,0),this.uv=new Mi(0,0)}),q3("TerrainRenderable",function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._model=null,t._meshData=null,t._brushMaterial=null,t._currentMaterial=null,t._currentMaterialLayers=0,t}return p(a,ox),v(a,[{key:"destroy",value:function(){this._invalidMaterial(),null!=this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null),_(g(a.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),(this._currentMaterial=null)!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new fm,this._currentMaterial.initialize({effectAsset:bd.get("builtin-terrain"),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return G_.get("missing-material")}}]),a}())),H3=q3("TerrainBlockInfo",oo("cc.TerrainBlockInfo")((x3=b((b3=function e(){y(this,e),m(this,"layers",x3,this)}).prototype,"layers",[lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),g3=b3))||g3),W3=q3("TerrainBlock",function(){function n(e,t,i){y(this,n),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._terrain=e,this._info=e.getBlockInfo(t,i),this._index[0]=t,this._index[1]=i,this._node=new PS(""),this._node.setParent(this._terrain.node),this._node._objFlags|=cc.Object.Flags.DontSave,this._renderable=this._node.addComponent(G3)}return v(n,[{key:"build",value:function(){for(var e=qE.root.device,t=new Float32Array(N3*F3*F3),i=0,n=0;n<F3;++n)for(var r=0;r<F3;++r){var a=this._index[0]*D3+r,s=this._index[1]*D3+n,o=this._terrain.getPosition(a,s),l=this._terrain.getNormal(a,s),u=new Mi(r/D3,n/D3);t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=l.x,t[i++]=l.y,t[i++]=l.z,t[i++]=u.x,t[i++]=u.y}var c=e.createBuffer({usage:Iu.VERTEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:N3*Float32Array.BYTES_PER_ELEMENT*F3*F3,stride:N3*Float32Array.BYTES_PER_ELEMENT});c.update(t);var h=[{name:Cu.ATTR_POSITION,format:Ou.RGB32F},{name:Cu.ATTR_NORMAL,format:Ou.RGB32F},{name:Cu.ATTR_TEX_COORD,format:Ou.RG32F}];this._renderable._meshData={attributes:h,vertexBuffers:[c],indexBuffer:this._terrain.getSharedIndexBuffer(),flatBuffers:[],primitiveMode:Uu.TRIANGLE_LIST},this._renderable._model=this._renderable._getRenderScene().createModel(_v,this._node),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new ji(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var n=this._terrain.getLayer(this.layers[0]);null!=n&&(i.x=1/n.tileSize),e.setProperty("detailMap0",null!=n?n.detailMap:null)}else e.setProperty("detailMap0",G_.get("default-texture"));else if(1===t){var r=this._terrain.getLayer(this.layers[0]),a=this._terrain.getLayer(this.layers[1]);null!=r&&(i.x=1/r.tileSize),null!=a&&(i.y=1/a.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=r?r.detailMap:null),e.setProperty("detailMap1",null!=a?a.detailMap:null)}else if(2===t){var s=this._terrain.getLayer(this.layers[0]),o=this._terrain.getLayer(this.layers[1]),l=this._terrain.getLayer(this.layers[2]);null!=s&&(i.x=1/s.tileSize),null!=o&&(i.y=1/o.tileSize),null!=l&&(i.z=1/l.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=s?s.detailMap:null),e.setProperty("detailMap1",null!=o?o.detailMap:null),e.setProperty("detailMap2",null!=l?l.detailMap:null)}else if(3===t){var u=this._terrain.getLayer(this.layers[0]),c=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),d=this._terrain.getLayer(this.layers[3]);null!=u&&(i.x=1/u.tileSize),null!=c&&(i.y=1/c.tileSize),null!=h&&(i.z=1/h.tileSize),null!=d&&(i.z=1/d.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=u?u.detailMap:null),e.setProperty("detailMap1",null!=c?c.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=d?d.detailMap:null)}e.setProperty("UVScale",i)}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new Zn;return e.x=this._index[0]*D3,e.y=this._index[1]*D3,e.width=D3,e.height=D3,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return 0<=this.layers[3]?3:0<=this.layers[2]?2:0<=this.layers[1]?1:0}},{key:"_getMaterialDefines",value:function(e){return 0===e?{LAYERS:1}:1===e?{LAYERS:2}:2===e?{LAYERS:3}:3===e?{LAYERS:4}:{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(N3*F3*F3),t=0,i=0;i<F3;++i)for(var n=0;n<F3;++n){var r=this._index[0]*D3+n,a=this._index[1]*D3+i,s=this._terrain.getPosition(r,a),o=this._terrain.getNormal(r,a),l=new Mi(n/F3,i/F3);e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=l.x,e[t++]=l.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new uf,this._weightMap.create(this._terrain.info.weightMapSize,this._terrain.info.weightMapSize,ad.RGBA8888),this._weightMap.setFilters(ud.LINEAR,ud.LINEAR),this._weightMap.setWrapMode(od.CLAMP_TO_EDGE,od.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.info.weightMapSize*this._terrain.info.weightMapSize*4),t=0,i=0;i<this._terrain.info.weightMapSize;++i)for(var n=0;n<this._terrain.info.weightMapSize;++n){var r=this._index[0]*this._terrain.info.weightMapSize+n,a=this._index[1]*this._terrain.info.weightMapSize+i,s=this._terrain.getWeight(r,a);e[4*t+0]=Math.floor(255*s.x),e[4*t+1]=Math.floor(255*s.y),e[4*t+2]=Math.floor(255*s.z),e[4*t+3]=Math.floor(255*s.w),t+=1}this._weightMap.uploadData(e.buffer)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"layers",get:function(){return this._info.layers}}]),n}());q3("Terrain",(S3=oo("cc.Terrain"),w3=po("Components/Terrain"),T3=lo({type:U3,visible:!0}),E3=lo({type:V3,visible:!0}),C3=lo({visible:!1}),A3=lo({visible:!1}),k3=lo({visible:!1}),S3(R3=w3(R3=ho((M3=b((O3=function(){function i(){var e;y(this,i),m(e=x(this,g(i).call(this)),"_info",M3,l(e)),m(e,"_layers",I3,l(e)),m(e,"_heights",L3,l(e)),m(e,"_weights",z3,l(e)),m(e,"_blockInfos",B3,l(e)),e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var t=0;t<P3;++t)e._layers.push(null);return e}return p(i,rp),v(i,[{key:"build",value:function(e){return this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildImp()}},{key:"rebuild",value:function(e){e.initialize();for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new H3);for(var n=Math.min(this.info.blockCount[0],e.blockCount[0]),r=Math.min(this.info.blockCount[1],e.blockCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._blockInfos[l]}this._blockInfos=t;var u=this._blocks,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var d;if(c){if(h>=u.length)break;d=u[h++]}else{if((h=u.next()).done)break;d=h.value}d.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildNormals();for(var f=0;f<this._info.blockCount[1];++f)for(var p=0;p<this._info.blockCount[0];++p)this._blocks.push(new W3(this,p,f));var _=this._blocks,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}y.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,n=0;n<this._info.vertexCount[1];++n)for(var r=0;r<this._info.vertexCount[0];++r){var a=r/this._info.tileCount[0],s=n/this._info.tileCount[1],o=e.getAt(a*e.w,s*e.h)*t;this._heights[i++]=o}this._buildNormals();var l=this._blocks,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}h._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,n=0;n<e.h;++n)for(var r=0;r<e.w;++r){var a=r/(e.w-1),s=n/(e.h-1),o=a*this._info.size.width,l=s*this._info.size.height,u=this.getHeightAt(o,l);null!=u&&(e.data[i++]=u*t)}}},{key:"onLoad",value:function(){for(var e=qE.root.device,t=new Uint16Array(D3*D3*6),i=0,n=0;n<D3;++n)for(var r=0;r<D3;++r){var a=n*F3+r,s=n*F3+r+1,o=(n+1)*F3+r,l=(n+1)*F3+r+1;t[i++]=a,t[i++]=o,t[i++]=s,t[i++]=s,t[i++]=o,t[i++]=l}this._sharedIndexBuffer=e.createBuffer({usage:Iu.INDEX|Iu.TRANSFER_DST,memUsage:zu.HOST|zu.DEVICE,size:Uint16Array.BYTES_PER_ELEMENT*D3*D3*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){var e=this._blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp()}},{key:"update",value:function(e){var t=this._blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._info.tileSize,n=t*this._info.tileSize,r=this.getHeight(e,t);return new Fi(i,r,n)}},{key:"setHeight",value:function(e,t,i){this._heights[t*this._info.vertexCount[0]+e]=i}},{key:"getHeight",value:function(e,t){return this._heights[t*this._info.vertexCount[0]+e]}},{key:"getHeightClamp",value:function(e,t){return e=pi(e,0,this._info.vertexCount[0]-1),t=pi(t,0,this._info.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var c=this.getHeight(r,a),h=this.getHeight(s,a),d=this.getHeight(r,o),f=this.getHeight(s,o),p=.5*(h+d);return l+u<=1?f=p-c+p:c=p-f+p,(c*(1-l)+h*l)*(1-u)+(d*(1-l)+f*l)*u}},{key:"_setNormal",value:function(e,t,i){var n=t*this._info.vertexCount[0]+e;this._normals[3*n+0]=i.x,this._normals[3*n+1]=i.y,this._normals[3*n+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this._info.vertexCount[0]+e,n=new Fi;return n.x=this._normals[3*i+0],n.y=this._normals[3*i+1],n.z=this._normals[3*i+2],n}},{key:"getNormalAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var c=this.getNormal(r,a),h=this.getNormal(s,a),d=this.getNormal(r,o),f=this.getNormal(s,o),p=new Fi;Fi.add(p,h,d).multiplyScalar(.5),l+u<=1?(f.set(p),f.subtract(c),f.add(p)):(c.set(p),c.subtract(f),c.add(p));var _=new Fi,v=new Fi,m=new Fi;return Fi.lerp(_,c,h,l),Fi.lerp(v,d,f,l),Fi.lerp(m,_,v,u),m}},{key:"setWeight",value:function(e,t,i){var n=t*this.info.weightMapSize*this.info.blockCount[0]+e;this._weights[4*n+0]=255*i.x,this._weights[4*n+1]=255*i.y,this._weights[4*n+2]=255*i.z,this._weights[4*n+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this.info.weightMapSize*this.info.blockCount[0]+e,n=new ji;return n.x=this._weights[4*i+0]/255,n.y=this._weights[4*i+1]/255,n.z=this._weights[4*i+2]/255,n.w=this._weights[4*i+3]/255,n}},{key:"getWeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var c=this.getWeight(r,a),h=this.getWeight(s,a),d=this.getWeight(r,o),f=this.getWeight(s,o),p=new ji;ji.add(p,h,d).multiplyScalar(.5),l+u<=1?(f=new ji,ji.subtract(f,p,c).add(p)):(c=new ji,ji.subtract(c,p,f).add(p));var _=new ji,v=new ji,m=new ji;return ji.lerp(_,c,h,l),ji.lerp(v,d,f,l),ji.lerp(m,_,v,u),m}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._info.blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._info.blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"rayCheck",value:function(e,t,i){var n=0,r=e,a=null,s=new Fi;if(s.set(t),s.multiplyScalar(i),t.equals(new Fi(0,1,0))){var o=this.getHeightAt(r.x,r.z);null!=o&&r.y<=o&&(a=new Fi(r.x,o,r.z))}else if(t.equals(new Fi(0,-1,0))){var l=this.getHeightAt(r.x,r.z);null!=l&&r.y>=l&&(a=new Fi(r.x,l,r.z))}else for(;n++<2e3;){var u=this.getHeightAt(r.x,r.z);if(null!=u&&r.y<=u){a=new Fi(r.x,u,r.z);break}r.add(s)}return a}},{key:"_calcuNormal",value:function(e,t){var i,n,r=1,a=this.getPosition(e,t);i=e<this._info.vertexCount[0]-1?this.getPosition(e+1,t):(r*=-1,this.getPosition(e-1,t)),n=t<this._info.vertexCount[1]-1?this.getPosition(e,t+1):(r*=-1,this.getPosition(e,t-1)),i.subtract(a),n.subtract(a);var s=new Fi;return s.set(n),s.cross(i),s.multiplyScalar(r),s.normalize(),s}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this._info.vertexCount[1];++t)for(var i=0;i<this._info.vertexCount[0];++i){var n=this._calcuNormal(i,t);this._normals[3*e+0]=n.x,this._normals[3*e+1]=n.y,this._normals[3*e+2]=n.z,e+=1}}},{key:"_buildImp",value:function(){if(0<this._blocks.length)return!0;if(this._info.initialize(),0===this._info.blockCount[0]||0===this._info.blockCount[1])return!1;var e=this._info.vertexCount[0]*this._info.vertexCount[1];if(this._heights.length!==e){this._heights=new Array(e),this._normals=new Array(3*e);for(var t=0;t<e;++t)this._heights[t]=0,this._normals[3*t+0]=0,this._normals[3*t+1]=1,this._normals[3*t+2]=0}else this._normals=new Array(3*e),this._buildNormals();var i=this.info.weightMapSize*this.info.blockCount[0],n=this.info.weightMapSize*this.info.blockCount[1];if(this._weights.length!==i*n*4){this._weights=new Uint8Array(i*n*4);for(var r=0;r<i*n;++r)this._weights[4*r+0]=255,this._weights[4*r+1]=0,this._weights[4*r+2]=0,this._weights[4*r+3]=0}if(this._blockInfos.length!==this.info.blockCount[0]*this.info.blockCount[1]){this._blockInfos=[];for(var a=0;a<this.info.blockCount[1];++a)for(var s=0;s<this.info.blockCount[0];++s)this._blockInfos.push(new H3)}for(var o=0;o<this.info.blockCount[1];++o)for(var l=0;l<this.info.blockCount[0];++l)this._blocks.push(new W3(this,l,o));var u=this._blocks,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var d;if(c){if(h>=u.length)break;d=u[h++]}else{if((h=u.next()).done)break;d=h.value}d.build()}}},{key:"_rebuildHeights",value:function(e){if(this.info.vertexCount[0]===e.vertexCount[0]&&this.info.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=0;for(var n=Math.min(this.info.vertexCount[0],e.vertexCount[0]),r=Math.min(this.info.vertexCount[1],e.vertexCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._heights[l]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var g=this,t=this.info.weightMapSize,a=this.info.weightMapSize*this.info.blockCount[0],i=this.info.weightMapSize*this.info.blockCount[1],n=e.weightMapSize*e.blockCount[0],r=e.weightMapSize*e.blockCount[1];if(n==a&&r==i)return!1;for(var s=new Uint8Array(n*r*4),o=0;o<n*r;++o)s[4*o+0]=255,s[4*o+1]=0,s[4*o+2]=0,s[4*o+3]=0;for(var l=Math.min(e.blockCount[0],this.info.blockCount[0]),u=Math.min(e.blockCount[1],this.info.blockCount[1]),b=function(e,t,i){var n=t*a+e,r=new ji;return r.x=i[4*n+0]/255,r.y=i[4*n+1]/255,r.z=i[4*n+2]/255,r.w=i[4*n+3]/255,r},c=function(e,t,i,n,r){var a=Math.floor(e),s=Math.floor(t),o=a+1,l=s+1,u=e-a,c=t-s,h=b(a+i,s+n,g._weights),d=b(o+i,s+n,g._weights),f=b(a+i,l+n,g._weights),p=b(o+i,l+n,g._weights),_=new ji;ji.add(_,d,f).multiplyScalar(.5),u+c<=1?(p.set(_),p.subtract(h),p.add(_)):(h.set(_),h.subtract(p),h.add(_));var v=new ji,m=new ji,y=new ji;return ji.lerp(v,h,d,u),ji.lerp(m,f,p,u),ji.lerp(y,v,m,c),y},h=0;h<u;++h)for(var d=0;d<l;++d)for(var f=d*t,p=h*t,_=0;_<this.info.weightMapSize;++_)for(var v=0;v<this.info.weightMapSize;++v){var m=void 0;if(e.weightMapSize==t)m=b(v+f,_+p,this._weights);else m=c(v/(this.info.weightMapSize-1)*(t-1),_/(this.info.weightMapSize-1)*(t-1),f,p,this._weights);var y=d*this.info.weightMapSize+v,x=(h*this.info.weightMapSize+_)*n+y;s[4*x+0]=255*m.x,s[4*x+1]=255*m.y,s[4*x+2]=255*m.z,s[4*x+3]=255*m.w}return this._weights=s,!0}},{key:"info",get:function(){return this._info}}]),i}()).prototype,"_info",[T3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U3}}),I3=b(O3.prototype,"_layers",[E3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),L3=b(O3.prototype,"_heights",[C3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z3=b(O3.prototype,"_weights",[A3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Uint8Array}}),B3=b(O3.prototype,"_blockInfos",[k3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),R3=O3))||R3)||R3)||R3))}}});
